import{_ as mn}from"./index-CRQ9SfiP.js";function bn(){function e(Xe,hn){if(!Xe)throw new Error(`[dom] Missing #${hn}`);return Xe}const t=e(document.getElementById("appRoot"),"appRoot"),i=e(document.getElementById("tabImage"),"tabImage"),n=e(document.getElementById("tabColors"),"tabColors"),o=e(document.getElementById("tabSettings"),"tabSettings"),a=e(document.getElementById("tabLogs"),"tabLogs"),s=e(document.getElementById("tabPipeline"),"tabPipeline"),r=e(document.getElementById("tabBuilder"),"tabBuilder"),d=e(document.getElementById("viewImage"),"viewImage"),l=e(document.getElementById("viewColors"),"viewColors"),c=e(document.getElementById("viewSettings"),"viewSettings"),f=e(document.getElementById("viewLogs"),"viewLogs"),h=e(document.getElementById("viewPipeline"),"viewPipeline"),g=e(document.getElementById("viewBuilder"),"viewBuilder"),p=e(document.getElementById("dropZone"),"dropZone"),m=e(document.getElementById("fileInput"),"fileInput"),v=e(document.getElementById("srcCanvas"),"srcCanvas"),b=e(document.getElementById("pipelineStatus"),"pipelineStatus"),y=e(document.getElementById("pipelineTuningMount"),"pipelineTuningMount"),S=e(document.getElementById("pipelineViewMount"),"pipelineViewMount"),T=e(document.getElementById("builderImportFile"),"builderImportFile"),D=e(document.getElementById("btnBuilderExport"),"btnBuilderExport"),U=e(document.getElementById("builderStatus"),"builderStatus"),F=e(document.getElementById("colorsCanvas"),"colorsCanvas"),B=e(document.getElementById("palette"),"palette"),O=e(document.getElementById("btnColorsApply"),"btnColorsApply"),u=e(document.getElementById("btnColorsCancel"),"btnColorsCancel"),E=e(document.getElementById("btnColorsReset"),"btnColorsReset"),P=e(document.getElementById("edgesDark"),"edgesDark"),I=e(document.getElementById("edgeMaskThreshold"),"edgeMaskThreshold"),w=e(document.getElementById("edgeDilate"),"edgeDilate"),C=e(document.getElementById("maxRegionPx"),"maxRegionPx"),k=e(document.getElementById("colorsStatus"),"colorsStatus"),x=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),A=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),L=e(document.getElementById("devConfigDetails"),"devConfigDetails"),G=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),j=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),H=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),$=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),re=e(document.getElementById("logsCbDebug"),"logsCbDebug"),le=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),Kt=e(document.getElementById("cfgStatus"),"cfgStatus"),Ht=e(document.getElementById("cfgOpenCvSpinner"),"cfgOpenCvSpinner"),Wt=e(document.getElementById("cfgOpenCvStatus"),"cfgOpenCvStatus"),Jt=e(document.getElementById("cfgOpenCvReport"),"cfgOpenCvReport"),qt=e(document.getElementById("settingsEngineBox"),"settingsEngineBox"),Yt=e(document.getElementById("cfgUseOpenCv"),"cfgUseOpenCv"),Zt=e(document.getElementById("tuningMount"),"tuningMount"),Xt=e(document.getElementById("settingsVersion"),"settingsVersion"),Qt=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),en=e(document.getElementById("logsLimit"),"logsLimit"),tn=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),nn=e(document.getElementById("logsStatus"),"logsStatus"),on=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),an=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),sn=e(document.getElementById("btnLogsExport"),"btnLogsExport"),rn=e(document.getElementById("btnLogsClear"),"btnLogsClear"),ln=e(document.getElementById("logsOut"),"logsOut"),cn=e(document.getElementById("debugLimit"),"debugLimit"),un=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),dn=e(document.getElementById("btnDebugExport"),"btnDebugExport"),pn=e(document.getElementById("btnDebugClear"),"btnDebugClear"),gn=e(document.getElementById("debugStatus"),"debugStatus"),fn=e(document.getElementById("debugOut"),"debugOut");return{rootEl:t,tabImage:i,tabColors:n,tabSettings:o,tabLogs:a,tabPipeline:s,tabBuilder:r,viewImage:d,viewColors:l,viewSettings:c,viewLogs:f,viewPipeline:h,viewBuilder:g,dropZoneEl:p,fileInputEl:m,srcCanvasEl:v,pipelineStatusEl:b,pipelineTuningMountEl:y,pipelineViewMountEl:S,builderImportFileEl:T,btnBuilderExportEl:D,builderStatusEl:U,colorsCanvasEl:F,paletteEl:B,btnColorsApplyEl:O,btnColorsCancelEl:u,btnColorsResetEl:E,edgesDarkEl:P,edgeMaskThresholdEl:I,edgeDilateEl:w,maxRegionPxEl:C,colorsStatusEl:k,cfgShowDevToolsEl:x,settingsGeneralStatusEl:A,devConfigDetailsEl:L,cfgTraceConsoleEl:G,cfgActionLogMaxEl:j,cfgDebugTraceMaxEl:H,cfgFailureLogsPerRunEl:$,logsCbDebugEl:re,btnCfgResetDefaults:le,cfgStatusEl:Kt,settingsVersionEl:Xt,settingsGitHubLinkEl:Qt,cfgOpenCvSpinner:Ht,cfgOpenCvStatus:Wt,cfgOpenCvReport:Jt,settingsEngineBoxEl:qt,cfgUseOpenCvEl:Yt,tuningMountEl:Zt,logsLimitEl:en,btnLogsRefresh:tn,logsStatusEl:nn,logsTrimKeepEl:on,btnLogsTrim:an,btnLogsExport:sn,btnLogsClear:rn,logsOutEl:ln,debugLimitEl:cn,btnDebugRefresh:un,btnDebugExport:dn,btnDebugClear:pn,debugStatusEl:gn,debugOutEl:fn}}const yn=new Set;function vn(e){yn.add(e)}function wn(){const e=new Set;function t(n){return e.add(n),()=>e.delete(n)}function i(){vn(o=>{for(const a of e)a(o)})}return{on:t,start:i}}const Cn=new Set;function Ct(e){for(const t of Cn)t(e,"local")}function ue(e){const t=localStorage.getItem(e);if(t!==null)try{return JSON.parse(t)}catch{return t}}function En(e,t){localStorage.setItem(e,JSON.stringify(t))}async function oe(e){if(typeof e=="string")return{[e]:ue(e)};if(Array.isArray(e)){const i={};for(const n of e)i[n]=ue(n);return i}const t={};for(const[i,n]of Object.entries(e))t[i]=localStorage.getItem(i)!==null?ue(i):n;return t}async function ae(e){const t={};for(const[i,n]of Object.entries(e)){const o=ue(i);En(i,n),t[i]={oldValue:o,newValue:n}}Ct(t)}async function Je(e){const t=Array.isArray(e)?e:[e],i={};for(const n of t){const o=ue(n);localStorage.removeItem(n),i[n]={oldValue:o,newValue:void 0}}Ct(i)}function ee(e,t,i,n){const o=Number(String(e??"").trim());return Number.isFinite(o)?Math.max(t,Math.min(i,Math.floor(o))):n}const Ue="beemage.devConfig",J={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let Ne=!1,ke={...J};function Et(e){const t=e||{};return{traceConsole:!!t.traceConsole,actionLogMax:ee(t.actionLogMax??J.actionLogMax,100,5e4,J.actionLogMax),debugTraceMax:ee(t.debugTraceMax??J.debugTraceMax,100,5e4,J.debugTraceMax),failureLogsPerRun:ee(t.failureLogsPerRun??J.failureLogsPerRun,0,5e4,J.failureLogsPerRun)}}async function ze(){if(Ne)return;const e=await oe([Ue]).catch(()=>({}));ke=Et(e==null?void 0:e[Ue]),Ne=!0}function Ie(){return ke}async function kt(e){ke=Et(e),Ne=!0,await ae({[Ue]:ke}).catch(()=>null)}async function kn(){await kt({...J})}function In(e,t){const i={pipeline:e.tabPipeline,image:e.tabImage,builder:e.tabBuilder,colors:e.tabColors,settings:e.tabSettings,logs:e.tabLogs},n={pipeline:e.viewPipeline,image:e.viewImage,builder:e.viewBuilder,colors:e.viewColors,settings:e.viewSettings,logs:e.viewLogs};let o="image";const a=new Set;function s(){const g=Ie();return!!(g!=null&&g.traceConsole)}function r(){const g=globalThis;g.__bctGlobalErrorHooksInstalled||(g.__bctGlobalErrorHooksInstalled=!0,window.addEventListener("error",p=>{var v;const m=p;console.error("[panel] window error",{message:m.message,filename:m.filename,lineno:m.lineno,colno:m.colno,error:m.error?String(m.error):null,stack:(v=m.error)!=null&&v.stack?String(m.error.stack):null})}),window.addEventListener("unhandledrejection",p=>{var m;console.error("[panel] unhandledrejection",{reason:p.reason?String(p.reason):null,stack:(m=p.reason)!=null&&m.stack?String(p.reason.stack):null})}))}s()&&r();function d(g){Object.keys(i).forEach(p=>{const m=p===g;i[p].classList.toggle("is-active",m),i[p].setAttribute("aria-selected",m?"true":"false"),n[p].hidden=!m,n[p].classList.toggle("is-active",m)})}function l(g){var p,m,v,b,y,S,T,D;if(g===o){(m=(p=t[g]).refresh)==null||m.call(p);return}(b=(v=t[o]).unmount)==null||b.call(v),o=g,d(o),a.has(o)?(D=(T=t[o]).refresh)==null||D.call(T):(a.add(o),(S=(y=t[o]).mount)==null||S.call(y))}function c(){i.image.addEventListener("click",g=>{var p;(p=g.preventDefault)==null||p.call(g),l("image")}),i.pipeline.addEventListener("click",g=>{var p;(p=g.preventDefault)==null||p.call(g),l("pipeline")}),i.colors.addEventListener("click",g=>{var p;(p=g.preventDefault)==null||p.call(g),l("colors")}),i.settings.addEventListener("click",g=>{var p;(p=g.preventDefault)==null||p.call(g),l("settings")}),i.logs.addEventListener("click",g=>{var p;(p=g.preventDefault)==null||p.call(g),l("logs")}),i.builder.addEventListener("click",g=>{var p;(p=g.preventDefault)==null||p.call(g),l("builder")})}function f(){var g,p,m,v;o="image",d(o),Object.keys(t).forEach(b=>{var y,S;return(S=(y=t[b]).boot)==null?void 0:S.call(y)}),a.has(o)?(v=(m=t[o]).refresh)==null||v.call(m):(a.add(o),(p=(g=t[o]).mount)==null||p.call(g))}function h(){Object.keys(t).forEach(g=>{var p,m;return(m=(p=t[g]).dispose)==null?void 0:m.call(p)})}return{bind:c,boot:f,activate:l,dispose:h}}function Qe(e){const t=e.items.length;return{items:e.items,counts:{items:t},meta:e.meta}}function xn(){const e={items:[],meta:{}},t=new Set;function i(){const l=Qe(e);for(const c of t)try{c(l)}catch{}}function n(){return Qe(e)}function o(l){t.add(l);try{l(n())}catch{}return()=>t.delete(l)}function a(){e.items=[],e.meta={},i()}function s(l){e.meta.scopeUpdatedSince=l,i()}function r(){return String(e.meta.scopeUpdatedSince||"")}function d(l,c){e.items=l.slice(),e.meta.updatedTs=Date.now(),typeof(c==null?void 0:c.limit)=="number"&&(e.meta.limit=c.limit),i()}return{getSnapshot:n,subscribe:o,getScopeUpdatedSince:r,clearAll:a,setScopeUpdatedSince:s,setItems:d}}function Sn(e,t){function i(r){e.dropZoneEl.classList.toggle("is-hover",r)}function n(r,d){const l=r.getContext("2d",{willReadFrequently:!0});if(!l)return;const c=Math.max(1,r.width),f=Math.max(1,r.height);l.clearRect(0,0,c,f);const h=d.naturalWidth||d.width,g=d.naturalHeight||d.height;if(!h||!g)return;const p=Math.min(c/h,f/g),m=Math.max(1,Math.round(h*p)),v=Math.max(1,Math.round(g*p)),b=Math.floor((c-m)/2),y=Math.floor((f-v)/2);l.drawImage(d,b,y,m,v)}function o(r){n(e.srcCanvasEl,r)}function a(r){t.lastError=void 0,t.loadedImageName=r,t.hasImage=!0}function s(r){t.lastError=r,t.hasImage=!1}return{setHover:i,drawImageToSource:o,showLoadOk:a,showLoadError:s}}function Pn(){return{loadedImageName:null,hasImage:!1,lastError:void 0}}const xe="beemage.actionLog",An=5e3;function Mn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function Tn(e){return Array.isArray(e)?e:[e]}function Se(e,t,i){return Math.max(t,Math.min(i,Math.floor(e)))}async function de(){const e=await oe(xe),t=e==null?void 0:e[xe];return Array.isArray(t)?t:[]}async function It(e){await ae({[xe]:e})}async function N(e,t){const i=Se(An,100,5e4),o=Tn(e).map(d=>({...d,id:Mn(),ts:Date.now()}));if(!o.length)return{total:(await de()).length};const s=(await de()).concat(o),r=s.length>i?s.slice(s.length-i):s;return await It(r),{total:r.length}}async function Dn(e){const t=Se((e==null?void 0:e.limit)??200,1,5e4),i=Se((e==null?void 0:e.offset)??0,0,1e6);let o=await de();e!=null&&e.kind&&(o=o.filter(r=>r.kind===e.kind)),e!=null&&e.scope&&(o=o.filter(r=>r.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(o=o.filter(r=>r.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(o=o.filter(r=>r.ts<=e.untilTs));const a=o.length;o=o.slice().reverse();const s=o.slice(i,i+t);return{total:a,items:s}}async function Rn(e){let i=await de();if(typeof e.beforeTs=="number"&&(i=i.filter(n=>n.ts>=e.beforeTs)),typeof e.keepLast=="number"){const n=Se(e.keepLast,0,5e4);n===0?i=[]:i.length>n&&(i=i.slice(i.length-n))}return await It(i),{total:i.length}}async function Ln(){await Je(xe)}async function On(e){const t=await de();return JSON.stringify(t,null,2)}const pe="beemage.debugTrace",_e="beemage.debugTrace.enabled",$n=2e3;function Bn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function Fe(e,t,i){return Math.max(t,Math.min(i,Math.floor(e)))}async function Pe(){const e=await oe(pe),t=e==null?void 0:e[pe];return Array.isArray(t)?t:[]}async function Vn(e){await ae({[pe]:e})}async function qe(){const e=await oe(_e);return!!(e!=null&&e[_e])}async function xt(e){await ae({[_e]:!!e}),e||await Je(pe)}async function St(){await Je(pe)}async function Q(e,t){if(!await qe())return{total:0};const n=Fe((t==null?void 0:t.max)??$n,100,5e4),o=(Array.isArray(e)?e:[e]).map(d=>({...d,id:Bn(),ts:Date.now()}));if(!o.length)return{total:(await Pe()).length};const s=(await Pe()).concat(o),r=s.length>n?s.slice(s.length-n):s;return await Vn(r),{total:r.length}}async function Pt(e){const t=Fe((e==null?void 0:e.limit)??200,1,5e4),i=Fe((e==null?void 0:e.offset)??0,0,1e6),n=(e==null?void 0:e.reverse)??!0,o=await Pe(),a=o.length,r=(n?o.slice().reverse():o).slice(i,i+t);return{total:a,items:r}}async function At(e){const t=await Pe();return JSON.stringify(t,null,e!=null&&e.pretty?2:0)}const Mt=Object.freeze(Object.defineProperty({__proto__:null,append:Q,clear:St,exportJson:At,isEnabled:qe,list:Pt,setEnabled:xt},Symbol.toStringTag,{value:"Module"}));function Un(e,t){const i=Pn(),n=Sn(e,i);async function o(c){if(!c.type.startsWith("image/"))throw new Error(`Unsupported file type: ${c.type||"unknown"}`);const f=URL.createObjectURL(c);try{const h=new Image;return h.decoding="async",h.src=f,typeof h.decode=="function"?await h.decode():await new Promise((g,p)=>{h.onload=()=>g(),h.onerror=()=>p(new Error("Image decode failed."))}),h}finally{URL.revokeObjectURL(f)}}async function a(c){const f=await o(c);n.drawImageToSource(f),n.showLoadOk(c.name),N({scope:"panel",kind:"info",message:`Input loaded: ${c.name}`}),Q({scope:"panel",kind:"info",message:"Mage input loaded into srcCanvas",meta:{name:c.name,type:c.type,size:c.size,canvasW:e.srcCanvasEl.width,canvasH:e.srcCanvasEl.height,naturalW:f.naturalWidth||f.width,naturalH:f.naturalHeight||f.height}})}function s(){e.dropZoneEl.addEventListener("dragover",c=>{c.preventDefault(),n.setHover(!0)}),e.dropZoneEl.addEventListener("dragleave",()=>n.setHover(!1)),e.dropZoneEl.addEventListener("drop",c=>{var h,g;c.preventDefault(),n.setHover(!1);const f=(g=(h=c.dataTransfer)==null?void 0:h.files)==null?void 0:g[0];f&&a(f).catch(p=>{const m=p instanceof Error?p.message:String(p);n.showLoadError(m),N({scope:"panel",kind:"error",message:`Input load failed: ${m}`}),Q({scope:"panel",kind:"error",message:"Input load failed",meta:{error:m}})})}),e.fileInputEl.addEventListener("change",()=>{var f;const c=(f=e.fileInputEl.files)==null?void 0:f[0];c&&(a(c).catch(h=>{const g=h instanceof Error?h.message:String(h);n.showLoadError(g),N({scope:"panel",kind:"error",message:`Input load failed: ${g}`}),Q({scope:"panel",kind:"error",message:"Input load failed",meta:{error:g}})}),e.fileInputEl.value="")})}function r(){s()}function d(){}function l(){}return{id:"image",bind:r,mount:d,unmount:l}}function Te(e,t,i){return Number.isFinite(e)?Math.max(t,Math.min(i,Math.trunc(e))):t}function Nn(e,t,i){return Math.round(.2126*e+.7152*t+.0722*i)}function Tt(e){return{edgesDark:!!(e.edgesDark??!0),edgeThreshold:Te(e.edgeThreshold??80,0,255),edgeDilate:Te(e.edgeDilate??2,0,6),maxRegionPx:Te(e.maxRegionPx??2e5,1e3,1e7)}}function zn(e,t,i){const{data:n,width:o,height:a}=e,s=new Uint8Array(o*a);for(let r=0,d=0;r<s.length;r++,d+=4){const l=n[d+0],c=n[d+1],f=n[d+2];if(n[d+3]===0){s[r]=0;continue}const g=Nn(l,c,f),p=t?g<=i:g>=255-i;s[r]=p?1:0}return s}function _n(e,t,i,n){if(n<=0)return e;let o=e;for(let a=0;a<n;a++){const s=new Uint8Array(t*i);for(let r=0;r<i;r++)for(let d=0;d<t;d++){const l=r*t+d;if(o[l]){s[l]=1;continue}let c=0;for(let f=-1;f<=1&&!c;f++){const h=r+f;if(!(h<0||h>=i))for(let g=-1;g<=1;g++){const p=d+g;if(!(p<0||p>=t)&&o[h*t+p]){c=1;break}}}s[l]=c}o=s}return o}function Fn(e,t,i,n,o,a){const s=t*n+e;if(i[s])return{ok:!1,message:"Click is on an edge; pick inside a region."};const r=new Uint8Array(n*o),d=new Int32Array(n*o),l=new Int32Array(n*o);let c=0,f=0;d[f]=e,l[f]=t,f++,r[s]=1;let h=1;for(;c<f;){const g=d[c],p=l[c];c++;const m=[[g-1,p],[g+1,p],[g,p-1],[g,p+1]];for(const[v,b]of m){if(v<0||v>=n||b<0||b>=o)continue;const y=b*n+v;if(!r[y]&&!i[y]&&(r[y]=1,d[f]=v,l[f]=b,f++,h++,h>a))return{ok:!1,message:`Region too large (>${a}px). Increase Max region or fix gaps.`}}}return{ok:!0,mask:r}}function jn(e,t,i,n){const o=new Uint8Array(i*n);for(let a=1;a<n-1;a++)for(let s=1;s<i-1;s++){const r=a*i+s;if(!e[r])continue;const d=(a-1)*i+s,l=(a+1)*i+s,c=a*i+(s-1),f=a*i+(s+1);(!e[d]||!e[l]||!e[c]||!e[f]||t[d]||t[l]||t[c]||t[f])&&(o[r]=1)}return o}function Gn(e,t,i,n){const o=Tt(n),a=e.width,s=e.height;let r=zn(e,o.edgesDark,o.edgeThreshold);r=_n(r,a,s,o.edgeDilate);const d=Fn(t,i,r,a,s,o.maxRegionPx);if(!d.ok)return{ok:!1,message:d.message};const l=jn(d.mask,r,a,s);return{ok:!0,preview:{mask:d.mask,outline:l,w:a,h:s}}}function Kn(e,t,i){const n=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),o=i.replace("#",""),a=parseInt(o.slice(0,2),16),s=parseInt(o.slice(2,4),16),r=parseInt(o.slice(4,6),16),d=n.data;for(let l=0,c=0;l<t.mask.length;l++,c+=4)t.mask[l]&&(d[c+0]=a,d[c+1]=s,d[c+2]=r);return n}function De(e,t,i){return Number.isFinite(e)?Math.max(t,Math.min(i,Math.trunc(e))):t}function et(e){const t=(e||"").trim();if(!t)return null;const i=t.startsWith("#")?t:`#${t}`;return/^#[0-9a-fA-F]{6}$/.test(i)?i.toLowerCase():null}function Hn(e){let t="#ff3b30",i=[],n=null;function o(m){e.colorsStatusEl.textContent=m||""}function a(){const m=!!e.edgesDarkEl.checked,v=De(parseInt(e.edgeMaskThresholdEl.value,10),0,255),b=De(parseInt(e.edgeDilateEl.value,10),0,6),y=De(parseInt(e.maxRegionPxEl.value,10),1e3,1e7);return e.edgeMaskThresholdEl.value=String(v),e.edgeDilateEl.value=String(b),e.maxRegionPxEl.value=String(y),Tt({edgesDark:m,edgeThreshold:v,edgeDilate:b,maxRegionPx:y})}function s(m){const v=et(m);if(v){t=v;for(const b of Array.from(e.paletteEl.querySelectorAll(".paletteItem"))){const y=b.dataset.hex||"";b.classList.toggle("is-selected",y===t)}}}function r(){return t}function d(m){i=m.slice(),e.paletteEl.innerHTML="";for(const v of i){const b=et(v);if(!b)continue;const y=document.createElement("button");y.type="button",y.className="paletteItem",y.style.background=b,y.dataset.hex=b,y.setAttribute("role","listitem"),y.setAttribute("aria-label",`Select ${b}`),y.addEventListener("click",()=>{s(b)}),e.paletteEl.appendChild(y)}s(t)}function l(m){const v=e.colorsCanvasEl;v.width=m.width,v.height=m.height,v.getContext("2d").putImageData(m,0,0)}function c(m,v){l(m);const b=e.colorsCanvasEl.getContext("2d"),{outline:y,w:S,h:T}=v,D=b.getImageData(0,0,S,T),U=D.data;for(let F=0,B=0;F<y.length;F++,B+=4)y[F]&&(U[B+0]=255,U[B+1]=60,U[B+2]=60,U[B+3]=220);b.putImageData(D,0,0)}function f(m){e.btnColorsApplyEl.disabled=!m}function h(m){e.btnColorsCancelEl.disabled=!m}function g(m){n=m}function p(){o("Idle"),f(!1),h(!1),e.colorsCanvasEl.addEventListener("click",m=>{if(!n)return;const v=e.colorsCanvasEl.getBoundingClientRect(),b=Math.floor((m.clientX-v.left)/v.width*e.colorsCanvasEl.width),y=Math.floor((m.clientY-v.top)/v.height*e.colorsCanvasEl.height);n(b,y)})}return{bind:p,setStatus:o,getSettings:a,setSelectedColor:s,getSelectedColor:r,renderPalette:d,drawBase:l,drawPreview:c,setApplyEnabled:f,setCancelEnabled:h,onCanvasClick:g}}let Dt={type:"none"};function ce(e){Dt=e}function tt(){return Dt}function Re(e){var s,r,d,l,c;if(!e){ce({type:"none"});return}const t=(s=e.outputSvg)==null?void 0:s.svg;if(typeof t=="string"&&t.length>0){ce({type:"svg",svg:t});return}const i=(r=e.outputImage)==null?void 0:r.data;if(i){ce({type:"image",image:i});return}const n=(d=e.outputMask)==null?void 0:d.data,o=(l=e.outputMask)==null?void 0:l.width,a=(c=e.outputMask)==null?void 0:c.height;if(n&&typeof o=="number"&&typeof a=="number"){ce({type:"mask",mask:n,width:o,height:a});return}ce({type:"none"})}const Wn=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#a2845e","#8e8e93","#1c1c1e","#ffffff","#000000","#4cd964","#5ac8fa","#ff6b6b","#7aa2ff","#f5a623","#50e3c2"];function Jn(e,t){const i=Hn(e);let n=null,o=null;function a(g){i.setStatus(g)}function s(g,p,m){const v=new ImageData(p,m),b=v.data;for(let y=0,S=0;y<g.length;y++,S+=4){const D=(g[y]??0)>0?0:255;b[S+0]=D,b[S+1]=D,b[S+2]=D,b[S+3]=255}return v}function r(){const g=tt();return g.type==="image"?g.image:g.type==="mask"?s(g.mask,g.width,g.height):null}function d(){return tt().type==="svg"?"Pipeline output is SVG. Colors needs an image or mask output.":"No pipeline output available. Run the Pipeline first."}function l(){const g=r();if(!g){n=null,o=null,i.setApplyEnabled(!1),i.setCancelEnabled(!1),a(d());return}n=g,o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Ready. Pick a color, click inside a region.")}function c(){if(n){i.drawBase(n);return}const g=r();if(!g){a(d());return}n=g,o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Loaded pipeline output. Pick a color, click inside a region.")}function f(){if(!n||!o)return;const g=i.getSelectedColor();n=Kn(n,o,g),o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Fill applied. Click another region.")}function h(){n&&(o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Preview canceled."))}return{bind(){i.bind(),i.renderPalette(Wn),i.onCanvasClick((g,p)=>{if(!n){a(d());return}const m=i.getSettings(),v=Gn(n,g,p,m);if(!v.ok){o=null,i.setApplyEnabled(!1),i.setCancelEnabled(!1),a(v.message);return}o=v.preview,i.drawPreview(n,o),i.setApplyEnabled(!0),i.setCancelEnabled(!0),a("Preview shown. Apply fill or cancel.")}),e.btnColorsApplyEl.addEventListener("click",()=>f()),e.btnColorsCancelEl.addEventListener("click",()=>h()),e.btnColorsResetEl.addEventListener("click",()=>l()),e.tabColors.addEventListener("click",()=>{queueMicrotask(()=>c())}),a("Idle"),i.setApplyEnabled(!1),i.setCancelEnabled(!1)}}}const nt="0.1.5";function Le(e){return`[BCT][${e}]`}function qn(e){function t(...a){e.traceOn()&&console.log(Le("trace"),...a)}function i(...a){console.warn(Le("warn"),...a)}function n(...a){console.error(Le("error"),...a)}function o(a,s){t(a,s),Q({scope:e.scope,kind:"debug",message:a,meta:s})}return{logTrace:t,logWarn:i,logError:n,traceScope:o}}const{logTrace:R,logWarn:we,logError:te,traceScope:Rt}=qn({scope:"panel",traceOn:()=>!!Ie().traceConsole});let K=0;function W(){return K>0}function X(e,t){if(t){Lt(e);return}K=0,Ae(e,!1)}async function Yn(e,t){const i=`${Date.now()}-${Math.random().toString(16).slice(2)}`;R("[state] withBusy: enter",{id:i,busyCount:K}),Lt(e,i);try{R("[state] withBusy: before await fn",{id:i,busyCount:K});const n=await t();return R("[state] withBusy: after await fn (resolved)",{id:i,busyCount:K}),n}catch(n){throw te("[state] withBusy: fn threw",{id:i,busyCount:K,msg:String((n==null?void 0:n.message)??n),stack:String((n==null?void 0:n.stack)??"")}),n}finally{R("[state] withBusy: finally before endBusy",{id:i,busyCount:K}),Zn(e,i),R("[state] withBusy: finally after endBusy",{id:i,busyCount:K})}}function Lt(e,t){K++,R("[state] beginBusy",{id:t,busyCount:K}),K===1&&Ae(e,!0)}function Zn(e,t){if(K--,R("[state] endBusy: dec",{id:t,busyCount:K}),K<=0){K=0,R("[state] endBusy: applying busy=false",{id:t,busyCount:K}),Ae(e,!1);return}K===0&&(R("[state] endBusy: applying busy=false (redundant branch)",{id:t,busyCount:K}),Ae(e,!1))}function Ae(e,t){e.rootEl.classList.toggle("is-busy",t),e.cfgShowDevToolsEl.disabled=!1,e.fileInputEl.disabled=t,e.cfgTraceConsoleEl.disabled=t,e.cfgActionLogMaxEl.disabled=t,e.cfgDebugTraceMaxEl.disabled=t,e.cfgFailureLogsPerRunEl.disabled=t,e.btnCfgResetDefaults.disabled=t,e.logsCbDebugEl.disabled=t,e.cfgUseOpenCvEl.disabled=t,e.logsLimitEl.disabled=t,e.btnLogsRefresh.disabled=t,e.logsTrimKeepEl.disabled=t,e.btnLogsTrim.disabled=t,e.btnLogsExport.disabled=t,e.btnLogsClear.disabled=t,e.debugLimitEl.disabled=t,e.btnDebugRefresh.disabled=t,e.btnDebugExport.disabled=t,e.btnDebugClear.disabled=t,e.btnColorsApplyEl.disabled=t,e.btnColorsCancelEl.disabled=t,e.btnColorsResetEl.disabled=t,e.edgesDarkEl.disabled=t,e.edgeMaskThresholdEl.disabled=t,e.edgeDilateEl.disabled=t,e.maxRegionPxEl.disabled=t;for(const i of Array.from(e.paletteEl.querySelectorAll("button")))i.disabled=t;e.colorsCanvasEl.style.pointerEvents=t?"none":"auto"}const Ye={native:{available:!0},opencv:{available:!1,reason:"OpenCV not loaded"}};function Xn(e){Ye[e]={available:!0}}function Qn(e,t){Ye[e]={available:!1,reason:t}}function ne(){return Ye.opencv.available===!0}async function ei(e){const t=new URL(e.opencvJsRel,document.baseURI).toString(),i=new URL(e.opencvWasmRel,document.baseURI).toString(),n=globalThis;n.Module=n.Module||{},n.Module.locateFile=o=>o.endsWith(".wasm")?i:o,n.Module.print=()=>{},n.Module.printErr=()=>{},n.cv||await ti(t),await ni(e.timeoutMs)}function ti(e){return new Promise((t,i)=>{const n=document.createElement("script");n.src=e,n.async=!0;const o=15e3,a=window.setTimeout(()=>{s(),i(new Error(`OpenCV script load timeout after ${o}ms: ${e}`))},o);function s(){window.clearTimeout(a),n.onload=null,n.onerror=null}n.onload=()=>{s(),t()},n.onerror=()=>{s(),i(new Error(`Failed to load OpenCV script: ${e}`))},document.head.appendChild(n)})}async function ni(e){var n;const t=Date.now(),i=globalThis;for(;Date.now()-t<e;){try{if(i.cv&&typeof i.cv.Mat=="function"){const o=new i.cv.Mat;(n=o.delete)==null||n.call(o);return}}catch{}await new Promise(o=>setTimeout(o,75))}throw new Error(`OpenCV initialization timeout after ${e}ms`)}async function ii(){try{await ei({opencvJsRel:"../assets/opencv/opencv.js",opencvWasmRel:"../assets/opencv/opencv.wasm",timeoutMs:2e4}),Xn("opencv")}catch(e){throw Qn("opencv",e!=null&&e.message?String(e.message):String(e)),e}}function z(e,t,i,n,o,a,s){return{id:e,title:t,implementedEngines:i,defaultEnginePolicy:n,params:o,children:a,description:s}}function oi(e){const t=new Map,i=new Map;function n(o,a){if(t.has(o.id))throw new Error(`[tuning] Duplicate component id: ${o.id}`);t.set(o.id,o),i.set(o.id,a);for(const s of o.children??[])n(s,o.id)}return n(e,null),{root:e,byId:t,parentById:i}}function Ot(){const e=z("app","BeeMage",["native","opencv"],"native",{},[z("edge","Edge",["native","opencv"],"auto",{},[z("edge.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),z("edge.threshold","Threshold",["native","opencv"],"auto",{manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128}},void 0,"Convert image into a binary mask before edge extraction."),z("edge.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:3},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Clean the mask before extracting edges."),z("edge.extract","Edge extract",["native","opencv"],"auto",{},void 0,"Extract a 1px outline from the cleaned mask.")],"Fixed-order edge pipeline (image -> mask -> edges). Presets configure each step."),z("svg","SVG",["native","opencv"],"auto",{},[z("svg.create","Create SVG",["native","opencv"],"auto",{scale:{kind:"number",label:"Scale",min:1,max:10,step:1,default:1},transparentBg:{kind:"number",label:"Transparent bg (0/1)",min:0,max:1,step:1,default:1},color:{kind:"text",label:"Color",default:"#3bca1e"}},void 0,"Convert the edge mask into an SVG.")],"SVG generation parameters."),z("segmentation","Segmentation",["native","opencv"],"auto",{},[z("segmentation.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),z("segmentation.denoise","Denoise",["native","opencv"],"auto",{denoiseAlgo:{kind:"number",label:"Denoise algo",min:0,max:2,step:1,default:1},blurK:{kind:"number",label:"Blur kernel",min:1,max:21,step:2,default:3},bilateralSigma:{kind:"number",label:"Bilateral sigma",min:1,max:150,step:1,default:35}},void 0,"Reduce noise before thresholding."),z("segmentation.color","Color / Gray",["native","opencv"],"auto",{colorMode:{kind:"number",label:"Color mode",min:0,max:3,step:1,default:1},hsvChannel:{kind:"number",label:"HSV channel",min:0,max:2,step:1,default:2}},void 0,"Select color space / channel features for thresholding."),z("segmentation.threshold","Threshold",["native","opencv"],"auto",{thresholdAlgo:{kind:"number",label:"Threshold algo",min:0,max:3,step:1,default:1},manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128},adaptBlock:{kind:"number",label:"Adaptive block",min:3,max:101,step:2,default:31},adaptC:{kind:"number",label:"Adaptive C",min:-50,max:50,step:1,default:3}},void 0,"Convert features into a binary mask."),z("segmentation.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:5},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Remove specks, fill holes, and stabilize regions.")],"Fixed-order segmentation pipeline. Presets configure each step."),z("image","iMage",["native","opencv"],"auto",{},[z("mage.process","Process",["native"],"auto",{imageScale:{kind:"number",label:"Processing scale",min:25,max:100,step:5,default:100},edgeThreshold:{kind:"number",label:"Edge threshold",min:1,max:255,step:1,default:70},invertOutput:{kind:"boolean",label:"White background",default:!0}}),z("mage.clean","Clean & Smooth",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:500,step:1,default:12},cleanRadius:{kind:"number",label:"Repair strength",min:1,max:3,step:1,default:1},cleanBinaryThreshold:{kind:"number",label:"Binary threshold",min:1,max:254,step:1,default:128}},[z("mage.clean.threshold","Threshold",["native"],"auto",{}),z("mage.clean.removeSmallComponents","Remove small components",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:5e3,step:1,default:12}},void 0,"Remove connected components smaller than the minimum area."),z("mage.clean.repair","Repair gaps",["native"],"auto",{}),z("mage.clean.smooth","Smooth mask",["native"],"auto",{}),z("mage.clean.quality","Quality metrics",["native"],"auto",{})]),z("mage.vectorize","Vectorize (SVG)",["native"],"native",{pathSmoothIters:{kind:"number",label:"Path smoothing",min:0,max:4,step:1,default:2}})]),z("colors","Colors",["native"],"auto",{},[z("colors.fill","Region fill",["native"],"auto",{edgesDark:{kind:"boolean",label:"Edges are dark",default:!0},edgeMaskThreshold:{kind:"number",label:"Edge threshold",min:0,max:255,step:1,default:80},edgeDilate:{kind:"number",label:"Gap close (px)",min:0,max:6,step:1,default:2},maxRegionPx:{kind:"number",label:"Max region (px)",min:1e3,step:1e3,default:2e5}})]),z("pipeline","Pipeline (UI)",["native","opencv"],"auto",{mode:{kind:"text",label:"Pipeline",default:"segmentation"},recipe:{kind:"text",label:"Recipe",default:"default"}},void 0,"UI state for the Pipeline tab (selected pipeline + recipe).")]);return oi(e)}function ai(e){return e.default}function si(e,t){const i={};for(const[n,o]of Object.entries(e))i[n]=ai(o);for(const[n,o]of Object.entries(t??{}))i[n]=o;return i}function ri(e,t,i){var o;let n=e;for(;n;){const a=t.byId.get(n);if(!a)throw new Error(`[tuning] Unknown component: ${n}`);const r=((o=i[n])==null?void 0:o.enginePolicy)??a.defaultEnginePolicy;if(r!=="inherit")return r;n=t.parentById.get(n)??null}return"native"}function li(e,t,i){const n=i.opencvReady&&e.includes("opencv");return e.includes("native")||e.length,t==="native"?{engine:"native"}:t==="opencv"?n?{engine:"opencv"}:{engine:"native",fallbackReason:i.opencvReady?"Policy=opencv, but component has no OpenCV implementation.":"Policy=opencv, but OpenCV is not available at runtime."}:t==="auto"?n?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}function $t(e,t,i,n){var l;const o=t.byId.get(e);if(!o)throw new Error(`[tuning] Unknown component: ${e}`);const a=ri(e,t,i),{engine:s,fallbackReason:r}=li(o.implementedEngines,a,n),d=si(o.params,(l=i[e])==null?void 0:l.params);return{id:e,policy:a,engine:s,fallbackReason:r,params:d}}const je="beemage.tuning.components.v1";async function ge(){const e=await oe([je]).catch(()=>({})),t=e==null?void 0:e[je];return!t||typeof t!="object"?{}:t}async function Bt(e){await ae({[je]:e}).catch(()=>null)}async function Oe(e,t){const i=await ge(),n=i[e]??{};i[e]={enginePolicy:t.enginePolicy??n.enginePolicy,params:{...n.params??{},...t.params??{}}},await Bt(i)}async function it(e){const t=await ge();delete t[e],await Bt(t)}function ci(){return{opencvReady:ne()}}function ui(e){return Array.isArray(e.children)&&e.children.length>0}function Vt(e){const{id:t,registry:i,stored:n,runtime:o}=e,a=i.byId.get(t);if(!a)throw new Error(`[tuning] Unknown component: ${t}`);const s=$t(t,i,n,o),r=n[t],d=r==null?void 0:r.enginePolicy,l=r==null?void 0:r.params,c=a.implementedEngines.includes("opencv"),f=!!o.opencvReady,h=[];for(const g of a.children??[])h.push(Vt({id:g.id,registry:i,stored:n,runtime:o}));return{id:a.id,title:a.title,description:a.description,isGroup:ui(a),implementedEngines:a.implementedEngines,storedPolicy:d,storedParams:l,effectivePolicy:s.policy,effectiveEngine:s.engine,fallbackReason:s.fallbackReason,paramsSchema:a.params,effectiveParams:s.params,canImplementOpenCv:c,runtimeOpenCvReady:f,children:h}}function Ut(e={}){const t=e.registry??Ot(),i=e.getRuntimeAvailability??ci;async function n(d="app"){const l=await ge(),c=i();if(!t.byId.get(d))throw new Error(`[tuning] Unknown scope: ${d}`);const h=Vt({id:d,registry:t,stored:l,runtime:c});return{scopeId:d,runtime:c,stored:l,root:h}}async function o(d,l){await Oe(d,{enginePolicy:l})}async function a(d,l,c){await Oe(d,{params:{[l]:c}})}async function s(d){await it(d)}async function r(d,l){const f=(await ge())[d];if(!(f!=null&&f.params))return;const h={...f.params??{}};delete h[l];const g=typeof f.enginePolicy=="string",p=Object.keys(h).length>0;if(!g&&!p){await it(d);return}await Oe(d,{enginePolicy:f.enginePolicy,params:h})}return{getRegistry:()=>t,loadTree:n,setEnginePolicy:o,setParam:a,resetNode:s,resetParam:r}}function V(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function ot(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function di(e){return e.fallbackReason?`${e.effectiveEngine} (fallback)`:e.effectiveEngine}function pi(e){const t=[{value:"native",label:"Native"},{value:"auto",label:"Auto"},...e.canImplementOpenCv?[{value:"opencv",label:"OpenCV"}]:[]];return e.isRoot?t:[{value:"inherit",label:"Inherit"},...t]}function gi(e){return!1}function fi(e,t,i){var o;const n=(o=e.storedParams)==null?void 0:o[t];return typeof n<"u"&&n!==i}function hi(e){var f;const{node:t,compId:i,key:n,schema:o,value:a,handlers:s}=e,r=V("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),d=V("label",{class:"fieldInline"}),l=V("span",void 0,o.label);d.appendChild(l);let c;if(o.kind==="number"?(c=V("input"),c.type="number",typeof o.min=="number"&&(c.min=String(o.min)),typeof o.max=="number"&&(c.max=String(o.max)),typeof o.step=="number"&&(c.step=String(o.step)),c.value=String(a??o.default),c.addEventListener("change",()=>{const h=Number(c.value);s.onSetParam(i,n,Number.isFinite(h)?h:o.default)})):o.kind==="boolean"?(c=V("input"),c.type="checkbox",c.checked=!!a,c.addEventListener("change",()=>{s.onSetParam(i,n,!!c.checked)})):(c=V("input"),c.type="text",c.value=String(a??o.default),c.addEventListener("change",()=>{s.onSetParam(i,n,String(c.value??o.default))})),d.appendChild(c),r.appendChild(d),s.onResetParam&&typeof((f=t.storedParams)==null?void 0:f[n])<"u"){const h=V("button",{type:"button"},"Reset");h.addEventListener("click",g=>{var p;g.preventDefault(),(p=s.onResetParam)==null||p.call(s,i,n)}),r.appendChild(h)}return fi(t,n,a)&&r.appendChild(V("span",{class:"muted",style:"font-size:12px;"},"override")),r}function Nt(e){const{node:t,depth:i,isRoot:n,handlers:o,treeScopeId:a}=e,s=V("div",{style:`margin-left:${Math.min(i*14,56)}px; margin-top:10px;`}),r=V("div",{style:"border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:10px; background:rgba(0,0,0,0.12);"}),d=V("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),l=V("div");l.appendChild(V("div",{style:"font-weight:700;"},t.title)),t.description&&l.appendChild(V("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},t.description)),t.isGroup&&l.appendChild(V("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},"Group (policy affects children)")),d.appendChild(l);const c=V("div",{class:"row",style:"align-items:center; gap:10px;"});c.appendChild(V("span",{class:"qBadge"},di(t)));const f=V("select");f.style.background="rgba(255,255,255,0.05)",f.style.border="1px solid rgba(255,255,255,0.08)",f.style.color="rgba(255,255,255,0.92)",f.style.borderRadius="10px",f.style.padding="6px 8px";const h=pi({isRoot:n,canImplementOpenCv:t.canImplementOpenCv});for(const S of h){const T=V("option");T.value=S.value,T.textContent=S.label,f.appendChild(T)}const g=new Set(h.map(S=>S.value)),p=t.effectivePolicy;g.has(p)?f.value=p:f.value=n?"native":"inherit",f.addEventListener("change",()=>{o.onSetPolicy(t.id,f.value)}),c.appendChild(f);const m=typeof t.storedPolicy<"u"||t.storedParams&&Object.keys(t.storedParams).length>0;if(o.onResetNode&&m){const S=V("button",{type:"button"},"Reset node");S.addEventListener("click",T=>{var D;T.preventDefault(),(D=o.onResetNode)==null||D.call(o,t.id)}),c.appendChild(S)}d.appendChild(c),r.appendChild(d),t.fallbackReason?r.appendChild(V("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},t.fallbackReason)):t.effectivePolicy==="opencv"&&!t.runtimeOpenCvReady&&r.appendChild(V("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},"OpenCV policy selected, but OpenCV is not available at runtime. It will fall back to native."));const v=Object.keys(t.paramsSchema??{}),b=v.length>0,y=t.children.length>0;if(b||y){const S=V("details",{style:"margin-top:10px;"});S.open=gi();const T=V("summary",{style:"cursor:pointer; user-select:none;"},"Details");if(S.appendChild(T),b){const D=V("div",{style:"margin-top:10px;"});D.appendChild(V("div",{class:"muted",style:"font-weight:600; margin-bottom:6px;"},"Parameters"));for(const U of v){const F=t.paramsSchema[U],B=t.effectiveParams[U];D.appendChild(hi({node:t,compId:t.id,key:U,schema:F,value:B,handlers:o}))}S.appendChild(D)}if(y){const D=V("div",{style:"margin-top:10px;"});for(const U of t.children)D.appendChild(Nt({node:U,depth:i+1,isRoot:!1,handlers:o,treeScopeId:a}));S.appendChild(D)}r.appendChild(S)}return s.appendChild(r),s}function zt(e,t){let i=!1;function n(a){if(i)return;ot(e);const s=a.scopeId==="app",r=V("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"});r.appendChild(V("div",{style:"font-weight:700;"},"Tuning")),r.appendChild(V("div",{class:"muted",style:"font-size:12px;"},`OpenCV runtime: ${a.runtime.opencvReady?"ready":"not available"}`)),e.appendChild(r),e.appendChild(Nt({node:a.root,depth:0,isRoot:s,handlers:t,treeScopeId:a.scopeId}))}function o(){i=!0,ot(e)}return{render:n,dispose:o}}function mi(){let e=!1,t={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},i=!1,n="",o="";function a(l){e=l}function s(l){t={...t,...l}}function r(l){i=l}function d(l){typeof l.general=="string"&&(n=l.general),typeof l.dev=="string"&&(o=l.dev)}return{get showDevTools(){return e},get dev(){return t},get debugEnabled(){return i},get generalStatus(){return n},get devStatus(){return o},setShowDevTools:a,setDev:s,setDebugEnabled:r,setStatus:d}}function bi(e){function t(l){e.settingsGeneralStatusEl.textContent=l||""}function i(l){e.cfgStatusEl.textContent=l||""}function n(l){e.cfgShowDevToolsEl.checked=l}function o(l){e.tabLogs.hidden=!l,e.devConfigDetailsEl.classList.toggle("is-hidden",!l),l||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function a(l){e.cfgTraceConsoleEl.checked=!!l.traceConsole,e.cfgActionLogMaxEl.value=String(l.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(l.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(l.failureLogsPerRun??50)}function s(l){e.logsCbDebugEl.checked=l}function r(l,c){e.settingsVersionEl.textContent=l||"—",e.settingsGitHubLinkEl.href=c||"#",e.settingsGitHubLinkEl.hidden=!c}function d(l){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=l,e.cfgActionLogMaxEl.disabled=l,e.cfgDebugTraceMaxEl.disabled=l,e.cfgFailureLogsPerRunEl.disabled=l,e.btnCfgResetDefaults.disabled=l,e.logsCbDebugEl.disabled=l,e.cfgUseOpenCvEl.disabled=l}return{setGeneralStatus:t,setDevStatus:i,setShowDevToolsChecked:n,setDevToolsVisible:o,setDevConfig:a,setDebugEnabledChecked:s,setAbout:r,setBusy:d}}const $e="template.settings.showDevTools",Be="beemage.settings.engine.useOpenCv";function yi(){var e,t;try{const i=(e=globalThis==null?void 0:globalThis.chrome)==null?void 0:e.runtime,n=(t=i==null?void 0:i.getManifest)==null?void 0:t.call(i),o=typeof(n==null?void 0:n.version)=="string"?n.version:"";if(R("Settings: getManifestVersion manifest found version is ",{v:o}),o)return o}catch{}return R("Settings: getManifestVersion fallback",{APP_VERSION:nt}),nt}function Ve(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??J.actionLogMax),debugTraceMax:Number(e.debugTraceMax??J.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??J.failureLogsPerRun)}}function vi(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:ee(e.cfgActionLogMaxEl.value,100,5e4,J.actionLogMax),debugTraceMax:ee(e.cfgDebugTraceMaxEl.value,100,5e4,J.debugTraceMax),failureLogsPerRun:ee(e.cfgFailureLogsPerRunEl.value,0,5e4,J.failureLogsPerRun)}}async function at(e){const t=Mt;return typeof t.setEnabled=="function"?(await t.setEnabled(e),{ok:!0}):typeof t.enable=="function"&&typeof t.disable=="function"?(await(e?t.enable():t.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function wi(e,t){const i=mi(),n=bi(e),o=Ut({getRuntimeAvailability:()=>({opencvReady:e.cfgUseOpenCvEl.checked&&ne()})}),a=zt(e.tuningMountEl,{onSetPolicy:async(u,E)=>{await o.setEnginePolicy(u,E),await y("policy change")},onSetParam:async(u,E,P)=>{await o.setParam(u,E,P),await y("param change")},onResetNode:async u=>{await o.resetNode(u),await y("reset node")},onResetParam:async(u,E)=>{await o.resetParam(u,E),await y("reset param")}});function s(u){e.settingsEngineBoxEl.classList.toggle("is-hidden",!1)}async function r(){const u=await oe([Be]).catch(()=>({}));return(u==null?void 0:u[Be])===!0}async function d(u){await ae({[Be]:!!u}).catch(()=>null)}function l(u){var E;e.cfgUseOpenCvEl.checked=u,(E=e.cfgUseOpenCvEl.closest(".switch"))==null||E.classList.toggle("is-disabled",e.cfgUseOpenCvEl.disabled)}function c(u){e.cfgOpenCvSpinner.classList.toggle("is-hidden",!u),e.cfgOpenCvSpinner.setAttribute("aria-hidden",u?"false":"true")}function f(u){e.cfgOpenCvStatus.textContent=u||""}function h(u){e.cfgOpenCvReport.textContent=u||""}async function g(){if(W())return;if(!!!e.cfgUseOpenCvEl.checked){await d(!1),c(!1),f(ne()?"OpenCV loaded (native mode)":"Native mode"),h("Native mode. OpenCV is optional and demo-only."),await y("opencv mode disabled");return}c(!0),f("Loading OpenCV…"),h("Loading OpenCV…");try{if(await Yn(e,async()=>{await ii()}),!ne())throw new Error("OpenCV load returned but runtime is not injected.");await d(!0),f("OpenCV mode enabled"),h("OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV."),await y("opencv mode enabled")}catch(E){const P=String((E==null?void 0:E.message)??E);await d(!1),l(!1),f("OpenCV load failed"),h(`ERROR

${P}`),te("[settings] OpenCV toggle failed",{msg:P})}finally{c(!1)}}async function p(){const u=await oe([$e]).catch(()=>({}));return(u==null?void 0:u[$e])===!0}async function m(u){await ae({[$e]:!!u}).catch(()=>null)}function v(u){i.setShowDevTools(u),n.setShowDevToolsChecked(u),n.setDevToolsVisible(u)}async function b(){const u=await p();v(u),R("Settings: boot applyDevToolsVisibility",{showDevTools:u})}async function y(u){try{const E=await o.loadTree("app");a.render(E),R("[settings] tuning rendered",{reason:u,opencvInjected:ne(),opencvMode:!!e.cfgUseOpenCvEl.checked})}catch(E){te("[settings] tuning render failed",{reason:u,msg:String((E==null?void 0:E.message)??E)}),e.tuningMountEl.textContent="Tuning UI failed to load (see console)."}}async function S(){var w;n.setBusy(W());const u=await p();v(u),await ze().catch(()=>null);const E=Ie();i.setDev(Ve(E)),n.setDevConfig(i.dev);const P=Mt;let I=!1;try{typeof P.isEnabled=="function"?I=!!await P.isEnabled():I=!!P.enabled}catch(C){we("Settings: failed to read debug enabled state",{error:C instanceof Error?C.message:String(C)})}i.setDebugEnabled(I),n.setDebugEnabledChecked(I),n.setAbout(yi()||"—",((w=e.settingsGitHubLinkEl)==null?void 0:w.href)||"#"),s();{const C=await r();l(C),c(!1);const k=ne();C?(f(k?"OpenCV mode enabled":"OpenCV mode (not loaded)"),h(k?"OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV.":"OpenCV mode is enabled, but OpenCV is not loaded yet. Toggle OFF then ON to load OpenCV.")):(f(k?"OpenCV loaded (native mode)":"Native mode"),h("Native mode. OpenCV is optional and demo-only."))}n.setGeneralStatus(""),n.setDevStatus(""),await y("loadAll"),R("Settings: loaded",{showDevTools:u,debugTraceEnabled:I,dev:i.dev,opencvInjected:ne()})}async function T(){const u=!!e.cfgShowDevToolsEl.checked;v(u),await m(u),N({kind:"run",scope:"settings",message:u?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:u}}),R("Settings: ui toggle showDevTools",{showDevTools:u}),n.setGeneralStatus(u?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>n.setGeneralStatus(""),1200)}async function D(){const u=vi(e);n.setDevStatus("Saving…");try{await kt(u)}catch(E){te("Settings: failed to save dev config",{error:E instanceof Error?E.message:String(E),next:u}),n.setDevStatus("Save failed."),setTimeout(()=>n.setDevStatus(""),1200);return}i.setDev(Ve(u)),n.setDevConfig(i.dev),N({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:u}),R("Settings: devConfig updated",u),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}async function U(){n.setDevStatus("Resetting…");try{await kn(),await ze().catch(()=>null);const E=Ie();i.setDev(Ve(E)),n.setDevConfig(i.dev)}catch(E){te("Settings: failed to reset dev config defaults",{error:E instanceof Error?E.message:String(E)}),n.setDevStatus("Reset failed."),setTimeout(()=>n.setDevStatus(""),1200);return}const u=await at(!1);u.ok?(i.setDebugEnabled(!1),n.setDebugEnabledChecked(!1)):(we("Settings: failed to reset debug enabled state",{error:u.error||"unknown error"}),N({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:u.error||"unknown error"})),N({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...J,debugEnabled:!1}}),R("Settings: reset defaults",{...J,debugEnabled:!1}),n.setDevStatus("Reset."),setTimeout(()=>n.setDevStatus(""),1200)}async function F(){const u=!!e.logsCbDebugEl.checked;n.setDevStatus("Saving…");const E=await at(u);if(!E.ok){e.logsCbDebugEl.checked=!u,n.setDevStatus(`Save failed: ${E.error||"unknown error"}`),te("Settings: failed to change debug enabled state",{error:E.error||"unknown error",enabled:u}),N({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:E.error||"unknown error",meta:{enabled:u}});return}i.setDebugEnabled(u),N({kind:"run",scope:"settings",message:u?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:u}}),R("Settings: debug enabled changed",{enabled:u}),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}const B=t.on(()=>{});function O(){e.cfgShowDevToolsEl.addEventListener("change",()=>{T()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{W()||D()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{W()||D()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{W()||D()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{W()||D()}),e.btnCfgResetDefaults.addEventListener("click",()=>{W()||U()}),e.logsCbDebugEl.addEventListener("change",()=>{W()||F()}),e.cfgUseOpenCvEl.addEventListener("change",()=>{g()}),b().catch(u=>{we("Settings: initDevToolsVisibility failed",{error:u instanceof Error?u.message:String(u)})})}return{id:"settings",refresh(){S().catch(u=>{te("Settings: refresh failed",{error:u instanceof Error?u.message:String(u)})})},mount(){S().catch(u=>{te("Settings: mount failed",{error:u instanceof Error?u.message:String(u)})})},unmount(){},bind:O,dispose(){B()}}}function Ci(){let e=[],t=0;function i(n){e=n.items,t=n.total}return{get items(){return e},get total(){return t},set:i}}function Ei(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function st(e,t){const i=[];i.push(`Total entries: ${t.total}`),i.push("");for(const n of t.items){const o=typeof n.ok=="boolean"?n.ok?"ok":"fail":"",a=[];typeof n.status=="number"&&a.push(`status=${n.status}`),o&&a.push(o);const s=[n.scope,n.kind].filter(Boolean).join("/");i.push(`[${Ei(n.ts)}] ${s}${a.length?` (${a.join(", ")})`:""}`),i.push(`  ${n.message}`),n.error&&i.push(`  error: ${n.error}`),i.push("")}e.textContent=i.join(`
`),e.scrollTop=0}function ki(e){function t(s){e.logsStatusEl.textContent=s}function i(s){e.debugStatusEl.textContent=s}function n(s){e.logsCbDebugEl.checked=s}function o(s){st(e.logsOutEl,{total:s.total,items:s.items.map(r=>({ts:r.ts,message:r.message,scope:r.scope,kind:r.kind,ok:r.ok,status:r.status,error:r.error,meta:r.meta}))})}function a(s){st(e.debugOutEl,{total:s.total,items:s.items.map(r=>({ts:r.ts,message:r.message,scope:r.scope,kind:r.kind,ok:r.ok,status:r.status,error:r.error,meta:r.meta}))})}return{setAuditStatus:t,setDebugStatus:i,setDebugChecked:n,renderAudit:o,renderDebug:a}}const rt="beemage";function Ii(e,t){const i=Ci(),n=ki(e);async function o(){n.setAuditStatus("Loading…"),X(e,!0);try{const p=ee(e.logsLimitEl.value,10,5e3,200),m=await Dn({limit:p,reverse:!0});i.set(m),n.renderAudit({items:i.items,total:i.total}),n.setAuditStatus(`Showing ${i.items.length} (newest first)`)}catch(p){n.setAuditStatus(`Failed: ${(p==null?void 0:p.message)||String(p)}`)}finally{X(e,!1)}}async function a(){n.setDebugStatus("Loading…"),X(e,!0);try{const p=ee(e.debugLimitEl.value,10,5e3,200),m=await Pt({limit:p,reverse:!0});n.renderDebug(m),n.setDebugStatus(`Showing ${m.items.length} (newest first)`)}catch(p){n.setDebugStatus(`Failed: ${(p==null?void 0:p.message)||String(p)}`)}finally{X(e,!1)}}async function s(){const p=await qe();n.setDebugChecked(p)}async function r(p){if(await xt(p),n.setDebugChecked(p),!p){n.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}n.setDebugStatus("Debug ON."),await a()}async function d(){const p=ee(e.logsTrimKeepEl.value,0,5e4,2e3);n.setAuditStatus("Trimming…"),X(e,!0);try{const m=await Rn({keepLast:p});await o(),n.setAuditStatus(`Trimmed. Remaining: ${m.total}`)}catch(m){n.setAuditStatus(`Trim failed: ${(m==null?void 0:m.message)||String(m)}`)}finally{X(e,!1)}}async function l(){n.setAuditStatus("Clearing…"),X(e,!0);try{await Ln(),await o(),n.setAuditStatus("Cleared.")}catch(p){n.setAuditStatus(`Clear failed: ${(p==null?void 0:p.message)||String(p)}`)}finally{X(e,!1)}}async function c(){n.setAuditStatus("Exporting…");try{const p=await On({pretty:!0}),m=new Blob([p],{type:"application/json"}),v=URL.createObjectURL(m),b=document.createElement("a");b.href=v,b.download=`${rt}-audit-${Date.now()}.json`,b.click(),setTimeout(()=>URL.revokeObjectURL(v),1e3),n.setAuditStatus("Exported.")}catch(p){n.setAuditStatus(`Export failed: ${(p==null?void 0:p.message)||String(p)}`)}}async function f(){n.setDebugStatus("Clearing…"),X(e,!0);try{await St(),await a(),n.setDebugStatus("Cleared.")}catch(p){n.setDebugStatus(`Clear failed: ${(p==null?void 0:p.message)||String(p)}`)}finally{X(e,!1)}}async function h(){n.setDebugStatus("Exporting…");try{const p=await At({pretty:!0}),m=new Blob([p],{type:"application/json"}),v=URL.createObjectURL(m),b=document.createElement("a");b.href=v,b.download=`${rt}-debug-${Date.now()}.json`,b.click(),setTimeout(()=>URL.revokeObjectURL(v),1e3),n.setDebugStatus("Exported.")}catch(p){n.setDebugStatus(`Export failed: ${(p==null?void 0:p.message)||String(p)}`)}}function g(){e.btnLogsRefresh.addEventListener("click",()=>{W()||o()}),e.btnLogsTrim.addEventListener("click",()=>{W()||d()}),e.btnLogsClear.addEventListener("click",()=>{W()||l()}),e.btnLogsExport.addEventListener("click",()=>{W()||c()}),e.logsCbDebugEl.addEventListener("change",()=>{W()||r(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{W()||a()}),e.btnDebugClear.addEventListener("click",()=>{W()||f()}),e.btnDebugExport.addEventListener("click",()=>{W()||h()})}return{id:"logs",bind:g,mount(){s(),o(),a()},unmount(){},dispose(){}}}function xi(e,t){if(e.id===t)return e;const i=[...e.children??[]];for(;i.length>0;){const n=i.shift();if(n.id===t)return n;for(const o of n.children??[])i.push(o)}throw new Error(`[tuning] scopeRootId not found in VM tree: ${t}`)}function Si(e,t){if(e.id===t)return e;const i=[...e.children??[]];for(;i.length>0;){const n=i.shift();if(n.id===t)return n;for(const o of n.children??[])i.push(o)}return null}function Pi(e){const t=Ut({getRuntimeAvailability:e.getRuntimeAvailability}),i=[];let n=!1;async function o(){return await t.loadTree("app")}async function a(){if(n)return;const b=await o();for(const y of i){if(y.scopeRootId==="app"){y.view.render(b);continue}const S=xi(b.root,y.scopeRootId);y.view.render({...b,scopeId:y.scopeRootId,root:S})}}async function s(b,y){await t.setEnginePolicy(b,y),e.actionLogAppend(`[tuning] policy ${b} = ${y}`),e.debugTraceAppend(`[tuning] setPolicy id=${b} policy=${y}`),await a()}async function r(b,y,S){await t.setParam(b,y,S),e.actionLogAppend(`[tuning] param ${b}.${y} = ${String(S)}`),e.debugTraceAppend(`[tuning] setParam id=${b} key=${y} value=${String(S)}`),await a()}async function d(b){await t.resetNode(b),e.actionLogAppend(`[tuning] reset node ${b}`),e.debugTraceAppend(`[tuning] resetNode id=${b}`),await a()}async function l(b,y){await t.resetParam(b,y),e.actionLogAppend(`[tuning] reset param ${b}.${y}`),e.debugTraceAppend(`[tuning] resetParam id=${b} key=${y}`),await a()}async function c(b){var y,S;if(!n){if(b.policies)for(const T of b.policies)await t.setEnginePolicy(T.id,T.policy);if(b.params)for(const T of b.params)await t.setParam(T.id,T.key,T.value);e.actionLogAppend(`[tuning] preset ${b.id} (${b.title})`),e.debugTraceAppend(`[tuning] applyPreset id=${b.id} title=${b.title} policies=${((y=b.policies)==null?void 0:y.length)??0} params=${((S=b.params)==null?void 0:S.length)??0}`),await a()}}async function f(b){const y=await o(),S=Si(y.root,b);if(!S)throw new Error(`[tuning] getEffectiveParams: unknown component id ${b}`);return{...S.effectiveParams??{}}}async function h(b,y,S){await t.setParam(b,y,S),e.actionLogAppend(`[tuning] param ${b}.${y} = ${String(S)}`),e.debugTraceAppend(`[tuning] setParamValue id=${b} key=${y} value=${String(S)}`),await a()}function g(b){if(n)return;const{mountEl:y,scopeRootId:S}=b;if(i.some(D=>D.mountEl===y))return;const T=zt(y,{onSetPolicy:s,onSetParam:r,onResetNode:d,onResetParam:l});i.push({mountEl:y,scopeRootId:S,view:T}),a()}function p(b){const y=i.findIndex(S=>S.mountEl===b);y<0||(i[y].view.dispose(),i.splice(y,1))}async function m(){await a()}function v(){n=!0;for(const b of i)b.view.dispose();i.length=0}return{mount:g,unmount:p,refresh:m,applyPreset:c,getEffectiveParams:f,setParamValue:h,dispose:v}}function Z(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function Ai(e){const t=[{kind:"input",type:e.io.input}],i=[{kind:"output",type:e.io.output}];return{id:e.id,title:e.title,group:e.group,inputs:t,outputs:i}}function Mi(e){const t=String(e||"").toLowerCase();return t==="image"?"opPort--image":t==="mask"?"opPort--mask":t==="svg"?"opPort--svg":"opPort--unknown"}function lt(e){const{ports:t,kind:i,getPortClass:n}=e,o=Z("div",{class:"opCard__portsRow"}),a=Z("div",{class:"opCard__portsLabel"},i==="input"?"IN":"OUT");o.appendChild(a);const s=Z("div",{class:"opCard__ports"});for(const r of t){const d=`opPort ${n(r.type)}`,l=r.label?`${r.label}: ${r.type}`:String(r.type),c=Z("div",{class:d,"data-port-kind":r.kind,"data-port-type":String(r.type)},l);s.appendChild(c)}return o.appendChild(s),o}function Ze(e,t){const i=Ai(e),n={compact:!!(t!=null&&t.compact),showId:(t==null?void 0:t.showId)??!0,showGroup:(t==null?void 0:t.showGroup)??!0,getPortClass:(t==null?void 0:t.getPortClass)??Mi,onClick:(t==null?void 0:t.onClick)??(()=>{})},o=Z("div",{class:`opCard${n.compact?" opCard--compact":""}`,"data-op-id":i.id}),a=Z("div",{class:"opCard__head"}),s=Z("div",{class:"opCard__title"},i.title);a.appendChild(s);const r=Z("div",{class:"opCard__meta"});n.showGroup&&i.group&&r.appendChild(Z("span",{class:"opBadge opBadge--group"},i.group)),n.showId&&r.appendChild(Z("span",{class:"opBadge opBadge--id"},i.id)),a.appendChild(r),o.appendChild(a);const d=Z("div",{class:"opCard__body"});return d.appendChild(lt({ports:i.inputs,kind:"input",getPortClass:n.getPortClass})),d.appendChild(lt({ports:i.outputs,kind:"output",getPortClass:n.getPortClass})),o.appendChild(d),t!=null&&t.onClick&&(o.classList.add("opCard--clickable"),o.addEventListener("click",l=>{var c,f;(c=l.preventDefault)==null||c.call(l),(f=t.onClick)==null||f.call(t,i.id)})),o}function M(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function Ti(e){return e.type==="image"}function Di(e){return e.type==="mask"}function Ri(e){return e.type==="svg"}function _t(e){return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(e)}`}function ct(e,t){if(Ti(e)){const n=M("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return Ce(n,e.image),n}if(Di(e)){const n=M("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return Ge(n,e.mask,e.width,e.height),n}if(!Ri(e))return M("div",{class:"muted",style:"margin-top:8px; font-size:12px;"},`Unsupported output: ${String(e.type)}`);const i=M("img",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`,"aria-label":"SVG preview"});return i.src=_t(e.svg),i}function Ft(e,t){const i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download=e,n.rel="noopener",n.click(),setTimeout(()=>URL.revokeObjectURL(i),500)}async function ut(e,t){const i=await new Promise(n=>t.toBlob(o=>n(o),"image/png"));if(!i)throw new Error("Failed to create PNG blob.");Ft(e,i)}function Ce(e,t){e.width=t.width,e.height=t.height;const i=e.getContext("2d",{willReadFrequently:!0});i&&i.putImageData(t,0,0)}function Ge(e,t,i,n){e.width=i,e.height=n;const o=e.getContext("2d",{willReadFrequently:!0});if(!o)return;let a=0;const s=i*n;for(let c=0;c<s;c++){const f=t[c]??0;f>a&&(a=f)}const r=a<=1,d=o.createImageData(i,n),l=d.data;for(let c=0;c<s;c++){const f=t[c]??0;let h;r?h=(f>0?1:0)?0:255:h=f;const g=c*4;l[g]=h,l[g+1]=h,l[g+2]=h,l[g+3]=255}o.putImageData(d,0,0)}function Li(e){const{hostEl:t,statusEl:i,handlers:n}=e;let o=!1,a=null,s=null,r=null,d=null,l=null,c=null,f=null,h=null,g=null,p=null,m=null,v=null,b=null;function y(){for(;t.firstChild;)t.removeChild(t.firstChild)}async function S(u){var A,L,G,j,H;const P=(typeof(u==null?void 0:u.activePipelineId)=="string"?u.activePipelineId:"pipeline").replace(/[^a-z0-9_-]+/gi,"_").slice(0,40)||"pipeline",I=(A=u==null?void 0:u.outputSvg)==null?void 0:A.svg;if(typeof I=="string"&&I.length>0){const $=new Blob([I],{type:"image/svg+xml;charset=utf-8"});Ft(`beemage-${P}.svg`,$);return}const w=(L=u==null?void 0:u.outputImage)==null?void 0:L.data;if(w){const $=document.createElement("canvas");Ce($,w),await ut(`beemage-${P}.png`,$);return}const C=(G=u==null?void 0:u.outputMask)==null?void 0:G.data,k=(j=u==null?void 0:u.outputMask)==null?void 0:j.width,x=(H=u==null?void 0:u.outputMask)==null?void 0:H.height;if(C&&typeof k=="number"&&typeof x=="number"){const $=document.createElement("canvas");Ge($,C,k,x),await ut(`beemage-${P}-mask.png`,$);return}throw new Error("No output to download.")}function T(){if(o)return;o=!0,y(),a=M("div",{class:"card"}),h=M("p",{class:"muted",style:"margin-top:0;"},"Universal pipeline runner. Select a pipeline and run it.");const u=M("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),E=M("label",{class:"fieldInline"});E.appendChild(M("span",{},"Pipeline")),s=M("select"),E.appendChild(s);const P=M("label",{class:"fieldInline"});P.appendChild(M("span",{},"Recipe")),r=M("select"),P.appendChild(r),d=M("button",{type:"button"},"Run all"),l=M("button",{type:"button"},"Next step"),c=M("button",{type:"button"},"Reset"),f=M("button",{type:"button"},"Download"),u.appendChild(E),u.appendChild(P),u.appendChild(d),u.appendChild(l),u.appendChild(c),u.appendChild(f);const I=M("div",{class:"grid4",style:"margin-top:12px;"}),w=M("div",{class:"card"});w.appendChild(M("div",{class:"cardTitle"},"Input (from source)")),g=M("canvas",{class:"canvas","aria-label":"Pipeline input preview"}),w.appendChild(g);const C=M("div",{class:"card"});C.appendChild(M("div",{class:"cardTitle"},"Current output")),p=M("canvas",{class:"canvas","aria-label":"Pipeline current output preview"}),m=M("img",{class:"canvas","aria-label":"Pipeline SVG output preview",style:"display:none;"}),C.appendChild(p),C.appendChild(m);const k=M("div",{class:"card",style:"grid-column:1 / -1;"});k.appendChild(M("div",{class:"cardTitle"},"Stages")),v=M("div"),k.appendChild(v),I.appendChild(w),I.appendChild(C),I.appendChild(k),a.appendChild(h),a.appendChild(u),a.appendChild(I),t.appendChild(a),s.addEventListener("change",()=>{const x=s?s.value:"segmentation";n.onSelectPipeline(x)}),r.addEventListener("change",()=>{const x=r?r.value:"default";n.onSelectRecipe(x)}),d.addEventListener("click",()=>n.onRunAll()),l.addEventListener("click",()=>n.onNext()),c.addEventListener("click",()=>n.onReset()),f.addEventListener("click",async()=>{try{await S(b)}catch(x){const A=x instanceof Error?x.message:String(x);i.textContent=`Download failed: ${A}`}})}function D(u){if(!s||!r)return;const E=Array.isArray(u==null?void 0:u.pipelines)?u.pipelines:[],P=Array.isArray(u==null?void 0:u.recipes)?u.recipes:[],I=typeof(u==null?void 0:u.activePipelineId)=="string"?u.activePipelineId:"segmentation",w=typeof(u==null?void 0:u.activeRecipeId)=="string"?u.activeRecipeId:"default";s.innerHTML="";for(const C of E){const k=M("option");k.value=C.id,k.textContent=C.title,C.id===I&&(k.selected=!0),s.appendChild(k)}r.innerHTML="";for(const C of P){const k=M("option");k.value=C.id,k.textContent=C.title,C.id===w&&(k.selected=!0),r.appendChild(k)}}function U(u){var P;if(!g)return;const E=(P=u==null?void 0:u.input)==null?void 0:P.data;if(!E){g.width=1,g.height=1;const I=g.getContext("2d");I&&I.clearRect(0,0,g.width,g.height);return}Ce(g,E)}function F(u){var x,A,L,G,j;if(!p||!m)return;const E=(x=u==null?void 0:u.outputSvg)==null?void 0:x.svg;if(typeof E=="string"&&E.length>0){p.style.display="none",m.style.display="block",m.src=_t(E);return}p.style.display="block",m.style.display="none",m.src="";const P=(A=u==null?void 0:u.outputImage)==null?void 0:A.data;if(P){Ce(p,P);return}const I=(L=u==null?void 0:u.outputMask)==null?void 0:L.data,w=(G=u==null?void 0:u.outputMask)==null?void 0:G.width,C=(j=u==null?void 0:u.outputMask)==null?void 0:j.height;if(I&&typeof w=="number"&&typeof C=="number"){Ge(p,I,w,C);return}p.width=1,p.height=1;const k=p.getContext("2d");k&&k.clearRect(0,0,p.width,p.height)}function B(u){if(!v)return;v.innerHTML="";const E=Array.isArray(u==null?void 0:u.stages)?u.stages:[];if(!E.length){v.appendChild(M("div",{class:"muted",style:"font-size:12px;"},"No stages."));return}const P=M("div",{style:"display:flex; flex-direction:column; gap:10px;"});for(const I of E)P.appendChild(O(I));v.appendChild(P)}function O(u){const E=M("div",{class:"card",style:"padding:10px;"}),P=M("div",{class:"row",style:"align-items:center; justify-content:space-between;"});P.appendChild(M("div",{style:"font-weight:bold;"},String(u.title??u.stageId))),P.appendChild(M("div",{class:"status"},String(u.state??"idle"))),E.appendChild(P),E.appendChild(M("div",{class:"muted",style:"font-size:12px;"},`${u.input} -> ${u.output}`)),typeof u.error=="string"&&u.error.length>0&&E.appendChild(M("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Stage error: ${u.error}`));const I=u.outputArtifact;I&&E.appendChild(ct(I,260));const w=Array.isArray(u.ops)?u.ops:[];if(w.length){const C=M("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:8px;"});for(let k=0;k<w.length;k++){const x=w[k],A=k===w.length-1,L=M("div",{class:"card",style:"padding:8px;"}),G=M("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),j={id:String(x.opId??""),title:String(x.title??x.opId??"Operation"),io:{input:x.input,output:x.output},group:x.group},H=Ze(j,{compact:!0,showGroup:!0,showId:!0});G.appendChild(H),G.appendChild(M("div",{class:"status"},String(x.state??"idle"))),L.appendChild(G),typeof x.error=="string"&&x.error.length>0&&L.appendChild(M("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Op error: ${x.error}`));const $=I&&A?void 0:x.outputArtifact;$&&L.appendChild(ct($,200)),C.appendChild(L)}E.appendChild(C)}return E}return{mount(){T()},render(u){var E,P,I;if(T(),b=u,D(u),i.textContent=typeof(u==null?void 0:u.statusText)=="string"?u.statusText:"Idle",h){const w=typeof(u==null?void 0:u.description)=="string"?u.description:"Universal pipeline runner.";h.textContent=w}if(f){const w=typeof((E=u==null?void 0:u.outputSvg)==null?void 0:E.svg)=="string"&&u.outputSvg.svg.length>0,C=!!((P=u==null?void 0:u.outputImage)!=null&&P.data),k=!!((I=u==null?void 0:u.outputMask)!=null&&I.data);f.disabled=!(w||C||k)}U(u),F(u),B(u)},dispose(){o=!1,a=null,s=null,r=null,d=null,l=null,c=null,f=null,h=null,g=null,p=null,m=null,v=null,b=null,y()}}}function fe(e,t){return e.find(i=>i.id===t)??null}function q(e,t){return{input:e,output:t}}function dt(e,t){return`${e}.${t+1}`}function Ke(e){const t=[{kind:"dispatch",id:"op.seg.resize",title:"Resize",io:q("image","image"),dispatchId:"segmentation.resize",tuningId:"segmentation.resize",group:"Segmentation"},{kind:"dispatch",id:"op.seg.denoise",title:"Denoise",io:q("image","image"),dispatchId:"segmentation.denoise",tuningId:"segmentation.denoise",group:"Segmentation"},{kind:"dispatch",id:"op.seg.color",title:"Color / Gray",io:q("image","image"),dispatchId:"segmentation.color",tuningId:"segmentation.color",group:"Segmentation"},{kind:"dispatch",id:"op.seg.threshold",title:"Threshold",io:q("image","mask"),dispatchId:"segmentation.threshold",tuningId:"segmentation.threshold",group:"Segmentation"},{kind:"dispatch",id:"op.seg.morphology",title:"Morphology cleanup",io:q("mask","mask"),dispatchId:"segmentation.morphology",tuningId:"segmentation.morphology",group:"Segmentation"},{kind:"dispatch",id:"op.edge.resize",title:"Resize",io:q("image","image"),dispatchId:"edge.resize",tuningId:"edge.resize",group:"Edge"},{kind:"dispatch",id:"op.edge.threshold",title:"Threshold",io:q("image","mask"),dispatchId:"edge.threshold",tuningId:"edge.threshold",group:"Edge"},{kind:"dispatch",id:"op.edge.morphology",title:"Morphology cleanup",io:q("mask","mask"),dispatchId:"edge.morphology",tuningId:"edge.morphology",group:"Edge"},{kind:"dispatch",id:"op.edge.extract",title:"Edge extract",io:q("mask","mask"),dispatchId:"edge.extract",tuningId:"edge.extract",group:"Edge"},{kind:"dispatch",id:"op.svg.create",title:"Create SVG",io:q("mask","svg"),dispatchId:"svg.create",tuningId:"svg.create",group:"SVG"},{kind:"dispatch",id:"op.mage.clean.removeSmallComponents",title:"Remove small components",io:q("mask","mask"),dispatchId:"mage.clean.removeSmallComponents",tuningId:"mage.clean.removeSmallComponents",group:"Cleanup"},{kind:"js",id:"op.util.pass.image",title:"Pass-through (image)",io:q("image","image"),group:"Utility",run:({input:l})=>l},{kind:"js",id:"op.util.pass.mask",title:"Pass-through (mask)",io:q("mask","mask"),group:"Utility",run:({input:l})=>l}];function i(l){return fe(t,l)}function n(l,c){return c.map((f,h)=>({instanceId:dt(l,h),opId:f,enabled:!0}))}const o=[{id:"segmentation",title:"Segmentation",implemented:!0,description:"Multi-step segmentation pipeline (image -> mask).",ops:n("segmentation",["op.seg.resize","op.seg.denoise","op.seg.color","op.seg.threshold","op.seg.morphology"])},{id:"edge",title:"Edge",implemented:!0,description:"Edge extraction pipeline (image -> mask -> edges).",ops:n("edge",["op.edge.resize","op.edge.threshold","op.edge.morphology","op.edge.extract"])},{id:"svg",title:"SVG",implemented:!0,description:"Image to SVG outline.",ops:n("svg",["op.edge.resize","op.edge.threshold","op.edge.morphology","op.edge.extract","op.svg.create"])},{id:"cleanup",title:"Cleanup (min area)",implemented:!0,description:"Image -> mask -> cleanup (morphology + remove small components).",ops:n("cleanup",["op.seg.resize","op.seg.threshold","op.seg.morphology","op.mage.clean.removeSmallComponents"])},{id:"surface",title:"Surface",implemented:!1,description:"Future: region labeling + vectorize pipeline.",ops:[]}],a=(e==null?void 0:e.userPipelines)??[];function s(l){return fe(o,l)}function r(l){return fe(a,l)??fe(o,l)}function d(){const l=new Set(a.map(f=>f.id));return[...o.filter(f=>!l.has(f.id)),...a]}return{ops:t,getOp:i,builtIns:o,getBuiltIn:s,listPipelines:d,getPipeline:r,createInstanceId:dt}}const pt=Ot();function Oi(){return{opencvReady:ne()}}function $i(e){const{implemented:t,policy:i,runtimeOpenCvReady:n}=e,o=n&&t.includes("opencv");return t.includes("native")||t.length,i==="native"?{engine:"native"}:i==="opencv"?o?{engine:"opencv"}:{engine:"native",fallbackReason:n?"Override policy=opencv, but this op has no OpenCV implementation.":"Override policy=opencv, but OpenCV is not available at runtime."}:i==="auto"?o?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}async function Bi(e,t){const i=await ge(),n=Oi(),o=$t(e,pt,i,n),a=pt.byId.get(e);if(!a)throw new Error(`[opsDispatch] Unknown op in registry: ${e}`);const r={...o.params,...(t==null?void 0:t.params)??{}},d=t!=null&&t.enginePolicy&&t.enginePolicy!=="inherit"?t.enginePolicy:o.policy;let l=o.engine,c=o.fallbackReason;if(t!=null&&t.enginePolicy&&t.enginePolicy!=="inherit"){const f=$i({implemented:a.implementedEngines,policy:d,runtimeOpenCvReady:!!n.opencvReady});l=f.engine,c=f.fallbackReason}return{engine:l,params:r,fallbackReason:c,opencvReady:!!n.opencvReady}}async function Vi(e,t,i,n){const{engine:o,params:a,fallbackReason:s,opencvReady:r}=await Bi(e,n);return o==="opencv"&&!r?(we(`OpenCV selected for ${e} but not ready; falling back to native. ${s??""}`.trim()),await i[e].native(t,a)):await i[e][o](t,a)}function he(e,t,i,n){if(!t||!i)return e;const o=Math.floor(Number(n.morphAlgo??2)),a=Ni(Math.floor(Number(n.morphIters??1)),1,20),s=Math.floor(Number(n.morphK??5)),r=Ui(s),d=r-1>>1;if(o<=0||r<=1)return e;let l=e,c=new Uint8Array(t*i);for(let f=0;f<a;f++){if(o===1){ft(l,c,t,i,d);const h=l;l=c,c=h;continue}if(o===2){gt(l,c,t,i,d);const h=l;l=c,c=h;continue}gt(l,c,t,i,d),l===e&&f===0&&(l=new Uint8Array(e)),ft(c,l,t,i,d)}return l}function Ui(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:5}function gt(e,t,i,n,o){t.fill(0);for(let a=0;a<n;a++){const s=Math.max(0,a-o),r=Math.min(n-1,a+o);for(let d=0;d<i;d++){const l=Math.max(0,d-o),c=Math.min(i-1,d+o);let f=0;for(let h=s;h<=r&&!f;h++){let g=h*i+l;for(let p=l;p<=c;p++,g++)if(e[g]){f=1;break}}t[a*i+d]=f}}}function ft(e,t,i,n,o){t.fill(0);for(let a=0;a<n;a++){const s=Math.max(0,a-o),r=Math.min(n-1,a+o);for(let d=0;d<i;d++){const l=Math.max(0,d-o),c=Math.min(i-1,d+o);let f=1;for(let h=s;h<=r&&f;h++){let g=h*i+l;for(let p=l;p<=c;p++,g++)if(!e[g]){f=0;break}}t[a*i+d]=f}}}function Ni(e,t,i){return e<t?t:e>i?i:e}function jt(e,t,i,n){const o=Math.max(0,Math.floor(Number(n??0)));if(!t||!i||o<=1)return e;const a=new Uint8Array(e),s=new Uint8Array(e.length),r=new Int32Array(e.length),d=new Int32Array(e.length);for(let l=0;l<i;l++)for(let c=0;c<t;c++){const f=l*t+c;if(e[f]===0||s[f]===1)continue;let h=0,g=0;s[f]=1,r[g]=c,d[g]=l,g++;const p=[f];for(;h<g;){const m=r[h],v=d[h];h++;const b=m-1,y=v,S=m+1,T=v,D=m,U=v-1,F=m,B=v+1;if(b>=0){const O=y*t+b;e[O]!==0&&s[O]===0&&(s[O]=1,r[g]=b,d[g]=y,g++,p.push(O))}if(S<t){const O=T*t+S;e[O]!==0&&s[O]===0&&(s[O]=1,r[g]=S,d[g]=T,g++,p.push(O))}if(U>=0){const O=U*t+D;e[O]!==0&&s[O]===0&&(s[O]=1,r[g]=D,d[g]=U,g++,p.push(O))}if(B<i){const O=B*t+F;e[O]!==0&&s[O]===0&&(s[O]=1,r[g]=F,d[g]=B,g++,p.push(O))}}if(p.length<o)for(let m=0;m<p.length;m++)a[p[m]]=0}return a}function zi(){const e=globalThis;return e!=null&&e.cv&&typeof e.cv.Mat=="function"?e.cv:null}function _i(e,t){const{width:i,height:n}=e,o=Math.max(0,Math.floor(Number(t.cleanMinArea??0)));if(Rt("OpenCV removeSmallComponents params",{width:i,height:n,minArea:o}),!i||!n||o<=1)return e.mask;const a=zi();if(!a)return jt(e.mask,i,n,o);const s=new a.Mat(n,i,a.CV_8UC1);try{const r=s.data,d=e.mask;for(let h=0;h<d.length;h++)r[h]=d[h]?255:0;const l=new a.Mat,c=new a.Mat,f=new a.Mat;try{const h=a.connectedComponentsWithStats(s,l,c,f,8,a.CV_32S),g=a.CC_STAT_AREA??4,p=new Array(h).fill(!1);for(let b=1;b<h;b++)c.intAt(b,g)<o&&(p[b]=!0);const m=new Uint8Array(i*n),v=l.data32S;for(let b=0;b<m.length;b++){const y=v[b];m[b]=y>0&&!p[y]?1:0}return m}finally{l.delete(),c.delete(),f.delete()}}finally{s.delete()}}function me(e,t,i,n){const o=Math.max(0,Math.min(255,Math.floor(Number(n.manualT??128)))),a=new Uint8Array(t*i),s=e.data;for(let r=0,d=0;r<a.length;r++,d+=4){const l=s[d],c=s[d+1],f=s[d+2],h=l*77+c*150+f*29>>8;a[r]=h>=o?1:0}return a}function be(e,t,i,n){const o=Math.max(1,Math.floor(Number(n.targetMaxW??t)));if(!t||!i||t<=o)return e;const a=o/t,s=Math.max(1,Math.floor(t*a)),r=Math.max(1,Math.floor(i*a));return Math.floor(Number(n.resizeAlgo??1))===0?Fi(e,t,i,s,r):ji(e,t,i,s,r)}function Fi(e,t,i,n,o){const a=e.data,s=new Uint8ClampedArray(n*o*4),r=t/n,d=i/o;for(let l=0;l<o;l++){const c=Math.min(i-1,Math.max(0,Math.floor((l+.5)*d-.5)));for(let f=0;f<n;f++){const h=Math.min(t-1,Math.max(0,Math.floor((f+.5)*r-.5))),g=(c*t+h)*4,p=(l*n+f)*4;s[p]=a[g],s[p+1]=a[g+1],s[p+2]=a[g+2],s[p+3]=a[g+3]}}return new ImageData(s,n,o)}function ji(e,t,i,n,o){const a=e.data,s=new Uint8ClampedArray(n*o*4),r=t/n,d=i/o;for(let l=0;l<o;l++){const c=(l+.5)*d-.5,f=ye(Math.floor(c),0,i-1),h=ye(f+1,0,i-1),g=c-f;for(let p=0;p<n;p++){const m=(p+.5)*r-.5,v=ye(Math.floor(m),0,t-1),b=ye(v+1,0,t-1),y=m-v,S=(f*t+v)*4,T=(f*t+b)*4,D=(h*t+v)*4,U=(h*t+b)*4,F=(l*n+p)*4;for(let B=0;B<4;B++){const O=a[S+B],u=a[T+B],E=a[D+B],P=a[U+B],I=O+(u-O)*y,w=E+(P-E)*y,C=I+(w-I)*g;s[F+B]=Gi(C)}}}return new ImageData(s,n,o)}function ye(e,t,i){return e<t?t:e>i?i:e}function Gi(e){return e<=0?0:e>=255?255:e|0}function ht(e,t,i,n){if(!t||!i)return e;const o=Math.floor(Number(n.denoiseAlgo??1));if(o<=0)return e;const a=Math.floor(Number(n.blurK??3)),s=Ki(a);return o===2&&s<=3?Wi(e,t,i):s<=1?e:Hi(e,t,i,s)}function Ki(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:3}function Hi(e,t,i,n){const o=n-1>>1,a=e.data,s=new Uint8ClampedArray(t*i*4);for(let d=0;d<i;d++){let l=0,c=0,f=0,h=0;for(let g=-o;g<=o;g++){const p=ie(g,0,t-1),m=(d*t+p)*4;l+=a[m],c+=a[m+1],f+=a[m+2],h+=a[m+3]}for(let g=0;g<t;g++){const p=(d*t+g)*4;s[p]=l/n|0,s[p+1]=c/n|0,s[p+2]=f/n|0,s[p+3]=h/n|0;const m=ie(g-o,0,t-1),v=ie(g+o+1,0,t-1),b=(d*t+m)*4,y=(d*t+v)*4;l+=a[y]-a[b],c+=a[y+1]-a[b+1],f+=a[y+2]-a[b+2],h+=a[y+3]-a[b+3]}}const r=new Uint8ClampedArray(t*i*4);for(let d=0;d<t;d++){let l=0,c=0,f=0,h=0;for(let g=-o;g<=o;g++){const m=(ie(g,0,i-1)*t+d)*4;l+=s[m],c+=s[m+1],f+=s[m+2],h+=s[m+3]}for(let g=0;g<i;g++){const p=(g*t+d)*4;r[p]=l/n|0,r[p+1]=c/n|0,r[p+2]=f/n|0,r[p+3]=h/n|0;const m=ie(g-o,0,i-1),v=ie(g+o+1,0,i-1),b=(m*t+d)*4,y=(v*t+d)*4;l+=s[y]-s[b],c+=s[y+1]-s[b+1],f+=s[y+2]-s[b+2],h+=s[y+3]-s[b+3]}}return new ImageData(r,t,i)}function Wi(e,t,i){const n=e.data,o=new Uint8ClampedArray(t*i*4),a=new Array(9),s=new Array(9),r=new Array(9),d=new Array(9);for(let l=0;l<i;l++)for(let c=0;c<t;c++){let f=0;for(let g=-1;g<=1;g++){const p=ie(l+g,0,i-1);for(let m=-1;m<=1;m++){const v=ie(c+m,0,t-1),b=(p*t+v)*4;a[f]=n[b],s[f]=n[b+1],r[f]=n[b+2],d[f]=n[b+3],f++}}a.sort(ve),s.sort(ve),r.sort(ve),d.sort(ve);const h=(l*t+c)*4;o[h]=a[4]|0,o[h+1]=s[4]|0,o[h+2]=r[4]|0,o[h+3]=d[4]|0}return new ImageData(o,t,i)}function ve(e,t){return e-t}function ie(e,t,i){return e<t?t:e>i?i:e}function mt(e,t,i,n){if(!t||!i)return e;const o=Math.floor(Number(n.colorMode??1));if(o===0)return e;const a=e.data,s=new Uint8ClampedArray(t*i*4),r=qi(Math.floor(Number(n.hsvChannel??2)),0,2);for(let d=0,l=0;d<t*i;d++,l+=4){const c=a[l],f=a[l+1],h=a[l+2],g=a[l+3];let p=0;if(o===1)p=c*77+f*150+h*29>>8;else if(o===2){const m=Ji(c,f,h),v=r===0?m.h:r===1?m.s:m.v;p=Yi(v*255)}else p=255-(c*77+f*150+h*29>>8);s[l]=p,s[l+1]=p,s[l+2]=p,s[l+3]=g}return new ImageData(s,t,i)}function Ji(e,t,i){const n=e/255,o=t/255,a=i/255,s=Math.max(n,o,a),r=Math.min(n,o,a),d=s-r;let l=0;d!==0&&(s===n?l=(o-a)/d%6:s===o?l=(a-n)/d+2:l=(n-o)/d+4,l/=6,l<0&&(l+=1));const c=s===0?0:d/s;return{h:l,s:c,v:s}}function qi(e,t,i){return e<t?t:e>i?i:e}function Yi(e){return e<=0?0:e>=255?255:e|0}function bt(e,t,i){const n=new Uint8Array(e.length),o=(a,s)=>s*t+a;for(let a=0;a<i;a++)for(let s=0;s<t;s++){const r=o(s,a);if(e[r]===0)continue;if(s===0||a===0||s===t-1||a===i-1){n[r]=255;continue}const l=e[o(s-1,a)],c=e[o(s+1,a)],f=e[o(s,a-1)],h=e[o(s,a+1)];(l===0||c===0||f===0||h===0)&&(n[r]=255)}return n}function yt(e,t,i,n){const o=Math.max(1,Math.floor(n.scale||1)),a=t*o,s=i*o,r=o;let d="";for(let h=0;h<i;h++){const g=h*t;for(let p=0;p<t;p++){if(e[g+p]===0)continue;const v=p*r,b=h*r;d+=`M${v} ${b}h${r}v${r}h-${r}Z`}}const l=n.transparentBg?"":`<rect x="0" y="0" width="${a}" height="${s}" fill="white"/>`,c=n.color||"#000",f=d.length>0?`<path d="${d}" fill="${c}" stroke="none"/>`:"";return`<svg xmlns="http://www.w3.org/2000/svg" width="${a}" height="${s}" viewBox="0 0 ${a} ${s}">`+l+f+"</svg>"}const Zi="demo",Xi={"mage.clean.removeSmallComponents":{native:(e,t)=>jt(e.mask,e.width,e.height,t.cleanMinArea),opencv:(e,t)=>(R("OpenCV removeSmallComponents called (demo).",{width:e.width,height:e.height,cleanMinArea:t.cleanMinArea}),_i(e,t))},"segmentation.resize":{native:(e,t)=>(R("[demo op] segmentation.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),be(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(R("[demo op] segmentation.resize opencv",{width:e.width,height:e.height}),be(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"segmentation.denoise":{native:(e,t)=>(R("[demo op] segmentation.denoise native",{width:e.width,height:e.height,denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}),ht(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma})),opencv:(e,t)=>(R("[demo op] segmentation.denoise opencv",{width:e.width,height:e.height}),ht(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}))},"segmentation.color":{native:(e,t)=>(R("[demo op] segmentation.color native",{width:e.width,height:e.height,colorMode:t.colorMode,hsvChannel:t.hsvChannel}),mt(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel})),opencv:(e,t)=>(R("[demo op] segmentation.color opencv",{width:e.width,height:e.height}),mt(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel}))},"segmentation.threshold":{native:(e,t)=>(R("[demo op] segmentation.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),me(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(R("[demo op] segmentation.threshold opencv",{width:e.width,height:e.height}),me(e.image,e.width,e.height,{manualT:t.manualT}))},"segmentation.morphology":{native:(e,t)=>(R("[demo op] segmentation.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),he(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(R("[demo op] segmentation.morphology opencv",{width:e.width,height:e.height}),he(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.resize":{native:(e,t)=>(R("[demo op] edge.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),be(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(R("[demo op] edge.resize opencv",{width:e.width,height:e.height}),be(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"edge.threshold":{native:(e,t)=>(R("[demo op] edge.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),me(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(R("[demo op] edge.threshold opencv",{width:e.width,height:e.height}),me(e.image,e.width,e.height,{manualT:t.manualT}))},"edge.morphology":{native:(e,t)=>(R("[demo op] edge.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),he(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(R("[demo op] edge.morphology opencv",{width:e.width,height:e.height}),he(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.extract":{native:(e,t)=>(R("[demo op] edge.extract native",{width:e.width,height:e.height}),bt(e.mask,e.width,e.height)),opencv:(e,t)=>(R("[demo op] edge.extract opencv",{width:e.width,height:e.height}),bt(e.mask,e.width,e.height))},"svg.create":{native:(e,t)=>(R("[demo op] svg.create native",{width:e.width,height:e.height,scale:t.scale}),yt(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color})),opencv:(e,t)=>(R("[demo op] svg.create opencv",{width:e.width,height:e.height,scale:t.scale}),yt(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color}))}};async function se(e,t,i){return Rt("[opsDispatch] runOp",{op:e,implSource:Zi,inputKeys:t&&typeof t=="object"?Object.keys(t):typeof t,override:i?{enginePolicy:i.enginePolicy,paramsKeys:Object.keys(i.params??{})}:null}),Vi(e,t,Xi,i)}const Qi=Object.freeze(Object.defineProperty({__proto__:null,runOp:se},Symbol.toStringTag,{value:"Module"}));function eo(e){return{width:e.width,height:e.height}}function to(e){return e.type==="image"}function no(e){return e.type==="mask"}function Gt(e){return{type:"image",width:e.width,height:e.height,image:e}}function vt(e,t,i){return{type:"mask",width:t,height:i,mask:e}}function wt(e,t,i){return{type:"svg",width:t,height:i,svg:e}}function Me(e,t){return`IO mismatch: expected ${e}, got ${t}`}function io(e,t){if(e.length===0)return"Pipeline has no ops";let i=t;for(const n of e){if(n.io.input!==i)return`Chain IO mismatch at "${n.title}": needs ${n.io.input} but current is ${i}`;i=n.io.output}return null}async function oo(e,t,i){const n=t.override;if(e.io.input==="image"){if(!to(i))throw new Error(Me("image",i.type));const{width:s,height:r}=i;if(e.io.output==="image"){const d=await se(e.dispatchId,{image:i.image,width:s,height:r},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return Gt(d)}if(e.io.output==="mask"){const d=await se(e.dispatchId,{image:i.image,width:s,height:r},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return vt(d,s,r)}if(e.io.output==="svg"){const d=await se(e.dispatchId,{image:i.image,width:s,height:r},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return wt(d,s,r)}throw new Error(`Unsupported dispatch output: ${e.io.output}`)}if(!no(i))throw new Error(Me("mask",i.type));const{width:o,height:a}=i;if(e.io.output==="mask"){const s=await se(e.dispatchId,{mask:i.mask,width:o,height:a},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return vt(s,o,a)}if(e.io.output==="svg"){const s=await se(e.dispatchId,{mask:i.mask,width:o,height:a},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return wt(s,o,a)}throw new Error(`Invalid op spec: mask input cannot produce ${e.io.output} (unsupported here)`)}async function ao(e,t,i,n){var r;if(e.kind==="dispatch")return await oo(e,t,i);const a={...e.tuningId?await n.getEffectiveParams(e.tuningId).catch(()=>({})):{},...((r=t.override)==null?void 0:r.params)??{}};return await e.run({input:i,params:a})}async function so(e){const{catalogue:t,pipeline:i,inputImage:n,deps:o}=e,a=Gt(n);if(!i.implemented)return{pipelineId:i.id,title:i.title,status:"error",error:"Not implemented yet",input:a,ops:[]};const s=i.ops.filter(f=>f.enabled!==!1),r=[];for(const f of s){const h=t.getOp(f.opId);if(!h)return{pipelineId:i.id,title:i.title,status:"error",error:`Unknown opId in pipeline: ${f.opId}`,input:a,ops:[]};r.push(h)}const d=io(r,"image");if(d)return o.debug("pipeline validation failed (linear)",{pipelineId:i.id,error:d}),{pipelineId:i.id,title:i.title,status:"error",error:d,input:a,ops:s.map((f,h)=>{var g,p;return{instanceId:f.instanceId,opId:f.opId,title:((g=r[h])==null?void 0:g.title)??f.opId,io:((p=r[h])==null?void 0:p.io)??{input:"image",output:"image"},status:"error",error:d}})};const l=[];let c=a;for(let f=0;f<r.length;f++){const h=s[f],g=r[f];try{if(g.io.input!==c.type)throw new Error(Me(g.io.input,c.type));const p=await ao(g,h,c,o);if(p.type!==g.io.output)throw new Error(Me(g.io.output,p.type));l.push({instanceId:h.instanceId,opId:g.id,title:g.title,io:g.io,status:"ok",output:p}),c=p}catch(p){const m=p instanceof Error?p.message:String(p);return l.push({instanceId:h.instanceId,opId:g.id,title:g.title,io:g.io,status:"error",error:m}),o.debug("pipeline op failed (linear)",{pipelineId:i.id,opId:g.id,error:m,...eo(c)}),{pipelineId:i.id,title:i.title,status:"error",error:`Op "${g.title}" failed: ${m}`,input:a,ops:l}}}return{pipelineId:i.id,title:i.title,status:"ok",input:a,output:c,ops:l}}const He="beemage.pipeline.userPipelines.v1";async function Ee(){const e=await oe([He]).catch(()=>({})),t=e==null?void 0:e[He];if(!Array.isArray(t))return[];const i=[];for(const n of t)!n||typeof n!="object"||typeof n.id=="string"&&Array.isArray(n.ops)&&i.push(n);return i}async function ro(e){await ae({[He]:e}).catch(()=>null)}function lo(e){return e.type==="image"}function co(e){return e.type==="mask"}function uo(e){return e.type==="svg"}function po(e){var u,E,P,I;let t=Ke({userPipelines:[]}),n=((P=(E=(u=t.listPipelines)==null?void 0:u.call(t))==null?void 0:E[0])==null?void 0:P.id)??((I=t.builtIns[0])==null?void 0:I.id)??"segmentation",o="default",a=null,s="Idle",r=null,d=[],l=0,c=null;async function f(){var x,A;const w=await Ee().catch(()=>[]);t=Ke({userPipelines:w});const C=((x=t.listPipelines)==null?void 0:x.call(t))??t.builtIns;C.some(L=>L.id===n)||(n=((A=C[0])==null?void 0:A.id)??"segmentation",o="default"),m()}function h(){var C,k,x;const w=((C=t.getPipeline)==null?void 0:C.call(t,n))??((x=(k=t.listPipelines)==null?void 0:k.call(t))==null?void 0:x[0]);if(!w)throw new Error("[pipeline] No pipelines available.");return w}function g(w){return[{id:"default",title:"Default",buildPipeline:k=>k}]}function p(){const w=h(),C=g(),k=C.find(x=>x.id===o)??C[0];return o=k.id,k.buildPipeline(w)}function m(){s=p().implemented?"Ready":"Not implemented yet",r=null,d=[],l=0,c=null}function v(){m()}function b(w){var k,x;w===n||!(((k=t.getPipeline)==null?void 0:k.call(t,w))??((x=t.getBuiltIn)==null?void 0:x.call(t,w)))||(n=w,o="default",v())}function y(w){w!==o&&(o=w,v())}function S(w){a=w,m()}function T(w){const C=w.ops.filter(x=>x.enabled!==!1),k=[];for(let x=0;x<C.length;x++){const A=C[x],L=t.getOp(A.opId);L&&k.push({index0:x,instanceId:A.instanceId,opSpec:L})}return k}function D(w){var A;const C=w.ops.map(L=>({instanceId:L.instanceId,opId:L.opId,title:L.title,input:L.io.input,output:L.io.output,state:L.status==="ok"?"ok":L.status==="error"?"error":"idle",error:L.error,outputArtifact:L.output})),k=w.status==="ok"?"ok":"error",x=w.output??((A=C.slice().reverse().find(L=>L.outputArtifact))==null?void 0:A.outputArtifact);return[{stageId:"pipeline",title:"Pipeline",input:"image",output:(x==null?void 0:x.type)??"image",ops:C,state:k,error:w.error,outputArtifact:x}]}function U(w,C){C&&(lo(C)?w.outputImage={width:C.width,height:C.height,data:C.image}:co(C)?w.outputMask={width:C.width,height:C.height,data:C.mask}:uo(C)&&(w.outputSvg={width:C.width,height:C.height,svg:C.svg}))}async function F(){const w=p();if(!w.implemented){s="Not implemented yet";return}if(!a){s="No input image";return}s="Running all…";const C=await so({catalogue:t,pipeline:w,inputImage:a,deps:e.runner});r=C,d=T(w),l=d.length,c=C.output??null,s=C.status==="ok"?"Done":C.error??"Error"}async function B(){const w=p();if(!w.implemented){s="Not implemented yet";return}if(!a){s="No input image";return}if(d.length===0&&(d=T(w),l=0,c={type:"image",width:a.width,height:a.height,image:a},r={pipelineId:w.id,title:w.title,status:"ok",input:{type:"image",width:a.width,height:a.height,image:a},output:{type:"image",width:a.width,height:a.height,image:a},ops:[]}),l>=d.length){s="Done";return}const C=d[l],k=C.opSpec;c||(c={type:"image",width:a.width,height:a.height,image:a});try{if(s=`Running: ${k.title}`,c.type!==k.io.input)throw new Error(`IO mismatch: expected ${k.io.input}, got ${c.type}`);const x=k.tuningId?await e.runner.getEffectiveParams(k.tuningId).catch(()=>({})):{};let A;if(k.kind==="dispatch"){const{runOp:j}=await mn(async()=>{const{runOp:H}=await Promise.resolve().then(()=>Qi);return{runOp:H}},void 0,import.meta.url);if(c.type==="image"){const H=await j(k.dispatchId,{image:c.image,width:c.width,height:c.height});if(k.io.output==="image"){const $=H;A={type:"image",width:$.width,height:$.height,image:$}}else if(k.io.output==="mask")A={type:"mask",width:c.width,height:c.height,mask:H};else throw new Error(`Unsupported dispatch output: ${k.io.output}`)}else if(c.type==="mask"){const H=await j(k.dispatchId,{mask:c.mask,width:c.width,height:c.height});if(k.io.output==="mask")A={type:"mask",width:c.width,height:c.height,mask:H};else if(k.io.output==="svg")A={type:"svg",width:c.width,height:c.height,svg:H};else throw new Error(`Invalid dispatch output: ${k.io.output}`)}else throw new Error("Dispatch ops cannot take svg input.")}else A=await k.run({input:c,params:x});if(A.type!==k.io.output)throw new Error(`IO mismatch: expected ${k.io.output}, got ${A.type}`);const G=((r==null?void 0:r.ops)??[]).concat([{instanceId:C.instanceId,opId:k.id,title:k.title,io:k.io,status:"ok",output:A}]);r={pipelineId:w.id,title:w.title,status:"ok",input:{type:"image",width:a.width,height:a.height,image:a},output:A,ops:G},c=A,l+=1,s=l>=d.length?"Done":"Ready"}catch(x){const A=x instanceof Error?x.message:String(x);s=`Error: ${k.title} — ${A}`;const G=((r==null?void 0:r.ops)??[]).concat([{instanceId:C.instanceId,opId:k.id,title:k.title,io:k.io,status:"error",error:A}]);r={pipelineId:w.id,title:w.title,status:"error",error:A,input:{type:"image",width:a.width,height:a.height,image:a},ops:G},e.runner.debug("pipeline next-step failed",{pipelineId:w.id,recipeId:o,instanceId:C.instanceId,opId:k.id,error:A})}}function O(){var G;h();const w=p(),C=g(),A={pipelines:(((G=t.listPipelines)==null?void 0:G.call(t))??t.builtIns).map(j=>({id:j.id,title:j.title})),recipes:C.map(j=>({id:j.id,title:j.title})),activePipelineId:n,activeRecipeId:o,statusText:s,description:w.description,stages:r?D(r):[],input:a?{width:a.width,height:a.height,data:a}:void 0,nextIndex:l,totalOps:d.length||w.ops.filter(j=>j.enabled!==!1).length},L=(r==null?void 0:r.output)??c??null;return U(A,L),A}return v(),{getVm:O,setActivePipeline:b,setActiveRecipe:y,setInputImageData:S,runAll:F,runNext:B,reset:v,reloadCatalogue:f}}function go(e,t,i){const n=po({runner:{getEffectiveParams:async u=>await i.getEffectiveParams(u).catch(()=>({})),debug:(u,E)=>Q({scope:"panel",kind:"debug",message:u,meta:E})}});let o=null,a=!1,s=null,r=null;function d(){const u=n.getVm();if(!(u.stages.some(I=>I.state==="error")||String(u.statusText).toLowerCase().includes("error"))){r=null;return}const P=String(u.statusText||"Pipeline error");P!==r&&(r=P,N({scope:"panel",kind:"error",message:`Pipeline: ${P}`}))}function l(){e.pipelineTuningMountEl.innerHTML=""}function c(u){return[u,`pipeline.${u}`,"pipeline"]}function f(u){const E=c(u);if(s===E[0])return;l();let P=null,I=null;for(const w of E)try{i.mount({mountEl:e.pipelineTuningMountEl,scopeRootId:w}),P=w;break}catch(C){I=C,l()}if(!P){s=null,N({scope:"panel",kind:"info",message:`Pipeline tuning mount failed for "${u}" (no matching scope).`}),Q({scope:"panel",kind:"error",message:"Pipeline tuning mount failed (no candidate scopeRootId worked)",meta:{pipelineId:u,candidates:E,error:I instanceof Error?I.message:String(I)}});return}s=P,N({scope:"panel",kind:"info",message:`Pipeline tuning mount: pipelineId=${u}, scopeRootId=${P}`})}function h(){const u=n.getVm(),E=typeof u.activePipelineId=="string"?u.activePipelineId:"segmentation";f(E)}function g(){const u=e.srcCanvasEl,E=u.width,P=u.height;if(!E||!P)return null;const I=u.getContext("2d",{willReadFrequently:!0});return I?I.getImageData(0,0,E,P):null}function p(){if(n.getVm().input)return;const E=g();E&&n.setInputImageData(E)}function m(){const u=g();u&&n.setInputImageData(u)}async function v(){const u=await i.getEffectiveParams("pipeline").catch(()=>({})),E=u==null?void 0:u.mode,P=u==null?void 0:u.recipe,I=typeof E=="string"?E:"segmentation",w=typeof P=="string"?P:"default";n.setActivePipeline(I),n.setActiveRecipe(w),h()}function b(){return o||(N({scope:"panel",kind:"info",message:"Pipeline view: create + mount"}),o=Li({hostEl:e.pipelineViewMountEl,statusEl:e.pipelineStatusEl,handlers:{onSelectPipeline:u=>{N({scope:"panel",kind:"info",message:`Pipeline select: ${u}`}),n.setActivePipeline(u),i.setParamValue("pipeline","mode",u),h(),y()},onSelectRecipe:u=>{N({scope:"panel",kind:"info",message:`Recipe select: ${u}`}),n.setActiveRecipe(u),i.setParamValue("pipeline","recipe",u),y()},onRunAll:()=>void S(),onNext:()=>void T(),onReset:()=>{n.reset();const u=g();u&&n.setInputImageData(u),Re(n.getVm()),N({scope:"panel",kind:"info",message:"Pipeline reset (reseed from source)"}),h(),y()}}}),o.mount(),h(),o)}function y(){b().render(n.getVm())}async function S(){N({scope:"panel",kind:"info",message:"Pipeline run: all"}),m();try{await n.runAll()}finally{Re(n.getVm()),y(),d()}}async function T(){N({scope:"panel",kind:"info",message:"Pipeline run: next"}),p();try{await n.runNext()}finally{Re(n.getVm()),y(),d()}}function D(){}async function U(){a=!0,N({scope:"panel",kind:"info",message:"Pipeline tab: mount()"}),m(),await n.reloadCatalogue().catch(()=>null),await v(),N({scope:"panel",kind:"info",message:"Pipeline tab: render()"}),y()}async function F(){a&&(N({scope:"panel",kind:"info",message:"Pipeline tab: refresh()"}),m(),await n.reloadCatalogue().catch(()=>null),await v(),y())}function B(){a=!1,N({scope:"panel",kind:"info",message:"Pipeline tab: unmount()"})}function O(){N({scope:"panel",kind:"info",message:"Pipeline tab: dispose()"}),o==null||o.dispose(),o=null,s=null,l()}return{bind:D,mount:U,unmount:B,refresh:F,dispose:O}}function We(e){return!!e&&typeof e=="object"}function fo(e){if(!We(e)||typeof e.id!="string"||!e.id||typeof e.title!="string"||!e.title||typeof e.implemented!="boolean"||!Array.isArray(e.ops))return!1;for(const t of e.ops)if(!We(t)||typeof t.instanceId!="string"||!t.instanceId||typeof t.opId!="string"||!t.opId||t.enabled!==void 0&&typeof t.enabled!="boolean")return!1;return!0}function ho(){const e=Ke({userPipelines:[]});async function t(){return await Ee().catch(()=>[])}function i(){return e.ops}async function n(a){let s;try{s=JSON.parse(a)}catch{throw new Error("Invalid JSON (parse failed).")}let r;if(Array.isArray(s))r=s;else if(We(s)&&Array.isArray(s.pipelines))r=s.pipelines;else throw new Error('Invalid file shape. Expected {"pipelines":[...]} or an array of pipelines.');const d=r,l=d.length,c=[];let f=0;for(const p of d){if(!fo(p)){f++;continue}c.push(p)}if(c.length===0)throw new Error("No valid pipelines found in the imported file.");const h=await Ee().catch(()=>[]),g=new Map;for(const p of h)g.set(p.id,p);for(const p of c)g.set(p.id,p);return await ro(Array.from(g.values())),{imported:c.length,skipped:f,totalInFile:l}}async function o(){const a=await Ee().catch(()=>[]),s={format:"beemage.pipeline.userPipelines.v1",exportedAt:new Date().toISOString(),pipelines:a};return JSON.stringify(s,null,2)}return{listUserPipelines:t,listOperations:i,importFromJsonText:n,exportToJsonText:o}}function Y(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function mo(e){return e.enabled!==!1}function bo(e){const t=new Map;for(const i of e)t.set(i.id,i);return t}function yo(e,t,i){const n={compactOps:i==null?void 0:i.compactOps},o=bo(t),a=Y("div",{class:"pipelineCard"}),s=Y("div",{class:"pipelineCardHead"}),r=Y("div",{style:"display:flex; flex-direction:column; gap:2px;"});r.appendChild(Y("div",{class:"pipelineCardTitle"},e.title||e.id)),r.appendChild(Y("div",{class:"muted",style:"font-size:12px;"},e.id)),s.appendChild(r);{const f=e.implemented?"implemented":"not implemented";s.appendChild(Y("div",{class:"status"},f))}a.appendChild(s),typeof e.description=="string"&&e.description.length>0&&a.appendChild(Y("div",{class:"muted",style:"font-size:12px; margin-top:6px;"},e.description));const d=Y("div",{class:"pipelineOps",style:"margin-top:10px;"}),c=Array.isArray(e.ops)?e.ops:[];if(!c.length)return d.appendChild(Y("div",{class:"muted",style:"font-size:12px;"},"No operations in this pipeline.")),a.appendChild(d),a;for(let f=0;f<c.length;f++){const h=c[f],g=o.get(h.opId),p=!mo(h),m=g?Ze(g,{compact:n.compactOps,showGroup:!0,showId:!0}):Y("div",{class:"opCard opCard--unknown",style:"padding:10px;"},`Unknown operation: ${h.opId}`);p&&m.classList.add("is-disabled"),d.appendChild(m),f<c.length-1&&d.appendChild(Y("div",{class:"pipelineConnector","aria-hidden":"true"}))}return a.appendChild(d),a}function _(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function vo(e){const{dom:t,handlers:i}=e;let n=!1,o=!1,a=null,s="all",r="all",d=null,l=null,c=null,f=null,h=null,g=null;function p(){if(h)return h;const I=_("div",{"data-role":"builderListMount",style:"margin-top:12px;"});return t.viewBuilder.appendChild(I),h=I,I}function m(){h&&(h.innerHTML="")}function v(){if(a)return a;const I=_("div",{"data-role":"builderPipelineMount",style:"margin-top:12px;"});return t.viewBuilder.appendChild(I),a=I,I}function b(){a&&(a.innerHTML="")}function y(){if(g)return g;const I=_("div",{"data-role":"builderOpsMount",style:"margin-top:12px;"});return t.viewBuilder.appendChild(I),g=I,I}function S(){g&&(g.innerHTML="")}function T(I,w){const C=_("select"),k=[{value:"all",label:"All"},{value:"image",label:"image"},{value:"mask",label:"mask"},{value:"svg",label:"svg"}];for(const x of k){const A=_("option");A.value=x.value,A.textContent=x.label,x.value===I&&(A.selected=!0),C.appendChild(A)}return C.addEventListener("change",()=>w(C.value)),C}function D(I){const w=s==="all"?!0:I.io.input===s,C=r==="all"?!0:I.io.output===r;return w&&C}function U(I){const w=v();if(w.innerHTML="",!d)return;const k=(Array.isArray(I.userPipelinesRaw)?I.userPipelinesRaw:[]).find(A=>A.id===d);if(!k)return;const x=_("div",{class:"card",style:"padding:10px;"});x.appendChild(_("div",{class:"cardTitle"},"Pipeline preview")),x.appendChild(yo(k,I.ops??[],{compactOps:!0})),w.appendChild(x)}function F(I){const w=y();w.innerHTML="";const C=_("div",{class:"card",style:"padding:10px;"});C.appendChild(_("div",{class:"cardTitle"},"All operations"));const k=I.filter(D);if(!k.length){C.appendChild(_("div",{class:"muted",style:"font-size:12px;"},"No operations match the filter.")),w.appendChild(C);return}const x=_("div",{class:"opsGrid",style:"margin-top:10px;"});for(const A of k)x.appendChild(Ze(A,{compact:!0,showGroup:!0,showId:!0}));C.appendChild(x),w.appendChild(C)}function B(I,w){const C=p();C.innerHTML="";const k=_("div",{class:"card",style:"padding:10px;"});k.appendChild(_("div",{class:"cardTitle"},"Stored user pipelines"));const x=_("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px;"}),A=_("label",{class:"fieldInline"});A.appendChild(_("span",{},"Preview pipeline")),f=_("select"),A.appendChild(f);const L=Array.isArray(w.userPipelinesRaw)?w.userPipelinesRaw:[];f.innerHTML="";{const $=_("option");$.value="",$.textContent="None",f.appendChild($);for(const re of L){const le=_("option");le.value=re.id,le.textContent=`${re.title} (${re.id})`,f.appendChild(le)}}d&&L.some($=>$.id===d)?f.value=d:(f.value="",d=null),f.addEventListener("change",()=>{d=(f?f.value:"")||null,U(w)});const G=_("label",{class:"fieldInline"});G.appendChild(_("span",{},"Filter input")),l=T(String(s),$=>{s=$==="all"?"all":$,F(w.ops??[])}),G.appendChild(l);const j=_("label",{class:"fieldInline"});if(j.appendChild(_("span",{},"Filter output")),c=T(String(r),$=>{r=$==="all"?"all":$,F(w.ops??[])}),j.appendChild(c),x.appendChild(A),x.appendChild(G),x.appendChild(j),k.appendChild(x),!I.length){k.appendChild(_("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No user pipelines stored.")),C.appendChild(k);return}const H=_("ul",{style:"margin:10px 0 0 0; padding-left:18px;"});for(const $ of I)H.appendChild(_("li",{style:"font-size:12px; margin:4px 0;"},`${$.id} — ${$.title} (${$.implemented?"implemented":"not implemented"}, ops=${$.opCount})`));k.appendChild(H),C.appendChild(k)}function O(){o||(o=!0,t.builderImportFileEl.addEventListener("change",()=>{var I;(I=t.builderImportFileEl.files)==null||I[0]}),t.btnBuilderExportEl.addEventListener("click",()=>{i.onExport()}),t.builderImportFileEl.addEventListener("change",()=>{var w;const I=((w=t.builderImportFileEl.files)==null?void 0:w[0])??null;I&&(i.onImportFile(I),t.builderImportFileEl.value="")}))}function u(){n||(n=!0,p(),v(),y())}function E(I){t.builderStatusEl.textContent=I.statusText||"Idle",B(I.pipelines,I),U(I),F(I.ops??[])}function P(){n=!1,o=!1,d=null,s="all",r="all",l=null,c=null,f=null,m(),h==null||h.remove(),h=null,b(),a==null||a.remove(),a=null,S(),g==null||g.remove(),g=null}return{bind:O,mount:u,render:E,dispose:P}}function wo(e,t){const i=new Blob([t],{type:"application/json;charset=utf-8"}),n=URL.createObjectURL(i),o=document.createElement("a");o.href=n,o.download=e,o.rel="noopener",o.click(),setTimeout(()=>URL.revokeObjectURL(n),500)}function Co(e,t){const i=ho();let n=!1,o="Idle",a=[],s=i.listOperations();const r=vo({dom:e,handlers:{onImportFile:async v=>{try{o=`Importing: ${v.name}`,c();const b=await v.text(),y=await i.importFromJsonText(b);N({scope:"panel",kind:"info",message:`Builder import: imported=${y.imported}, skipped=${y.skipped}, total=${y.totalInFile}`}),o=`Imported ${y.imported} pipeline(s) (skipped ${y.skipped}).`,await d()}catch(b){const y=b instanceof Error?b.message:String(b);N({scope:"panel",kind:"error",message:`Builder import failed: ${y}`}),Q({scope:"panel",kind:"error",message:"Builder import failed",meta:{error:y}}),o=`Import failed: ${y}`,c()}},onExport:async()=>{try{o="Exporting…",c();const v=await i.exportToJsonText();wo("beemage-user-pipelines.json",v),N({scope:"panel",kind:"info",message:"Builder export: downloaded beemage-user-pipelines.json"}),o="Exported.",c()}catch(v){const b=v instanceof Error?v.message:String(v);N({scope:"panel",kind:"error",message:`Builder export failed: ${b}`}),Q({scope:"panel",kind:"error",message:"Builder export failed",meta:{error:b}}),o=`Export failed: ${b}`,c()}}}});async function d(){const v=await i.listUserPipelines().catch(()=>[]);a=v,s=i.listOperations(),o=`Ready. User pipelines: ${v.length} · Operations: ${s.length}`,c()}function l(){const v=a??[];return{statusText:o,pipelines:v.map(b=>({id:String(b.id),title:String(b.title),implemented:!!b.implemented,opCount:Array.isArray(b.ops)?b.ops.length:0})),userPipelinesRaw:v,ops:s}}function c(){r.mount(),r.render(l())}function f(){r.bind(),e.builderStatusEl.textContent="Idle"}async function h(){n=!0,o="Loading…",c(),await d()}async function g(){n&&(o="Refreshing…",c(),await d())}function p(){n=!1}function m(){r.dispose()}return{bind:f,mount:h,refresh:g,unmount:p,dispose:m}}async function Eo(){const e=bn();await ze().catch(()=>null);const t=wn();t.start();const i=xn();globalThis.__APP__={...globalThis.__APP__,cache:i};const n=Pi({getRuntimeAvailability:()=>({opencvReady:!1}),debugTraceAppend:f=>Q({scope:"panel",kind:"debug",message:f}),actionLogAppend:f=>N({scope:"panel",kind:"info",message:f})});n.mount({mountEl:e.tuningMountEl,scopeRootId:"app"});const o=Un(e),a=Jn(e),s=go(e,t,n),r=wi(e,t),d=Ii(e),l=Co(e);o.bind(),s.bind(),a.bind(),r.bind(),d.bind(),l.bind();const c=In(e,{image:o,pipeline:s,builder:l,colors:a,settings:r,logs:d});c.bind(),c.boot()}Eo();
