import{_ as In}from"./index-BvVeibrk.js";function kn(){function e(at,Cn){if(!at)throw new Error(`[dom] Missing #${Cn}`);return at}const t=e(document.getElementById("appRoot"),"appRoot"),n=e(document.getElementById("tabImage"),"tabImage"),i=e(document.getElementById("tabColors"),"tabColors"),o=e(document.getElementById("tabSettings"),"tabSettings"),a=e(document.getElementById("tabLogs"),"tabLogs"),s=e(document.getElementById("tabPipeline"),"tabPipeline"),l=e(document.getElementById("tabBuilder"),"tabBuilder"),u=e(document.getElementById("viewImage"),"viewImage"),r=e(document.getElementById("viewColors"),"viewColors"),f=e(document.getElementById("viewSettings"),"viewSettings"),d=e(document.getElementById("viewLogs"),"viewLogs"),b=e(document.getElementById("viewPipeline"),"viewPipeline"),p=e(document.getElementById("viewBuilder"),"viewBuilder"),g=e(document.getElementById("dropZone"),"dropZone"),y=e(document.getElementById("fileInput"),"fileInput"),w=e(document.getElementById("srcCanvas"),"srcCanvas"),m=e(document.getElementById("pipelineStatus"),"pipelineStatus"),h=e(document.getElementById("pipelineTuningMount"),"pipelineTuningMount"),v=e(document.getElementById("pipelineViewMount"),"pipelineViewMount"),R=e(document.getElementById("builderImportFile"),"builderImportFile"),M=e(document.getElementById("btnBuilderExport"),"btnBuilderExport"),A=e(document.getElementById("builderStatus"),"builderStatus"),x=e(document.getElementById("colorsCanvas"),"colorsCanvas"),$=e(document.getElementById("palette"),"palette"),O=e(document.getElementById("btnColorsApply"),"btnColorsApply"),c=e(document.getElementById("btnColorsCancel"),"btnColorsCancel"),E=e(document.getElementById("btnColorsReset"),"btnColorsReset"),S=e(document.getElementById("edgesDark"),"edgesDark"),P=e(document.getElementById("edgeMaskThreshold"),"edgeMaskThreshold"),U=e(document.getElementById("edgeDilate"),"edgeDilate"),C=e(document.getElementById("maxRegionPx"),"maxRegionPx"),I=e(document.getElementById("colorsStatus"),"colorsStatus"),k=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),T=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),D=e(document.getElementById("devConfigDetails"),"devConfigDetails"),L=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),z=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),K=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),j=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),X=e(document.getElementById("logsCbDebug"),"logsCbDebug"),W=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),$e=e(document.getElementById("cfgStatus"),"cfgStatus"),Xt=e(document.getElementById("cfgOpenCvSpinner"),"cfgOpenCvSpinner"),en=e(document.getElementById("cfgOpenCvStatus"),"cfgOpenCvStatus"),tn=e(document.getElementById("cfgOpenCvReport"),"cfgOpenCvReport"),nn=e(document.getElementById("settingsEngineBox"),"settingsEngineBox"),on=e(document.getElementById("cfgUseOpenCv"),"cfgUseOpenCv"),an=e(document.getElementById("tuningMount"),"tuningMount"),sn=e(document.getElementById("settingsVersion"),"settingsVersion"),rn=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),ln=e(document.getElementById("logsLimit"),"logsLimit"),cn=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),dn=e(document.getElementById("logsStatus"),"logsStatus"),un=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),pn=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),gn=e(document.getElementById("btnLogsExport"),"btnLogsExport"),fn=e(document.getElementById("btnLogsClear"),"btnLogsClear"),hn=e(document.getElementById("logsOut"),"logsOut"),mn=e(document.getElementById("debugLimit"),"debugLimit"),bn=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),yn=e(document.getElementById("btnDebugExport"),"btnDebugExport"),vn=e(document.getElementById("btnDebugClear"),"btnDebugClear"),wn=e(document.getElementById("debugStatus"),"debugStatus"),En=e(document.getElementById("debugOut"),"debugOut");return{rootEl:t,tabImage:n,tabColors:i,tabSettings:o,tabLogs:a,tabPipeline:s,tabBuilder:l,viewImage:u,viewColors:r,viewSettings:f,viewLogs:d,viewPipeline:b,viewBuilder:p,dropZoneEl:g,fileInputEl:y,srcCanvasEl:w,pipelineStatusEl:m,pipelineTuningMountEl:h,pipelineViewMountEl:v,builderImportFileEl:R,btnBuilderExportEl:M,builderStatusEl:A,colorsCanvasEl:x,paletteEl:$,btnColorsApplyEl:O,btnColorsCancelEl:c,btnColorsResetEl:E,edgesDarkEl:S,edgeMaskThresholdEl:P,edgeDilateEl:U,maxRegionPxEl:C,colorsStatusEl:I,cfgShowDevToolsEl:k,settingsGeneralStatusEl:T,devConfigDetailsEl:D,cfgTraceConsoleEl:L,cfgActionLogMaxEl:z,cfgDebugTraceMaxEl:K,cfgFailureLogsPerRunEl:j,logsCbDebugEl:X,btnCfgResetDefaults:W,cfgStatusEl:$e,settingsVersionEl:sn,settingsGitHubLinkEl:rn,cfgOpenCvSpinner:Xt,cfgOpenCvStatus:en,cfgOpenCvReport:tn,settingsEngineBoxEl:nn,cfgUseOpenCvEl:on,tuningMountEl:an,logsLimitEl:ln,btnLogsRefresh:cn,logsStatusEl:dn,logsTrimKeepEl:un,btnLogsTrim:pn,btnLogsExport:gn,btnLogsClear:fn,logsOutEl:hn,debugLimitEl:mn,btnDebugRefresh:bn,btnDebugExport:yn,btnDebugClear:vn,debugStatusEl:wn,debugOutEl:En}}const Sn=new Set;function xn(e){Sn.add(e)}function Pn(){const e=new Set;function t(i){return e.add(i),()=>e.delete(i)}function n(){xn(o=>{for(const a of e)a(o)})}return{on:t,start:n}}const Rn=new Set;function Rt(e){for(const t of Rn)t(e,"local")}function fe(e){const t=localStorage.getItem(e);if(t!==null)try{return JSON.parse(t)}catch{return t}}function An(e,t){localStorage.setItem(e,JSON.stringify(t))}async function oe(e){if(typeof e=="string")return{[e]:fe(e)};if(Array.isArray(e)){const n={};for(const i of e)n[i]=fe(i);return n}const t={};for(const[n,i]of Object.entries(e))t[n]=localStorage.getItem(n)!==null?fe(n):i;return t}async function ae(e){const t={};for(const[n,i]of Object.entries(e)){const o=fe(n);An(n,i),t[n]={oldValue:o,newValue:i}}Rt(t)}async function tt(e){const t=Array.isArray(e)?e:[e],n={};for(const i of t){const o=fe(i);localStorage.removeItem(i),n[i]={oldValue:o,newValue:void 0}}Rt(n)}function ie(e,t,n,i){const o=Number(String(e??"").trim());return Number.isFinite(o)?Math.max(t,Math.min(n,Math.floor(o))):i}const Ge="beemage.devConfig",q={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let Ke=!1,Pe={...q};function At(e){const t=e||{};return{traceConsole:!!t.traceConsole,actionLogMax:ie(t.actionLogMax??q.actionLogMax,100,5e4,q.actionLogMax),debugTraceMax:ie(t.debugTraceMax??q.debugTraceMax,100,5e4,q.debugTraceMax),failureLogsPerRun:ie(t.failureLogsPerRun??q.failureLogsPerRun,0,5e4,q.failureLogsPerRun)}}async function He(){if(Ke)return;const e=await oe([Ge]).catch(()=>({}));Pe=At(e==null?void 0:e[Ge]),Ke=!0}function Re(){return Pe}async function Dt(e){Pe=At(e),Ke=!0,await ae({[Ge]:Pe}).catch(()=>null)}async function Dn(){await Dt({...q})}function Mn(e,t){const n={pipeline:e.tabPipeline,image:e.tabImage,builder:e.tabBuilder,colors:e.tabColors,settings:e.tabSettings,logs:e.tabLogs},i={pipeline:e.viewPipeline,image:e.viewImage,builder:e.viewBuilder,colors:e.viewColors,settings:e.viewSettings,logs:e.viewLogs};let o="image";const a=new Set;function s(){const p=Re();return!!(p!=null&&p.traceConsole)}function l(){const p=globalThis;p.__bctGlobalErrorHooksInstalled||(p.__bctGlobalErrorHooksInstalled=!0,window.addEventListener("error",g=>{var w;const y=g;console.error("[panel] window error",{message:y.message,filename:y.filename,lineno:y.lineno,colno:y.colno,error:y.error?String(y.error):null,stack:(w=y.error)!=null&&w.stack?String(y.error.stack):null})}),window.addEventListener("unhandledrejection",g=>{var y;console.error("[panel] unhandledrejection",{reason:g.reason?String(g.reason):null,stack:(y=g.reason)!=null&&y.stack?String(g.reason.stack):null})}))}s()&&l();function u(p){Object.keys(n).forEach(g=>{const y=g===p;n[g].classList.toggle("is-active",y),n[g].setAttribute("aria-selected",y?"true":"false"),i[g].hidden=!y,i[g].classList.toggle("is-active",y)})}function r(p){var g,y,w,m,h,v,R,M;if(p===o){(y=(g=t[p]).refresh)==null||y.call(g);return}(m=(w=t[o]).unmount)==null||m.call(w),o=p,u(o),a.has(o)?(M=(R=t[o]).refresh)==null||M.call(R):(a.add(o),(v=(h=t[o]).mount)==null||v.call(h))}function f(){n.image.addEventListener("click",p=>{var g;(g=p.preventDefault)==null||g.call(p),r("image")}),n.pipeline.addEventListener("click",p=>{var g;(g=p.preventDefault)==null||g.call(p),r("pipeline")}),n.colors.addEventListener("click",p=>{var g;(g=p.preventDefault)==null||g.call(p),r("colors")}),n.settings.addEventListener("click",p=>{var g;(g=p.preventDefault)==null||g.call(p),r("settings")}),n.logs.addEventListener("click",p=>{var g;(g=p.preventDefault)==null||g.call(p),r("logs")}),n.builder.addEventListener("click",p=>{var g;(g=p.preventDefault)==null||g.call(p),r("builder")})}function d(){var p,g,y,w;o="image",u(o),Object.keys(t).forEach(m=>{var h,v;return(v=(h=t[m]).boot)==null?void 0:v.call(h)}),a.has(o)?(w=(y=t[o]).refresh)==null||w.call(y):(a.add(o),(g=(p=t[o]).mount)==null||g.call(p))}function b(){Object.keys(t).forEach(p=>{var g,y;return(y=(g=t[p]).dispose)==null?void 0:y.call(g)})}return{bind:f,boot:d,activate:r,dispose:b}}function st(e){const t=e.items.length;return{items:e.items,counts:{items:t},meta:e.meta}}function Tn(){const e={items:[],meta:{}},t=new Set;function n(){const r=st(e);for(const f of t)try{f(r)}catch{}}function i(){return st(e)}function o(r){t.add(r);try{r(i())}catch{}return()=>t.delete(r)}function a(){e.items=[],e.meta={},n()}function s(r){e.meta.scopeUpdatedSince=r,n()}function l(){return String(e.meta.scopeUpdatedSince||"")}function u(r,f){e.items=r.slice(),e.meta.updatedTs=Date.now(),typeof(f==null?void 0:f.limit)=="number"&&(e.meta.limit=f.limit),n()}return{getSnapshot:i,subscribe:o,getScopeUpdatedSince:l,clearAll:a,setScopeUpdatedSince:s,setItems:u}}function Ln(e,t){function n(l){e.dropZoneEl.classList.toggle("is-hover",l)}function i(l,u){const r=l.getContext("2d",{willReadFrequently:!0});if(!r)return;const f=Math.max(1,l.width),d=Math.max(1,l.height);r.clearRect(0,0,f,d);const b=u.naturalWidth||u.width,p=u.naturalHeight||u.height;if(!b||!p)return;const g=Math.min(f/b,d/p),y=Math.max(1,Math.round(b*g)),w=Math.max(1,Math.round(p*g)),m=Math.floor((f-y)/2),h=Math.floor((d-w)/2);r.drawImage(u,m,h,y,w)}function o(l){i(e.srcCanvasEl,l)}function a(l){t.lastError=void 0,t.loadedImageName=l,t.hasImage=!0}function s(l){t.lastError=l,t.hasImage=!1}return{setHover:n,drawImageToSource:o,showLoadOk:a,showLoadError:s}}function On(){return{loadedImageName:null,hasImage:!1,lastError:void 0}}const Ae="beemage.actionLog",$n=5e3;function Bn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function Un(e){return Array.isArray(e)?e:[e]}function De(e,t,n){return Math.max(t,Math.min(n,Math.floor(e)))}async function he(){const e=await oe(Ae),t=e==null?void 0:e[Ae];return Array.isArray(t)?t:[]}async function Mt(e){await ae({[Ae]:e})}async function N(e,t){const n=De($n,100,5e4),o=Un(e).map(u=>({...u,id:Bn(),ts:Date.now()}));if(!o.length)return{total:(await he()).length};const s=(await he()).concat(o),l=s.length>n?s.slice(s.length-n):s;return await Mt(l),{total:l.length}}async function Vn(e){const t=De((e==null?void 0:e.limit)??200,1,5e4),n=De((e==null?void 0:e.offset)??0,0,1e6);let o=await he();e!=null&&e.kind&&(o=o.filter(l=>l.kind===e.kind)),e!=null&&e.scope&&(o=o.filter(l=>l.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(o=o.filter(l=>l.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(o=o.filter(l=>l.ts<=e.untilTs));const a=o.length;o=o.slice().reverse();const s=o.slice(n,n+t);return{total:a,items:s}}async function Nn(e){let n=await he();if(typeof e.beforeTs=="number"&&(n=n.filter(i=>i.ts>=e.beforeTs)),typeof e.keepLast=="number"){const i=De(e.keepLast,0,5e4);i===0?n=[]:n.length>i&&(n=n.slice(n.length-i))}return await Mt(n),{total:n.length}}async function jn(){await tt(Ae)}async function zn(e){const t=await he();return JSON.stringify(t,null,2)}const me="beemage.debugTrace",We="beemage.debugTrace.enabled",Fn=2e3;function _n(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function Je(e,t,n){return Math.max(t,Math.min(n,Math.floor(e)))}async function Me(){const e=await oe(me),t=e==null?void 0:e[me];return Array.isArray(t)?t:[]}async function Gn(e){await ae({[me]:e})}async function nt(){const e=await oe(We);return!!(e!=null&&e[We])}async function Tt(e){await ae({[We]:!!e}),e||await tt(me)}async function Lt(){await tt(me)}async function Y(e,t){if(!await nt())return{total:0};const i=Je((t==null?void 0:t.max)??Fn,100,5e4),o=(Array.isArray(e)?e:[e]).map(u=>({...u,id:_n(),ts:Date.now()}));if(!o.length)return{total:(await Me()).length};const s=(await Me()).concat(o),l=s.length>i?s.slice(s.length-i):s;return await Gn(l),{total:l.length}}async function Ot(e){const t=Je((e==null?void 0:e.limit)??200,1,5e4),n=Je((e==null?void 0:e.offset)??0,0,1e6),i=(e==null?void 0:e.reverse)??!0,o=await Me(),a=o.length,l=(i?o.slice().reverse():o).slice(n,n+t);return{total:a,items:l}}async function $t(e){const t=await Me();return JSON.stringify(t,null,e!=null&&e.pretty?2:0)}const Bt=Object.freeze(Object.defineProperty({__proto__:null,append:Y,clear:Lt,exportJson:$t,isEnabled:nt,list:Ot,setEnabled:Tt},Symbol.toStringTag,{value:"Module"}));function Kn(e,t){const n=On(),i=Ln(e,n);async function o(f){if(!f.type.startsWith("image/"))throw new Error(`Unsupported file type: ${f.type||"unknown"}`);const d=URL.createObjectURL(f);try{const b=new Image;return b.decoding="async",b.src=d,typeof b.decode=="function"?await b.decode():await new Promise((p,g)=>{b.onload=()=>p(),b.onerror=()=>g(new Error("Image decode failed."))}),b}finally{URL.revokeObjectURL(d)}}async function a(f){const d=await o(f);i.drawImageToSource(d),i.showLoadOk(f.name),N({scope:"panel",kind:"info",message:`Input loaded: ${f.name}`}),Y({scope:"panel",kind:"info",message:"Mage input loaded into srcCanvas",meta:{name:f.name,type:f.type,size:f.size,canvasW:e.srcCanvasEl.width,canvasH:e.srcCanvasEl.height,naturalW:d.naturalWidth||d.width,naturalH:d.naturalHeight||d.height}})}function s(){e.dropZoneEl.addEventListener("dragover",f=>{f.preventDefault(),i.setHover(!0)}),e.dropZoneEl.addEventListener("dragleave",()=>i.setHover(!1)),e.dropZoneEl.addEventListener("drop",f=>{var b,p;f.preventDefault(),i.setHover(!1);const d=(p=(b=f.dataTransfer)==null?void 0:b.files)==null?void 0:p[0];d&&a(d).catch(g=>{const y=g instanceof Error?g.message:String(g);i.showLoadError(y),N({scope:"panel",kind:"error",message:`Input load failed: ${y}`}),Y({scope:"panel",kind:"error",message:"Input load failed",meta:{error:y}})})}),e.fileInputEl.addEventListener("change",()=>{var d;const f=(d=e.fileInputEl.files)==null?void 0:d[0];f&&(a(f).catch(b=>{const p=b instanceof Error?b.message:String(b);i.showLoadError(p),N({scope:"panel",kind:"error",message:`Input load failed: ${p}`}),Y({scope:"panel",kind:"error",message:"Input load failed",meta:{error:p}})}),e.fileInputEl.value="")})}function l(){s()}function u(){}function r(){}return{id:"image",bind:l,mount:u,unmount:r}}function Be(e,t,n){return Number.isFinite(e)?Math.max(t,Math.min(n,Math.trunc(e))):t}function Hn(e,t,n){return Math.round(.2126*e+.7152*t+.0722*n)}function Ut(e){return{edgesDark:!!(e.edgesDark??!0),edgeThreshold:Be(e.edgeThreshold??80,0,255),edgeDilate:Be(e.edgeDilate??2,0,6),maxRegionPx:Be(e.maxRegionPx??2e5,1e3,1e7)}}function Wn(e,t,n){const{data:i,width:o,height:a}=e,s=new Uint8Array(o*a);for(let l=0,u=0;l<s.length;l++,u+=4){const r=i[u+0],f=i[u+1],d=i[u+2];if(i[u+3]===0){s[l]=0;continue}const p=Hn(r,f,d),g=t?p<=n:p>=255-n;s[l]=g?1:0}return s}function Jn(e,t,n,i){if(i<=0)return e;let o=e;for(let a=0;a<i;a++){const s=new Uint8Array(t*n);for(let l=0;l<n;l++)for(let u=0;u<t;u++){const r=l*t+u;if(o[r]){s[r]=1;continue}let f=0;for(let d=-1;d<=1&&!f;d++){const b=l+d;if(!(b<0||b>=n))for(let p=-1;p<=1;p++){const g=u+p;if(!(g<0||g>=t)&&o[b*t+g]){f=1;break}}}s[r]=f}o=s}return o}function qn(e,t,n,i,o,a){const s=t*i+e;if(n[s])return{ok:!1,message:"Click is on an edge; pick inside a region."};const l=new Uint8Array(i*o),u=new Int32Array(i*o),r=new Int32Array(i*o);let f=0,d=0;u[d]=e,r[d]=t,d++,l[s]=1;let b=1;for(;f<d;){const p=u[f],g=r[f];f++;const y=[[p-1,g],[p+1,g],[p,g-1],[p,g+1]];for(const[w,m]of y){if(w<0||w>=i||m<0||m>=o)continue;const h=m*i+w;if(!l[h]&&!n[h]&&(l[h]=1,u[d]=w,r[d]=m,d++,b++,b>a))return{ok:!1,message:`Region too large (>${a}px). Increase Max region or fix gaps.`}}}return{ok:!0,mask:l}}function Yn(e,t,n,i){const o=new Uint8Array(n*i);for(let a=1;a<i-1;a++)for(let s=1;s<n-1;s++){const l=a*n+s;if(!e[l])continue;const u=(a-1)*n+s,r=(a+1)*n+s,f=a*n+(s-1),d=a*n+(s+1);(!e[u]||!e[r]||!e[f]||!e[d]||t[u]||t[r]||t[f]||t[d])&&(o[l]=1)}return o}function Zn(e,t,n,i){const o=Ut(i),a=e.width,s=e.height;let l=Wn(e,o.edgesDark,o.edgeThreshold);l=Jn(l,a,s,o.edgeDilate);const u=qn(t,n,l,a,s,o.maxRegionPx);if(!u.ok)return{ok:!1,message:u.message};const r=Yn(u.mask,l,a,s);return{ok:!0,preview:{mask:u.mask,outline:r,w:a,h:s}}}function Qn(e,t,n){const i=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),o=n.replace("#",""),a=parseInt(o.slice(0,2),16),s=parseInt(o.slice(2,4),16),l=parseInt(o.slice(4,6),16),u=i.data;for(let r=0,f=0;r<t.mask.length;r++,f+=4)t.mask[r]&&(u[f+0]=a,u[f+1]=s,u[f+2]=l);return i}function Ue(e,t,n){return Number.isFinite(e)?Math.max(t,Math.min(n,Math.trunc(e))):t}function rt(e){const t=(e||"").trim();if(!t)return null;const n=t.startsWith("#")?t:`#${t}`;return/^#[0-9a-fA-F]{6}$/.test(n)?n.toLowerCase():null}function Xn(e){let t="#ff3b30",n=[],i=null;function o(y){e.colorsStatusEl.textContent=y||""}function a(){const y=!!e.edgesDarkEl.checked,w=Ue(parseInt(e.edgeMaskThresholdEl.value,10),0,255),m=Ue(parseInt(e.edgeDilateEl.value,10),0,6),h=Ue(parseInt(e.maxRegionPxEl.value,10),1e3,1e7);return e.edgeMaskThresholdEl.value=String(w),e.edgeDilateEl.value=String(m),e.maxRegionPxEl.value=String(h),Ut({edgesDark:y,edgeThreshold:w,edgeDilate:m,maxRegionPx:h})}function s(y){const w=rt(y);if(w){t=w;for(const m of Array.from(e.paletteEl.querySelectorAll(".paletteItem"))){const h=m.dataset.hex||"";m.classList.toggle("is-selected",h===t)}}}function l(){return t}function u(y){n=y.slice(),e.paletteEl.innerHTML="";for(const w of n){const m=rt(w);if(!m)continue;const h=document.createElement("button");h.type="button",h.className="paletteItem",h.style.background=m,h.dataset.hex=m,h.setAttribute("role","listitem"),h.setAttribute("aria-label",`Select ${m}`),h.addEventListener("click",()=>{s(m)}),e.paletteEl.appendChild(h)}s(t)}function r(y){const w=e.colorsCanvasEl;w.width=y.width,w.height=y.height,w.getContext("2d").putImageData(y,0,0)}function f(y,w){r(y);const m=e.colorsCanvasEl.getContext("2d"),{outline:h,w:v,h:R}=w,M=m.getImageData(0,0,v,R),A=M.data;for(let x=0,$=0;x<h.length;x++,$+=4)h[x]&&(A[$+0]=255,A[$+1]=60,A[$+2]=60,A[$+3]=220);m.putImageData(M,0,0)}function d(y){e.btnColorsApplyEl.disabled=!y}function b(y){e.btnColorsCancelEl.disabled=!y}function p(y){i=y}function g(){o("Idle"),d(!1),b(!1),e.colorsCanvasEl.addEventListener("click",y=>{if(!i)return;const w=e.colorsCanvasEl.getBoundingClientRect(),m=Math.floor((y.clientX-w.left)/w.width*e.colorsCanvasEl.width),h=Math.floor((y.clientY-w.top)/w.height*e.colorsCanvasEl.height);i(m,h)})}return{bind:g,setStatus:o,getSettings:a,setSelectedColor:s,getSelectedColor:l,renderPalette:u,drawBase:r,drawPreview:f,setApplyEnabled:d,setCancelEnabled:b,onCanvasClick:p}}let Vt={type:"none"};function ge(e){Vt=e}function lt(){return Vt}function Ve(e){var s,l,u,r,f;if(!e){ge({type:"none"});return}const t=(s=e.outputSvg)==null?void 0:s.svg;if(typeof t=="string"&&t.length>0){ge({type:"svg",svg:t});return}const n=(l=e.outputImage)==null?void 0:l.data;if(n){ge({type:"image",image:n});return}const i=(u=e.outputMask)==null?void 0:u.data,o=(r=e.outputMask)==null?void 0:r.width,a=(f=e.outputMask)==null?void 0:f.height;if(i&&typeof o=="number"&&typeof a=="number"){ge({type:"mask",mask:i,width:o,height:a});return}ge({type:"none"})}const ei=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#a2845e","#8e8e93","#1c1c1e","#ffffff","#000000","#4cd964","#5ac8fa","#ff6b6b","#7aa2ff","#f5a623","#50e3c2"];function ti(e,t){const n=Xn(e);let i=null,o=null;function a(p){n.setStatus(p)}function s(p,g,y){const w=new ImageData(g,y),m=w.data;for(let h=0,v=0;h<p.length;h++,v+=4){const M=(p[h]??0)>0?0:255;m[v+0]=M,m[v+1]=M,m[v+2]=M,m[v+3]=255}return w}function l(){const p=lt();return p.type==="image"?p.image:p.type==="mask"?s(p.mask,p.width,p.height):null}function u(){return lt().type==="svg"?"Pipeline output is SVG. Colors needs an image or mask output.":"No pipeline output available. Run the Pipeline first."}function r(){const p=l();if(!p){i=null,o=null,n.setApplyEnabled(!1),n.setCancelEnabled(!1),a(u());return}i=p,o=null,n.drawBase(i),n.setApplyEnabled(!1),n.setCancelEnabled(!1),a("Ready. Pick a color, click inside a region.")}function f(){if(i){n.drawBase(i);return}const p=l();if(!p){a(u());return}i=p,o=null,n.drawBase(i),n.setApplyEnabled(!1),n.setCancelEnabled(!1),a("Loaded pipeline output. Pick a color, click inside a region.")}function d(){if(!i||!o)return;const p=n.getSelectedColor();i=Qn(i,o,p),o=null,n.drawBase(i),n.setApplyEnabled(!1),n.setCancelEnabled(!1),a("Fill applied. Click another region.")}function b(){i&&(o=null,n.drawBase(i),n.setApplyEnabled(!1),n.setCancelEnabled(!1),a("Preview canceled."))}return{bind(){n.bind(),n.renderPalette(ei),n.onCanvasClick((p,g)=>{if(!i){a(u());return}const y=n.getSettings(),w=Zn(i,p,g,y);if(!w.ok){o=null,n.setApplyEnabled(!1),n.setCancelEnabled(!1),a(w.message);return}o=w.preview,n.drawPreview(i,o),n.setApplyEnabled(!0),n.setCancelEnabled(!0),a("Preview shown. Apply fill or cancel.")}),e.btnColorsApplyEl.addEventListener("click",()=>d()),e.btnColorsCancelEl.addEventListener("click",()=>b()),e.btnColorsResetEl.addEventListener("click",()=>r()),e.tabColors.addEventListener("click",()=>{queueMicrotask(()=>f())}),a("Idle"),n.setApplyEnabled(!1),n.setCancelEnabled(!1)}}}const ct="0.1.6";function Ne(e){return`[BCT][${e}]`}function ni(e){function t(...a){e.traceOn()&&console.log(Ne("trace"),...a)}function n(...a){console.warn(Ne("warn"),...a)}function i(...a){console.error(Ne("error"),...a)}function o(a,s){t(a,s),Y({scope:e.scope,kind:"debug",message:a,meta:s})}return{logTrace:t,logWarn:n,logError:i,traceScope:o}}const{logTrace:V,logWarn:Se,logError:re,traceScope:Nt}=ni({scope:"panel",traceOn:()=>!!Re().traceConsole});let H=0;function J(){return H>0}function te(e,t){if(t){jt(e);return}H=0,Te(e,!1)}async function ii(e,t){const n=`${Date.now()}-${Math.random().toString(16).slice(2)}`;V("[state] withBusy: enter",{id:n,busyCount:H}),jt(e,n);try{V("[state] withBusy: before await fn",{id:n,busyCount:H});const i=await t();return V("[state] withBusy: after await fn (resolved)",{id:n,busyCount:H}),i}catch(i){throw re("[state] withBusy: fn threw",{id:n,busyCount:H,msg:String((i==null?void 0:i.message)??i),stack:String((i==null?void 0:i.stack)??"")}),i}finally{V("[state] withBusy: finally before endBusy",{id:n,busyCount:H}),oi(e,n),V("[state] withBusy: finally after endBusy",{id:n,busyCount:H})}}function jt(e,t){H++,V("[state] beginBusy",{id:t,busyCount:H}),H===1&&Te(e,!0)}function oi(e,t){if(H--,V("[state] endBusy: dec",{id:t,busyCount:H}),H<=0){H=0,V("[state] endBusy: applying busy=false",{id:t,busyCount:H}),Te(e,!1);return}H===0&&(V("[state] endBusy: applying busy=false (redundant branch)",{id:t,busyCount:H}),Te(e,!1))}function Te(e,t){e.rootEl.classList.toggle("is-busy",t),e.cfgShowDevToolsEl.disabled=!1,e.fileInputEl.disabled=t,e.cfgTraceConsoleEl.disabled=t,e.cfgActionLogMaxEl.disabled=t,e.cfgDebugTraceMaxEl.disabled=t,e.cfgFailureLogsPerRunEl.disabled=t,e.btnCfgResetDefaults.disabled=t,e.logsCbDebugEl.disabled=t,e.cfgUseOpenCvEl.disabled=t,e.logsLimitEl.disabled=t,e.btnLogsRefresh.disabled=t,e.logsTrimKeepEl.disabled=t,e.btnLogsTrim.disabled=t,e.btnLogsExport.disabled=t,e.btnLogsClear.disabled=t,e.debugLimitEl.disabled=t,e.btnDebugRefresh.disabled=t,e.btnDebugExport.disabled=t,e.btnDebugClear.disabled=t,e.btnColorsApplyEl.disabled=t,e.btnColorsCancelEl.disabled=t,e.btnColorsResetEl.disabled=t,e.edgesDarkEl.disabled=t,e.edgeMaskThresholdEl.disabled=t,e.edgeDilateEl.disabled=t,e.maxRegionPxEl.disabled=t;for(const n of Array.from(e.paletteEl.querySelectorAll("button")))n.disabled=t;e.colorsCanvasEl.style.pointerEvents=t?"none":"auto"}const it={native:{available:!0},opencv:{available:!1,reason:"OpenCV not loaded"}};function ai(e){it[e]={available:!0}}function si(e,t){it[e]={available:!1,reason:t}}function le(){return it.opencv.available===!0}async function ri(e){const t=new URL(e.opencvJsRel,document.baseURI).toString(),n=new URL(e.opencvWasmRel,document.baseURI).toString(),i=globalThis;i.Module=i.Module||{},i.Module.locateFile=o=>o.endsWith(".wasm")?n:o,i.Module.print=()=>{},i.Module.printErr=()=>{},i.cv||await li(t),await ci(e.timeoutMs)}function li(e){return new Promise((t,n)=>{const i=document.createElement("script");i.src=e,i.async=!0;const o=15e3,a=window.setTimeout(()=>{s(),n(new Error(`OpenCV script load timeout after ${o}ms: ${e}`))},o);function s(){window.clearTimeout(a),i.onload=null,i.onerror=null}i.onload=()=>{s(),t()},i.onerror=()=>{s(),n(new Error(`Failed to load OpenCV script: ${e}`))},document.head.appendChild(i)})}async function ci(e){var i;const t=Date.now(),n=globalThis;for(;Date.now()-t<e;){try{if(n.cv&&typeof n.cv.Mat=="function"){const o=new n.cv.Mat;(i=o.delete)==null||i.call(o);return}}catch{}await new Promise(o=>setTimeout(o,75))}throw new Error(`OpenCV initialization timeout after ${e}ms`)}async function di(){try{await ri({opencvJsRel:"../assets/opencv/opencv.js",opencvWasmRel:"../assets/opencv/opencv.wasm",timeoutMs:2e4}),ai("opencv")}catch(e){throw si("opencv",e!=null&&e.message?String(e.message):String(e)),e}}function _(e,t,n,i,o,a,s){return{id:e,title:t,implementedEngines:n,defaultEnginePolicy:i,params:o,children:a,description:s}}function ui(e){const t=new Map,n=new Map;function i(o,a){if(t.has(o.id))throw new Error(`[tuning] Duplicate component id: ${o.id}`);t.set(o.id,o),n.set(o.id,a);for(const s of o.children??[])i(s,o.id)}return i(e,null),{root:e,byId:t,parentById:n}}function zt(){const e=_("app","BeeMage",["native","opencv"],"native",{},[_("edge","Edge",["native","opencv"],"auto",{},[_("edge.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),_("edge.threshold","Threshold",["native","opencv"],"auto",{manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128}},void 0,"Convert image into a binary mask before edge extraction."),_("edge.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:3},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Clean the mask before extracting edges."),_("edge.extract","Edge extract",["native","opencv"],"auto",{},void 0,"Extract a 1px outline from the cleaned mask.")],"Fixed-order edge pipeline (image -> mask -> edges). Presets configure each step."),_("svg","SVG",["native","opencv"],"auto",{},[_("svg.create","Create SVG",["native","opencv"],"auto",{scale:{kind:"number",label:"Scale",min:1,max:10,step:1,default:1},transparentBg:{kind:"number",label:"Transparent bg (0/1)",min:0,max:1,step:1,default:1},color:{kind:"text",label:"Color",default:"#3bca1e"}},void 0,"Convert the edge mask into an SVG.")],"SVG generation parameters."),_("segmentation","Segmentation",["native","opencv"],"auto",{},[_("segmentation.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),_("segmentation.denoise","Denoise",["native","opencv"],"auto",{denoiseAlgo:{kind:"number",label:"Denoise algo",min:0,max:2,step:1,default:1},blurK:{kind:"number",label:"Blur kernel",min:1,max:21,step:2,default:3},bilateralSigma:{kind:"number",label:"Bilateral sigma",min:1,max:150,step:1,default:35}},void 0,"Reduce noise before thresholding."),_("segmentation.color","Color / Gray",["native","opencv"],"auto",{colorMode:{kind:"number",label:"Color mode",min:0,max:3,step:1,default:1},hsvChannel:{kind:"number",label:"HSV channel",min:0,max:2,step:1,default:2}},void 0,"Select color space / channel features for thresholding."),_("segmentation.threshold","Threshold",["native","opencv"],"auto",{thresholdAlgo:{kind:"number",label:"Threshold algo",min:0,max:3,step:1,default:1},manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128},adaptBlock:{kind:"number",label:"Adaptive block",min:3,max:101,step:2,default:31},adaptC:{kind:"number",label:"Adaptive C",min:-50,max:50,step:1,default:3}},void 0,"Convert features into a binary mask."),_("segmentation.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:5},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Remove specks, fill holes, and stabilize regions.")],"Fixed-order segmentation pipeline. Presets configure each step."),_("image","iMage",["native","opencv"],"auto",{},[_("mage.process","Process",["native"],"auto",{imageScale:{kind:"number",label:"Processing scale",min:25,max:100,step:5,default:100},edgeThreshold:{kind:"number",label:"Edge threshold",min:1,max:255,step:1,default:70},invertOutput:{kind:"boolean",label:"White background",default:!0}}),_("mage.clean","Clean & Smooth",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:500,step:1,default:12},cleanRadius:{kind:"number",label:"Repair strength",min:1,max:3,step:1,default:1},cleanBinaryThreshold:{kind:"number",label:"Binary threshold",min:1,max:254,step:1,default:128}},[_("mage.clean.threshold","Threshold",["native"],"auto",{}),_("mage.clean.removeSmallComponents","Remove small components",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:5e3,step:1,default:12}},void 0,"Remove connected components smaller than the minimum area."),_("mage.clean.repair","Repair gaps",["native"],"auto",{}),_("mage.clean.smooth","Smooth mask",["native"],"auto",{}),_("mage.clean.quality","Quality metrics",["native"],"auto",{})]),_("mage.vectorize","Vectorize (SVG)",["native"],"native",{pathSmoothIters:{kind:"number",label:"Path smoothing",min:0,max:4,step:1,default:2}})]),_("colors","Colors",["native"],"auto",{},[_("colors.fill","Region fill",["native"],"auto",{edgesDark:{kind:"boolean",label:"Edges are dark",default:!0},edgeMaskThreshold:{kind:"number",label:"Edge threshold",min:0,max:255,step:1,default:80},edgeDilate:{kind:"number",label:"Gap close (px)",min:0,max:6,step:1,default:2},maxRegionPx:{kind:"number",label:"Max region (px)",min:1e3,step:1e3,default:2e5}})]),_("pipeline","Pipeline (UI)",["native","opencv"],"auto",{mode:{kind:"text",label:"Pipeline",default:"segmentation"},recipe:{kind:"text",label:"Recipe",default:"default"}},void 0,"UI state for the Pipeline tab (selected pipeline + recipe).")]);return ui(e)}function pi(e){return e.default}function gi(e,t){const n={};for(const[i,o]of Object.entries(e))n[i]=pi(o);for(const[i,o]of Object.entries(t??{}))n[i]=o;return n}function fi(e,t,n){var o;let i=e;for(;i;){const a=t.byId.get(i);if(!a)throw new Error(`[tuning] Unknown component: ${i}`);const l=((o=n[i])==null?void 0:o.enginePolicy)??a.defaultEnginePolicy;if(l!=="inherit")return l;i=t.parentById.get(i)??null}return"native"}function hi(e,t,n){const i=n.opencvReady&&e.includes("opencv");return e.includes("native")||e.length,t==="native"?{engine:"native"}:t==="opencv"?i?{engine:"opencv"}:{engine:"native",fallbackReason:n.opencvReady?"Policy=opencv, but component has no OpenCV implementation.":"Policy=opencv, but OpenCV is not available at runtime."}:t==="auto"?i?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}function Ft(e,t,n,i){var r;const o=t.byId.get(e);if(!o)throw new Error(`[tuning] Unknown component: ${e}`);const a=fi(e,t,n),{engine:s,fallbackReason:l}=hi(o.implementedEngines,a,i),u=gi(o.params,(r=n[e])==null?void 0:r.params);return{id:e,policy:a,engine:s,fallbackReason:l,params:u}}const qe="beemage.tuning.components.v1";async function be(){const e=await oe([qe]).catch(()=>({})),t=e==null?void 0:e[qe];return!t||typeof t!="object"?{}:t}async function _t(e){await ae({[qe]:e}).catch(()=>null)}async function je(e,t){const n=await be(),i=n[e]??{};n[e]={enginePolicy:t.enginePolicy??i.enginePolicy,params:{...i.params??{},...t.params??{}}},await _t(n)}async function dt(e){const t=await be();delete t[e],await _t(t)}function mi(){return{opencvReady:le()}}function bi(e){return Array.isArray(e.children)&&e.children.length>0}function Gt(e){const{id:t,registry:n,stored:i,runtime:o}=e,a=n.byId.get(t);if(!a)throw new Error(`[tuning] Unknown component: ${t}`);const s=Ft(t,n,i,o),l=i[t],u=l==null?void 0:l.enginePolicy,r=l==null?void 0:l.params,f=a.implementedEngines.includes("opencv"),d=!!o.opencvReady,b=[];for(const p of a.children??[])b.push(Gt({id:p.id,registry:n,stored:i,runtime:o}));return{id:a.id,title:a.title,description:a.description,isGroup:bi(a),implementedEngines:a.implementedEngines,storedPolicy:u,storedParams:r,effectivePolicy:s.policy,effectiveEngine:s.engine,fallbackReason:s.fallbackReason,paramsSchema:a.params,effectiveParams:s.params,canImplementOpenCv:f,runtimeOpenCvReady:d,children:b}}function Kt(e={}){const t=e.registry??zt(),n=e.getRuntimeAvailability??mi;async function i(u="app"){const r=await be(),f=n();if(!t.byId.get(u))throw new Error(`[tuning] Unknown scope: ${u}`);const b=Gt({id:u,registry:t,stored:r,runtime:f});return{scopeId:u,runtime:f,stored:r,root:b}}async function o(u,r){await je(u,{enginePolicy:r})}async function a(u,r,f){await je(u,{params:{[r]:f}})}async function s(u){await dt(u)}async function l(u,r){const d=(await be())[u];if(!(d!=null&&d.params))return;const b={...d.params??{}};delete b[r];const p=typeof d.enginePolicy=="string",g=Object.keys(b).length>0;if(!p&&!g){await dt(u);return}await je(u,{enginePolicy:d.enginePolicy,params:b})}return{getRegistry:()=>t,loadTree:i,setEnginePolicy:o,setParam:a,resetNode:s,resetParam:l}}function F(e,t,n){const i=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))i.setAttribute(o,a);return typeof n=="string"&&(i.textContent=n),i}function ut(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function yi(e){return e.fallbackReason?`${e.effectiveEngine} (fallback)`:e.effectiveEngine}function vi(e){const t=[{value:"native",label:"Native"},{value:"auto",label:"Auto"},...e.canImplementOpenCv?[{value:"opencv",label:"OpenCV"}]:[]];return e.isRoot?t:[{value:"inherit",label:"Inherit"},...t]}function wi(e){return!1}function Ei(e,t,n){var o;const i=(o=e.storedParams)==null?void 0:o[t];return typeof i<"u"&&i!==n}function Ci(e){var d;const{node:t,compId:n,key:i,schema:o,value:a,handlers:s}=e,l=F("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),u=F("label",{class:"fieldInline"}),r=F("span",void 0,o.label);u.appendChild(r);let f;if(o.kind==="number"?(f=F("input"),f.type="number",typeof o.min=="number"&&(f.min=String(o.min)),typeof o.max=="number"&&(f.max=String(o.max)),typeof o.step=="number"&&(f.step=String(o.step)),f.value=String(a??o.default),f.addEventListener("change",()=>{const b=Number(f.value);s.onSetParam(n,i,Number.isFinite(b)?b:o.default)})):o.kind==="boolean"?(f=F("input"),f.type="checkbox",f.checked=!!a,f.addEventListener("change",()=>{s.onSetParam(n,i,!!f.checked)})):(f=F("input"),f.type="text",f.value=String(a??o.default),f.addEventListener("change",()=>{s.onSetParam(n,i,String(f.value??o.default))})),u.appendChild(f),l.appendChild(u),s.onResetParam&&typeof((d=t.storedParams)==null?void 0:d[i])<"u"){const b=F("button",{type:"button"},"Reset");b.addEventListener("click",p=>{var g;p.preventDefault(),(g=s.onResetParam)==null||g.call(s,n,i)}),l.appendChild(b)}return Ei(t,i,a)&&l.appendChild(F("span",{class:"muted",style:"font-size:12px;"},"override")),l}function Ht(e){const{node:t,depth:n,isRoot:i,handlers:o,treeScopeId:a}=e,s=F("div",{style:`margin-left:${Math.min(n*14,56)}px; margin-top:10px;`}),l=F("div",{style:"border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:10px; background:rgba(0,0,0,0.12);"}),u=F("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),r=F("div");r.appendChild(F("div",{style:"font-weight:700;"},t.title)),t.description&&r.appendChild(F("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},t.description)),t.isGroup&&r.appendChild(F("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},"Group (policy affects children)")),u.appendChild(r);const f=F("div",{class:"row",style:"align-items:center; gap:10px;"});f.appendChild(F("span",{class:"qBadge"},yi(t)));const d=F("select");d.style.background="rgba(255,255,255,0.05)",d.style.border="1px solid rgba(255,255,255,0.08)",d.style.color="rgba(255,255,255,0.92)",d.style.borderRadius="10px",d.style.padding="6px 8px";const b=vi({isRoot:i,canImplementOpenCv:t.canImplementOpenCv});for(const v of b){const R=F("option");R.value=v.value,R.textContent=v.label,d.appendChild(R)}const p=new Set(b.map(v=>v.value)),g=t.effectivePolicy;p.has(g)?d.value=g:d.value=i?"native":"inherit",d.addEventListener("change",()=>{o.onSetPolicy(t.id,d.value)}),f.appendChild(d);const y=typeof t.storedPolicy<"u"||t.storedParams&&Object.keys(t.storedParams).length>0;if(o.onResetNode&&y){const v=F("button",{type:"button"},"Reset node");v.addEventListener("click",R=>{var M;R.preventDefault(),(M=o.onResetNode)==null||M.call(o,t.id)}),f.appendChild(v)}u.appendChild(f),l.appendChild(u),t.fallbackReason?l.appendChild(F("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},t.fallbackReason)):t.effectivePolicy==="opencv"&&!t.runtimeOpenCvReady&&l.appendChild(F("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},"OpenCV policy selected, but OpenCV is not available at runtime. It will fall back to native."));const w=Object.keys(t.paramsSchema??{}),m=w.length>0,h=t.children.length>0;if(m||h){const v=F("details",{style:"margin-top:10px;"});v.open=wi();const R=F("summary",{style:"cursor:pointer; user-select:none;"},"Details");if(v.appendChild(R),m){const M=F("div",{style:"margin-top:10px;"});M.appendChild(F("div",{class:"muted",style:"font-weight:600; margin-bottom:6px;"},"Parameters"));for(const A of w){const x=t.paramsSchema[A],$=t.effectiveParams[A];M.appendChild(Ci({node:t,compId:t.id,key:A,schema:x,value:$,handlers:o}))}v.appendChild(M)}if(h){const M=F("div",{style:"margin-top:10px;"});for(const A of t.children)M.appendChild(Ht({node:A,depth:n+1,isRoot:!1,handlers:o,treeScopeId:a}));v.appendChild(M)}l.appendChild(v)}return s.appendChild(l),s}function Wt(e,t){let n=!1;function i(a){if(n)return;ut(e);const s=a.scopeId==="app",l=F("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"});l.appendChild(F("div",{style:"font-weight:700;"},"Tuning")),l.appendChild(F("div",{class:"muted",style:"font-size:12px;"},`OpenCV runtime: ${a.runtime.opencvReady?"ready":"not available"}`)),e.appendChild(l),e.appendChild(Ht({node:a.root,depth:0,isRoot:s,handlers:t,treeScopeId:a.scopeId}))}function o(){n=!0,ut(e)}return{render:i,dispose:o}}function Ii(){let e=!1,t={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},n=!1,i="",o="";function a(r){e=r}function s(r){t={...t,...r}}function l(r){n=r}function u(r){typeof r.general=="string"&&(i=r.general),typeof r.dev=="string"&&(o=r.dev)}return{get showDevTools(){return e},get dev(){return t},get debugEnabled(){return n},get generalStatus(){return i},get devStatus(){return o},setShowDevTools:a,setDev:s,setDebugEnabled:l,setStatus:u}}function ki(e){function t(r){e.settingsGeneralStatusEl.textContent=r||""}function n(r){e.cfgStatusEl.textContent=r||""}function i(r){e.cfgShowDevToolsEl.checked=r}function o(r){e.tabLogs.hidden=!r,e.devConfigDetailsEl.classList.toggle("is-hidden",!r),r||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function a(r){e.cfgTraceConsoleEl.checked=!!r.traceConsole,e.cfgActionLogMaxEl.value=String(r.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(r.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(r.failureLogsPerRun??50)}function s(r){e.logsCbDebugEl.checked=r}function l(r,f){e.settingsVersionEl.textContent=r||"—",e.settingsGitHubLinkEl.href=f||"#",e.settingsGitHubLinkEl.hidden=!f}function u(r){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=r,e.cfgActionLogMaxEl.disabled=r,e.cfgDebugTraceMaxEl.disabled=r,e.cfgFailureLogsPerRunEl.disabled=r,e.btnCfgResetDefaults.disabled=r,e.logsCbDebugEl.disabled=r,e.cfgUseOpenCvEl.disabled=r}return{setGeneralStatus:t,setDevStatus:n,setShowDevToolsChecked:i,setDevToolsVisible:o,setDevConfig:a,setDebugEnabledChecked:s,setAbout:l,setBusy:u}}const ze="template.settings.showDevTools",Fe="beemage.settings.engine.useOpenCv";function Si(){var e,t;try{const n=(e=globalThis==null?void 0:globalThis.chrome)==null?void 0:e.runtime,i=(t=n==null?void 0:n.getManifest)==null?void 0:t.call(n),o=typeof(i==null?void 0:i.version)=="string"?i.version:"";if(V("Settings: getManifestVersion manifest found version is ",{v:o}),o)return o}catch{}return V("Settings: getManifestVersion fallback",{APP_VERSION:ct}),ct}function _e(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??q.actionLogMax),debugTraceMax:Number(e.debugTraceMax??q.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??q.failureLogsPerRun)}}function xi(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:ie(e.cfgActionLogMaxEl.value,100,5e4,q.actionLogMax),debugTraceMax:ie(e.cfgDebugTraceMaxEl.value,100,5e4,q.debugTraceMax),failureLogsPerRun:ie(e.cfgFailureLogsPerRunEl.value,0,5e4,q.failureLogsPerRun)}}async function pt(e){const t=Bt;return typeof t.setEnabled=="function"?(await t.setEnabled(e),{ok:!0}):typeof t.enable=="function"&&typeof t.disable=="function"?(await(e?t.enable():t.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function Pi(e,t){const n=Ii(),i=ki(e),o=Kt({getRuntimeAvailability:()=>({opencvReady:e.cfgUseOpenCvEl.checked&&le()})}),a=Wt(e.tuningMountEl,{onSetPolicy:async(c,E)=>{await o.setEnginePolicy(c,E),await h("policy change")},onSetParam:async(c,E,S)=>{await o.setParam(c,E,S),await h("param change")},onResetNode:async c=>{await o.resetNode(c),await h("reset node")},onResetParam:async(c,E)=>{await o.resetParam(c,E),await h("reset param")}});function s(c){e.settingsEngineBoxEl.classList.toggle("is-hidden",!1)}async function l(){const c=await oe([Fe]).catch(()=>({}));return(c==null?void 0:c[Fe])===!0}async function u(c){await ae({[Fe]:!!c}).catch(()=>null)}function r(c){var E;e.cfgUseOpenCvEl.checked=c,(E=e.cfgUseOpenCvEl.closest(".switch"))==null||E.classList.toggle("is-disabled",e.cfgUseOpenCvEl.disabled)}function f(c){e.cfgOpenCvSpinner.classList.toggle("is-hidden",!c),e.cfgOpenCvSpinner.setAttribute("aria-hidden",c?"false":"true")}function d(c){e.cfgOpenCvStatus.textContent=c||""}function b(c){e.cfgOpenCvReport.textContent=c||""}async function p(){if(J())return;if(!!!e.cfgUseOpenCvEl.checked){await u(!1),f(!1),d(le()?"OpenCV loaded (native mode)":"Native mode"),b("Native mode. OpenCV is optional and demo-only."),await h("opencv mode disabled");return}f(!0),d("Loading OpenCV…"),b("Loading OpenCV…");try{if(await ii(e,async()=>{await di()}),!le())throw new Error("OpenCV load returned but runtime is not injected.");await u(!0),d("OpenCV mode enabled"),b("OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV."),await h("opencv mode enabled")}catch(E){const S=String((E==null?void 0:E.message)??E);await u(!1),r(!1),d("OpenCV load failed"),b(`ERROR

${S}`),re("[settings] OpenCV toggle failed",{msg:S})}finally{f(!1)}}async function g(){const c=await oe([ze]).catch(()=>({}));return(c==null?void 0:c[ze])===!0}async function y(c){await ae({[ze]:!!c}).catch(()=>null)}function w(c){n.setShowDevTools(c),i.setShowDevToolsChecked(c),i.setDevToolsVisible(c)}async function m(){const c=await g();w(c),V("Settings: boot applyDevToolsVisibility",{showDevTools:c})}async function h(c){try{const E=await o.loadTree("app");a.render(E),V("[settings] tuning rendered",{reason:c,opencvInjected:le(),opencvMode:!!e.cfgUseOpenCvEl.checked})}catch(E){re("[settings] tuning render failed",{reason:c,msg:String((E==null?void 0:E.message)??E)}),e.tuningMountEl.textContent="Tuning UI failed to load (see console)."}}async function v(){var U;i.setBusy(J());const c=await g();w(c),await He().catch(()=>null);const E=Re();n.setDev(_e(E)),i.setDevConfig(n.dev);const S=Bt;let P=!1;try{typeof S.isEnabled=="function"?P=!!await S.isEnabled():P=!!S.enabled}catch(C){Se("Settings: failed to read debug enabled state",{error:C instanceof Error?C.message:String(C)})}n.setDebugEnabled(P),i.setDebugEnabledChecked(P),i.setAbout(Si()||"—",((U=e.settingsGitHubLinkEl)==null?void 0:U.href)||"#"),s();{const C=await l();r(C),f(!1);const I=le();C?(d(I?"OpenCV mode enabled":"OpenCV mode (not loaded)"),b(I?"OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV.":"OpenCV mode is enabled, but OpenCV is not loaded yet. Toggle OFF then ON to load OpenCV.")):(d(I?"OpenCV loaded (native mode)":"Native mode"),b("Native mode. OpenCV is optional and demo-only."))}i.setGeneralStatus(""),i.setDevStatus(""),await h("loadAll"),V("Settings: loaded",{showDevTools:c,debugTraceEnabled:P,dev:n.dev,opencvInjected:le()})}async function R(){const c=!!e.cfgShowDevToolsEl.checked;w(c),await y(c),N({kind:"run",scope:"settings",message:c?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:c}}),V("Settings: ui toggle showDevTools",{showDevTools:c}),i.setGeneralStatus(c?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>i.setGeneralStatus(""),1200)}async function M(){const c=xi(e);i.setDevStatus("Saving…");try{await Dt(c)}catch(E){re("Settings: failed to save dev config",{error:E instanceof Error?E.message:String(E),next:c}),i.setDevStatus("Save failed."),setTimeout(()=>i.setDevStatus(""),1200);return}n.setDev(_e(c)),i.setDevConfig(n.dev),N({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:c}),V("Settings: devConfig updated",c),i.setDevStatus("Saved."),setTimeout(()=>i.setDevStatus(""),1200)}async function A(){i.setDevStatus("Resetting…");try{await Dn(),await He().catch(()=>null);const E=Re();n.setDev(_e(E)),i.setDevConfig(n.dev)}catch(E){re("Settings: failed to reset dev config defaults",{error:E instanceof Error?E.message:String(E)}),i.setDevStatus("Reset failed."),setTimeout(()=>i.setDevStatus(""),1200);return}const c=await pt(!1);c.ok?(n.setDebugEnabled(!1),i.setDebugEnabledChecked(!1)):(Se("Settings: failed to reset debug enabled state",{error:c.error||"unknown error"}),N({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:c.error||"unknown error"})),N({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...q,debugEnabled:!1}}),V("Settings: reset defaults",{...q,debugEnabled:!1}),i.setDevStatus("Reset."),setTimeout(()=>i.setDevStatus(""),1200)}async function x(){const c=!!e.logsCbDebugEl.checked;i.setDevStatus("Saving…");const E=await pt(c);if(!E.ok){e.logsCbDebugEl.checked=!c,i.setDevStatus(`Save failed: ${E.error||"unknown error"}`),re("Settings: failed to change debug enabled state",{error:E.error||"unknown error",enabled:c}),N({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:E.error||"unknown error",meta:{enabled:c}});return}n.setDebugEnabled(c),N({kind:"run",scope:"settings",message:c?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:c}}),V("Settings: debug enabled changed",{enabled:c}),i.setDevStatus("Saved."),setTimeout(()=>i.setDevStatus(""),1200)}const $=t.on(()=>{});function O(){e.cfgShowDevToolsEl.addEventListener("change",()=>{R()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{J()||M()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{J()||M()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{J()||M()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{J()||M()}),e.btnCfgResetDefaults.addEventListener("click",()=>{J()||A()}),e.logsCbDebugEl.addEventListener("change",()=>{J()||x()}),e.cfgUseOpenCvEl.addEventListener("change",()=>{p()}),m().catch(c=>{Se("Settings: initDevToolsVisibility failed",{error:c instanceof Error?c.message:String(c)})})}return{id:"settings",refresh(){v().catch(c=>{re("Settings: refresh failed",{error:c instanceof Error?c.message:String(c)})})},mount(){v().catch(c=>{re("Settings: mount failed",{error:c instanceof Error?c.message:String(c)})})},unmount(){},bind:O,dispose(){$()}}}function Ri(){let e=[],t=0;function n(i){e=i.items,t=i.total}return{get items(){return e},get total(){return t},set:n}}function Ai(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function gt(e,t){const n=[];n.push(`Total entries: ${t.total}`),n.push("");for(const i of t.items){const o=typeof i.ok=="boolean"?i.ok?"ok":"fail":"",a=[];typeof i.status=="number"&&a.push(`status=${i.status}`),o&&a.push(o);const s=[i.scope,i.kind].filter(Boolean).join("/");n.push(`[${Ai(i.ts)}] ${s}${a.length?` (${a.join(", ")})`:""}`),n.push(`  ${i.message}`),i.error&&n.push(`  error: ${i.error}`),n.push("")}e.textContent=n.join(`
`),e.scrollTop=0}function Di(e){function t(s){e.logsStatusEl.textContent=s}function n(s){e.debugStatusEl.textContent=s}function i(s){e.logsCbDebugEl.checked=s}function o(s){gt(e.logsOutEl,{total:s.total,items:s.items.map(l=>({ts:l.ts,message:l.message,scope:l.scope,kind:l.kind,ok:l.ok,status:l.status,error:l.error,meta:l.meta}))})}function a(s){gt(e.debugOutEl,{total:s.total,items:s.items.map(l=>({ts:l.ts,message:l.message,scope:l.scope,kind:l.kind,ok:l.ok,status:l.status,error:l.error,meta:l.meta}))})}return{setAuditStatus:t,setDebugStatus:n,setDebugChecked:i,renderAudit:o,renderDebug:a}}const ft="beemage";function Mi(e,t){const n=Ri(),i=Di(e);async function o(){i.setAuditStatus("Loading…"),te(e,!0);try{const g=ie(e.logsLimitEl.value,10,5e3,200),y=await Vn({limit:g,reverse:!0});n.set(y),i.renderAudit({items:n.items,total:n.total}),i.setAuditStatus(`Showing ${n.items.length} (newest first)`)}catch(g){i.setAuditStatus(`Failed: ${(g==null?void 0:g.message)||String(g)}`)}finally{te(e,!1)}}async function a(){i.setDebugStatus("Loading…"),te(e,!0);try{const g=ie(e.debugLimitEl.value,10,5e3,200),y=await Ot({limit:g,reverse:!0});i.renderDebug(y),i.setDebugStatus(`Showing ${y.items.length} (newest first)`)}catch(g){i.setDebugStatus(`Failed: ${(g==null?void 0:g.message)||String(g)}`)}finally{te(e,!1)}}async function s(){const g=await nt();i.setDebugChecked(g)}async function l(g){if(await Tt(g),i.setDebugChecked(g),!g){i.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}i.setDebugStatus("Debug ON."),await a()}async function u(){const g=ie(e.logsTrimKeepEl.value,0,5e4,2e3);i.setAuditStatus("Trimming…"),te(e,!0);try{const y=await Nn({keepLast:g});await o(),i.setAuditStatus(`Trimmed. Remaining: ${y.total}`)}catch(y){i.setAuditStatus(`Trim failed: ${(y==null?void 0:y.message)||String(y)}`)}finally{te(e,!1)}}async function r(){i.setAuditStatus("Clearing…"),te(e,!0);try{await jn(),await o(),i.setAuditStatus("Cleared.")}catch(g){i.setAuditStatus(`Clear failed: ${(g==null?void 0:g.message)||String(g)}`)}finally{te(e,!1)}}async function f(){i.setAuditStatus("Exporting…");try{const g=await zn({pretty:!0}),y=new Blob([g],{type:"application/json"}),w=URL.createObjectURL(y),m=document.createElement("a");m.href=w,m.download=`${ft}-audit-${Date.now()}.json`,m.click(),setTimeout(()=>URL.revokeObjectURL(w),1e3),i.setAuditStatus("Exported.")}catch(g){i.setAuditStatus(`Export failed: ${(g==null?void 0:g.message)||String(g)}`)}}async function d(){i.setDebugStatus("Clearing…"),te(e,!0);try{await Lt(),await a(),i.setDebugStatus("Cleared.")}catch(g){i.setDebugStatus(`Clear failed: ${(g==null?void 0:g.message)||String(g)}`)}finally{te(e,!1)}}async function b(){i.setDebugStatus("Exporting…");try{const g=await $t({pretty:!0}),y=new Blob([g],{type:"application/json"}),w=URL.createObjectURL(y),m=document.createElement("a");m.href=w,m.download=`${ft}-debug-${Date.now()}.json`,m.click(),setTimeout(()=>URL.revokeObjectURL(w),1e3),i.setDebugStatus("Exported.")}catch(g){i.setDebugStatus(`Export failed: ${(g==null?void 0:g.message)||String(g)}`)}}function p(){e.btnLogsRefresh.addEventListener("click",()=>{J()||o()}),e.btnLogsTrim.addEventListener("click",()=>{J()||u()}),e.btnLogsClear.addEventListener("click",()=>{J()||r()}),e.btnLogsExport.addEventListener("click",()=>{J()||f()}),e.logsCbDebugEl.addEventListener("change",()=>{J()||l(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{J()||a()}),e.btnDebugClear.addEventListener("click",()=>{J()||d()}),e.btnDebugExport.addEventListener("click",()=>{J()||b()})}return{id:"logs",bind:p,mount(){s(),o(),a()},unmount(){},dispose(){}}}function Ti(e,t){if(e.id===t)return e;const n=[...e.children??[]];for(;n.length>0;){const i=n.shift();if(i.id===t)return i;for(const o of i.children??[])n.push(o)}throw new Error(`[tuning] scopeRootId not found in VM tree: ${t}`)}function Li(e,t){if(e.id===t)return e;const n=[...e.children??[]];for(;n.length>0;){const i=n.shift();if(i.id===t)return i;for(const o of i.children??[])n.push(o)}return null}function Oi(e){const t=Kt({getRuntimeAvailability:e.getRuntimeAvailability}),n=[];let i=!1;async function o(){return await t.loadTree("app")}async function a(){if(i)return;const m=await o();for(const h of n){if(h.scopeRootId==="app"){h.view.render(m);continue}const v=Ti(m.root,h.scopeRootId);h.view.render({...m,scopeId:h.scopeRootId,root:v})}}async function s(m,h){await t.setEnginePolicy(m,h),e.actionLogAppend(`[tuning] policy ${m} = ${h}`),e.debugTraceAppend(`[tuning] setPolicy id=${m} policy=${h}`),await a()}async function l(m,h,v){await t.setParam(m,h,v),e.actionLogAppend(`[tuning] param ${m}.${h} = ${String(v)}`),e.debugTraceAppend(`[tuning] setParam id=${m} key=${h} value=${String(v)}`),await a()}async function u(m){await t.resetNode(m),e.actionLogAppend(`[tuning] reset node ${m}`),e.debugTraceAppend(`[tuning] resetNode id=${m}`),await a()}async function r(m,h){await t.resetParam(m,h),e.actionLogAppend(`[tuning] reset param ${m}.${h}`),e.debugTraceAppend(`[tuning] resetParam id=${m} key=${h}`),await a()}async function f(m){var h,v;if(!i){if(m.policies)for(const R of m.policies)await t.setEnginePolicy(R.id,R.policy);if(m.params)for(const R of m.params)await t.setParam(R.id,R.key,R.value);e.actionLogAppend(`[tuning] preset ${m.id} (${m.title})`),e.debugTraceAppend(`[tuning] applyPreset id=${m.id} title=${m.title} policies=${((h=m.policies)==null?void 0:h.length)??0} params=${((v=m.params)==null?void 0:v.length)??0}`),await a()}}async function d(m){const h=await o(),v=Li(h.root,m);if(!v)throw new Error(`[tuning] getEffectiveParams: unknown component id ${m}`);return{...v.effectiveParams??{}}}async function b(m,h,v){await t.setParam(m,h,v),e.actionLogAppend(`[tuning] param ${m}.${h} = ${String(v)}`),e.debugTraceAppend(`[tuning] setParamValue id=${m} key=${h} value=${String(v)}`),await a()}function p(m){if(i)return;const{mountEl:h,scopeRootId:v}=m;if(n.some(M=>M.mountEl===h))return;const R=Wt(h,{onSetPolicy:s,onSetParam:l,onResetNode:u,onResetParam:r});n.push({mountEl:h,scopeRootId:v,view:R}),a()}function g(m){const h=n.findIndex(v=>v.mountEl===m);h<0||(n[h].view.dispose(),n.splice(h,1))}async function y(){await a()}function w(){i=!0;for(const m of n)m.view.dispose();n.length=0}return{mount:p,unmount:g,refresh:y,applyPreset:f,getEffectiveParams:d,setParamValue:b,dispose:w}}function ee(e,t,n){const i=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))i.setAttribute(o,a);return typeof n=="string"&&(i.textContent=n),i}function $i(e){const t=[{kind:"input",type:e.io.input}],n=[{kind:"output",type:e.io.output}];return{id:e.id,title:e.title,group:e.group,inputs:t,outputs:n}}function Bi(e){const t=String(e||"").toLowerCase();return t==="image"?"opPort--image":t==="mask"?"opPort--mask":t==="svg"?"opPort--svg":"opPort--unknown"}function ht(e){const{ports:t,kind:n,getPortClass:i}=e,o=ee("div",{class:"opCard__portsRow"}),a=ee("div",{class:"opCard__portsLabel"},n==="input"?"IN":"OUT");o.appendChild(a);const s=ee("div",{class:"opCard__ports"});for(const l of t){const u=`opPort ${i(l.type)}`,r=l.label?`${l.label}: ${l.type}`:String(l.type),f=ee("div",{class:u,"data-port-kind":l.kind,"data-port-type":String(l.type)},r);s.appendChild(f)}return o.appendChild(s),o}function ot(e,t){const n=$i(e),i={compact:!!(t!=null&&t.compact),showId:(t==null?void 0:t.showId)??!0,showGroup:(t==null?void 0:t.showGroup)??!0,getPortClass:(t==null?void 0:t.getPortClass)??Bi,onClick:(t==null?void 0:t.onClick)??(()=>{})},o=ee("div",{class:`opCard${i.compact?" opCard--compact":""}`,"data-op-id":n.id}),a=ee("div",{class:"opCard__head"}),s=ee("div",{class:"opCard__title"},n.title);a.appendChild(s);const l=ee("div",{class:"opCard__meta"});i.showGroup&&n.group&&l.appendChild(ee("span",{class:"opBadge opBadge--group"},n.group)),i.showId&&l.appendChild(ee("span",{class:"opBadge opBadge--id"},n.id)),a.appendChild(l),o.appendChild(a);const u=ee("div",{class:"opCard__body"});return u.appendChild(ht({ports:n.inputs,kind:"input",getPortClass:i.getPortClass})),u.appendChild(ht({ports:n.outputs,kind:"output",getPortClass:i.getPortClass})),o.appendChild(u),t!=null&&t.onClick&&(o.classList.add("opCard--clickable"),o.addEventListener("click",r=>{var f,d;(f=r.preventDefault)==null||f.call(r),(d=t.onClick)==null||d.call(t,n.id)})),o}function B(e,t,n){const i=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))i.setAttribute(o,a);return typeof n=="string"&&(i.textContent=n),i}function Ui(e){return e.type==="image"}function Vi(e){return e.type==="mask"}function Ni(e){return e.type==="svg"}function Jt(e){return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(e)}`}function mt(e,t){if(Ui(e)){const i=B("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return xe(i,e.image),i}if(Vi(e)){const i=B("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return Ye(i,e.mask,e.width,e.height),i}if(!Ni(e))return B("div",{class:"muted",style:"margin-top:8px; font-size:12px;"},`Unsupported output: ${String(e.type)}`);const n=B("img",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`,"aria-label":"SVG preview"});return n.src=Jt(e.svg),n}function qt(e,t){const n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download=e,i.rel="noopener",i.click(),setTimeout(()=>URL.revokeObjectURL(n),500)}async function bt(e,t){const n=await new Promise(i=>t.toBlob(o=>i(o),"image/png"));if(!n)throw new Error("Failed to create PNG blob.");qt(e,n)}function xe(e,t){e.width=t.width,e.height=t.height;const n=e.getContext("2d",{willReadFrequently:!0});n&&n.putImageData(t,0,0)}function Ye(e,t,n,i){e.width=n,e.height=i;const o=e.getContext("2d",{willReadFrequently:!0});if(!o)return;let a=0;const s=n*i;for(let f=0;f<s;f++){const d=t[f]??0;d>a&&(a=d)}const l=a<=1,u=o.createImageData(n,i),r=u.data;for(let f=0;f<s;f++){const d=t[f]??0;let b;l?b=(d>0?1:0)?0:255:b=d;const p=f*4;r[p]=b,r[p+1]=b,r[p+2]=b,r[p+3]=255}o.putImageData(u,0,0)}function ji(e){const{hostEl:t,statusEl:n,handlers:i}=e;let o=!1,a=null,s=null,l=null,u=null,r=null,f=null,d=null,b=null,p=null,g=null,y=null,w=null,m=null;function h(){for(;t.firstChild;)t.removeChild(t.firstChild)}async function v(c){var T,D,L,z,K;const S=(typeof(c==null?void 0:c.activePipelineId)=="string"?c.activePipelineId:"pipeline").replace(/[^a-z0-9_-]+/gi,"_").slice(0,40)||"pipeline",P=(T=c==null?void 0:c.outputSvg)==null?void 0:T.svg;if(typeof P=="string"&&P.length>0){const j=new Blob([P],{type:"image/svg+xml;charset=utf-8"});qt(`beemage-${S}.svg`,j);return}const U=(D=c==null?void 0:c.outputImage)==null?void 0:D.data;if(U){const j=document.createElement("canvas");xe(j,U),await bt(`beemage-${S}.png`,j);return}const C=(L=c==null?void 0:c.outputMask)==null?void 0:L.data,I=(z=c==null?void 0:c.outputMask)==null?void 0:z.width,k=(K=c==null?void 0:c.outputMask)==null?void 0:K.height;if(C&&typeof I=="number"&&typeof k=="number"){const j=document.createElement("canvas");Ye(j,C,I,k),await bt(`beemage-${S}-mask.png`,j);return}throw new Error("No output to download.")}function R(){if(o)return;o=!0,h(),a=B("div",{class:"card"}),b=B("p",{class:"muted",style:"margin-top:0;"},"Universal pipeline runner. Select a pipeline and run it.");const c=B("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),E=B("label",{class:"fieldInline"});E.appendChild(B("span",{},"Pipeline")),s=B("select"),E.appendChild(s);const S=B("label",{class:"fieldInline"});S.appendChild(B("span",{},"Recipe")),l=B("select"),S.appendChild(l),u=B("button",{type:"button"},"Run all"),r=B("button",{type:"button"},"Next step"),f=B("button",{type:"button"},"Reset"),d=B("button",{type:"button"},"Download"),c.appendChild(E),c.appendChild(S),c.appendChild(u),c.appendChild(r),c.appendChild(f),c.appendChild(d);const P=B("div",{class:"grid4",style:"margin-top:12px;"}),U=B("div",{class:"card"});U.appendChild(B("div",{class:"cardTitle"},"Input (from source)")),p=B("canvas",{class:"canvas","aria-label":"Pipeline input preview"}),U.appendChild(p);const C=B("div",{class:"card"});C.appendChild(B("div",{class:"cardTitle"},"Current output")),g=B("canvas",{class:"canvas","aria-label":"Pipeline current output preview"}),y=B("img",{class:"canvas","aria-label":"Pipeline SVG output preview",style:"display:none;"}),C.appendChild(g),C.appendChild(y);const I=B("div",{class:"card",style:"grid-column:1 / -1;"});I.appendChild(B("div",{class:"cardTitle"},"Stages")),w=B("div"),I.appendChild(w),P.appendChild(U),P.appendChild(C),P.appendChild(I),a.appendChild(b),a.appendChild(c),a.appendChild(P),t.appendChild(a),s.addEventListener("change",()=>{const k=s?s.value:"segmentation";i.onSelectPipeline(k)}),l.addEventListener("change",()=>{const k=l?l.value:"default";i.onSelectRecipe(k)}),u.addEventListener("click",()=>i.onRunAll()),r.addEventListener("click",()=>i.onNext()),f.addEventListener("click",()=>i.onReset()),d.addEventListener("click",async()=>{try{await v(m)}catch(k){const T=k instanceof Error?k.message:String(k);n.textContent=`Download failed: ${T}`}})}function M(c){if(!s||!l)return;const E=Array.isArray(c==null?void 0:c.pipelines)?c.pipelines:[],S=Array.isArray(c==null?void 0:c.recipes)?c.recipes:[],P=typeof(c==null?void 0:c.activePipelineId)=="string"?c.activePipelineId:"segmentation",U=typeof(c==null?void 0:c.activeRecipeId)=="string"?c.activeRecipeId:"default";s.innerHTML="";for(const C of E){const I=B("option");I.value=C.id,I.textContent=C.title,C.id===P&&(I.selected=!0),s.appendChild(I)}l.innerHTML="";for(const C of S){const I=B("option");I.value=C.id,I.textContent=C.title,C.id===U&&(I.selected=!0),l.appendChild(I)}}function A(c){var S;if(!p)return;const E=(S=c==null?void 0:c.input)==null?void 0:S.data;if(!E){p.width=1,p.height=1;const P=p.getContext("2d");P&&P.clearRect(0,0,p.width,p.height);return}xe(p,E)}function x(c){var k,T,D,L,z;if(!g||!y)return;const E=(k=c==null?void 0:c.outputSvg)==null?void 0:k.svg;if(typeof E=="string"&&E.length>0){g.style.display="none",y.style.display="block",y.src=Jt(E);return}g.style.display="block",y.style.display="none",y.src="";const S=(T=c==null?void 0:c.outputImage)==null?void 0:T.data;if(S){xe(g,S);return}const P=(D=c==null?void 0:c.outputMask)==null?void 0:D.data,U=(L=c==null?void 0:c.outputMask)==null?void 0:L.width,C=(z=c==null?void 0:c.outputMask)==null?void 0:z.height;if(P&&typeof U=="number"&&typeof C=="number"){Ye(g,P,U,C);return}g.width=1,g.height=1;const I=g.getContext("2d");I&&I.clearRect(0,0,g.width,g.height)}function $(c){if(!w)return;w.innerHTML="";const E=Array.isArray(c==null?void 0:c.stages)?c.stages:[];if(!E.length){w.appendChild(B("div",{class:"muted",style:"font-size:12px;"},"No stages."));return}const S=B("div",{style:"display:flex; flex-direction:column; gap:10px;"});for(const P of E)S.appendChild(O(P));w.appendChild(S)}function O(c){const E=B("div",{class:"card",style:"padding:10px;"}),S=B("div",{class:"row",style:"align-items:center; justify-content:space-between;"});S.appendChild(B("div",{style:"font-weight:bold;"},String(c.title??c.stageId))),S.appendChild(B("div",{class:"status"},String(c.state??"idle"))),E.appendChild(S),E.appendChild(B("div",{class:"muted",style:"font-size:12px;"},`${c.input} -> ${c.output}`)),typeof c.error=="string"&&c.error.length>0&&E.appendChild(B("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Stage error: ${c.error}`));const P=c.outputArtifact;P&&E.appendChild(mt(P,260));const U=Array.isArray(c.ops)?c.ops:[];if(U.length){const C=B("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:8px;"});for(let I=0;I<U.length;I++){const k=U[I],T=I===U.length-1,D=B("div",{class:"card",style:"padding:8px;"}),L=B("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),z={id:String(k.opId??""),title:String(k.title??k.opId??"Operation"),io:{input:k.input,output:k.output},group:k.group},K=ot(z,{compact:!0,showGroup:!0,showId:!0});L.appendChild(K),L.appendChild(B("div",{class:"status"},String(k.state??"idle"))),D.appendChild(L),typeof k.error=="string"&&k.error.length>0&&D.appendChild(B("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Op error: ${k.error}`));const j=P&&T?void 0:k.outputArtifact;j&&D.appendChild(mt(j,200)),C.appendChild(D)}E.appendChild(C)}return E}return{mount(){R()},render(c){var E,S,P;if(R(),m=c,M(c),n.textContent=typeof(c==null?void 0:c.statusText)=="string"?c.statusText:"Idle",b){const U=typeof(c==null?void 0:c.description)=="string"?c.description:"Universal pipeline runner.";b.textContent=U}if(d){const U=typeof((E=c==null?void 0:c.outputSvg)==null?void 0:E.svg)=="string"&&c.outputSvg.svg.length>0,C=!!((S=c==null?void 0:c.outputImage)!=null&&S.data),I=!!((P=c==null?void 0:c.outputMask)!=null&&P.data);d.disabled=!(U||C||I)}A(c),x(c),$(c)},dispose(){o=!1,a=null,s=null,l=null,u=null,r=null,f=null,d=null,b=null,p=null,g=null,y=null,w=null,m=null,h()}}}function ve(e,t){return e.find(n=>n.id===t)??null}function Z(e,t){return{input:e,output:t}}function yt(e,t){return`${e}.${t+1}`}function Ze(e){const t=[{kind:"dispatch",id:"op.seg.resize",title:"Resize",io:Z("image","image"),dispatchId:"segmentation.resize",tuningId:"segmentation.resize",group:"Segmentation"},{kind:"dispatch",id:"op.seg.denoise",title:"Denoise",io:Z("image","image"),dispatchId:"segmentation.denoise",tuningId:"segmentation.denoise",group:"Segmentation"},{kind:"dispatch",id:"op.seg.color",title:"Color / Gray",io:Z("image","image"),dispatchId:"segmentation.color",tuningId:"segmentation.color",group:"Segmentation"},{kind:"dispatch",id:"op.seg.threshold",title:"Threshold",io:Z("image","mask"),dispatchId:"segmentation.threshold",tuningId:"segmentation.threshold",group:"Segmentation"},{kind:"dispatch",id:"op.seg.morphology",title:"Morphology cleanup",io:Z("mask","mask"),dispatchId:"segmentation.morphology",tuningId:"segmentation.morphology",group:"Segmentation"},{kind:"dispatch",id:"op.edge.resize",title:"Resize",io:Z("image","image"),dispatchId:"edge.resize",tuningId:"edge.resize",group:"Edge"},{kind:"dispatch",id:"op.edge.threshold",title:"Threshold",io:Z("image","mask"),dispatchId:"edge.threshold",tuningId:"edge.threshold",group:"Edge"},{kind:"dispatch",id:"op.edge.morphology",title:"Morphology cleanup",io:Z("mask","mask"),dispatchId:"edge.morphology",tuningId:"edge.morphology",group:"Edge"},{kind:"dispatch",id:"op.edge.extract",title:"Edge extract",io:Z("mask","mask"),dispatchId:"edge.extract",tuningId:"edge.extract",group:"Edge"},{kind:"dispatch",id:"op.svg.create",title:"Create SVG",io:Z("mask","svg"),dispatchId:"svg.create",tuningId:"svg.create",group:"SVG"},{kind:"dispatch",id:"op.mage.clean.removeSmallComponents",title:"Remove small components",io:Z("mask","mask"),dispatchId:"mage.clean.removeSmallComponents",tuningId:"mage.clean.removeSmallComponents",group:"Cleanup"},{kind:"js",id:"op.util.pass.image",title:"Pass-through (image)",io:Z("image","image"),group:"Utility",run:({input:r})=>r},{kind:"js",id:"op.util.pass.mask",title:"Pass-through (mask)",io:Z("mask","mask"),group:"Utility",run:({input:r})=>r}];function n(r){return ve(t,r)}function i(r,f){return f.map((d,b)=>({instanceId:yt(r,b),opId:d,enabled:!0}))}const o=[{id:"segmentation",title:"Segmentation",implemented:!0,description:"Multi-step segmentation pipeline (image -> mask).",ops:i("segmentation",["op.seg.resize","op.seg.denoise","op.seg.color","op.seg.threshold","op.seg.morphology"])},{id:"edge",title:"Edge",implemented:!0,description:"Edge extraction pipeline (image -> mask -> edges).",ops:i("edge",["op.edge.resize","op.edge.threshold","op.edge.morphology","op.edge.extract"])},{id:"svg",title:"SVG",implemented:!0,description:"Image to SVG outline.",ops:i("svg",["op.edge.resize","op.edge.threshold","op.edge.morphology","op.edge.extract","op.svg.create"])},{id:"cleanup",title:"Cleanup (min area)",implemented:!0,description:"Image -> mask -> cleanup (morphology + remove small components).",ops:i("cleanup",["op.seg.resize","op.seg.threshold","op.seg.morphology","op.mage.clean.removeSmallComponents"])},{id:"surface",title:"Surface",implemented:!1,description:"Future: region labeling + vectorize pipeline.",ops:[]}],a=(e==null?void 0:e.userPipelines)??[];function s(r){return ve(o,r)}function l(r){return ve(a,r)??ve(o,r)}function u(){const r=new Set(a.map(d=>d.id));return[...o.filter(d=>!r.has(d.id)),...a]}return{ops:t,getOp:n,builtIns:o,getBuiltIn:s,listPipelines:u,getPipeline:l,createInstanceId:yt}}const vt=zt();function zi(){return{opencvReady:le()}}function Fi(e){const{implemented:t,policy:n,runtimeOpenCvReady:i}=e,o=i&&t.includes("opencv");return t.includes("native")||t.length,n==="native"?{engine:"native"}:n==="opencv"?o?{engine:"opencv"}:{engine:"native",fallbackReason:i?"Override policy=opencv, but this op has no OpenCV implementation.":"Override policy=opencv, but OpenCV is not available at runtime."}:n==="auto"?o?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}async function _i(e,t){const n=await be(),i=zi(),o=Ft(e,vt,n,i),a=vt.byId.get(e);if(!a)throw new Error(`[opsDispatch] Unknown op in registry: ${e}`);const l={...o.params,...(t==null?void 0:t.params)??{}},u=t!=null&&t.enginePolicy&&t.enginePolicy!=="inherit"?t.enginePolicy:o.policy;let r=o.engine,f=o.fallbackReason;if(t!=null&&t.enginePolicy&&t.enginePolicy!=="inherit"){const d=Fi({implemented:a.implementedEngines,policy:u,runtimeOpenCvReady:!!i.opencvReady});r=d.engine,f=d.fallbackReason}return{engine:r,params:l,fallbackReason:f,opencvReady:!!i.opencvReady}}async function Gi(e,t,n,i){const{engine:o,params:a,fallbackReason:s,opencvReady:l}=await _i(e,i);return o==="opencv"&&!l?(Se(`OpenCV selected for ${e} but not ready; falling back to native. ${s??""}`.trim()),await n[e].native(t,a)):await n[e][o](t,a)}function we(e,t,n,i){if(!t||!n)return e;const o=Math.floor(Number(i.morphAlgo??2)),a=Hi(Math.floor(Number(i.morphIters??1)),1,20),s=Math.floor(Number(i.morphK??5)),l=Ki(s),u=l-1>>1;if(o<=0||l<=1)return e;let r=e,f=new Uint8Array(t*n);for(let d=0;d<a;d++){if(o===1){Et(r,f,t,n,u);const b=r;r=f,f=b;continue}if(o===2){wt(r,f,t,n,u);const b=r;r=f,f=b;continue}wt(r,f,t,n,u),r===e&&d===0&&(r=new Uint8Array(e)),Et(f,r,t,n,u)}return r}function Ki(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:5}function wt(e,t,n,i,o){t.fill(0);for(let a=0;a<i;a++){const s=Math.max(0,a-o),l=Math.min(i-1,a+o);for(let u=0;u<n;u++){const r=Math.max(0,u-o),f=Math.min(n-1,u+o);let d=0;for(let b=s;b<=l&&!d;b++){let p=b*n+r;for(let g=r;g<=f;g++,p++)if(e[p]){d=1;break}}t[a*n+u]=d}}}function Et(e,t,n,i,o){t.fill(0);for(let a=0;a<i;a++){const s=Math.max(0,a-o),l=Math.min(i-1,a+o);for(let u=0;u<n;u++){const r=Math.max(0,u-o),f=Math.min(n-1,u+o);let d=1;for(let b=s;b<=l&&d;b++){let p=b*n+r;for(let g=r;g<=f;g++,p++)if(!e[p]){d=0;break}}t[a*n+u]=d}}}function Hi(e,t,n){return e<t?t:e>n?n:e}function Yt(e,t,n,i){const o=Math.max(0,Math.floor(Number(i??0)));if(!t||!n||o<=1)return e;const a=new Uint8Array(e),s=new Uint8Array(e.length),l=new Int32Array(e.length),u=new Int32Array(e.length);for(let r=0;r<n;r++)for(let f=0;f<t;f++){const d=r*t+f;if(e[d]===0||s[d]===1)continue;let b=0,p=0;s[d]=1,l[p]=f,u[p]=r,p++;const g=[d];for(;b<p;){const y=l[b],w=u[b];b++;const m=y-1,h=w,v=y+1,R=w,M=y,A=w-1,x=y,$=w+1;if(m>=0){const O=h*t+m;e[O]!==0&&s[O]===0&&(s[O]=1,l[p]=m,u[p]=h,p++,g.push(O))}if(v<t){const O=R*t+v;e[O]!==0&&s[O]===0&&(s[O]=1,l[p]=v,u[p]=R,p++,g.push(O))}if(A>=0){const O=A*t+M;e[O]!==0&&s[O]===0&&(s[O]=1,l[p]=M,u[p]=A,p++,g.push(O))}if($<n){const O=$*t+x;e[O]!==0&&s[O]===0&&(s[O]=1,l[p]=x,u[p]=$,p++,g.push(O))}}if(g.length<o)for(let y=0;y<g.length;y++)a[g[y]]=0}return a}function Wi(){const e=globalThis;return e!=null&&e.cv&&typeof e.cv.Mat=="function"?e.cv:null}function Ji(e,t){const{width:n,height:i}=e,o=Math.max(0,Math.floor(Number(t.cleanMinArea??0)));if(Nt("OpenCV removeSmallComponents params",{width:n,height:i,minArea:o}),!n||!i||o<=1)return e.mask;const a=Wi();if(!a)return Yt(e.mask,n,i,o);const s=new a.Mat(i,n,a.CV_8UC1);try{const l=s.data,u=e.mask;for(let b=0;b<u.length;b++)l[b]=u[b]?255:0;const r=new a.Mat,f=new a.Mat,d=new a.Mat;try{const b=a.connectedComponentsWithStats(s,r,f,d,8,a.CV_32S),p=a.CC_STAT_AREA??4,g=new Array(b).fill(!1);for(let m=1;m<b;m++)f.intAt(m,p)<o&&(g[m]=!0);const y=new Uint8Array(n*i),w=r.data32S;for(let m=0;m<y.length;m++){const h=w[m];y[m]=h>0&&!g[h]?1:0}return y}finally{r.delete(),f.delete(),d.delete()}}finally{s.delete()}}function Ee(e,t,n,i){const o=Math.max(0,Math.min(255,Math.floor(Number(i.manualT??128)))),a=new Uint8Array(t*n),s=e.data;for(let l=0,u=0;l<a.length;l++,u+=4){const r=s[u],f=s[u+1],d=s[u+2],b=r*77+f*150+d*29>>8;a[l]=b>=o?1:0}return a}function Ce(e,t,n,i){const o=Math.max(1,Math.floor(Number(i.targetMaxW??t)));if(!t||!n||t<=o)return e;const a=o/t,s=Math.max(1,Math.floor(t*a)),l=Math.max(1,Math.floor(n*a));return Math.floor(Number(i.resizeAlgo??1))===0?qi(e,t,n,s,l):Yi(e,t,n,s,l)}function qi(e,t,n,i,o){const a=e.data,s=new Uint8ClampedArray(i*o*4),l=t/i,u=n/o;for(let r=0;r<o;r++){const f=Math.min(n-1,Math.max(0,Math.floor((r+.5)*u-.5)));for(let d=0;d<i;d++){const b=Math.min(t-1,Math.max(0,Math.floor((d+.5)*l-.5))),p=(f*t+b)*4,g=(r*i+d)*4;s[g]=a[p],s[g+1]=a[p+1],s[g+2]=a[p+2],s[g+3]=a[p+3]}}return new ImageData(s,i,o)}function Yi(e,t,n,i,o){const a=e.data,s=new Uint8ClampedArray(i*o*4),l=t/i,u=n/o;for(let r=0;r<o;r++){const f=(r+.5)*u-.5,d=Ie(Math.floor(f),0,n-1),b=Ie(d+1,0,n-1),p=f-d;for(let g=0;g<i;g++){const y=(g+.5)*l-.5,w=Ie(Math.floor(y),0,t-1),m=Ie(w+1,0,t-1),h=y-w,v=(d*t+w)*4,R=(d*t+m)*4,M=(b*t+w)*4,A=(b*t+m)*4,x=(r*i+g)*4;for(let $=0;$<4;$++){const O=a[v+$],c=a[R+$],E=a[M+$],S=a[A+$],P=O+(c-O)*h,U=E+(S-E)*h,C=P+(U-P)*p;s[x+$]=Zi(C)}}}return new ImageData(s,i,o)}function Ie(e,t,n){return e<t?t:e>n?n:e}function Zi(e){return e<=0?0:e>=255?255:e|0}function Ct(e,t,n,i){if(!t||!n)return e;const o=Math.floor(Number(i.denoiseAlgo??1));if(o<=0)return e;const a=Math.floor(Number(i.blurK??3)),s=Qi(a);return o===2&&s<=3?eo(e,t,n):s<=1?e:Xi(e,t,n,s)}function Qi(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:3}function Xi(e,t,n,i){const o=i-1>>1,a=e.data,s=new Uint8ClampedArray(t*n*4);for(let u=0;u<n;u++){let r=0,f=0,d=0,b=0;for(let p=-o;p<=o;p++){const g=ce(p,0,t-1),y=(u*t+g)*4;r+=a[y],f+=a[y+1],d+=a[y+2],b+=a[y+3]}for(let p=0;p<t;p++){const g=(u*t+p)*4;s[g]=r/i|0,s[g+1]=f/i|0,s[g+2]=d/i|0,s[g+3]=b/i|0;const y=ce(p-o,0,t-1),w=ce(p+o+1,0,t-1),m=(u*t+y)*4,h=(u*t+w)*4;r+=a[h]-a[m],f+=a[h+1]-a[m+1],d+=a[h+2]-a[m+2],b+=a[h+3]-a[m+3]}}const l=new Uint8ClampedArray(t*n*4);for(let u=0;u<t;u++){let r=0,f=0,d=0,b=0;for(let p=-o;p<=o;p++){const y=(ce(p,0,n-1)*t+u)*4;r+=s[y],f+=s[y+1],d+=s[y+2],b+=s[y+3]}for(let p=0;p<n;p++){const g=(p*t+u)*4;l[g]=r/i|0,l[g+1]=f/i|0,l[g+2]=d/i|0,l[g+3]=b/i|0;const y=ce(p-o,0,n-1),w=ce(p+o+1,0,n-1),m=(y*t+u)*4,h=(w*t+u)*4;r+=s[h]-s[m],f+=s[h+1]-s[m+1],d+=s[h+2]-s[m+2],b+=s[h+3]-s[m+3]}}return new ImageData(l,t,n)}function eo(e,t,n){const i=e.data,o=new Uint8ClampedArray(t*n*4),a=new Array(9),s=new Array(9),l=new Array(9),u=new Array(9);for(let r=0;r<n;r++)for(let f=0;f<t;f++){let d=0;for(let p=-1;p<=1;p++){const g=ce(r+p,0,n-1);for(let y=-1;y<=1;y++){const w=ce(f+y,0,t-1),m=(g*t+w)*4;a[d]=i[m],s[d]=i[m+1],l[d]=i[m+2],u[d]=i[m+3],d++}}a.sort(ke),s.sort(ke),l.sort(ke),u.sort(ke);const b=(r*t+f)*4;o[b]=a[4]|0,o[b+1]=s[4]|0,o[b+2]=l[4]|0,o[b+3]=u[4]|0}return new ImageData(o,t,n)}function ke(e,t){return e-t}function ce(e,t,n){return e<t?t:e>n?n:e}function It(e,t,n,i){if(!t||!n)return e;const o=Math.floor(Number(i.colorMode??1));if(o===0)return e;const a=e.data,s=new Uint8ClampedArray(t*n*4),l=no(Math.floor(Number(i.hsvChannel??2)),0,2);for(let u=0,r=0;u<t*n;u++,r+=4){const f=a[r],d=a[r+1],b=a[r+2],p=a[r+3];let g=0;if(o===1)g=f*77+d*150+b*29>>8;else if(o===2){const y=to(f,d,b),w=l===0?y.h:l===1?y.s:y.v;g=io(w*255)}else g=255-(f*77+d*150+b*29>>8);s[r]=g,s[r+1]=g,s[r+2]=g,s[r+3]=p}return new ImageData(s,t,n)}function to(e,t,n){const i=e/255,o=t/255,a=n/255,s=Math.max(i,o,a),l=Math.min(i,o,a),u=s-l;let r=0;u!==0&&(s===i?r=(o-a)/u%6:s===o?r=(a-i)/u+2:r=(i-o)/u+4,r/=6,r<0&&(r+=1));const f=s===0?0:u/s;return{h:r,s:f,v:s}}function no(e,t,n){return e<t?t:e>n?n:e}function io(e){return e<=0?0:e>=255?255:e|0}function kt(e,t,n){const i=new Uint8Array(e.length),o=(a,s)=>s*t+a;for(let a=0;a<n;a++)for(let s=0;s<t;s++){const l=o(s,a);if(e[l]===0)continue;if(s===0||a===0||s===t-1||a===n-1){i[l]=255;continue}const r=e[o(s-1,a)],f=e[o(s+1,a)],d=e[o(s,a-1)],b=e[o(s,a+1)];(r===0||f===0||d===0||b===0)&&(i[l]=255)}return i}function St(e,t,n,i){const o=Math.max(1,Math.floor(i.scale||1)),a=t*o,s=n*o,l=o;let u="";for(let b=0;b<n;b++){const p=b*t;for(let g=0;g<t;g++){if(e[p+g]===0)continue;const w=g*l,m=b*l;u+=`M${w} ${m}h${l}v${l}h-${l}Z`}}const r=i.transparentBg?"":`<rect x="0" y="0" width="${a}" height="${s}" fill="white"/>`,f=i.color||"#000",d=u.length>0?`<path d="${u}" fill="${f}" stroke="none"/>`:"";return`<svg xmlns="http://www.w3.org/2000/svg" width="${a}" height="${s}" viewBox="0 0 ${a} ${s}">`+r+d+"</svg>"}const oo="demo",ao={"mage.clean.removeSmallComponents":{native:(e,t)=>Yt(e.mask,e.width,e.height,t.cleanMinArea),opencv:(e,t)=>(V("OpenCV removeSmallComponents called (demo).",{width:e.width,height:e.height,cleanMinArea:t.cleanMinArea}),Ji(e,t))},"segmentation.resize":{native:(e,t)=>(V("[demo op] segmentation.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),Ce(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(V("[demo op] segmentation.resize opencv",{width:e.width,height:e.height}),Ce(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"segmentation.denoise":{native:(e,t)=>(V("[demo op] segmentation.denoise native",{width:e.width,height:e.height,denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}),Ct(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma})),opencv:(e,t)=>(V("[demo op] segmentation.denoise opencv",{width:e.width,height:e.height}),Ct(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}))},"segmentation.color":{native:(e,t)=>(V("[demo op] segmentation.color native",{width:e.width,height:e.height,colorMode:t.colorMode,hsvChannel:t.hsvChannel}),It(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel})),opencv:(e,t)=>(V("[demo op] segmentation.color opencv",{width:e.width,height:e.height}),It(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel}))},"segmentation.threshold":{native:(e,t)=>(V("[demo op] segmentation.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),Ee(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(V("[demo op] segmentation.threshold opencv",{width:e.width,height:e.height}),Ee(e.image,e.width,e.height,{manualT:t.manualT}))},"segmentation.morphology":{native:(e,t)=>(V("[demo op] segmentation.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),we(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(V("[demo op] segmentation.morphology opencv",{width:e.width,height:e.height}),we(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.resize":{native:(e,t)=>(V("[demo op] edge.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),Ce(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(V("[demo op] edge.resize opencv",{width:e.width,height:e.height}),Ce(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"edge.threshold":{native:(e,t)=>(V("[demo op] edge.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),Ee(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(V("[demo op] edge.threshold opencv",{width:e.width,height:e.height}),Ee(e.image,e.width,e.height,{manualT:t.manualT}))},"edge.morphology":{native:(e,t)=>(V("[demo op] edge.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),we(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(V("[demo op] edge.morphology opencv",{width:e.width,height:e.height}),we(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.extract":{native:(e,t)=>(V("[demo op] edge.extract native",{width:e.width,height:e.height}),kt(e.mask,e.width,e.height)),opencv:(e,t)=>(V("[demo op] edge.extract opencv",{width:e.width,height:e.height}),kt(e.mask,e.width,e.height))},"svg.create":{native:(e,t)=>(V("[demo op] svg.create native",{width:e.width,height:e.height,scale:t.scale}),St(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color})),opencv:(e,t)=>(V("[demo op] svg.create opencv",{width:e.width,height:e.height,scale:t.scale}),St(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color}))}};async function ue(e,t,n){return Nt("[opsDispatch] runOp",{op:e,implSource:oo,inputKeys:t&&typeof t=="object"?Object.keys(t):typeof t,override:n?{enginePolicy:n.enginePolicy,paramsKeys:Object.keys(n.params??{})}:null}),Gi(e,t,ao,n)}const so=Object.freeze(Object.defineProperty({__proto__:null,runOp:ue},Symbol.toStringTag,{value:"Module"}));function ro(e){return{width:e.width,height:e.height}}function lo(e){return e.type==="image"}function co(e){return e.type==="mask"}function Zt(e){return{type:"image",width:e.width,height:e.height,image:e}}function xt(e,t,n){return{type:"mask",width:t,height:n,mask:e}}function Pt(e,t,n){return{type:"svg",width:t,height:n,svg:e}}function Le(e,t){return`IO mismatch: expected ${e}, got ${t}`}function uo(e,t){if(e.length===0)return"Pipeline has no ops";let n=t;for(const i of e){if(i.io.input!==n)return`Chain IO mismatch at "${i.title}": needs ${i.io.input} but current is ${n}`;n=i.io.output}return null}async function po(e,t,n){const i=t.override;if(e.io.input==="image"){if(!lo(n))throw new Error(Le("image",n.type));const{width:s,height:l}=n;if(e.io.output==="image"){const u=await ue(e.dispatchId,{image:n.image,width:s,height:l},i?{enginePolicy:i.enginePolicy,params:i.params}:void 0);return Zt(u)}if(e.io.output==="mask"){const u=await ue(e.dispatchId,{image:n.image,width:s,height:l},i?{enginePolicy:i.enginePolicy,params:i.params}:void 0);return xt(u,s,l)}if(e.io.output==="svg"){const u=await ue(e.dispatchId,{image:n.image,width:s,height:l},i?{enginePolicy:i.enginePolicy,params:i.params}:void 0);return Pt(u,s,l)}throw new Error(`Unsupported dispatch output: ${e.io.output}`)}if(!co(n))throw new Error(Le("mask",n.type));const{width:o,height:a}=n;if(e.io.output==="mask"){const s=await ue(e.dispatchId,{mask:n.mask,width:o,height:a},i?{enginePolicy:i.enginePolicy,params:i.params}:void 0);return xt(s,o,a)}if(e.io.output==="svg"){const s=await ue(e.dispatchId,{mask:n.mask,width:o,height:a},i?{enginePolicy:i.enginePolicy,params:i.params}:void 0);return Pt(s,o,a)}throw new Error(`Invalid op spec: mask input cannot produce ${e.io.output} (unsupported here)`)}async function go(e,t,n,i){var l;if(e.kind==="dispatch")return await po(e,t,n);const a={...e.tuningId?await i.getEffectiveParams(e.tuningId).catch(()=>({})):{},...((l=t.override)==null?void 0:l.params)??{}};return await e.run({input:n,params:a})}async function fo(e){const{catalogue:t,pipeline:n,inputImage:i,deps:o}=e,a=Zt(i);if(!n.implemented)return{pipelineId:n.id,title:n.title,status:"error",error:"Not implemented yet",input:a,ops:[]};const s=n.ops.filter(d=>d.enabled!==!1),l=[];for(const d of s){const b=t.getOp(d.opId);if(!b)return{pipelineId:n.id,title:n.title,status:"error",error:`Unknown opId in pipeline: ${d.opId}`,input:a,ops:[]};l.push(b)}const u=uo(l,"image");if(u)return o.debug("pipeline validation failed (linear)",{pipelineId:n.id,error:u}),{pipelineId:n.id,title:n.title,status:"error",error:u,input:a,ops:s.map((d,b)=>{var p,g;return{instanceId:d.instanceId,opId:d.opId,title:((p=l[b])==null?void 0:p.title)??d.opId,io:((g=l[b])==null?void 0:g.io)??{input:"image",output:"image"},status:"error",error:u}})};const r=[];let f=a;for(let d=0;d<l.length;d++){const b=s[d],p=l[d];try{if(p.io.input!==f.type)throw new Error(Le(p.io.input,f.type));const g=await go(p,b,f,o);if(g.type!==p.io.output)throw new Error(Le(p.io.output,g.type));r.push({instanceId:b.instanceId,opId:p.id,title:p.title,io:p.io,status:"ok",output:g}),f=g}catch(g){const y=g instanceof Error?g.message:String(g);return r.push({instanceId:b.instanceId,opId:p.id,title:p.title,io:p.io,status:"error",error:y}),o.debug("pipeline op failed (linear)",{pipelineId:n.id,opId:p.id,error:y,...ro(f)}),{pipelineId:n.id,title:n.title,status:"error",error:`Op "${p.title}" failed: ${y}`,input:a,ops:r}}}return{pipelineId:n.id,title:n.title,status:"ok",input:a,output:f,ops:r}}const Qe="beemage.pipeline.userPipelines.v1";async function pe(){const e=await oe([Qe]).catch(()=>({})),t=e==null?void 0:e[Qe];if(!Array.isArray(t))return[];const n=[];for(const i of t)!i||typeof i!="object"||typeof i.id=="string"&&Array.isArray(i.ops)&&n.push(i);return n}async function Oe(e){await ae({[Qe]:e}).catch(()=>null)}async function ho(e){const t=await pe(),n=t.findIndex(i=>i.id===e.id);if(n>=0){const i=t.slice();i[n]=e,await Oe(i);return}await Oe([...t,e])}async function mo(e){const n=(await pe()).filter(i=>i.id!==e);await Oe(n)}const Xe="beemage.pipeline.recipes.v1";function bo(){return Date.now()}function Qt(){return{recipesById:{}}}async function de(){const e=await oe([Xe]).catch(()=>({})),t=e==null?void 0:e[Xe];return!t||typeof t!="object"?{}:t}async function ye(e){await ae({[Xe]:e}).catch(()=>null)}async function yo(e,t){const n=await de(),i=n[e]??Qt();i.selectedRecipeId=t,n[e]=i,await ye(n)}async function vo(e,t){const n=await de(),i=n[e]??Qt();i.recipesById[t.id]={...t,updatedTs:bo()},i.selectedRecipeId||(i.selectedRecipeId=t.id),n[e]=i,await ye(n)}async function wo(e,t){const n=await de(),i=n[e];if(i){if(delete i.recipesById[t],i.selectedRecipeId===t){const o=Object.keys(i.recipesById);i.selectedRecipeId=o.length?o[0]:void 0}n[e]=i,await ye(n)}}function Eo(e){const t=[];for(const[n,i]of Object.entries(e??{})){const o=Object.values(i.recipesById??{});t.push({pipelineId:n,selectedRecipeId:i.selectedRecipeId,recipes:o})}return t.sort((n,i)=>n.pipelineId.localeCompare(i.pipelineId)),t}function Co(e){if(!Array.isArray(e))return{};const t={};for(const n of e){if(!n||typeof n!="object")continue;const i=n.pipelineId;if(typeof i!="string"||!i)continue;const o=n.selectedRecipeId,a=n.recipes,s={};if(Array.isArray(a))for(const l of a){if(!l||typeof l!="object")continue;const u=l.id,r=l.title,f=l.updatedTs,d=l.ops;typeof u!="string"||!u||typeof r!="string"||!r||typeof f=="number"&&Array.isArray(d)&&(s[u]=l)}t[i]={selectedRecipeId:typeof o=="string"?o:void 0,recipesById:s}}return t}function Io(e){return e.type==="image"}function ko(e){return e.type==="mask"}function So(e){return e.type==="svg"}function xo(e){var E,S,P,U;let t=Ze({userPipelines:[]}),n={},o=((P=(S=(E=t.listPipelines)==null?void 0:E.call(t))==null?void 0:S[0])==null?void 0:P.id)??((U=t.builtIns[0])==null?void 0:U.id)??"segmentation",a="default",s=null,l="Idle",u=null,r=[],f=0,d=null;async function b(){var D,L,z,K,j;const C=await pe().catch(()=>[]);t=Ze({userPipelines:C}),n=await de().catch(()=>({}));const I=((D=t.listPipelines)==null?void 0:D.call(t))??t.builtIns;I.some(X=>X.id===o)||(o=((L=I[0])==null?void 0:L.id)??"segmentation",a="default");const T=((z=t.getPipeline)==null?void 0:z.call(t,o))??((j=(K=t.listPipelines)==null?void 0:K.call(t))==null?void 0:j[0]);T&&g(T).some($e=>$e.id===a)||(a="default"),w()}function p(){var I,k,T;const C=((I=t.getPipeline)==null?void 0:I.call(t,o))??((T=(k=t.listPipelines)==null?void 0:k.call(t))==null?void 0:T[0]);if(!C)throw new Error("[pipeline] No pipelines available.");return C}function g(C){const I={id:"default",title:"Default",buildPipeline:L=>L},k=n==null?void 0:n[C.id],T=(k==null?void 0:k.recipesById)??{},D=[I];for(const L of Object.keys(T)){const z=T[L];!z||typeof z.id!="string"||D.push({id:String(z.id),title:typeof z.title=="string"&&z.title.trim().length?z.title:String(z.id),buildPipeline:K=>{const j=Array.isArray(z.ops)?z.ops:null;if(!j)return K;const X=j.filter(W=>W&&typeof W=="object").map(W=>({instanceId:typeof W.instanceId=="string"?W.instanceId:String(W.instanceId??""),opId:typeof W.opId=="string"?W.opId:String(W.opId??""),enabled:W.enabled===void 0?!0:!!W.enabled})).filter(W=>W.instanceId&&W.opId);return X.length?{...K,ops:X}:K}})}return D.slice(0,1).concat(D.slice(1).sort((L,z)=>String(L.title).localeCompare(String(z.title))))}function y(){const C=p(),I=g(C),k=I.find(T=>T.id===a)??I[0];return a=k.id,k.buildPipeline(C)}function w(){l=y().implemented?"Ready":"Not implemented yet",u=null,r=[],f=0,d=null}function m(){w()}function h(C){var k,T;C===o||!(((k=t.getPipeline)==null?void 0:k.call(t,C))??((T=t.getBuiltIn)==null?void 0:T.call(t,C)))||(o=C,a="default",m())}function v(C){if(C===a)return;const I=p();a=g(I).some(D=>D.id===C)?C:"default",m()}function R(C){s=C,w()}function M(C){const I=C.ops.filter(T=>T.enabled!==!1),k=[];for(let T=0;T<I.length;T++){const D=I[T],L=t.getOp(D.opId);L&&k.push({index0:T,instanceId:D.instanceId,opSpec:L})}return k}function A(C){var D;const I=C.ops.map(L=>({instanceId:L.instanceId,opId:L.opId,title:L.title,input:L.io.input,output:L.io.output,state:L.status==="ok"?"ok":L.status==="error"?"error":"idle",error:L.error,outputArtifact:L.output})),k=C.status==="ok"?"ok":"error",T=C.output??((D=I.slice().reverse().find(L=>L.outputArtifact))==null?void 0:D.outputArtifact);return[{stageId:"pipeline",title:"Pipeline",input:"image",output:(T==null?void 0:T.type)??"image",ops:I,state:k,error:C.error,outputArtifact:T}]}function x(C,I){I&&(Io(I)?C.outputImage={width:I.width,height:I.height,data:I.image}:ko(I)?C.outputMask={width:I.width,height:I.height,data:I.mask}:So(I)&&(C.outputSvg={width:I.width,height:I.height,svg:I.svg}))}async function $(){const C=y();if(!C.implemented){l="Not implemented yet";return}if(!s){l="No input image";return}l="Running all…";const I=await fo({catalogue:t,pipeline:C,inputImage:s,deps:e.runner});u=I,r=M(C),f=r.length,d=I.output??null,l=I.status==="ok"?"Done":I.error??"Error"}async function O(){const C=y();if(!C.implemented){l="Not implemented yet";return}if(!s){l="No input image";return}if(r.length===0&&(r=M(C),f=0,d={type:"image",width:s.width,height:s.height,image:s},u={pipelineId:C.id,title:C.title,status:"ok",input:{type:"image",width:s.width,height:s.height,image:s},output:{type:"image",width:s.width,height:s.height,image:s},ops:[]}),f>=r.length){l="Done";return}const I=r[f],k=I.opSpec;d||(d={type:"image",width:s.width,height:s.height,image:s});try{if(l=`Running: ${k.title}`,d.type!==k.io.input)throw new Error(`IO mismatch: expected ${k.io.input}, got ${d.type}`);const T=k.tuningId?await e.runner.getEffectiveParams(k.tuningId).catch(()=>({})):{};let D;if(k.kind==="dispatch"){const{runOp:K}=await In(async()=>{const{runOp:j}=await Promise.resolve().then(()=>so);return{runOp:j}},void 0,import.meta.url);if(d.type==="image"){const j=await K(k.dispatchId,{image:d.image,width:d.width,height:d.height});if(k.io.output==="image"){const X=j;D={type:"image",width:X.width,height:X.height,image:X}}else if(k.io.output==="mask")D={type:"mask",width:d.width,height:d.height,mask:j};else throw new Error(`Unsupported dispatch output: ${k.io.output}`)}else if(d.type==="mask"){const j=await K(k.dispatchId,{mask:d.mask,width:d.width,height:d.height});if(k.io.output==="mask")D={type:"mask",width:d.width,height:d.height,mask:j};else if(k.io.output==="svg")D={type:"svg",width:d.width,height:d.height,svg:j};else throw new Error(`Invalid dispatch output: ${k.io.output}`)}else throw new Error("Dispatch ops cannot take svg input.")}else D=await k.run({input:d,params:T});if(D.type!==k.io.output)throw new Error(`IO mismatch: expected ${k.io.output}, got ${D.type}`);const z=((u==null?void 0:u.ops)??[]).concat([{instanceId:I.instanceId,opId:k.id,title:k.title,io:k.io,status:"ok",output:D}]);u={pipelineId:C.id,title:C.title,status:"ok",input:{type:"image",width:s.width,height:s.height,image:s},output:D,ops:z},d=D,f+=1,l=f>=r.length?"Done":"Ready"}catch(T){const D=T instanceof Error?T.message:String(T);l=`Error: ${k.title} — ${D}`;const z=((u==null?void 0:u.ops)??[]).concat([{instanceId:I.instanceId,opId:k.id,title:k.title,io:k.io,status:"error",error:D}]);u={pipelineId:C.id,title:C.title,status:"error",error:D,input:{type:"image",width:s.width,height:s.height,image:s},ops:z},e.runner.debug("pipeline next-step failed",{pipelineId:C.id,recipeId:a,instanceId:I.instanceId,opId:k.id,error:D})}}function c(){var K;const C=p(),I=y(),k=g(C),L={pipelines:(((K=t.listPipelines)==null?void 0:K.call(t))??t.builtIns).map(j=>({id:j.id,title:j.title})),recipes:k.map(j=>({id:j.id,title:j.title})),activePipelineId:o,activeRecipeId:a,statusText:l,description:I.description,stages:u?A(u):[],input:s?{width:s.width,height:s.height,data:s}:void 0,nextIndex:f,totalOps:r.length||I.ops.filter(j=>j.enabled!==!1).length},z=(u==null?void 0:u.output)??d??null;return x(L,z),L}return m(),{getVm:c,setActivePipeline:h,setActiveRecipe:v,setInputImageData:R,runAll:$,runNext:O,reset:m,reloadCatalogue:b}}function Po(e,t,n){const i=xo({runner:{getEffectiveParams:async c=>await n.getEffectiveParams(c).catch(()=>({})),debug:(c,E)=>Y({scope:"panel",kind:"debug",message:c,meta:E})}});let o=null,a=!1,s=null,l=null;function u(){const c=i.getVm();if(!(c.stages.some(P=>P.state==="error")||String(c.statusText).toLowerCase().includes("error"))){l=null;return}const S=String(c.statusText||"Pipeline error");S!==l&&(l=S,N({scope:"panel",kind:"error",message:`Pipeline: ${S}`}))}function r(){e.pipelineTuningMountEl.innerHTML=""}function f(c){return[c,`pipeline.${c}`,"pipeline"]}function d(c){const E=f(c);if(s===E[0])return;r();let S=null,P=null;for(const U of E)try{n.mount({mountEl:e.pipelineTuningMountEl,scopeRootId:U}),S=U;break}catch(C){P=C,r()}if(!S){s=null,N({scope:"panel",kind:"info",message:`Pipeline tuning mount failed for "${c}" (no matching scope).`}),Y({scope:"panel",kind:"error",message:"Pipeline tuning mount failed (no candidate scopeRootId worked)",meta:{pipelineId:c,candidates:E,error:P instanceof Error?P.message:String(P)}});return}s=S,N({scope:"panel",kind:"info",message:`Pipeline tuning mount: pipelineId=${c}, scopeRootId=${S}`})}function b(){const c=i.getVm(),E=typeof c.activePipelineId=="string"?c.activePipelineId:"segmentation";d(E)}function p(){const c=e.srcCanvasEl,E=c.width,S=c.height;if(!E||!S)return null;const P=c.getContext("2d",{willReadFrequently:!0});return P?P.getImageData(0,0,E,S):null}function g(){if(i.getVm().input)return;const E=p();E&&i.setInputImageData(E)}function y(){const c=p();c&&i.setInputImageData(c)}async function w(){const c=await n.getEffectiveParams("pipeline").catch(()=>({})),E=c==null?void 0:c.mode,S=c==null?void 0:c.recipe,P=typeof E=="string"?E:"segmentation",U=typeof S=="string"?S:"default";i.setActivePipeline(P),i.setActiveRecipe(U),b()}function m(){return o||(N({scope:"panel",kind:"info",message:"Pipeline view: create + mount"}),o=ji({hostEl:e.pipelineViewMountEl,statusEl:e.pipelineStatusEl,handlers:{onSelectPipeline:c=>{N({scope:"panel",kind:"info",message:`Pipeline select: ${c}`}),i.setActivePipeline(c),n.setParamValue("pipeline","mode",c),b(),h()},onSelectRecipe:c=>{N({scope:"panel",kind:"info",message:`Recipe select: ${c}`}),i.setActiveRecipe(c),n.setParamValue("pipeline","recipe",c),h()},onRunAll:()=>void v(),onNext:()=>void R(),onReset:()=>{i.reset();const c=p();c&&i.setInputImageData(c),Ve(i.getVm()),N({scope:"panel",kind:"info",message:"Pipeline reset (reseed from source)"}),b(),h()}}}),o.mount(),b(),o)}function h(){m().render(i.getVm())}async function v(){N({scope:"panel",kind:"info",message:"Pipeline run: all"}),y();try{await i.runAll()}finally{Ve(i.getVm()),h(),u()}}async function R(){N({scope:"panel",kind:"info",message:"Pipeline run: next"}),g();try{await i.runNext()}finally{Ve(i.getVm()),h(),u()}}function M(){}async function A(){a=!0,N({scope:"panel",kind:"info",message:"Pipeline tab: mount()"}),y(),await i.reloadCatalogue().catch(()=>null),await w(),N({scope:"panel",kind:"info",message:"Pipeline tab: render()"}),h()}async function x(){a&&(N({scope:"panel",kind:"info",message:"Pipeline tab: refresh()"}),y(),await i.reloadCatalogue().catch(()=>null),await w(),h())}function $(){a=!1,N({scope:"panel",kind:"info",message:"Pipeline tab: unmount()"})}function O(){N({scope:"panel",kind:"info",message:"Pipeline tab: dispose()"}),o==null||o.dispose(),o=null,s=null,r()}return{bind:M,mount:A,unmount:$,refresh:x,dispose:O}}function et(e){return!!e&&typeof e=="object"}function Ro(e){if(!et(e)||typeof e.id!="string"||!e.id||typeof e.title!="string"||!e.title||typeof e.implemented!="boolean"||!Array.isArray(e.ops))return!1;for(const t of e.ops)if(!et(t)||typeof t.instanceId!="string"||!t.instanceId||typeof t.opId!="string"||!t.opId||t.enabled!==void 0&&typeof t.enabled!="boolean")return!1;return!0}function Ao(){const e=Ze({userPipelines:[]});async function t(){return await pe().catch(()=>[])}function n(){return e.ops}async function i(){return await de().catch(()=>({}))}async function o(b){await mo(b).catch(()=>null)}async function a(b){await ho(b).catch(()=>null)}async function s(b){const p=await de().catch(()=>({}));!p||typeof p!="object"||(delete p[b],await ye(p).catch(()=>null))}async function l(b,p){await yo(b,p).catch(()=>null)}async function u(b,p){await vo(b,p).catch(()=>null)}async function r(b,p){await wo(b,p).catch(()=>null)}async function f(b){let p;try{p=JSON.parse(b)}catch{throw new Error("Invalid JSON (parse failed).")}let g,y;if(Array.isArray(p))g=p;else if(et(p)&&Array.isArray(p.pipelines))g=p.pipelines,y=p.recipes;else throw new Error('Invalid file shape. Expected {"pipelines":[...]} or an array of pipelines.');const w=g,m=w.length,h=[];let v=0;for(const A of w){if(!Ro(A)){v++;continue}h.push(A)}if(h.length===0)throw new Error("No valid pipelines found in the imported file.");const R=await pe().catch(()=>[]),M=new Map;for(const A of R)M.set(A.id,A);for(const A of h)M.set(A.id,A);if(await Oe(Array.from(M.values())),y!==void 0){if(!Array.isArray(y))throw new Error('Invalid "recipes" shape. Expected an array (or omit the field).');const A=Co(y);await ye(A).catch(()=>null)}return{imported:h.length,skipped:v,totalInFile:m}}async function d(){const b=await pe().catch(()=>[]),p=await de().catch(()=>({})),g={format:"beemage.pipeline.userPipelines.v2",exportedAt:new Date().toISOString(),pipelines:b,recipes:Eo(p)};return JSON.stringify(g,null,2)}return{listUserPipelines:t,listOperations:n,importFromJsonText:f,exportToJsonText:d,listAllRecipes:i,deleteUserPipelineById:o,upsertUserPipeline:a,setSelectedRecipe:l,upsertRecipe:u,deleteRecipe:r,deleteAllRecipesForPipeline:s}}function ne(e,t,n){const i=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))i.setAttribute(o,a);return typeof n=="string"&&(i.textContent=n),i}function Do(e){return e.enabled!==!1}function Mo(e){const t=new Map;for(const n of e)t.set(n.id,n);return t}function To(e,t,n){const i={compactOps:n==null?void 0:n.compactOps},o=Mo(t),a=ne("div",{class:"pipelineCard"}),s=ne("div",{class:"pipelineCardHead"}),l=ne("div",{style:"display:flex; flex-direction:column; gap:2px;"});l.appendChild(ne("div",{class:"pipelineCardTitle"},e.title||e.id)),s.appendChild(l);{const d=e.implemented?"implemented":"not implemented";s.appendChild(ne("div",{class:"status"},d))}a.appendChild(s);const u=ne("div",{class:"pipelineOps",style:"margin-top:10px;"}),f=Array.isArray(e.ops)?e.ops:[];if(!f.length)return u.appendChild(ne("div",{class:"muted",style:"font-size:12px;"},"No operations in this pipeline.")),a.appendChild(u),a;for(let d=0;d<f.length;d++){const b=f[d],p=o.get(b.opId),g=!Do(b),y=p?ot(p,{compact:i.compactOps,showGroup:!0,showId:!0}):ne("div",{class:"opCard opCard--unknown",style:"padding:10px;"},`Unknown operation: ${b.opId}`);g&&y.classList.add("is-disabled"),u.appendChild(y),d<f.length-1&&u.appendChild(ne("div",{class:"pipelineConnector","aria-hidden":"true"}))}return a.appendChild(u),a}function Q(e,t,n){const i=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))i.setAttribute(o,a);return typeof n=="string"&&(i.textContent=n),i}function Lo(e){return JSON.parse(e)}function Oo(e){const{pipelineId:t,instanceIds:n,selectedRecipeId:i,recipes:o,handlers:a}=e,s=Q("div",{class:"card",style:"padding:10px; margin-top:8px;"});s.appendChild(Q("div",{class:"cardTitle"},"Recipes"));const l=Q("div",{class:"row",style:"gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px;"});s.appendChild(l);const u=Q("label",{class:"fieldInline"});u.appendChild(Q("span",{},"Selected"));const r=Q("select"),f=Q("option");f.value="",f.textContent="None",r.appendChild(f);for(const h of o){const v=Q("option");v.value=h.id,v.textContent=`${h.title} (${h.id})`,r.appendChild(v)}r.value=i??"",r.addEventListener("change",()=>{const h=r.value;h&&a.onSelectRecipe(t,h)}),u.appendChild(r),l.appendChild(u);const d=Q("button",{class:"btn",type:"button"},"New recipe"),b=Q("button",{class:"btn",type:"button"},"Edit recipe"),p=Q("button",{class:"btn",type:"button"},"Delete recipe");l.appendChild(d),l.appendChild(b),l.appendChild(p);const g=Q("div",{class:"muted",style:"font-size:12px; margin-top:8px;"},`Recipes store only deltas per instanceId. Valid instanceIds: ${n.join(", ")||"(none)"}`);s.appendChild(g);function y(){const h=window.prompt("New recipe id (unique within this pipeline):","new");if(!h)return;const v=window.prompt("Recipe title:",h);v&&a.onUpsertRecipe(t,{id:h,title:v,ops:[]})}function w(){const h=(i??r.value)||"";if(!h){window.alert("Select a recipe first.");return}const v=o.find(A=>A.id===h);if(!v){window.alert("Recipe not found.");return}const R={id:v.id,title:v.title,ops:v.ops},M=window.prompt(`Edit recipe JSON (pipeline=${t}).

Structure: { id, title, ops: [{ instanceId, enabled?, override?: { enginePolicy?, params? } }] }

`,JSON.stringify(R,null,2));if(M)try{const A=Lo(M);if(typeof A.id!="string"||!A.id)throw new Error("Missing recipe.id");if(typeof A.title!="string"||!A.title)throw new Error("Missing recipe.title");if(!Array.isArray(A.ops))throw new Error("Missing recipe.ops array");for(const x of A.ops){if(!x||typeof x!="object")throw new Error("Invalid patch object in ops");if(typeof x.instanceId!="string"||!x.instanceId)throw new Error("Patch missing instanceId");n.length&&!n.includes(x.instanceId)&&console.warn("Recipe patch references unknown instanceId",t,x.instanceId)}a.onUpsertRecipe(t,{id:A.id,title:A.title,ops:A.ops})}catch(A){const x=A instanceof Error?A.message:String(A);window.alert(`Invalid recipe JSON: ${x}`)}}function m(){const h=(i??r.value)||"";if(!h){window.alert("Select a recipe first.");return}window.confirm(`Delete recipe "${h}" from pipeline "${t}"?`)&&a.onDeleteRecipe(t,h)}return d.addEventListener("click",y),b.addEventListener("click",w),p.addEventListener("click",m),o.length||(b.disabled=!0,p.disabled=!0),s}function se(e,t,n){const i=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))i.setAttribute(o,a);return typeof n=="string"&&(i.textContent=n),i}function $o(e){return JSON.parse(e)}function Bo(e){const{pipeline:t,opsLibrary:n,selectedRecipeId:i,recipes:o,handlers:a}=e,s=se("div",{class:"card",style:"padding:10px; margin-top:10px;"}),l=se("div",{class:"row",style:"justify-content:space-between; align-items:center; gap:10px;"}),u=se("div",{class:"cardTitle"},`${t.title} (${t.id})`);l.appendChild(u);const r=se("div",{class:"row",style:"gap:8px; align-items:center;"}),f=se("button",{class:"btn",type:"button"},"Edit"),d=se("button",{class:"btn",type:"button"},"Delete");r.appendChild(f),r.appendChild(d),l.appendChild(r),s.appendChild(l),t.description&&s.appendChild(se("div",{class:"muted",style:"font-size:12px; margin-top:6px;"},t.description));const b=se("div",{style:"margin-top:10px;"});b.appendChild(To(t,n,{compactOps:!0})),s.appendChild(b);const p=t.ops.map(w=>w.instanceId);s.appendChild(Oo({pipelineId:t.id,instanceIds:p,selectedRecipeId:i,recipes:o,handlers:a}));function g(){const w={id:t.id,title:t.title,description:t.description??"",implemented:t.implemented,ops:t.ops},m=window.prompt(`Edit pipeline JSON.

Structure: { id, title, description?, implemented, ops: [{ instanceId, opId, enabled?, override? }] }

`,JSON.stringify(w,null,2));if(m)try{const h=$o(m);if(!h||typeof h!="object")throw new Error("Invalid JSON object");if(typeof h.id!="string"||!h.id)throw new Error("Missing pipeline.id");if(typeof h.title!="string"||!h.title)throw new Error("Missing pipeline.title");if(typeof h.implemented!="boolean")throw new Error("Missing pipeline.implemented boolean");if(!Array.isArray(h.ops))throw new Error("Missing pipeline.ops array");for(const v of h.ops){if(!v||typeof v!="object")throw new Error("Invalid op entry");if(typeof v.instanceId!="string"||!v.instanceId)throw new Error("Op missing instanceId");if(typeof v.opId!="string"||!v.opId)throw new Error("Op missing opId");if(v.enabled!==void 0&&typeof v.enabled!="boolean")throw new Error("Op.enabled must be boolean")}a.onUpsertPipeline(h)}catch(h){const v=h instanceof Error?h.message:String(h);window.alert(`Invalid pipeline JSON: ${v}`)}}function y(){window.confirm(`Delete pipeline "${t.id}"? This also deletes its recipes.`)&&a.onDeletePipeline(t.id)}return f.addEventListener("click",g),d.addEventListener("click",y),s}function G(e,t,n){const i=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))i.setAttribute(o,a);return typeof n=="string"&&(i.textContent=n),i}function Uo(e){const{dom:t,handlers:n}=e;let i=!1,o=!1,a="all",s="all",l=null,u=null,r="",f=null,d=null,b=null;function p(){if(d)return d;const x=G("div",{"data-role":"builderListMount",style:"margin-top:12px;"});return t.viewBuilder.appendChild(x),d=x,x}function g(){if(b)return b;const x=G("div",{"data-role":"builderOpsMount",style:"margin-top:12px;"});return t.viewBuilder.appendChild(x),b=x,x}function y(x,$){const O=G("select"),c=[{value:"all",label:"All"},{value:"image",label:"image"},{value:"mask",label:"mask"},{value:"svg",label:"svg"}];for(const E of c){const S=G("option");S.value=E.value,S.textContent=E.label,E.value===x&&(S.selected=!0),O.appendChild(S)}return O.addEventListener("change",()=>$(O.value)),O}function w(x){const $=a==="all"?!0:x.io.input===a,O=s==="all"?!0:x.io.output===s;return $&&O}function m(x,$){const O=g();O.innerHTML="";const c=G("div",{class:"card",style:"padding:10px;"});c.appendChild(G("div",{class:"cardTitle"},"All operations"));const E=G("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px;"}),S=G("label",{class:"fieldInline"});S.appendChild(G("span",{},"Filter input")),l=y(String(a),I=>{a=I==="all"?"all":I,m(x)}),S.appendChild(l);const P=G("label",{class:"fieldInline"});P.appendChild(G("span",{},"Filter output")),u=y(String(s),I=>{s=I==="all"?"all":I,m(x)}),P.appendChild(u),E.appendChild(S),E.appendChild(P),c.appendChild(E);const U=x.filter(w);if(!U.length){c.appendChild(G("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No operations match the filter.")),O.appendChild(c);return}const C=G("div",{class:"opsGrid",style:"margin-top:10px;"});for(const I of U)C.appendChild(ot(I,{compact:!0,showGroup:!0,showId:!0}));c.appendChild(C),O.appendChild(c)}function h(x,$){const O=p();O.innerHTML="";const c=G("div",{class:"card",style:"padding:10px;"});c.appendChild(G("div",{class:"cardTitle"},"Stored user pipelines"));const E=G("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px;"}),S=G("label",{class:"fieldInline"});S.appendChild(G("span",{},"Filter pipelines")),f=G("input",{type:"text",value:r,placeholder:"Search by id or title…",style:"min-width:260px;"}),f.addEventListener("input",()=>{r=f?f.value:"",h($.pipelines,$)}),S.appendChild(f);const P=G("button",{type:"button",class:"btn",style:"padding:4px 10px; font-size:12px;"},"Clear");P.addEventListener("click",()=>{r="",f&&(f.value=""),h($.pipelines,$)}),E.appendChild(S),E.appendChild(P),c.appendChild(E);const U=Array.isArray($.userPipelinesRaw)?$.userPipelinesRaw:[];if(!U.length){c.appendChild(G("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No user pipelines stored.")),O.appendChild(c);return}const C=r.trim().toLowerCase(),I=C.length===0?U:U.filter(D=>{const L=String(D.id??"").toLowerCase(),z=String(D.title??"").toLowerCase();return L.includes(C)||z.includes(C)});if(!I.length){c.appendChild(G("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No pipelines match the search.")),O.appendChild(c);return}const k=G("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:10px;"}),T=$.recipesAll??{};for(const D of I){const L=(T==null?void 0:T[D.id])??{recipesById:{},selectedRecipeId:void 0},z=(L==null?void 0:L.recipesById)??{},K=Object.values(z),j=L==null?void 0:L.selectedRecipeId;k.appendChild(Bo({pipeline:D,opsLibrary:$.ops??[],selectedRecipeId:j,recipes:K,handlers:{onDeletePipeline:n.onDeletePipeline,onUpsertPipeline:n.onUpsertPipeline,onSelectRecipe:n.onSelectRecipe,onUpsertRecipe:n.onUpsertRecipe,onDeleteRecipe:n.onDeleteRecipe}}))}c.appendChild(k),O.appendChild(c)}function v(){o||(o=!0,t.builderImportFileEl.addEventListener("change",()=>{var x;(x=t.builderImportFileEl.files)==null||x[0]}),t.btnBuilderExportEl.addEventListener("click",()=>{n.onExport()}),t.builderImportFileEl.addEventListener("change",()=>{var $;const x=(($=t.builderImportFileEl.files)==null?void 0:$[0])??null;x&&(n.onImportFile(x),t.builderImportFileEl.value="")}))}function R(){i||(i=!0,p(),g())}function M(x){t.builderStatusEl.textContent=x.statusText||"Idle",h(x.pipelines,x),m(x.ops??[])}function A(){i=!1,o=!1,a="all",s="all",r="",f=null,l=null,u=null,d&&(d.innerHTML="",d.remove(),d=null),b&&(b.innerHTML="",b.remove(),b=null)}return{bind:v,mount:R,render:M,dispose:A}}function Vo(e,t){const n=new Blob([t],{type:"application/json;charset=utf-8"}),i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download=e,o.rel="noopener",o.click(),setTimeout(()=>URL.revokeObjectURL(i),500)}function No(e,t){const n=Ao();let i=!1,o={},a="Idle",s=[],l=n.listOperations();const u=Uo({dom:e,handlers:{onImportFile:async m=>{try{a=`Importing: ${m.name}`,d();const h=await m.text(),v=await n.importFromJsonText(h);N({scope:"panel",kind:"info",message:`Builder import: imported=${v.imported}, skipped=${v.skipped}, total=${v.totalInFile}`}),a=`Imported ${v.imported} pipeline(s) (skipped ${v.skipped}).`,await r()}catch(h){const v=h instanceof Error?h.message:String(h);N({scope:"panel",kind:"error",message:`Builder import failed: ${v}`}),Y({scope:"panel",kind:"error",message:"Builder import failed",meta:{error:v}}),a=`Import failed: ${v}`,d()}},onExport:async()=>{try{a="Exporting…",d();const m=await n.exportToJsonText();Vo("beemage-user-pipelines.json",m),N({scope:"panel",kind:"info",message:"Builder export: downloaded beemage-user-pipelines.json"}),a="Exported.",d()}catch(m){const h=m instanceof Error?m.message:String(m);N({scope:"panel",kind:"error",message:`Builder export failed: ${h}`}),Y({scope:"panel",kind:"error",message:"Builder export failed",meta:{error:h}}),a=`Export failed: ${h}`,d()}},onDeletePipeline:async m=>{try{await n.deleteUserPipelineById(m),await n.deleteAllRecipesForPipeline(m),N({scope:"panel",kind:"info",message:`Builder: deleted user pipeline "${m}" (and its recipes)`}),a=`Deleted pipeline ${m}.`,await r()}catch(h){const v=h instanceof Error?h.message:String(h);N({scope:"panel",kind:"error",message:`Delete pipeline failed: ${v}`}),Y({scope:"panel",kind:"error",message:"Delete pipeline failed",meta:{pipelineId:m,error:v}}),a=`Delete failed: ${v}`,d()}},onUpsertPipeline:async m=>{try{await n.upsertUserPipeline(m),N({scope:"panel",kind:"info",message:`Builder: saved user pipeline "${String((m==null?void 0:m.id)??"")}"`}),a=`Saved pipeline ${String((m==null?void 0:m.id)??"")}.`,await r()}catch(h){const v=h instanceof Error?h.message:String(h);N({scope:"panel",kind:"error",message:`Save pipeline failed: ${v}`}),Y({scope:"panel",kind:"error",message:"Save pipeline failed",meta:{error:v}}),a=`Save failed: ${v}`,d()}},onSelectRecipe:async(m,h)=>{try{await n.setSelectedRecipe(m,h),N({scope:"panel",kind:"info",message:`Builder: selected recipe "${h}" for pipeline "${m}"`}),a=`Selected recipe ${h} for ${m}.`,await r()}catch(v){const R=v instanceof Error?v.message:String(v);N({scope:"panel",kind:"error",message:`Select recipe failed: ${R}`}),Y({scope:"panel",kind:"error",message:"Select recipe failed",meta:{pipelineId:m,recipeId:h,error:R}}),a=`Select recipe failed: ${R}`,d()}},onUpsertRecipe:async(m,h)=>{try{await n.upsertRecipe(m,h),N({scope:"panel",kind:"info",message:`Builder: saved recipe "${String((h==null?void 0:h.id)??"")}" for pipeline "${m}"`}),a=`Saved recipe ${String((h==null?void 0:h.id)??"")} for ${m}.`,await r()}catch(v){const R=v instanceof Error?v.message:String(v);N({scope:"panel",kind:"error",message:`Save recipe failed: ${R}`}),Y({scope:"panel",kind:"error",message:"Save recipe failed",meta:{pipelineId:m,error:R}}),a=`Save recipe failed: ${R}`,d()}},onDeleteRecipe:async(m,h)=>{try{await n.deleteRecipe(m,h),N({scope:"panel",kind:"info",message:`Builder: deleted recipe "${h}" from pipeline "${m}"`}),a=`Deleted recipe ${h} from ${m}.`,await r()}catch(v){const R=v instanceof Error?v.message:String(v);N({scope:"panel",kind:"error",message:`Delete recipe failed: ${R}`}),Y({scope:"panel",kind:"error",message:"Delete recipe failed",meta:{pipelineId:m,recipeId:h,error:R}}),a=`Delete recipe failed: ${R}`,d()}}}});async function r(){const m=await n.listUserPipelines().catch(()=>[]);s=m,l=n.listOperations(),o=await n.listAllRecipes().catch(()=>({})),a=`Ready. User pipelines: ${m.length} · Operations: ${l.length}`,d()}function f(){const m=s??[];return{statusText:a,pipelines:m.map(h=>({id:String(h.id),title:String(h.title),implemented:!!h.implemented,opCount:Array.isArray(h.ops)?h.ops.length:0})),userPipelinesRaw:m,ops:l,recipesAll:o??{}}}function d(){u.mount(),u.render(f())}function b(){u.bind(),e.builderStatusEl.textContent="Idle"}async function p(){i=!0,a="Loading…",d(),await r()}async function g(){i&&(a="Refreshing…",d(),await r())}function y(){i=!1}function w(){u.dispose()}return{bind:b,mount:p,refresh:g,unmount:y,dispose:w}}async function jo(){const e=kn();await He().catch(()=>null);const t=Pn();t.start();const n=Tn();globalThis.__APP__={...globalThis.__APP__,cache:n};const i=Oi({getRuntimeAvailability:()=>({opencvReady:!1}),debugTraceAppend:d=>Y({scope:"panel",kind:"debug",message:d}),actionLogAppend:d=>N({scope:"panel",kind:"info",message:d})});i.mount({mountEl:e.tuningMountEl,scopeRootId:"app"});const o=Kn(e),a=ti(e),s=Po(e,t,i),l=Pi(e,t),u=Mi(e),r=No(e);o.bind(),s.bind(),a.bind(),l.bind(),u.bind(),r.bind();const f=Mn(e,{image:o,pipeline:s,builder:r,colors:a,settings:l,logs:u});f.bind(),f.boot()}jo();
