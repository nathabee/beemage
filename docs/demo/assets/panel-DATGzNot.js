import{_ as Rn}from"./index-DGDEbKu7.js";function Dn(){function e(xt,Tn){if(!xt)throw new Error(`[dom] Missing #${Tn}`);return xt}const t=e(document.getElementById("appRoot"),"appRoot"),i=e(document.getElementById("tabImage"),"tabImage"),n=e(document.getElementById("tabColors"),"tabColors"),o=e(document.getElementById("tabSettings"),"tabSettings"),a=e(document.getElementById("tabLogs"),"tabLogs"),s=e(document.getElementById("tabPipeline"),"tabPipeline"),c=e(document.getElementById("tabBuilder"),"tabBuilder"),d=e(document.getElementById("viewImage"),"viewImage"),l=e(document.getElementById("viewColors"),"viewColors"),f=e(document.getElementById("viewSettings"),"viewSettings"),p=e(document.getElementById("viewLogs"),"viewLogs"),r=e(document.getElementById("viewPipeline"),"viewPipeline"),g=e(document.getElementById("viewBuilder"),"viewBuilder"),u=e(document.getElementById("dropZone"),"dropZone"),b=e(document.getElementById("fileInput"),"fileInput"),w=e(document.getElementById("srcCanvas"),"srcCanvas"),h=e(document.getElementById("pipelineStatus"),"pipelineStatus"),m=e(document.getElementById("pipelineTuningMount"),"pipelineTuningMount"),C=e(document.getElementById("pipelineViewMount"),"pipelineViewMount"),v=e(document.getElementById("builderImportFile"),"builderImportFile"),E=e(document.getElementById("btnBuilderExport"),"btnBuilderExport"),x=e(document.getElementById("builderStatus"),"builderStatus"),M=e(document.getElementById("colorsCanvas"),"colorsCanvas"),A=e(document.getElementById("palette"),"palette"),U=e(document.getElementById("btnColorsApply"),"btnColorsApply"),P=e(document.getElementById("btnColorsCancel"),"btnColorsCancel"),y=e(document.getElementById("btnColorsReset"),"btnColorsReset"),z=e(document.getElementById("edgesDark"),"edgesDark"),N=e(document.getElementById("edgeMaskThreshold"),"edgeMaskThreshold"),R=e(document.getElementById("edgeDilate"),"edgeDilate"),D=e(document.getElementById("maxRegionPx"),"maxRegionPx"),k=e(document.getElementById("colorsStatus"),"colorsStatus"),S=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),$=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),I=e(document.getElementById("devConfigDetails"),"devConfigDetails"),T=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),L=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),V=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),O=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),B=e(document.getElementById("logsCbDebug"),"logsCbDebug"),W=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),j=e(document.getElementById("cfgStatus"),"cfgStatus"),H=e(document.getElementById("cfgOpenCvSpinner"),"cfgOpenCvSpinner"),q=e(document.getElementById("cfgOpenCvStatus"),"cfgOpenCvStatus"),Y=e(document.getElementById("cfgOpenCvReport"),"cfgOpenCvReport"),F=e(document.getElementById("settingsEngineBox"),"settingsEngineBox"),ee=e(document.getElementById("cfgUseOpenCv"),"cfgUseOpenCv"),Q=e(document.getElementById("tuningMount"),"tuningMount"),ce=e(document.getElementById("settingsVersion"),"settingsVersion"),pe=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),Ye=e(document.getElementById("logsLimit"),"logsLimit"),bn=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),wn=e(document.getElementById("logsStatus"),"logsStatus"),vn=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),Cn=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),En=e(document.getElementById("btnLogsExport"),"btnLogsExport"),xn=e(document.getElementById("btnLogsClear"),"btnLogsClear"),kn=e(document.getElementById("logsOut"),"logsOut"),In=e(document.getElementById("debugLimit"),"debugLimit"),Sn=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),Pn=e(document.getElementById("btnDebugExport"),"btnDebugExport"),$n=e(document.getElementById("btnDebugClear"),"btnDebugClear"),Ln=e(document.getElementById("debugStatus"),"debugStatus"),An=e(document.getElementById("debugOut"),"debugOut");return{rootEl:t,tabImage:i,tabColors:n,tabSettings:o,tabLogs:a,tabPipeline:s,tabBuilder:c,viewImage:d,viewColors:l,viewSettings:f,viewLogs:p,viewPipeline:r,viewBuilder:g,dropZoneEl:u,fileInputEl:b,srcCanvasEl:w,pipelineStatusEl:h,pipelineTuningMountEl:m,pipelineViewMountEl:C,builderImportFileEl:v,btnBuilderExportEl:E,builderStatusEl:x,colorsCanvasEl:M,paletteEl:A,btnColorsApplyEl:U,btnColorsCancelEl:P,btnColorsResetEl:y,edgesDarkEl:z,edgeMaskThresholdEl:N,edgeDilateEl:R,maxRegionPxEl:D,colorsStatusEl:k,cfgShowDevToolsEl:S,settingsGeneralStatusEl:$,devConfigDetailsEl:I,cfgTraceConsoleEl:T,cfgActionLogMaxEl:L,cfgDebugTraceMaxEl:V,cfgFailureLogsPerRunEl:O,logsCbDebugEl:B,btnCfgResetDefaults:W,cfgStatusEl:j,settingsVersionEl:ce,settingsGitHubLinkEl:pe,cfgOpenCvSpinner:H,cfgOpenCvStatus:q,cfgOpenCvReport:Y,settingsEngineBoxEl:F,cfgUseOpenCvEl:ee,tuningMountEl:Q,logsLimitEl:Ye,btnLogsRefresh:bn,logsStatusEl:wn,logsTrimKeepEl:vn,btnLogsTrim:Cn,btnLogsExport:En,btnLogsClear:xn,logsOutEl:kn,debugLimitEl:In,btnDebugRefresh:Sn,btnDebugExport:Pn,btnDebugClear:$n,debugStatusEl:Ln,debugOutEl:An}}const Mn=new Set;function On(e){Mn.add(e)}function kt(e){return`./${String(e||"").replace(/^\/+/,"")}`}function Bn(){const e=new Set;function t(n){return e.add(n),()=>e.delete(n)}function i(){On(o=>{for(const a of e)a(o)})}return{on:t,start:i}}const Un=new Set;function qt(e){for(const t of Un)t(e,"local")}function $e(e){const t=localStorage.getItem(e);if(t!==null)try{return JSON.parse(t)}catch{return t}}function zn(e,t){localStorage.setItem(e,JSON.stringify(t))}async function he(e){if(typeof e=="string")return{[e]:$e(e)};if(Array.isArray(e)){const i={};for(const n of e)i[n]=$e(n);return i}const t={};for(const[i,n]of Object.entries(e))t[i]=localStorage.getItem(i)!==null?$e(i):n;return t}async function me(e){const t={};for(const[i,n]of Object.entries(e)){const o=$e(i);zn(i,n),t[i]={oldValue:o,newValue:n}}qt(t)}async function wt(e){const t=Array.isArray(e)?e:[e],i={};for(const n of t){const o=$e(n);localStorage.removeItem(n),i[n]={oldValue:o,newValue:void 0}}qt(i)}function fe(e,t,i,n){const o=Number(String(e??"").trim());return Number.isFinite(o)?Math.max(t,Math.min(i,Math.floor(o))):n}const st="beemage.devConfig",se={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let rt=!1,Ve={...se};function Jt(e){const t=e||{};return{traceConsole:!!t.traceConsole,actionLogMax:fe(t.actionLogMax??se.actionLogMax,100,5e4,se.actionLogMax),debugTraceMax:fe(t.debugTraceMax??se.debugTraceMax,100,5e4,se.debugTraceMax),failureLogsPerRun:fe(t.failureLogsPerRun??se.failureLogsPerRun,0,5e4,se.failureLogsPerRun)}}async function lt(){if(rt)return;const e=await he([st]).catch(()=>({}));Ve=Jt(e==null?void 0:e[st]),rt=!0}function Ne(){return Ve}async function Zt(e){Ve=Jt(e),rt=!0,await me({[st]:Ve}).catch(()=>null)}async function jn(){await Zt({...se})}function Vn(e,t){const i={pipeline:e.tabPipeline,image:e.tabImage,builder:e.tabBuilder,colors:e.tabColors,settings:e.tabSettings,logs:e.tabLogs},n={pipeline:e.viewPipeline,image:e.viewImage,builder:e.viewBuilder,colors:e.viewColors,settings:e.viewSettings,logs:e.viewLogs};let o="image";const a=new Set;function s(){const g=Ne();return!!(g!=null&&g.traceConsole)}function c(){const g=globalThis;g.__bctGlobalErrorHooksInstalled||(g.__bctGlobalErrorHooksInstalled=!0,window.addEventListener("error",u=>{var w;const b=u;console.error("[panel] window error",{message:b.message,filename:b.filename,lineno:b.lineno,colno:b.colno,error:b.error?String(b.error):null,stack:(w=b.error)!=null&&w.stack?String(b.error.stack):null})}),window.addEventListener("unhandledrejection",u=>{var b;console.error("[panel] unhandledrejection",{reason:u.reason?String(u.reason):null,stack:(b=u.reason)!=null&&b.stack?String(u.reason.stack):null})}))}s()&&c();function d(g){Object.keys(i).forEach(u=>{const b=u===g;i[u].classList.toggle("is-active",b),i[u].setAttribute("aria-selected",b?"true":"false"),n[u].hidden=!b,n[u].classList.toggle("is-active",b)})}function l(g){var u,b,w,h,m,C,v,E;if(g===o){(b=(u=t[g]).refresh)==null||b.call(u);return}(h=(w=t[o]).unmount)==null||h.call(w),o=g,d(o),a.has(o)?(E=(v=t[o]).refresh)==null||E.call(v):(a.add(o),(C=(m=t[o]).mount)==null||C.call(m))}function f(){i.image.addEventListener("click",g=>{var u;(u=g.preventDefault)==null||u.call(g),l("image")}),i.pipeline.addEventListener("click",g=>{var u;(u=g.preventDefault)==null||u.call(g),l("pipeline")}),i.colors.addEventListener("click",g=>{var u;(u=g.preventDefault)==null||u.call(g),l("colors")}),i.settings.addEventListener("click",g=>{var u;(u=g.preventDefault)==null||u.call(g),l("settings")}),i.logs.addEventListener("click",g=>{var u;(u=g.preventDefault)==null||u.call(g),l("logs")}),i.builder.addEventListener("click",g=>{var u;(u=g.preventDefault)==null||u.call(g),l("builder")})}function p(){var g,u,b,w;o="image",d(o),Object.keys(t).forEach(h=>{var m,C;return(C=(m=t[h]).boot)==null?void 0:C.call(m)}),a.has(o)?(w=(b=t[o]).refresh)==null||w.call(b):(a.add(o),(u=(g=t[o]).mount)==null||u.call(g))}function r(){Object.keys(t).forEach(g=>{var u,b;return(b=(u=t[g]).dispose)==null?void 0:b.call(u)})}return{bind:f,boot:p,activate:l,dispose:r}}function It(e){const t=e.items.length;return{items:e.items,counts:{items:t},meta:e.meta}}function Nn(){const e={items:[],meta:{}},t=new Set;function i(){const l=It(e);for(const f of t)try{f(l)}catch{}}function n(){return It(e)}function o(l){t.add(l);try{l(n())}catch{}return()=>t.delete(l)}function a(){e.items=[],e.meta={},i()}function s(l){e.meta.scopeUpdatedSince=l,i()}function c(){return String(e.meta.scopeUpdatedSince||"")}function d(l,f){e.items=l.slice(),e.meta.updatedTs=Date.now(),typeof(f==null?void 0:f.limit)=="number"&&(e.meta.limit=f.limit),i()}return{getSnapshot:n,subscribe:o,getScopeUpdatedSince:c,clearAll:a,setScopeUpdatedSince:s,setItems:d}}function Fn(e,t,i){let n=null;function o(){if(n)return n;const p=document.createElement("div");return p.className="mageFileList",p.setAttribute("style",["margin-top:10px;","padding:8px 10px;","border-radius:10px;","border:1px solid rgba(255,255,255,0.12);","background: rgba(0,0,0,0.06);","font-size:12px;"].join(" ")),(e.dropZoneEl.parentElement??e.dropZoneEl).appendChild(p),n=p,p}function a(p){e.dropZoneEl.classList.toggle("is-hover",p)}function s(p,r){const g=p.getContext("2d",{willReadFrequently:!0});if(!g)return;const u=Math.max(1,p.width),b=Math.max(1,p.height);g.clearRect(0,0,u,b);const w=r.naturalWidth||r.width,h=r.naturalHeight||r.height;if(!w||!h)return;const m=Math.min(u/w,b/h),C=Math.max(1,Math.round(w*m)),v=Math.max(1,Math.round(h*m)),E=Math.floor((u-C)/2),x=Math.floor((b-v)/2);g.drawImage(r,E,x,C,v)}function c(p){s(e.srcCanvasEl,p)}function d(p){const r=o();if(r.innerHTML="",!p.length){r.textContent="No files loaded.";return}const g=document.createElement("div");g.textContent=p.length===1?"Loaded file:":`Loaded files (${p.length}) — reorder for stacking/PDF:`,g.setAttribute("style","margin-bottom:6px; opacity:0.85;"),r.appendChild(g);for(let u=0;u<p.length;u++){const b=document.createElement("div");b.setAttribute("style",["display:flex;","align-items:center;","gap:8px;","padding:4px 0;","border-top: 1px solid rgba(255,255,255,0.06);"].join(" "));const w=document.createElement("div");w.textContent=`${u+1}. ${p[u]}`,w.setAttribute("style","flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"),b.appendChild(w);const h=document.createElement("button");h.type="button",h.textContent="Up",h.disabled=u===0,h.addEventListener("click",()=>i.onMove(u,u-1)),b.appendChild(h);const m=document.createElement("button");m.type="button",m.textContent="Down",m.disabled=u===p.length-1,m.addEventListener("click",()=>i.onMove(u,u+1)),b.appendChild(m),r.appendChild(b)}}function l(p){t.lastError=void 0;const r=Array.isArray(p)?p.filter(Boolean):[];t.loadedImageNames=r,t.loadedCount=r.length,t.loadedImageName=r[0]??null,t.hasImage=r.length>0,d(r)}function f(p){t.lastError=p,t.hasImage=!1,t.loadedImageName=null,t.loadedImageNames=[],t.loadedCount=0;const r=o();r.innerHTML="",r.textContent=`Error: ${p}`}return d(t.loadedImageNames??[]),{setHover:a,drawImageToSource:c,showLoadOk:l,showLoadError:f}}function _n(){return{loadedImageName:null,loadedImageNames:[],loadedCount:0,hasImage:!1,lastError:void 0}}const Fe="beemage.actionLog",Hn=5e3;function Gn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function Wn(e){return Array.isArray(e)?e:[e]}function _e(e,t,i){return Math.max(t,Math.min(i,Math.floor(e)))}async function Le(){const e=await he(Fe),t=e==null?void 0:e[Fe];return Array.isArray(t)?t:[]}async function Yt(e){await me({[Fe]:e})}async function G(e,t){const i=_e(Hn,100,5e4),o=Wn(e).map(d=>({...d,id:Gn(),ts:Date.now()}));if(!o.length)return{total:(await Le()).length};const s=(await Le()).concat(o),c=s.length>i?s.slice(s.length-i):s;return await Yt(c),{total:c.length}}async function Kn(e){const t=_e((e==null?void 0:e.limit)??200,1,5e4),i=_e((e==null?void 0:e.offset)??0,0,1e6);let o=await Le();e!=null&&e.kind&&(o=o.filter(c=>c.kind===e.kind)),e!=null&&e.scope&&(o=o.filter(c=>c.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(o=o.filter(c=>c.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(o=o.filter(c=>c.ts<=e.untilTs));const a=o.length;o=o.slice().reverse();const s=o.slice(i,i+t);return{total:a,items:s}}async function qn(e){let i=await Le();if(typeof e.beforeTs=="number"&&(i=i.filter(n=>n.ts>=e.beforeTs)),typeof e.keepLast=="number"){const n=_e(e.keepLast,0,5e4);n===0?i=[]:i.length>n&&(i=i.slice(i.length-n))}return await Yt(i),{total:i.length}}async function Jn(){await wt(Fe)}async function Zn(e){const t=await Le();return JSON.stringify(t,null,2)}const Ae="beemage.debugTrace",ct="beemage.debugTrace.enabled",Yn=2e3;function Qn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function dt(e,t,i){return Math.max(t,Math.min(i,Math.floor(e)))}async function He(){const e=await he(Ae),t=e==null?void 0:e[Ae];return Array.isArray(t)?t:[]}async function Xn(e){await me({[Ae]:e})}async function vt(){const e=await he(ct);return!!(e!=null&&e[ct])}async function Qt(e){await me({[ct]:!!e}),e||await wt(Ae)}async function Xt(){await wt(Ae)}async function ne(e,t){if(!await vt())return{total:0};const n=dt((t==null?void 0:t.max)??Yn,100,5e4),o=(Array.isArray(e)?e:[e]).map(d=>({...d,id:Qn(),ts:Date.now()}));if(!o.length)return{total:(await He()).length};const s=(await He()).concat(o),c=s.length>n?s.slice(s.length-n):s;return await Xn(c),{total:c.length}}async function en(e){const t=dt((e==null?void 0:e.limit)??200,1,5e4),i=dt((e==null?void 0:e.offset)??0,0,1e6),n=(e==null?void 0:e.reverse)??!0,o=await He(),a=o.length,c=(n?o.slice().reverse():o).slice(i,i+t);return{total:a,items:c}}async function tn(e){const t=await He();return JSON.stringify(t,null,e!=null&&e.pretty?2:0)}const nn=Object.freeze(Object.defineProperty({__proto__:null,append:ne,clear:Xt,exportJson:tn,isEnabled:vt,list:en,setEnabled:Qt},Symbol.toStringTag,{value:"Module"}));function ei(e,t){const i=_n();let n=[];const a=Fn(e,i,{onMove:(w,h)=>{if(w===h||w<0||w>=n.length||h<0||h>=n.length)return;const m=n.slice(),[C]=m.splice(w,1);C&&(m.splice(h,0,C),n=m,f(),l(),a.showLoadOk(n.map(v=>v.name)),G({scope:"panel",kind:"info",message:`Input order updated: ${w+1} → ${h+1}`}),ne({scope:"panel",kind:"info",message:"Mage input reordered",meta:{fromIndex:w,toIndex:h,names:n.slice(0,10).map(v=>v.name)}}))}});async function s(w){if(!w.type.startsWith("image/"))throw new Error(`Unsupported file type: ${w.type||"unknown"}`);const h=URL.createObjectURL(w);try{const m=new Image;return m.decoding="async",m.src=h,typeof m.decode=="function"?await m.decode():await new Promise((C,v)=>{m.onload=()=>C(),m.onerror=()=>v(new Error("Image decode failed."))}),m}finally{URL.revokeObjectURL(h)}}function c(w){const h=w.naturalWidth||w.width,m=w.naturalHeight||w.height;if(!h||!m)throw new Error("Image has invalid dimensions.");const C=document.createElement("canvas");C.width=h,C.height=m;const v=C.getContext("2d",{willReadFrequently:!0});if(!v)throw new Error("2D canvas context unavailable.");return v.drawImage(w,0,0,h,m),v.getImageData(0,0,h,m)}function d(w){globalThis.app__=globalThis.app__??{},globalThis.app__.input__=w}function l(){const w=n.map(m=>m.imageData),h=n.map(m=>m.name);d({kind:w.length===1?"image":"imageList",images:w,names:h,createdAtMs:Date.now()})}function f(){const w=n[0];if(!w)return;const h=e.srcCanvasEl;h.width=Math.max(1,w.width),h.height=Math.max(1,w.height);const m=h.getContext("2d",{willReadFrequently:!0});m&&m.putImageData(w.imageData,0,0)}async function p(w){const h=(w??[]).filter(v=>v&&v.type.startsWith("image/"));if(h.length===0)throw new Error("No supported images found.");const m=await Promise.all(h.map(s));n=m.map((v,E)=>{const x=h[E],M=v.naturalWidth||v.width,A=v.naturalHeight||v.height;return{name:x.name,type:x.type,size:x.size,width:M,height:A,imageData:c(v)}}),a.drawImageToSource(m[0]),a.showLoadOk(h.map(v=>v.name)),l(),G({scope:"panel",kind:"info",message:n.length===1?`Input loaded: ${n[0].name}`:`Inputs loaded: ${n.length} images`}),ne({scope:"panel",kind:"info",message:"Mage input loaded",meta:{count:n.length,names:n.slice(0,10).map(v=>v.name),first:n[0]?{name:n[0].name,w:n[0].width,h:n[0].height,type:n[0].type}:null}})}function r(){e.dropZoneEl.addEventListener("dragover",w=>{w.preventDefault(),a.setHover(!0)}),e.dropZoneEl.addEventListener("dragleave",()=>a.setHover(!1)),e.dropZoneEl.addEventListener("drop",w=>{var m;w.preventDefault(),a.setHover(!1);const h=Array.from(((m=w.dataTransfer)==null?void 0:m.files)??[]);h.length!==0&&p(h).catch(C=>{const v=C instanceof Error?C.message:String(C);a.showLoadError(v),G({scope:"panel",kind:"error",message:`Input load failed: ${v}`}),ne({scope:"panel",kind:"error",message:"Input load failed",meta:{error:v}})})}),e.fileInputEl.addEventListener("change",()=>{const w=Array.from(e.fileInputEl.files??[]);w.length!==0&&(p(w).catch(h=>{const m=h instanceof Error?h.message:String(h);a.showLoadError(m),G({scope:"panel",kind:"error",message:`Input load failed: ${m}`}),ne({scope:"panel",kind:"error",message:"Input load failed",meta:{error:m}})}),e.fileInputEl.value="")})}function g(){r()}function u(){}function b(){}return{id:"image",bind:g,mount:u,unmount:b}}function Qe(e,t,i){return Number.isFinite(e)?Math.max(t,Math.min(i,Math.trunc(e))):t}function ti(e,t,i){return Math.round(.2126*e+.7152*t+.0722*i)}function on(e){return{edgesDark:!!(e.edgesDark??!0),edgeThreshold:Qe(e.edgeThreshold??80,0,255),edgeDilate:Qe(e.edgeDilate??2,0,6),maxRegionPx:Qe(e.maxRegionPx??2e5,1e3,1e7)}}function ni(e,t,i){const{data:n,width:o,height:a}=e,s=new Uint8Array(o*a);for(let c=0,d=0;c<s.length;c++,d+=4){const l=n[d+0],f=n[d+1],p=n[d+2];if(n[d+3]===0){s[c]=0;continue}const g=ti(l,f,p),u=t?g<=i:g>=255-i;s[c]=u?1:0}return s}function ii(e,t,i,n){if(n<=0)return e;let o=e;for(let a=0;a<n;a++){const s=new Uint8Array(t*i);for(let c=0;c<i;c++)for(let d=0;d<t;d++){const l=c*t+d;if(o[l]){s[l]=1;continue}let f=0;for(let p=-1;p<=1&&!f;p++){const r=c+p;if(!(r<0||r>=i))for(let g=-1;g<=1;g++){const u=d+g;if(!(u<0||u>=t)&&o[r*t+u]){f=1;break}}}s[l]=f}o=s}return o}function oi(e,t,i,n,o,a){const s=t*n+e;if(i[s])return{ok:!1,message:"Click is on an edge; pick inside a region."};const c=new Uint8Array(n*o),d=new Int32Array(n*o),l=new Int32Array(n*o);let f=0,p=0;d[p]=e,l[p]=t,p++,c[s]=1;let r=1;for(;f<p;){const g=d[f],u=l[f];f++;const b=[[g-1,u],[g+1,u],[g,u-1],[g,u+1]];for(const[w,h]of b){if(w<0||w>=n||h<0||h>=o)continue;const m=h*n+w;if(!c[m]&&!i[m]&&(c[m]=1,d[p]=w,l[p]=h,p++,r++,r>a))return{ok:!1,message:`Region too large (>${a}px). Increase Max region or fix gaps.`}}}return{ok:!0,mask:c}}function ai(e,t,i,n){const o=new Uint8Array(i*n);for(let a=1;a<n-1;a++)for(let s=1;s<i-1;s++){const c=a*i+s;if(!e[c])continue;const d=(a-1)*i+s,l=(a+1)*i+s,f=a*i+(s-1),p=a*i+(s+1);(!e[d]||!e[l]||!e[f]||!e[p]||t[d]||t[l]||t[f]||t[p])&&(o[c]=1)}return o}function si(e,t,i,n){const o=on(n),a=e.width,s=e.height;let c=ni(e,o.edgesDark,o.edgeThreshold);c=ii(c,a,s,o.edgeDilate);const d=oi(t,i,c,a,s,o.maxRegionPx);if(!d.ok)return{ok:!1,message:d.message};const l=ai(d.mask,c,a,s);return{ok:!0,preview:{mask:d.mask,outline:l,w:a,h:s}}}function ri(e,t,i){const n=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),o=i.replace("#",""),a=parseInt(o.slice(0,2),16),s=parseInt(o.slice(2,4),16),c=parseInt(o.slice(4,6),16),d=n.data;for(let l=0,f=0;l<t.mask.length;l++,f+=4)t.mask[l]&&(d[f+0]=a,d[f+1]=s,d[f+2]=c);return n}function Xe(e,t,i){return Number.isFinite(e)?Math.max(t,Math.min(i,Math.trunc(e))):t}function St(e){const t=(e||"").trim();if(!t)return null;const i=t.startsWith("#")?t:`#${t}`;return/^#[0-9a-fA-F]{6}$/.test(i)?i.toLowerCase():null}function li(e){let t="#ff3b30",i=[],n=null;function o(b){e.colorsStatusEl.textContent=b||""}function a(){const b=!!e.edgesDarkEl.checked,w=Xe(parseInt(e.edgeMaskThresholdEl.value,10),0,255),h=Xe(parseInt(e.edgeDilateEl.value,10),0,6),m=Xe(parseInt(e.maxRegionPxEl.value,10),1e3,1e7);return e.edgeMaskThresholdEl.value=String(w),e.edgeDilateEl.value=String(h),e.maxRegionPxEl.value=String(m),on({edgesDark:b,edgeThreshold:w,edgeDilate:h,maxRegionPx:m})}function s(b){const w=St(b);if(w){t=w;for(const h of Array.from(e.paletteEl.querySelectorAll(".paletteItem"))){const m=h.dataset.hex||"";h.classList.toggle("is-selected",m===t)}}}function c(){return t}function d(b){i=b.slice(),e.paletteEl.innerHTML="";for(const w of i){const h=St(w);if(!h)continue;const m=document.createElement("button");m.type="button",m.className="paletteItem",m.style.background=h,m.dataset.hex=h,m.setAttribute("role","listitem"),m.setAttribute("aria-label",`Select ${h}`),m.addEventListener("click",()=>{s(h)}),e.paletteEl.appendChild(m)}s(t)}function l(b){const w=e.colorsCanvasEl;w.width=b.width,w.height=b.height,w.getContext("2d").putImageData(b,0,0)}function f(b,w){l(b);const h=e.colorsCanvasEl.getContext("2d"),{outline:m,w:C,h:v}=w,E=h.getImageData(0,0,C,v),x=E.data;for(let M=0,A=0;M<m.length;M++,A+=4)m[M]&&(x[A+0]=255,x[A+1]=60,x[A+2]=60,x[A+3]=220);h.putImageData(E,0,0)}function p(b){e.btnColorsApplyEl.disabled=!b}function r(b){e.btnColorsCancelEl.disabled=!b}function g(b){n=b}function u(){o("Idle"),p(!1),r(!1),e.colorsCanvasEl.addEventListener("click",b=>{if(!n)return;const w=e.colorsCanvasEl.getBoundingClientRect(),h=Math.floor((b.clientX-w.left)/w.width*e.colorsCanvasEl.width),m=Math.floor((b.clientY-w.top)/w.height*e.colorsCanvasEl.height);n(h,m)})}return{bind:u,setStatus:o,getSettings:a,setSelectedColor:s,getSelectedColor:c,renderPalette:d,drawBase:l,drawPreview:f,setApplyEnabled:p,setCancelEnabled:r,onCanvasClick:g}}let an={type:"none"};function xe(e){an=e}function Pt(){return an}function Pe(e){var d,l,f,p,r,g,u;if(!e){xe({type:"none"});return}const t=(d=e.outputPdf)==null?void 0:d.bytes;if(t&&t.byteLength>0){xe({type:"pdf",bytes:t,mime:"application/pdf",filenameHint:(l=e.outputPdf)==null?void 0:l.filenameHint});return}const i=e.outputImageList;if(i&&typeof i.count=="number"&&i.count>0){xe({type:"imageList",count:i.count,first:i.first?{width:i.first.width,height:i.first.height,data:i.first.data}:void 0});return}const n=(f=e.outputSvg)==null?void 0:f.svg;if(typeof n=="string"&&n.length>0){xe({type:"svg",svg:n});return}const o=(p=e.outputImage)==null?void 0:p.data;if(o){xe({type:"image",image:o});return}const a=(r=e.outputMask)==null?void 0:r.data,s=(g=e.outputMask)==null?void 0:g.width,c=(u=e.outputMask)==null?void 0:u.height;if(a&&typeof s=="number"&&typeof c=="number"){xe({type:"mask",mask:a,width:s,height:c});return}xe({type:"none"})}const ci=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#a2845e","#8e8e93","#1c1c1e","#ffffff","#000000","#4cd964","#5ac8fa","#ff6b6b","#7aa2ff","#f5a623","#50e3c2"];function di(e,t){const i=li(e);let n=null,o=null;function a(g){i.setStatus(g)}function s(g,u,b){const w=new ImageData(u,b),h=w.data;for(let m=0,C=0;m<g.length;m++,C+=4){const E=(g[m]??0)>0?0:255;h[C+0]=E,h[C+1]=E,h[C+2]=E,h[C+3]=255}return w}function c(){const g=Pt();return g.type==="image"?g.image:g.type==="mask"?s(g.mask,g.width,g.height):null}function d(){return Pt().type==="svg"?"Pipeline output is SVG. Colors needs an image or mask output.":"No pipeline output available. Run the Pipeline first."}function l(){const g=c();if(!g){n=null,o=null,i.setApplyEnabled(!1),i.setCancelEnabled(!1),a(d());return}n=g,o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Ready. Pick a color, click inside a region.")}function f(){if(n){i.drawBase(n);return}const g=c();if(!g){a(d());return}n=g,o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Loaded pipeline output. Pick a color, click inside a region.")}function p(){if(!n||!o)return;const g=i.getSelectedColor();n=ri(n,o,g),o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Fill applied. Click another region.")}function r(){n&&(o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Preview canceled."))}return{bind(){i.bind(),i.renderPalette(ci),i.onCanvasClick((g,u)=>{if(!n){a(d());return}const b=i.getSettings(),w=si(n,g,u,b);if(!w.ok){o=null,i.setApplyEnabled(!1),i.setCancelEnabled(!1),a(w.message);return}o=w.preview,i.drawPreview(n,o),i.setApplyEnabled(!0),i.setCancelEnabled(!0),a("Preview shown. Apply fill or cancel.")}),e.btnColorsApplyEl.addEventListener("click",()=>p()),e.btnColorsCancelEl.addEventListener("click",()=>r()),e.btnColorsResetEl.addEventListener("click",()=>l()),e.tabColors.addEventListener("click",()=>{queueMicrotask(()=>f())}),a("Idle"),i.setApplyEnabled(!1),i.setCancelEnabled(!1)}}}const pi="0.3.5";function et(e){return`[BCT][${e}]`}function ui(e){function t(...a){e.traceOn()&&console.log(et("trace"),...a)}function i(...a){console.warn(et("warn"),...a)}function n(...a){console.error(et("error"),...a)}function o(a,s){t(a,s),ne({scope:e.scope,kind:"debug",message:a,meta:s})}return{logTrace:t,logWarn:i,logError:n,traceScope:o}}const{logTrace:J,logWarn:je,logError:ve,traceScope:sn}=ui({scope:"panel",traceOn:()=>!!Ne().traceConsole});let ie=0;function ae(){return ie>0}function de(e,t){if(t){rn(e);return}ie=0,Ge(e,!1)}async function gi(e,t){const i=`${Date.now()}-${Math.random().toString(16).slice(2)}`;J("[state] withBusy: enter",{id:i,busyCount:ie}),rn(e,i);try{J("[state] withBusy: before await fn",{id:i,busyCount:ie});const n=await t();return J("[state] withBusy: after await fn (resolved)",{id:i,busyCount:ie}),n}catch(n){throw ve("[state] withBusy: fn threw",{id:i,busyCount:ie,msg:String((n==null?void 0:n.message)??n),stack:String((n==null?void 0:n.stack)??"")}),n}finally{J("[state] withBusy: finally before endBusy",{id:i,busyCount:ie}),fi(e,i),J("[state] withBusy: finally after endBusy",{id:i,busyCount:ie})}}function rn(e,t){ie++,J("[state] beginBusy",{id:t,busyCount:ie}),ie===1&&Ge(e,!0)}function fi(e,t){if(ie--,J("[state] endBusy: dec",{id:t,busyCount:ie}),ie<=0){ie=0,J("[state] endBusy: applying busy=false",{id:t,busyCount:ie}),Ge(e,!1);return}ie===0&&(J("[state] endBusy: applying busy=false (redundant branch)",{id:t,busyCount:ie}),Ge(e,!1))}function Ge(e,t){e.rootEl.classList.toggle("is-busy",t),e.cfgShowDevToolsEl.disabled=!1,e.fileInputEl.disabled=t,e.cfgTraceConsoleEl.disabled=t,e.cfgActionLogMaxEl.disabled=t,e.cfgDebugTraceMaxEl.disabled=t,e.cfgFailureLogsPerRunEl.disabled=t,e.btnCfgResetDefaults.disabled=t,e.logsCbDebugEl.disabled=t,e.cfgUseOpenCvEl.disabled=t,e.logsLimitEl.disabled=t,e.btnLogsRefresh.disabled=t,e.logsTrimKeepEl.disabled=t,e.btnLogsTrim.disabled=t,e.btnLogsExport.disabled=t,e.btnLogsClear.disabled=t,e.debugLimitEl.disabled=t,e.btnDebugRefresh.disabled=t,e.btnDebugExport.disabled=t,e.btnDebugClear.disabled=t,e.btnColorsApplyEl.disabled=t,e.btnColorsCancelEl.disabled=t,e.btnColorsResetEl.disabled=t,e.edgesDarkEl.disabled=t,e.edgeMaskThresholdEl.disabled=t,e.edgeDilateEl.disabled=t,e.maxRegionPxEl.disabled=t;for(const i of Array.from(e.paletteEl.querySelectorAll("button")))i.disabled=t;e.colorsCanvasEl.style.pointerEvents=t?"none":"auto"}const Ct={native:{available:!0},opencv:{available:!1,reason:"OpenCV not loaded"}};function hi(e){Ct[e]={available:!0}}function mi(e,t){Ct[e]={available:!1,reason:t}}function Ce(){return Ct.opencv.available===!0}async function yi(e){const t=new URL(e.opencvJsRel,document.baseURI).toString(),i=new URL(e.opencvWasmRel,document.baseURI).toString(),n=globalThis;n.Module=n.Module||{},n.Module.locateFile=o=>o.endsWith(".wasm")?i:o,n.Module.print=()=>{},n.Module.printErr=()=>{},n.cv||await bi(t),await wi(e.timeoutMs)}function bi(e){return new Promise((t,i)=>{const n=document.createElement("script");n.src=e,n.async=!0;const o=15e3,a=window.setTimeout(()=>{s(),i(new Error(`OpenCV script load timeout after ${o}ms: ${e}`))},o);function s(){window.clearTimeout(a),n.onload=null,n.onerror=null}n.onload=()=>{s(),t()},n.onerror=()=>{s(),i(new Error(`Failed to load OpenCV script: ${e}`))},document.head.appendChild(n)})}async function wi(e){var n;const t=Date.now(),i=globalThis;for(;Date.now()-t<e;){try{if(i.cv&&typeof i.cv.Mat=="function"){const o=new i.cv.Mat;(n=o.delete)==null||n.call(o);return}}catch{}await new Promise(o=>setTimeout(o,75))}throw new Error(`OpenCV initialization timeout after ${e}ms`)}async function vi(){try{await yi({opencvJsRel:"../assets/opencv/opencv.js",opencvWasmRel:"../assets/opencv/opencv.wasm",timeoutMs:2e4}),hi("opencv")}catch(e){throw mi("opencv",e!=null&&e.message?String(e.message):String(e)),e}}function te(e,t,i,n,o,a,s){return{id:e,title:t,implementedEngines:i,defaultEnginePolicy:n,params:o,children:a,description:s}}function Ci(e){const t=new Map,i=new Map;function n(o,a){if(t.has(o.id))throw new Error(`[tuning] Duplicate component id: ${o.id}`);t.set(o.id,o),i.set(o.id,a);for(const s of o.children??[])n(s,o.id)}return n(e,null),{root:e,byId:t,parentById:i}}function ln(){const e=te("app","BeeMage",["native","opencv"],"native",{},[te("edge","Edge",["native","opencv"],"auto",{},[te("edge.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),te("edge.threshold","Threshold",["native","opencv"],"auto",{manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128}},void 0,"Convert image into a binary mask before edge extraction."),te("edge.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:3},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Clean the mask before extracting edges."),te("edge.extract","Edge extract",["native","opencv"],"auto",{},void 0,"Extract a 1px outline from the cleaned mask.")],"Fixed-order edge pipeline (image -> mask -> edges). Presets configure each step."),te("svg","SVG",["native","opencv"],"auto",{},[te("svg.create","Create SVG",["native","opencv"],"auto",{scale:{kind:"number",label:"Scale",min:1,max:10,step:1,default:1},transparentBg:{kind:"number",label:"Transparent bg (0/1)",min:0,max:1,step:1,default:1},color:{kind:"text",label:"Color",default:"#3bca1e"}},void 0,"Convert the edge mask into an SVG.")],"SVG generation parameters."),te("segmentation","Segmentation",["native","opencv"],"auto",{},[te("segmentation.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),te("segmentation.denoise","Denoise",["native","opencv"],"auto",{denoiseAlgo:{kind:"number",label:"Denoise algo",min:0,max:2,step:1,default:1},blurK:{kind:"number",label:"Blur kernel",min:1,max:21,step:2,default:3},bilateralSigma:{kind:"number",label:"Bilateral sigma",min:1,max:150,step:1,default:35}},void 0,"Reduce noise before thresholding."),te("segmentation.color","Color / Gray",["native","opencv"],"auto",{colorMode:{kind:"number",label:"Color mode",min:0,max:3,step:1,default:1},hsvChannel:{kind:"number",label:"HSV channel",min:0,max:2,step:1,default:2}},void 0,"Select color space / channel features for thresholding."),te("segmentation.threshold","Threshold",["native","opencv"],"auto",{thresholdAlgo:{kind:"number",label:"Threshold algo",min:0,max:3,step:1,default:1},manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128},adaptBlock:{kind:"number",label:"Adaptive block",min:3,max:101,step:2,default:31},adaptC:{kind:"number",label:"Adaptive C",min:-50,max:50,step:1,default:3}},void 0,"Convert features into a binary mask."),te("segmentation.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:5},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Remove specks, fill holes, and stabilize regions.")],"Fixed-order segmentation pipeline. Presets configure each step."),te("image","iMage",["native","opencv"],"auto",{},[te("mage.process","Process",["native"],"auto",{imageScale:{kind:"number",label:"Processing scale",min:25,max:100,step:5,default:100},edgeThreshold:{kind:"number",label:"Edge threshold",min:1,max:255,step:1,default:70},invertOutput:{kind:"boolean",label:"White background",default:!0}}),te("mage.clean","Clean & Smooth",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:500,step:1,default:12},cleanRadius:{kind:"number",label:"Repair strength",min:1,max:3,step:1,default:1},cleanBinaryThreshold:{kind:"number",label:"Binary threshold",min:1,max:254,step:1,default:128}},[te("mage.clean.threshold","Threshold",["native"],"auto",{}),te("mage.clean.removeSmallComponents","Remove small components",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:5e3,step:1,default:12}},void 0,"Remove connected components smaller than the minimum area."),te("mage.clean.repair","Repair gaps",["native"],"auto",{}),te("mage.clean.smooth","Smooth mask",["native"],"auto",{}),te("mage.clean.quality","Quality metrics",["native"],"auto",{})]),te("mage.vectorize","Vectorize (SVG)",["native"],"native",{pathSmoothIters:{kind:"number",label:"Path smoothing",min:0,max:4,step:1,default:2}})]),te("colors","Colors",["native"],"auto",{},[te("colors.fill","Region fill",["native"],"auto",{edgesDark:{kind:"boolean",label:"Edges are dark",default:!0},edgeMaskThreshold:{kind:"number",label:"Edge threshold",min:0,max:255,step:1,default:80},edgeDilate:{kind:"number",label:"Gap close (px)",min:0,max:6,step:1,default:2},maxRegionPx:{kind:"number",label:"Max region (px)",min:1e3,step:1e3,default:2e5}})]),te("pipeline","Pipeline (UI)",["native","opencv"],"auto",{mode:{kind:"text",label:"Pipeline",default:"segmentation"},recipe:{kind:"text",label:"Recipe",default:"default"}},void 0,"UI state for the Pipeline tab (selected pipeline + recipe).")]);return Ci(e)}function Ei(e){return e.default}function xi(e,t){const i={};for(const[n,o]of Object.entries(e))i[n]=Ei(o);for(const[n,o]of Object.entries(t??{}))i[n]=o;return i}function ki(e,t,i){var o;let n=e;for(;n;){const a=t.byId.get(n);if(!a)throw new Error(`[tuning] Unknown component: ${n}`);const c=((o=i[n])==null?void 0:o.enginePolicy)??a.defaultEnginePolicy;if(c!=="inherit")return c;n=t.parentById.get(n)??null}return"native"}function Ii(e,t,i){const n=i.opencvReady&&e.includes("opencv");return e.includes("native")||e.length,t==="native"?{engine:"native"}:t==="opencv"?n?{engine:"opencv"}:{engine:"native",fallbackReason:i.opencvReady?"Policy=opencv, but component has no OpenCV implementation.":"Policy=opencv, but OpenCV is not available at runtime."}:t==="auto"?n?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}function cn(e,t,i,n){var l;const o=t.byId.get(e);if(!o)throw new Error(`[tuning] Unknown component: ${e}`);const a=ki(e,t,i),{engine:s,fallbackReason:c}=Ii(o.implementedEngines,a,n),d=xi(o.params,(l=i[e])==null?void 0:l.params);return{id:e,policy:a,engine:s,fallbackReason:c,params:d}}const pt="beemage.tuning.components.v1";async function Te(){const e=await he([pt]).catch(()=>({})),t=e==null?void 0:e[pt];return!t||typeof t!="object"?{}:t}async function dn(e){await me({[pt]:e}).catch(()=>null)}async function tt(e,t){const i=await Te(),n=i[e]??{};i[e]={enginePolicy:t.enginePolicy??n.enginePolicy,params:{...n.params??{},...t.params??{}}},await dn(i)}async function $t(e){const t=await Te();delete t[e],await dn(t)}function Si(){return{opencvReady:Ce()}}function Pi(e){return Array.isArray(e.children)&&e.children.length>0}function pn(e){const{id:t,registry:i,stored:n,runtime:o}=e,a=i.byId.get(t);if(!a)throw new Error(`[tuning] Unknown component: ${t}`);const s=cn(t,i,n,o),c=n[t],d=c==null?void 0:c.enginePolicy,l=c==null?void 0:c.params,f=a.implementedEngines.includes("opencv"),p=!!o.opencvReady,r=[];for(const g of a.children??[])r.push(pn({id:g.id,registry:i,stored:n,runtime:o}));return{id:a.id,title:a.title,description:a.description,isGroup:Pi(a),implementedEngines:a.implementedEngines,storedPolicy:d,storedParams:l,effectivePolicy:s.policy,effectiveEngine:s.engine,fallbackReason:s.fallbackReason,paramsSchema:a.params,effectiveParams:s.params,canImplementOpenCv:f,runtimeOpenCvReady:p,children:r}}function un(e={}){const t=e.registry??ln(),i=e.getRuntimeAvailability??Si;async function n(d="app"){const l=await Te(),f=i();if(!t.byId.get(d))throw new Error(`[tuning] Unknown scope: ${d}`);const r=pn({id:d,registry:t,stored:l,runtime:f});return{scopeId:d,runtime:f,stored:l,root:r}}async function o(d,l){await tt(d,{enginePolicy:l})}async function a(d,l,f){await tt(d,{params:{[l]:f}})}async function s(d){await $t(d)}async function c(d,l){const p=(await Te())[d];if(!(p!=null&&p.params))return;const r={...p.params??{}};delete r[l];const g=typeof p.enginePolicy=="string",u=Object.keys(r).length>0;if(!g&&!u){await $t(d);return}await tt(d,{enginePolicy:p.enginePolicy,params:r})}return{getRegistry:()=>t,loadTree:n,setEnginePolicy:o,setParam:a,resetNode:s,resetParam:c}}function X(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function Lt(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function $i(e){return e.fallbackReason?`${e.effectiveEngine} (fallback)`:e.effectiveEngine}function Li(e){const t=[{value:"native",label:"Native"},{value:"auto",label:"Auto"},...e.canImplementOpenCv?[{value:"opencv",label:"OpenCV"}]:[]];return e.isRoot?t:[{value:"inherit",label:"Inherit"},...t]}function Ai(e){return!1}function Ti(e,t,i){var o;const n=(o=e.storedParams)==null?void 0:o[t];return typeof n<"u"&&n!==i}function Ri(e){var p;const{node:t,compId:i,key:n,schema:o,value:a,handlers:s}=e,c=X("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),d=X("label",{class:"fieldInline"}),l=X("span",void 0,o.label);d.appendChild(l);let f;if(o.kind==="number"?(f=X("input"),f.type="number",typeof o.min=="number"&&(f.min=String(o.min)),typeof o.max=="number"&&(f.max=String(o.max)),typeof o.step=="number"&&(f.step=String(o.step)),f.value=String(a??o.default),f.addEventListener("change",()=>{const r=Number(f.value);s.onSetParam(i,n,Number.isFinite(r)?r:o.default)})):o.kind==="boolean"?(f=X("input"),f.type="checkbox",f.checked=!!a,f.addEventListener("change",()=>{s.onSetParam(i,n,!!f.checked)})):(f=X("input"),f.type="text",f.value=String(a??o.default),f.addEventListener("change",()=>{s.onSetParam(i,n,String(f.value??o.default))})),d.appendChild(f),c.appendChild(d),s.onResetParam&&typeof((p=t.storedParams)==null?void 0:p[n])<"u"){const r=X("button",{type:"button"},"Reset");r.addEventListener("click",g=>{var u;g.preventDefault(),(u=s.onResetParam)==null||u.call(s,i,n)}),c.appendChild(r)}return Ti(t,n,a)&&c.appendChild(X("span",{class:"muted",style:"font-size:12px;"},"override")),c}function gn(e){const{node:t,depth:i,isRoot:n,handlers:o,treeScopeId:a}=e,s=X("div",{style:`margin-left:${Math.min(i*14,56)}px; margin-top:10px;`}),c=X("div",{style:"border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:10px; background:rgba(0,0,0,0.12);"}),d=X("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),l=X("div");l.appendChild(X("div",{style:"font-weight:700;"},t.title)),t.description&&l.appendChild(X("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},t.description)),t.isGroup&&l.appendChild(X("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},"Group (policy affects children)")),d.appendChild(l);const f=X("div",{class:"row",style:"align-items:center; gap:10px;"});f.appendChild(X("span",{class:"qBadge"},$i(t)));const p=X("select");p.style.background="rgba(255,255,255,0.05)",p.style.border="1px solid rgba(255,255,255,0.08)",p.style.color="rgba(255,255,255,0.92)",p.style.borderRadius="10px",p.style.padding="6px 8px";const r=Li({isRoot:n,canImplementOpenCv:t.canImplementOpenCv});for(const C of r){const v=X("option");v.value=C.value,v.textContent=C.label,p.appendChild(v)}const g=new Set(r.map(C=>C.value)),u=t.effectivePolicy;g.has(u)?p.value=u:p.value=n?"native":"inherit",p.addEventListener("change",()=>{o.onSetPolicy(t.id,p.value)}),f.appendChild(p);const b=typeof t.storedPolicy<"u"||t.storedParams&&Object.keys(t.storedParams).length>0;if(o.onResetNode&&b){const C=X("button",{type:"button"},"Reset node");C.addEventListener("click",v=>{var E;v.preventDefault(),(E=o.onResetNode)==null||E.call(o,t.id)}),f.appendChild(C)}d.appendChild(f),c.appendChild(d),t.fallbackReason?c.appendChild(X("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},t.fallbackReason)):t.effectivePolicy==="opencv"&&!t.runtimeOpenCvReady&&c.appendChild(X("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},"OpenCV policy selected, but OpenCV is not available at runtime. It will fall back to native."));const w=Object.keys(t.paramsSchema??{}),h=w.length>0,m=t.children.length>0;if(h||m){const C=X("details",{style:"margin-top:10px;"});C.open=Ai();const v=X("summary",{style:"cursor:pointer; user-select:none;"},"Details");if(C.appendChild(v),h){const E=X("div",{style:"margin-top:10px;"});E.appendChild(X("div",{class:"muted",style:"font-weight:600; margin-bottom:6px;"},"Parameters"));for(const x of w){const M=t.paramsSchema[x],A=t.effectiveParams[x];E.appendChild(Ri({node:t,compId:t.id,key:x,schema:M,value:A,handlers:o}))}C.appendChild(E)}if(m){const E=X("div",{style:"margin-top:10px;"});for(const x of t.children)E.appendChild(gn({node:x,depth:i+1,isRoot:!1,handlers:o,treeScopeId:a}));C.appendChild(E)}c.appendChild(C)}return s.appendChild(c),s}function fn(e,t){let i=!1;function n(a){if(i)return;Lt(e);const s=a.scopeId==="app",c=X("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"});c.appendChild(X("div",{style:"font-weight:700;"},"Tuning")),c.appendChild(X("div",{class:"muted",style:"font-size:12px;"},`OpenCV runtime: ${a.runtime.opencvReady?"ready":"not available"}`)),e.appendChild(c),e.appendChild(gn({node:a.root,depth:0,isRoot:s,handlers:t,treeScopeId:a.scopeId}))}function o(){i=!0,Lt(e)}return{render:n,dispose:o}}function Di(){let e=!1,t={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},i=!1,n="",o="";function a(l){e=l}function s(l){t={...t,...l}}function c(l){i=l}function d(l){typeof l.general=="string"&&(n=l.general),typeof l.dev=="string"&&(o=l.dev)}return{get showDevTools(){return e},get dev(){return t},get debugEnabled(){return i},get generalStatus(){return n},get devStatus(){return o},setShowDevTools:a,setDev:s,setDebugEnabled:c,setStatus:d}}function Mi(e){function t(l){e.settingsGeneralStatusEl.textContent=l||""}function i(l){e.cfgStatusEl.textContent=l||""}function n(l){e.cfgShowDevToolsEl.checked=l}function o(l){e.tabLogs.hidden=!l,e.devConfigDetailsEl.classList.toggle("is-hidden",!l),l||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function a(l){e.cfgTraceConsoleEl.checked=!!l.traceConsole,e.cfgActionLogMaxEl.value=String(l.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(l.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(l.failureLogsPerRun??50)}function s(l){e.logsCbDebugEl.checked=l}function c(l,f){e.settingsVersionEl.textContent=l||"—",e.settingsGitHubLinkEl.href=f||"#",e.settingsGitHubLinkEl.hidden=!f}function d(l){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=l,e.cfgActionLogMaxEl.disabled=l,e.cfgDebugTraceMaxEl.disabled=l,e.cfgFailureLogsPerRunEl.disabled=l,e.btnCfgResetDefaults.disabled=l,e.logsCbDebugEl.disabled=l,e.cfgUseOpenCvEl.disabled=l}return{setGeneralStatus:t,setDevStatus:i,setShowDevToolsChecked:n,setDevToolsVisible:o,setDevConfig:a,setDebugEnabledChecked:s,setAbout:c,setBusy:d}}const nt="template.settings.showDevTools",it="beemage.settings.engine.useOpenCv";function Oi(){return pi}function ot(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??se.actionLogMax),debugTraceMax:Number(e.debugTraceMax??se.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??se.failureLogsPerRun)}}function Bi(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:fe(e.cfgActionLogMaxEl.value,100,5e4,se.actionLogMax),debugTraceMax:fe(e.cfgDebugTraceMaxEl.value,100,5e4,se.debugTraceMax),failureLogsPerRun:fe(e.cfgFailureLogsPerRunEl.value,0,5e4,se.failureLogsPerRun)}}async function At(e){const t=nn;return typeof t.setEnabled=="function"?(await t.setEnabled(e),{ok:!0}):typeof t.enable=="function"&&typeof t.disable=="function"?(await(e?t.enable():t.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function Ui(e,t){const i=Di(),n=Mi(e),o=un({getRuntimeAvailability:()=>({opencvReady:e.cfgUseOpenCvEl.checked&&Ce()})}),a=fn(e.tuningMountEl,{onSetPolicy:async(P,y)=>{await o.setEnginePolicy(P,y),await m("policy change")},onSetParam:async(P,y,z)=>{await o.setParam(P,y,z),await m("param change")},onResetNode:async P=>{await o.resetNode(P),await m("reset node")},onResetParam:async(P,y)=>{await o.resetParam(P,y),await m("reset param")}});function s(P){e.settingsEngineBoxEl.classList.toggle("is-hidden",!1)}async function c(){const P=await he([it]).catch(()=>({}));return(P==null?void 0:P[it])===!0}async function d(P){await me({[it]:!!P}).catch(()=>null)}function l(P){var y;e.cfgUseOpenCvEl.checked=P,(y=e.cfgUseOpenCvEl.closest(".switch"))==null||y.classList.toggle("is-disabled",e.cfgUseOpenCvEl.disabled)}function f(P){e.cfgOpenCvSpinner.classList.toggle("is-hidden",!P),e.cfgOpenCvSpinner.setAttribute("aria-hidden",P?"false":"true")}function p(P){e.cfgOpenCvStatus.textContent=P||""}function r(P){e.cfgOpenCvReport.textContent=P||""}async function g(){if(ae())return;if(!!!e.cfgUseOpenCvEl.checked){await d(!1),f(!1),p(Ce()?"OpenCV loaded (native mode)":"Native mode"),r("Native mode. OpenCV is optional and demo-only."),await m("opencv mode disabled");return}f(!0),p("Loading OpenCV…"),r("Loading OpenCV…");try{if(await gi(e,async()=>{await vi()}),!Ce())throw new Error("OpenCV load returned but runtime is not injected.");await d(!0),p("OpenCV mode enabled"),r("OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV."),await m("opencv mode enabled")}catch(y){const z=String((y==null?void 0:y.message)??y);await d(!1),l(!1),p("OpenCV load failed"),r(`ERROR

${z}`),ve("[settings] OpenCV toggle failed",{msg:z})}finally{f(!1)}}async function u(){const P=await he([nt]).catch(()=>({}));return(P==null?void 0:P[nt])===!0}async function b(P){await me({[nt]:!!P}).catch(()=>null)}function w(P){i.setShowDevTools(P),n.setShowDevToolsChecked(P),n.setDevToolsVisible(P)}async function h(){const P=await u();w(P),J("Settings: boot applyDevToolsVisibility",{showDevTools:P})}async function m(P){try{const y=await o.loadTree("app");a.render(y),J("[settings] tuning rendered",{reason:P,opencvInjected:Ce(),opencvMode:!!e.cfgUseOpenCvEl.checked})}catch(y){ve("[settings] tuning render failed",{reason:P,msg:String((y==null?void 0:y.message)??y)}),e.tuningMountEl.textContent="Tuning UI failed to load (see console)."}}async function C(){var R;n.setBusy(ae());const P=await u();w(P),await lt().catch(()=>null);const y=Ne();i.setDev(ot(y)),n.setDevConfig(i.dev);const z=nn;let N=!1;try{typeof z.isEnabled=="function"?N=!!await z.isEnabled():N=!!z.enabled}catch(D){je("Settings: failed to read debug enabled state",{error:D instanceof Error?D.message:String(D)})}i.setDebugEnabled(N),n.setDebugEnabledChecked(N),n.setAbout(Oi(),((R=e.settingsGitHubLinkEl)==null?void 0:R.href)||"#"),s();{const D=await c();l(D),f(!1);const k=Ce();D?(p(k?"OpenCV mode enabled":"OpenCV mode (not loaded)"),r(k?"OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV.":"OpenCV mode is enabled, but OpenCV is not loaded yet. Toggle OFF then ON to load OpenCV.")):(p(k?"OpenCV loaded (native mode)":"Native mode"),r("Native mode. OpenCV is optional and demo-only."))}n.setGeneralStatus(""),n.setDevStatus(""),await m("loadAll"),J("Settings: loaded",{showDevTools:P,debugTraceEnabled:N,dev:i.dev,opencvInjected:Ce()})}async function v(){const P=!!e.cfgShowDevToolsEl.checked;w(P),await b(P),G({kind:"run",scope:"settings",message:P?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:P}}),J("Settings: ui toggle showDevTools",{showDevTools:P}),n.setGeneralStatus(P?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>n.setGeneralStatus(""),1200)}async function E(){const P=Bi(e);n.setDevStatus("Saving…");try{await Zt(P)}catch(y){ve("Settings: failed to save dev config",{error:y instanceof Error?y.message:String(y),next:P}),n.setDevStatus("Save failed."),setTimeout(()=>n.setDevStatus(""),1200);return}i.setDev(ot(P)),n.setDevConfig(i.dev),G({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:P}),J("Settings: devConfig updated",P),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}async function x(){n.setDevStatus("Resetting…");try{await jn(),await lt().catch(()=>null);const y=Ne();i.setDev(ot(y)),n.setDevConfig(i.dev)}catch(y){ve("Settings: failed to reset dev config defaults",{error:y instanceof Error?y.message:String(y)}),n.setDevStatus("Reset failed."),setTimeout(()=>n.setDevStatus(""),1200);return}const P=await At(!1);P.ok?(i.setDebugEnabled(!1),n.setDebugEnabledChecked(!1)):(je("Settings: failed to reset debug enabled state",{error:P.error||"unknown error"}),G({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:P.error||"unknown error"})),G({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...se,debugEnabled:!1}}),J("Settings: reset defaults",{...se,debugEnabled:!1}),n.setDevStatus("Reset."),setTimeout(()=>n.setDevStatus(""),1200)}async function M(){const P=!!e.logsCbDebugEl.checked;n.setDevStatus("Saving…");const y=await At(P);if(!y.ok){e.logsCbDebugEl.checked=!P,n.setDevStatus(`Save failed: ${y.error||"unknown error"}`),ve("Settings: failed to change debug enabled state",{error:y.error||"unknown error",enabled:P}),G({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:y.error||"unknown error",meta:{enabled:P}});return}i.setDebugEnabled(P),G({kind:"run",scope:"settings",message:P?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:P}}),J("Settings: debug enabled changed",{enabled:P}),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}const A=t.on(()=>{});function U(){e.cfgShowDevToolsEl.addEventListener("change",()=>{v()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{ae()||E()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{ae()||E()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{ae()||E()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{ae()||E()}),e.btnCfgResetDefaults.addEventListener("click",()=>{ae()||x()}),e.logsCbDebugEl.addEventListener("change",()=>{ae()||M()}),e.cfgUseOpenCvEl.addEventListener("change",()=>{g()}),h().catch(P=>{je("Settings: initDevToolsVisibility failed",{error:P instanceof Error?P.message:String(P)})})}return{id:"settings",refresh(){C().catch(P=>{ve("Settings: refresh failed",{error:P instanceof Error?P.message:String(P)})})},mount(){C().catch(P=>{ve("Settings: mount failed",{error:P instanceof Error?P.message:String(P)})})},unmount(){},bind:U,dispose(){A()}}}function zi(){let e=[],t=0;function i(n){e=n.items,t=n.total}return{get items(){return e},get total(){return t},set:i}}function ji(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function Tt(e,t){const i=[];i.push(`Total entries: ${t.total}`),i.push("");for(const n of t.items){const o=typeof n.ok=="boolean"?n.ok?"ok":"fail":"",a=[];typeof n.status=="number"&&a.push(`status=${n.status}`),o&&a.push(o);const s=[n.scope,n.kind].filter(Boolean).join("/");i.push(`[${ji(n.ts)}] ${s}${a.length?` (${a.join(", ")})`:""}`),i.push(`  ${n.message}`),n.error&&i.push(`  error: ${n.error}`),i.push("")}e.textContent=i.join(`
`),e.scrollTop=0}function Vi(e){function t(s){e.logsStatusEl.textContent=s}function i(s){e.debugStatusEl.textContent=s}function n(s){e.logsCbDebugEl.checked=s}function o(s){Tt(e.logsOutEl,{total:s.total,items:s.items.map(c=>({ts:c.ts,message:c.message,scope:c.scope,kind:c.kind,ok:c.ok,status:c.status,error:c.error,meta:c.meta}))})}function a(s){Tt(e.debugOutEl,{total:s.total,items:s.items.map(c=>({ts:c.ts,message:c.message,scope:c.scope,kind:c.kind,ok:c.ok,status:c.status,error:c.error,meta:c.meta}))})}return{setAuditStatus:t,setDebugStatus:i,setDebugChecked:n,renderAudit:o,renderDebug:a}}const Rt="beemage";function Ni(e,t){const i=zi(),n=Vi(e);async function o(){n.setAuditStatus("Loading…"),de(e,!0);try{const u=fe(e.logsLimitEl.value,10,5e3,200),b=await Kn({limit:u,reverse:!0});i.set(b),n.renderAudit({items:i.items,total:i.total}),n.setAuditStatus(`Showing ${i.items.length} (newest first)`)}catch(u){n.setAuditStatus(`Failed: ${(u==null?void 0:u.message)||String(u)}`)}finally{de(e,!1)}}async function a(){n.setDebugStatus("Loading…"),de(e,!0);try{const u=fe(e.debugLimitEl.value,10,5e3,200),b=await en({limit:u,reverse:!0});n.renderDebug(b),n.setDebugStatus(`Showing ${b.items.length} (newest first)`)}catch(u){n.setDebugStatus(`Failed: ${(u==null?void 0:u.message)||String(u)}`)}finally{de(e,!1)}}async function s(){const u=await vt();n.setDebugChecked(u)}async function c(u){if(await Qt(u),n.setDebugChecked(u),!u){n.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}n.setDebugStatus("Debug ON."),await a()}async function d(){const u=fe(e.logsTrimKeepEl.value,0,5e4,2e3);n.setAuditStatus("Trimming…"),de(e,!0);try{const b=await qn({keepLast:u});await o(),n.setAuditStatus(`Trimmed. Remaining: ${b.total}`)}catch(b){n.setAuditStatus(`Trim failed: ${(b==null?void 0:b.message)||String(b)}`)}finally{de(e,!1)}}async function l(){n.setAuditStatus("Clearing…"),de(e,!0);try{await Jn(),await o(),n.setAuditStatus("Cleared.")}catch(u){n.setAuditStatus(`Clear failed: ${(u==null?void 0:u.message)||String(u)}`)}finally{de(e,!1)}}async function f(){n.setAuditStatus("Exporting…");try{const u=await Zn({pretty:!0}),b=new Blob([u],{type:"application/json"}),w=URL.createObjectURL(b),h=document.createElement("a");h.href=w,h.download=`${Rt}-audit-${Date.now()}.json`,h.click(),setTimeout(()=>URL.revokeObjectURL(w),1e3),n.setAuditStatus("Exported.")}catch(u){n.setAuditStatus(`Export failed: ${(u==null?void 0:u.message)||String(u)}`)}}async function p(){n.setDebugStatus("Clearing…"),de(e,!0);try{await Xt(),await a(),n.setDebugStatus("Cleared.")}catch(u){n.setDebugStatus(`Clear failed: ${(u==null?void 0:u.message)||String(u)}`)}finally{de(e,!1)}}async function r(){n.setDebugStatus("Exporting…");try{const u=await tn({pretty:!0}),b=new Blob([u],{type:"application/json"}),w=URL.createObjectURL(b),h=document.createElement("a");h.href=w,h.download=`${Rt}-debug-${Date.now()}.json`,h.click(),setTimeout(()=>URL.revokeObjectURL(w),1e3),n.setDebugStatus("Exported.")}catch(u){n.setDebugStatus(`Export failed: ${(u==null?void 0:u.message)||String(u)}`)}}function g(){e.btnLogsRefresh.addEventListener("click",()=>{ae()||o()}),e.btnLogsTrim.addEventListener("click",()=>{ae()||d()}),e.btnLogsClear.addEventListener("click",()=>{ae()||l()}),e.btnLogsExport.addEventListener("click",()=>{ae()||f()}),e.logsCbDebugEl.addEventListener("change",()=>{ae()||c(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{ae()||a()}),e.btnDebugClear.addEventListener("click",()=>{ae()||p()}),e.btnDebugExport.addEventListener("click",()=>{ae()||r()})}return{id:"logs",bind:g,mount(){s(),o(),a()},unmount(){},dispose(){}}}function Fi(e,t){if(e.id===t)return e;const i=[...e.children??[]];for(;i.length>0;){const n=i.shift();if(n.id===t)return n;for(const o of n.children??[])i.push(o)}throw new Error(`[tuning] scopeRootId not found in VM tree: ${t}`)}function _i(e,t){if(e.id===t)return e;const i=[...e.children??[]];for(;i.length>0;){const n=i.shift();if(n.id===t)return n;for(const o of n.children??[])i.push(o)}return null}function Hi(e){const t=un({getRuntimeAvailability:e.getRuntimeAvailability}),i=[];let n=!1;async function o(){return await t.loadTree("app")}async function a(){if(n)return;const h=await o();for(const m of i){if(m.scopeRootId==="app"){m.view.render(h);continue}const C=Fi(h.root,m.scopeRootId);m.view.render({...h,scopeId:m.scopeRootId,root:C})}}async function s(h,m){await t.setEnginePolicy(h,m),e.actionLogAppend(`[tuning] policy ${h} = ${m}`),e.debugTraceAppend(`[tuning] setPolicy id=${h} policy=${m}`),await a()}async function c(h,m,C){await t.setParam(h,m,C),e.actionLogAppend(`[tuning] param ${h}.${m} = ${String(C)}`),e.debugTraceAppend(`[tuning] setParam id=${h} key=${m} value=${String(C)}`),await a()}async function d(h){await t.resetNode(h),e.actionLogAppend(`[tuning] reset node ${h}`),e.debugTraceAppend(`[tuning] resetNode id=${h}`),await a()}async function l(h,m){await t.resetParam(h,m),e.actionLogAppend(`[tuning] reset param ${h}.${m}`),e.debugTraceAppend(`[tuning] resetParam id=${h} key=${m}`),await a()}async function f(h){var m,C;if(!n){if(h.policies)for(const v of h.policies)await t.setEnginePolicy(v.id,v.policy);if(h.params)for(const v of h.params)await t.setParam(v.id,v.key,v.value);e.actionLogAppend(`[tuning] preset ${h.id} (${h.title})`),e.debugTraceAppend(`[tuning] applyPreset id=${h.id} title=${h.title} policies=${((m=h.policies)==null?void 0:m.length)??0} params=${((C=h.params)==null?void 0:C.length)??0}`),await a()}}async function p(h){const m=await o(),C=_i(m.root,h);if(!C)throw new Error(`[tuning] getEffectiveParams: unknown component id ${h}`);return{...C.effectiveParams??{}}}async function r(h,m,C){await t.setParam(h,m,C),e.actionLogAppend(`[tuning] param ${h}.${m} = ${String(C)}`),e.debugTraceAppend(`[tuning] setParamValue id=${h} key=${m} value=${String(C)}`),await a()}function g(h){if(n)return;const{mountEl:m,scopeRootId:C}=h;if(i.some(E=>E.mountEl===m))return;const v=fn(m,{onSetPolicy:s,onSetParam:c,onResetNode:d,onResetParam:l});i.push({mountEl:m,scopeRootId:C,view:v}),a()}function u(h){const m=i.findIndex(C=>C.mountEl===h);m<0||(i[m].view.dispose(),i.splice(m,1))}async function b(){await a()}function w(){n=!0;for(const h of i)h.view.dispose();i.length=0}return{mount:g,unmount:u,refresh:b,applyPreset:f,getEffectiveParams:p,setParamValue:r,dispose:w}}function re(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function Gi(e){const t=[{kind:"input",type:e.io.input}],i=[{kind:"output",type:e.io.output}];return{id:e.id,title:e.title,group:e.group,inputs:t,outputs:i}}function Wi(e){const t=String(e||"").toLowerCase();return t==="image"?"opPort--image":t==="mask"?"opPort--mask":t==="svg"?"opPort--svg":t==="imagelist"?"opPort--imageList":t==="pdf"?"opPort--pdf":"opPort--unknown"}function Ki(e){const{kind:t,type:i}=e,n="http://www.w3.org/2000/svg",o=document.createElementNS(n,"svg");o.setAttribute("viewBox","0 0 48 20"),o.setAttribute("width","48"),o.setAttribute("height","20"),o.setAttribute("aria-hidden","true"),o.classList.add("opPort__glyph");const a=String(i||"").toLowerCase(),s=t==="output",c=document.createElementNS(n,"rect");c.setAttribute("x","1"),c.setAttribute("y","3"),c.setAttribute("width","46"),c.setAttribute("height","14"),c.setAttribute("rx","7"),c.setAttribute("ry","7"),c.classList.add("opPort__glyphTrack"),o.appendChild(c);const d=document.createElementNS(n,"path");d.classList.add("opPort__glyphShape");const l=(b,w,h)=>Math.max(w,Math.min(h,b)),f=24,p=10,r=7,u=l((a==="mask"?12:a==="svg"||a==="image"?14:12)/2,4,10);if(a==="image")if(s){const b=f-u,w=f+u+r,h=p-6,m=p+6;d.setAttribute("d",`M ${b} ${h} L ${w} ${p} L ${b} ${m} Z`)}else{const b=f+u,w=f-u-r,h=p-6,m=p+6;d.setAttribute("d",`M ${b} ${h} L ${w} ${p} L ${b} ${m} Z`),d.classList.add("opPort__glyphShape--socket")}else if(a==="svg")if(s){const b=f-u,w=u*2+r;d.setAttribute("d",[`M ${b} ${p-6}`,`h ${w}`,"a 6 6 0 0 1 0 12",`h ${-w}`,"a 6 6 0 0 1 0 -12","Z"].join(" "))}else{const b=f+u,w=u*2+r;d.setAttribute("d",[`M ${b} ${p-6}`,`h ${-w}`,"a 6 6 0 0 0 0 12",`h ${w}`,"a 6 6 0 0 0 0 -12","Z"].join(" ")),d.classList.add("opPort__glyphShape--socket")}else if(s){const b=f-u,w=u*2+r;d.setAttribute("d",`M ${b} ${p-6} h ${w} v 12 h ${-w} Z`)}else{const b=f+u,w=u*2+r;d.setAttribute("d",`M ${b} ${p-6} h ${-w} v 12 h ${w} Z`),d.classList.add("opPort__glyphShape--socket")}return o.appendChild(d),o}function qi(e){const{port:t,getPortClass:i}=e,n=`opPort ${i(t.type)}`,o=t.label?`${t.label}: ${t.type}`:String(t.type);return re("div",{class:n,"data-port-kind":t.kind,"data-port-type":String(t.type)},o)}function Ji(e){const{port:t,getPortClass:i}=e,n=`opPort opPort--puzzle ${i(t.type)}`,o=re("div",{class:n,"data-port-kind":t.kind,"data-port-type":String(t.type)}),a=t.label?t.label:String(t.type);o.appendChild(re("div",{class:"opPort__puzzleLabel"},a));const s=Ki({kind:t.kind,type:t.type});return o.appendChild(s),o}function Dt(e){const{ports:t,kind:i,portStyle:n,getPortClass:o}=e,a=re("div",{class:"opCard__portsRow"}),s=re("div",{class:"opCard__portsLabel"},i==="input"?"IN":"OUT");a.appendChild(s);const c=re("div",{class:"opCard__ports"});for(const d of t){const l=n==="puzzle"?Ji({port:d,getPortClass:o}):qi({port:d,getPortClass:o});c.appendChild(l)}return a.appendChild(c),a}function ye(e,t,i){return Math.max(t,Math.min(i,e))}function We(e){const t=String(e||"").toLowerCase();return t==="image"?"image":t==="mask"?"mask":t==="svg"?"svg":t==="imagelist"?"image":t==="pdf"?"rect":"unknown"}function Ke(e){return e==="image"?{w:34,d:7,shape:"circle"}:e==="svg"?{w:30,d:7,shape:"triangle"}:e==="mask"?{w:28,d:6,shape:"rect"}:e==="rect"?{w:30,d:6,shape:"rect"}:{w:26,d:6,shape:"rect"}}function Zi(e){return`url("data:image/svg+xml,${encodeURIComponent(e).replace(/'/g,"%27").replace(/"/g,"%22")}")`}function Yi(e){const{root:t,inType:i,outType:n}=e,o=We(i),a=We(n),s=Ke(o),c=Ke(a),d=Qi({inType:i,outType:n}),l=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 110" preserveAspectRatio="none">
    <path d="${d}" fill="white"/>
  </svg>`,f=Zi(l);t.style.webkitMaskImage=f,t.style.webkitMaskRepeat="no-repeat",t.style.webkitMaskSize="100% 100%",t.style.webkitMaskPosition="center",t.style.maskImage=f,t.style.maskRepeat="no-repeat",t.style.maskSize="100% 100%",t.style.maskPosition="center",t.classList.add("opCard--puzzleFrame"),t.style.position="relative",t.style.border="none",t.style.overflow="visible",t.style.minWidth="0";let p=t.querySelector(":scope > svg.opCard__puzzleOutline");if(!p)p=document.createElementNS("http://www.w3.org/2000/svg","svg"),p.classList.add("opCard__puzzleOutline"),p.setAttribute("viewBox","0 0 100 110"),p.setAttribute("preserveAspectRatio","none"),p.innerHTML=`<path d="${d}" fill="none" stroke="rgba(255,255,255,0.18)" stroke-width="1.5"/>`,t.insertBefore(p,t.firstChild);else{const m=p.querySelector("path");m&&m.setAttribute("d",d)}const r=t.classList.contains("opCard--compact"),g=r?22:26,u=r?16:18,b=r?16:18,w=u+Math.round(s.d*.9),h=b+Math.round(c.d*.9);t.style.setProperty("--opPuzzleInsetX",`${g}px`),t.style.setProperty("--opPuzzleInsetTop",`${w}px`),t.style.setProperty("--opPuzzleInsetBottom",`${h}px`)}function Qi(e){const c=We(e.inType),d=We(e.outType),l=Ke(c),f=Ke(d),p=50,r=ye(l.w,18,40),g=ye(l.d,6,12),u=ye(f.w,18,40),b=Math.max(6,Math.min(12,8)),w=ye(f.d,6,b),h=ye(p-r/2,20,80),m=ye(p+r/2,20,80),C=ye(p-u/2,20,80),v=ye(p+u/2,20,80);function E(){if(l.shape==="triangle")return`L ${p} ${0+g} L ${m} 0`;if(l.shape==="circle"){const M=h,A=m,U=A-M,P=g,y=Math.max(6,U*.25),z=M+U/2;return[`C ${M+y} 0 ${M+y} ${0+P} ${z} ${0+P}`,`C ${A-y} ${0+P} ${A-y} 0 ${A} 0`].join(" ")}return`V ${0+g} H ${m} V 0`}function x(){if(f.shape==="triangle")return`L ${p} ${100+w} L ${C} 100`;if(f.shape==="circle"){const M=v,A=C,U=M-A,P=w,y=Math.max(6,U*.25),z=A+U/2;return[`C ${M-y} 100 ${M-y} ${100+P} ${z} ${100+P}`,`C ${A+y} ${100+P} ${A+y} 100 ${A} 100`].join(" ")}return`V ${100+w} H ${C} V 100`}return["M 16 0",`H ${h}`,E(),"H 84","A 10 10 0 0 1 94 10","V 90","A 10 10 0 0 1 84 100",`H ${v}`,x(),"H 16","A 10 10 0 0 1 6 90","V 10","A 10 10 0 0 1 16 0","Z"].join(" ")}function Ze(e,t){const i=Gi(e),n={compact:!!(t!=null&&t.compact),showId:(t==null?void 0:t.showId)??!0,showGroup:(t==null?void 0:t.showGroup)??!0,portStyle:(t==null?void 0:t.portStyle)??"chip",cardStyle:(t==null?void 0:t.cardStyle)??"plain",getPortClass:(t==null?void 0:t.getPortClass)??Wi,onClick:t==null?void 0:t.onClick},o=re("div",{class:`opCard${n.compact?" opCard--compact":""}`,"data-op-id":i.id}),a=re("div",{class:"opCard__content"}),s=re("div",{class:"opCard__head"}),c=re("div",{class:"opCard__title"},i.title);s.appendChild(c);const d=re("div",{class:"opCard__meta"});n.showGroup&&i.group&&d.appendChild(re("span",{class:"opBadge opBadge--group"},i.group)),n.showId&&d.appendChild(re("span",{class:"opBadge opBadge--id"},i.id)),s.appendChild(d),a.appendChild(s);const l=re("div",{class:"opCard__body"});return l.appendChild(Dt({ports:i.inputs,kind:"input",portStyle:n.portStyle,getPortClass:n.getPortClass})),l.appendChild(Dt({ports:i.outputs,kind:"output",portStyle:n.portStyle,getPortClass:n.getPortClass})),a.appendChild(l),o.appendChild(a),n.cardStyle==="puzzleFrame"&&Yi({root:o,inType:e.io.input,outType:e.io.output}),n.onClick&&(o.classList.add("opCard--clickable"),o.addEventListener("click",f=>{var p,r;(p=f.preventDefault)==null||p.call(f),(r=n.onClick)==null||r.call(n,i.id)})),o}function _(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function Xi(e){return e.type==="image"}function eo(e){return e.type==="mask"}function to(e){return e.type==="svg"}function no(e){return e.type==="imageList"}function io(e){return e.type==="pdf"}function hn(e){return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(e)}`}function Mt(e,t){var n;if(io(e)){const o=Math.max(1,Math.round((((n=e.bytes)==null?void 0:n.length)??0)/1024));return _("div",{class:"muted",style:"margin-top:8px; font-size:12px; white-space:pre-wrap;"},`PDF output (${o} KB)`)}if(no(e)){const o=_("div",{style:"margin-top:8px;"});o.appendChild(_("div",{class:"muted",style:"font-size:12px; margin-bottom:6px;"},`Image list (${e.items.length})`));const a=e.items[0];if(a){const s=_("canvas",{class:"canvas",style:`display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});ge(s,a.image),o.appendChild(s)}return o}if(Xi(e)){const o=_("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return ge(o,e.image),o}if(eo(e)){const o=_("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return gt(o,e.mask,e.width,e.height),o}if(!to(e))return _("div",{class:"muted",style:"margin-top:8px; font-size:12px;"},`Unsupported output: ${String(e.type)}`);const i=_("img",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`,"aria-label":"SVG preview"});return i.src=hn(e.svg),i}function ut(e,t){const i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download=e,n.rel="noopener",n.click(),setTimeout(()=>URL.revokeObjectURL(i),500)}async function at(e,t){const i=await new Promise(n=>t.toBlob(o=>n(o),"image/png"));if(!i)throw new Error("Failed to create PNG blob.");ut(e,i)}function ge(e,t){e.width=t.width,e.height=t.height;const i=e.getContext("2d",{willReadFrequently:!0});i&&i.putImageData(t,0,0)}function gt(e,t,i,n){e.width=i,e.height=n;const o=e.getContext("2d",{willReadFrequently:!0});if(!o)return;let a=0;const s=i*n;for(let f=0;f<s;f++){const p=t[f]??0;p>a&&(a=p)}const c=a<=1,d=o.createImageData(i,n),l=d.data;for(let f=0;f<s;f++){const p=t[f]??0;let r;c?r=(p>0?1:0)?0:255:r=p;const g=f*4;l[g]=r,l[g+1]=r,l[g+2]=r,l[g+3]=255}o.putImageData(d,0,0)}function oo(e){const{hostEl:t,statusEl:i,handlers:n}=e;let o=!1,a=null,s=null,c=null,d=null,l=null,f=null,p=null,r=null,g=null,u=null,b=null,w=null,h=null,m=null;function C(){for(;t.firstChild;)t.removeChild(t.firstChild)}async function v(y){var V,O,B,W,j,H,q,Y,F,ee;const N=(typeof(y==null?void 0:y.activePipelineId)=="string"?y.activePipelineId:"pipeline").replace(/[^a-z0-9_-]+/gi,"_").slice(0,40)||"pipeline",R=(V=y==null?void 0:y.outputPdf)==null?void 0:V.bytes;if(R&&R.byteLength>0){const Q=typeof((O=y==null?void 0:y.outputPdf)==null?void 0:O.filenameHint)=="string"?y.outputPdf.filenameHint:"",ce=Q&&Q.toLowerCase().endsWith(".pdf")?Q:`beemage-${N}.pdf`,pe=new Uint8Array(R.byteLength);pe.set(R);const Ye=new Blob([pe],{type:"application/pdf"});ut(ce,Ye);return}const D=(B=y==null?void 0:y.outputSvg)==null?void 0:B.svg;if(typeof D=="string"&&D.length>0){const Q=new Blob([D],{type:"image/svg+xml;charset=utf-8"});ut(`beemage-${N}.svg`,Q);return}const k=(W=y==null?void 0:y.outputImage)==null?void 0:W.data;if(k){const Q=document.createElement("canvas");ge(Q,k),await at(`beemage-${N}.png`,Q);return}const S=(j=y==null?void 0:y.outputMask)==null?void 0:j.data,$=(H=y==null?void 0:y.outputMask)==null?void 0:H.width,I=(q=y==null?void 0:y.outputMask)==null?void 0:q.height;if(S&&typeof $=="number"&&typeof I=="number"){const Q=document.createElement("canvas");gt(Q,S,$,I),await at(`beemage-${N}-mask.png`,Q);return}const T=(Y=y==null?void 0:y.outputImageList)==null?void 0:Y.count,L=(ee=(F=y==null?void 0:y.outputImageList)==null?void 0:F.first)==null?void 0:ee.data;if(typeof T=="number"&&T>0&&L){const Q=document.createElement("canvas");ge(Q,L),await at(`beemage-${N}-0.png`,Q);return}throw new Error("No output to download.")}function E(){if(o)return;o=!0,C(),a=_("div",{class:"card"}),r=_("p",{class:"muted",style:"margin-top:0;"},"Universal pipeline runner. Select a pipeline and run it.");const y=_("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),z=_("label",{class:"fieldInline"});z.appendChild(_("span",{},"Pipeline")),s=_("select"),z.appendChild(s);const N=_("label",{class:"fieldInline"});N.appendChild(_("span",{},"Recipe")),c=_("select"),N.appendChild(c),d=_("button",{type:"button"},"Run all"),l=_("button",{type:"button"},"Next step"),f=_("button",{type:"button"},"Reset"),p=_("button",{type:"button"},"Download"),y.appendChild(z),y.appendChild(N),y.appendChild(d),y.appendChild(l),y.appendChild(f),y.appendChild(p);const R=_("div",{class:"grid4",style:"margin-top:12px;"}),D=_("div",{class:"card"});D.appendChild(_("div",{class:"cardTitle"},"Input (from source)")),g=_("canvas",{class:"canvas","aria-label":"Pipeline input preview"}),D.appendChild(g);const k=_("div",{class:"card"});k.appendChild(_("div",{class:"cardTitle"},"Current output")),w=_("div",{class:"muted",style:"font-size:12px; margin-top:6px;"}),u=_("canvas",{class:"canvas","aria-label":"Pipeline current output preview"}),b=_("img",{class:"canvas","aria-label":"Pipeline SVG output preview",style:"display:none;"}),k.appendChild(w),k.appendChild(u),k.appendChild(b);const S=_("div",{class:"card",style:"grid-column:1 / -1;"});S.appendChild(_("div",{class:"cardTitle"},"Stages")),h=_("div"),S.appendChild(h),R.appendChild(D),R.appendChild(k),R.appendChild(S),a.appendChild(r),a.appendChild(y),a.appendChild(R),t.appendChild(a),s.addEventListener("change",()=>{const $=s?s.value:"segmentation";n.onSelectPipeline($)}),c.addEventListener("change",()=>{const $=c?c.value:"default";n.onSelectRecipe($)}),d.addEventListener("click",()=>n.onRunAll()),l.addEventListener("click",()=>n.onNext()),f.addEventListener("click",()=>n.onReset()),p.addEventListener("click",async()=>{try{await v(m)}catch($){const I=$ instanceof Error?$.message:String($);i.textContent=`Download failed: ${I}`}})}function x(y){if(!s||!c)return;const z=Array.isArray(y==null?void 0:y.pipelines)?y.pipelines:[],N=Array.isArray(y==null?void 0:y.recipes)?y.recipes:[],R=typeof(y==null?void 0:y.activePipelineId)=="string"?y.activePipelineId:"segmentation",D=typeof(y==null?void 0:y.activeRecipeId)=="string"?y.activeRecipeId:"default";s.innerHTML="";for(const k of z){const S=_("option");S.value=k.id,S.textContent=k.title,k.id===R&&(S.selected=!0),s.appendChild(S)}c.innerHTML="";for(const k of N){const S=_("option");S.value=k.id,S.textContent=k.title,k.id===D&&(S.selected=!0),c.appendChild(S)}}function M(y){var D,k,S;if(!g)return;const z=y==null?void 0:y.inputArtifact;if(z&&z.type==="image"){ge(g,z.image);return}if(z&&z.type==="imageList"){const $=(k=(D=z.items)==null?void 0:D[0])==null?void 0:k.image;if($){ge(g,$);return}}const N=(S=y==null?void 0:y.input)==null?void 0:S.data;if(N){ge(g,N);return}g.width=1,g.height=1;const R=g.getContext("2d");R&&R.clearRect(0,0,g.width,g.height)}function A(y){var L,V,O,B,W,j,H,q,Y;if(!u||!b||!w)return;w.textContent="";const z=(L=y==null?void 0:y.outputPdf)==null?void 0:L.bytes;if(z&&z.length){u.style.display="none",b.style.display="none",b.src="";const F=Math.max(1,Math.round(z.length/1024));w.textContent=`PDF output (${F} KB)`;return}const N=(V=y==null?void 0:y.outputImageList)==null?void 0:V.count,R=(B=(O=y==null?void 0:y.outputImageList)==null?void 0:O.first)==null?void 0:B.data;if(typeof N=="number"&&N>0){if(w.textContent=`Image list (${N})`,R){u.style.display="block",b.style.display="none",b.src="",ge(u,R);return}u.style.display="none",b.style.display="none",b.src="";return}const D=(W=y==null?void 0:y.outputSvg)==null?void 0:W.svg;if(typeof D=="string"&&D.length>0){u.style.display="none",b.style.display="block",b.src=hn(D);return}u.style.display="block",b.style.display="none",b.src="";const k=(j=y==null?void 0:y.outputImage)==null?void 0:j.data;if(k){ge(u,k);return}const S=(H=y==null?void 0:y.outputMask)==null?void 0:H.data,$=(q=y==null?void 0:y.outputMask)==null?void 0:q.width,I=(Y=y==null?void 0:y.outputMask)==null?void 0:Y.height;if(S&&typeof $=="number"&&typeof I=="number"){gt(u,S,$,I);return}u.width=1,u.height=1;const T=u.getContext("2d");T&&T.clearRect(0,0,u.width,u.height)}function U(y){if(!h)return;h.innerHTML="";const z=Array.isArray(y==null?void 0:y.stages)?y.stages:[];if(!z.length){h.appendChild(_("div",{class:"muted",style:"font-size:12px;"},"No stages."));return}const N=_("div",{style:"display:flex; flex-direction:column; gap:10px;"});for(const R of z)N.appendChild(P(R));h.appendChild(N)}function P(y){const z=_("div",{class:"card",style:"padding:10px;"}),N=_("div",{class:"row",style:"align-items:center; justify-content:space-between;"});N.appendChild(_("div",{style:"font-weight:bold;"},String(y.title??y.stageId))),N.appendChild(_("div",{class:"status"},String(y.state??"idle"))),z.appendChild(N),z.appendChild(_("div",{class:"muted",style:"font-size:12px;"},`${y.input} -> ${y.output}`)),typeof y.error=="string"&&y.error.length>0&&z.appendChild(_("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Stage error: ${y.error}`));const R=y.outputArtifact;R&&z.appendChild(Mt(R,260));const D=Array.isArray(y.ops)?y.ops:[];if(D.length){const k=_("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:8px;"});for(let S=0;S<D.length;S++){const $=D[S],I=S===D.length-1,T=_("div",{class:"card",style:"padding:8px;"}),L=_("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),V={id:String($.opId??""),title:String($.title??$.opId??"Operation"),io:{input:$.input,output:$.output},group:$.group},O=Ze(V,{compact:!0,showGroup:!0,showId:!0,portStyle:"puzzle",cardStyle:"plain"});L.appendChild(O),L.appendChild(_("div",{class:"status"},String($.state??"idle"))),T.appendChild(L),typeof $.error=="string"&&$.error.length>0&&T.appendChild(_("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Op error: ${$.error}`));const B=R&&I?void 0:$.outputArtifact;B&&T.appendChild(Mt(B,200)),k.appendChild(T)}z.appendChild(k)}return z}return{mount(){E()},render(y){var z,N,R,D,k;if(E(),m=y,x(y),i.textContent=typeof(y==null?void 0:y.statusText)=="string"?y.statusText:"Idle",r){const S=typeof(y==null?void 0:y.description)=="string"?y.description:"Universal pipeline runner.";r.textContent=S}if(p){const S=(z=y==null?void 0:y.outputPdf)==null?void 0:z.bytes,$=((S==null?void 0:S.byteLength)??0)>0,I=typeof((N=y==null?void 0:y.outputSvg)==null?void 0:N.svg)=="string"&&y.outputSvg.svg.length>0,T=!!((R=y==null?void 0:y.outputImage)!=null&&R.data),L=!!((D=y==null?void 0:y.outputMask)!=null&&D.data),V=typeof((k=y==null?void 0:y.outputImageList)==null?void 0:k.count)=="number"&&y.outputImageList.count>0;p.disabled=!($||I||T||L||V)}M(y),A(y),U(y)},dispose(){o=!1,a=null,s=null,c=null,d=null,l=null,f=null,p=null,r=null,g=null,u=null,b=null,w=null,h=null,m=null,C()}}}async function ao(e,t={}){const i=t.pageWidthPt??595.28,n=t.pageHeightPt??841.89,o=t.jpegQuality??.92,a=t.contain??!0,s=t.marginPt??18,c=[];for(const v of e){const E=await ro(v),{jpegBytes:x,pxW:M,pxH:A}=await lo(E,o);c.push({jpegBytes:x,pxW:M,pxH:A})}const d=[],l=[0];let f=0;const p=v=>{d.push(v),f+=v.byteLength},r=v=>p(new TextEncoder().encode(v)),g=v=>{l[v]=f,r(`${v} 0 obj
`)},u=()=>r(`endobj
`);r(`%PDF-1.4
`),p(new Uint8Array([37,226,227,207,211,10]));const b=1,w=2;let h=3;const m=[];for(let v=0;v<c.length;v++){const E=h++,x=h++,M=h++;m.push({pageObj:M,contentObj:x,imageObj:E});const{jpegBytes:A,pxW:U,pxH:P}=c[v];g(E),r(`<<
`),r(`/Type /XObject
`),r(`/Subtype /Image
`),r(`/Width ${U}
`),r(`/Height ${P}
`),r(`/ColorSpace /DeviceRGB
`),r(`/BitsPerComponent 8
`),r(`/Filter /DCTDecode
`),r(`/Length ${A.byteLength}
`),r(`>>
`),r(`stream
`),p(A),r(`
endstream
`),u();const{drawW:y,drawH:z,offsetX:N,offsetY:R}=so({pageW:i,pageH:n,pxW:U,pxH:P,contain:a,margin:s}),D=`q
${y.toFixed(2)} 0 0 ${z.toFixed(2)} ${N.toFixed(2)} ${R.toFixed(2)} cm
/Im0 Do
Q
`,k=new TextEncoder().encode(D);g(x),r(`<<
`),r(`/Length ${k.byteLength}
`),r(`>>
`),r(`stream
`),p(k),r(`endstream
`),u(),g(M),r(`<<
`),r(`/Type /Page
`),r(`/Parent ${w} 0 R
`),r(`/MediaBox [0 0 ${i.toFixed(2)} ${n.toFixed(2)}]
`),r(`/Resources <<
`),r("/XObject << /Im0 "),r(`${E} 0 R`),r(` >>
`),r(`>>
`),r(`/Contents ${x} 0 R
`),r(`>>
`),u()}g(w),r(`<<
`),r(`/Type /Pages
`),r(`/Count ${m.length}
`),r("/Kids [");for(const v of m)r(` ${v.pageObj} 0 R`);r(` ]
`),r(`>>
`),u(),g(b),r(`<<
`),r(`/Type /Catalog
`),r(`/Pages ${w} 0 R
`),r(`>>
`),u();const C=f;r(`xref
`),r(`0 ${h}
`),r(`0000000000 65535 f 
`);for(let v=1;v<h;v++){const E=l[v]??0;r(E.toString().padStart(10,"0")),r(` 00000 n 
`)}return r(`trailer
`),r(`<<
`),r(`/Size ${h}
`),r(`/Root ${b} 0 R
`),r(`>>
`),r(`startxref
`),r(`${C}
`),r(`%%EOF
`),po(d,f)}function so(e){const{pageW:t,pageH:i,pxW:n,pxH:o,contain:a,margin:s}=e;if(!a)return{drawW:t,drawH:i,offsetX:0,offsetY:0};const c=Math.max(1,t-2*s),d=Math.max(1,i-2*s),l=n/o,f=c/d;let p,r;return l>=f?(p=c,r=c/l):(r=d,p=d*l),{drawW:p,drawH:r,offsetX:(t-p)/2,offsetY:(i-r)/2}}async function ro(e){if(e instanceof Blob)return e;if(e instanceof Uint8Array){const i=new Uint8Array(e);return new Blob([i.buffer])}if("blob"in e)return e.blob;const t=new Uint8Array(e.bytes);return new Blob([t.buffer])}async function lo(e,t){const i=URL.createObjectURL(e);try{const n=await co(i),o=document.createElement("canvas");o.width=Math.max(1,n.naturalWidth||n.width),o.height=Math.max(1,n.naturalHeight||n.height);const a=o.getContext("2d");if(!a)throw new Error("PDF: canvas 2D context unavailable.");a.drawImage(n,0,0);const c=await(await new Promise((d,l)=>{o.toBlob(f=>f?d(f):l(new Error("PDF: JPEG encode failed.")),"image/jpeg",t)})).arrayBuffer();return{jpegBytes:new Uint8Array(c),pxW:o.width,pxH:o.height}}finally{URL.revokeObjectURL(i)}}function co(e){return new Promise((t,i)=>{const n=new Image;n.decoding="async",n.onload=()=>t(n),n.onerror=()=>i(new Error("PDF: image load failed.")),n.src=e})}function po(e,t){const i=new Uint8Array(t);let n=0;for(const o of e)i.set(o,n),n+=o.byteLength;return i}function Et(e){return!!e&&e.type==="image"&&typeof e.width=="number"&&typeof e.height=="number"&&!!e.image}function uo(e){const t=e.filter(Et);if(t.length===0)throw new Error("Stack vertical: empty imageList.");const i=Math.max(...t.map(d=>d.width)),n=t.reduce((d,l)=>d+l.height,0),o=document.createElement("canvas");o.width=Math.max(1,i),o.height=Math.max(1,n);const a=o.getContext("2d",{willReadFrequently:!0});if(!a)throw new Error("Stack vertical: 2D context unavailable.");let s=0;for(const d of t)a.putImageData(d.image,0,s),s+=d.height;const c=a.getImageData(0,0,o.width,o.height);return{type:"image",width:c.width,height:c.height,image:c}}function go(e){const t=e.filter(Et);if(t.length===0)throw new Error("Stack horizontal: empty imageList.");const i=t.reduce((d,l)=>d+l.width,0),n=Math.max(...t.map(d=>d.height)),o=document.createElement("canvas");o.width=Math.max(1,i),o.height=Math.max(1,n);const a=o.getContext("2d",{willReadFrequently:!0});if(!a)throw new Error("Stack horizontal: 2D context unavailable.");let s=0;for(const d of t)a.putImageData(d.image,s,0),s+=d.width;const c=a.getImageData(0,0,o.width,o.height);return{type:"image",width:c.width,height:c.height,image:c}}function fo(e){const t=document.createElement("canvas");t.width=Math.max(1,e.width),t.height=Math.max(1,e.height);const i=t.getContext("2d",{willReadFrequently:!0});if(!i)throw new Error("PNG encode: 2D context unavailable.");i.putImageData(e,0,0);const n=t.toDataURL("image/png"),o=n.indexOf("base64,");if(o<0)throw new Error("PNG encode: unexpected data URL.");const a=n.slice(o+7),s=atob(a),c=new Uint8Array(s.length);for(let d=0;d<s.length;d++)c[d]=s.charCodeAt(d);return c}function De(e,t){return e.find(i=>i.id===t)??null}function oe(e,t){return{input:e,output:t}}function Ot(e,t){return`${e}.${t+1}`}function ft(e){const t=[{kind:"dispatch",id:"op.seg.resize",title:"Resize",io:oe("image","image"),dispatchId:"segmentation.resize",tuningId:"segmentation.resize",group:"Segmentation"},{kind:"dispatch",id:"op.seg.denoise",title:"Denoise",io:oe("image","image"),dispatchId:"segmentation.denoise",tuningId:"segmentation.denoise",group:"Segmentation"},{kind:"dispatch",id:"op.seg.color",title:"Color / Gray",io:oe("image","image"),dispatchId:"segmentation.color",tuningId:"segmentation.color",group:"Segmentation"},{kind:"dispatch",id:"op.seg.threshold",title:"Threshold",io:oe("image","mask"),dispatchId:"segmentation.threshold",tuningId:"segmentation.threshold",group:"Segmentation"},{kind:"dispatch",id:"op.seg.morphology",title:"Morphology cleanup",io:oe("mask","mask"),dispatchId:"segmentation.morphology",tuningId:"segmentation.morphology",group:"Segmentation"},{kind:"dispatch",id:"op.edge.resize",title:"Resize",io:oe("image","image"),dispatchId:"edge.resize",tuningId:"edge.resize",group:"Edge"},{kind:"dispatch",id:"op.edge.threshold",title:"Threshold",io:oe("image","mask"),dispatchId:"edge.threshold",tuningId:"edge.threshold",group:"Edge"},{kind:"dispatch",id:"op.edge.morphology",title:"Morphology cleanup",io:oe("mask","mask"),dispatchId:"edge.morphology",tuningId:"edge.morphology",group:"Edge"},{kind:"dispatch",id:"op.edge.extract",title:"Edge extract",io:oe("mask","mask"),dispatchId:"edge.extract",tuningId:"edge.extract",group:"Edge"},{kind:"dispatch",id:"op.svg.create",title:"Create SVG",io:oe("mask","svg"),dispatchId:"svg.create",tuningId:"svg.create",group:"SVG"},{kind:"dispatch",id:"op.mage.clean.removeSmallComponents",title:"Remove small components",io:oe("mask","mask"),dispatchId:"mage.clean.removeSmallComponents",tuningId:"mage.clean.removeSmallComponents",group:"Cleanup"},{kind:"js",id:"op.util.pass.image",title:"Pass-through (image)",io:oe("image","image"),group:"Utility",run:({input:l})=>l},{kind:"js",id:"op.util.pass.mask",title:"Pass-through (mask)",io:oe("mask","mask"),group:"Utility",run:({input:l})=>l},{kind:"js",id:"op.util.pass.imageList",title:"Pass-through (imageList)",io:oe("imageList","imageList"),group:"Utility",run:({input:l})=>l},{kind:"js",id:"op.imageList.stackVertical",title:"Stack images (vertical)",io:oe("imageList","image"),group:"Multi-input",run:({input:l})=>{const f=l;if(f.type!=="imageList")throw new Error(`Expected imageList, got ${f.type}`);return uo(f.items)}},{kind:"js",id:"op.imageList.stackHorizontal",title:"Stack images (horizontal)",io:oe("imageList","image"),group:"Multi-input",run:({input:l})=>{const f=l;if(f.type!=="imageList")throw new Error(`Expected imageList, got ${f.type}`);return go(f.items)}},{kind:"js",id:"op.imageList.toPdf",title:"Images → PDF",io:oe("imageList","pdf"),group:"Multi-input",run:async({input:l})=>{const f=l;if(f.type!=="imageList")throw new Error(`Expected imageList, got ${f.type}`);const p=f.items.filter(Et);if(p.length===0)throw new Error("PDF: empty imageList.");const r=p.map(u=>fo(u.image));return{type:"pdf",bytes:await ao(r,{contain:!0}),filenameHint:"beemage.pdf"}}}];function i(l){return De(t,l)}function n(l,f){return f.map((p,r)=>({instanceId:Ot(l,r),opId:p,enabled:!0}))}const o=[{id:"segmentation",title:"Segmentation",implemented:!0,description:"Multi-step segmentation pipeline (image -> mask).",ops:n("segmentation",["op.seg.resize","op.seg.denoise","op.seg.color","op.seg.threshold","op.seg.morphology"])},{id:"edge",title:"Edge",implemented:!0,description:"Edge extraction pipeline (image -> mask -> edges).",ops:n("edge",["op.edge.resize","op.edge.threshold","op.edge.morphology","op.edge.extract"])},{id:"svg",title:"SVG",implemented:!0,description:"Image to SVG outline.",ops:n("svg",["op.edge.resize","op.edge.threshold","op.edge.morphology","op.edge.extract","op.svg.create"])},{id:"cleanup",title:"Cleanup (min area)",implemented:!0,description:"Image -> mask -> cleanup (morphology + remove small components).",ops:n("cleanup",["op.seg.resize","op.seg.threshold","op.seg.morphology","op.mage.clean.removeSmallComponents"])},{id:"surface",title:"Surface",implemented:!1,description:"Future: region labeling + vectorize pipeline.",ops:[]}],a=(e==null?void 0:e.userPipelines)??[];function s(l){return De(o,l)}function c(l){return De(a,l)??De(o,l)}function d(){const l=new Set(a.map(p=>p.id));return[...o.filter(p=>!l.has(p.id)),...a]}return{ops:t,getOp:i,builtIns:o,getBuiltIn:s,listPipelines:d,getPipeline:c,createInstanceId:Ot}}const Bt=ln();function ho(){return{opencvReady:Ce()}}function mo(e){const{implemented:t,policy:i,runtimeOpenCvReady:n}=e,o=n&&t.includes("opencv");return t.includes("native")||t.length,i==="native"?{engine:"native"}:i==="opencv"?o?{engine:"opencv"}:{engine:"native",fallbackReason:n?"Override policy=opencv, but this op has no OpenCV implementation.":"Override policy=opencv, but OpenCV is not available at runtime."}:i==="auto"?o?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}async function yo(e,t){const i=await Te(),n=ho(),o=cn(e,Bt,i,n),a=Bt.byId.get(e);if(!a)throw new Error(`[opsDispatch] Unknown op in registry: ${e}`);const c={...o.params,...(t==null?void 0:t.params)??{}},d=t!=null&&t.enginePolicy&&t.enginePolicy!=="inherit"?t.enginePolicy:o.policy;let l=o.engine,f=o.fallbackReason;if(t!=null&&t.enginePolicy&&t.enginePolicy!=="inherit"){const p=mo({implemented:a.implementedEngines,policy:d,runtimeOpenCvReady:!!n.opencvReady});l=p.engine,f=p.fallbackReason}return{engine:l,params:c,fallbackReason:f,opencvReady:!!n.opencvReady}}async function bo(e,t,i,n){const{engine:o,params:a,fallbackReason:s,opencvReady:c}=await yo(e,n);return o==="opencv"&&!c?(je(`OpenCV selected for ${e} but not ready; falling back to native. ${s??""}`.trim()),await i[e].native(t,a)):await i[e][o](t,a)}function Me(e,t,i,n){if(!t||!i)return e;const o=Math.floor(Number(n.morphAlgo??2)),a=vo(Math.floor(Number(n.morphIters??1)),1,20),s=Math.floor(Number(n.morphK??5)),c=wo(s),d=c-1>>1;if(o<=0||c<=1)return e;let l=e,f=new Uint8Array(t*i);for(let p=0;p<a;p++){if(o===1){zt(l,f,t,i,d);const r=l;l=f,f=r;continue}if(o===2){Ut(l,f,t,i,d);const r=l;l=f,f=r;continue}Ut(l,f,t,i,d),l===e&&p===0&&(l=new Uint8Array(e)),zt(f,l,t,i,d)}return l}function wo(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:5}function Ut(e,t,i,n,o){t.fill(0);for(let a=0;a<n;a++){const s=Math.max(0,a-o),c=Math.min(n-1,a+o);for(let d=0;d<i;d++){const l=Math.max(0,d-o),f=Math.min(i-1,d+o);let p=0;for(let r=s;r<=c&&!p;r++){let g=r*i+l;for(let u=l;u<=f;u++,g++)if(e[g]){p=1;break}}t[a*i+d]=p}}}function zt(e,t,i,n,o){t.fill(0);for(let a=0;a<n;a++){const s=Math.max(0,a-o),c=Math.min(n-1,a+o);for(let d=0;d<i;d++){const l=Math.max(0,d-o),f=Math.min(i-1,d+o);let p=1;for(let r=s;r<=c&&p;r++){let g=r*i+l;for(let u=l;u<=f;u++,g++)if(!e[g]){p=0;break}}t[a*i+d]=p}}}function vo(e,t,i){return e<t?t:e>i?i:e}function mn(e,t,i,n){const o=Math.max(0,Math.floor(Number(n??0)));if(!t||!i||o<=1)return e;const a=new Uint8Array(e),s=new Uint8Array(e.length),c=new Int32Array(e.length),d=new Int32Array(e.length);for(let l=0;l<i;l++)for(let f=0;f<t;f++){const p=l*t+f;if(e[p]===0||s[p]===1)continue;let r=0,g=0;s[p]=1,c[g]=f,d[g]=l,g++;const u=[p];for(;r<g;){const b=c[r],w=d[r];r++;const h=b-1,m=w,C=b+1,v=w,E=b,x=w-1,M=b,A=w+1;if(h>=0){const U=m*t+h;e[U]!==0&&s[U]===0&&(s[U]=1,c[g]=h,d[g]=m,g++,u.push(U))}if(C<t){const U=v*t+C;e[U]!==0&&s[U]===0&&(s[U]=1,c[g]=C,d[g]=v,g++,u.push(U))}if(x>=0){const U=x*t+E;e[U]!==0&&s[U]===0&&(s[U]=1,c[g]=E,d[g]=x,g++,u.push(U))}if(A<i){const U=A*t+M;e[U]!==0&&s[U]===0&&(s[U]=1,c[g]=M,d[g]=A,g++,u.push(U))}}if(u.length<o)for(let b=0;b<u.length;b++)a[u[b]]=0}return a}function Co(){const e=globalThis;return e!=null&&e.cv&&typeof e.cv.Mat=="function"?e.cv:null}function Eo(e,t){const{width:i,height:n}=e,o=Math.max(0,Math.floor(Number(t.cleanMinArea??0)));if(sn("OpenCV removeSmallComponents params",{width:i,height:n,minArea:o}),!i||!n||o<=1)return e.mask;const a=Co();if(!a)return mn(e.mask,i,n,o);const s=new a.Mat(n,i,a.CV_8UC1);try{const c=s.data,d=e.mask;for(let r=0;r<d.length;r++)c[r]=d[r]?255:0;const l=new a.Mat,f=new a.Mat,p=new a.Mat;try{const r=a.connectedComponentsWithStats(s,l,f,p,8,a.CV_32S),g=a.CC_STAT_AREA??4,u=new Array(r).fill(!1);for(let h=1;h<r;h++)f.intAt(h,g)<o&&(u[h]=!0);const b=new Uint8Array(i*n),w=l.data32S;for(let h=0;h<b.length;h++){const m=w[h];b[h]=m>0&&!u[m]?1:0}return b}finally{l.delete(),f.delete(),p.delete()}}finally{s.delete()}}function Oe(e,t,i,n){const o=Math.max(0,Math.min(255,Math.floor(Number(n.manualT??128)))),a=new Uint8Array(t*i),s=e.data;for(let c=0,d=0;c<a.length;c++,d+=4){const l=s[d],f=s[d+1],p=s[d+2],r=l*77+f*150+p*29>>8;a[c]=r>=o?1:0}return a}function Be(e,t,i,n){const o=Math.max(1,Math.floor(Number(n.targetMaxW??t)));if(!t||!i||t<=o)return e;const a=o/t,s=Math.max(1,Math.floor(t*a)),c=Math.max(1,Math.floor(i*a));return Math.floor(Number(n.resizeAlgo??1))===0?xo(e,t,i,s,c):ko(e,t,i,s,c)}function xo(e,t,i,n,o){const a=e.data,s=new Uint8ClampedArray(n*o*4),c=t/n,d=i/o;for(let l=0;l<o;l++){const f=Math.min(i-1,Math.max(0,Math.floor((l+.5)*d-.5)));for(let p=0;p<n;p++){const r=Math.min(t-1,Math.max(0,Math.floor((p+.5)*c-.5))),g=(f*t+r)*4,u=(l*n+p)*4;s[u]=a[g],s[u+1]=a[g+1],s[u+2]=a[g+2],s[u+3]=a[g+3]}}return new ImageData(s,n,o)}function ko(e,t,i,n,o){const a=e.data,s=new Uint8ClampedArray(n*o*4),c=t/n,d=i/o;for(let l=0;l<o;l++){const f=(l+.5)*d-.5,p=Ue(Math.floor(f),0,i-1),r=Ue(p+1,0,i-1),g=f-p;for(let u=0;u<n;u++){const b=(u+.5)*c-.5,w=Ue(Math.floor(b),0,t-1),h=Ue(w+1,0,t-1),m=b-w,C=(p*t+w)*4,v=(p*t+h)*4,E=(r*t+w)*4,x=(r*t+h)*4,M=(l*n+u)*4;for(let A=0;A<4;A++){const U=a[C+A],P=a[v+A],y=a[E+A],z=a[x+A],N=U+(P-U)*m,R=y+(z-y)*m,D=N+(R-N)*g;s[M+A]=Io(D)}}}return new ImageData(s,n,o)}function Ue(e,t,i){return e<t?t:e>i?i:e}function Io(e){return e<=0?0:e>=255?255:e|0}function jt(e,t,i,n){if(!t||!i)return e;const o=Math.floor(Number(n.denoiseAlgo??1));if(o<=0)return e;const a=Math.floor(Number(n.blurK??3)),s=So(a);return o===2&&s<=3?$o(e,t,i):s<=1?e:Po(e,t,i,s)}function So(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:3}function Po(e,t,i,n){const o=n-1>>1,a=e.data,s=new Uint8ClampedArray(t*i*4);for(let d=0;d<i;d++){let l=0,f=0,p=0,r=0;for(let g=-o;g<=o;g++){const u=Ee(g,0,t-1),b=(d*t+u)*4;l+=a[b],f+=a[b+1],p+=a[b+2],r+=a[b+3]}for(let g=0;g<t;g++){const u=(d*t+g)*4;s[u]=l/n|0,s[u+1]=f/n|0,s[u+2]=p/n|0,s[u+3]=r/n|0;const b=Ee(g-o,0,t-1),w=Ee(g+o+1,0,t-1),h=(d*t+b)*4,m=(d*t+w)*4;l+=a[m]-a[h],f+=a[m+1]-a[h+1],p+=a[m+2]-a[h+2],r+=a[m+3]-a[h+3]}}const c=new Uint8ClampedArray(t*i*4);for(let d=0;d<t;d++){let l=0,f=0,p=0,r=0;for(let g=-o;g<=o;g++){const b=(Ee(g,0,i-1)*t+d)*4;l+=s[b],f+=s[b+1],p+=s[b+2],r+=s[b+3]}for(let g=0;g<i;g++){const u=(g*t+d)*4;c[u]=l/n|0,c[u+1]=f/n|0,c[u+2]=p/n|0,c[u+3]=r/n|0;const b=Ee(g-o,0,i-1),w=Ee(g+o+1,0,i-1),h=(b*t+d)*4,m=(w*t+d)*4;l+=s[m]-s[h],f+=s[m+1]-s[h+1],p+=s[m+2]-s[h+2],r+=s[m+3]-s[h+3]}}return new ImageData(c,t,i)}function $o(e,t,i){const n=e.data,o=new Uint8ClampedArray(t*i*4),a=new Array(9),s=new Array(9),c=new Array(9),d=new Array(9);for(let l=0;l<i;l++)for(let f=0;f<t;f++){let p=0;for(let g=-1;g<=1;g++){const u=Ee(l+g,0,i-1);for(let b=-1;b<=1;b++){const w=Ee(f+b,0,t-1),h=(u*t+w)*4;a[p]=n[h],s[p]=n[h+1],c[p]=n[h+2],d[p]=n[h+3],p++}}a.sort(ze),s.sort(ze),c.sort(ze),d.sort(ze);const r=(l*t+f)*4;o[r]=a[4]|0,o[r+1]=s[4]|0,o[r+2]=c[4]|0,o[r+3]=d[4]|0}return new ImageData(o,t,i)}function ze(e,t){return e-t}function Ee(e,t,i){return e<t?t:e>i?i:e}function Vt(e,t,i,n){if(!t||!i)return e;const o=Math.floor(Number(n.colorMode??1));if(o===0)return e;const a=e.data,s=new Uint8ClampedArray(t*i*4),c=Ao(Math.floor(Number(n.hsvChannel??2)),0,2);for(let d=0,l=0;d<t*i;d++,l+=4){const f=a[l],p=a[l+1],r=a[l+2],g=a[l+3];let u=0;if(o===1)u=f*77+p*150+r*29>>8;else if(o===2){const b=Lo(f,p,r),w=c===0?b.h:c===1?b.s:b.v;u=To(w*255)}else u=255-(f*77+p*150+r*29>>8);s[l]=u,s[l+1]=u,s[l+2]=u,s[l+3]=g}return new ImageData(s,t,i)}function Lo(e,t,i){const n=e/255,o=t/255,a=i/255,s=Math.max(n,o,a),c=Math.min(n,o,a),d=s-c;let l=0;d!==0&&(s===n?l=(o-a)/d%6:s===o?l=(a-n)/d+2:l=(n-o)/d+4,l/=6,l<0&&(l+=1));const f=s===0?0:d/s;return{h:l,s:f,v:s}}function Ao(e,t,i){return e<t?t:e>i?i:e}function To(e){return e<=0?0:e>=255?255:e|0}function Nt(e,t,i){const n=new Uint8Array(e.length),o=(a,s)=>s*t+a;for(let a=0;a<i;a++)for(let s=0;s<t;s++){const c=o(s,a);if(e[c]===0)continue;if(s===0||a===0||s===t-1||a===i-1){n[c]=255;continue}const l=e[o(s-1,a)],f=e[o(s+1,a)],p=e[o(s,a-1)],r=e[o(s,a+1)];(l===0||f===0||p===0||r===0)&&(n[c]=255)}return n}function Ft(e,t,i,n){const o=Math.max(1,Math.floor(n.scale||1)),a=t*o,s=i*o,c=o;let d="";for(let r=0;r<i;r++){const g=r*t;for(let u=0;u<t;u++){if(e[g+u]===0)continue;const w=u*c,h=r*c;d+=`M${w} ${h}h${c}v${c}h-${c}Z`}}const l=n.transparentBg?"":`<rect x="0" y="0" width="${a}" height="${s}" fill="white"/>`,f=n.color||"#000",p=d.length>0?`<path d="${d}" fill="${f}" stroke="none"/>`:"";return`<svg xmlns="http://www.w3.org/2000/svg" width="${a}" height="${s}" viewBox="0 0 ${a} ${s}">`+l+p+"</svg>"}const Ro="demo",Do={"mage.clean.removeSmallComponents":{native:(e,t)=>mn(e.mask,e.width,e.height,t.cleanMinArea),opencv:(e,t)=>(J("OpenCV removeSmallComponents called (demo).",{width:e.width,height:e.height,cleanMinArea:t.cleanMinArea}),Eo(e,t))},"segmentation.resize":{native:(e,t)=>(J("[demo op] segmentation.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),Be(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(J("[demo op] segmentation.resize opencv",{width:e.width,height:e.height}),Be(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"segmentation.denoise":{native:(e,t)=>(J("[demo op] segmentation.denoise native",{width:e.width,height:e.height,denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}),jt(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma})),opencv:(e,t)=>(J("[demo op] segmentation.denoise opencv",{width:e.width,height:e.height}),jt(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}))},"segmentation.color":{native:(e,t)=>(J("[demo op] segmentation.color native",{width:e.width,height:e.height,colorMode:t.colorMode,hsvChannel:t.hsvChannel}),Vt(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel})),opencv:(e,t)=>(J("[demo op] segmentation.color opencv",{width:e.width,height:e.height}),Vt(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel}))},"segmentation.threshold":{native:(e,t)=>(J("[demo op] segmentation.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),Oe(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(J("[demo op] segmentation.threshold opencv",{width:e.width,height:e.height}),Oe(e.image,e.width,e.height,{manualT:t.manualT}))},"segmentation.morphology":{native:(e,t)=>(J("[demo op] segmentation.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),Me(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(J("[demo op] segmentation.morphology opencv",{width:e.width,height:e.height}),Me(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.resize":{native:(e,t)=>(J("[demo op] edge.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),Be(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(J("[demo op] edge.resize opencv",{width:e.width,height:e.height}),Be(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"edge.threshold":{native:(e,t)=>(J("[demo op] edge.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),Oe(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(J("[demo op] edge.threshold opencv",{width:e.width,height:e.height}),Oe(e.image,e.width,e.height,{manualT:t.manualT}))},"edge.morphology":{native:(e,t)=>(J("[demo op] edge.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),Me(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(J("[demo op] edge.morphology opencv",{width:e.width,height:e.height}),Me(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.extract":{native:(e,t)=>(J("[demo op] edge.extract native",{width:e.width,height:e.height}),Nt(e.mask,e.width,e.height)),opencv:(e,t)=>(J("[demo op] edge.extract opencv",{width:e.width,height:e.height}),Nt(e.mask,e.width,e.height))},"svg.create":{native:(e,t)=>(J("[demo op] svg.create native",{width:e.width,height:e.height,scale:t.scale}),Ft(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color})),opencv:(e,t)=>(J("[demo op] svg.create opencv",{width:e.width,height:e.height,scale:t.scale}),Ft(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color}))}};async function ke(e,t,i){return sn("[opsDispatch] runOp",{op:e,implSource:Ro,inputKeys:t&&typeof t=="object"?Object.keys(t):typeof t,override:i?{enginePolicy:i.enginePolicy,paramsKeys:Object.keys(i.params??{})}:null}),bo(e,t,Do,i)}async function Mo(e,t){return ke(e,t)}const Oo=Object.freeze(Object.defineProperty({__proto__:null,runMaskOp:Mo,runOp:ke},Symbol.toStringTag,{value:"Module"}));function Bo(e){return e.type==="image"||e.type==="mask"||e.type==="svg"?{width:e.width,height:e.height}:null}function Uo(e){const{catalogue:t,pipeline:i}=e,n=(i.ops??[]).filter(a=>a.enabled!==!1),o=[];for(const a of n){const s=t.getOp(a.opId);if(!s)return{enabledInstances:[],specs:[],error:`Unknown opId in pipeline: ${a.opId}`};o.push(s)}return{enabledInstances:n,specs:o}}function zo(e){const{specs:t,instances:i,startType:n}=e;if(t.length===0)return{ok:!0,startType:n,endType:n,steps:[]};if(i.length!==t.length)return{ok:!1,startType:n,error:`Typing internal mismatch: instances(${i.length}) != specs(${t.length})`,steps:[]};let o=n;const a=[];for(let s=0;s<t.length;s++){const c=t[s],d=i[s],l=c.io.input,f=l===o,p=f?void 0:`Chain IO mismatch at "${c.title}" (${c.id}): needs ${l} but current is ${o}`;if(a.push({index:s,instanceId:d.instanceId,opId:c.id,title:c.title,expectedInput:l,actualInput:o,output:c.io.output,ok:f,error:p}),!f)return{ok:!1,startType:n,error:p,steps:a};o=c.io.output}return{ok:!0,startType:n,endType:o,steps:a}}function _t(e){const{specs:t,startType:i,index:n}=e;if(n<=0||t.length===0)return i;let o=i;for(let a=0;a<Math.min(n,t.length);a++){const s=t[a];if(s.io.input!==o)return o;o=s.io.output}return o}function jo(e){const{beforeType:t,afterType:i,op:n}=e;return n.io.input!==t?{ok:!1,reason:`Needs ${n.io.input} but slot provides ${t}`}:i&&n.io.output!==i?{ok:!1,reason:`Produces ${n.io.output} but next op needs ${i}`}:{ok:!0}}function Vo(e){return e.type==="image"}function No(e){return e.type==="mask"}function Fo(e){return{type:"image",width:e.width,height:e.height,image:e}}function Ht(e,t,i){return{type:"mask",width:t,height:i,mask:e}}function Gt(e,t,i){return{type:"svg",width:t,height:i,svg:e}}function qe(e,t){return`IO mismatch: expected ${e}, got ${t}`}async function _o(e,t,i){const n=t.override;if(e.io.input!=="image"&&e.io.input!=="mask")throw new Error(`Dispatch op does not support input type: ${e.io.input}`);if(e.io.input==="image"){if(!Vo(i))throw new Error(qe("image",i.type));const{width:s,height:c}=i;if(e.io.output==="image"){const d=await ke(e.dispatchId,{image:i.image,width:s,height:c},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return Fo(d)}if(e.io.output==="mask"){const d=await ke(e.dispatchId,{image:i.image,width:s,height:c},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return Ht(d,s,c)}if(e.io.output==="svg"){const d=await ke(e.dispatchId,{image:i.image,width:s,height:c},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return Gt(d,s,c)}throw new Error(`Unsupported dispatch output: ${e.io.output}`)}if(!No(i))throw new Error(qe("mask",i.type));const{width:o,height:a}=i;if(e.io.output==="mask"){const s=await ke(e.dispatchId,{mask:i.mask,width:o,height:a},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return Ht(s,o,a)}if(e.io.output==="svg"){const s=await ke(e.dispatchId,{mask:i.mask,width:o,height:a},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return Gt(s,o,a)}throw new Error(`Invalid op spec: mask input cannot produce ${e.io.output} (unsupported here)`)}async function Ho(e,t,i,n){var c;if(e.kind==="dispatch")return await _o(e,t,i);const a={...e.tuningId?await n.getEffectiveParams(e.tuningId).catch(()=>({})):{},...((c=t.override)==null?void 0:c.params)??{}};return await e.run({input:i,params:a})}async function Go(e){const{catalogue:t,pipeline:i,input:n,deps:o}=e;if(!i.implemented)return{pipelineId:i.id,title:i.title,status:"error",error:"Not implemented yet",input:n,ops:[]};const a=Uo({catalogue:t,pipeline:i});if(a.error)return{pipelineId:i.id,title:i.title,status:"error",error:a.error,input:n,ops:[]};const s=a.enabledInstances,c=a.specs,d=zo({specs:c,instances:s,startType:n.type});if(!d.ok)return o.debug("pipeline validation failed (linear)",{pipelineId:i.id,error:d.error}),{pipelineId:i.id,title:i.title,status:"error",error:d.error??"Invalid pipeline typing",input:n,ops:s.map((p,r)=>{var g,u;return{instanceId:p.instanceId,opId:p.opId,title:((g=c[r])==null?void 0:g.title)??p.opId,io:((u=c[r])==null?void 0:u.io)??{input:n.type,output:n.type},status:"error",error:d.error??"Invalid pipeline typing"}})};const l=[];let f=n;for(let p=0;p<c.length;p++){const r=s[p],g=c[p];try{if(g.io.input!==f.type)throw new Error(qe(g.io.input,f.type));const u=await Ho(g,r,f,o);if(u.type!==g.io.output)throw new Error(qe(g.io.output,u.type));l.push({instanceId:r.instanceId,opId:g.id,title:g.title,io:g.io,status:"ok",output:u}),f=u}catch(u){const b=u instanceof Error?u.message:String(u);l.push({instanceId:r.instanceId,opId:g.id,title:g.title,io:g.io,status:"error",error:b});const w=Bo(f);return o.debug("pipeline op failed (linear)",{pipelineId:i.id,opId:g.id,error:b,...w??{},currentType:f.type}),{pipelineId:i.id,title:i.title,status:"error",error:`Op "${g.title}" failed: ${b}`,input:n,ops:l}}}return{pipelineId:i.id,title:i.title,status:"ok",input:n,output:f,ops:l}}const ht="beemage.pipeline.userPipelines.v1";async function Se(){const e=await he([ht]).catch(()=>({})),t=e==null?void 0:e[ht];if(!Array.isArray(t))return[];const i=[];for(const n of t)!n||typeof n!="object"||typeof n.id=="string"&&Array.isArray(n.ops)&&i.push(n);return i}async function Je(e){await me({[ht]:e}).catch(()=>null)}async function Wo(e){const t=await Se(),i=t.findIndex(n=>n.id===e.id);if(i>=0){const n=t.slice();n[i]=e,await Je(n);return}await Je([...t,e])}async function Ko(e){const i=(await Se()).filter(n=>n.id!==e);await Je(i)}const mt="beemage.pipeline.recipes.v1";function qo(){return Date.now()}function yn(){return{recipesById:{}}}async function Ie(){const e=await he([mt]).catch(()=>({})),t=e==null?void 0:e[mt];return!t||typeof t!="object"?{}:t}async function Re(e){await me({[mt]:e}).catch(()=>null)}async function Jo(e,t){const i=await Ie(),n=i[e]??yn();n.selectedRecipeId=t,i[e]=n,await Re(i)}async function Zo(e,t){const i=await Ie(),n=i[e]??yn();n.recipesById[t.id]={...t,updatedTs:qo()},n.selectedRecipeId||(n.selectedRecipeId=t.id),i[e]=n,await Re(i)}async function Yo(e,t){const i=await Ie(),n=i[e];if(n){if(delete n.recipesById[t],n.selectedRecipeId===t){const o=Object.keys(n.recipesById);n.selectedRecipeId=o.length?o[0]:void 0}i[e]=n,await Re(i)}}function Qo(e){const t=[];for(const[i,n]of Object.entries(e??{})){const o=Object.values(n.recipesById??{});t.push({pipelineId:i,selectedRecipeId:n.selectedRecipeId,recipes:o})}return t.sort((i,n)=>i.pipelineId.localeCompare(n.pipelineId)),t}function Xo(e){if(!Array.isArray(e))return{};const t={};for(const i of e){if(!i||typeof i!="object")continue;const n=i.pipelineId;if(typeof n!="string"||!n)continue;const o=i.selectedRecipeId,a=i.recipes,s={};if(Array.isArray(a))for(const c of a){if(!c||typeof c!="object")continue;const d=c.id,l=c.title,f=c.updatedTs,p=c.ops;typeof d!="string"||!d||typeof l!="string"||!l||typeof f=="number"&&Array.isArray(p)&&(s[d]=c)}t[n]={selectedRecipeId:typeof o=="string"?o:void 0,recipesById:s}}return t}function ea(e){return e.type==="image"}function ta(e){return e.type==="mask"}function na(e){return e.type==="svg"}function ia(e){return e.type==="imageList"}function oa(e){return e.type==="pdf"}function aa(e){var z,N,R,D;let t=ft({userPipelines:[]}),i={},o=((R=(N=(z=t.listPipelines)==null?void 0:z.call(t))==null?void 0:N[0])==null?void 0:R.id)??((D=t.builtIns[0])==null?void 0:D.id)??"segmentation",a="default",s=null,c="Idle",d=null,l=[],f=0,p=null;async function r(){var O,B,W,j,H;const k=o,S=a,$=await Se().catch(()=>[]);t=ft({userPipelines:$}),i=await Ie().catch(()=>({}));const I=((O=t.listPipelines)==null?void 0:O.call(t))??t.builtIns;I.some(q=>q.id===o)||(o=((B=I[0])==null?void 0:B.id)??"segmentation",a="default");const L=((W=t.getPipeline)==null?void 0:W.call(t,o))??((H=(j=t.listPipelines)==null?void 0:j.call(t))==null?void 0:H[0]);if(L&&u(L).some(F=>F.id===a)||(a="default"),k!==o||S!==a){w();return}l=[],f=0}function g(){var S,$,I;const k=((S=t.getPipeline)==null?void 0:S.call(t,o))??((I=($=t.listPipelines)==null?void 0:$.call(t))==null?void 0:I[0]);if(!k)throw new Error("[pipeline] No pipelines available.");return k}function u(k){const S={id:"default",title:"Default",buildPipeline:L=>L},$=i==null?void 0:i[k.id],I=($==null?void 0:$.recipesById)??{},T=[S];for(const L of Object.keys(I)){const V=I[L];!V||typeof V.id!="string"||T.push({id:String(V.id),title:typeof V.title=="string"&&V.title.trim().length?V.title:String(V.id),buildPipeline:O=>{const B=Array.isArray(V.ops)?V.ops:null;if(!B)return O;const W=B.filter(j=>j&&typeof j=="object").map(j=>({instanceId:typeof j.instanceId=="string"?j.instanceId:String(j.instanceId??""),opId:typeof j.opId=="string"?j.opId:String(j.opId??""),enabled:j.enabled===void 0?!0:!!j.enabled})).filter(j=>j.instanceId&&j.opId);return W.length?{...O,ops:W}:O}})}return T.slice(0,1).concat(T.slice(1).sort((L,V)=>String(L.title).localeCompare(String(V.title))))}function b(){const k=g(),S=u(k),$=S.find(I=>I.id===a)??S[0];return a=$.id,$.buildPipeline(k)}function w(){c=b().implemented?"Ready":"Not implemented yet",d=null,l=[],f=0,p=null}function h(){w()}function m(k){var $,I;k===o||!((($=t.getPipeline)==null?void 0:$.call(t,k))??((I=t.getBuiltIn)==null?void 0:I.call(t,k)))||(o=k,a="default",h())}function C(k){if(k===a)return;const S=g();a=u(S).some(T=>T.id===k)?k:"default",h()}function v(k){s=k,w()}function E(k){v({type:"image",width:k.width,height:k.height,image:k})}function x(k){const S=k.ops.filter(I=>I.enabled!==!1),$=[];for(let I=0;I<S.length;I++){const T=S[I],L=t.getOp(T.opId);L&&$.push({index0:I,instanceId:T.instanceId,inst:T,opSpec:L})}return $}function M(k){var T;const S=k.ops.map(L=>({instanceId:L.instanceId,opId:L.opId,title:L.title,input:L.io.input,output:L.io.output,state:L.status==="ok"?"ok":L.status==="error"?"error":"idle",error:L.error,outputArtifact:L.output})),$=k.status==="ok"?"ok":"error",I=k.output??((T=S.slice().reverse().find(L=>L.outputArtifact))==null?void 0:T.outputArtifact);return[{stageId:"pipeline",title:"Pipeline",input:k.input.type,output:(I==null?void 0:I.type)??k.input.type,ops:S,state:$,error:k.error,outputArtifact:I}]}function A(k,S){if(k.outputImage=void 0,k.outputMask=void 0,k.outputSvg=void 0,k.outputImageList=void 0,k.outputPdf=void 0,!!S)if(ea(S))k.outputImage={width:S.width,height:S.height,data:S.image};else if(ta(S))k.outputMask={width:S.width,height:S.height,data:S.mask};else if(na(S))k.outputSvg={width:S.width,height:S.height,svg:S.svg};else if(ia(S)){const $=S.items[0];k.outputImageList={count:S.items.length,first:$?{width:$.width,height:$.height,data:$.image}:void 0}}else oa(S)&&(k.outputPdf={bytes:S.bytes,filenameHint:S.filenameHint})}async function U(){const k=b();if(!k.implemented){c="Not implemented yet";return}if(!s){c="No input";return}c="Running all…";const S=await Go({catalogue:t,pipeline:k,input:s,deps:e.runner});d=S,l=x(k),f=l.length,p=S.output??null,c=S.status==="ok"?"Done":S.error??"Error"}async function P(){var I;const k=b();if(!k.implemented){c="Not implemented yet";return}if(!s){c="No input";return}if(l.length===0&&(l=x(k),f=0,p=s,d={pipelineId:k.id,title:k.title,status:"ok",input:s,output:s,ops:[]}),f>=l.length){c="Done";return}const S=l[f],$=S.opSpec;p||(p=s);try{if(c=`Running: ${$.title}`,p.type!==$.io.input)throw new Error(`IO mismatch: expected ${$.io.input}, got ${p.type}`);const T=$.tuningId?await e.runner.getEffectiveParams($.tuningId).catch(()=>({})):{};let L;if($.kind==="dispatch"){const{runOp:B}=await Rn(async()=>{const{runOp:j}=await Promise.resolve().then(()=>Oo);return{runOp:j}},void 0,import.meta.url),W=S.inst.override;if(p.type==="image"){const j=await B($.dispatchId,{image:p.image,width:p.width,height:p.height},W?{enginePolicy:W.enginePolicy,params:{...T,...W.params??{}}}:{params:T});if($.io.output==="image"){const H=j;L={type:"image",width:H.width,height:H.height,image:H}}else if($.io.output==="mask")L={type:"mask",width:p.width,height:p.height,mask:j};else if($.io.output==="svg")L={type:"svg",width:p.width,height:p.height,svg:j};else throw new Error(`Unsupported dispatch output: ${$.io.output}`)}else if(p.type==="mask"){const j=await B($.dispatchId,{mask:p.mask,width:p.width,height:p.height},W?{enginePolicy:W.enginePolicy,params:{...T,...W.params??{}}}:{params:T});if($.io.output==="mask")L={type:"mask",width:p.width,height:p.height,mask:j};else if($.io.output==="svg")L={type:"svg",width:p.width,height:p.height,svg:j};else throw new Error(`Invalid dispatch output: ${$.io.output}`)}else throw new Error(`Dispatch ops cannot take ${p.type} input.`)}else{const B={...T,...((I=S.inst.override)==null?void 0:I.params)??{}};L=await $.run({input:p,params:B})}if(L.type!==$.io.output)throw new Error(`IO mismatch: expected ${$.io.output}, got ${L.type}`);const O=((d==null?void 0:d.ops)??[]).concat([{instanceId:S.instanceId,opId:$.id,title:$.title,io:$.io,status:"ok",output:L}]);d={pipelineId:k.id,title:k.title,status:"ok",input:s,output:L,ops:O},p=L,f+=1,c=f>=l.length?"Done":"Ready"}catch(T){const L=T instanceof Error?T.message:String(T);c=`Error: ${$.title} — ${L}`;const O=((d==null?void 0:d.ops)??[]).concat([{instanceId:S.instanceId,opId:$.id,title:$.title,io:$.io,status:"error",error:L}]);d={pipelineId:k.id,title:k.title,status:"error",error:L,input:s,ops:O},e.runner.debug("pipeline next-step failed",{pipelineId:k.id,recipeId:a,instanceId:S.instanceId,opId:$.id,error:L})}}function y(){var O;const k=g(),S=b(),$=u(k),L={pipelines:(((O=t.listPipelines)==null?void 0:O.call(t))??t.builtIns).map(B=>({id:B.id,title:B.title})),recipes:$.map(B=>({id:B.id,title:B.title})),activePipelineId:o,activeRecipeId:a,statusText:c,description:S.description,stages:d?M(d):[],inputArtifact:s??void 0,input:s&&s.type==="image"?{width:s.width,height:s.height,data:s.image}:void 0,nextIndex:f,totalOps:l.length||S.ops.filter(B=>B.enabled!==!1).length},V=(d==null?void 0:d.output)??p??null;return A(L,V),L}return h(),{getVm:y,setActivePipeline:m,setActiveRecipe:C,setInputImageData:E,setInputArtifact:v,runAll:U,runNext:P,reset:h,reloadCatalogue:r}}const yt=new Set;function sa(e){return yt.add(e),()=>{yt.delete(e)}}function be(e){const t=Array.from(yt);for(const i of t)try{i(e)}catch{}}function ra(e,t,i){const n=aa({runner:{getEffectiveParams:async I=>await i.getEffectiveParams(I).catch(()=>({})),debug:(I,T)=>ne({scope:"panel",kind:"debug",message:I,meta:T})}});let o=null,a=!1,s=null,c=null,d=null,l=!1;const f=[];function p(){d||(d=sa(I=>{a&&(f.push(`${I.kind}:${I.reason}`),g())}))}function r(){d==null||d(),d=null}function g(){l||(l=!0,queueMicrotask(()=>{l=!1;const I=f.splice(0,f.length).join(",")||"unknown";u(I)}))}async function u(I){ne({scope:"panel",kind:"info",message:"Pipeline tab: auto reload catalogue",meta:{reason:I}});const T=n.getVm(),L=String(T.activePipelineId??""),V=String(T.activeRecipeId??"");try{await n.reloadCatalogue()}catch(j){const H=j instanceof Error?j.message:String(j);ne({scope:"panel",kind:"error",message:"Pipeline tab: auto reloadCatalogue failed",meta:{reason:I,error:H}}),G({scope:"panel",kind:"error",message:"Pipeline catalogue refresh failed (auto)."});return}const O=n.getVm(),B=String(O.activePipelineId??""),W=String(O.activeRecipeId??"");(L!==B||V!==W)&&(G({scope:"panel",kind:"info",message:`Pipeline selection updated due to storage change: ${L}/${V} → ${B}/${W}`}),i.setParamValue("pipeline","mode",B),i.setParamValue("pipeline","recipe",W)),v(),Pe(O),y()}async function b(){n.reset();const I=x();I&&n.setInputArtifact(I),Pe(n.getVm()),G({scope:"panel",kind:"info",message:"Pipeline reset (reseed from source)"});try{await n.reloadCatalogue()}catch(T){ne({scope:"panel",kind:"error",message:"Pipeline reset: reloadCatalogue() failed",meta:{error:T instanceof Error?T.message:String(T)}}),G({scope:"panel",kind:"error",message:"Pipeline reset: failed to reload pipeline catalogue from storage."})}try{await U()}catch(T){ne({scope:"panel",kind:"error",message:"Pipeline reset: syncPipelineFromTuning() failed",meta:{error:T instanceof Error?T.message:String(T)}}),v()}Pe(n.getVm()),y()}function w(){const I=n.getVm();if(!(I.stages.some(V=>V.state==="error")||String(I.statusText).toLowerCase().includes("error"))){c=null;return}const L=String(I.statusText||"Pipeline error");L!==c&&(c=L,G({scope:"panel",kind:"error",message:`Pipeline: ${L}`}))}function h(){e.pipelineTuningMountEl.innerHTML=""}function m(I){return[I,`pipeline.${I}`,"pipeline"]}function C(I){const T=m(I);if(s===T[0])return;h();let L=null,V=null;for(const O of T)try{i.mount({mountEl:e.pipelineTuningMountEl,scopeRootId:O}),L=O;break}catch(B){V=B,h()}if(!L){s=null,G({scope:"panel",kind:"info",message:`Pipeline tuning mount failed for "${I}" (no matching scope).`}),ne({scope:"panel",kind:"error",message:"Pipeline tuning mount failed (no candidate scopeRootId worked)",meta:{pipelineId:I,candidates:T,error:V instanceof Error?V.message:String(V)}});return}s=L,G({scope:"panel",kind:"info",message:`Pipeline tuning mount: pipelineId=${I}, scopeRootId=${L}`})}function v(){const I=n.getVm(),T=typeof I.activePipelineId=="string"?I.activePipelineId:"segmentation";C(T)}function E(I){return{type:"image",width:I.width,height:I.height,image:I}}function x(){const I=globalThis==null?void 0:globalThis.app__,T=I==null?void 0:I.input__;if(T&&typeof T=="object"){const j=String(T.kind??"");if(j==="image"){const H=T.image??T.data;if(H&&typeof H=="object"&&typeof H.width=="number"&&typeof H.height=="number")return E(H)}if(j==="imageList"){const H=T.images??T.items;if(Array.isArray(H)&&H.length>0){const q=H.filter(Y=>Y&&typeof Y.width=="number"&&typeof Y.height=="number").map(Y=>E(Y));if(q.length>0)return{type:"imageList",items:q}}}ne({scope:"panel",kind:"info",message:"Pipeline tab: app__.input__ present but unsupported/malformed; falling back to srcCanvas",meta:{kind:j}})}const L=e.srcCanvasEl,V=L.width,O=L.height;if(!V||!O)return null;const B=L.getContext("2d",{willReadFrequently:!0});if(!B)return null;const W=B.getImageData(0,0,V,O);return E(W)}function M(){if(n.getVm().input)return;const T=x();T&&n.setInputArtifact(T)}function A(){const I=x();I&&n.setInputArtifact(I)}async function U(){const I=await i.getEffectiveParams("pipeline").catch(()=>({})),T=I==null?void 0:I.mode,L=I==null?void 0:I.recipe,V=typeof T=="string"?T:"segmentation",O=typeof L=="string"?L:"default";n.setActivePipeline(V),n.setActiveRecipe(O),v()}function P(){return o||(G({scope:"panel",kind:"info",message:"Pipeline view: create + mount"}),o=oo({hostEl:e.pipelineViewMountEl,statusEl:e.pipelineStatusEl,handlers:{onSelectPipeline:I=>{G({scope:"panel",kind:"info",message:`Pipeline select: ${I}`}),n.setActivePipeline(I),i.setParamValue("pipeline","mode",I),v(),y()},onSelectRecipe:I=>{G({scope:"panel",kind:"info",message:`Recipe select: ${I}`}),n.setActiveRecipe(I),i.setParamValue("pipeline","recipe",I),y()},onRunAll:()=>void z(),onNext:()=>void N(),onReset:()=>{b()}}}),o.mount(),v(),o)}function y(){P().render(n.getVm())}async function z(){G({scope:"panel",kind:"info",message:"Pipeline run: all"}),A();try{await n.runAll()}finally{Pe(n.getVm()),y(),w()}}async function N(){G({scope:"panel",kind:"info",message:"Pipeline run: next"}),M();try{await n.runNext()}finally{Pe(n.getVm()),y(),w()}}function R(){}async function D(){a=!0,G({scope:"panel",kind:"info",message:"Pipeline tab: mount()"}),A(),await n.reloadCatalogue().catch(()=>null),await U(),p(),G({scope:"panel",kind:"info",message:"Pipeline tab: render()"}),y()}async function k(){a&&(G({scope:"panel",kind:"info",message:"Pipeline tab: refresh()"}),A(),await n.reloadCatalogue().catch(()=>null),await U(),y())}function S(){a=!1,r(),G({scope:"panel",kind:"info",message:"Pipeline tab: unmount()"})}function $(){G({scope:"panel",kind:"info",message:"Pipeline tab: dispose()"}),r(),o==null||o.dispose(),o=null,s=null,h()}return{bind:R,mount:D,unmount:S,refresh:k,dispose:$}}function bt(e){return!!e&&typeof e=="object"}function la(e){if(!bt(e)||typeof e.id!="string"||!e.id||typeof e.title!="string"||!e.title||typeof e.implemented!="boolean"||!Array.isArray(e.ops))return!1;for(const t of e.ops)if(!bt(t)||typeof t.instanceId!="string"||!t.instanceId||typeof t.opId!="string"||!t.opId||t.enabled!==void 0&&typeof t.enabled!="boolean")return!1;return!0}function ca(){const e=ft({userPipelines:[]});async function t(){return await Se().catch(()=>[])}function i(){return e.ops}async function n(){return await Ie().catch(()=>({}))}async function o(r){await Ko(r).catch(()=>null),be({kind:"userPipelines",reason:"delete",pipelineId:r})}async function a(r){await Wo(r).catch(()=>null),be({kind:"userPipelines",reason:"upsert",pipelineId:r.id})}async function s(r){const g=await Ie().catch(()=>({}));!g||typeof g!="object"||(delete g[r],await Re(g).catch(()=>null),be({kind:"recipes",reason:"deleteAllForPipeline",pipelineId:r}))}async function c(r,g){await Jo(r,g).catch(()=>null),be({kind:"recipes",reason:"select",pipelineId:r,recipeId:g})}async function d(r,g){await Zo(r,g).catch(()=>null),be({kind:"recipes",reason:"upsert",pipelineId:r,recipeId:g.id})}async function l(r,g){await Yo(r,g).catch(()=>null),be({kind:"recipes",reason:"delete",pipelineId:r,recipeId:g})}async function f(r){let g;try{g=JSON.parse(r)}catch{throw new Error("Invalid JSON (parse failed).")}let u,b;if(Array.isArray(g))u=g;else if(bt(g)&&Array.isArray(g.pipelines))u=g.pipelines,b=g.recipes;else throw new Error('Invalid file shape. Expected {"pipelines":[...]} or an array of pipelines.');const w=u,h=w.length,m=[];let C=0;for(const x of w){if(!la(x)){C++;continue}m.push(x)}if(m.length===0)throw new Error("No valid pipelines found in the imported file.");const v=await Se().catch(()=>[]),E=new Map;for(const x of v)E.set(x.id,x);for(const x of m)E.set(x.id,x);if(await Je(Array.from(E.values())),be({kind:"userPipelines",reason:"import"}),b!==void 0){if(!Array.isArray(b))throw new Error('Invalid "recipes" shape. Expected an array (or omit the field).');const x=Xo(b);await Re(x).catch(()=>null),be({kind:"recipes",reason:"import"})}return{imported:m.length,skipped:C,totalInFile:h}}async function p(){const r=await Se().catch(()=>[]),g=await Ie().catch(()=>({})),u={format:"beemage.pipeline.userPipelines.v2",exportedAt:new Date().toISOString(),pipelines:r,recipes:Qo(g)};return JSON.stringify(u,null,2)}return{listUserPipelines:t,listOperations:i,importFromJsonText:f,exportToJsonText:p,listAllRecipes:n,deleteUserPipelineById:o,upsertUserPipeline:a,setSelectedRecipe:c,upsertRecipe:d,deleteRecipe:l,deleteAllRecipesForPipeline:s}}function ue(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function da(e){return e.enabled!==!1}function pa(e){const t=new Map;for(const i of e)t.set(i.id,i);return t}function ua(e,t,i){const n={compactOps:i==null?void 0:i.compactOps},o=pa(t),a=ue("div",{class:"pipelineCard"}),s=ue("div",{class:"pipelineCardHead"}),c=ue("div",{style:"display:flex; flex-direction:column; gap:2px;"});c.appendChild(ue("div",{class:"pipelineCardTitle"},e.title||e.id)),s.appendChild(c);{const p=e.implemented?"implemented":"not implemented";s.appendChild(ue("div",{class:"status"},p))}a.appendChild(s);const d=ue("div",{class:"pipelineOps",style:"margin-top:10px;"}),f=Array.isArray(e.ops)?e.ops:[];if(!f.length)return d.appendChild(ue("div",{class:"muted",style:"font-size:12px;"},"No operations in this pipeline.")),a.appendChild(d),a;for(let p=0;p<f.length;p++){const r=f[p],g=o.get(r.opId),u=!da(r),b=g?Ze(g,{compact:n.compactOps,showGroup:!0,showId:!0}):ue("div",{class:"opCard opCard--unknown",style:"padding:10px;"},`Unknown operation: ${r.opId}`);u&&b.classList.add("is-disabled"),d.appendChild(b),p<f.length-1&&d.appendChild(ue("div",{class:"pipelineConnector","aria-hidden":"true"}))}return a.appendChild(d),a}function le(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function ga(e){return JSON.parse(e)}function fa(e){const{pipelineId:t,instanceIds:i,selectedRecipeId:n,recipes:o,handlers:a}=e,s=le("div",{class:"card",style:"padding:10px; margin-top:8px;"});s.appendChild(le("div",{class:"cardTitle"},"Recipes"));const c=le("div",{class:"row",style:"gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px;"});s.appendChild(c);const d=le("label",{class:"fieldInline"});d.appendChild(le("span",{},"Selected"));const l=le("select"),f=le("option");f.value="",f.textContent="None",l.appendChild(f);for(const m of o){const C=le("option");C.value=m.id,C.textContent=`${m.title} (${m.id})`,l.appendChild(C)}l.value=n??"",l.addEventListener("change",()=>{const m=l.value;m&&a.onSelectRecipe(t,m)}),d.appendChild(l),c.appendChild(d);const p=le("button",{class:"btn",type:"button"},"New recipe"),r=le("button",{class:"btn",type:"button"},"Edit recipe"),g=le("button",{class:"btn",type:"button"},"Delete recipe");c.appendChild(p),c.appendChild(r),c.appendChild(g);const u=le("div",{class:"muted",style:"font-size:12px; margin-top:8px;"},`Recipes store only deltas per instanceId. Valid instanceIds: ${i.join(", ")||"(none)"}`);s.appendChild(u);function b(){const m=window.prompt("New recipe id (unique within this pipeline):","new");if(!m)return;const C=window.prompt("Recipe title:",m);C&&a.onUpsertRecipe(t,{id:m,title:C,ops:[]})}function w(){const m=(n??l.value)||"";if(!m){window.alert("Select a recipe first.");return}const C=o.find(x=>x.id===m);if(!C){window.alert("Recipe not found.");return}const v={id:C.id,title:C.title,ops:C.ops},E=window.prompt(`Edit recipe JSON (pipeline=${t}).

Structure: { id, title, ops: [{ instanceId, enabled?, override?: { enginePolicy?, params? } }] }

`,JSON.stringify(v,null,2));if(E)try{const x=ga(E);if(typeof x.id!="string"||!x.id)throw new Error("Missing recipe.id");if(typeof x.title!="string"||!x.title)throw new Error("Missing recipe.title");if(!Array.isArray(x.ops))throw new Error("Missing recipe.ops array");for(const M of x.ops){if(!M||typeof M!="object")throw new Error("Invalid patch object in ops");if(typeof M.instanceId!="string"||!M.instanceId)throw new Error("Patch missing instanceId");i.length&&!i.includes(M.instanceId)&&console.warn("Recipe patch references unknown instanceId",t,M.instanceId)}a.onUpsertRecipe(t,{id:x.id,title:x.title,ops:x.ops})}catch(x){const M=x instanceof Error?x.message:String(x);window.alert(`Invalid recipe JSON: ${M}`)}}function h(){const m=(n??l.value)||"";if(!m){window.alert("Select a recipe first.");return}window.confirm(`Delete recipe "${m}" from pipeline "${t}"?`)&&a.onDeleteRecipe(t,m)}return p.addEventListener("click",b),r.addEventListener("click",w),g.addEventListener("click",h),o.length||(r.disabled=!0,g.disabled=!0),s}function we(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function ha(e){return JSON.parse(e)}function ma(e){const{pipeline:t,opsLibrary:i,selectedRecipeId:n,recipes:o,handlers:a}=e,s=we("div",{class:"card",style:"padding:10px; margin-top:10px;"}),c=we("div",{class:"row",style:"justify-content:space-between; align-items:center; gap:10px;"}),d=we("div",{class:"cardTitle"},`${t.title} (${t.id})`);c.appendChild(d);const l=we("div",{class:"row",style:"gap:8px; align-items:center;"}),f=we("button",{class:"btn",type:"button"},"Edit"),p=we("button",{class:"btn",type:"button"},"Delete");l.appendChild(f),l.appendChild(p),c.appendChild(l),s.appendChild(c),t.description&&s.appendChild(we("div",{class:"muted",style:"font-size:12px; margin-top:6px;"},t.description));const r=we("div",{style:"margin-top:10px;"});r.appendChild(ua(t,i,{compactOps:!0})),s.appendChild(r);const g=t.ops.map(w=>w.instanceId);s.appendChild(fa({pipelineId:t.id,instanceIds:g,selectedRecipeId:n,recipes:o,handlers:a}));function u(){const w={id:t.id,title:t.title,description:t.description??"",implemented:t.implemented,ops:t.ops},h=window.prompt(`Edit pipeline JSON.

Structure: { id, title, description?, implemented, ops: [{ instanceId, opId, enabled?, override? }] }

`,JSON.stringify(w,null,2));if(h)try{const m=ha(h);if(!m||typeof m!="object")throw new Error("Invalid JSON object");if(typeof m.id!="string"||!m.id)throw new Error("Missing pipeline.id");if(typeof m.title!="string"||!m.title)throw new Error("Missing pipeline.title");if(typeof m.implemented!="boolean")throw new Error("Missing pipeline.implemented boolean");if(!Array.isArray(m.ops))throw new Error("Missing pipeline.ops array");for(const C of m.ops){if(!C||typeof C!="object")throw new Error("Invalid op entry");if(typeof C.instanceId!="string"||!C.instanceId)throw new Error("Op missing instanceId");if(typeof C.opId!="string"||!C.opId)throw new Error("Op missing opId");if(C.enabled!==void 0&&typeof C.enabled!="boolean")throw new Error("Op.enabled must be boolean")}a.onUpsertPipeline(m)}catch(m){const C=m instanceof Error?m.message:String(m);window.alert(`Invalid pipeline JSON: ${C}`)}}function b(){window.confirm(`Delete pipeline "${t.id}"? This also deletes its recipes.`)&&a.onDeletePipeline(t.id)}return f.addEventListener("click",u),p.addEventListener("click",b),s}function Z(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function Wt(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function ya(e,t){return`${e}.${t+1}`}function ba(e){const t=new Map;for(const i of e)t.set(i.id,i);return t}function Kt(e,t){const i=[];for(const n of e.opIds){const o=t.get(n);o&&i.push(o)}return i}function wa(e,t){let i=t;for(const n of e){if(n.io.input!==i)return i;i=n.io.output}return i}function va(e){const{mountEl:t,onSavePipeline:i}=e;let n=!1,o=[],a=new Map,s="info",c="Drag an operation from the left and drop it into a slot.",d=null;function l(C){const v="margin-top:10px; padding:8px 10px; border-radius:10px; font-size:12px; border:1px solid rgba(255,255,255,0.12);";return C==="error"?v+" background: rgba(255, 80, 80, 0.10);":C==="info"?v+" background: rgba(255, 200, 80, 0.10);":v+" background: rgba(80, 160, 255, 0.08);"}function f(C,v){s=C,c=v,d&&(d.setAttribute("style",l(C)),d.textContent=v)}function p(C){return C&&(C.getData("application/x-beemage-opid")||C.getData("text/plain"))||""}const r={id:"myPipeline",title:"My pipeline",description:"",implemented:!0,opIds:[],startType:"imageList"};function g(C,v){r.opIds.splice(C,0,v)}function u(C){r.opIds.splice(C,1)}function b(C,v){const E=C+v;if(E<0||E>=r.opIds.length)return;const x=r.opIds[C];r.opIds[C]=r.opIds[E],r.opIds[E]=x}function w(C,v){const E=a.get(v);if(!E)return{ok:!1,reason:"Unknown op"};const x=Kt(r,a),M=_t({specs:x,startType:r.startType,index:C}),A=C<x.length?x[C].io.input:void 0;return jo({beforeType:M,afterType:A,op:E})}function h(){const C=r.id.trim(),v=r.title.trim();if(!C){window.alert("Pipeline id is required.");return}if(!v){window.alert("Pipeline title is required.");return}const E=[];for(const A of r.opIds){const U=a.get(A);if(!U){window.alert(`Unknown operation in draft: ${A}`);return}E.push(U)}const x={id:C,title:v,description:r.description||void 0,implemented:!!r.implemented,ops:r.opIds.map((A,U)=>({instanceId:ya(C,U),opId:A,enabled:!0}))};let M=r.startType;for(let A=0;A<E.length;A++){const U=E[A];if(U.io.input!==M){window.alert(`Invalid typing at step ${A+1}: "${U.title}" needs ${U.io.input} but current is ${M}`);return}M=U.io.output}i(x)}function m(){if(n)return;Wt(t);const C=Z("div",{class:"card",style:"padding:10px;"});C.appendChild(Z("div",{class:"cardTitle"},"Pipeline playground"));const v=Z("div",{class:"row",style:"gap:10px; flex-wrap:wrap; align-items:flex-end; margin-top:10px;"}),E=Z("label",{class:"fieldInline"});E.appendChild(Z("span",{},"Id"));const x=Z("input",{type:"text",value:r.id,style:"min-width:200px;"});x.addEventListener("input",()=>{r.id=x.value}),E.appendChild(x);const M=Z("label",{class:"fieldInline"});M.appendChild(Z("span",{},"Title"));const A=Z("input",{type:"text",value:r.title,style:"min-width:240px;"});A.addEventListener("input",()=>{r.title=A.value}),M.appendChild(A);const U=Z("label",{class:"fieldInline"});U.appendChild(Z("span",{},"Start type"));const P=Z("select"),y=["image","imageList","mask","svg","pdf"];for(const O of y){const B=Z("option");B.value=O,B.textContent=O,O===r.startType&&(B.selected=!0),P.appendChild(B)}P.addEventListener("change",()=>{const O=String(P.value);r.startType=O,f("info",`Start type set to "${O}".`),m()}),U.appendChild(P);const z=Z("label",{class:"fieldInline"});z.appendChild(Z("span",{},"Implemented"));const N=Z("input",{type:"checkbox"});N.checked=!!r.implemented,N.addEventListener("change",()=>{r.implemented=!!N.checked}),z.appendChild(N);const R=Z("button",{type:"button",class:"btn"},"Clear");R.addEventListener("click",()=>{r.opIds=[],m()});const D=Z("button",{type:"button",class:"btn"},"Save pipeline");D.addEventListener("click",h),v.appendChild(E),v.appendChild(M),v.appendChild(U),v.appendChild(z),v.appendChild(R),v.appendChild(D),C.appendChild(v);const k=Z("label",{style:"display:block; margin-top:10px;"});k.appendChild(Z("div",{class:"muted",style:"font-size:12px; margin-bottom:4px;"},"Description"));const S=Z("textarea",{style:"width:100%; min-height:54px;"});S.value=r.description,S.addEventListener("input",()=>{r.description=S.value}),k.appendChild(S),C.appendChild(k);const $=Kt(r,a),I=wa($,r.startType),T=Z("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},`Start: ${r.startType}  →  Current output: ${I}`);C.appendChild(T),d=Z("div",{style:l(s)},c),C.appendChild(d);const L=Z("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:8px;"});L.appendChild(Z("div",{style:"border:1px dashed rgba(255,255,255,0.18); border-radius:10px; padding:8px; background:rgba(0,0,0,0.08);"},`Input (${r.startType})`));function V(O){const B=Z("div",{"data-slot-index":String(O),style:"min-height:46px; display:flex; align-items:center; justify-content:center; border:1px dashed rgba(255,255,255,0.14); border-radius:10px; padding:8px; background:rgba(0,0,0,0.05); text-align:center; font-size:12px; cursor:copy;"}),W=_t({specs:$,startType:r.startType,index:O}),j=O<$.length?$[O].io.input:void 0;return B.textContent=j?`Drop here (slot type: ${W} → next needs: ${j})`:`Drop here (slot type: ${W})`,B.addEventListener("dragenter",H=>{H.preventDefault(),B.style.background="rgba(80, 160, 255, 0.08)"}),B.addEventListener("dragover",H=>{H.preventDefault(),H.dataTransfer&&(H.dataTransfer.dropEffect="copy");const q=p(H.dataTransfer);if(!q)return;const Y=w(O,q);B.style.background=Y.ok?"rgba(80, 255, 140, 0.08)":"rgba(255, 80, 80, 0.06)"}),B.addEventListener("dragleave",()=>{B.style.background="rgba(0,0,0,0.05)"}),B.addEventListener("drop",H=>{H.preventDefault(),B.style.background="rgba(0,0,0,0.05)";const q=p(H.dataTransfer);if(!q){f("error","Drop refused: could not read operation id from the drag payload."),ne({scope:"panel",kind:"error",message:"Builder playground drop refused (missing opId)",meta:{index:O}});return}const Y=w(O,q);if(!Y.ok){f("info",`Drop refused: ${Y.reason??"operation cannot be inserted here."}`),ne({scope:"panel",kind:"info",message:"Builder playground drop refused (typing mismatch)",meta:{index:O,opId:q,reason:Y.reason??""}});return}g(O,q),f("info",`Inserted "${q}" at position ${O+1}.`),ne({scope:"panel",kind:"info",message:"Builder playground op inserted",meta:{index:O,opId:q}}),m()}),B}for(let O=0;O<=r.opIds.length;O++)if(L.appendChild(V(O)),O<r.opIds.length){const B=r.opIds[O],W=a.get(B),j=Z("div",{class:"row",style:"gap:8px; align-items:flex-start;"}),H=Z("div",{style:"flex:1;"});W?H.appendChild(Ze(W,{compact:!0,showGroup:!0,showId:!0,portStyle:"puzzle",cardStyle:"puzzleFrame"})):H.appendChild(Z("div",{class:"muted"},`Unknown op: ${B}`));const q=Z("div",{style:"display:flex; flex-direction:column; gap:6px;"}),Y=Z("button",{type:"button",class:"btn"},"Up");Y.disabled=O===0,Y.addEventListener("click",()=>{b(O,-1),m()});const F=Z("button",{type:"button",class:"btn"},"Down");F.disabled=O===r.opIds.length-1,F.addEventListener("click",()=>{b(O,1),m()});const ee=Z("button",{type:"button",class:"btn"},"Remove");ee.addEventListener("click",()=>{u(O),m()}),q.appendChild(Y),q.appendChild(F),q.appendChild(ee),j.appendChild(H),j.appendChild(q),L.appendChild(j)}C.appendChild(L),t.appendChild(C)}return{render(C){o=C.opsLibrary??[],a=ba(o),m()},dispose(){n=!0,Wt(t)}}}function K(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function Ca(e){const{dom:t,handlers:i}=e;let n=!1,o=!1,a="all",s="all",c=null,d=null,l="",f=null,p=null,r=null,g=null,u=null,b=null,w=null,h=null;function m(){if(p)return p;const R=K("div",{"data-role":"builderListMount",style:"margin-top:12px;"});return t.viewBuilder.appendChild(R),p=R,R}function C(){if(v(),r)return r;const R=K("div",{"data-role":"builderOpsMount"});return(u??t.viewBuilder).appendChild(R),r=R,R}function v(){g||(g=K("div",{"data-role":"builderLayout",style:"display:flex; gap:12px; align-items:flex-start; margin-top:12px;"}),u=K("div",{"data-role":"builderLeftCol",style:"flex:1; min-width:320px;"}),b=K("div",{"data-role":"builderRightCol",style:"flex:1; min-width:320px;"}),g.appendChild(u),g.appendChild(b),t.viewBuilder.appendChild(g))}function E(R,D){const k=K("select"),S=[{value:"all",label:"All"},{value:"image",label:"image"},{value:"mask",label:"mask"},{value:"svg",label:"svg"}];for(const $ of S){const I=K("option");I.value=$.value,I.textContent=$.label,$.value===R&&(I.selected=!0),k.appendChild(I)}return k.addEventListener("change",()=>D(k.value)),k}function x(){if(v(),w)return w;const R=K("div",{"data-role":"builderPlaygroundMount"});return(b??t.viewBuilder).appendChild(R),w=R,h=va({mountEl:w,onSavePipeline:async D=>{await i.onUpsertPipeline(D)}}),R}function M(R){const D=a==="all"?!0:R.io.input===a,k=s==="all"?!0:R.io.output===s;return D&&k}function A(R,D){const k=C();k.innerHTML="";const S=K("div",{class:"card",style:"padding:10px;"});S.appendChild(K("div",{class:"cardTitle"},"All operations"));let $=(D==null?void 0:D._opsQuery)??"",I=(D==null?void 0:D._opsDedupe)??!0;const T=K("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px;"}),L=K("label",{class:"fieldInline"});L.appendChild(K("span",{},"Search"));const V=K("input",{type:"text",value:$,placeholder:"Type to filter (title / id / group)…",style:"min-width:260px;"}),O=K("label",{class:"fieldInline"});O.appendChild(K("span",{},"Hide duplicates"));const B=K("input",{type:"checkbox"});B.checked=I;const W=K("label",{class:"fieldInline"});W.appendChild(K("span",{},"Filter input")),c=E(String(a),F=>{a=F==="all"?"all":F,A(R,D)}),W.appendChild(c);const j=K("label",{class:"fieldInline"});j.appendChild(K("span",{},"Filter output")),d=E(String(s),F=>{s=F==="all"?"all":F,A(R,D)}),j.appendChild(d),V.addEventListener("input",()=>{$=V.value,D&&(D._opsQuery=$),A(R,D)}),B.addEventListener("change",()=>{I=B.checked,D&&(D._opsDedupe=I),A(R,D)}),T.appendChild(L),T.appendChild(V),T.appendChild(O),T.appendChild(B),T.appendChild(W),T.appendChild(j),S.appendChild(T);const H=$.trim().toLowerCase();let q=R.filter(M);if(H&&(q=q.filter(F=>`${F.title} ${F.id} ${String(F.group??"")} ${String(F.dispatchId??"")}`.toLowerCase().includes(H))),I){const F=new Set,ee=[];for(const Q of q){const ce=`${Q.title}|${Q.io.input}->${Q.io.output}|${Q.kind}`;F.has(ce)||(F.add(ce),ee.push(Q))}q=ee}if(!q.length){S.appendChild(K("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No operations match the filters.")),k.appendChild(S);return}const Y=K("div",{class:"opsGrid",style:"margin-top:10px;"});for(const F of q){const ee=Ze(F,{compact:!0,showGroup:!0,showId:!0,portStyle:"puzzle",cardStyle:"plain"});ee.setAttribute("draggable","true"),ee.addEventListener("dragstart",Q=>{var ce,pe;(ce=Q.dataTransfer)==null||ce.setData("application/x-beemage-opid",F.id),(pe=Q.dataTransfer)==null||pe.setData("text/plain",F.id),Q.dataTransfer&&(Q.dataTransfer.effectAllowed="copy")}),Y.appendChild(ee)}S.appendChild(Y),k.appendChild(S)}function U(R,D){const k=m();k.innerHTML="";const S=K("div",{class:"card",style:"padding:10px;"});S.appendChild(K("div",{class:"cardTitle"},"Stored user pipelines"));const $=K("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px;"}),I=Array.isArray(D.examples)?D.examples:[],T=K("label",{class:"fieldInline"});T.appendChild(K("span",{},"Load example"));const L=K("select",{style:"min-width:260px;"});{const F=K("option");F.value="",F.textContent=I.length?"Select an example…":"No examples available",F.selected=!0,L.appendChild(F)}for(const F of I){const ee=K("option");ee.value=String(F.path??""),ee.textContent=String(F.title??F.id??F.path??"Example"),L.appendChild(ee)}T.appendChild(L);const V=K("button",{type:"button",class:"btn",style:"padding:4px 10px; font-size:12px;"},"Load");V.disabled=!0,L.addEventListener("change",()=>{V.disabled=!L.value}),V.addEventListener("click",()=>{const F=L.value;F&&(i.onLoadExample(F),L.value="",V.disabled=!0)});const O=K("label",{class:"fieldInline"});O.appendChild(K("span",{},"Filter pipelines")),f=K("input",{type:"text",value:l,placeholder:"Search by id or title…",style:"min-width:260px;"}),f.addEventListener("input",()=>{l=f?f.value:"",U(D.pipelines,D)}),O.appendChild(f);const B=K("button",{type:"button",class:"btn",style:"padding:4px 10px; font-size:12px;"},"Clear");B.addEventListener("click",()=>{l="",f&&(f.value=""),U(D.pipelines,D)}),$.appendChild(T),$.appendChild(V),$.appendChild(O),$.appendChild(B),S.appendChild($);const W=Array.isArray(D.userPipelinesRaw)?D.userPipelinesRaw:[];if(!W.length){S.appendChild(K("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No user pipelines stored.")),k.appendChild(S);return}const j=l.trim().toLowerCase(),H=j.length===0?W:W.filter(F=>{const ee=String(F.id??"").toLowerCase(),Q=String(F.title??"").toLowerCase();return ee.includes(j)||Q.includes(j)});if(!H.length){S.appendChild(K("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No pipelines match the search.")),k.appendChild(S);return}const q=K("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:10px;"}),Y=D.recipesAll??{};for(const F of H){const ee=(Y==null?void 0:Y[F.id])??{recipesById:{},selectedRecipeId:void 0},Q=(ee==null?void 0:ee.recipesById)??{},ce=Object.values(Q),pe=ee==null?void 0:ee.selectedRecipeId;q.appendChild(ma({pipeline:F,opsLibrary:D.ops??[],selectedRecipeId:pe,recipes:ce,handlers:{onDeletePipeline:i.onDeletePipeline,onUpsertPipeline:i.onUpsertPipeline,onSelectRecipe:i.onSelectRecipe,onUpsertRecipe:i.onUpsertRecipe,onDeleteRecipe:i.onDeleteRecipe}}))}S.appendChild(q),k.appendChild(S)}function P(){o||(o=!0,t.builderImportFileEl.addEventListener("change",()=>{var R;(R=t.builderImportFileEl.files)==null||R[0]}),t.btnBuilderExportEl.addEventListener("click",()=>{i.onExport()}),t.builderImportFileEl.addEventListener("change",()=>{var D;const R=((D=t.builderImportFileEl.files)==null?void 0:D[0])??null;R&&(i.onImportFile(R),t.builderImportFileEl.value="")}))}function y(){n||(n=!0,v(),C(),x(),m())}function z(R){t.builderStatusEl.textContent=R.statusText||"Idle",v(),C(),x(),m(),h==null||h.render({opsLibrary:R.ops??[]}),A(R.ops??[],R),U(R.pipelines,R)}function N(){n=!1,o=!1,a="all",s="all",l="",f=null,c=null,d=null,p&&(p.innerHTML="",p.remove(),p=null),r&&(r.innerHTML="",r.remove(),r=null),h==null||h.dispose(),h=null,w&&(w.innerHTML="",w.remove(),w=null),g&&(g.innerHTML="",g.remove(),g=null,u=null,b=null)}return{bind:P,mount:y,render:z,dispose:N}}function Ea(e,t){const i=new Blob([t],{type:"application/json;charset=utf-8"}),n=URL.createObjectURL(i),o=document.createElement("a");o.href=n,o.download=e,o.rel="noopener",o.click(),setTimeout(()=>URL.revokeObjectURL(n),500)}function xa(e,t){const i=ca();let n=!1,o={},a=[],s="Idle",c=[],d=i.listOperations();async function l(){const v=kt("assets/pipelines/index.json"),E=await fetch(v,{cache:"no-store"});if(!E.ok)throw new Error(`Examples index not found: ${E.status}`);const x=await E.json().catch(()=>null),M=x==null?void 0:x.examples;return Array.isArray(M)?M.map(A=>({id:String((A==null?void 0:A.id)??""),title:String((A==null?void 0:A.title)??(A==null?void 0:A.id)??(A==null?void 0:A.path)??"Example"),path:String((A==null?void 0:A.path)??"")})).filter(A=>A.id&&A.path):[]}async function f(v){const E=kt(v),x=await fetch(E,{cache:"no-store"});if(!x.ok)throw new Error(`Example fetch failed (${x.status}): ${v}`);const M=await x.text();await i.importFromJsonText(M)}const p=Ca({dom:e,handlers:{onImportFile:async v=>{try{s=`Importing: ${v.name}`,u();const E=await v.text(),x=await i.importFromJsonText(E);G({scope:"panel",kind:"info",message:`Builder import: imported=${x.imported}, skipped=${x.skipped}, total=${x.totalInFile}`}),s=`Imported ${x.imported} pipeline(s) (skipped ${x.skipped}).`,await r()}catch(E){const x=E instanceof Error?E.message:String(E);G({scope:"panel",kind:"error",message:`Builder import failed: ${x}`}),ne({scope:"panel",kind:"error",message:"Builder import failed",meta:{error:x}}),s=`Import failed: ${x}`,u()}},onExport:async()=>{try{s="Exporting…",u();const v=await i.exportToJsonText();Ea("beemage-user-pipelines.json",v),G({scope:"panel",kind:"info",message:"Builder export: downloaded beemage-user-pipelines.json"}),s="Exported.",u()}catch(v){const E=v instanceof Error?v.message:String(v);G({scope:"panel",kind:"error",message:`Builder export failed: ${E}`}),ne({scope:"panel",kind:"error",message:"Builder export failed",meta:{error:E}}),s=`Export failed: ${E}`,u()}},onDeletePipeline:async v=>{try{await i.deleteUserPipelineById(v),await i.deleteAllRecipesForPipeline(v),G({scope:"panel",kind:"info",message:`Builder: deleted user pipeline "${v}" (and its recipes)`}),s=`Deleted pipeline ${v}.`,await r()}catch(E){const x=E instanceof Error?E.message:String(E);G({scope:"panel",kind:"error",message:`Delete pipeline failed: ${x}`}),ne({scope:"panel",kind:"error",message:"Delete pipeline failed",meta:{pipelineId:v,error:x}}),s=`Delete failed: ${x}`,u()}},onUpsertPipeline:async v=>{try{await i.upsertUserPipeline(v),G({scope:"panel",kind:"info",message:`Builder: saved user pipeline "${String((v==null?void 0:v.id)??"")}"`}),s=`Saved pipeline ${String((v==null?void 0:v.id)??"")}.`,await r()}catch(E){const x=E instanceof Error?E.message:String(E);G({scope:"panel",kind:"error",message:`Save pipeline failed: ${x}`}),ne({scope:"panel",kind:"error",message:"Save pipeline failed",meta:{error:x}}),s=`Save failed: ${x}`,u()}},onSelectRecipe:async(v,E)=>{try{await i.setSelectedRecipe(v,E),G({scope:"panel",kind:"info",message:`Builder: selected recipe "${E}" for pipeline "${v}"`}),s=`Selected recipe ${E} for ${v}.`,await r()}catch(x){const M=x instanceof Error?x.message:String(x);G({scope:"panel",kind:"error",message:`Select recipe failed: ${M}`}),ne({scope:"panel",kind:"error",message:"Select recipe failed",meta:{pipelineId:v,recipeId:E,error:M}}),s=`Select recipe failed: ${M}`,u()}},onUpsertRecipe:async(v,E)=>{try{await i.upsertRecipe(v,E),G({scope:"panel",kind:"info",message:`Builder: saved recipe "${String((E==null?void 0:E.id)??"")}" for pipeline "${v}"`}),s=`Saved recipe ${String((E==null?void 0:E.id)??"")} for ${v}.`,await r()}catch(x){const M=x instanceof Error?x.message:String(x);G({scope:"panel",kind:"error",message:`Save recipe failed: ${M}`}),ne({scope:"panel",kind:"error",message:"Save recipe failed",meta:{pipelineId:v,error:M}}),s=`Save recipe failed: ${M}`,u()}},onDeleteRecipe:async(v,E)=>{try{await i.deleteRecipe(v,E),G({scope:"panel",kind:"info",message:`Builder: deleted recipe "${E}" from pipeline "${v}"`}),s=`Deleted recipe ${E} from ${v}.`,await r()}catch(x){const M=x instanceof Error?x.message:String(x);G({scope:"panel",kind:"error",message:`Delete recipe failed: ${M}`}),ne({scope:"panel",kind:"error",message:"Delete recipe failed",meta:{pipelineId:v,recipeId:E,error:M}}),s=`Delete recipe failed: ${M}`,u()}},onLoadExample:async v=>{try{s=`Loading example: ${v}`,u(),await f(v),G({scope:"panel",kind:"info",message:`Builder example loaded: ${v}`}),s=`Loaded example: ${v}`,await r()}catch(E){const x=E instanceof Error?E.message:String(E);G({scope:"panel",kind:"error",message:`Load example failed: ${x}`}),ne({scope:"panel",kind:"error",message:"Load example failed",meta:{error:x,examplePath:v}}),s=`Load example failed: ${x}`,u()}}}});async function r(){const v=await i.listUserPipelines().catch(()=>[]);c=v,d=i.listOperations(),o=await i.listAllRecipes().catch(()=>({})),a=await l().catch(()=>[]),s=`Ready. User pipelines: ${v.length} · Operations: ${d.length} · Examples: ${a.length}`,u()}function g(){const v=c??[];return{statusText:s,pipelines:v.map(E=>({id:String(E.id),title:String(E.title),implemented:!!E.implemented,opCount:Array.isArray(E.ops)?E.ops.length:0})),userPipelinesRaw:v,ops:d,recipesAll:o??{},examples:a??[]}}function u(){p.mount(),p.render(g())}function b(){p.bind(),e.builderStatusEl.textContent="Idle"}async function w(){n=!0,s="Loading…",u(),await r()}async function h(){n&&(s="Refreshing…",u(),await r())}function m(){n=!1}function C(){p.dispose()}return{bind:b,mount:w,refresh:h,unmount:m,dispose:C}}async function ka(){const e=Dn();await lt().catch(()=>null);const t=Bn();t.start();const i=Nn();globalThis.app__={...globalThis.app__,cache:i};const n=Hi({getRuntimeAvailability:()=>({opencvReady:!1}),debugTraceAppend:p=>ne({scope:"panel",kind:"debug",message:p}),actionLogAppend:p=>G({scope:"panel",kind:"info",message:p})});n.mount({mountEl:e.tuningMountEl,scopeRootId:"app"});const o=ei(e),a=di(e),s=ra(e,t,n),c=Ui(e,t),d=Ni(e),l=xa(e);o.bind(),s.bind(),a.bind(),c.bind(),d.bind(),l.bind();const f=Vn(e,{image:o,pipeline:s,builder:l,colors:a,settings:c,logs:d});f.bind(),f.boot()}ka();
