function dn(){function e(Ve,un){if(!Ve)throw new Error(`[dom] Missing #${un}`);return Ve}const t=e(document.getElementById("appRoot"),"appRoot"),o=e(document.getElementById("tabContour"),"tabContour"),n=e(document.getElementById("tabColors"),"tabColors"),a=e(document.getElementById("tabSettings"),"tabSettings"),s=e(document.getElementById("tabLogs"),"tabLogs"),r=e(document.getElementById("tabSegmentation"),"tabSegmentation"),g=e(document.getElementById("viewContour"),"viewContour"),p=e(document.getElementById("viewColors"),"viewColors"),l=e(document.getElementById("viewSettings"),"viewSettings"),c=e(document.getElementById("viewLogs"),"viewLogs"),v=e(document.getElementById("viewSegmentation"),"viewSegmentation"),h=e(document.getElementById("dropZone"),"dropZone"),d=e(document.getElementById("fileInput"),"fileInput"),i=e(document.getElementById("btnProcess"),"btnProcess"),u=e(document.getElementById("btnClean"),"btnClean"),f=e(document.getElementById("btnDownload"),"btnDownload"),m=e(document.getElementById("contourStatus"),"contourStatus"),b=e(document.getElementById("contourSpinner"),"contourSpinner"),E=e(document.getElementById("srcCanvas"),"srcCanvas"),C=e(document.getElementById("outCanvas"),"outCanvas"),S=e(document.getElementById("clean1Canvas"),"clean1Canvas"),x=e(document.getElementById("clean2Canvas"),"clean2Canvas"),R=e(document.getElementById("cleanQualityBadge"),"cleanQualityBadge"),D=e(document.getElementById("cleanQualityFill"),"cleanQualityFill"),k=e(document.getElementById("cleanQualityText"),"cleanQualityText"),y=e(document.getElementById("btnVectorize"),"btnVectorize"),w=e(document.getElementById("btnDownloadSvg"),"btnDownloadSvg"),B=e(document.getElementById("svgPreviewImg"),"svgPreviewImg"),I=e(document.getElementById("svgPreviewText"),"svgPreviewText"),M=e(document.getElementById("contourTuningMount"),"contourTuningMount"),L=e(document.getElementById("segPresetList"),"segPresetList"),N=e(document.getElementById("segRecipeDrop"),"segRecipeDrop"),F=e(document.getElementById("segStepResize"),"segStepResize"),Z=e(document.getElementById("segStepDenoise"),"segStepDenoise"),ee=e(document.getElementById("segStepColor"),"segStepColor"),G=e(document.getElementById("segStepThreshold"),"segStepThreshold"),se=e(document.getElementById("segStepMorphology"),"segStepMorphology"),ht=e(document.getElementById("segRunBtn"),"segRunBtn"),vt=e(document.getElementById("segStatus"),"segStatus"),bt=e(document.getElementById("segMaskCanvas"),"segMaskCanvas"),yt=e(document.getElementById("segNextBtn"),"segNextBtn"),Et=e(document.getElementById("segResetBtn"),"segResetBtn"),Ct=e(document.getElementById("colorsCanvas"),"colorsCanvas"),wt=e(document.getElementById("palette"),"palette"),St=e(document.getElementById("btnColorsApply"),"btnColorsApply"),xt=e(document.getElementById("btnColorsCancel"),"btnColorsCancel"),kt=e(document.getElementById("btnColorsReset"),"btnColorsReset"),Dt=e(document.getElementById("edgesDark"),"edgesDark"),Rt=e(document.getElementById("edgeMaskThreshold"),"edgeMaskThreshold"),Tt=e(document.getElementById("edgeDilate"),"edgeDilate"),It=e(document.getElementById("maxRegionPx"),"maxRegionPx"),Mt=e(document.getElementById("colorsStatus"),"colorsStatus"),Lt=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),Pt=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),Bt=e(document.getElementById("devConfigDetails"),"devConfigDetails"),At=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),Ot=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),$t=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),Vt=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),Nt=e(document.getElementById("logsCbDebug"),"logsCbDebug"),Ut=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),zt=e(document.getElementById("cfgStatus"),"cfgStatus"),Ft=e(document.getElementById("cfgOpenCvSpinner"),"cfgOpenCvSpinner"),jt=e(document.getElementById("cfgOpenCvStatus"),"cfgOpenCvStatus"),_t=e(document.getElementById("cfgOpenCvReport"),"cfgOpenCvReport"),qt=e(document.getElementById("settingsEngineBox"),"settingsEngineBox"),Gt=e(document.getElementById("cfgUseOpenCv"),"cfgUseOpenCv"),Kt=e(document.getElementById("tuningMount"),"tuningMount"),Qt=e(document.getElementById("settingsVersion"),"settingsVersion"),Ht=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),Wt=e(document.getElementById("logsLimit"),"logsLimit"),Yt=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),Jt=e(document.getElementById("logsStatus"),"logsStatus"),Xt=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),Zt=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),en=e(document.getElementById("btnLogsExport"),"btnLogsExport"),tn=e(document.getElementById("btnLogsClear"),"btnLogsClear"),nn=e(document.getElementById("logsOut"),"logsOut"),on=e(document.getElementById("debugLimit"),"debugLimit"),an=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),sn=e(document.getElementById("btnDebugExport"),"btnDebugExport"),rn=e(document.getElementById("btnDebugClear"),"btnDebugClear"),ln=e(document.getElementById("debugStatus"),"debugStatus"),cn=e(document.getElementById("debugOut"),"debugOut");return{rootEl:t,tabContour:o,tabColors:n,tabSettings:a,tabLogs:s,tabSegmentation:r,viewContour:g,viewSegmentation:v,viewColors:p,viewSettings:l,viewLogs:c,dropZoneEl:h,fileInputEl:d,btnProcessEl:i,btnCleanEl:u,btnDownloadEl:f,contourStatusEl:m,contourSpinnerEl:b,srcCanvasEl:E,outCanvasEl:C,clean1CanvasEl:S,clean2CanvasEl:x,cleanQualityBadgeEl:R,cleanQualityFillEl:D,cleanQualityTextEl:k,btnVectorizeEl:y,btnDownloadSvgEl:w,svgPreviewImgEl:B,svgPreviewTextEl:I,contourTuningMountEl:M,segPresetListEl:L,segRecipeDropEl:N,segStepResizeEl:F,segStepDenoiseEl:Z,segStepColorEl:ee,segStepThresholdEl:G,segStepMorphologyEl:se,segRunBtn:ht,segStatusEl:vt,segMaskCanvasEl:bt,segNextBtn:yt,segResetBtn:Et,colorsCanvasEl:Ct,paletteEl:wt,btnColorsApplyEl:St,btnColorsCancelEl:xt,btnColorsResetEl:kt,edgesDarkEl:Dt,edgeMaskThresholdEl:Rt,edgeDilateEl:Tt,maxRegionPxEl:It,colorsStatusEl:Mt,cfgShowDevToolsEl:Lt,settingsGeneralStatusEl:Pt,devConfigDetailsEl:Bt,cfgTraceConsoleEl:At,cfgActionLogMaxEl:Ot,cfgDebugTraceMaxEl:$t,cfgFailureLogsPerRunEl:Vt,logsCbDebugEl:Nt,btnCfgResetDefaults:Ut,cfgStatusEl:zt,settingsVersionEl:Qt,settingsGitHubLinkEl:Ht,cfgOpenCvSpinner:Ft,cfgOpenCvStatus:jt,cfgOpenCvReport:_t,settingsEngineBoxEl:qt,cfgUseOpenCvEl:Gt,tuningMountEl:Kt,logsLimitEl:Wt,btnLogsRefresh:Yt,logsStatusEl:Jt,logsTrimKeepEl:Xt,btnLogsTrim:Zt,btnLogsExport:en,btnLogsClear:tn,logsOutEl:nn,debugLimitEl:on,btnDebugRefresh:an,btnDebugExport:sn,btnDebugClear:rn,debugStatusEl:ln,debugOutEl:cn}}const gn=new Set;function fn(e){gn.add(e)}function pn(){const e=new Set;function t(n){return e.add(n),()=>e.delete(n)}function o(){fn(a=>{for(const s of e)s(a)})}return{on:t,start:o}}const mn=new Set;function Je(e){for(const t of mn)t(e,"local")}function te(e){const t=localStorage.getItem(e);if(t!==null)try{return JSON.parse(t)}catch{return t}}function hn(e,t){localStorage.setItem(e,JSON.stringify(t))}async function Y(e){if(typeof e=="string")return{[e]:te(e)};if(Array.isArray(e)){const o={};for(const n of e)o[n]=te(n);return o}const t={};for(const[o,n]of Object.entries(e))t[o]=localStorage.getItem(o)!==null?te(o):n;return t}async function J(e){const t={};for(const[o,n]of Object.entries(e)){const a=te(o);hn(o,n),t[o]={oldValue:a,newValue:n}}Je(t)}async function Le(e){const t=Array.isArray(e)?e:[e],o={};for(const n of t){const a=te(n);localStorage.removeItem(n),o[n]={oldValue:a,newValue:void 0}}Je(o)}function q(e,t,o,n){const a=Number(String(e??"").trim());return Number.isFinite(a)?Math.max(t,Math.min(o,Math.floor(a))):n}const ke="beecontour.devConfig",z={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let De=!1,re={...z};function Xe(e){const t=e||{};return{traceConsole:!!t.traceConsole,actionLogMax:q(t.actionLogMax??z.actionLogMax,100,5e4,z.actionLogMax),debugTraceMax:q(t.debugTraceMax??z.debugTraceMax,100,5e4,z.debugTraceMax),failureLogsPerRun:q(t.failureLogsPerRun??z.failureLogsPerRun,0,5e4,z.failureLogsPerRun)}}async function Ne(){if(De)return;const e=await Y([ke]).catch(()=>({}));re=Xe(e==null?void 0:e[ke]),De=!0}function le(){return re}async function Ze(e){re=Xe(e),De=!0,await J({[ke]:re}).catch(()=>null)}async function vn(){await Ze({...z})}function bn(e,t){const o={segmentation:e.tabSegmentation,contour:e.tabContour,colors:e.tabColors,settings:e.tabSettings,logs:e.tabLogs},n={segmentation:e.viewSegmentation,contour:e.viewContour,colors:e.viewColors,settings:e.viewSettings,logs:e.viewLogs};let a="contour";const s=new Set;function r(){const d=le();return!!(d!=null&&d.traceConsole)}function g(){const d=globalThis;d.__bctGlobalErrorHooksInstalled||(d.__bctGlobalErrorHooksInstalled=!0,window.addEventListener("error",i=>{var f;const u=i;console.error("[panel] window error",{message:u.message,filename:u.filename,lineno:u.lineno,colno:u.colno,error:u.error?String(u.error):null,stack:(f=u.error)!=null&&f.stack?String(u.error.stack):null})}),window.addEventListener("unhandledrejection",i=>{var u;console.error("[panel] unhandledrejection",{reason:i.reason?String(i.reason):null,stack:(u=i.reason)!=null&&u.stack?String(i.reason.stack):null})}))}r()&&g();function p(d){Object.keys(o).forEach(i=>{const u=i===d;o[i].classList.toggle("is-active",u),o[i].setAttribute("aria-selected",u?"true":"false"),n[i].hidden=!u,n[i].classList.toggle("is-active",u)})}function l(d){var i,u,f,m,b,E,C,S;if(d===a){(u=(i=t[d]).refresh)==null||u.call(i);return}(m=(f=t[a]).unmount)==null||m.call(f),a=d,p(a),s.has(a)?(S=(C=t[a]).refresh)==null||S.call(C):(s.add(a),(E=(b=t[a]).mount)==null||E.call(b))}function c(){o.contour.addEventListener("click",d=>{var i;(i=d.preventDefault)==null||i.call(d),l("contour")}),o.segmentation.addEventListener("click",d=>{var i;(i=d.preventDefault)==null||i.call(d),l("segmentation")}),o.colors.addEventListener("click",d=>{var i;(i=d.preventDefault)==null||i.call(d),l("colors")}),o.settings.addEventListener("click",d=>{var i;(i=d.preventDefault)==null||i.call(d),l("settings")}),o.logs.addEventListener("click",d=>{var i;(i=d.preventDefault)==null||i.call(d),l("logs")})}function v(){var d,i,u,f;a="contour",p(a),Object.keys(t).forEach(m=>{var b,E;return(E=(b=t[m]).boot)==null?void 0:E.call(b)}),s.has(a)?(f=(u=t[a]).refresh)==null||f.call(u):(s.add(a),(i=(d=t[a]).mount)==null||i.call(d))}function h(){Object.keys(t).forEach(d=>{var i,u;return(u=(i=t[d]).dispose)==null?void 0:u.call(i)})}return{bind:c,boot:v,activate:l,dispose:h}}function Ue(e){const t=e.items.length;return{items:e.items,counts:{items:t},meta:e.meta}}function yn(){const e={items:[],meta:{}},t=new Set;function o(){const l=Ue(e);for(const c of t)try{c(l)}catch{}}function n(){return Ue(e)}function a(l){t.add(l);try{l(n())}catch{}return()=>t.delete(l)}function s(){e.items=[],e.meta={},o()}function r(l){e.meta.scopeUpdatedSince=l,o()}function g(){return String(e.meta.scopeUpdatedSince||"")}function p(l,c){e.items=l.slice(),e.meta.updatedTs=Date.now(),typeof(c==null?void 0:c.limit)=="number"&&(e.meta.limit=c.limit),o()}return{getSnapshot:n,subscribe:a,getScopeUpdatedSince:g,clearAll:s,setScopeUpdatedSince:r,setItems:p}}function En(){return{loadedImageName:null,hasImage:!1,hasOutput:!1,edgeMask:void 0,repairedMask:void 0,smoothedMask:void 0,svgText:void 0}}function Cn(e){e.loadedImageName=null,e.hasImage=!1,e.hasOutput=!1,e.edgeMask=void 0,e.repairedMask=void 0,e.smoothedMask=void 0,e.svgText=void 0}function et(e,t,o){const n=new Uint8Array(e.length);function a(f,m){return m*t+f}function s(f,m){return f<0||m<0||f>=t||m>=o?!1:e[a(f,m)]===1}let r=0,g=0,p=0,l=0,c=0;const v=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];for(let f=0;f<o;f++)for(let m=0;m<t;m++){if(!s(m,f))continue;r++;let b=0,E=!1;for(const[C,S]of v)s(m+C,f+S)?b++:E=!0;E&&g++,b===1?p++:b>=3&&l++}const h=[[-1,0],[1,0],[0,-1],[0,1]],d=new Int32Array(e.length),i=new Int32Array(e.length);for(let f=0;f<o;f++)for(let m=0;m<t;m++){const b=a(m,f);if(e[b]===0||n[b]===1)continue;c++,n[b]=1;let E=0,C=0;for(d[C]=m,i[C]=f,C++;E<C;){const S=d[E],x=i[E];E++;for(const[R,D]of h){const k=S+R,y=x+D;if(k<0||y<0||k>=t||y>=o)continue;const w=a(k,y);e[w]===0||n[w]===1||(n[w]=1,d[C]=k,i[C]=y,C++)}}}const u=r/Math.max(1,g);return{onPixels:r,boundaryPixels:g,components:c,endpoints:p,junctions:l,thicknessRatio:u}}function wn(e,t){function o(d){e.contourStatusEl.textContent=d}function n(d,i){e.contourSpinnerEl.classList.toggle("is-hidden",!d),i&&o(i)}function a(){e.btnProcessEl.disabled=!t.hasImage,e.btnDownloadEl.disabled=!t.hasOutput,e.btnCleanEl.disabled=!t.hasOutput,e.btnVectorizeEl.disabled=!t.smoothedMask,e.btnDownloadSvgEl.disabled=!t.svgText}function s(){t.svgText=void 0,e.svgPreviewTextEl.textContent="",e.svgPreviewImgEl.removeAttribute("src")}function r(){const d=e.srcCanvasEl.getContext("2d"),i=e.outCanvasEl.getContext("2d");d.clearRect(0,0,e.srcCanvasEl.width,e.srcCanvasEl.height),i.clearRect(0,0,e.outCanvasEl.width,e.outCanvasEl.height);const u=e.clean1CanvasEl.getContext("2d"),f=e.clean2CanvasEl.getContext("2d");u.clearRect(0,0,e.clean1CanvasEl.width,e.clean1CanvasEl.height),f.clearRect(0,0,e.clean2CanvasEl.width,e.clean2CanvasEl.height)}function g(){const d=e.clean1CanvasEl.getContext("2d"),i=e.clean2CanvasEl.getContext("2d");d.clearRect(0,0,e.clean1CanvasEl.width,e.clean1CanvasEl.height),i.clearRect(0,0,e.clean2CanvasEl.width,e.clean2CanvasEl.height)}function p(d,i){const u=Number(d.value);return Number.isFinite(u)?u:i}function l(d,i){const u=i instanceof Error?i.message:String(i);o(`${d} failed: ${u}`),n(!1),console.error(`[BeeContour] ${d} failed`,i)}function c(d,i){if(!t.smoothedMask){e.cleanQualityBadgeEl.textContent="—",e.cleanQualityBadgeEl.className="qBadge qBadge--off",e.cleanQualityFillEl.style.width="0%",e.cleanQualityTextEl.textContent="";return}const u=et(t.smoothedMask,d,i),f=(k,y)=>Math.max(0,Math.min(1,k/Math.max(1,y))),m=f(u.components,800),b=f(u.endpoints,3e3),E=f(u.junctions,1500),C=u.thicknessRatio>5?1:u.thicknessRatio>3?.5:0,S=Math.round(100*(1-(.45*m+.45*b+.1*E)-.1*C)),x=Math.max(0,Math.min(100,S));let R="qBadge qBadge--bad",D=`Bad ${x}`;x>=70?(R="qBadge qBadge--ok",D=`Good ${x}`):x>=45&&(R="qBadge qBadge--warn",D=`OK ${x}`),e.cleanQualityBadgeEl.className=R,e.cleanQualityBadgeEl.textContent=D,e.cleanQualityFillEl.style.width=`${x}%`,e.cleanQualityTextEl.textContent=`CC:${u.components} end:${u.endpoints} j:${u.junctions} thick:${u.thicknessRatio.toFixed(2)}`}function v(){if(!t.hasOutput)return;const i=`${(t.loadedImageName||"beecontour").replace(/\.[a-z0-9]+$/i,"").replace(/[^a-z0-9-_]+/gi,"_")}_contour.png`,u=e.outCanvasEl.toDataURL("image/png"),f=document.createElement("a");f.href=u,f.download=i,document.body.appendChild(f),f.click(),f.remove(),o(`Downloaded: ${i}`)}function h(){if(!t.svgText)return;const i=`${(t.loadedImageName||"beecontour").replace(/\.[a-z0-9]+$/i,"").replace(/[^a-z0-9-_]+/gi,"_")}_contour.svg`,u=new Blob([t.svgText],{type:"image/svg+xml;charset=utf-8"}),f=URL.createObjectURL(u),m=document.createElement("a");m.href=f,m.download=i,document.body.appendChild(m),m.click(),m.remove(),URL.revokeObjectURL(f),o(`Downloaded: ${i}`)}return{setStatus:o,setContourBusyVisual:n,updateEnabled:a,clearSvgPreview:s,clearCanvases:r,clearCleanCanvasesOnly:g,getNumber:p,showError:l,updateCleanQualityUI:c,downloadPng:v,downloadSvg:h}}const ne="beecontour.debugTrace",Re="beecontour.debugTrace.enabled",Sn=2e3;function xn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function Te(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}async function ce(){const e=await Y(ne),t=e==null?void 0:e[ne];return Array.isArray(t)?t:[]}async function kn(e){await J({[ne]:e})}async function Pe(){const e=await Y(Re);return!!(e!=null&&e[Re])}async function tt(e){await J({[Re]:!!e}),e||await Le(ne)}async function nt(){await Le(ne)}async function Be(e,t){if(!await Pe())return{total:0};const n=Te((t==null?void 0:t.max)??Sn,100,5e4),a=(Array.isArray(e)?e:[e]).map(p=>({...p,id:xn(),ts:Date.now()}));if(!a.length)return{total:(await ce()).length};const r=(await ce()).concat(a),g=r.length>n?r.slice(r.length-n):r;return await kn(g),{total:g.length}}async function ot(e){const t=Te((e==null?void 0:e.limit)??200,1,5e4),o=Te((e==null?void 0:e.offset)??0,0,1e6),n=(e==null?void 0:e.reverse)??!0,a=await ce(),s=a.length,g=(n?a.slice().reverse():a).slice(o,o+t);return{total:s,items:g}}async function at(e){const t=await ce();return JSON.stringify(t,null,e!=null&&e.pretty?2:0)}const st=Object.freeze(Object.defineProperty({__proto__:null,append:Be,clear:nt,exportJson:at,isEnabled:Pe,list:ot,setEnabled:tt},Symbol.toStringTag,{value:"Module"}));function me(e){return`[BCT][${e}]`}function Dn(e){function t(...s){e.traceOn()&&console.log(me("trace"),...s)}function o(...s){console.warn(me("warn"),...s)}function n(...s){console.error(me("error"),...s)}function a(s,r){t(s,r),Be({scope:e.scope,kind:"debug",message:s,meta:r})}return{logTrace:t,logWarn:o,logError:n,traceScope:a}}const{logTrace:P,logWarn:j,logError:O,traceScope:V}=Dn({scope:"panel",traceOn:()=>!!le().traceConsole});let $=0;function U(){return $>0}function _(e,t){if(t){it(e);return}$=0,ue(e,!1)}async function X(e,t){const o=`${Date.now()}-${Math.random().toString(16).slice(2)}`;P("[state] withBusy: enter",{id:o,busyCount:$}),it(e,o);try{P("[state] withBusy: before await fn",{id:o,busyCount:$});const n=await t();return P("[state] withBusy: after await fn (resolved)",{id:o,busyCount:$}),n}catch(n){throw O("[state] withBusy: fn threw",{id:o,busyCount:$,msg:String((n==null?void 0:n.message)??n),stack:String((n==null?void 0:n.stack)??"")}),n}finally{P("[state] withBusy: finally before endBusy",{id:o,busyCount:$}),Rn(e,o),P("[state] withBusy: finally after endBusy",{id:o,busyCount:$})}}function it(e,t){$++,P("[state] beginBusy",{id:t,busyCount:$}),$===1&&ue(e,!0)}function Rn(e,t){if($--,P("[state] endBusy: dec",{id:t,busyCount:$}),$<=0){$=0,P("[state] endBusy: applying busy=false",{id:t,busyCount:$}),ue(e,!1);return}$===0&&(P("[state] endBusy: applying busy=false (redundant branch)",{id:t,busyCount:$}),ue(e,!1))}function ue(e,t){e.rootEl.classList.toggle("is-busy",t),e.cfgShowDevToolsEl.disabled=!1,e.fileInputEl.disabled=t,e.btnProcessEl.disabled=t,e.btnCleanEl.disabled=t,e.btnDownloadEl.disabled=t,e.btnVectorizeEl.disabled=t,e.btnDownloadSvgEl.disabled=t,e.cfgTraceConsoleEl.disabled=t,e.cfgActionLogMaxEl.disabled=t,e.cfgDebugTraceMaxEl.disabled=t,e.cfgFailureLogsPerRunEl.disabled=t,e.btnCfgResetDefaults.disabled=t,e.logsCbDebugEl.disabled=t,e.cfgUseOpenCvEl.disabled=t,e.logsLimitEl.disabled=t,e.btnLogsRefresh.disabled=t,e.logsTrimKeepEl.disabled=t,e.btnLogsTrim.disabled=t,e.btnLogsExport.disabled=t,e.btnLogsClear.disabled=t,e.debugLimitEl.disabled=t,e.btnDebugRefresh.disabled=t,e.btnDebugExport.disabled=t,e.btnDebugClear.disabled=t,e.btnColorsApplyEl.disabled=t,e.btnColorsCancelEl.disabled=t,e.btnColorsResetEl.disabled=t,e.edgesDarkEl.disabled=t,e.edgeMaskThresholdEl.disabled=t,e.edgeDilateEl.disabled=t,e.maxRegionPxEl.disabled=t;for(const o of Array.from(e.paletteEl.querySelectorAll("button")))o.disabled=t;e.colorsCanvasEl.style.pointerEvents=t?"none":"auto"}function A(e,t,o,n,a,s,r){return{id:e,title:t,implementedEngines:o,defaultEnginePolicy:n,params:a,children:s,description:r}}function Tn(e){const t=new Map,o=new Map;function n(a,s){if(t.has(a.id))throw new Error(`[tuning] Duplicate component id: ${a.id}`);t.set(a.id,a),o.set(a.id,s);for(const r of a.children??[])n(r,a.id)}return n(e,null),{root:e,byId:t,parentById:o}}function Ae(){const e=A("app","BeeContour",["native","opencv"],"native",{},[A("contour","Contour",["native","opencv"],"auto",{},[A("contour.process","Process",["native"],"auto",{contourScale:{kind:"number",label:"Processing scale",min:25,max:100,step:5,default:100},edgeThreshold:{kind:"number",label:"Edge threshold",min:1,max:255,step:1,default:70},invertOutput:{kind:"boolean",label:"White background",default:!0}}),A("contour.clean","Clean & Smooth",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:500,step:1,default:12},cleanRadius:{kind:"number",label:"Repair strength",min:1,max:3,step:1,default:1},cleanBinaryThreshold:{kind:"number",label:"Binary threshold",min:1,max:254,step:1,default:128}},[A("contour.clean.threshold","Threshold",["native"],"auto",{}),A("contour.clean.removeSmallComponents","Remove small components",["native","opencv"],"auto",{}),A("contour.clean.repair","Repair gaps",["native"],"auto",{}),A("contour.clean.smooth","Smooth mask",["native"],"auto",{}),A("contour.clean.quality","Quality metrics",["native"],"auto",{})]),A("contour.vectorize","Vectorize (SVG)",["native"],"native",{pathSmoothIters:{kind:"number",label:"Path smoothing",min:0,max:4,step:1,default:2}})]),A("colors","Colors",["native"],"auto",{},[A("colors.fill","Region fill",["native"],"auto",{edgesDark:{kind:"boolean",label:"Edges are dark",default:!0},edgeMaskThreshold:{kind:"number",label:"Edge threshold",min:0,max:255,step:1,default:80},edgeDilate:{kind:"number",label:"Gap close (px)",min:0,max:6,step:1,default:2},maxRegionPx:{kind:"number",label:"Max region (px)",min:1e3,step:1e3,default:2e5}})]),A("segmentation","Segmentation",["native","opencv"],"auto",{},[A("segmentation.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),A("segmentation.denoise","Denoise",["native","opencv"],"auto",{denoiseAlgo:{kind:"number",label:"Denoise algo",min:0,max:2,step:1,default:1},blurK:{kind:"number",label:"Blur kernel",min:1,max:21,step:2,default:3},bilateralSigma:{kind:"number",label:"Bilateral sigma",min:1,max:150,step:1,default:35}},void 0,"Reduce noise before thresholding."),A("segmentation.color","Color / Gray",["native","opencv"],"auto",{colorMode:{kind:"number",label:"Color mode",min:0,max:3,step:1,default:1},hsvChannel:{kind:"number",label:"HSV channel",min:0,max:2,step:1,default:2}},void 0,"Select color space / channel features for thresholding."),A("segmentation.threshold","Threshold",["native","opencv"],"auto",{thresholdAlgo:{kind:"number",label:"Threshold algo",min:0,max:3,step:1,default:1},manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128},adaptBlock:{kind:"number",label:"Adaptive block",min:3,max:101,step:2,default:31},adaptC:{kind:"number",label:"Adaptive C",min:-50,max:50,step:1,default:3}},void 0,"Convert features into a binary mask."),A("segmentation.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:5},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Remove specks, fill holes, and stabilize regions.")],"Fixed-order segmentation pipeline. Presets configure each step.")]);return Tn(e)}function In(e){return e.default}function Mn(e,t){const o={};for(const[n,a]of Object.entries(e))o[n]=In(a);for(const[n,a]of Object.entries(t??{}))o[n]=a;return o}function Ln(e,t,o){var a;let n=e;for(;n;){const s=t.byId.get(n);if(!s)throw new Error(`[tuning] Unknown component: ${n}`);const g=((a=o[n])==null?void 0:a.enginePolicy)??s.defaultEnginePolicy;if(g!=="inherit")return g;n=t.parentById.get(n)??null}return"native"}function Pn(e,t,o){const n=o.opencvReady&&e.includes("opencv");return e.includes("native")||e.length,t==="native"?{engine:"native"}:t==="opencv"?n?{engine:"opencv"}:{engine:"native",fallbackReason:o.opencvReady?"Policy=opencv, but component has no OpenCV implementation.":"Policy=opencv, but OpenCV is not available at runtime."}:t==="auto"?n?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}function rt(e,t,o,n){var l;const a=t.byId.get(e);if(!a)throw new Error(`[tuning] Unknown component: ${e}`);const s=Ln(e,t,o),{engine:r,fallbackReason:g}=Pn(a.implementedEngines,s,n),p=Mn(a.params,(l=o[e])==null?void 0:l.params);return{id:e,policy:s,engine:r,fallbackReason:g,params:p}}const Ie="beecontour.tuning.components.v1";async function oe(){const e=await Y([Ie]).catch(()=>({})),t=e==null?void 0:e[Ie];return!t||typeof t!="object"?{}:t}async function lt(e){await J({[Ie]:e}).catch(()=>null)}async function he(e,t){const o=await oe(),n=o[e]??{};o[e]={enginePolicy:t.enginePolicy??n.enginePolicy,params:{...n.params??{},...t.params??{}}},await lt(o)}async function ze(e){const t=await oe();delete t[e],await lt(t)}const Oe={native:{available:!0},opencv:{available:!1,reason:"OpenCV not loaded"}};function Bn(e){Oe[e]={available:!0}}function An(e,t){Oe[e]={available:!1,reason:t}}function K(){return Oe.opencv.available===!0}function On(){return{opencvReady:K()}}function $n(e){return Array.isArray(e.children)&&e.children.length>0}function ct(e){const{id:t,registry:o,stored:n,runtime:a}=e,s=o.byId.get(t);if(!s)throw new Error(`[tuning] Unknown component: ${t}`);const r=rt(t,o,n,a),g=n[t],p=g==null?void 0:g.enginePolicy,l=g==null?void 0:g.params,c=s.implementedEngines.includes("opencv"),v=!!a.opencvReady,h=[];for(const d of s.children??[])h.push(ct({id:d.id,registry:o,stored:n,runtime:a}));return{id:s.id,title:s.title,description:s.description,isGroup:$n(s),implementedEngines:s.implementedEngines,storedPolicy:p,storedParams:l,effectivePolicy:r.policy,effectiveEngine:r.engine,fallbackReason:r.fallbackReason,paramsSchema:s.params,effectiveParams:r.params,canImplementOpenCv:c,runtimeOpenCvReady:v,children:h}}function $e(e={}){const t=e.registry??Ae(),o=e.getRuntimeAvailability??On;async function n(p="app"){const l=await oe(),c=o();if(!t.byId.get(p))throw new Error(`[tuning] Unknown scope: ${p}`);const h=ct({id:p,registry:t,stored:l,runtime:c});return{scopeId:p,runtime:c,stored:l,root:h}}async function a(p,l){await he(p,{enginePolicy:l})}async function s(p,l,c){await he(p,{params:{[l]:c}})}async function r(p){await ze(p)}async function g(p,l){const v=(await oe())[p];if(!(v!=null&&v.params))return;const h={...v.params??{}};delete h[l];const d=typeof v.enginePolicy=="string",i=Object.keys(h).length>0;if(!d&&!i){await ze(p);return}await he(p,{enginePolicy:v.enginePolicy,params:h})}return{getRegistry:()=>t,loadTree:n,setEnginePolicy:a,setParam:s,resetNode:r,resetParam:g}}function Vn(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}function Nn(e,t){if(e.kind==="number"){const o=Number(t),n=e.default,a=Number.isFinite(o)?o:n,s=typeof e.min=="number"?e.min:a,r=typeof e.max=="number"?e.max:a;return Vn(a,s,r)}return e.kind==="boolean"?!!t:String(t??e.default)}function Q(e,t,o,n){const a=e.byId.get(t);if(!a)throw new Error(`[tuningParams] unknown node: ${t}`);const s=a.params[o];if(!s)throw new Error(`[tuningParams] unknown param: ${t}.${o}`);return Nn(s,n)}function ie(e,t){if((e==null?void 0:e.id)===t)return e;for(const o of(e==null?void 0:e.children)??[]){const n=ie(o,t);if(n)return n}return null}async function pe(){const e=$e(),t=Ae(),o=await e.loadTree("app"),n=ie(o.root,"contour.process"),a=ie(o.root,"contour.clean"),s=ie(o.root,"contour.vectorize");if(!n||!a||!s)throw new Error("[contour] tuning nodes missing (registry mismatch)");const r=Q(t,"contour.process","contourScale",n.effectiveParams.contourScale),g=Q(t,"contour.process","edgeThreshold",n.effectiveParams.edgeThreshold),p=Q(t,"contour.process","invertOutput",n.effectiveParams.invertOutput),l=Q(t,"contour.clean","cleanMinArea",a.effectiveParams.cleanMinArea),c=Q(t,"contour.clean","cleanRadius",a.effectiveParams.cleanRadius),v=Q(t,"contour.clean","cleanBinaryThreshold",a.effectiveParams.cleanBinaryThreshold),h=Q(t,"contour.vectorize","pathSmoothIters",s.effectiveParams.pathSmoothIters);return{contourScale:r,edgeThreshold:g,invertOutput:p,cleanMinArea:l,cleanRadius:c,cleanBinaryThreshold:v,pathSmoothIters:h}}async function Fe(e,t,o,n){const{setStatus:a,setContourBusyVisual:s,clearCanvases:r,clearCleanCanvasesOnly:g,clearSvgPreview:p,updateEnabled:l,getNumber:c}=n;if(!o.type.startsWith("image/")){a("Unsupported file type (please drop an image)."),j("Contour load: rejected non-image file",{name:o.name,type:o.type,size:o.size}),V("Contour load: rejected non-image file",{name:o.name,type:o.type,size:o.size});return}const v=performance.now();await X(e,async()=>{s(!0,"Loading image…"),t.loadedImageName=o.name||"image";const h=URL.createObjectURL(o);V("Contour load: start",{name:o.name,type:o.type,size:o.size});try{const d=await new Promise((R,D)=>{const k=new Image;k.onload=()=>R(k),k.onerror=()=>D(new Error("Failed to load image")),k.src=h}),i=e.srcCanvasEl,u=i.getContext("2d");if(!u){O("Contour load: missing 2D context",{canvasId:"srcCanvasEl"}),a("Load failed — canvas context not available.");return}r();const m=(await pe()).contourScale,b=m/100;let E=Math.max(64,Math.floor(d.naturalWidth*b)),C=Math.max(64,Math.floor(d.naturalHeight*b));const S=1600,x=Math.min(1,S/Math.max(E,C));E=Math.max(64,Math.floor(E*x)),C=Math.max(64,Math.floor(C*x)),i.width=E,i.height=C,u.imageSmoothingEnabled=!0,u.clearRect(0,0,i.width,i.height),u.drawImage(d,0,0,i.width,i.height),t.hasImage=!0,t.hasOutput=!1,t.edgeMask=void 0,t.repairedMask=void 0,t.smoothedMask=void 0,t.svgText=void 0,p(),g(),l(),a(`Loaded: ${t.loadedImageName} (${i.width}×${i.height})`),V("Contour load: done",{naturalW:d.naturalWidth,naturalH:d.naturalHeight,scalePct:m,maxSide:S,targetW:E,targetH:C,pixels:E*C,ms:Math.round((performance.now()-v)*10)/10})}catch(d){O("Contour load: exception",{error:d instanceof Error?d.message:String(d)}),a("Load failed — see console / debug trace.")}finally{URL.revokeObjectURL(h),s(!1)}})}async function Un(e,t,o){const{setStatus:n,setContourBusyVisual:a,clearCleanCanvasesOnly:s,clearSvgPreview:r,updateEnabled:g}=o;if(!t.hasImage){j("Contour process: skipped (no image loaded)");return}const p=performance.now();await X(e,async()=>{a(!0,"Processing…"),await new Promise(l=>{setTimeout(()=>{(async()=>{try{const c=e.srcCanvasEl,v=e.outCanvasEl,h=c.width,d=c.height,i=h*d,u=await pe(),f=u.edgeThreshold,m=u.invertOutput;V("Contour process: start",{width:h,height:d,pixels:i,threshold:f,whiteBg:m}),v.width=h,v.height=d;const b=v.getContext("2d",{willReadFrequently:!0}),E=c.getContext("2d",{willReadFrequently:!0});if(!E||!b){O("Contour process: missing 2D context",{hasSrc:!!E,hasOut:!!b}),n("Process failed — canvas context not available.");return}const S=E.getImageData(0,0,h,d).data,x=new Uint8ClampedArray(h*d);for(let I=0,M=0;I<S.length;I+=4,M++){const L=S[I],N=S[I+1],F=S[I+2];x[M]=.299*L+.587*N+.114*F|0}const R=[-1,0,1,-2,0,2,-1,0,1],D=[-1,-2,-1,0,0,0,1,2,1],k=new Uint8ClampedArray(h*d);for(let I=1;I<d-1;I++)for(let M=1;M<h-1;M++){let L=0,N=0,F=0;for(let ee=-1;ee<=1;ee++)for(let G=-1;G<=1;G++){const se=x[(I+ee)*h+(M+G)];L+=se*R[F],N+=se*D[F],F++}const Z=Math.min(255,Math.sqrt(L*L+N*N)|0);k[I*h+M]=Z>=f?255:0}const y=b.createImageData(h,d),w=y.data;let B=0;for(let I=0,M=0;I<k.length;I++,M+=4){const L=k[I];if(L===255&&B++,m){const F=L===255?0:255;w[M]=F,w[M+1]=F,w[M+2]=F,w[M+3]=255}else w[M]=L,w[M+1]=L,w[M+2]=L,w[M+3]=255}b.putImageData(y,0,0),t.hasOutput=!0,t.edgeMask=void 0,t.repairedMask=void 0,t.smoothedMask=void 0,r(),s(),n("Done. You can clean/smooth or download the PNG."),V("Contour process: done",{width:h,height:d,pixels:i,threshold:f,whiteBg:m,edgePixels:B,edgeRatio:Math.round(B/Math.max(1,i)*1e6)/1e6,ms:Math.round((performance.now()-p)*10)/10})}catch(c){O("Contour process: exception",{error:c instanceof Error?c.message:String(c)}),n("Process failed — see console / debug trace.")}finally{l()}})()},0)}),a(!1),g()})}function Me(e,t,o,n){const a=new ImageData(t,o),s=a.data;for(let r=0,g=0;r<e.length;r++,g+=4){const p=e[r]===1;if(n){const l=p?0:255;s[g]=l,s[g+1]=l,s[g+2]=l,s[g+3]=255}else{const l=p?255:0;s[g]=l,s[g+1]=l,s[g+2]=l,s[g+3]=255}}return a}function ve(e,t,o,n){const a=new Uint8Array(e.length),s=Math.max(1,n);for(let r=0;r<o;r++)for(let g=0;g<t;g++){let p=0;for(let l=-s;l<=s&&!p;l++){const c=r+l;if(c<0||c>=o)continue;const v=c*t;for(let h=-s;h<=s;h++){const d=g+h;if(!(d<0||d>=t)&&e[v+d]===1){p=1;break}}}a[r*t+g]=p}return a}function be(e,t,o,n){const a=new Uint8Array(e.length),s=Math.max(1,n);for(let r=0;r<o;r++)for(let g=0;g<t;g++){let p=1;for(let l=-s;l<=s&&p;l++){const c=r+l;if(c<0||c>=o){p=0;break}const v=c*t;for(let h=-s;h<=s;h++){const d=g+h;if(d<0||d>=t){p=0;break}if(e[v+d]===0){p=0;break}}}a[r*t+g]=p}return a}function ut(e,t,o,n){const a=new Uint8Array(e),s=new Uint8Array(e.length),r=new Int32Array(e.length),g=new Int32Array(e.length);for(let p=0;p<o;p++)for(let l=0;l<t;l++){const c=p*t+l;if(e[c]===0||s[c]===1)continue;let v=0,h=0;s[c]=1,r[h]=l,g[h]=p,h++;const d=[c];for(;v<h;){const i=r[v],u=g[v];v++;const f=[[i-1,u],[i+1,u],[i,u-1],[i,u+1]];for(const[m,b]of f){if(m<0||m>=t||b<0||b>=o)continue;const E=b*t+m;e[E]===0||s[E]===1||(s[E]=1,r[h]=m,g[h]=b,h++,d.push(E))}}if(d.length<n)for(const i of d)a[i]=0}return a}const zn=Ae();function Fn(){return{opencvReady:K()}}async function jn(e){const t=await oe(),o=Fn(),n=rt(e,zn,t,o);if(e==="contour.clean.removeSmallComponents"){const a=Number(n.params.cleanMinArea??12);return{engine:n.engine,params:{cleanMinArea:a},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.resize"){const a=Number(n.params.resizeAlgo??1),s=Number(n.params.targetMaxW??900);return{engine:n.engine,params:{resizeAlgo:a,targetMaxW:s},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.denoise"){const a=Number(n.params.denoiseAlgo??1),s=Number(n.params.blurK??5),r=Number(n.params.bilateralSigma??35);return{engine:n.engine,params:{denoiseAlgo:a,blurK:s,bilateralSigma:r},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.color"){const a=Number(n.params.colorMode??1),s=Number(n.params.hsvChannel??2);return{engine:n.engine,params:{colorMode:a,hsvChannel:s},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.threshold"){const a=Number(n.params.thresholdAlgo??1),s=Number(n.params.manualT??128),r=Number(n.params.adaptBlock??21),g=Number(n.params.adaptC??2);return{engine:n.engine,params:{thresholdAlgo:a,manualT:s,adaptBlock:r,adaptC:g},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.morphology"){const a=Number(n.params.morphAlgo??2),s=Number(n.params.morphK??7),r=Number(n.params.morphIters??1);return{engine:n.engine,params:{morphAlgo:a,morphK:s,morphIters:r},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}throw new Error(`[opsDispatch] Unknown op: ${e}`)}async function _n(e,t,o){const{engine:n,params:a,fallbackReason:s,opencvReady:r}=await jn(e);return n==="opencv"&&!r?(j(`OpenCV selected for ${e} but not ready; falling back to native. ${s??""}`.trim()),await o[e].native(t,a)):await o[e][n](t,a)}function qn(){const e=globalThis;return e!=null&&e.cv&&typeof e.cv.Mat=="function"?e.cv:null}function Gn(e,t){const{width:o,height:n}=e,a=Math.max(0,Math.floor(Number(t.cleanMinArea??0)));if(V("oopenCV RemoveSmallComponents: params",{width:o,height:n,minArea:a}),a<=1)return e.mask;const s=qn();if(!s)return ut(e.mask,o,n,a);const r=new s.Mat(n,o,s.CV_8UC1);try{const g=r.data,p=e.mask;for(let h=0;h<p.length;h++)g[h]=p[h]?255:0;const l=new s.Mat,c=new s.Mat,v=new s.Mat;try{const h=s.connectedComponentsWithStats(r,l,c,v,8,s.CV_32S),d=s.CC_STAT_AREA??4,i=new Array(h).fill(!1);for(let m=1;m<h;m++)c.intAt(m,d)<a&&(i[m]=!0);const u=new Uint8Array(o*n),f=l.data32S;for(let m=0;m<u.length;m++){const b=f[m];u[m]=b>0&&!i[b]?1:0}return u}finally{l.delete(),c.delete(),v.delete()}}finally{r.delete()}}function je(e,t,o,n){const a=Math.max(0,Math.min(255,Math.floor(Number(n.manualT??128)))),s=new Uint8Array(t*o),r=e.data;for(let g=0,p=0;g<s.length;g++,p+=4){const l=r[p],c=r[p+1],v=r[p+2],h=l*77+c*150+v*29>>8;s[g]=h>=a?1:0}return s}const Kn={"contour.clean.removeSmallComponents":{native:(e,t)=>ut(e.mask,e.width,e.height,t.cleanMinArea),opencv:(e,t)=>(P("OpenCV removeSmallComponents called (demo).",{width:e.width,height:e.height,cleanMinArea:t.cleanMinArea}),Gn(e,t))},"segmentation.resize":{native:e=>e.image,opencv:e=>(P("OpenCV segmentation.resize called (demo) [stub]."),e.image)},"segmentation.denoise":{native:e=>e.image,opencv:e=>(P("OpenCV segmentation.denoise called (demo) [stub]."),e.image)},"segmentation.color":{native:e=>e.image,opencv:e=>(P("OpenCV segmentation.color called (demo) [stub]."),e.image)},"segmentation.threshold":{native:(e,t)=>je(e.image,e.width,e.height,{manualT:t.manualT}),opencv:(e,t)=>(P("OpenCV segmentation.threshold called (demo) [stub]."),je(e.image,e.width,e.height,{manualT:t.manualT}))},"segmentation.morphology":{native:e=>e.mask,opencv:e=>(P("OpenCV segmentation.morphology called (demo) [stub]."),e.mask)}};async function de(e,t){return _n(e,t,Kn)}async function Qn(e,t){return de(e,t)}async function Hn(e,t,o){const{setStatus:n,setContourBusyVisual:a,clearSvgPreview:s,updateEnabled:r,updateCleanQualityUI:g}=o;if(!t.hasOutput){j("Contour clean: skipped (no output present)");return}const p=performance.now();await X(e,async()=>{a(!0,"Cleaning…"),await new Promise(l=>{setTimeout(()=>{(async()=>{try{const c=e.outCanvasEl,v=e.clean1CanvasEl,h=e.clean2CanvasEl,d=await pe(),i=d.cleanRadius,u=d.cleanBinaryThreshold,f=d.invertOutput;v.width=c.width,v.height=c.height,h.width=c.width,h.height=c.height;const m=c.width,b=c.height,E=m*b;V("Contour clean: start",{width:m,height:b,pixels:E,whiteBg:f,EDGE_T:u,radius:i});const C=c.getContext("2d",{willReadFrequently:!0}),S=v.getContext("2d",{willReadFrequently:!0}),x=h.getContext("2d",{willReadFrequently:!0});if(!C||!S||!x){O("Contour clean: missing 2D context",{hasOut:!!C,hasC1:!!S,hasC2:!!x}),n("Clean failed — canvas context not available.");return}const D=C.getImageData(0,0,m,b).data,k=new Uint8Array(m*b);let y=0;for(let N=0,F=0;N<k.length;N++,F+=4){const Z=D[F],G=(f?Z<u:Z>=u)?1:0;k[N]=G,G===1&&y++}V("Contour removeSmallComponents: params",{edge:k,width:m,height:b});const w=await Qn("contour.clean.removeSmallComponents",{mask:k,width:m,height:b});V("Contour erode : params",{edgeNoSpeck:w,width:m,height:b,radius:i});const B=be(ve(w,m,b,i),m,b,i);S.putImageData(Me(B,m,b,f),0,0),V("Contour dilate : params",{repaired:B,width:m,height:b,radius:i});const I=ve(be(B,m,b,i),m,b,i);V("Contour erode : params",{opened:I,width:m,height:b,radius:i});const M=be(ve(I,m,b,i),m,b,i);x.putImageData(Me(M,m,b,f),0,0),t.edgeMask=k,t.repairedMask=B,t.smoothedMask=M,s();const L=et(M,m,b);g(m,b),n(`Clean done — CC:${L.components} endpoints:${L.endpoints} junctions:${L.junctions} thickness:${L.thicknessRatio.toFixed(2)}`),V("Contour clean: done",{width:m,height:b,pixels:E,whiteBg:f,EDGE_T:u,radius:i,edgeOn:y,edgeRatio:Math.round(y/Math.max(1,E)*1e6)/1e6,quality:L,ms:Math.round((performance.now()-p)*10)/10})}catch(c){O("Contour clean: exception",{error:c instanceof Error?c.message:String(c)}),n("Clean failed — see console / debug trace.")}finally{l()}})()},0)}),a(!1),r()})}function Wn(e,t,o){const n=new Uint8Array(e.length),a=[];function s(d,i){return i*t+d}function r(d,i){return d<0||i<0||d>=t||i>=o?!1:e[s(d,i)]===1}function g(d,i){if(!r(d,i))return!1;for(let u=-1;u<=1;u++)for(let f=-1;f<=1;f++)if(!(f===0&&u===0)&&!r(d+f,i+u))return!0;return!1}const p=[{dx:1,dy:0},{dx:1,dy:1},{dx:0,dy:1},{dx:-1,dy:1},{dx:-1,dy:0},{dx:-1,dy:-1},{dx:0,dy:-1},{dx:1,dy:-1}],l=2e3,c=Math.max(2e3,Math.floor((t+o)*2)),v=Math.max(2e5,Math.floor(t*o*.25));let h=0;for(let d=0;d<o;d++)for(let i=0;i<t;i++){if(a.length>=l||h>=v)return a;const u=s(i,d);if(n[u]===1||!g(i,d))continue;const f=[];let m=i,b=d,E=4,C=0;const S=Math.min(t*o,c*4);for(;C<S;){C++;const x=s(m,b);if(n[x]===1||(f.push({x:m,y:b}),n[x]=1,h++,f.length>=c)||h>=v)break;let R=!1;const D=(E+6)%8;for(let k=0;k<8;k++){const y=(D+k)%8,w=m+p[y].dx,B=b+p[y].dy;if(!g(w,B))continue;const I=s(w,B);if(!(!(w===i&&B===d&&f.length>10)&&n[I]===1)){m=w,b=B,E=y,R=!0;break}}if(!R||m===i&&b===d&&f.length>10)break}f.length>=20&&a.push(f)}return a}function _e(e,t){if(e.length<3)return e;const o=t*t;function n(l,c,v){const h=v.x-c.x,d=v.y-c.y,i=l.x-c.x,u=l.y-c.y,f=h*i+d*u;if(f<=0)return(l.x-c.x)**2+(l.y-c.y)**2;const m=h*h+d*d;if(m<=f)return(l.x-v.x)**2+(l.y-v.y)**2;const b=f/m,E=c.x+b*h,C=c.y+b*d;return(l.x-E)**2+(l.y-C)**2}const a=new Uint8Array(e.length);a[0]=1,a[e.length-1]=1;const s=[0],r=[e.length-1];for(;s.length>0;){const l=s.pop(),c=r.pop();if(c<=l+1)continue;const v=e[l],h=e[c];let d=0,i=-1;for(let u=l+1;u<c;u++){const f=n(e[u],v,h);f>d&&(d=f,i=u)}i!==-1&&d>o&&(a[i]=1,s.push(l),r.push(i),s.push(i),r.push(c))}const g=[];for(let l=0;l<e.length;l++)a[l]===1&&g.push(e[l]);const p=[];for(const l of g){const c=p[p.length-1];(!c||c.x!==l.x||c.y!==l.y)&&p.push(l)}return p}function Yn(e,t){let o=e;for(let n=0;n<t;n++){if(o.length<3)return o;const a=[];for(let c=0;c<o.length-1;c++){const v=o[c],h=o[c+1];a.push({x:.75*v.x+.25*h.x,y:.75*v.y+.25*h.y},{x:.25*v.x+.75*h.x,y:.25*v.y+.75*h.y})}const s=o[0],r=o[o.length-1],g=s.x-r.x,p=s.y-r.y;if(g*g+p*p<=4){const c=o[o.length-1],v=o[0];a.push({x:.75*c.x+.25*v.x,y:.75*c.y+.25*v.y},{x:.25*c.x+.75*v.x,y:.25*c.y+.75*v.y})}o=a}return o}function Jn(e,t,o){const n=[];for(const a of e){const s=Xn(a);s&&n.push(`<path d="${s}" fill="none" stroke="#000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>`)}return`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${t}" height="${o}" viewBox="0 0 ${t} ${o}">
<rect x="0" y="0" width="${t}" height="${o}" fill="#fff"/>
`+n.join(`
`)+`
</svg>
`}function Xn(e){if(e.length<2)return"";const t=e.slice(),o=t[0],n=t[t.length-1],a=o.x-n.x,s=o.y-n.y,r=a*a+s*s<=4;r&&t.push({x:o.x,y:o.y});let g=`M ${t[0].x.toFixed(2)} ${t[0].y.toFixed(2)}`;for(let p=0;p<t.length-1;p++){const l=t[Math.max(0,p-1)],c=t[p],v=t[p+1],h=t[Math.min(t.length-1,p+2)],d=c.x+(v.x-l.x)/6,i=c.y+(v.y-l.y)/6,u=v.x-(h.x-c.x)/6,f=v.y-(h.y-c.y)/6;g+=` C ${d.toFixed(2)} ${i.toFixed(2)}, ${u.toFixed(2)} ${f.toFixed(2)}, ${v.x.toFixed(2)} ${v.y.toFixed(2)}`}return r&&(g+=" Z"),g}async function Zn(e,t,o){if(!t.smoothedMask){j("Contour vectorize: skipped (no smoothed mask present)");return}const n=performance.now();await X(e,async()=>{o.setContourBusyVisual(!0,"Vectorizing…");const a=()=>{t.svgText=void 0,e.svgPreviewTextEl.textContent="",e.svgPreviewImgEl.removeAttribute("src")};try{await new Promise((s,r)=>{setTimeout(()=>{(async()=>{try{const g=t.smoothedMask,p=e.outCanvasEl.width,l=e.outCanvasEl.height,c=p*l,v=1.5,d=(await pe()).pathSmoothIters;V("Contour vectorize: start",{width:p,height:l,pixels:c,epsilon:v,smoothIters:d});const i=Wn(g,p,l),u=i.length,f=i.reduce((D,k)=>D+k.length,0),m=i.reduce((D,k)=>Math.max(D,k.length),0);if(u===0||f===0){j("Contour vectorize: no boundaries found",{width:p,height:l,pixels:c,pathsRaw:u,pointsRaw:f}),a(),o.setStatus("No boundaries found to vectorize."),s();return}if(u>2e3||f>2e5){j("Contour vectorize: aborted (too complex)",{width:p,height:l,pixels:c,pathsRaw:u,pointsRaw:f,maxPolyline:m}),a(),o.setStatus(`Vectorize aborted: too complex (paths ${u}, points ${f}). Try stronger clean / higher minArea / lower resolution.`),s();return}V("Contour vectorize: traced boundaries",{pathsRaw:u,pointsRaw:f,maxPolyline:m});const b=i.filter(D=>D.length>=20).map(D=>{const k=_e(D,v),y=d>0?Yn(k,d):k;return _e(y,v)}).filter(D=>D.length>=3),E=b.length,C=b.reduce((D,k)=>D+k.length,0),S=b.reduce((D,k)=>Math.max(D,k.length),0);if(E===0||C===0){j("Contour vectorize: simplified to nothing",{pathsRaw:u,pointsRaw:f,pathsOut:E,pointsOut:C,smoothIters:d,epsilon:v}),a(),o.setStatus("Vectorize produced no usable paths (after simplification)."),s();return}V("Contour vectorize: simplified",{pathsOut:E,pointsOut:C,maxOut:S,smoothIters:d,epsilon:v});const x=Jn(b,p,l);t.svgText=x,e.svgPreviewTextEl.textContent=x;const R=encodeURIComponent(x).replace(/'/g,"%27").replace(/"/g,"%22");e.svgPreviewImgEl.src=`data:image/svg+xml;charset=utf-8,${R}`,o.setStatus(`SVG generated: paths ${E}, points ${f}→${C}, smooth ${d}`),V("Contour vectorize: done",{width:p,height:l,pixels:c,smoothIters:d,epsilon:v,pathsRaw:u,pointsRaw:f,pathsOut:E,pointsOut:C,svgChars:x.length,ms:Math.round((performance.now()-n)*10)/10}),s()}catch(g){O("Contour vectorize: exception",{error:g instanceof Error?g.message:String(g),ms:Math.round((performance.now()-n)*10)/10}),r(g)}})()},0)})}catch(s){o.showError("Vectorize",s),a()}finally{o.setContourBusyVisual(!1),o.updateEnabled()}})}function eo(e,t){const o=En(),n=wn(e,o);function a(){const p=e.dropZoneEl;function l(c){p.classList.toggle("is-hover",c)}p.addEventListener("dragover",c=>{c.preventDefault(),l(!0)}),p.addEventListener("dragleave",()=>l(!1)),p.addEventListener("drop",c=>{var h;c.preventDefault(),l(!1);const v=(h=c.dataTransfer)==null?void 0:h.files;!v||v.length===0||Fe(e,o,v[0],{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearCanvases:n.clearCanvases,clearCleanCanvasesOnly:n.clearCleanCanvasesOnly,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,getNumber:n.getNumber})}),e.fileInputEl.addEventListener("change",()=>{var v;const c=(v=e.fileInputEl.files)==null?void 0:v[0];c&&(Fe(e,o,c,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearCanvases:n.clearCanvases,clearCleanCanvasesOnly:n.clearCleanCanvasesOnly,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,getNumber:n.getNumber}),e.fileInputEl.value="")})}function s(){a(),e.btnDownloadEl.addEventListener("click",()=>n.downloadPng()),e.btnDownloadSvgEl.addEventListener("click",()=>n.downloadSvg()),e.btnProcessEl.addEventListener("click",()=>{Un(e,o,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearCleanCanvasesOnly:n.clearCleanCanvasesOnly,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled})}),e.btnCleanEl.addEventListener("click",()=>{Hn(e,o,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,updateCleanQualityUI:n.updateCleanQualityUI})}),e.btnVectorizeEl.addEventListener("click",()=>{Zn(e,o,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,updateEnabled:n.updateEnabled,showError:n.showError,getNumber:n.getNumber})}),Cn(o),n.clearSvgPreview(),n.updateEnabled(),n.setStatus("No image loaded"),e.contourSpinnerEl.classList.add("is-hidden")}function r(){}function g(){}return{id:"contour",bind:s,mount:r,unmount:g}}const dt=[{id:"seg.recipe.document",title:"Recipe: Document scan",target:"segmentation",params:[{id:"segmentation.resize",key:"resizeAlgo",value:1},{id:"segmentation.resize",key:"targetMaxW",value:1200},{id:"segmentation.denoise",key:"denoiseAlgo",value:1},{id:"segmentation.denoise",key:"blurK",value:3},{id:"segmentation.color",key:"colorMode",value:1},{id:"segmentation.threshold",key:"thresholdAlgo",value:2},{id:"segmentation.threshold",key:"adaptBlock",value:31},{id:"segmentation.threshold",key:"adaptC",value:3},{id:"segmentation.morphology",key:"morphAlgo",value:2},{id:"segmentation.morphology",key:"morphK",value:5},{id:"segmentation.morphology",key:"morphIters",value:1}]},{id:"seg.threshold.otsu",title:"Threshold: Otsu",target:"segmentation.threshold",params:[{id:"segmentation.threshold",key:"thresholdAlgo",value:1}]},{id:"seg.morph.fill-holes",title:"Morphology: Fill holes (close)",target:"segmentation.morphology",params:[{id:"segmentation.morphology",key:"morphAlgo",value:2},{id:"segmentation.morphology",key:"morphK",value:7},{id:"segmentation.morphology",key:"morphIters",value:1}]}];function to(e){return dt.find(t=>t.id===e)??null}function ye(e,t,o){const n=document.createElement(e);return t&&(n.className=t),typeof o=="string"&&(n.textContent=o),n}function no(e,t){return t==="recipe"?e.target==="segmentation":e.target===t}function oo(e,t){const o=[],n=new Map,a={"segmentation.resize":e.segStepResizeEl,"segmentation.denoise":e.segStepDenoiseEl,"segmentation.color":e.segStepColorEl,"segmentation.threshold":e.segStepThresholdEl,"segmentation.morphology":e.segStepMorphologyEl};function s(){const h=e.segPresetListEl;h.innerHTML="";for(const d of dt){const i=ye("div","segPresetCard");i.setAttribute("draggable","true"),i.setAttribute("data-preset-id",d.id),i.setAttribute("aria-label",`Preset: ${d.title}`);const u=ye("div","segPresetCardTitle",d.title),f=ye("div","segPresetCardDesc",d.description||`Target: ${d.target}`);i.appendChild(u),i.appendChild(f);const m=b=>{b.dataTransfer&&(b.dataTransfer.setData("text/plain",d.id),b.dataTransfer.effectAllowed="copy")};i.addEventListener("dragstart",m),o.push(()=>i.removeEventListener("dragstart",m)),h.appendChild(i)}}function r(h,d){const i=h.querySelector("[data-assigned]");i&&(i.textContent=d,i.classList.remove("muted"))}function g(h){for(const d of Object.keys(a))n.set(d,h.id),r(a[d],h.title);r(e.segRecipeDropEl,h.title)}function p(h,d){const i=b=>{b.preventDefault(),h.classList.add("is-over")},u=b=>{b.preventDefault(),h.classList.add("is-over"),b.dataTransfer&&(b.dataTransfer.dropEffect="copy")},f=()=>{h.classList.remove("is-over")},m=async b=>{var S;b.preventDefault(),h.classList.remove("is-over");const E=((S=b.dataTransfer)==null?void 0:S.getData("text/plain"))||"";if(!E)return;const C=to(E);C&&no(C,d)&&(d==="recipe"?g(C):(n.set(d,C.id),r(h,C.title)),await t.applyPreset(C))};h.addEventListener("dragenter",i),h.addEventListener("dragover",u),h.addEventListener("dragleave",f),h.addEventListener("drop",m),o.push(()=>h.removeEventListener("dragenter",i)),o.push(()=>h.removeEventListener("dragover",u)),o.push(()=>h.removeEventListener("dragleave",f)),o.push(()=>h.removeEventListener("drop",m))}function l(){s(),p(e.segRecipeDropEl,"recipe"),p(e.segStepResizeEl,"segmentation.resize"),p(e.segStepDenoiseEl,"segmentation.denoise"),p(e.segStepColorEl,"segmentation.color"),p(e.segStepThresholdEl,"segmentation.threshold"),p(e.segStepMorphologyEl,"segmentation.morphology")}function c(h){}function v(){for(const h of o)h();o.length=0}return l(),{set:c,dispose:v}}async function ao(e,t){if(t.input.kind!=="image")throw new Error(`[segmentation] runImageOp: Mat input not supported yet for ${e}`);return{kind:"image",image:await de(e,{image:t.input.image,width:t.width,height:t.height})}}async function qe(e,t){if(e==="segmentation.threshold"){const{input:s,width:r,height:g}=t;if(s.kind!=="image")throw new Error("[segmentation] runMaskOp(threshold): Mat input not supported yet");return await de(e,{image:s.image,width:r,height:g})}const{mask:o,width:n,height:a}=t;return await de(e,{mask:o,width:n,height:a})}const H=[{id:"segmentation.resize",kind:"image"},{id:"segmentation.denoise",kind:"image"},{id:"segmentation.color",kind:"image"},{id:"segmentation.threshold",kind:"mask"},{id:"segmentation.morphology",kind:"mask"}];function so(e,t,o){const n=oo(e,o);let a=null;const s={"segmentation.resize":e.segStepResizeEl,"segmentation.denoise":e.segStepDenoiseEl,"segmentation.color":e.segStepColorEl,"segmentation.threshold":e.segStepThresholdEl,"segmentation.morphology":e.segStepMorphologyEl};function r(E){e.segStatusEl.textContent=E||""}function g(){for(const E of Object.values(s))E.classList.remove("is-active"),E.classList.remove("is-done")}function p(E){var C,S;for(const x of Object.values(s))x.classList.remove("is-active"),x.classList.remove("is-done");if(a){for(let x=0;x<Math.min(a.stepIndex,H.length);x++){const R=H[x].id;(C=s[R])==null||C.classList.add("is-done")}E&&((S=s[E])==null||S.classList.add("is-active"))}}function l(){if(!a)return;const{width:E,height:C}=a;e.segMaskCanvasEl.width=E,e.segMaskCanvasEl.height=C;const S=e.segMaskCanvasEl.getContext("2d",{willReadFrequently:!0});if(!S){O("[segmentation] preview: missing 2D context");return}if(a.artifact.kind==="image"){S.putImageData(a.artifact.image,0,0);return}S.putImageData(Me(a.artifact.mask,E,C,!0),0,0)}function c(){const E=e.outCanvasEl,C=E.width,S=E.height;if(!C||!S)return null;const x=E.getContext("2d",{willReadFrequently:!0});if(!x)return null;const R=x.getImageData(0,0,C,S);return{width:C,height:S,stepIndex:0,artifact:{kind:"image",image:R}}}async function v(){if(!a&&(a=c(),!a)){r("No image");return}if(a.stepIndex>=H.length){r("Done");return}const E=H[a.stepIndex],{width:C,height:S}=a;if(p(E.id),r(`Running: ${E.id}`),V("[segmentation] next step",{stepIndex:a.stepIndex,stepId:E.id,width:C,height:S,artifact:a.artifact.kind}),E.id==="segmentation.resize"||E.id==="segmentation.denoise"||E.id==="segmentation.color"){if(a.artifact.kind!=="image")throw new Error(`[segmentation] step ${E.id} expected image input, got mask`);const x=await ao(E.id,{input:{kind:"image",image:a.artifact.image},width:C,height:S});if(x.kind!=="image")throw new Error(`[segmentation] step ${E.id} returned non-image`);const R=a.stepIndex<H.length?H[a.stepIndex].id:null;p(R),a.artifact={kind:"image",image:x.image},a.stepIndex++,l(),r(`Done: ${E.id}`);return}if(E.id==="segmentation.threshold"){if(a.artifact.kind!=="image")throw new Error("[segmentation] threshold expected image input, got mask");const x=await qe("segmentation.threshold",{input:{kind:"image",image:a.artifact.image},width:C,height:S});a.artifact={kind:"mask",mask:x},a.stepIndex++,l(),p(null),r("Done: segmentation.threshold");return}if(E.id==="segmentation.morphology"){if(a.artifact.kind!=="mask")throw new Error("[segmentation] morphology expected mask input, got image");const x=await qe("segmentation.morphology",{mask:a.artifact.mask,width:C,height:S});a.artifact={kind:"mask",mask:x},a.stepIndex++,l(),p(null),r("Done: segmentation.morphology");return}}async function h(){if(a=c(),!a){r("No image");return}for(l(),r("Running all…");a&&a.stepIndex<H.length;)await v();r("Done")}function d(){a=null,g(),r("Idle");const E=e.segMaskCanvasEl.getContext("2d");E&&E.clearRect(0,0,e.segMaskCanvasEl.width,e.segMaskCanvasEl.height)}function i(){e.segRunBtn.addEventListener("click",()=>{X(e,async()=>{try{await h()}catch(E){O("[segmentation] runAll exception",{error:E instanceof Error?E.message:String(E)}),r("Failed")}})}),e.segNextBtn.addEventListener("click",()=>{X(e,async()=>{try{await v()}catch(E){O("[segmentation] nextStep exception",{error:E instanceof Error?E.message:String(E)}),r("Failed")}})}),e.segResetBtn.addEventListener("click",()=>d())}function u(){P("[segmentation] mount"),r("Idle")}function f(){P("[segmentation] refresh"),a&&l()}function m(){}function b(){n.dispose()}return{bind:i,mount:u,refresh:f,unmount:m,dispose:b}}function Ee(e,t,o){return Number.isFinite(e)?Math.max(t,Math.min(o,Math.trunc(e))):t}function io(e,t,o){return Math.round(.2126*e+.7152*t+.0722*o)}function gt(e){return{edgesDark:!!(e.edgesDark??!0),edgeThreshold:Ee(e.edgeThreshold??80,0,255),edgeDilate:Ee(e.edgeDilate??2,0,6),maxRegionPx:Ee(e.maxRegionPx??2e5,1e3,1e7)}}function ro(e,t,o){const{data:n,width:a,height:s}=e,r=new Uint8Array(a*s);for(let g=0,p=0;g<r.length;g++,p+=4){const l=n[p+0],c=n[p+1],v=n[p+2];if(n[p+3]===0){r[g]=0;continue}const d=io(l,c,v),i=t?d<=o:d>=255-o;r[g]=i?1:0}return r}function lo(e,t,o,n){if(n<=0)return e;let a=e;for(let s=0;s<n;s++){const r=new Uint8Array(t*o);for(let g=0;g<o;g++)for(let p=0;p<t;p++){const l=g*t+p;if(a[l]){r[l]=1;continue}let c=0;for(let v=-1;v<=1&&!c;v++){const h=g+v;if(!(h<0||h>=o))for(let d=-1;d<=1;d++){const i=p+d;if(!(i<0||i>=t)&&a[h*t+i]){c=1;break}}}r[l]=c}a=r}return a}function co(e,t,o,n,a,s){const r=t*n+e;if(o[r])return{ok:!1,message:"Click is on an edge; pick inside a region."};const g=new Uint8Array(n*a),p=new Int32Array(n*a),l=new Int32Array(n*a);let c=0,v=0;p[v]=e,l[v]=t,v++,g[r]=1;let h=1;for(;c<v;){const d=p[c],i=l[c];c++;const u=[[d-1,i],[d+1,i],[d,i-1],[d,i+1]];for(const[f,m]of u){if(f<0||f>=n||m<0||m>=a)continue;const b=m*n+f;if(!g[b]&&!o[b]&&(g[b]=1,p[v]=f,l[v]=m,v++,h++,h>s))return{ok:!1,message:`Region too large (>${s}px). Increase Max region or fix gaps.`}}}return{ok:!0,mask:g}}function uo(e,t,o,n){const a=new Uint8Array(o*n);for(let s=1;s<n-1;s++)for(let r=1;r<o-1;r++){const g=s*o+r;if(!e[g])continue;const p=(s-1)*o+r,l=(s+1)*o+r,c=s*o+(r-1),v=s*o+(r+1);(!e[p]||!e[l]||!e[c]||!e[v]||t[p]||t[l]||t[c]||t[v])&&(a[g]=1)}return a}function go(e,t,o,n){const a=gt(n),s=e.width,r=e.height;let g=ro(e,a.edgesDark,a.edgeThreshold);g=lo(g,s,r,a.edgeDilate);const p=co(t,o,g,s,r,a.maxRegionPx);if(!p.ok)return{ok:!1,message:p.message};const l=uo(p.mask,g,s,r);return{ok:!0,preview:{mask:p.mask,outline:l,w:s,h:r}}}function fo(e,t,o){const n=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),a=o.replace("#",""),s=parseInt(a.slice(0,2),16),r=parseInt(a.slice(2,4),16),g=parseInt(a.slice(4,6),16),p=n.data;for(let l=0,c=0;l<t.mask.length;l++,c+=4)t.mask[l]&&(p[c+0]=s,p[c+1]=r,p[c+2]=g);return n}function Ce(e,t,o){return Number.isFinite(e)?Math.max(t,Math.min(o,Math.trunc(e))):t}function Ge(e){const t=(e||"").trim();if(!t)return null;const o=t.startsWith("#")?t:`#${t}`;return/^#[0-9a-fA-F]{6}$/.test(o)?o.toLowerCase():null}function po(e){let t="#ff3b30",o=[],n=null;function a(u){e.colorsStatusEl.textContent=u||""}function s(){const u=!!e.edgesDarkEl.checked,f=Ce(parseInt(e.edgeMaskThresholdEl.value,10),0,255),m=Ce(parseInt(e.edgeDilateEl.value,10),0,6),b=Ce(parseInt(e.maxRegionPxEl.value,10),1e3,1e7);return e.edgeMaskThresholdEl.value=String(f),e.edgeDilateEl.value=String(m),e.maxRegionPxEl.value=String(b),gt({edgesDark:u,edgeThreshold:f,edgeDilate:m,maxRegionPx:b})}function r(u){const f=Ge(u);if(f){t=f;for(const m of Array.from(e.paletteEl.querySelectorAll(".paletteItem"))){const b=m.dataset.hex||"";m.classList.toggle("is-selected",b===t)}}}function g(){return t}function p(u){o=u.slice(),e.paletteEl.innerHTML="";for(const f of o){const m=Ge(f);if(!m)continue;const b=document.createElement("button");b.type="button",b.className="paletteItem",b.style.background=m,b.dataset.hex=m,b.setAttribute("role","listitem"),b.setAttribute("aria-label",`Select ${m}`),b.addEventListener("click",()=>{r(m)}),e.paletteEl.appendChild(b)}r(t)}function l(u){const f=e.colorsCanvasEl;f.width=u.width,f.height=u.height,f.getContext("2d").putImageData(u,0,0)}function c(u,f){l(u);const m=e.colorsCanvasEl.getContext("2d"),{outline:b,w:E,h:C}=f,S=m.getImageData(0,0,E,C),x=S.data;for(let R=0,D=0;R<b.length;R++,D+=4)b[R]&&(x[D+0]=255,x[D+1]=60,x[D+2]=60,x[D+3]=220);m.putImageData(S,0,0)}function v(u){e.btnColorsApplyEl.disabled=!u}function h(u){e.btnColorsCancelEl.disabled=!u}function d(u){n=u}function i(){a("Idle"),v(!1),h(!1),e.colorsCanvasEl.addEventListener("click",u=>{if(!n)return;const f=e.colorsCanvasEl.getBoundingClientRect(),m=Math.floor((u.clientX-f.left)/f.width*e.colorsCanvasEl.width),b=Math.floor((u.clientY-f.top)/f.height*e.colorsCanvasEl.height);n(m,b)})}return{bind:i,setStatus:a,getSettings:s,setSelectedColor:r,getSelectedColor:g,renderPalette:p,drawBase:l,drawPreview:c,setApplyEnabled:v,setCancelEnabled:h,onCanvasClick:d}}const mo=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#a2845e","#8e8e93","#1c1c1e","#ffffff","#000000","#4cd964","#5ac8fa","#ff6b6b","#7aa2ff","#f5a623","#50e3c2"];function ho(e,t){const o=po(e);let n=null,a=null;function s(v){o.setStatus(v)}function r(){const v=e.outCanvasEl.getContext("2d");if(!v)return null;const h=e.outCanvasEl.width,d=e.outCanvasEl.height;return h<=0||d<=0?null:v.getImageData(0,0,h,d)}function g(){const v=r();if(!v){n=null,a=null,o.setApplyEnabled(!1),o.setCancelEnabled(!1),s("No output available. Run Process first.");return}n=v,a=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),s("Ready. Pick a color, click inside a region.")}function p(){if(n){o.drawBase(n);return}const v=r();if(!v){s("No output available. Run Process first.");return}n=v,a=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),s("Loaded output. Pick a color, click inside a region.")}function l(){if(!n||!a)return;const v=o.getSelectedColor();n=fo(n,a,v),a=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),s("Fill applied. Click another region.")}function c(){n&&(a=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),s("Preview canceled."))}return{bind(){o.bind(),o.renderPalette(mo),o.onCanvasClick((v,h)=>{if(!n){s("No output available. Run Process first.");return}const d=o.getSettings(),i=go(n,v,h,d);if(!i.ok){a=null,o.setApplyEnabled(!1),o.setCancelEnabled(!1),s(i.message);return}a=i.preview,o.drawPreview(n,a),o.setApplyEnabled(!0),o.setCancelEnabled(!0),s("Preview shown. Apply fill or cancel.")}),e.btnColorsApplyEl.addEventListener("click",()=>l()),e.btnColorsCancelEl.addEventListener("click",()=>c()),e.btnColorsResetEl.addEventListener("click",()=>g()),e.tabColors.addEventListener("click",()=>{queueMicrotask(()=>p())}),s("Idle"),o.setApplyEnabled(!1),o.setCancelEnabled(!1)}}}const ge="beecontour.actionLog",vo=5e3;function bo(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function yo(e){return Array.isArray(e)?e:[e]}function fe(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}async function ae(){const e=await Y(ge),t=e==null?void 0:e[ge];return Array.isArray(t)?t:[]}async function ft(e){await J({[ge]:e})}async function W(e,t){const o=fe(vo,100,5e4),a=yo(e).map(p=>({...p,id:bo(),ts:Date.now()}));if(!a.length)return{total:(await ae()).length};const r=(await ae()).concat(a),g=r.length>o?r.slice(r.length-o):r;return await ft(g),{total:g.length}}async function Eo(e){const t=fe((e==null?void 0:e.limit)??200,1,5e4),o=fe((e==null?void 0:e.offset)??0,0,1e6);let a=await ae();e!=null&&e.kind&&(a=a.filter(g=>g.kind===e.kind)),e!=null&&e.scope&&(a=a.filter(g=>g.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(a=a.filter(g=>g.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(a=a.filter(g=>g.ts<=e.untilTs));const s=a.length;a=a.slice().reverse();const r=a.slice(o,o+t);return{total:s,items:r}}async function Co(e){let o=await ae();if(typeof e.beforeTs=="number"&&(o=o.filter(n=>n.ts>=e.beforeTs)),typeof e.keepLast=="number"){const n=fe(e.keepLast,0,5e4);n===0?o=[]:o.length>n&&(o=o.slice(o.length-n))}return await ft(o),{total:o.length}}async function wo(){await Le(ge)}async function So(e){const t=await ae();return JSON.stringify(t,null,2)}const Ke="0.0.9";async function xo(e){const t=new URL(e.opencvJsRel,document.baseURI).toString(),o=new URL(e.opencvWasmRel,document.baseURI).toString(),n=globalThis;n.Module=n.Module||{},n.Module.locateFile=a=>a.endsWith(".wasm")?o:a,n.Module.print=()=>{},n.Module.printErr=()=>{},n.cv||await ko(t),await Do(e.timeoutMs)}function ko(e){return new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0;const a=15e3,s=window.setTimeout(()=>{r(),o(new Error(`OpenCV script load timeout after ${a}ms: ${e}`))},a);function r(){window.clearTimeout(s),n.onload=null,n.onerror=null}n.onload=()=>{r(),t()},n.onerror=()=>{r(),o(new Error(`Failed to load OpenCV script: ${e}`))},document.head.appendChild(n)})}async function Do(e){var n;const t=Date.now(),o=globalThis;for(;Date.now()-t<e;){try{if(o.cv&&typeof o.cv.Mat=="function"){const a=new o.cv.Mat;(n=a.delete)==null||n.call(a);return}}catch{}await new Promise(a=>setTimeout(a,75))}throw new Error(`OpenCV initialization timeout after ${e}ms`)}async function Ro(){try{await xo({opencvJsRel:"../assets/opencv/opencv.js",opencvWasmRel:"../assets/opencv/opencv.wasm",timeoutMs:2e4}),Bn("opencv")}catch(e){throw An("opencv",e!=null&&e.message?String(e.message):String(e)),e}}function T(e,t,o){const n=document.createElement(e);if(t)for(const[a,s]of Object.entries(t))n.setAttribute(a,s);return typeof o=="string"&&(n.textContent=o),n}function Qe(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function To(e){return e.fallbackReason?`${e.effectiveEngine} (fallback)`:e.effectiveEngine}function Io(e){const t=[{value:"native",label:"Native"},{value:"auto",label:"Auto"},...e.canImplementOpenCv?[{value:"opencv",label:"OpenCV"}]:[]];return e.isRoot?t:[{value:"inherit",label:"Inherit"},...t]}function Mo(e,t,o){var a;const n=(a=e.storedParams)==null?void 0:a[t];return typeof n<"u"&&n!==o}function Lo(e){var v;const{node:t,compId:o,key:n,schema:a,value:s,handlers:r}=e,g=T("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),p=T("label",{class:"fieldInline"}),l=T("span",void 0,a.label);p.appendChild(l);let c;if(a.kind==="number"?(c=T("input"),c.type="number",typeof a.min=="number"&&(c.min=String(a.min)),typeof a.max=="number"&&(c.max=String(a.max)),typeof a.step=="number"&&(c.step=String(a.step)),c.value=String(s??a.default),c.addEventListener("change",()=>{const h=Number(c.value);r.onSetParam(o,n,Number.isFinite(h)?h:a.default)})):a.kind==="boolean"?(c=T("input"),c.type="checkbox",c.checked=!!s,c.addEventListener("change",()=>{r.onSetParam(o,n,!!c.checked)})):(c=T("input"),c.type="text",c.value=String(s??a.default),c.addEventListener("change",()=>{r.onSetParam(o,n,String(c.value??a.default))})),p.appendChild(c),g.appendChild(p),r.onResetParam&&typeof((v=t.storedParams)==null?void 0:v[n])<"u"){const h=T("button",{type:"button"},"Reset");h.addEventListener("click",d=>{var i;d.preventDefault(),(i=r.onResetParam)==null||i.call(r,o,n)}),g.appendChild(h)}return Mo(t,n,s)&&g.appendChild(T("span",{class:"muted",style:"font-size:12px;"},"override")),g}function pt(e){const{node:t,depth:o,isRoot:n,handlers:a}=e,s=T("div",{style:`margin-left:${Math.min(o*14,56)}px; margin-top:10px;`}),r=T("div",{style:"border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:10px; background:rgba(0,0,0,0.12);"}),g=T("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),p=T("div");p.appendChild(T("div",{style:"font-weight:700;"},t.title)),t.description&&p.appendChild(T("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},t.description)),t.isGroup&&p.appendChild(T("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},"Group (policy affects children)")),g.appendChild(p);const l=T("div",{class:"row",style:"align-items:center; gap:10px;"});l.appendChild(T("span",{class:"qBadge"},To(t)));const c=T("select");c.style.background="rgba(255,255,255,0.05)",c.style.border="1px solid rgba(255,255,255,0.08)",c.style.color="rgba(255,255,255,0.92)",c.style.borderRadius="10px",c.style.padding="6px 8px";const v=Io({isRoot:n,canImplementOpenCv:t.canImplementOpenCv});for(const f of v){const m=T("option");m.value=f.value,m.textContent=f.label,c.appendChild(m)}const h=new Set(v.map(f=>f.value)),d=t.effectivePolicy;h.has(d)?c.value=d:c.value=n?"native":"inherit",c.addEventListener("change",()=>{a.onSetPolicy(t.id,c.value)}),l.appendChild(c);const i=typeof t.storedPolicy<"u"||t.storedParams&&Object.keys(t.storedParams).length>0;if(a.onResetNode&&i){const f=T("button",{type:"button"},"Reset node");f.addEventListener("click",m=>{var b;m.preventDefault(),(b=a.onResetNode)==null||b.call(a,t.id)}),l.appendChild(f)}g.appendChild(l),r.appendChild(g),t.fallbackReason?r.appendChild(T("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},t.fallbackReason)):t.effectivePolicy==="opencv"&&!t.runtimeOpenCvReady&&r.appendChild(T("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},"OpenCV policy selected, but OpenCV is not available at runtime. It will fall back to native."));const u=Object.keys(t.paramsSchema??{});if(u.length>0){const f=T("div",{style:"margin-top:10px;"});f.appendChild(T("div",{class:"muted",style:"font-weight:600; margin-bottom:6px;"},"Parameters"));for(const m of u){const b=t.paramsSchema[m],E=t.effectiveParams[m];f.appendChild(Lo({node:t,compId:t.id,key:m,schema:b,value:E,handlers:a}))}r.appendChild(f)}if(t.children.length>0){const f=T("div",{style:"margin-top:10px;"});for(const m of t.children)f.appendChild(pt({node:m,depth:o+1,isRoot:!1,handlers:a}));r.appendChild(f)}return s.appendChild(r),s}function mt(e,t){let o=!1;function n(s){if(o)return;Qe(e);const r=s.scopeId==="app",g=T("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"});g.appendChild(T("div",{style:"font-weight:700;"},"Tuning")),g.appendChild(T("div",{class:"muted",style:"font-size:12px;"},`OpenCV runtime: ${s.runtime.opencvReady?"ready":"not available"}`)),e.appendChild(g),e.appendChild(pt({node:s.root,depth:0,isRoot:r,handlers:t}))}function a(){o=!0,Qe(e)}return{render:n,dispose:a}}function Po(){let e=!1,t={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},o=!1,n="",a="";function s(l){e=l}function r(l){t={...t,...l}}function g(l){o=l}function p(l){typeof l.general=="string"&&(n=l.general),typeof l.dev=="string"&&(a=l.dev)}return{get showDevTools(){return e},get dev(){return t},get debugEnabled(){return o},get generalStatus(){return n},get devStatus(){return a},setShowDevTools:s,setDev:r,setDebugEnabled:g,setStatus:p}}function Bo(e){function t(l){e.settingsGeneralStatusEl.textContent=l||""}function o(l){e.cfgStatusEl.textContent=l||""}function n(l){e.cfgShowDevToolsEl.checked=l}function a(l){e.tabLogs.hidden=!l,e.devConfigDetailsEl.classList.toggle("is-hidden",!l),l||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function s(l){e.cfgTraceConsoleEl.checked=!!l.traceConsole,e.cfgActionLogMaxEl.value=String(l.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(l.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(l.failureLogsPerRun??50)}function r(l){e.logsCbDebugEl.checked=l}function g(l,c){e.settingsVersionEl.textContent=l||"—",e.settingsGitHubLinkEl.href=c||"#",e.settingsGitHubLinkEl.hidden=!c}function p(l){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=l,e.cfgActionLogMaxEl.disabled=l,e.cfgDebugTraceMaxEl.disabled=l,e.cfgFailureLogsPerRunEl.disabled=l,e.btnCfgResetDefaults.disabled=l,e.logsCbDebugEl.disabled=l,e.cfgUseOpenCvEl.disabled=l}return{setGeneralStatus:t,setDevStatus:o,setShowDevToolsChecked:n,setDevToolsVisible:a,setDevConfig:s,setDebugEnabledChecked:r,setAbout:g,setBusy:p}}const we="template.settings.showDevTools",Se="beecontour.settings.engine.useOpenCv";function Ao(){var e,t;try{const o=(e=globalThis==null?void 0:globalThis.chrome)==null?void 0:e.runtime,n=(t=o==null?void 0:o.getManifest)==null?void 0:t.call(o),a=typeof(n==null?void 0:n.version)=="string"?n.version:"";if(P("Settings: getManifestVersion manifest found version is ",{v:a}),a)return a}catch{}return P("Settings: getManifestVersion fallback",{APP_VERSION:Ke}),Ke}function xe(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??z.actionLogMax),debugTraceMax:Number(e.debugTraceMax??z.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??z.failureLogsPerRun)}}function Oo(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:q(e.cfgActionLogMaxEl.value,100,5e4,z.actionLogMax),debugTraceMax:q(e.cfgDebugTraceMaxEl.value,100,5e4,z.debugTraceMax),failureLogsPerRun:q(e.cfgFailureLogsPerRunEl.value,0,5e4,z.failureLogsPerRun)}}async function He(e){const t=st;return typeof t.setEnabled=="function"?(await t.setEnabled(e),{ok:!0}):typeof t.enable=="function"&&typeof t.disable=="function"?(await(e?t.enable():t.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function $o(e,t){const o=Po(),n=Bo(e),a=$e({getRuntimeAvailability:()=>({opencvReady:e.cfgUseOpenCvEl.checked&&K()})}),s=mt(e.tuningMountEl,{onSetPolicy:async(y,w)=>{await a.setEnginePolicy(y,w),await b("policy change")},onSetParam:async(y,w,B)=>{await a.setParam(y,w,B),await b("param change")},onResetNode:async y=>{await a.resetNode(y),await b("reset node")},onResetParam:async(y,w)=>{await a.resetParam(y,w),await b("reset param")}});function r(y){e.settingsEngineBoxEl.classList.toggle("is-hidden",!1)}async function g(){const y=await Y([Se]).catch(()=>({}));return(y==null?void 0:y[Se])===!0}async function p(y){await J({[Se]:!!y}).catch(()=>null)}function l(y){var w;e.cfgUseOpenCvEl.checked=y,(w=e.cfgUseOpenCvEl.closest(".switch"))==null||w.classList.toggle("is-disabled",e.cfgUseOpenCvEl.disabled)}function c(y){e.cfgOpenCvSpinner.classList.toggle("is-hidden",!y),e.cfgOpenCvSpinner.setAttribute("aria-hidden",y?"false":"true")}function v(y){e.cfgOpenCvStatus.textContent=y||""}function h(y){e.cfgOpenCvReport.textContent=y||""}async function d(){if(U())return;if(!!!e.cfgUseOpenCvEl.checked){await p(!1),c(!1),v(K()?"OpenCV loaded (native mode)":"Native mode"),h("Native mode. OpenCV is optional and demo-only."),await b("opencv mode disabled");return}c(!0),v("Loading OpenCV…"),h("Loading OpenCV…");try{if(await X(e,async()=>{await Ro()}),!K())throw new Error("OpenCV load returned but runtime is not injected.");await p(!0),v("OpenCV mode enabled"),h("OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV."),await b("opencv mode enabled")}catch(w){const B=String((w==null?void 0:w.message)??w);await p(!1),l(!1),v("OpenCV load failed"),h(`ERROR

${B}`),O("[settings] OpenCV toggle failed",{msg:B})}finally{c(!1)}}async function i(){const y=await Y([we]).catch(()=>({}));return(y==null?void 0:y[we])===!0}async function u(y){await J({[we]:!!y}).catch(()=>null)}function f(y){o.setShowDevTools(y),n.setShowDevToolsChecked(y),n.setDevToolsVisible(y)}async function m(){const y=await i();f(y),P("Settings: boot applyDevToolsVisibility",{showDevTools:y})}async function b(y){try{const w=await a.loadTree("app");s.render(w),P("[settings] tuning rendered",{reason:y,opencvInjected:K(),opencvMode:!!e.cfgUseOpenCvEl.checked})}catch(w){O("[settings] tuning render failed",{reason:y,msg:String((w==null?void 0:w.message)??w)}),e.tuningMountEl.textContent="Tuning UI failed to load (see console)."}}async function E(){var M;n.setBusy(U());const y=await i();f(y),await Ne().catch(()=>null);const w=le();o.setDev(xe(w)),n.setDevConfig(o.dev);const B=st;let I=!1;try{typeof B.isEnabled=="function"?I=!!await B.isEnabled():I=!!B.enabled}catch(L){j("Settings: failed to read debug enabled state",{error:L instanceof Error?L.message:String(L)})}o.setDebugEnabled(I),n.setDebugEnabledChecked(I),n.setAbout(Ao()||"—",((M=e.settingsGitHubLinkEl)==null?void 0:M.href)||"#"),r();{const L=await g();l(L),c(!1);const N=K();L?(v(N?"OpenCV mode enabled":"OpenCV mode (not loaded)"),h(N?"OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV.":"OpenCV mode is enabled, but OpenCV is not loaded yet. Toggle OFF then ON to load OpenCV.")):(v(N?"OpenCV loaded (native mode)":"Native mode"),h("Native mode. OpenCV is optional and demo-only."))}n.setGeneralStatus(""),n.setDevStatus(""),await b("loadAll"),P("Settings: loaded",{showDevTools:y,debugTraceEnabled:I,dev:o.dev,opencvInjected:K()})}async function C(){const y=!!e.cfgShowDevToolsEl.checked;f(y),await u(y),W({kind:"run",scope:"settings",message:y?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:y}}),P("Settings: ui toggle showDevTools",{showDevTools:y}),n.setGeneralStatus(y?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>n.setGeneralStatus(""),1200)}async function S(){const y=Oo(e);n.setDevStatus("Saving…");try{await Ze(y)}catch(w){O("Settings: failed to save dev config",{error:w instanceof Error?w.message:String(w),next:y}),n.setDevStatus("Save failed."),setTimeout(()=>n.setDevStatus(""),1200);return}o.setDev(xe(y)),n.setDevConfig(o.dev),W({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:y}),P("Settings: devConfig updated",y),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}async function x(){n.setDevStatus("Resetting…");try{await vn(),await Ne().catch(()=>null);const w=le();o.setDev(xe(w)),n.setDevConfig(o.dev)}catch(w){O("Settings: failed to reset dev config defaults",{error:w instanceof Error?w.message:String(w)}),n.setDevStatus("Reset failed."),setTimeout(()=>n.setDevStatus(""),1200);return}const y=await He(!1);y.ok?(o.setDebugEnabled(!1),n.setDebugEnabledChecked(!1)):(j("Settings: failed to reset debug enabled state",{error:y.error||"unknown error"}),W({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:y.error||"unknown error"})),W({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...z,debugEnabled:!1}}),P("Settings: reset defaults",{...z,debugEnabled:!1}),n.setDevStatus("Reset."),setTimeout(()=>n.setDevStatus(""),1200)}async function R(){const y=!!e.logsCbDebugEl.checked;n.setDevStatus("Saving…");const w=await He(y);if(!w.ok){e.logsCbDebugEl.checked=!y,n.setDevStatus(`Save failed: ${w.error||"unknown error"}`),O("Settings: failed to change debug enabled state",{error:w.error||"unknown error",enabled:y}),W({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:w.error||"unknown error",meta:{enabled:y}});return}o.setDebugEnabled(y),W({kind:"run",scope:"settings",message:y?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:y}}),P("Settings: debug enabled changed",{enabled:y}),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}const D=t.on(()=>{});function k(){e.cfgShowDevToolsEl.addEventListener("change",()=>{C()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{U()||S()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{U()||S()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{U()||S()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{U()||S()}),e.btnCfgResetDefaults.addEventListener("click",()=>{U()||x()}),e.logsCbDebugEl.addEventListener("change",()=>{U()||R()}),e.cfgUseOpenCvEl.addEventListener("change",()=>{d()}),m().catch(y=>{j("Settings: initDevToolsVisibility failed",{error:y instanceof Error?y.message:String(y)})})}return{id:"settings",refresh(){E().catch(y=>{O("Settings: refresh failed",{error:y instanceof Error?y.message:String(y)})})},mount(){E().catch(y=>{O("Settings: mount failed",{error:y instanceof Error?y.message:String(y)})})},unmount(){},bind:k,dispose(){D()}}}function Vo(){let e=[],t=0;function o(n){e=n.items,t=n.total}return{get items(){return e},get total(){return t},set:o}}function No(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function We(e,t){const o=[];o.push(`Total entries: ${t.total}`),o.push("");for(const n of t.items){const a=typeof n.ok=="boolean"?n.ok?"ok":"fail":"",s=[];typeof n.status=="number"&&s.push(`status=${n.status}`),a&&s.push(a);const r=[n.scope,n.kind].filter(Boolean).join("/");o.push(`[${No(n.ts)}] ${r}${s.length?` (${s.join(", ")})`:""}`),o.push(`  ${n.message}`),n.error&&o.push(`  error: ${n.error}`),o.push("")}e.textContent=o.join(`
`),e.scrollTop=0}function Uo(e){function t(r){e.logsStatusEl.textContent=r}function o(r){e.debugStatusEl.textContent=r}function n(r){e.logsCbDebugEl.checked=r}function a(r){We(e.logsOutEl,{total:r.total,items:r.items.map(g=>({ts:g.ts,message:g.message,scope:g.scope,kind:g.kind,ok:g.ok,status:g.status,error:g.error,meta:g.meta}))})}function s(r){We(e.debugOutEl,{total:r.total,items:r.items.map(g=>({ts:g.ts,message:g.message,scope:g.scope,kind:g.kind,ok:g.ok,status:g.status,error:g.error,meta:g.meta}))})}return{setAuditStatus:t,setDebugStatus:o,setDebugChecked:n,renderAudit:a,renderDebug:s}}const Ye="beecontour";function zo(e,t){const o=Vo(),n=Uo(e);async function a(){n.setAuditStatus("Loading…"),_(e,!0);try{const i=q(e.logsLimitEl.value,10,5e3,200),u=await Eo({limit:i,reverse:!0});o.set(u),n.renderAudit({items:o.items,total:o.total}),n.setAuditStatus(`Showing ${o.items.length} (newest first)`)}catch(i){n.setAuditStatus(`Failed: ${(i==null?void 0:i.message)||String(i)}`)}finally{_(e,!1)}}async function s(){n.setDebugStatus("Loading…"),_(e,!0);try{const i=q(e.debugLimitEl.value,10,5e3,200),u=await ot({limit:i,reverse:!0});n.renderDebug(u),n.setDebugStatus(`Showing ${u.items.length} (newest first)`)}catch(i){n.setDebugStatus(`Failed: ${(i==null?void 0:i.message)||String(i)}`)}finally{_(e,!1)}}async function r(){const i=await Pe();n.setDebugChecked(i)}async function g(i){if(await tt(i),n.setDebugChecked(i),!i){n.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}n.setDebugStatus("Debug ON."),await s()}async function p(){const i=q(e.logsTrimKeepEl.value,0,5e4,2e3);n.setAuditStatus("Trimming…"),_(e,!0);try{const u=await Co({keepLast:i});await a(),n.setAuditStatus(`Trimmed. Remaining: ${u.total}`)}catch(u){n.setAuditStatus(`Trim failed: ${(u==null?void 0:u.message)||String(u)}`)}finally{_(e,!1)}}async function l(){n.setAuditStatus("Clearing…"),_(e,!0);try{await wo(),await a(),n.setAuditStatus("Cleared.")}catch(i){n.setAuditStatus(`Clear failed: ${(i==null?void 0:i.message)||String(i)}`)}finally{_(e,!1)}}async function c(){n.setAuditStatus("Exporting…");try{const i=await So({pretty:!0}),u=new Blob([i],{type:"application/json"}),f=URL.createObjectURL(u),m=document.createElement("a");m.href=f,m.download=`${Ye}-audit-${Date.now()}.json`,m.click(),setTimeout(()=>URL.revokeObjectURL(f),1e3),n.setAuditStatus("Exported.")}catch(i){n.setAuditStatus(`Export failed: ${(i==null?void 0:i.message)||String(i)}`)}}async function v(){n.setDebugStatus("Clearing…"),_(e,!0);try{await nt(),await s(),n.setDebugStatus("Cleared.")}catch(i){n.setDebugStatus(`Clear failed: ${(i==null?void 0:i.message)||String(i)}`)}finally{_(e,!1)}}async function h(){n.setDebugStatus("Exporting…");try{const i=await at({pretty:!0}),u=new Blob([i],{type:"application/json"}),f=URL.createObjectURL(u),m=document.createElement("a");m.href=f,m.download=`${Ye}-debug-${Date.now()}.json`,m.click(),setTimeout(()=>URL.revokeObjectURL(f),1e3),n.setDebugStatus("Exported.")}catch(i){n.setDebugStatus(`Export failed: ${(i==null?void 0:i.message)||String(i)}`)}}function d(){e.btnLogsRefresh.addEventListener("click",()=>{U()||a()}),e.btnLogsTrim.addEventListener("click",()=>{U()||p()}),e.btnLogsClear.addEventListener("click",()=>{U()||l()}),e.btnLogsExport.addEventListener("click",()=>{U()||c()}),e.logsCbDebugEl.addEventListener("change",()=>{U()||g(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{U()||s()}),e.btnDebugClear.addEventListener("click",()=>{U()||v()}),e.btnDebugExport.addEventListener("click",()=>{U()||h()})}return{id:"logs",bind:d,mount(){r(),a(),s()},unmount(){},dispose(){}}}function Fo(e,t){if(e.id===t)return e;const o=[...e.children??[]];for(;o.length>0;){const n=o.shift();if(n.id===t)return n;for(const a of n.children??[])o.push(a)}throw new Error(`[tuning] scopeRootId not found in VM tree: ${t}`)}function jo(e){const t=$e({getRuntimeAvailability:e.getRuntimeAvailability}),o=[];let n=!1;async function a(){return await t.loadTree("app")}async function s(){if(n)return;const u=await a();for(const f of o){if(f.scopeRootId==="app"){f.view.render(u);continue}const m=Fo(u.root,f.scopeRootId);f.view.render({...u,scopeId:f.scopeRootId,root:m})}}async function r(u,f){await t.setEnginePolicy(u,f),e.actionLogAppend(`[tuning] policy ${u} = ${f}`),e.debugTraceAppend(`[tuning] setPolicy id=${u} policy=${f}`),await s()}async function g(u,f,m){await t.setParam(u,f,m),e.actionLogAppend(`[tuning] param ${u}.${f} = ${String(m)}`),e.debugTraceAppend(`[tuning] setParam id=${u} key=${f} value=${String(m)}`),await s()}async function p(u){await t.resetNode(u),e.actionLogAppend(`[tuning] reset node ${u}`),e.debugTraceAppend(`[tuning] resetNode id=${u}`),await s()}async function l(u,f){await t.resetParam(u,f),e.actionLogAppend(`[tuning] reset param ${u}.${f}`),e.debugTraceAppend(`[tuning] resetParam id=${u} key=${f}`),await s()}async function c(u){var f,m;if(!n){if(u.policies)for(const b of u.policies)await t.setEnginePolicy(b.id,b.policy);if(u.params)for(const b of u.params)await t.setParam(b.id,b.key,b.value);e.actionLogAppend(`[tuning] preset ${u.id} (${u.title})`),e.debugTraceAppend(`[tuning] applyPreset id=${u.id} title=${u.title} policies=${((f=u.policies)==null?void 0:f.length)??0} params=${((m=u.params)==null?void 0:m.length)??0}`),await s()}}function v(u){if(n)return;const{mountEl:f,scopeRootId:m}=u;if(o.some(E=>E.mountEl===f))return;const b=mt(f,{onSetPolicy:r,onSetParam:g,onResetNode:p,onResetParam:l});o.push({mountEl:f,scopeRootId:m,view:b}),s()}function h(u){const f=o.findIndex(m=>m.mountEl===u);f<0||(o[f].view.dispose(),o.splice(f,1))}async function d(){await s()}function i(){n=!0;for(const u of o)u.view.dispose();o.length=0}return{mount:v,unmount:h,refresh:d,applyPreset:c,dispose:i}}(function(){const t=dn(),o=pn();o.start();const n=yn();globalThis.__APP__={...globalThis.__APP__,cache:n};const a=jo({getRuntimeAvailability:()=>({opencvReady:!1}),debugTraceAppend:v=>Be({scope:"panel",kind:"debug",message:v}),actionLogAppend:v=>W({scope:"panel",kind:"info",message:v})});a.mount({mountEl:t.tuningMountEl,scopeRootId:"app"}),a.mount({mountEl:t.contourTuningMountEl,scopeRootId:"contour"});const s=eo(t),r=ho(t),g=so(t,o,a),p=$o(t,o),l=zo(t);s.bind(),g.bind(),r.bind(),p.bind(),l.bind();const c=bn(t,{contour:s,segmentation:g,colors:r,settings:p,logs:l});c.bind(),c.boot()})();
