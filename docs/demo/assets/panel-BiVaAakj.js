import{_ as Mn}from"./index-BZY-xxQi.js";function Dn(){function e(vt,Ln){if(!vt)throw new Error(`[dom] Missing #${Ln}`);return vt}const t=e(document.getElementById("appRoot"),"appRoot"),i=e(document.getElementById("tabImage"),"tabImage"),n=e(document.getElementById("tabColors"),"tabColors"),o=e(document.getElementById("tabSettings"),"tabSettings"),a=e(document.getElementById("tabLogs"),"tabLogs"),s=e(document.getElementById("tabPipeline"),"tabPipeline"),l=e(document.getElementById("tabBuilder"),"tabBuilder"),p=e(document.getElementById("viewImage"),"viewImage"),r=e(document.getElementById("viewColors"),"viewColors"),g=e(document.getElementById("viewSettings"),"viewSettings"),u=e(document.getElementById("viewLogs"),"viewLogs"),h=e(document.getElementById("viewPipeline"),"viewPipeline"),c=e(document.getElementById("viewBuilder"),"viewBuilder"),d=e(document.getElementById("dropZone"),"dropZone"),m=e(document.getElementById("fileInput"),"fileInput"),v=e(document.getElementById("srcCanvas"),"srcCanvas"),y=e(document.getElementById("pipelineStatus"),"pipelineStatus"),b=e(document.getElementById("pipelineTuningMount"),"pipelineTuningMount"),x=e(document.getElementById("pipelineViewMount"),"pipelineViewMount"),w=e(document.getElementById("builderImportFile"),"builderImportFile"),C=e(document.getElementById("btnBuilderExport"),"btnBuilderExport"),E=e(document.getElementById("builderStatus"),"builderStatus"),L=e(document.getElementById("colorsCanvas"),"colorsCanvas"),T=e(document.getElementById("palette"),"palette"),B=e(document.getElementById("btnColorsApply"),"btnColorsApply"),f=e(document.getElementById("btnColorsCancel"),"btnColorsCancel"),$=e(document.getElementById("btnColorsReset"),"btnColorsReset"),U=e(document.getElementById("edgesDark"),"edgesDark"),z=e(document.getElementById("edgeMaskThreshold"),"edgeMaskThreshold"),M=e(document.getElementById("edgeDilate"),"edgeDilate"),I=e(document.getElementById("maxRegionPx"),"maxRegionPx"),S=e(document.getElementById("colorsStatus"),"colorsStatus"),P=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),k=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),A=e(document.getElementById("devConfigDetails"),"devConfigDetails"),D=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),R=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),V=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),O=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),H=e(document.getElementById("logsCbDebug"),"logsCbDebug"),N=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),J=e(document.getElementById("cfgStatus"),"cfgStatus"),Y=e(document.getElementById("cfgOpenCvSpinner"),"cfgOpenCvSpinner"),le=e(document.getElementById("cfgOpenCvStatus"),"cfgOpenCvStatus"),se=e(document.getElementById("cfgOpenCvReport"),"cfgOpenCvReport"),X=e(document.getElementById("settingsEngineBox"),"settingsEngineBox"),ne=e(document.getElementById("cfgUseOpenCv"),"cfgUseOpenCv"),Ee=e(document.getElementById("tuningMount"),"tuningMount"),qe=e(document.getElementById("settingsVersion"),"settingsVersion"),Ze=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),bn=e(document.getElementById("logsLimit"),"logsLimit"),vn=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),wn=e(document.getElementById("logsStatus"),"logsStatus"),Cn=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),En=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),kn=e(document.getElementById("btnLogsExport"),"btnLogsExport"),In=e(document.getElementById("btnLogsClear"),"btnLogsClear"),xn=e(document.getElementById("logsOut"),"logsOut"),Sn=e(document.getElementById("debugLimit"),"debugLimit"),Pn=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),$n=e(document.getElementById("btnDebugExport"),"btnDebugExport"),An=e(document.getElementById("btnDebugClear"),"btnDebugClear"),Rn=e(document.getElementById("debugStatus"),"debugStatus"),Tn=e(document.getElementById("debugOut"),"debugOut");return{rootEl:t,tabImage:i,tabColors:n,tabSettings:o,tabLogs:a,tabPipeline:s,tabBuilder:l,viewImage:p,viewColors:r,viewSettings:g,viewLogs:u,viewPipeline:h,viewBuilder:c,dropZoneEl:d,fileInputEl:m,srcCanvasEl:v,pipelineStatusEl:y,pipelineTuningMountEl:b,pipelineViewMountEl:x,builderImportFileEl:w,btnBuilderExportEl:C,builderStatusEl:E,colorsCanvasEl:L,paletteEl:T,btnColorsApplyEl:B,btnColorsCancelEl:f,btnColorsResetEl:$,edgesDarkEl:U,edgeMaskThresholdEl:z,edgeDilateEl:M,maxRegionPxEl:I,colorsStatusEl:S,cfgShowDevToolsEl:P,settingsGeneralStatusEl:k,devConfigDetailsEl:A,cfgTraceConsoleEl:D,cfgActionLogMaxEl:R,cfgDebugTraceMaxEl:V,cfgFailureLogsPerRunEl:O,logsCbDebugEl:H,btnCfgResetDefaults:N,cfgStatusEl:J,settingsVersionEl:qe,settingsGitHubLinkEl:Ze,cfgOpenCvSpinner:Y,cfgOpenCvStatus:le,cfgOpenCvReport:se,settingsEngineBoxEl:X,cfgUseOpenCvEl:ne,tuningMountEl:Ee,logsLimitEl:bn,btnLogsRefresh:vn,logsStatusEl:wn,logsTrimKeepEl:Cn,btnLogsTrim:En,btnLogsExport:kn,btnLogsClear:In,logsOutEl:xn,debugLimitEl:Sn,btnDebugRefresh:Pn,btnDebugExport:$n,btnDebugClear:An,debugStatusEl:Rn,debugOutEl:Tn}}const On=new Set;function Bn(e){On.add(e)}function wt(e){return`./${String(e||"").replace(/^\/+/,"")}`}function Un(){const e=new Set;function t(n){return e.add(n),()=>e.delete(n)}function i(){Bn(o=>{for(const a of e)a(o)})}return{on:t,start:i}}const Vn=new Set;function Ht(e){for(const t of Vn)t(e,"local")}function xe(e){const t=localStorage.getItem(e);if(t!==null)try{return JSON.parse(t)}catch{return t}}function zn(e,t){localStorage.setItem(e,JSON.stringify(t))}async function pe(e){if(typeof e=="string")return{[e]:xe(e)};if(Array.isArray(e)){const i={};for(const n of e)i[n]=xe(n);return i}const t={};for(const[i,n]of Object.entries(e))t[i]=localStorage.getItem(i)!==null?xe(i):n;return t}async function ue(e){const t={};for(const[i,n]of Object.entries(e)){const o=xe(i);zn(i,n),t[i]={oldValue:o,newValue:n}}Ht(t)}async function mt(e){const t=Array.isArray(e)?e:[e],i={};for(const n of t){const o=xe(n);localStorage.removeItem(n),i[n]={oldValue:o,newValue:void 0}}Ht(i)}function de(e,t,i,n){const o=Number(String(e??"").trim());return Number.isFinite(o)?Math.max(t,Math.min(i,Math.floor(o))):n}const ot="beemage.devConfig",te={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let at=!1,Ve={...te};function Wt(e){const t=e||{};return{traceConsole:!!t.traceConsole,actionLogMax:de(t.actionLogMax??te.actionLogMax,100,5e4,te.actionLogMax),debugTraceMax:de(t.debugTraceMax??te.debugTraceMax,100,5e4,te.debugTraceMax),failureLogsPerRun:de(t.failureLogsPerRun??te.failureLogsPerRun,0,5e4,te.failureLogsPerRun)}}async function st(){if(at)return;const e=await pe([ot]).catch(()=>({}));Ve=Wt(e==null?void 0:e[ot]),at=!0}function ze(){return Ve}async function Jt(e){Ve=Wt(e),at=!0,await ue({[ot]:Ve}).catch(()=>null)}async function Nn(){await Jt({...te})}function jn(e,t){const i={pipeline:e.tabPipeline,image:e.tabImage,builder:e.tabBuilder,colors:e.tabColors,settings:e.tabSettings,logs:e.tabLogs},n={pipeline:e.viewPipeline,image:e.viewImage,builder:e.viewBuilder,colors:e.viewColors,settings:e.viewSettings,logs:e.viewLogs};let o="image";const a=new Set;function s(){const c=ze();return!!(c!=null&&c.traceConsole)}function l(){const c=globalThis;c.__bctGlobalErrorHooksInstalled||(c.__bctGlobalErrorHooksInstalled=!0,window.addEventListener("error",d=>{var v;const m=d;console.error("[panel] window error",{message:m.message,filename:m.filename,lineno:m.lineno,colno:m.colno,error:m.error?String(m.error):null,stack:(v=m.error)!=null&&v.stack?String(m.error.stack):null})}),window.addEventListener("unhandledrejection",d=>{var m;console.error("[panel] unhandledrejection",{reason:d.reason?String(d.reason):null,stack:(m=d.reason)!=null&&m.stack?String(d.reason.stack):null})}))}s()&&l();function p(c){Object.keys(i).forEach(d=>{const m=d===c;i[d].classList.toggle("is-active",m),i[d].setAttribute("aria-selected",m?"true":"false"),n[d].hidden=!m,n[d].classList.toggle("is-active",m)})}function r(c){var d,m,v,y,b,x,w,C;if(c===o){(m=(d=t[c]).refresh)==null||m.call(d);return}(y=(v=t[o]).unmount)==null||y.call(v),o=c,p(o),a.has(o)?(C=(w=t[o]).refresh)==null||C.call(w):(a.add(o),(x=(b=t[o]).mount)==null||x.call(b))}function g(){i.image.addEventListener("click",c=>{var d;(d=c.preventDefault)==null||d.call(c),r("image")}),i.pipeline.addEventListener("click",c=>{var d;(d=c.preventDefault)==null||d.call(c),r("pipeline")}),i.colors.addEventListener("click",c=>{var d;(d=c.preventDefault)==null||d.call(c),r("colors")}),i.settings.addEventListener("click",c=>{var d;(d=c.preventDefault)==null||d.call(c),r("settings")}),i.logs.addEventListener("click",c=>{var d;(d=c.preventDefault)==null||d.call(c),r("logs")}),i.builder.addEventListener("click",c=>{var d;(d=c.preventDefault)==null||d.call(c),r("builder")})}function u(){var c,d,m,v;o="image",p(o),Object.keys(t).forEach(y=>{var b,x;return(x=(b=t[y]).boot)==null?void 0:x.call(b)}),a.has(o)?(v=(m=t[o]).refresh)==null||v.call(m):(a.add(o),(d=(c=t[o]).mount)==null||d.call(c))}function h(){Object.keys(t).forEach(c=>{var d,m;return(m=(d=t[c]).dispose)==null?void 0:m.call(d)})}return{bind:g,boot:u,activate:r,dispose:h}}function Ct(e){const t=e.items.length;return{items:e.items,counts:{items:t},meta:e.meta}}function _n(){const e={items:[],meta:{}},t=new Set;function i(){const r=Ct(e);for(const g of t)try{g(r)}catch{}}function n(){return Ct(e)}function o(r){t.add(r);try{r(n())}catch{}return()=>t.delete(r)}function a(){e.items=[],e.meta={},i()}function s(r){e.meta.scopeUpdatedSince=r,i()}function l(){return String(e.meta.scopeUpdatedSince||"")}function p(r,g){e.items=r.slice(),e.meta.updatedTs=Date.now(),typeof(g==null?void 0:g.limit)=="number"&&(e.meta.limit=g.limit),i()}return{getSnapshot:n,subscribe:o,getScopeUpdatedSince:l,clearAll:a,setScopeUpdatedSince:s,setItems:p}}function Fn(e,t){function i(l){e.dropZoneEl.classList.toggle("is-hover",l)}function n(l,p){const r=l.getContext("2d",{willReadFrequently:!0});if(!r)return;const g=Math.max(1,l.width),u=Math.max(1,l.height);r.clearRect(0,0,g,u);const h=p.naturalWidth||p.width,c=p.naturalHeight||p.height;if(!h||!c)return;const d=Math.min(g/h,u/c),m=Math.max(1,Math.round(h*d)),v=Math.max(1,Math.round(c*d)),y=Math.floor((g-m)/2),b=Math.floor((u-v)/2);r.drawImage(p,y,b,m,v)}function o(l){n(e.srcCanvasEl,l)}function a(l){t.lastError=void 0,t.loadedImageName=l,t.hasImage=!0}function s(l){t.lastError=l,t.hasImage=!1}return{setHover:i,drawImageToSource:o,showLoadOk:a,showLoadError:s}}function Gn(){return{loadedImageName:null,hasImage:!1,lastError:void 0}}const Ne="beemage.actionLog",Kn=5e3;function Hn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function Wn(e){return Array.isArray(e)?e:[e]}function je(e,t,i){return Math.max(t,Math.min(i,Math.floor(e)))}async function Se(){const e=await pe(Ne),t=e==null?void 0:e[Ne];return Array.isArray(t)?t:[]}async function qt(e){await ue({[Ne]:e})}async function _(e,t){const i=je(Kn,100,5e4),o=Wn(e).map(p=>({...p,id:Hn(),ts:Date.now()}));if(!o.length)return{total:(await Se()).length};const s=(await Se()).concat(o),l=s.length>i?s.slice(s.length-i):s;return await qt(l),{total:l.length}}async function Jn(e){const t=je((e==null?void 0:e.limit)??200,1,5e4),i=je((e==null?void 0:e.offset)??0,0,1e6);let o=await Se();e!=null&&e.kind&&(o=o.filter(l=>l.kind===e.kind)),e!=null&&e.scope&&(o=o.filter(l=>l.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(o=o.filter(l=>l.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(o=o.filter(l=>l.ts<=e.untilTs));const a=o.length;o=o.slice().reverse();const s=o.slice(i,i+t);return{total:a,items:s}}async function qn(e){let i=await Se();if(typeof e.beforeTs=="number"&&(i=i.filter(n=>n.ts>=e.beforeTs)),typeof e.keepLast=="number"){const n=je(e.keepLast,0,5e4);n===0?i=[]:i.length>n&&(i=i.slice(i.length-n))}return await qt(i),{total:i.length}}async function Zn(){await mt(Ne)}async function Yn(e){const t=await Se();return JSON.stringify(t,null,2)}const Pe="beemage.debugTrace",rt="beemage.debugTrace.enabled",Xn=2e3;function Qn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function lt(e,t,i){return Math.max(t,Math.min(i,Math.floor(e)))}async function _e(){const e=await pe(Pe),t=e==null?void 0:e[Pe];return Array.isArray(t)?t:[]}async function ei(e){await ue({[Pe]:e})}async function yt(){const e=await pe(rt);return!!(e!=null&&e[rt])}async function Zt(e){await ue({[rt]:!!e}),e||await mt(Pe)}async function Yt(){await mt(Pe)}async function Z(e,t){if(!await yt())return{total:0};const n=lt((t==null?void 0:t.max)??Xn,100,5e4),o=(Array.isArray(e)?e:[e]).map(p=>({...p,id:Qn(),ts:Date.now()}));if(!o.length)return{total:(await _e()).length};const s=(await _e()).concat(o),l=s.length>n?s.slice(s.length-n):s;return await ei(l),{total:l.length}}async function Xt(e){const t=lt((e==null?void 0:e.limit)??200,1,5e4),i=lt((e==null?void 0:e.offset)??0,0,1e6),n=(e==null?void 0:e.reverse)??!0,o=await _e(),a=o.length,l=(n?o.slice().reverse():o).slice(i,i+t);return{total:a,items:l}}async function Qt(e){const t=await _e();return JSON.stringify(t,null,e!=null&&e.pretty?2:0)}const en=Object.freeze(Object.defineProperty({__proto__:null,append:Z,clear:Yt,exportJson:Qt,isEnabled:yt,list:Xt,setEnabled:Zt},Symbol.toStringTag,{value:"Module"}));function ti(e,t){const i=Gn(),n=Fn(e,i);async function o(g){if(!g.type.startsWith("image/"))throw new Error(`Unsupported file type: ${g.type||"unknown"}`);const u=URL.createObjectURL(g);try{const h=new Image;return h.decoding="async",h.src=u,typeof h.decode=="function"?await h.decode():await new Promise((c,d)=>{h.onload=()=>c(),h.onerror=()=>d(new Error("Image decode failed."))}),h}finally{URL.revokeObjectURL(u)}}async function a(g){const u=await o(g);n.drawImageToSource(u),n.showLoadOk(g.name),_({scope:"panel",kind:"info",message:`Input loaded: ${g.name}`}),Z({scope:"panel",kind:"info",message:"Mage input loaded into srcCanvas",meta:{name:g.name,type:g.type,size:g.size,canvasW:e.srcCanvasEl.width,canvasH:e.srcCanvasEl.height,naturalW:u.naturalWidth||u.width,naturalH:u.naturalHeight||u.height}})}function s(){e.dropZoneEl.addEventListener("dragover",g=>{g.preventDefault(),n.setHover(!0)}),e.dropZoneEl.addEventListener("dragleave",()=>n.setHover(!1)),e.dropZoneEl.addEventListener("drop",g=>{var h,c;g.preventDefault(),n.setHover(!1);const u=(c=(h=g.dataTransfer)==null?void 0:h.files)==null?void 0:c[0];u&&a(u).catch(d=>{const m=d instanceof Error?d.message:String(d);n.showLoadError(m),_({scope:"panel",kind:"error",message:`Input load failed: ${m}`}),Z({scope:"panel",kind:"error",message:"Input load failed",meta:{error:m}})})}),e.fileInputEl.addEventListener("change",()=>{var u;const g=(u=e.fileInputEl.files)==null?void 0:u[0];g&&(a(g).catch(h=>{const c=h instanceof Error?h.message:String(h);n.showLoadError(c),_({scope:"panel",kind:"error",message:`Input load failed: ${c}`}),Z({scope:"panel",kind:"error",message:"Input load failed",meta:{error:c}})}),e.fileInputEl.value="")})}function l(){s()}function p(){}function r(){}return{id:"image",bind:l,mount:p,unmount:r}}function Ye(e,t,i){return Number.isFinite(e)?Math.max(t,Math.min(i,Math.trunc(e))):t}function ni(e,t,i){return Math.round(.2126*e+.7152*t+.0722*i)}function tn(e){return{edgesDark:!!(e.edgesDark??!0),edgeThreshold:Ye(e.edgeThreshold??80,0,255),edgeDilate:Ye(e.edgeDilate??2,0,6),maxRegionPx:Ye(e.maxRegionPx??2e5,1e3,1e7)}}function ii(e,t,i){const{data:n,width:o,height:a}=e,s=new Uint8Array(o*a);for(let l=0,p=0;l<s.length;l++,p+=4){const r=n[p+0],g=n[p+1],u=n[p+2];if(n[p+3]===0){s[l]=0;continue}const c=ni(r,g,u),d=t?c<=i:c>=255-i;s[l]=d?1:0}return s}function oi(e,t,i,n){if(n<=0)return e;let o=e;for(let a=0;a<n;a++){const s=new Uint8Array(t*i);for(let l=0;l<i;l++)for(let p=0;p<t;p++){const r=l*t+p;if(o[r]){s[r]=1;continue}let g=0;for(let u=-1;u<=1&&!g;u++){const h=l+u;if(!(h<0||h>=i))for(let c=-1;c<=1;c++){const d=p+c;if(!(d<0||d>=t)&&o[h*t+d]){g=1;break}}}s[r]=g}o=s}return o}function ai(e,t,i,n,o,a){const s=t*n+e;if(i[s])return{ok:!1,message:"Click is on an edge; pick inside a region."};const l=new Uint8Array(n*o),p=new Int32Array(n*o),r=new Int32Array(n*o);let g=0,u=0;p[u]=e,r[u]=t,u++,l[s]=1;let h=1;for(;g<u;){const c=p[g],d=r[g];g++;const m=[[c-1,d],[c+1,d],[c,d-1],[c,d+1]];for(const[v,y]of m){if(v<0||v>=n||y<0||y>=o)continue;const b=y*n+v;if(!l[b]&&!i[b]&&(l[b]=1,p[u]=v,r[u]=y,u++,h++,h>a))return{ok:!1,message:`Region too large (>${a}px). Increase Max region or fix gaps.`}}}return{ok:!0,mask:l}}function si(e,t,i,n){const o=new Uint8Array(i*n);for(let a=1;a<n-1;a++)for(let s=1;s<i-1;s++){const l=a*i+s;if(!e[l])continue;const p=(a-1)*i+s,r=(a+1)*i+s,g=a*i+(s-1),u=a*i+(s+1);(!e[p]||!e[r]||!e[g]||!e[u]||t[p]||t[r]||t[g]||t[u])&&(o[l]=1)}return o}function ri(e,t,i,n){const o=tn(n),a=e.width,s=e.height;let l=ii(e,o.edgesDark,o.edgeThreshold);l=oi(l,a,s,o.edgeDilate);const p=ai(t,i,l,a,s,o.maxRegionPx);if(!p.ok)return{ok:!1,message:p.message};const r=si(p.mask,l,a,s);return{ok:!0,preview:{mask:p.mask,outline:r,w:a,h:s}}}function li(e,t,i){const n=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),o=i.replace("#",""),a=parseInt(o.slice(0,2),16),s=parseInt(o.slice(2,4),16),l=parseInt(o.slice(4,6),16),p=n.data;for(let r=0,g=0;r<t.mask.length;r++,g+=4)t.mask[r]&&(p[g+0]=a,p[g+1]=s,p[g+2]=l);return n}function Xe(e,t,i){return Number.isFinite(e)?Math.max(t,Math.min(i,Math.trunc(e))):t}function Et(e){const t=(e||"").trim();if(!t)return null;const i=t.startsWith("#")?t:`#${t}`;return/^#[0-9a-fA-F]{6}$/.test(i)?i.toLowerCase():null}function ci(e){let t="#ff3b30",i=[],n=null;function o(m){e.colorsStatusEl.textContent=m||""}function a(){const m=!!e.edgesDarkEl.checked,v=Xe(parseInt(e.edgeMaskThresholdEl.value,10),0,255),y=Xe(parseInt(e.edgeDilateEl.value,10),0,6),b=Xe(parseInt(e.maxRegionPxEl.value,10),1e3,1e7);return e.edgeMaskThresholdEl.value=String(v),e.edgeDilateEl.value=String(y),e.maxRegionPxEl.value=String(b),tn({edgesDark:m,edgeThreshold:v,edgeDilate:y,maxRegionPx:b})}function s(m){const v=Et(m);if(v){t=v;for(const y of Array.from(e.paletteEl.querySelectorAll(".paletteItem"))){const b=y.dataset.hex||"";y.classList.toggle("is-selected",b===t)}}}function l(){return t}function p(m){i=m.slice(),e.paletteEl.innerHTML="";for(const v of i){const y=Et(v);if(!y)continue;const b=document.createElement("button");b.type="button",b.className="paletteItem",b.style.background=y,b.dataset.hex=y,b.setAttribute("role","listitem"),b.setAttribute("aria-label",`Select ${y}`),b.addEventListener("click",()=>{s(y)}),e.paletteEl.appendChild(b)}s(t)}function r(m){const v=e.colorsCanvasEl;v.width=m.width,v.height=m.height,v.getContext("2d").putImageData(m,0,0)}function g(m,v){r(m);const y=e.colorsCanvasEl.getContext("2d"),{outline:b,w:x,h:w}=v,C=y.getImageData(0,0,x,w),E=C.data;for(let L=0,T=0;L<b.length;L++,T+=4)b[L]&&(E[T+0]=255,E[T+1]=60,E[T+2]=60,E[T+3]=220);y.putImageData(C,0,0)}function u(m){e.btnColorsApplyEl.disabled=!m}function h(m){e.btnColorsCancelEl.disabled=!m}function c(m){n=m}function d(){o("Idle"),u(!1),h(!1),e.colorsCanvasEl.addEventListener("click",m=>{if(!n)return;const v=e.colorsCanvasEl.getBoundingClientRect(),y=Math.floor((m.clientX-v.left)/v.width*e.colorsCanvasEl.width),b=Math.floor((m.clientY-v.top)/v.height*e.colorsCanvasEl.height);n(y,b)})}return{bind:d,setStatus:o,getSettings:a,setSelectedColor:s,getSelectedColor:l,renderPalette:p,drawBase:r,drawPreview:g,setApplyEnabled:u,setCancelEnabled:h,onCanvasClick:c}}let nn={type:"none"};function ke(e){nn=e}function kt(){return nn}function Ie(e){var s,l,p,r,g;if(!e){ke({type:"none"});return}const t=(s=e.outputSvg)==null?void 0:s.svg;if(typeof t=="string"&&t.length>0){ke({type:"svg",svg:t});return}const i=(l=e.outputImage)==null?void 0:l.data;if(i){ke({type:"image",image:i});return}const n=(p=e.outputMask)==null?void 0:p.data,o=(r=e.outputMask)==null?void 0:r.width,a=(g=e.outputMask)==null?void 0:g.height;if(n&&typeof o=="number"&&typeof a=="number"){ke({type:"mask",mask:n,width:o,height:a});return}ke({type:"none"})}const di=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#a2845e","#8e8e93","#1c1c1e","#ffffff","#000000","#4cd964","#5ac8fa","#ff6b6b","#7aa2ff","#f5a623","#50e3c2"];function pi(e,t){const i=ci(e);let n=null,o=null;function a(c){i.setStatus(c)}function s(c,d,m){const v=new ImageData(d,m),y=v.data;for(let b=0,x=0;b<c.length;b++,x+=4){const C=(c[b]??0)>0?0:255;y[x+0]=C,y[x+1]=C,y[x+2]=C,y[x+3]=255}return v}function l(){const c=kt();return c.type==="image"?c.image:c.type==="mask"?s(c.mask,c.width,c.height):null}function p(){return kt().type==="svg"?"Pipeline output is SVG. Colors needs an image or mask output.":"No pipeline output available. Run the Pipeline first."}function r(){const c=l();if(!c){n=null,o=null,i.setApplyEnabled(!1),i.setCancelEnabled(!1),a(p());return}n=c,o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Ready. Pick a color, click inside a region.")}function g(){if(n){i.drawBase(n);return}const c=l();if(!c){a(p());return}n=c,o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Loaded pipeline output. Pick a color, click inside a region.")}function u(){if(!n||!o)return;const c=i.getSelectedColor();n=li(n,o,c),o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Fill applied. Click another region.")}function h(){n&&(o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Preview canceled."))}return{bind(){i.bind(),i.renderPalette(di),i.onCanvasClick((c,d)=>{if(!n){a(p());return}const m=i.getSettings(),v=ri(n,c,d,m);if(!v.ok){o=null,i.setApplyEnabled(!1),i.setCancelEnabled(!1),a(v.message);return}o=v.preview,i.drawPreview(n,o),i.setApplyEnabled(!0),i.setCancelEnabled(!0),a("Preview shown. Apply fill or cancel.")}),e.btnColorsApplyEl.addEventListener("click",()=>u()),e.btnColorsCancelEl.addEventListener("click",()=>h()),e.btnColorsResetEl.addEventListener("click",()=>r()),e.tabColors.addEventListener("click",()=>{queueMicrotask(()=>g())}),a("Idle"),i.setApplyEnabled(!1),i.setCancelEnabled(!1)}}}const It="0.2.6";function Qe(e){return`[BCT][${e}]`}function ui(e){function t(...a){e.traceOn()&&console.log(Qe("trace"),...a)}function i(...a){console.warn(Qe("warn"),...a)}function n(...a){console.error(Qe("error"),...a)}function o(a,s){t(a,s),Z({scope:e.scope,kind:"debug",message:a,meta:s})}return{logTrace:t,logWarn:i,logError:n,traceScope:o}}const{logTrace:F,logWarn:Be,logError:me,traceScope:on}=ui({scope:"panel",traceOn:()=>!!ze().traceConsole});let Q=0;function ee(){return Q>0}function re(e,t){if(t){an(e);return}Q=0,Fe(e,!1)}async function gi(e,t){const i=`${Date.now()}-${Math.random().toString(16).slice(2)}`;F("[state] withBusy: enter",{id:i,busyCount:Q}),an(e,i);try{F("[state] withBusy: before await fn",{id:i,busyCount:Q});const n=await t();return F("[state] withBusy: after await fn (resolved)",{id:i,busyCount:Q}),n}catch(n){throw me("[state] withBusy: fn threw",{id:i,busyCount:Q,msg:String((n==null?void 0:n.message)??n),stack:String((n==null?void 0:n.stack)??"")}),n}finally{F("[state] withBusy: finally before endBusy",{id:i,busyCount:Q}),fi(e,i),F("[state] withBusy: finally after endBusy",{id:i,busyCount:Q})}}function an(e,t){Q++,F("[state] beginBusy",{id:t,busyCount:Q}),Q===1&&Fe(e,!0)}function fi(e,t){if(Q--,F("[state] endBusy: dec",{id:t,busyCount:Q}),Q<=0){Q=0,F("[state] endBusy: applying busy=false",{id:t,busyCount:Q}),Fe(e,!1);return}Q===0&&(F("[state] endBusy: applying busy=false (redundant branch)",{id:t,busyCount:Q}),Fe(e,!1))}function Fe(e,t){e.rootEl.classList.toggle("is-busy",t),e.cfgShowDevToolsEl.disabled=!1,e.fileInputEl.disabled=t,e.cfgTraceConsoleEl.disabled=t,e.cfgActionLogMaxEl.disabled=t,e.cfgDebugTraceMaxEl.disabled=t,e.cfgFailureLogsPerRunEl.disabled=t,e.btnCfgResetDefaults.disabled=t,e.logsCbDebugEl.disabled=t,e.cfgUseOpenCvEl.disabled=t,e.logsLimitEl.disabled=t,e.btnLogsRefresh.disabled=t,e.logsTrimKeepEl.disabled=t,e.btnLogsTrim.disabled=t,e.btnLogsExport.disabled=t,e.btnLogsClear.disabled=t,e.debugLimitEl.disabled=t,e.btnDebugRefresh.disabled=t,e.btnDebugExport.disabled=t,e.btnDebugClear.disabled=t,e.btnColorsApplyEl.disabled=t,e.btnColorsCancelEl.disabled=t,e.btnColorsResetEl.disabled=t,e.edgesDarkEl.disabled=t,e.edgeMaskThresholdEl.disabled=t,e.edgeDilateEl.disabled=t,e.maxRegionPxEl.disabled=t;for(const i of Array.from(e.paletteEl.querySelectorAll("button")))i.disabled=t;e.colorsCanvasEl.style.pointerEvents=t?"none":"auto"}const bt={native:{available:!0},opencv:{available:!1,reason:"OpenCV not loaded"}};function hi(e){bt[e]={available:!0}}function mi(e,t){bt[e]={available:!1,reason:t}}function ye(){return bt.opencv.available===!0}async function yi(e){const t=new URL(e.opencvJsRel,document.baseURI).toString(),i=new URL(e.opencvWasmRel,document.baseURI).toString(),n=globalThis;n.Module=n.Module||{},n.Module.locateFile=o=>o.endsWith(".wasm")?i:o,n.Module.print=()=>{},n.Module.printErr=()=>{},n.cv||await bi(t),await vi(e.timeoutMs)}function bi(e){return new Promise((t,i)=>{const n=document.createElement("script");n.src=e,n.async=!0;const o=15e3,a=window.setTimeout(()=>{s(),i(new Error(`OpenCV script load timeout after ${o}ms: ${e}`))},o);function s(){window.clearTimeout(a),n.onload=null,n.onerror=null}n.onload=()=>{s(),t()},n.onerror=()=>{s(),i(new Error(`Failed to load OpenCV script: ${e}`))},document.head.appendChild(n)})}async function vi(e){var n;const t=Date.now(),i=globalThis;for(;Date.now()-t<e;){try{if(i.cv&&typeof i.cv.Mat=="function"){const o=new i.cv.Mat;(n=o.delete)==null||n.call(o);return}}catch{}await new Promise(o=>setTimeout(o,75))}throw new Error(`OpenCV initialization timeout after ${e}ms`)}async function wi(){try{await yi({opencvJsRel:"../assets/opencv/opencv.js",opencvWasmRel:"../assets/opencv/opencv.wasm",timeoutMs:2e4}),hi("opencv")}catch(e){throw mi("opencv",e!=null&&e.message?String(e.message):String(e)),e}}function q(e,t,i,n,o,a,s){return{id:e,title:t,implementedEngines:i,defaultEnginePolicy:n,params:o,children:a,description:s}}function Ci(e){const t=new Map,i=new Map;function n(o,a){if(t.has(o.id))throw new Error(`[tuning] Duplicate component id: ${o.id}`);t.set(o.id,o),i.set(o.id,a);for(const s of o.children??[])n(s,o.id)}return n(e,null),{root:e,byId:t,parentById:i}}function sn(){const e=q("app","BeeMage",["native","opencv"],"native",{},[q("edge","Edge",["native","opencv"],"auto",{},[q("edge.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),q("edge.threshold","Threshold",["native","opencv"],"auto",{manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128}},void 0,"Convert image into a binary mask before edge extraction."),q("edge.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:3},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Clean the mask before extracting edges."),q("edge.extract","Edge extract",["native","opencv"],"auto",{},void 0,"Extract a 1px outline from the cleaned mask.")],"Fixed-order edge pipeline (image -> mask -> edges). Presets configure each step."),q("svg","SVG",["native","opencv"],"auto",{},[q("svg.create","Create SVG",["native","opencv"],"auto",{scale:{kind:"number",label:"Scale",min:1,max:10,step:1,default:1},transparentBg:{kind:"number",label:"Transparent bg (0/1)",min:0,max:1,step:1,default:1},color:{kind:"text",label:"Color",default:"#3bca1e"}},void 0,"Convert the edge mask into an SVG.")],"SVG generation parameters."),q("segmentation","Segmentation",["native","opencv"],"auto",{},[q("segmentation.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),q("segmentation.denoise","Denoise",["native","opencv"],"auto",{denoiseAlgo:{kind:"number",label:"Denoise algo",min:0,max:2,step:1,default:1},blurK:{kind:"number",label:"Blur kernel",min:1,max:21,step:2,default:3},bilateralSigma:{kind:"number",label:"Bilateral sigma",min:1,max:150,step:1,default:35}},void 0,"Reduce noise before thresholding."),q("segmentation.color","Color / Gray",["native","opencv"],"auto",{colorMode:{kind:"number",label:"Color mode",min:0,max:3,step:1,default:1},hsvChannel:{kind:"number",label:"HSV channel",min:0,max:2,step:1,default:2}},void 0,"Select color space / channel features for thresholding."),q("segmentation.threshold","Threshold",["native","opencv"],"auto",{thresholdAlgo:{kind:"number",label:"Threshold algo",min:0,max:3,step:1,default:1},manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128},adaptBlock:{kind:"number",label:"Adaptive block",min:3,max:101,step:2,default:31},adaptC:{kind:"number",label:"Adaptive C",min:-50,max:50,step:1,default:3}},void 0,"Convert features into a binary mask."),q("segmentation.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:5},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Remove specks, fill holes, and stabilize regions.")],"Fixed-order segmentation pipeline. Presets configure each step."),q("image","iMage",["native","opencv"],"auto",{},[q("mage.process","Process",["native"],"auto",{imageScale:{kind:"number",label:"Processing scale",min:25,max:100,step:5,default:100},edgeThreshold:{kind:"number",label:"Edge threshold",min:1,max:255,step:1,default:70},invertOutput:{kind:"boolean",label:"White background",default:!0}}),q("mage.clean","Clean & Smooth",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:500,step:1,default:12},cleanRadius:{kind:"number",label:"Repair strength",min:1,max:3,step:1,default:1},cleanBinaryThreshold:{kind:"number",label:"Binary threshold",min:1,max:254,step:1,default:128}},[q("mage.clean.threshold","Threshold",["native"],"auto",{}),q("mage.clean.removeSmallComponents","Remove small components",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:5e3,step:1,default:12}},void 0,"Remove connected components smaller than the minimum area."),q("mage.clean.repair","Repair gaps",["native"],"auto",{}),q("mage.clean.smooth","Smooth mask",["native"],"auto",{}),q("mage.clean.quality","Quality metrics",["native"],"auto",{})]),q("mage.vectorize","Vectorize (SVG)",["native"],"native",{pathSmoothIters:{kind:"number",label:"Path smoothing",min:0,max:4,step:1,default:2}})]),q("colors","Colors",["native"],"auto",{},[q("colors.fill","Region fill",["native"],"auto",{edgesDark:{kind:"boolean",label:"Edges are dark",default:!0},edgeMaskThreshold:{kind:"number",label:"Edge threshold",min:0,max:255,step:1,default:80},edgeDilate:{kind:"number",label:"Gap close (px)",min:0,max:6,step:1,default:2},maxRegionPx:{kind:"number",label:"Max region (px)",min:1e3,step:1e3,default:2e5}})]),q("pipeline","Pipeline (UI)",["native","opencv"],"auto",{mode:{kind:"text",label:"Pipeline",default:"segmentation"},recipe:{kind:"text",label:"Recipe",default:"default"}},void 0,"UI state for the Pipeline tab (selected pipeline + recipe).")]);return Ci(e)}function Ei(e){return e.default}function ki(e,t){const i={};for(const[n,o]of Object.entries(e))i[n]=Ei(o);for(const[n,o]of Object.entries(t??{}))i[n]=o;return i}function Ii(e,t,i){var o;let n=e;for(;n;){const a=t.byId.get(n);if(!a)throw new Error(`[tuning] Unknown component: ${n}`);const l=((o=i[n])==null?void 0:o.enginePolicy)??a.defaultEnginePolicy;if(l!=="inherit")return l;n=t.parentById.get(n)??null}return"native"}function xi(e,t,i){const n=i.opencvReady&&e.includes("opencv");return e.includes("native")||e.length,t==="native"?{engine:"native"}:t==="opencv"?n?{engine:"opencv"}:{engine:"native",fallbackReason:i.opencvReady?"Policy=opencv, but component has no OpenCV implementation.":"Policy=opencv, but OpenCV is not available at runtime."}:t==="auto"?n?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}function rn(e,t,i,n){var r;const o=t.byId.get(e);if(!o)throw new Error(`[tuning] Unknown component: ${e}`);const a=Ii(e,t,i),{engine:s,fallbackReason:l}=xi(o.implementedEngines,a,n),p=ki(o.params,(r=i[e])==null?void 0:r.params);return{id:e,policy:a,engine:s,fallbackReason:l,params:p}}const ct="beemage.tuning.components.v1";async function $e(){const e=await pe([ct]).catch(()=>({})),t=e==null?void 0:e[ct];return!t||typeof t!="object"?{}:t}async function ln(e){await ue({[ct]:e}).catch(()=>null)}async function et(e,t){const i=await $e(),n=i[e]??{};i[e]={enginePolicy:t.enginePolicy??n.enginePolicy,params:{...n.params??{},...t.params??{}}},await ln(i)}async function xt(e){const t=await $e();delete t[e],await ln(t)}function Si(){return{opencvReady:ye()}}function Pi(e){return Array.isArray(e.children)&&e.children.length>0}function cn(e){const{id:t,registry:i,stored:n,runtime:o}=e,a=i.byId.get(t);if(!a)throw new Error(`[tuning] Unknown component: ${t}`);const s=rn(t,i,n,o),l=n[t],p=l==null?void 0:l.enginePolicy,r=l==null?void 0:l.params,g=a.implementedEngines.includes("opencv"),u=!!o.opencvReady,h=[];for(const c of a.children??[])h.push(cn({id:c.id,registry:i,stored:n,runtime:o}));return{id:a.id,title:a.title,description:a.description,isGroup:Pi(a),implementedEngines:a.implementedEngines,storedPolicy:p,storedParams:r,effectivePolicy:s.policy,effectiveEngine:s.engine,fallbackReason:s.fallbackReason,paramsSchema:a.params,effectiveParams:s.params,canImplementOpenCv:g,runtimeOpenCvReady:u,children:h}}function dn(e={}){const t=e.registry??sn(),i=e.getRuntimeAvailability??Si;async function n(p="app"){const r=await $e(),g=i();if(!t.byId.get(p))throw new Error(`[tuning] Unknown scope: ${p}`);const h=cn({id:p,registry:t,stored:r,runtime:g});return{scopeId:p,runtime:g,stored:r,root:h}}async function o(p,r){await et(p,{enginePolicy:r})}async function a(p,r,g){await et(p,{params:{[r]:g}})}async function s(p){await xt(p)}async function l(p,r){const u=(await $e())[p];if(!(u!=null&&u.params))return;const h={...u.params??{}};delete h[r];const c=typeof u.enginePolicy=="string",d=Object.keys(h).length>0;if(!c&&!d){await xt(p);return}await et(p,{enginePolicy:u.enginePolicy,params:h})}return{getRegistry:()=>t,loadTree:n,setEnginePolicy:o,setParam:a,resetNode:s,resetParam:l}}function K(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function St(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function $i(e){return e.fallbackReason?`${e.effectiveEngine} (fallback)`:e.effectiveEngine}function Ai(e){const t=[{value:"native",label:"Native"},{value:"auto",label:"Auto"},...e.canImplementOpenCv?[{value:"opencv",label:"OpenCV"}]:[]];return e.isRoot?t:[{value:"inherit",label:"Inherit"},...t]}function Ri(e){return!1}function Ti(e,t,i){var o;const n=(o=e.storedParams)==null?void 0:o[t];return typeof n<"u"&&n!==i}function Li(e){var u;const{node:t,compId:i,key:n,schema:o,value:a,handlers:s}=e,l=K("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),p=K("label",{class:"fieldInline"}),r=K("span",void 0,o.label);p.appendChild(r);let g;if(o.kind==="number"?(g=K("input"),g.type="number",typeof o.min=="number"&&(g.min=String(o.min)),typeof o.max=="number"&&(g.max=String(o.max)),typeof o.step=="number"&&(g.step=String(o.step)),g.value=String(a??o.default),g.addEventListener("change",()=>{const h=Number(g.value);s.onSetParam(i,n,Number.isFinite(h)?h:o.default)})):o.kind==="boolean"?(g=K("input"),g.type="checkbox",g.checked=!!a,g.addEventListener("change",()=>{s.onSetParam(i,n,!!g.checked)})):(g=K("input"),g.type="text",g.value=String(a??o.default),g.addEventListener("change",()=>{s.onSetParam(i,n,String(g.value??o.default))})),p.appendChild(g),l.appendChild(p),s.onResetParam&&typeof((u=t.storedParams)==null?void 0:u[n])<"u"){const h=K("button",{type:"button"},"Reset");h.addEventListener("click",c=>{var d;c.preventDefault(),(d=s.onResetParam)==null||d.call(s,i,n)}),l.appendChild(h)}return Ti(t,n,a)&&l.appendChild(K("span",{class:"muted",style:"font-size:12px;"},"override")),l}function pn(e){const{node:t,depth:i,isRoot:n,handlers:o,treeScopeId:a}=e,s=K("div",{style:`margin-left:${Math.min(i*14,56)}px; margin-top:10px;`}),l=K("div",{style:"border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:10px; background:rgba(0,0,0,0.12);"}),p=K("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),r=K("div");r.appendChild(K("div",{style:"font-weight:700;"},t.title)),t.description&&r.appendChild(K("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},t.description)),t.isGroup&&r.appendChild(K("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},"Group (policy affects children)")),p.appendChild(r);const g=K("div",{class:"row",style:"align-items:center; gap:10px;"});g.appendChild(K("span",{class:"qBadge"},$i(t)));const u=K("select");u.style.background="rgba(255,255,255,0.05)",u.style.border="1px solid rgba(255,255,255,0.08)",u.style.color="rgba(255,255,255,0.92)",u.style.borderRadius="10px",u.style.padding="6px 8px";const h=Ai({isRoot:n,canImplementOpenCv:t.canImplementOpenCv});for(const x of h){const w=K("option");w.value=x.value,w.textContent=x.label,u.appendChild(w)}const c=new Set(h.map(x=>x.value)),d=t.effectivePolicy;c.has(d)?u.value=d:u.value=n?"native":"inherit",u.addEventListener("change",()=>{o.onSetPolicy(t.id,u.value)}),g.appendChild(u);const m=typeof t.storedPolicy<"u"||t.storedParams&&Object.keys(t.storedParams).length>0;if(o.onResetNode&&m){const x=K("button",{type:"button"},"Reset node");x.addEventListener("click",w=>{var C;w.preventDefault(),(C=o.onResetNode)==null||C.call(o,t.id)}),g.appendChild(x)}p.appendChild(g),l.appendChild(p),t.fallbackReason?l.appendChild(K("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},t.fallbackReason)):t.effectivePolicy==="opencv"&&!t.runtimeOpenCvReady&&l.appendChild(K("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},"OpenCV policy selected, but OpenCV is not available at runtime. It will fall back to native."));const v=Object.keys(t.paramsSchema??{}),y=v.length>0,b=t.children.length>0;if(y||b){const x=K("details",{style:"margin-top:10px;"});x.open=Ri();const w=K("summary",{style:"cursor:pointer; user-select:none;"},"Details");if(x.appendChild(w),y){const C=K("div",{style:"margin-top:10px;"});C.appendChild(K("div",{class:"muted",style:"font-weight:600; margin-bottom:6px;"},"Parameters"));for(const E of v){const L=t.paramsSchema[E],T=t.effectiveParams[E];C.appendChild(Li({node:t,compId:t.id,key:E,schema:L,value:T,handlers:o}))}x.appendChild(C)}if(b){const C=K("div",{style:"margin-top:10px;"});for(const E of t.children)C.appendChild(pn({node:E,depth:i+1,isRoot:!1,handlers:o,treeScopeId:a}));x.appendChild(C)}l.appendChild(x)}return s.appendChild(l),s}function un(e,t){let i=!1;function n(a){if(i)return;St(e);const s=a.scopeId==="app",l=K("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"});l.appendChild(K("div",{style:"font-weight:700;"},"Tuning")),l.appendChild(K("div",{class:"muted",style:"font-size:12px;"},`OpenCV runtime: ${a.runtime.opencvReady?"ready":"not available"}`)),e.appendChild(l),e.appendChild(pn({node:a.root,depth:0,isRoot:s,handlers:t,treeScopeId:a.scopeId}))}function o(){i=!0,St(e)}return{render:n,dispose:o}}function Mi(){let e=!1,t={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},i=!1,n="",o="";function a(r){e=r}function s(r){t={...t,...r}}function l(r){i=r}function p(r){typeof r.general=="string"&&(n=r.general),typeof r.dev=="string"&&(o=r.dev)}return{get showDevTools(){return e},get dev(){return t},get debugEnabled(){return i},get generalStatus(){return n},get devStatus(){return o},setShowDevTools:a,setDev:s,setDebugEnabled:l,setStatus:p}}function Di(e){function t(r){e.settingsGeneralStatusEl.textContent=r||""}function i(r){e.cfgStatusEl.textContent=r||""}function n(r){e.cfgShowDevToolsEl.checked=r}function o(r){e.tabLogs.hidden=!r,e.devConfigDetailsEl.classList.toggle("is-hidden",!r),r||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function a(r){e.cfgTraceConsoleEl.checked=!!r.traceConsole,e.cfgActionLogMaxEl.value=String(r.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(r.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(r.failureLogsPerRun??50)}function s(r){e.logsCbDebugEl.checked=r}function l(r,g){e.settingsVersionEl.textContent=r||"—",e.settingsGitHubLinkEl.href=g||"#",e.settingsGitHubLinkEl.hidden=!g}function p(r){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=r,e.cfgActionLogMaxEl.disabled=r,e.cfgDebugTraceMaxEl.disabled=r,e.cfgFailureLogsPerRunEl.disabled=r,e.btnCfgResetDefaults.disabled=r,e.logsCbDebugEl.disabled=r,e.cfgUseOpenCvEl.disabled=r}return{setGeneralStatus:t,setDevStatus:i,setShowDevToolsChecked:n,setDevToolsVisible:o,setDevConfig:a,setDebugEnabledChecked:s,setAbout:l,setBusy:p}}const tt="template.settings.showDevTools",nt="beemage.settings.engine.useOpenCv";function Oi(){var e,t;try{const i=(e=globalThis==null?void 0:globalThis.chrome)==null?void 0:e.runtime,n=(t=i==null?void 0:i.getManifest)==null?void 0:t.call(i),o=typeof(n==null?void 0:n.version)=="string"?n.version:"";if(F("Settings: getManifestVersion manifest found version is ",{v:o}),o)return o}catch{}return F("Settings: getManifestVersion fallback",{APP_VERSION:It}),It}function it(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??te.actionLogMax),debugTraceMax:Number(e.debugTraceMax??te.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??te.failureLogsPerRun)}}function Bi(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:de(e.cfgActionLogMaxEl.value,100,5e4,te.actionLogMax),debugTraceMax:de(e.cfgDebugTraceMaxEl.value,100,5e4,te.debugTraceMax),failureLogsPerRun:de(e.cfgFailureLogsPerRunEl.value,0,5e4,te.failureLogsPerRun)}}async function Pt(e){const t=en;return typeof t.setEnabled=="function"?(await t.setEnabled(e),{ok:!0}):typeof t.enable=="function"&&typeof t.disable=="function"?(await(e?t.enable():t.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function Ui(e,t){const i=Mi(),n=Di(e),o=dn({getRuntimeAvailability:()=>({opencvReady:e.cfgUseOpenCvEl.checked&&ye()})}),a=un(e.tuningMountEl,{onSetPolicy:async(f,$)=>{await o.setEnginePolicy(f,$),await b("policy change")},onSetParam:async(f,$,U)=>{await o.setParam(f,$,U),await b("param change")},onResetNode:async f=>{await o.resetNode(f),await b("reset node")},onResetParam:async(f,$)=>{await o.resetParam(f,$),await b("reset param")}});function s(f){e.settingsEngineBoxEl.classList.toggle("is-hidden",!1)}async function l(){const f=await pe([nt]).catch(()=>({}));return(f==null?void 0:f[nt])===!0}async function p(f){await ue({[nt]:!!f}).catch(()=>null)}function r(f){var $;e.cfgUseOpenCvEl.checked=f,($=e.cfgUseOpenCvEl.closest(".switch"))==null||$.classList.toggle("is-disabled",e.cfgUseOpenCvEl.disabled)}function g(f){e.cfgOpenCvSpinner.classList.toggle("is-hidden",!f),e.cfgOpenCvSpinner.setAttribute("aria-hidden",f?"false":"true")}function u(f){e.cfgOpenCvStatus.textContent=f||""}function h(f){e.cfgOpenCvReport.textContent=f||""}async function c(){if(ee())return;if(!!!e.cfgUseOpenCvEl.checked){await p(!1),g(!1),u(ye()?"OpenCV loaded (native mode)":"Native mode"),h("Native mode. OpenCV is optional and demo-only."),await b("opencv mode disabled");return}g(!0),u("Loading OpenCV…"),h("Loading OpenCV…");try{if(await gi(e,async()=>{await wi()}),!ye())throw new Error("OpenCV load returned but runtime is not injected.");await p(!0),u("OpenCV mode enabled"),h("OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV."),await b("opencv mode enabled")}catch($){const U=String(($==null?void 0:$.message)??$);await p(!1),r(!1),u("OpenCV load failed"),h(`ERROR

${U}`),me("[settings] OpenCV toggle failed",{msg:U})}finally{g(!1)}}async function d(){const f=await pe([tt]).catch(()=>({}));return(f==null?void 0:f[tt])===!0}async function m(f){await ue({[tt]:!!f}).catch(()=>null)}function v(f){i.setShowDevTools(f),n.setShowDevToolsChecked(f),n.setDevToolsVisible(f)}async function y(){const f=await d();v(f),F("Settings: boot applyDevToolsVisibility",{showDevTools:f})}async function b(f){try{const $=await o.loadTree("app");a.render($),F("[settings] tuning rendered",{reason:f,opencvInjected:ye(),opencvMode:!!e.cfgUseOpenCvEl.checked})}catch($){me("[settings] tuning render failed",{reason:f,msg:String(($==null?void 0:$.message)??$)}),e.tuningMountEl.textContent="Tuning UI failed to load (see console)."}}async function x(){var M;n.setBusy(ee());const f=await d();v(f),await st().catch(()=>null);const $=ze();i.setDev(it($)),n.setDevConfig(i.dev);const U=en;let z=!1;try{typeof U.isEnabled=="function"?z=!!await U.isEnabled():z=!!U.enabled}catch(I){Be("Settings: failed to read debug enabled state",{error:I instanceof Error?I.message:String(I)})}i.setDebugEnabled(z),n.setDebugEnabledChecked(z),n.setAbout(Oi()||"—",((M=e.settingsGitHubLinkEl)==null?void 0:M.href)||"#"),s();{const I=await l();r(I),g(!1);const S=ye();I?(u(S?"OpenCV mode enabled":"OpenCV mode (not loaded)"),h(S?"OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV.":"OpenCV mode is enabled, but OpenCV is not loaded yet. Toggle OFF then ON to load OpenCV.")):(u(S?"OpenCV loaded (native mode)":"Native mode"),h("Native mode. OpenCV is optional and demo-only."))}n.setGeneralStatus(""),n.setDevStatus(""),await b("loadAll"),F("Settings: loaded",{showDevTools:f,debugTraceEnabled:z,dev:i.dev,opencvInjected:ye()})}async function w(){const f=!!e.cfgShowDevToolsEl.checked;v(f),await m(f),_({kind:"run",scope:"settings",message:f?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:f}}),F("Settings: ui toggle showDevTools",{showDevTools:f}),n.setGeneralStatus(f?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>n.setGeneralStatus(""),1200)}async function C(){const f=Bi(e);n.setDevStatus("Saving…");try{await Jt(f)}catch($){me("Settings: failed to save dev config",{error:$ instanceof Error?$.message:String($),next:f}),n.setDevStatus("Save failed."),setTimeout(()=>n.setDevStatus(""),1200);return}i.setDev(it(f)),n.setDevConfig(i.dev),_({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:f}),F("Settings: devConfig updated",f),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}async function E(){n.setDevStatus("Resetting…");try{await Nn(),await st().catch(()=>null);const $=ze();i.setDev(it($)),n.setDevConfig(i.dev)}catch($){me("Settings: failed to reset dev config defaults",{error:$ instanceof Error?$.message:String($)}),n.setDevStatus("Reset failed."),setTimeout(()=>n.setDevStatus(""),1200);return}const f=await Pt(!1);f.ok?(i.setDebugEnabled(!1),n.setDebugEnabledChecked(!1)):(Be("Settings: failed to reset debug enabled state",{error:f.error||"unknown error"}),_({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:f.error||"unknown error"})),_({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...te,debugEnabled:!1}}),F("Settings: reset defaults",{...te,debugEnabled:!1}),n.setDevStatus("Reset."),setTimeout(()=>n.setDevStatus(""),1200)}async function L(){const f=!!e.logsCbDebugEl.checked;n.setDevStatus("Saving…");const $=await Pt(f);if(!$.ok){e.logsCbDebugEl.checked=!f,n.setDevStatus(`Save failed: ${$.error||"unknown error"}`),me("Settings: failed to change debug enabled state",{error:$.error||"unknown error",enabled:f}),_({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:$.error||"unknown error",meta:{enabled:f}});return}i.setDebugEnabled(f),_({kind:"run",scope:"settings",message:f?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:f}}),F("Settings: debug enabled changed",{enabled:f}),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}const T=t.on(()=>{});function B(){e.cfgShowDevToolsEl.addEventListener("change",()=>{w()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{ee()||C()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{ee()||C()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{ee()||C()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{ee()||C()}),e.btnCfgResetDefaults.addEventListener("click",()=>{ee()||E()}),e.logsCbDebugEl.addEventListener("change",()=>{ee()||L()}),e.cfgUseOpenCvEl.addEventListener("change",()=>{c()}),y().catch(f=>{Be("Settings: initDevToolsVisibility failed",{error:f instanceof Error?f.message:String(f)})})}return{id:"settings",refresh(){x().catch(f=>{me("Settings: refresh failed",{error:f instanceof Error?f.message:String(f)})})},mount(){x().catch(f=>{me("Settings: mount failed",{error:f instanceof Error?f.message:String(f)})})},unmount(){},bind:B,dispose(){T()}}}function Vi(){let e=[],t=0;function i(n){e=n.items,t=n.total}return{get items(){return e},get total(){return t},set:i}}function zi(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function $t(e,t){const i=[];i.push(`Total entries: ${t.total}`),i.push("");for(const n of t.items){const o=typeof n.ok=="boolean"?n.ok?"ok":"fail":"",a=[];typeof n.status=="number"&&a.push(`status=${n.status}`),o&&a.push(o);const s=[n.scope,n.kind].filter(Boolean).join("/");i.push(`[${zi(n.ts)}] ${s}${a.length?` (${a.join(", ")})`:""}`),i.push(`  ${n.message}`),n.error&&i.push(`  error: ${n.error}`),i.push("")}e.textContent=i.join(`
`),e.scrollTop=0}function Ni(e){function t(s){e.logsStatusEl.textContent=s}function i(s){e.debugStatusEl.textContent=s}function n(s){e.logsCbDebugEl.checked=s}function o(s){$t(e.logsOutEl,{total:s.total,items:s.items.map(l=>({ts:l.ts,message:l.message,scope:l.scope,kind:l.kind,ok:l.ok,status:l.status,error:l.error,meta:l.meta}))})}function a(s){$t(e.debugOutEl,{total:s.total,items:s.items.map(l=>({ts:l.ts,message:l.message,scope:l.scope,kind:l.kind,ok:l.ok,status:l.status,error:l.error,meta:l.meta}))})}return{setAuditStatus:t,setDebugStatus:i,setDebugChecked:n,renderAudit:o,renderDebug:a}}const At="beemage";function ji(e,t){const i=Vi(),n=Ni(e);async function o(){n.setAuditStatus("Loading…"),re(e,!0);try{const d=de(e.logsLimitEl.value,10,5e3,200),m=await Jn({limit:d,reverse:!0});i.set(m),n.renderAudit({items:i.items,total:i.total}),n.setAuditStatus(`Showing ${i.items.length} (newest first)`)}catch(d){n.setAuditStatus(`Failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{re(e,!1)}}async function a(){n.setDebugStatus("Loading…"),re(e,!0);try{const d=de(e.debugLimitEl.value,10,5e3,200),m=await Xt({limit:d,reverse:!0});n.renderDebug(m),n.setDebugStatus(`Showing ${m.items.length} (newest first)`)}catch(d){n.setDebugStatus(`Failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{re(e,!1)}}async function s(){const d=await yt();n.setDebugChecked(d)}async function l(d){if(await Zt(d),n.setDebugChecked(d),!d){n.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}n.setDebugStatus("Debug ON."),await a()}async function p(){const d=de(e.logsTrimKeepEl.value,0,5e4,2e3);n.setAuditStatus("Trimming…"),re(e,!0);try{const m=await qn({keepLast:d});await o(),n.setAuditStatus(`Trimmed. Remaining: ${m.total}`)}catch(m){n.setAuditStatus(`Trim failed: ${(m==null?void 0:m.message)||String(m)}`)}finally{re(e,!1)}}async function r(){n.setAuditStatus("Clearing…"),re(e,!0);try{await Zn(),await o(),n.setAuditStatus("Cleared.")}catch(d){n.setAuditStatus(`Clear failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{re(e,!1)}}async function g(){n.setAuditStatus("Exporting…");try{const d=await Yn({pretty:!0}),m=new Blob([d],{type:"application/json"}),v=URL.createObjectURL(m),y=document.createElement("a");y.href=v,y.download=`${At}-audit-${Date.now()}.json`,y.click(),setTimeout(()=>URL.revokeObjectURL(v),1e3),n.setAuditStatus("Exported.")}catch(d){n.setAuditStatus(`Export failed: ${(d==null?void 0:d.message)||String(d)}`)}}async function u(){n.setDebugStatus("Clearing…"),re(e,!0);try{await Yt(),await a(),n.setDebugStatus("Cleared.")}catch(d){n.setDebugStatus(`Clear failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{re(e,!1)}}async function h(){n.setDebugStatus("Exporting…");try{const d=await Qt({pretty:!0}),m=new Blob([d],{type:"application/json"}),v=URL.createObjectURL(m),y=document.createElement("a");y.href=v,y.download=`${At}-debug-${Date.now()}.json`,y.click(),setTimeout(()=>URL.revokeObjectURL(v),1e3),n.setDebugStatus("Exported.")}catch(d){n.setDebugStatus(`Export failed: ${(d==null?void 0:d.message)||String(d)}`)}}function c(){e.btnLogsRefresh.addEventListener("click",()=>{ee()||o()}),e.btnLogsTrim.addEventListener("click",()=>{ee()||p()}),e.btnLogsClear.addEventListener("click",()=>{ee()||r()}),e.btnLogsExport.addEventListener("click",()=>{ee()||g()}),e.logsCbDebugEl.addEventListener("change",()=>{ee()||l(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{ee()||a()}),e.btnDebugClear.addEventListener("click",()=>{ee()||u()}),e.btnDebugExport.addEventListener("click",()=>{ee()||h()})}return{id:"logs",bind:c,mount(){s(),o(),a()},unmount(){},dispose(){}}}function _i(e,t){if(e.id===t)return e;const i=[...e.children??[]];for(;i.length>0;){const n=i.shift();if(n.id===t)return n;for(const o of n.children??[])i.push(o)}throw new Error(`[tuning] scopeRootId not found in VM tree: ${t}`)}function Fi(e,t){if(e.id===t)return e;const i=[...e.children??[]];for(;i.length>0;){const n=i.shift();if(n.id===t)return n;for(const o of n.children??[])i.push(o)}return null}function Gi(e){const t=dn({getRuntimeAvailability:e.getRuntimeAvailability}),i=[];let n=!1;async function o(){return await t.loadTree("app")}async function a(){if(n)return;const y=await o();for(const b of i){if(b.scopeRootId==="app"){b.view.render(y);continue}const x=_i(y.root,b.scopeRootId);b.view.render({...y,scopeId:b.scopeRootId,root:x})}}async function s(y,b){await t.setEnginePolicy(y,b),e.actionLogAppend(`[tuning] policy ${y} = ${b}`),e.debugTraceAppend(`[tuning] setPolicy id=${y} policy=${b}`),await a()}async function l(y,b,x){await t.setParam(y,b,x),e.actionLogAppend(`[tuning] param ${y}.${b} = ${String(x)}`),e.debugTraceAppend(`[tuning] setParam id=${y} key=${b} value=${String(x)}`),await a()}async function p(y){await t.resetNode(y),e.actionLogAppend(`[tuning] reset node ${y}`),e.debugTraceAppend(`[tuning] resetNode id=${y}`),await a()}async function r(y,b){await t.resetParam(y,b),e.actionLogAppend(`[tuning] reset param ${y}.${b}`),e.debugTraceAppend(`[tuning] resetParam id=${y} key=${b}`),await a()}async function g(y){var b,x;if(!n){if(y.policies)for(const w of y.policies)await t.setEnginePolicy(w.id,w.policy);if(y.params)for(const w of y.params)await t.setParam(w.id,w.key,w.value);e.actionLogAppend(`[tuning] preset ${y.id} (${y.title})`),e.debugTraceAppend(`[tuning] applyPreset id=${y.id} title=${y.title} policies=${((b=y.policies)==null?void 0:b.length)??0} params=${((x=y.params)==null?void 0:x.length)??0}`),await a()}}async function u(y){const b=await o(),x=Fi(b.root,y);if(!x)throw new Error(`[tuning] getEffectiveParams: unknown component id ${y}`);return{...x.effectiveParams??{}}}async function h(y,b,x){await t.setParam(y,b,x),e.actionLogAppend(`[tuning] param ${y}.${b} = ${String(x)}`),e.debugTraceAppend(`[tuning] setParamValue id=${y} key=${b} value=${String(x)}`),await a()}function c(y){if(n)return;const{mountEl:b,scopeRootId:x}=y;if(i.some(C=>C.mountEl===b))return;const w=un(b,{onSetPolicy:s,onSetParam:l,onResetNode:p,onResetParam:r});i.push({mountEl:b,scopeRootId:x,view:w}),a()}function d(y){const b=i.findIndex(x=>x.mountEl===y);b<0||(i[b].view.dispose(),i.splice(b,1))}async function m(){await a()}function v(){n=!0;for(const y of i)y.view.dispose();i.length=0}return{mount:c,unmount:d,refresh:m,applyPreset:g,getEffectiveParams:u,setParamValue:h,dispose:v}}function ie(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function Ki(e){const t=[{kind:"input",type:e.io.input}],i=[{kind:"output",type:e.io.output}];return{id:e.id,title:e.title,group:e.group,inputs:t,outputs:i}}function Hi(e){const t=String(e||"").toLowerCase();return t==="image"?"opPort--image":t==="mask"?"opPort--mask":t==="svg"?"opPort--svg":"opPort--unknown"}function Wi(e){const{kind:t,type:i}=e,n="http://www.w3.org/2000/svg",o=document.createElementNS(n,"svg");o.setAttribute("viewBox","0 0 48 20"),o.setAttribute("width","48"),o.setAttribute("height","20"),o.setAttribute("aria-hidden","true"),o.classList.add("opPort__glyph");const a=String(i||"").toLowerCase(),s=t==="output",l=document.createElementNS(n,"rect");l.setAttribute("x","1"),l.setAttribute("y","3"),l.setAttribute("width","46"),l.setAttribute("height","14"),l.setAttribute("rx","7"),l.setAttribute("ry","7"),l.classList.add("opPort__glyphTrack"),o.appendChild(l);const p=document.createElementNS(n,"path");p.classList.add("opPort__glyphShape");const r=(m,v,y)=>Math.max(v,Math.min(y,m)),g=24,u=10,h=7,d=r((a==="mask"?12:a==="svg"||a==="image"?14:12)/2,4,10);if(a==="image")if(s){const m=g-d,v=g+d+h,y=u-6,b=u+6;p.setAttribute("d",`M ${m} ${y} L ${v} ${u} L ${m} ${b} Z`)}else{const m=g+d,v=g-d-h,y=u-6,b=u+6;p.setAttribute("d",`M ${m} ${y} L ${v} ${u} L ${m} ${b} Z`),p.classList.add("opPort__glyphShape--socket")}else if(a==="svg")if(s){const m=g-d,v=d*2+h;p.setAttribute("d",[`M ${m} ${u-6}`,`h ${v}`,"a 6 6 0 0 1 0 12",`h ${-v}`,"a 6 6 0 0 1 0 -12","Z"].join(" "))}else{const m=g+d,v=d*2+h;p.setAttribute("d",[`M ${m} ${u-6}`,`h ${-v}`,"a 6 6 0 0 0 0 12",`h ${v}`,"a 6 6 0 0 0 0 -12","Z"].join(" ")),p.classList.add("opPort__glyphShape--socket")}else if(s){const m=g-d,v=d*2+h;p.setAttribute("d",`M ${m} ${u-6} h ${v} v 12 h ${-v} Z`)}else{const m=g+d,v=d*2+h;p.setAttribute("d",`M ${m} ${u-6} h ${-v} v 12 h ${v} Z`),p.classList.add("opPort__glyphShape--socket")}return o.appendChild(p),o}function Ji(e){const{port:t,getPortClass:i}=e,n=`opPort ${i(t.type)}`,o=t.label?`${t.label}: ${t.type}`:String(t.type);return ie("div",{class:n,"data-port-kind":t.kind,"data-port-type":String(t.type)},o)}function qi(e){const{port:t,getPortClass:i}=e,n=`opPort opPort--puzzle ${i(t.type)}`,o=ie("div",{class:n,"data-port-kind":t.kind,"data-port-type":String(t.type)}),a=t.label?t.label:String(t.type);o.appendChild(ie("div",{class:"opPort__puzzleLabel"},a));const s=Wi({kind:t.kind,type:t.type});return o.appendChild(s),o}function Rt(e){const{ports:t,kind:i,portStyle:n,getPortClass:o}=e,a=ie("div",{class:"opCard__portsRow"}),s=ie("div",{class:"opCard__portsLabel"},i==="input"?"IN":"OUT");a.appendChild(s);const l=ie("div",{class:"opCard__ports"});for(const p of t){const r=n==="puzzle"?qi({port:p,getPortClass:o}):Ji({port:p,getPortClass:o});l.appendChild(r)}return a.appendChild(l),a}function ge(e,t,i){return Math.max(t,Math.min(i,e))}function Ge(e){const t=String(e||"").toLowerCase();return t==="image"?"image":t==="mask"?"mask":t==="svg"?"svg":"unknown"}function Ke(e){return e==="image"?{w:34,d:7,shape:"circle"}:e==="svg"?{w:30,d:7,shape:"triangle"}:e==="mask"?{w:28,d:6,shape:"rect"}:{w:26,d:6,shape:"rect"}}function Zi(e){return`url("data:image/svg+xml,${encodeURIComponent(e).replace(/'/g,"%27").replace(/"/g,"%22")}")`}function Yi(e){const{root:t,inType:i,outType:n}=e,o=Ge(i),a=Ge(n),s=Ke(o),l=Ke(a),p=Xi({inType:i,outType:n}),r=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 110" preserveAspectRatio="none">
    <path d="${p}" fill="white"/>
  </svg>`,g=Zi(r);t.style.webkitMaskImage=g,t.style.webkitMaskRepeat="no-repeat",t.style.webkitMaskSize="100% 100%",t.style.webkitMaskPosition="center",t.style.maskImage=g,t.style.maskRepeat="no-repeat",t.style.maskSize="100% 100%",t.style.maskPosition="center",t.classList.add("opCard--puzzleFrame"),t.style.position="relative",t.style.border="none",t.style.overflow="visible",t.style.minWidth="0";let u=t.querySelector(":scope > svg.opCard__puzzleOutline");if(!u)u=document.createElementNS("http://www.w3.org/2000/svg","svg"),u.classList.add("opCard__puzzleOutline"),u.setAttribute("viewBox","0 0 100 110"),u.setAttribute("preserveAspectRatio","none"),u.innerHTML=`<path d="${p}" fill="none" stroke="rgba(255,255,255,0.18)" stroke-width="1.5"/>`,t.insertBefore(u,t.firstChild);else{const b=u.querySelector("path");b&&b.setAttribute("d",p)}const h=t.classList.contains("opCard--compact"),c=h?22:26,d=h?16:18,m=h?16:18,v=d+Math.round(s.d*.9),y=m+Math.round(l.d*.9);t.style.setProperty("--opPuzzleInsetX",`${c}px`),t.style.setProperty("--opPuzzleInsetTop",`${v}px`),t.style.setProperty("--opPuzzleInsetBottom",`${y}px`)}function Xi(e){const l=Ge(e.inType),p=Ge(e.outType),r=Ke(l),g=Ke(p),u=50,h=ge(r.w,18,40),c=ge(r.d,6,12),d=ge(g.w,18,40),m=Math.max(6,Math.min(12,8)),v=ge(g.d,6,m),y=ge(u-h/2,20,80),b=ge(u+h/2,20,80),x=ge(u-d/2,20,80),w=ge(u+d/2,20,80);function C(){if(r.shape==="triangle")return`L ${u} ${0+c} L ${b} 0`;if(r.shape==="circle"){const L=y,T=b,B=T-L,f=c,$=Math.max(6,B*.25),U=L+B/2;return[`C ${L+$} 0 ${L+$} ${0+f} ${U} ${0+f}`,`C ${T-$} ${0+f} ${T-$} 0 ${T} 0`].join(" ")}return`V ${0+c} H ${b} V 0`}function E(){if(g.shape==="triangle")return`L ${u} ${100+v} L ${x} 100`;if(g.shape==="circle"){const L=w,T=x,B=L-T,f=v,$=Math.max(6,B*.25),U=T+B/2;return[`C ${L-$} 100 ${L-$} ${100+f} ${U} ${100+f}`,`C ${T+$} ${100+f} ${T+$} 100 ${T} 100`].join(" ")}return`V ${100+v} H ${x} V 100`}return["M 16 0",`H ${y}`,C(),"H 84","A 10 10 0 0 1 94 10","V 90","A 10 10 0 0 1 84 100",`H ${w}`,E(),"H 16","A 10 10 0 0 1 6 90","V 10","A 10 10 0 0 1 16 0","Z"].join(" ")}function Je(e,t){const i=Ki(e),n={compact:!!(t!=null&&t.compact),showId:(t==null?void 0:t.showId)??!0,showGroup:(t==null?void 0:t.showGroup)??!0,portStyle:(t==null?void 0:t.portStyle)??"chip",cardStyle:(t==null?void 0:t.cardStyle)??"plain",getPortClass:(t==null?void 0:t.getPortClass)??Hi,onClick:t==null?void 0:t.onClick},o=ie("div",{class:`opCard${n.compact?" opCard--compact":""}`,"data-op-id":i.id}),a=ie("div",{class:"opCard__content"}),s=ie("div",{class:"opCard__head"}),l=ie("div",{class:"opCard__title"},i.title);s.appendChild(l);const p=ie("div",{class:"opCard__meta"});n.showGroup&&i.group&&p.appendChild(ie("span",{class:"opBadge opBadge--group"},i.group)),n.showId&&p.appendChild(ie("span",{class:"opBadge opBadge--id"},i.id)),s.appendChild(p),a.appendChild(s);const r=ie("div",{class:"opCard__body"});return r.appendChild(Rt({ports:i.inputs,kind:"input",portStyle:n.portStyle,getPortClass:n.getPortClass})),r.appendChild(Rt({ports:i.outputs,kind:"output",portStyle:n.portStyle,getPortClass:n.getPortClass})),a.appendChild(r),o.appendChild(a),n.cardStyle==="puzzleFrame"&&Yi({root:o,inType:e.io.input,outType:e.io.output}),n.onClick&&(o.classList.add("opCard--clickable"),o.addEventListener("click",g=>{var u,h;(u=g.preventDefault)==null||u.call(g),(h=n.onClick)==null||h.call(n,i.id)})),o}function j(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function Qi(e){return e.type==="image"}function eo(e){return e.type==="mask"}function to(e){return e.type==="svg"}function gn(e){return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(e)}`}function Tt(e,t){if(Qi(e)){const n=j("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return Ue(n,e.image),n}if(eo(e)){const n=j("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return dt(n,e.mask,e.width,e.height),n}if(!to(e))return j("div",{class:"muted",style:"margin-top:8px; font-size:12px;"},`Unsupported output: ${String(e.type)}`);const i=j("img",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`,"aria-label":"SVG preview"});return i.src=gn(e.svg),i}function fn(e,t){const i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download=e,n.rel="noopener",n.click(),setTimeout(()=>URL.revokeObjectURL(i),500)}async function Lt(e,t){const i=await new Promise(n=>t.toBlob(o=>n(o),"image/png"));if(!i)throw new Error("Failed to create PNG blob.");fn(e,i)}function Ue(e,t){e.width=t.width,e.height=t.height;const i=e.getContext("2d",{willReadFrequently:!0});i&&i.putImageData(t,0,0)}function dt(e,t,i,n){e.width=i,e.height=n;const o=e.getContext("2d",{willReadFrequently:!0});if(!o)return;let a=0;const s=i*n;for(let g=0;g<s;g++){const u=t[g]??0;u>a&&(a=u)}const l=a<=1,p=o.createImageData(i,n),r=p.data;for(let g=0;g<s;g++){const u=t[g]??0;let h;l?h=(u>0?1:0)?0:255:h=u;const c=g*4;r[c]=h,r[c+1]=h,r[c+2]=h,r[c+3]=255}o.putImageData(p,0,0)}function no(e){const{hostEl:t,statusEl:i,handlers:n}=e;let o=!1,a=null,s=null,l=null,p=null,r=null,g=null,u=null,h=null,c=null,d=null,m=null,v=null,y=null;function b(){for(;t.firstChild;)t.removeChild(t.firstChild)}async function x(f){var k,A,D,R,V;const U=(typeof(f==null?void 0:f.activePipelineId)=="string"?f.activePipelineId:"pipeline").replace(/[^a-z0-9_-]+/gi,"_").slice(0,40)||"pipeline",z=(k=f==null?void 0:f.outputSvg)==null?void 0:k.svg;if(typeof z=="string"&&z.length>0){const O=new Blob([z],{type:"image/svg+xml;charset=utf-8"});fn(`beemage-${U}.svg`,O);return}const M=(A=f==null?void 0:f.outputImage)==null?void 0:A.data;if(M){const O=document.createElement("canvas");Ue(O,M),await Lt(`beemage-${U}.png`,O);return}const I=(D=f==null?void 0:f.outputMask)==null?void 0:D.data,S=(R=f==null?void 0:f.outputMask)==null?void 0:R.width,P=(V=f==null?void 0:f.outputMask)==null?void 0:V.height;if(I&&typeof S=="number"&&typeof P=="number"){const O=document.createElement("canvas");dt(O,I,S,P),await Lt(`beemage-${U}-mask.png`,O);return}throw new Error("No output to download.")}function w(){if(o)return;o=!0,b(),a=j("div",{class:"card"}),h=j("p",{class:"muted",style:"margin-top:0;"},"Universal pipeline runner. Select a pipeline and run it.");const f=j("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),$=j("label",{class:"fieldInline"});$.appendChild(j("span",{},"Pipeline")),s=j("select"),$.appendChild(s);const U=j("label",{class:"fieldInline"});U.appendChild(j("span",{},"Recipe")),l=j("select"),U.appendChild(l),p=j("button",{type:"button"},"Run all"),r=j("button",{type:"button"},"Next step"),g=j("button",{type:"button"},"Reset"),u=j("button",{type:"button"},"Download"),f.appendChild($),f.appendChild(U),f.appendChild(p),f.appendChild(r),f.appendChild(g),f.appendChild(u);const z=j("div",{class:"grid4",style:"margin-top:12px;"}),M=j("div",{class:"card"});M.appendChild(j("div",{class:"cardTitle"},"Input (from source)")),c=j("canvas",{class:"canvas","aria-label":"Pipeline input preview"}),M.appendChild(c);const I=j("div",{class:"card"});I.appendChild(j("div",{class:"cardTitle"},"Current output")),d=j("canvas",{class:"canvas","aria-label":"Pipeline current output preview"}),m=j("img",{class:"canvas","aria-label":"Pipeline SVG output preview",style:"display:none;"}),I.appendChild(d),I.appendChild(m);const S=j("div",{class:"card",style:"grid-column:1 / -1;"});S.appendChild(j("div",{class:"cardTitle"},"Stages")),v=j("div"),S.appendChild(v),z.appendChild(M),z.appendChild(I),z.appendChild(S),a.appendChild(h),a.appendChild(f),a.appendChild(z),t.appendChild(a),s.addEventListener("change",()=>{const P=s?s.value:"segmentation";n.onSelectPipeline(P)}),l.addEventListener("change",()=>{const P=l?l.value:"default";n.onSelectRecipe(P)}),p.addEventListener("click",()=>n.onRunAll()),r.addEventListener("click",()=>n.onNext()),g.addEventListener("click",()=>n.onReset()),u.addEventListener("click",async()=>{try{await x(y)}catch(P){const k=P instanceof Error?P.message:String(P);i.textContent=`Download failed: ${k}`}})}function C(f){if(!s||!l)return;const $=Array.isArray(f==null?void 0:f.pipelines)?f.pipelines:[],U=Array.isArray(f==null?void 0:f.recipes)?f.recipes:[],z=typeof(f==null?void 0:f.activePipelineId)=="string"?f.activePipelineId:"segmentation",M=typeof(f==null?void 0:f.activeRecipeId)=="string"?f.activeRecipeId:"default";s.innerHTML="";for(const I of $){const S=j("option");S.value=I.id,S.textContent=I.title,I.id===z&&(S.selected=!0),s.appendChild(S)}l.innerHTML="";for(const I of U){const S=j("option");S.value=I.id,S.textContent=I.title,I.id===M&&(S.selected=!0),l.appendChild(S)}}function E(f){var U;if(!c)return;const $=(U=f==null?void 0:f.input)==null?void 0:U.data;if(!$){c.width=1,c.height=1;const z=c.getContext("2d");z&&z.clearRect(0,0,c.width,c.height);return}Ue(c,$)}function L(f){var P,k,A,D,R;if(!d||!m)return;const $=(P=f==null?void 0:f.outputSvg)==null?void 0:P.svg;if(typeof $=="string"&&$.length>0){d.style.display="none",m.style.display="block",m.src=gn($);return}d.style.display="block",m.style.display="none",m.src="";const U=(k=f==null?void 0:f.outputImage)==null?void 0:k.data;if(U){Ue(d,U);return}const z=(A=f==null?void 0:f.outputMask)==null?void 0:A.data,M=(D=f==null?void 0:f.outputMask)==null?void 0:D.width,I=(R=f==null?void 0:f.outputMask)==null?void 0:R.height;if(z&&typeof M=="number"&&typeof I=="number"){dt(d,z,M,I);return}d.width=1,d.height=1;const S=d.getContext("2d");S&&S.clearRect(0,0,d.width,d.height)}function T(f){if(!v)return;v.innerHTML="";const $=Array.isArray(f==null?void 0:f.stages)?f.stages:[];if(!$.length){v.appendChild(j("div",{class:"muted",style:"font-size:12px;"},"No stages."));return}const U=j("div",{style:"display:flex; flex-direction:column; gap:10px;"});for(const z of $)U.appendChild(B(z));v.appendChild(U)}function B(f){const $=j("div",{class:"card",style:"padding:10px;"}),U=j("div",{class:"row",style:"align-items:center; justify-content:space-between;"});U.appendChild(j("div",{style:"font-weight:bold;"},String(f.title??f.stageId))),U.appendChild(j("div",{class:"status"},String(f.state??"idle"))),$.appendChild(U),$.appendChild(j("div",{class:"muted",style:"font-size:12px;"},`${f.input} -> ${f.output}`)),typeof f.error=="string"&&f.error.length>0&&$.appendChild(j("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Stage error: ${f.error}`));const z=f.outputArtifact;z&&$.appendChild(Tt(z,260));const M=Array.isArray(f.ops)?f.ops:[];if(M.length){const I=j("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:8px;"});for(let S=0;S<M.length;S++){const P=M[S],k=S===M.length-1,A=j("div",{class:"card",style:"padding:8px;"}),D=j("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),R={id:String(P.opId??""),title:String(P.title??P.opId??"Operation"),io:{input:P.input,output:P.output},group:P.group},V=Je(R,{compact:!0,showGroup:!0,showId:!0,portStyle:"puzzle",cardStyle:"plain"});D.appendChild(V),D.appendChild(j("div",{class:"status"},String(P.state??"idle"))),A.appendChild(D),typeof P.error=="string"&&P.error.length>0&&A.appendChild(j("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Op error: ${P.error}`));const O=z&&k?void 0:P.outputArtifact;O&&A.appendChild(Tt(O,200)),I.appendChild(A)}$.appendChild(I)}return $}return{mount(){w()},render(f){var $,U,z;if(w(),y=f,C(f),i.textContent=typeof(f==null?void 0:f.statusText)=="string"?f.statusText:"Idle",h){const M=typeof(f==null?void 0:f.description)=="string"?f.description:"Universal pipeline runner.";h.textContent=M}if(u){const M=typeof(($=f==null?void 0:f.outputSvg)==null?void 0:$.svg)=="string"&&f.outputSvg.svg.length>0,I=!!((U=f==null?void 0:f.outputImage)!=null&&U.data),S=!!((z=f==null?void 0:f.outputMask)!=null&&z.data);u.disabled=!(M||I||S)}E(f),L(f),T(f)},dispose(){o=!1,a=null,s=null,l=null,p=null,r=null,g=null,u=null,h=null,c=null,d=null,m=null,v=null,y=null,b()}}}function Re(e,t){return e.find(i=>i.id===t)??null}function oe(e,t){return{input:e,output:t}}function Mt(e,t){return`${e}.${t+1}`}function pt(e){const t=[{kind:"dispatch",id:"op.seg.resize",title:"Resize",io:oe("image","image"),dispatchId:"segmentation.resize",tuningId:"segmentation.resize",group:"Segmentation"},{kind:"dispatch",id:"op.seg.denoise",title:"Denoise",io:oe("image","image"),dispatchId:"segmentation.denoise",tuningId:"segmentation.denoise",group:"Segmentation"},{kind:"dispatch",id:"op.seg.color",title:"Color / Gray",io:oe("image","image"),dispatchId:"segmentation.color",tuningId:"segmentation.color",group:"Segmentation"},{kind:"dispatch",id:"op.seg.threshold",title:"Threshold",io:oe("image","mask"),dispatchId:"segmentation.threshold",tuningId:"segmentation.threshold",group:"Segmentation"},{kind:"dispatch",id:"op.seg.morphology",title:"Morphology cleanup",io:oe("mask","mask"),dispatchId:"segmentation.morphology",tuningId:"segmentation.morphology",group:"Segmentation"},{kind:"dispatch",id:"op.edge.resize",title:"Resize",io:oe("image","image"),dispatchId:"edge.resize",tuningId:"edge.resize",group:"Edge"},{kind:"dispatch",id:"op.edge.threshold",title:"Threshold",io:oe("image","mask"),dispatchId:"edge.threshold",tuningId:"edge.threshold",group:"Edge"},{kind:"dispatch",id:"op.edge.morphology",title:"Morphology cleanup",io:oe("mask","mask"),dispatchId:"edge.morphology",tuningId:"edge.morphology",group:"Edge"},{kind:"dispatch",id:"op.edge.extract",title:"Edge extract",io:oe("mask","mask"),dispatchId:"edge.extract",tuningId:"edge.extract",group:"Edge"},{kind:"dispatch",id:"op.svg.create",title:"Create SVG",io:oe("mask","svg"),dispatchId:"svg.create",tuningId:"svg.create",group:"SVG"},{kind:"dispatch",id:"op.mage.clean.removeSmallComponents",title:"Remove small components",io:oe("mask","mask"),dispatchId:"mage.clean.removeSmallComponents",tuningId:"mage.clean.removeSmallComponents",group:"Cleanup"},{kind:"js",id:"op.util.pass.image",title:"Pass-through (image)",io:oe("image","image"),group:"Utility",run:({input:r})=>r},{kind:"js",id:"op.util.pass.mask",title:"Pass-through (mask)",io:oe("mask","mask"),group:"Utility",run:({input:r})=>r}];function i(r){return Re(t,r)}function n(r,g){return g.map((u,h)=>({instanceId:Mt(r,h),opId:u,enabled:!0}))}const o=[{id:"segmentation",title:"Segmentation",implemented:!0,description:"Multi-step segmentation pipeline (image -> mask).",ops:n("segmentation",["op.seg.resize","op.seg.denoise","op.seg.color","op.seg.threshold","op.seg.morphology"])},{id:"edge",title:"Edge",implemented:!0,description:"Edge extraction pipeline (image -> mask -> edges).",ops:n("edge",["op.edge.resize","op.edge.threshold","op.edge.morphology","op.edge.extract"])},{id:"svg",title:"SVG",implemented:!0,description:"Image to SVG outline.",ops:n("svg",["op.edge.resize","op.edge.threshold","op.edge.morphology","op.edge.extract","op.svg.create"])},{id:"cleanup",title:"Cleanup (min area)",implemented:!0,description:"Image -> mask -> cleanup (morphology + remove small components).",ops:n("cleanup",["op.seg.resize","op.seg.threshold","op.seg.morphology","op.mage.clean.removeSmallComponents"])},{id:"surface",title:"Surface",implemented:!1,description:"Future: region labeling + vectorize pipeline.",ops:[]}],a=(e==null?void 0:e.userPipelines)??[];function s(r){return Re(o,r)}function l(r){return Re(a,r)??Re(o,r)}function p(){const r=new Set(a.map(u=>u.id));return[...o.filter(u=>!r.has(u.id)),...a]}return{ops:t,getOp:i,builtIns:o,getBuiltIn:s,listPipelines:p,getPipeline:l,createInstanceId:Mt}}const Dt=sn();function io(){return{opencvReady:ye()}}function oo(e){const{implemented:t,policy:i,runtimeOpenCvReady:n}=e,o=n&&t.includes("opencv");return t.includes("native")||t.length,i==="native"?{engine:"native"}:i==="opencv"?o?{engine:"opencv"}:{engine:"native",fallbackReason:n?"Override policy=opencv, but this op has no OpenCV implementation.":"Override policy=opencv, but OpenCV is not available at runtime."}:i==="auto"?o?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}async function ao(e,t){const i=await $e(),n=io(),o=rn(e,Dt,i,n),a=Dt.byId.get(e);if(!a)throw new Error(`[opsDispatch] Unknown op in registry: ${e}`);const l={...o.params,...(t==null?void 0:t.params)??{}},p=t!=null&&t.enginePolicy&&t.enginePolicy!=="inherit"?t.enginePolicy:o.policy;let r=o.engine,g=o.fallbackReason;if(t!=null&&t.enginePolicy&&t.enginePolicy!=="inherit"){const u=oo({implemented:a.implementedEngines,policy:p,runtimeOpenCvReady:!!n.opencvReady});r=u.engine,g=u.fallbackReason}return{engine:r,params:l,fallbackReason:g,opencvReady:!!n.opencvReady}}async function so(e,t,i,n){const{engine:o,params:a,fallbackReason:s,opencvReady:l}=await ao(e,n);return o==="opencv"&&!l?(Be(`OpenCV selected for ${e} but not ready; falling back to native. ${s??""}`.trim()),await i[e].native(t,a)):await i[e][o](t,a)}function Te(e,t,i,n){if(!t||!i)return e;const o=Math.floor(Number(n.morphAlgo??2)),a=lo(Math.floor(Number(n.morphIters??1)),1,20),s=Math.floor(Number(n.morphK??5)),l=ro(s),p=l-1>>1;if(o<=0||l<=1)return e;let r=e,g=new Uint8Array(t*i);for(let u=0;u<a;u++){if(o===1){Bt(r,g,t,i,p);const h=r;r=g,g=h;continue}if(o===2){Ot(r,g,t,i,p);const h=r;r=g,g=h;continue}Ot(r,g,t,i,p),r===e&&u===0&&(r=new Uint8Array(e)),Bt(g,r,t,i,p)}return r}function ro(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:5}function Ot(e,t,i,n,o){t.fill(0);for(let a=0;a<n;a++){const s=Math.max(0,a-o),l=Math.min(n-1,a+o);for(let p=0;p<i;p++){const r=Math.max(0,p-o),g=Math.min(i-1,p+o);let u=0;for(let h=s;h<=l&&!u;h++){let c=h*i+r;for(let d=r;d<=g;d++,c++)if(e[c]){u=1;break}}t[a*i+p]=u}}}function Bt(e,t,i,n,o){t.fill(0);for(let a=0;a<n;a++){const s=Math.max(0,a-o),l=Math.min(n-1,a+o);for(let p=0;p<i;p++){const r=Math.max(0,p-o),g=Math.min(i-1,p+o);let u=1;for(let h=s;h<=l&&u;h++){let c=h*i+r;for(let d=r;d<=g;d++,c++)if(!e[c]){u=0;break}}t[a*i+p]=u}}}function lo(e,t,i){return e<t?t:e>i?i:e}function hn(e,t,i,n){const o=Math.max(0,Math.floor(Number(n??0)));if(!t||!i||o<=1)return e;const a=new Uint8Array(e),s=new Uint8Array(e.length),l=new Int32Array(e.length),p=new Int32Array(e.length);for(let r=0;r<i;r++)for(let g=0;g<t;g++){const u=r*t+g;if(e[u]===0||s[u]===1)continue;let h=0,c=0;s[u]=1,l[c]=g,p[c]=r,c++;const d=[u];for(;h<c;){const m=l[h],v=p[h];h++;const y=m-1,b=v,x=m+1,w=v,C=m,E=v-1,L=m,T=v+1;if(y>=0){const B=b*t+y;e[B]!==0&&s[B]===0&&(s[B]=1,l[c]=y,p[c]=b,c++,d.push(B))}if(x<t){const B=w*t+x;e[B]!==0&&s[B]===0&&(s[B]=1,l[c]=x,p[c]=w,c++,d.push(B))}if(E>=0){const B=E*t+C;e[B]!==0&&s[B]===0&&(s[B]=1,l[c]=C,p[c]=E,c++,d.push(B))}if(T<i){const B=T*t+L;e[B]!==0&&s[B]===0&&(s[B]=1,l[c]=L,p[c]=T,c++,d.push(B))}}if(d.length<o)for(let m=0;m<d.length;m++)a[d[m]]=0}return a}function co(){const e=globalThis;return e!=null&&e.cv&&typeof e.cv.Mat=="function"?e.cv:null}function po(e,t){const{width:i,height:n}=e,o=Math.max(0,Math.floor(Number(t.cleanMinArea??0)));if(on("OpenCV removeSmallComponents params",{width:i,height:n,minArea:o}),!i||!n||o<=1)return e.mask;const a=co();if(!a)return hn(e.mask,i,n,o);const s=new a.Mat(n,i,a.CV_8UC1);try{const l=s.data,p=e.mask;for(let h=0;h<p.length;h++)l[h]=p[h]?255:0;const r=new a.Mat,g=new a.Mat,u=new a.Mat;try{const h=a.connectedComponentsWithStats(s,r,g,u,8,a.CV_32S),c=a.CC_STAT_AREA??4,d=new Array(h).fill(!1);for(let y=1;y<h;y++)g.intAt(y,c)<o&&(d[y]=!0);const m=new Uint8Array(i*n),v=r.data32S;for(let y=0;y<m.length;y++){const b=v[y];m[y]=b>0&&!d[b]?1:0}return m}finally{r.delete(),g.delete(),u.delete()}}finally{s.delete()}}function Le(e,t,i,n){const o=Math.max(0,Math.min(255,Math.floor(Number(n.manualT??128)))),a=new Uint8Array(t*i),s=e.data;for(let l=0,p=0;l<a.length;l++,p+=4){const r=s[p],g=s[p+1],u=s[p+2],h=r*77+g*150+u*29>>8;a[l]=h>=o?1:0}return a}function Me(e,t,i,n){const o=Math.max(1,Math.floor(Number(n.targetMaxW??t)));if(!t||!i||t<=o)return e;const a=o/t,s=Math.max(1,Math.floor(t*a)),l=Math.max(1,Math.floor(i*a));return Math.floor(Number(n.resizeAlgo??1))===0?uo(e,t,i,s,l):go(e,t,i,s,l)}function uo(e,t,i,n,o){const a=e.data,s=new Uint8ClampedArray(n*o*4),l=t/n,p=i/o;for(let r=0;r<o;r++){const g=Math.min(i-1,Math.max(0,Math.floor((r+.5)*p-.5)));for(let u=0;u<n;u++){const h=Math.min(t-1,Math.max(0,Math.floor((u+.5)*l-.5))),c=(g*t+h)*4,d=(r*n+u)*4;s[d]=a[c],s[d+1]=a[c+1],s[d+2]=a[c+2],s[d+3]=a[c+3]}}return new ImageData(s,n,o)}function go(e,t,i,n,o){const a=e.data,s=new Uint8ClampedArray(n*o*4),l=t/n,p=i/o;for(let r=0;r<o;r++){const g=(r+.5)*p-.5,u=De(Math.floor(g),0,i-1),h=De(u+1,0,i-1),c=g-u;for(let d=0;d<n;d++){const m=(d+.5)*l-.5,v=De(Math.floor(m),0,t-1),y=De(v+1,0,t-1),b=m-v,x=(u*t+v)*4,w=(u*t+y)*4,C=(h*t+v)*4,E=(h*t+y)*4,L=(r*n+d)*4;for(let T=0;T<4;T++){const B=a[x+T],f=a[w+T],$=a[C+T],U=a[E+T],z=B+(f-B)*b,M=$+(U-$)*b,I=z+(M-z)*c;s[L+T]=fo(I)}}}return new ImageData(s,n,o)}function De(e,t,i){return e<t?t:e>i?i:e}function fo(e){return e<=0?0:e>=255?255:e|0}function Ut(e,t,i,n){if(!t||!i)return e;const o=Math.floor(Number(n.denoiseAlgo??1));if(o<=0)return e;const a=Math.floor(Number(n.blurK??3)),s=ho(a);return o===2&&s<=3?yo(e,t,i):s<=1?e:mo(e,t,i,s)}function ho(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:3}function mo(e,t,i,n){const o=n-1>>1,a=e.data,s=new Uint8ClampedArray(t*i*4);for(let p=0;p<i;p++){let r=0,g=0,u=0,h=0;for(let c=-o;c<=o;c++){const d=be(c,0,t-1),m=(p*t+d)*4;r+=a[m],g+=a[m+1],u+=a[m+2],h+=a[m+3]}for(let c=0;c<t;c++){const d=(p*t+c)*4;s[d]=r/n|0,s[d+1]=g/n|0,s[d+2]=u/n|0,s[d+3]=h/n|0;const m=be(c-o,0,t-1),v=be(c+o+1,0,t-1),y=(p*t+m)*4,b=(p*t+v)*4;r+=a[b]-a[y],g+=a[b+1]-a[y+1],u+=a[b+2]-a[y+2],h+=a[b+3]-a[y+3]}}const l=new Uint8ClampedArray(t*i*4);for(let p=0;p<t;p++){let r=0,g=0,u=0,h=0;for(let c=-o;c<=o;c++){const m=(be(c,0,i-1)*t+p)*4;r+=s[m],g+=s[m+1],u+=s[m+2],h+=s[m+3]}for(let c=0;c<i;c++){const d=(c*t+p)*4;l[d]=r/n|0,l[d+1]=g/n|0,l[d+2]=u/n|0,l[d+3]=h/n|0;const m=be(c-o,0,i-1),v=be(c+o+1,0,i-1),y=(m*t+p)*4,b=(v*t+p)*4;r+=s[b]-s[y],g+=s[b+1]-s[y+1],u+=s[b+2]-s[y+2],h+=s[b+3]-s[y+3]}}return new ImageData(l,t,i)}function yo(e,t,i){const n=e.data,o=new Uint8ClampedArray(t*i*4),a=new Array(9),s=new Array(9),l=new Array(9),p=new Array(9);for(let r=0;r<i;r++)for(let g=0;g<t;g++){let u=0;for(let c=-1;c<=1;c++){const d=be(r+c,0,i-1);for(let m=-1;m<=1;m++){const v=be(g+m,0,t-1),y=(d*t+v)*4;a[u]=n[y],s[u]=n[y+1],l[u]=n[y+2],p[u]=n[y+3],u++}}a.sort(Oe),s.sort(Oe),l.sort(Oe),p.sort(Oe);const h=(r*t+g)*4;o[h]=a[4]|0,o[h+1]=s[4]|0,o[h+2]=l[4]|0,o[h+3]=p[4]|0}return new ImageData(o,t,i)}function Oe(e,t){return e-t}function be(e,t,i){return e<t?t:e>i?i:e}function Vt(e,t,i,n){if(!t||!i)return e;const o=Math.floor(Number(n.colorMode??1));if(o===0)return e;const a=e.data,s=new Uint8ClampedArray(t*i*4),l=vo(Math.floor(Number(n.hsvChannel??2)),0,2);for(let p=0,r=0;p<t*i;p++,r+=4){const g=a[r],u=a[r+1],h=a[r+2],c=a[r+3];let d=0;if(o===1)d=g*77+u*150+h*29>>8;else if(o===2){const m=bo(g,u,h),v=l===0?m.h:l===1?m.s:m.v;d=wo(v*255)}else d=255-(g*77+u*150+h*29>>8);s[r]=d,s[r+1]=d,s[r+2]=d,s[r+3]=c}return new ImageData(s,t,i)}function bo(e,t,i){const n=e/255,o=t/255,a=i/255,s=Math.max(n,o,a),l=Math.min(n,o,a),p=s-l;let r=0;p!==0&&(s===n?r=(o-a)/p%6:s===o?r=(a-n)/p+2:r=(n-o)/p+4,r/=6,r<0&&(r+=1));const g=s===0?0:p/s;return{h:r,s:g,v:s}}function vo(e,t,i){return e<t?t:e>i?i:e}function wo(e){return e<=0?0:e>=255?255:e|0}function zt(e,t,i){const n=new Uint8Array(e.length),o=(a,s)=>s*t+a;for(let a=0;a<i;a++)for(let s=0;s<t;s++){const l=o(s,a);if(e[l]===0)continue;if(s===0||a===0||s===t-1||a===i-1){n[l]=255;continue}const r=e[o(s-1,a)],g=e[o(s+1,a)],u=e[o(s,a-1)],h=e[o(s,a+1)];(r===0||g===0||u===0||h===0)&&(n[l]=255)}return n}function Nt(e,t,i,n){const o=Math.max(1,Math.floor(n.scale||1)),a=t*o,s=i*o,l=o;let p="";for(let h=0;h<i;h++){const c=h*t;for(let d=0;d<t;d++){if(e[c+d]===0)continue;const v=d*l,y=h*l;p+=`M${v} ${y}h${l}v${l}h-${l}Z`}}const r=n.transparentBg?"":`<rect x="0" y="0" width="${a}" height="${s}" fill="white"/>`,g=n.color||"#000",u=p.length>0?`<path d="${p}" fill="${g}" stroke="none"/>`:"";return`<svg xmlns="http://www.w3.org/2000/svg" width="${a}" height="${s}" viewBox="0 0 ${a} ${s}">`+r+u+"</svg>"}const Co="demo",Eo={"mage.clean.removeSmallComponents":{native:(e,t)=>hn(e.mask,e.width,e.height,t.cleanMinArea),opencv:(e,t)=>(F("OpenCV removeSmallComponents called (demo).",{width:e.width,height:e.height,cleanMinArea:t.cleanMinArea}),po(e,t))},"segmentation.resize":{native:(e,t)=>(F("[demo op] segmentation.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),Me(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(F("[demo op] segmentation.resize opencv",{width:e.width,height:e.height}),Me(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"segmentation.denoise":{native:(e,t)=>(F("[demo op] segmentation.denoise native",{width:e.width,height:e.height,denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}),Ut(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma})),opencv:(e,t)=>(F("[demo op] segmentation.denoise opencv",{width:e.width,height:e.height}),Ut(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}))},"segmentation.color":{native:(e,t)=>(F("[demo op] segmentation.color native",{width:e.width,height:e.height,colorMode:t.colorMode,hsvChannel:t.hsvChannel}),Vt(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel})),opencv:(e,t)=>(F("[demo op] segmentation.color opencv",{width:e.width,height:e.height}),Vt(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel}))},"segmentation.threshold":{native:(e,t)=>(F("[demo op] segmentation.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),Le(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(F("[demo op] segmentation.threshold opencv",{width:e.width,height:e.height}),Le(e.image,e.width,e.height,{manualT:t.manualT}))},"segmentation.morphology":{native:(e,t)=>(F("[demo op] segmentation.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),Te(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(F("[demo op] segmentation.morphology opencv",{width:e.width,height:e.height}),Te(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.resize":{native:(e,t)=>(F("[demo op] edge.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),Me(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(F("[demo op] edge.resize opencv",{width:e.width,height:e.height}),Me(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"edge.threshold":{native:(e,t)=>(F("[demo op] edge.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),Le(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(F("[demo op] edge.threshold opencv",{width:e.width,height:e.height}),Le(e.image,e.width,e.height,{manualT:t.manualT}))},"edge.morphology":{native:(e,t)=>(F("[demo op] edge.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),Te(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(F("[demo op] edge.morphology opencv",{width:e.width,height:e.height}),Te(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.extract":{native:(e,t)=>(F("[demo op] edge.extract native",{width:e.width,height:e.height}),zt(e.mask,e.width,e.height)),opencv:(e,t)=>(F("[demo op] edge.extract opencv",{width:e.width,height:e.height}),zt(e.mask,e.width,e.height))},"svg.create":{native:(e,t)=>(F("[demo op] svg.create native",{width:e.width,height:e.height,scale:t.scale}),Nt(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color})),opencv:(e,t)=>(F("[demo op] svg.create opencv",{width:e.width,height:e.height,scale:t.scale}),Nt(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color}))}};async function we(e,t,i){return on("[opsDispatch] runOp",{op:e,implSource:Co,inputKeys:t&&typeof t=="object"?Object.keys(t):typeof t,override:i?{enginePolicy:i.enginePolicy,paramsKeys:Object.keys(i.params??{})}:null}),so(e,t,Eo,i)}const ko=Object.freeze(Object.defineProperty({__proto__:null,runOp:we},Symbol.toStringTag,{value:"Module"}));function Io(e){return{width:e.width,height:e.height}}function xo(e){const{catalogue:t,pipeline:i}=e,n=(i.ops??[]).filter(a=>a.enabled!==!1),o=[];for(const a of n){const s=t.getOp(a.opId);if(!s)return{enabledInstances:[],specs:[],error:`Unknown opId in pipeline: ${a.opId}`};o.push(s)}return{enabledInstances:n,specs:o}}function So(e){const{specs:t,instances:i,startType:n}=e;if(t.length===0)return{ok:!1,startType:n,error:"Pipeline has no ops",steps:[]};let o=n;const a=[];for(let s=0;s<t.length;s++){const l=t[s],p=i[s],r=l.io.input,g=r===o;if(a.push({index:s,instanceId:p.instanceId,opId:l.id,title:l.title,expectedInput:r,actualInput:o,output:l.io.output,ok:g,error:g?void 0:`Chain IO mismatch at "${l.title}": needs ${r} but current is ${o}`}),!g)return{ok:!1,startType:n,error:a[a.length-1].error,steps:a};o=l.io.output}return{ok:!0,startType:n,endType:o,steps:a}}function jt(e){const{specs:t,startType:i,index:n}=e;if(n<=0)return i;let o=i;for(let a=0;a<Math.min(n,t.length);a++){const s=t[a];if(s.io.input!==o)return o;o=s.io.output}return o}function Po(e){const{beforeType:t,afterType:i,op:n}=e;return n.io.input!==t?{ok:!1,reason:`Needs ${n.io.input} but slot provides ${t}`}:i&&n.io.output!==i?{ok:!1,reason:`Produces ${n.io.output} but next op needs ${i}`}:{ok:!0}}function $o(e){return e.type==="image"}function Ao(e){return e.type==="mask"}function mn(e){return{type:"image",width:e.width,height:e.height,image:e}}function _t(e,t,i){return{type:"mask",width:t,height:i,mask:e}}function Ft(e,t,i){return{type:"svg",width:t,height:i,svg:e}}function He(e,t){return`IO mismatch: expected ${e}, got ${t}`}async function Ro(e,t,i){const n=t.override;if(e.io.input==="image"){if(!$o(i))throw new Error(He("image",i.type));const{width:s,height:l}=i;if(e.io.output==="image"){const p=await we(e.dispatchId,{image:i.image,width:s,height:l},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return mn(p)}if(e.io.output==="mask"){const p=await we(e.dispatchId,{image:i.image,width:s,height:l},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return _t(p,s,l)}if(e.io.output==="svg"){const p=await we(e.dispatchId,{image:i.image,width:s,height:l},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return Ft(p,s,l)}throw new Error(`Unsupported dispatch output: ${e.io.output}`)}if(!Ao(i))throw new Error(He("mask",i.type));const{width:o,height:a}=i;if(e.io.output==="mask"){const s=await we(e.dispatchId,{mask:i.mask,width:o,height:a},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return _t(s,o,a)}if(e.io.output==="svg"){const s=await we(e.dispatchId,{mask:i.mask,width:o,height:a},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return Ft(s,o,a)}throw new Error(`Invalid op spec: mask input cannot produce ${e.io.output} (unsupported here)`)}async function To(e,t,i,n){var l;if(e.kind==="dispatch")return await Ro(e,t,i);const a={...e.tuningId?await n.getEffectiveParams(e.tuningId).catch(()=>({})):{},...((l=t.override)==null?void 0:l.params)??{}};return await e.run({input:i,params:a})}async function Lo(e){const{catalogue:t,pipeline:i,inputImage:n,deps:o}=e,a=mn(n);if(!i.implemented)return{pipelineId:i.id,title:i.title,status:"error",error:"Not implemented yet",input:a,ops:[]};const s=xo({catalogue:t,pipeline:i});if(s.error)return{pipelineId:i.id,title:i.title,status:"error",error:s.error,input:a,ops:[]};const l=s.enabledInstances,p=s.specs,r=So({specs:p,instances:l,startType:"image"});if(!r.ok)return o.debug("pipeline validation failed (linear)",{pipelineId:i.id,error:r.error}),{pipelineId:i.id,title:i.title,status:"error",error:r.error??"Invalid pipeline typing",input:a,ops:l.map((h,c)=>{var d,m;return{instanceId:h.instanceId,opId:h.opId,title:((d=p[c])==null?void 0:d.title)??h.opId,io:((m=p[c])==null?void 0:m.io)??{input:"image",output:"image"},status:"error",error:r.error??"Invalid pipeline typing"}})};const g=[];let u=a;for(let h=0;h<p.length;h++){const c=l[h],d=p[h];try{if(d.io.input!==u.type)throw new Error(He(d.io.input,u.type));const m=await To(d,c,u,o);if(m.type!==d.io.output)throw new Error(He(d.io.output,m.type));g.push({instanceId:c.instanceId,opId:d.id,title:d.title,io:d.io,status:"ok",output:m}),u=m}catch(m){const v=m instanceof Error?m.message:String(m);return g.push({instanceId:c.instanceId,opId:d.id,title:d.title,io:d.io,status:"error",error:v}),o.debug("pipeline op failed (linear)",{pipelineId:i.id,opId:d.id,error:v,...Io(u)}),{pipelineId:i.id,title:i.title,status:"error",error:`Op "${d.title}" failed: ${v}`,input:a,ops:g}}}return{pipelineId:i.id,title:i.title,status:"ok",input:a,output:u,ops:g}}const ut="beemage.pipeline.userPipelines.v1";async function Ce(){const e=await pe([ut]).catch(()=>({})),t=e==null?void 0:e[ut];if(!Array.isArray(t))return[];const i=[];for(const n of t)!n||typeof n!="object"||typeof n.id=="string"&&Array.isArray(n.ops)&&i.push(n);return i}async function We(e){await ue({[ut]:e}).catch(()=>null)}async function Mo(e){const t=await Ce(),i=t.findIndex(n=>n.id===e.id);if(i>=0){const n=t.slice();n[i]=e,await We(n);return}await We([...t,e])}async function Do(e){const i=(await Ce()).filter(n=>n.id!==e);await We(i)}const gt="beemage.pipeline.recipes.v1";function Oo(){return Date.now()}function yn(){return{recipesById:{}}}async function ve(){const e=await pe([gt]).catch(()=>({})),t=e==null?void 0:e[gt];return!t||typeof t!="object"?{}:t}async function Ae(e){await ue({[gt]:e}).catch(()=>null)}async function Bo(e,t){const i=await ve(),n=i[e]??yn();n.selectedRecipeId=t,i[e]=n,await Ae(i)}async function Uo(e,t){const i=await ve(),n=i[e]??yn();n.recipesById[t.id]={...t,updatedTs:Oo()},n.selectedRecipeId||(n.selectedRecipeId=t.id),i[e]=n,await Ae(i)}async function Vo(e,t){const i=await ve(),n=i[e];if(n){if(delete n.recipesById[t],n.selectedRecipeId===t){const o=Object.keys(n.recipesById);n.selectedRecipeId=o.length?o[0]:void 0}i[e]=n,await Ae(i)}}function zo(e){const t=[];for(const[i,n]of Object.entries(e??{})){const o=Object.values(n.recipesById??{});t.push({pipelineId:i,selectedRecipeId:n.selectedRecipeId,recipes:o})}return t.sort((i,n)=>i.pipelineId.localeCompare(n.pipelineId)),t}function No(e){if(!Array.isArray(e))return{};const t={};for(const i of e){if(!i||typeof i!="object")continue;const n=i.pipelineId;if(typeof n!="string"||!n)continue;const o=i.selectedRecipeId,a=i.recipes,s={};if(Array.isArray(a))for(const l of a){if(!l||typeof l!="object")continue;const p=l.id,r=l.title,g=l.updatedTs,u=l.ops;typeof p!="string"||!p||typeof r!="string"||!r||typeof g=="number"&&Array.isArray(u)&&(s[p]=l)}t[n]={selectedRecipeId:typeof o=="string"?o:void 0,recipesById:s}}return t}function jo(e){return e.type==="image"}function _o(e){return e.type==="mask"}function Fo(e){return e.type==="svg"}function Go(e){var $,U,z,M;let t=pt({userPipelines:[]}),i={},o=((z=(U=($=t.listPipelines)==null?void 0:$.call(t))==null?void 0:U[0])==null?void 0:z.id)??((M=t.builtIns[0])==null?void 0:M.id)??"segmentation",a="default",s=null,l="Idle",p=null,r=[],g=0,u=null;async function h(){var V,O,H,N,J;const I=o,S=a,P=await Ce().catch(()=>[]);t=pt({userPipelines:P}),i=await ve().catch(()=>({}));const k=((V=t.listPipelines)==null?void 0:V.call(t))??t.builtIns;k.some(Y=>Y.id===o)||(o=((O=k[0])==null?void 0:O.id)??"segmentation",a="default");const D=((H=t.getPipeline)==null?void 0:H.call(t,o))??((J=(N=t.listPipelines)==null?void 0:N.call(t))==null?void 0:J[0]);if(D&&d(D).some(se=>se.id===a)||(a="default"),I!==o||S!==a){v();return}r=[],g=0}function c(){var S,P,k;const I=((S=t.getPipeline)==null?void 0:S.call(t,o))??((k=(P=t.listPipelines)==null?void 0:P.call(t))==null?void 0:k[0]);if(!I)throw new Error("[pipeline] No pipelines available.");return I}function d(I){const S={id:"default",title:"Default",buildPipeline:D=>D},P=i==null?void 0:i[I.id],k=(P==null?void 0:P.recipesById)??{},A=[S];for(const D of Object.keys(k)){const R=k[D];!R||typeof R.id!="string"||A.push({id:String(R.id),title:typeof R.title=="string"&&R.title.trim().length?R.title:String(R.id),buildPipeline:V=>{const O=Array.isArray(R.ops)?R.ops:null;if(!O)return V;const H=O.filter(N=>N&&typeof N=="object").map(N=>({instanceId:typeof N.instanceId=="string"?N.instanceId:String(N.instanceId??""),opId:typeof N.opId=="string"?N.opId:String(N.opId??""),enabled:N.enabled===void 0?!0:!!N.enabled})).filter(N=>N.instanceId&&N.opId);return H.length?{...V,ops:H}:V}})}return A.slice(0,1).concat(A.slice(1).sort((D,R)=>String(D.title).localeCompare(String(R.title))))}function m(){const I=c(),S=d(I),P=S.find(k=>k.id===a)??S[0];return a=P.id,P.buildPipeline(I)}function v(){l=m().implemented?"Ready":"Not implemented yet",p=null,r=[],g=0,u=null}function y(){v()}function b(I){var P,k;I===o||!(((P=t.getPipeline)==null?void 0:P.call(t,I))??((k=t.getBuiltIn)==null?void 0:k.call(t,I)))||(o=I,a="default",y())}function x(I){if(I===a)return;const S=c();a=d(S).some(A=>A.id===I)?I:"default",y()}function w(I){s=I,v()}function C(I){const S=I.ops.filter(k=>k.enabled!==!1),P=[];for(let k=0;k<S.length;k++){const A=S[k],D=t.getOp(A.opId);D&&P.push({index0:k,instanceId:A.instanceId,opSpec:D})}return P}function E(I){var A;const S=I.ops.map(D=>({instanceId:D.instanceId,opId:D.opId,title:D.title,input:D.io.input,output:D.io.output,state:D.status==="ok"?"ok":D.status==="error"?"error":"idle",error:D.error,outputArtifact:D.output})),P=I.status==="ok"?"ok":"error",k=I.output??((A=S.slice().reverse().find(D=>D.outputArtifact))==null?void 0:A.outputArtifact);return[{stageId:"pipeline",title:"Pipeline",input:"image",output:(k==null?void 0:k.type)??"image",ops:S,state:P,error:I.error,outputArtifact:k}]}function L(I,S){S&&(jo(S)?I.outputImage={width:S.width,height:S.height,data:S.image}:_o(S)?I.outputMask={width:S.width,height:S.height,data:S.mask}:Fo(S)&&(I.outputSvg={width:S.width,height:S.height,svg:S.svg}))}async function T(){const I=m();if(!I.implemented){l="Not implemented yet";return}if(!s){l="No input image";return}l="Running all…";const S=await Lo({catalogue:t,pipeline:I,inputImage:s,deps:e.runner});p=S,r=C(I),g=r.length,u=S.output??null,l=S.status==="ok"?"Done":S.error??"Error"}async function B(){const I=m();if(!I.implemented){l="Not implemented yet";return}if(!s){l="No input image";return}if(r.length===0&&(r=C(I),g=0,u={type:"image",width:s.width,height:s.height,image:s},p={pipelineId:I.id,title:I.title,status:"ok",input:{type:"image",width:s.width,height:s.height,image:s},output:{type:"image",width:s.width,height:s.height,image:s},ops:[]}),g>=r.length){l="Done";return}const S=r[g],P=S.opSpec;u||(u={type:"image",width:s.width,height:s.height,image:s});try{if(l=`Running: ${P.title}`,u.type!==P.io.input)throw new Error(`IO mismatch: expected ${P.io.input}, got ${u.type}`);const k=P.tuningId?await e.runner.getEffectiveParams(P.tuningId).catch(()=>({})):{};let A;if(P.kind==="dispatch"){const{runOp:V}=await Mn(async()=>{const{runOp:O}=await Promise.resolve().then(()=>ko);return{runOp:O}},void 0,import.meta.url);if(u.type==="image"){const O=await V(P.dispatchId,{image:u.image,width:u.width,height:u.height});if(P.io.output==="image"){const H=O;A={type:"image",width:H.width,height:H.height,image:H}}else if(P.io.output==="mask")A={type:"mask",width:u.width,height:u.height,mask:O};else throw new Error(`Unsupported dispatch output: ${P.io.output}`)}else if(u.type==="mask"){const O=await V(P.dispatchId,{mask:u.mask,width:u.width,height:u.height});if(P.io.output==="mask")A={type:"mask",width:u.width,height:u.height,mask:O};else if(P.io.output==="svg")A={type:"svg",width:u.width,height:u.height,svg:O};else throw new Error(`Invalid dispatch output: ${P.io.output}`)}else throw new Error("Dispatch ops cannot take svg input.")}else A=await P.run({input:u,params:k});if(A.type!==P.io.output)throw new Error(`IO mismatch: expected ${P.io.output}, got ${A.type}`);const R=((p==null?void 0:p.ops)??[]).concat([{instanceId:S.instanceId,opId:P.id,title:P.title,io:P.io,status:"ok",output:A}]);p={pipelineId:I.id,title:I.title,status:"ok",input:{type:"image",width:s.width,height:s.height,image:s},output:A,ops:R},u=A,g+=1,l=g>=r.length?"Done":"Ready"}catch(k){const A=k instanceof Error?k.message:String(k);l=`Error: ${P.title} — ${A}`;const R=((p==null?void 0:p.ops)??[]).concat([{instanceId:S.instanceId,opId:P.id,title:P.title,io:P.io,status:"error",error:A}]);p={pipelineId:I.id,title:I.title,status:"error",error:A,input:{type:"image",width:s.width,height:s.height,image:s},ops:R},e.runner.debug("pipeline next-step failed",{pipelineId:I.id,recipeId:a,instanceId:S.instanceId,opId:P.id,error:A})}}function f(){var V;const I=c(),S=m(),P=d(I),D={pipelines:(((V=t.listPipelines)==null?void 0:V.call(t))??t.builtIns).map(O=>({id:O.id,title:O.title})),recipes:P.map(O=>({id:O.id,title:O.title})),activePipelineId:o,activeRecipeId:a,statusText:l,description:S.description,stages:p?E(p):[],input:s?{width:s.width,height:s.height,data:s}:void 0,nextIndex:g,totalOps:r.length||S.ops.filter(O=>O.enabled!==!1).length},R=(p==null?void 0:p.output)??u??null;return L(D,R),D}return y(),{getVm:f,setActivePipeline:b,setActiveRecipe:x,setInputImageData:w,runAll:T,runNext:B,reset:y,reloadCatalogue:h}}const ft=new Set;function Ko(e){return ft.add(e),()=>{ft.delete(e)}}function fe(e){const t=Array.from(ft);for(const i of t)try{i(e)}catch{}}function Ho(e,t,i){const n=Go({runner:{getEffectiveParams:async k=>await i.getEffectiveParams(k).catch(()=>({})),debug:(k,A)=>Z({scope:"panel",kind:"debug",message:k,meta:A})}});let o=null,a=!1,s=null,l=null,p=null,r=!1;const g=[];function u(){p||(p=Ko(k=>{a&&(g.push(`${k.kind}:${k.reason}`),c())}))}function h(){p==null||p(),p=null}function c(){r||(r=!0,queueMicrotask(()=>{r=!1;const k=g.splice(0,g.length).join(",")||"unknown";d(k)}))}async function d(k){Z({scope:"panel",kind:"info",message:"Pipeline tab: auto reload catalogue",meta:{reason:k}});const A=n.getVm(),D=String(A.activePipelineId??""),R=String(A.activeRecipeId??"");try{await n.reloadCatalogue()}catch(N){const J=N instanceof Error?N.message:String(N);Z({scope:"panel",kind:"error",message:"Pipeline tab: auto reloadCatalogue failed",meta:{reason:k,error:J}}),_({scope:"panel",kind:"error",message:"Pipeline catalogue refresh failed (auto)."});return}const V=n.getVm(),O=String(V.activePipelineId??""),H=String(V.activeRecipeId??"");(D!==O||R!==H)&&(_({scope:"panel",kind:"info",message:`Pipeline selection updated due to storage change: ${D}/${R} → ${O}/${H}`}),i.setParamValue("pipeline","mode",O),i.setParamValue("pipeline","recipe",H)),w(),Ie(V),f()}async function m(){n.reset();const k=C();k&&n.setInputImageData(k),Ie(n.getVm()),_({scope:"panel",kind:"info",message:"Pipeline reset (reseed from source)"});try{await n.reloadCatalogue()}catch(A){Z({scope:"panel",kind:"error",message:"Pipeline reset: reloadCatalogue() failed",meta:{error:A instanceof Error?A.message:String(A)}}),_({scope:"panel",kind:"error",message:"Pipeline reset: failed to reload pipeline catalogue from storage."})}try{await T()}catch(A){Z({scope:"panel",kind:"error",message:"Pipeline reset: syncPipelineFromTuning() failed",meta:{error:A instanceof Error?A.message:String(A)}}),w()}Ie(n.getVm()),f()}function v(){const k=n.getVm();if(!(k.stages.some(R=>R.state==="error")||String(k.statusText).toLowerCase().includes("error"))){l=null;return}const D=String(k.statusText||"Pipeline error");D!==l&&(l=D,_({scope:"panel",kind:"error",message:`Pipeline: ${D}`}))}function y(){e.pipelineTuningMountEl.innerHTML=""}function b(k){return[k,`pipeline.${k}`,"pipeline"]}function x(k){const A=b(k);if(s===A[0])return;y();let D=null,R=null;for(const V of A)try{i.mount({mountEl:e.pipelineTuningMountEl,scopeRootId:V}),D=V;break}catch(O){R=O,y()}if(!D){s=null,_({scope:"panel",kind:"info",message:`Pipeline tuning mount failed for "${k}" (no matching scope).`}),Z({scope:"panel",kind:"error",message:"Pipeline tuning mount failed (no candidate scopeRootId worked)",meta:{pipelineId:k,candidates:A,error:R instanceof Error?R.message:String(R)}});return}s=D,_({scope:"panel",kind:"info",message:`Pipeline tuning mount: pipelineId=${k}, scopeRootId=${D}`})}function w(){const k=n.getVm(),A=typeof k.activePipelineId=="string"?k.activePipelineId:"segmentation";x(A)}function C(){const k=e.srcCanvasEl,A=k.width,D=k.height;if(!A||!D)return null;const R=k.getContext("2d",{willReadFrequently:!0});return R?R.getImageData(0,0,A,D):null}function E(){if(n.getVm().input)return;const A=C();A&&n.setInputImageData(A)}function L(){const k=C();k&&n.setInputImageData(k)}async function T(){const k=await i.getEffectiveParams("pipeline").catch(()=>({})),A=k==null?void 0:k.mode,D=k==null?void 0:k.recipe,R=typeof A=="string"?A:"segmentation",V=typeof D=="string"?D:"default";n.setActivePipeline(R),n.setActiveRecipe(V),w()}function B(){return o||(_({scope:"panel",kind:"info",message:"Pipeline view: create + mount"}),o=no({hostEl:e.pipelineViewMountEl,statusEl:e.pipelineStatusEl,handlers:{onSelectPipeline:k=>{_({scope:"panel",kind:"info",message:`Pipeline select: ${k}`}),n.setActivePipeline(k),i.setParamValue("pipeline","mode",k),w(),f()},onSelectRecipe:k=>{_({scope:"panel",kind:"info",message:`Recipe select: ${k}`}),n.setActiveRecipe(k),i.setParamValue("pipeline","recipe",k),f()},onRunAll:()=>void $(),onNext:()=>void U(),onReset:()=>{m()}}}),o.mount(),w(),o)}function f(){B().render(n.getVm())}async function $(){_({scope:"panel",kind:"info",message:"Pipeline run: all"}),L();try{await n.runAll()}finally{Ie(n.getVm()),f(),v()}}async function U(){_({scope:"panel",kind:"info",message:"Pipeline run: next"}),E();try{await n.runNext()}finally{Ie(n.getVm()),f(),v()}}function z(){}async function M(){a=!0,_({scope:"panel",kind:"info",message:"Pipeline tab: mount()"}),L(),await n.reloadCatalogue().catch(()=>null),await T(),u(),_({scope:"panel",kind:"info",message:"Pipeline tab: render()"}),f()}async function I(){a&&(_({scope:"panel",kind:"info",message:"Pipeline tab: refresh()"}),L(),await n.reloadCatalogue().catch(()=>null),await T(),f())}function S(){a=!1,h(),_({scope:"panel",kind:"info",message:"Pipeline tab: unmount()"})}function P(){_({scope:"panel",kind:"info",message:"Pipeline tab: dispose()"}),h(),o==null||o.dispose(),o=null,s=null,y()}return{bind:z,mount:M,unmount:S,refresh:I,dispose:P}}function ht(e){return!!e&&typeof e=="object"}function Wo(e){if(!ht(e)||typeof e.id!="string"||!e.id||typeof e.title!="string"||!e.title||typeof e.implemented!="boolean"||!Array.isArray(e.ops))return!1;for(const t of e.ops)if(!ht(t)||typeof t.instanceId!="string"||!t.instanceId||typeof t.opId!="string"||!t.opId||t.enabled!==void 0&&typeof t.enabled!="boolean")return!1;return!0}function Jo(){const e=pt({userPipelines:[]});async function t(){return await Ce().catch(()=>[])}function i(){return e.ops}async function n(){return await ve().catch(()=>({}))}async function o(h){await Do(h).catch(()=>null),fe({kind:"userPipelines",reason:"delete",pipelineId:h})}async function a(h){await Mo(h).catch(()=>null),fe({kind:"userPipelines",reason:"upsert",pipelineId:h.id})}async function s(h){const c=await ve().catch(()=>({}));!c||typeof c!="object"||(delete c[h],await Ae(c).catch(()=>null),fe({kind:"recipes",reason:"deleteAllForPipeline",pipelineId:h}))}async function l(h,c){await Bo(h,c).catch(()=>null),fe({kind:"recipes",reason:"select",pipelineId:h,recipeId:c})}async function p(h,c){await Uo(h,c).catch(()=>null),fe({kind:"recipes",reason:"upsert",pipelineId:h,recipeId:c.id})}async function r(h,c){await Vo(h,c).catch(()=>null),fe({kind:"recipes",reason:"delete",pipelineId:h,recipeId:c})}async function g(h){let c;try{c=JSON.parse(h)}catch{throw new Error("Invalid JSON (parse failed).")}let d,m;if(Array.isArray(c))d=c;else if(ht(c)&&Array.isArray(c.pipelines))d=c.pipelines,m=c.recipes;else throw new Error('Invalid file shape. Expected {"pipelines":[...]} or an array of pipelines.');const v=d,y=v.length,b=[];let x=0;for(const E of v){if(!Wo(E)){x++;continue}b.push(E)}if(b.length===0)throw new Error("No valid pipelines found in the imported file.");const w=await Ce().catch(()=>[]),C=new Map;for(const E of w)C.set(E.id,E);for(const E of b)C.set(E.id,E);if(await We(Array.from(C.values())),fe({kind:"userPipelines",reason:"import"}),m!==void 0){if(!Array.isArray(m))throw new Error('Invalid "recipes" shape. Expected an array (or omit the field).');const E=No(m);await Ae(E).catch(()=>null),fe({kind:"recipes",reason:"import"})}return{imported:b.length,skipped:x,totalInFile:y}}async function u(){const h=await Ce().catch(()=>[]),c=await ve().catch(()=>({})),d={format:"beemage.pipeline.userPipelines.v2",exportedAt:new Date().toISOString(),pipelines:h,recipes:zo(c)};return JSON.stringify(d,null,2)}return{listUserPipelines:t,listOperations:i,importFromJsonText:g,exportToJsonText:u,listAllRecipes:n,deleteUserPipelineById:o,upsertUserPipeline:a,setSelectedRecipe:l,upsertRecipe:p,deleteRecipe:r,deleteAllRecipesForPipeline:s}}function ce(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function qo(e){return e.enabled!==!1}function Zo(e){const t=new Map;for(const i of e)t.set(i.id,i);return t}function Yo(e,t,i){const n={compactOps:i==null?void 0:i.compactOps},o=Zo(t),a=ce("div",{class:"pipelineCard"}),s=ce("div",{class:"pipelineCardHead"}),l=ce("div",{style:"display:flex; flex-direction:column; gap:2px;"});l.appendChild(ce("div",{class:"pipelineCardTitle"},e.title||e.id)),s.appendChild(l);{const u=e.implemented?"implemented":"not implemented";s.appendChild(ce("div",{class:"status"},u))}a.appendChild(s);const p=ce("div",{class:"pipelineOps",style:"margin-top:10px;"}),g=Array.isArray(e.ops)?e.ops:[];if(!g.length)return p.appendChild(ce("div",{class:"muted",style:"font-size:12px;"},"No operations in this pipeline.")),a.appendChild(p),a;for(let u=0;u<g.length;u++){const h=g[u],c=o.get(h.opId),d=!qo(h),m=c?Je(c,{compact:n.compactOps,showGroup:!0,showId:!0}):ce("div",{class:"opCard opCard--unknown",style:"padding:10px;"},`Unknown operation: ${h.opId}`);d&&m.classList.add("is-disabled"),p.appendChild(m),u<g.length-1&&p.appendChild(ce("div",{class:"pipelineConnector","aria-hidden":"true"}))}return a.appendChild(p),a}function ae(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function Xo(e){return JSON.parse(e)}function Qo(e){const{pipelineId:t,instanceIds:i,selectedRecipeId:n,recipes:o,handlers:a}=e,s=ae("div",{class:"card",style:"padding:10px; margin-top:8px;"});s.appendChild(ae("div",{class:"cardTitle"},"Recipes"));const l=ae("div",{class:"row",style:"gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px;"});s.appendChild(l);const p=ae("label",{class:"fieldInline"});p.appendChild(ae("span",{},"Selected"));const r=ae("select"),g=ae("option");g.value="",g.textContent="None",r.appendChild(g);for(const b of o){const x=ae("option");x.value=b.id,x.textContent=`${b.title} (${b.id})`,r.appendChild(x)}r.value=n??"",r.addEventListener("change",()=>{const b=r.value;b&&a.onSelectRecipe(t,b)}),p.appendChild(r),l.appendChild(p);const u=ae("button",{class:"btn",type:"button"},"New recipe"),h=ae("button",{class:"btn",type:"button"},"Edit recipe"),c=ae("button",{class:"btn",type:"button"},"Delete recipe");l.appendChild(u),l.appendChild(h),l.appendChild(c);const d=ae("div",{class:"muted",style:"font-size:12px; margin-top:8px;"},`Recipes store only deltas per instanceId. Valid instanceIds: ${i.join(", ")||"(none)"}`);s.appendChild(d);function m(){const b=window.prompt("New recipe id (unique within this pipeline):","new");if(!b)return;const x=window.prompt("Recipe title:",b);x&&a.onUpsertRecipe(t,{id:b,title:x,ops:[]})}function v(){const b=(n??r.value)||"";if(!b){window.alert("Select a recipe first.");return}const x=o.find(E=>E.id===b);if(!x){window.alert("Recipe not found.");return}const w={id:x.id,title:x.title,ops:x.ops},C=window.prompt(`Edit recipe JSON (pipeline=${t}).

Structure: { id, title, ops: [{ instanceId, enabled?, override?: { enginePolicy?, params? } }] }

`,JSON.stringify(w,null,2));if(C)try{const E=Xo(C);if(typeof E.id!="string"||!E.id)throw new Error("Missing recipe.id");if(typeof E.title!="string"||!E.title)throw new Error("Missing recipe.title");if(!Array.isArray(E.ops))throw new Error("Missing recipe.ops array");for(const L of E.ops){if(!L||typeof L!="object")throw new Error("Invalid patch object in ops");if(typeof L.instanceId!="string"||!L.instanceId)throw new Error("Patch missing instanceId");i.length&&!i.includes(L.instanceId)&&console.warn("Recipe patch references unknown instanceId",t,L.instanceId)}a.onUpsertRecipe(t,{id:E.id,title:E.title,ops:E.ops})}catch(E){const L=E instanceof Error?E.message:String(E);window.alert(`Invalid recipe JSON: ${L}`)}}function y(){const b=(n??r.value)||"";if(!b){window.alert("Select a recipe first.");return}window.confirm(`Delete recipe "${b}" from pipeline "${t}"?`)&&a.onDeleteRecipe(t,b)}return u.addEventListener("click",m),h.addEventListener("click",v),c.addEventListener("click",y),o.length||(h.disabled=!0,c.disabled=!0),s}function he(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function ea(e){return JSON.parse(e)}function ta(e){const{pipeline:t,opsLibrary:i,selectedRecipeId:n,recipes:o,handlers:a}=e,s=he("div",{class:"card",style:"padding:10px; margin-top:10px;"}),l=he("div",{class:"row",style:"justify-content:space-between; align-items:center; gap:10px;"}),p=he("div",{class:"cardTitle"},`${t.title} (${t.id})`);l.appendChild(p);const r=he("div",{class:"row",style:"gap:8px; align-items:center;"}),g=he("button",{class:"btn",type:"button"},"Edit"),u=he("button",{class:"btn",type:"button"},"Delete");r.appendChild(g),r.appendChild(u),l.appendChild(r),s.appendChild(l),t.description&&s.appendChild(he("div",{class:"muted",style:"font-size:12px; margin-top:6px;"},t.description));const h=he("div",{style:"margin-top:10px;"});h.appendChild(Yo(t,i,{compactOps:!0})),s.appendChild(h);const c=t.ops.map(v=>v.instanceId);s.appendChild(Qo({pipelineId:t.id,instanceIds:c,selectedRecipeId:n,recipes:o,handlers:a}));function d(){const v={id:t.id,title:t.title,description:t.description??"",implemented:t.implemented,ops:t.ops},y=window.prompt(`Edit pipeline JSON.

Structure: { id, title, description?, implemented, ops: [{ instanceId, opId, enabled?, override? }] }

`,JSON.stringify(v,null,2));if(y)try{const b=ea(y);if(!b||typeof b!="object")throw new Error("Invalid JSON object");if(typeof b.id!="string"||!b.id)throw new Error("Missing pipeline.id");if(typeof b.title!="string"||!b.title)throw new Error("Missing pipeline.title");if(typeof b.implemented!="boolean")throw new Error("Missing pipeline.implemented boolean");if(!Array.isArray(b.ops))throw new Error("Missing pipeline.ops array");for(const x of b.ops){if(!x||typeof x!="object")throw new Error("Invalid op entry");if(typeof x.instanceId!="string"||!x.instanceId)throw new Error("Op missing instanceId");if(typeof x.opId!="string"||!x.opId)throw new Error("Op missing opId");if(x.enabled!==void 0&&typeof x.enabled!="boolean")throw new Error("Op.enabled must be boolean")}a.onUpsertPipeline(b)}catch(b){const x=b instanceof Error?b.message:String(b);window.alert(`Invalid pipeline JSON: ${x}`)}}function m(){window.confirm(`Delete pipeline "${t.id}"? This also deletes its recipes.`)&&a.onDeletePipeline(t.id)}return g.addEventListener("click",d),u.addEventListener("click",m),s}function W(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function Gt(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function na(e,t){return`${e}.${t+1}`}function ia(e){const t=new Map;for(const i of e)t.set(i.id,i);return t}function Kt(e,t){const i=[];for(const n of e.opIds){const o=t.get(n);o&&i.push(o)}return i}function oa(e,t){let i=t;for(const n of e){if(n.io.input!==i)return i;i=n.io.output}return i}function aa(e){const{mountEl:t,onSavePipeline:i}=e;let n=!1,o=[],a=new Map;const s="image";let l,p="Drag an operation from the left and drop it into a slot.",r=null;function g(w){const C="margin-top:10px; padding:8px 10px; border-radius:10px; font-size:12px; border:1px solid rgba(255,255,255,0.12);";return w==="error"?C+" background: rgba(255, 80, 80, 0.10);":w==="info"?C+" background: rgba(255, 200, 80, 0.10);":C+" background: rgba(80, 160, 255, 0.08);"}function u(w,C){l=w,p=C,r&&(r.setAttribute("style",g(w)),r.textContent=C)}function h(w){return w&&(w.getData("application/x-beemage-opid")||w.getData("text/plain"))||""}const c={id:"myPipeline",title:"My pipeline",description:"",implemented:!0,opIds:[]};function d(w,C){c.opIds.splice(w,0,C)}function m(w){c.opIds.splice(w,1)}function v(w,C){const E=w+C;if(E<0||E>=c.opIds.length)return;const L=c.opIds[w];c.opIds[w]=c.opIds[E],c.opIds[E]=L}function y(w,C){const E=a.get(C);if(!E)return{ok:!1,reason:"Unknown op"};const L=Kt(c,a),T=jt({specs:L,startType:s,index:w}),B=w<L.length?L[w].io.input:void 0;return Po({beforeType:T,afterType:B,op:E})}function b(){const w=c.id.trim(),C=c.title.trim();if(!w){window.alert("Pipeline id is required.");return}if(!C){window.alert("Pipeline title is required.");return}const E=[];for(const B of c.opIds){const f=a.get(B);if(!f){window.alert(`Unknown operation in draft: ${B}`);return}E.push(f)}const L={id:w,title:C,description:c.description||void 0,implemented:!!c.implemented,ops:c.opIds.map((B,f)=>({instanceId:na(w,f),opId:B,enabled:!0}))};let T=s;for(let B=0;B<E.length;B++){const f=E[B];if(f.io.input!==T){window.alert(`Invalid typing at step ${B+1}: "${f.title}" needs ${f.io.input} but current is ${T}`);return}T=f.io.output}i(L)}function x(){if(n)return;Gt(t);const w=W("div",{class:"card",style:"padding:10px;"});w.appendChild(W("div",{class:"cardTitle"},"Pipeline playground"));const C=W("div",{class:"row",style:"gap:10px; flex-wrap:wrap; align-items:flex-end; margin-top:10px;"}),E=W("label",{class:"fieldInline"});E.appendChild(W("span",{},"Id"));const L=W("input",{type:"text",value:c.id,style:"min-width:200px;"});L.addEventListener("input",()=>{c.id=L.value}),E.appendChild(L);const T=W("label",{class:"fieldInline"});T.appendChild(W("span",{},"Title"));const B=W("input",{type:"text",value:c.title,style:"min-width:240px;"});B.addEventListener("input",()=>{c.title=B.value}),T.appendChild(B);const f=W("label",{class:"fieldInline"});f.appendChild(W("span",{},"Implemented"));const $=W("input",{type:"checkbox"});$.checked=!!c.implemented,$.addEventListener("change",()=>{c.implemented=!!$.checked}),f.appendChild($);const U=W("button",{type:"button",class:"btn"},"Clear");U.addEventListener("click",()=>{c.opIds=[],x()});const z=W("button",{type:"button",class:"btn"},"Save pipeline");z.addEventListener("click",b),C.appendChild(E),C.appendChild(T),C.appendChild(f),C.appendChild(U),C.appendChild(z),w.appendChild(C);const M=W("label",{style:"display:block; margin-top:10px;"});M.appendChild(W("div",{class:"muted",style:"font-size:12px; margin-bottom:4px;"},"Description"));const I=W("textarea",{style:"width:100%; min-height:54px;"});I.value=c.description,I.addEventListener("input",()=>{c.description=I.value}),M.appendChild(I),w.appendChild(M);const S=Kt(c,a),P=oa(S,s),k=W("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},`Start: ${s}  →  Current output: ${P}`);w.appendChild(k),r=W("div",{style:g(l)},p),w.appendChild(r);const A=W("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:8px;"});A.appendChild(W("div",{style:"border:1px dashed rgba(255,255,255,0.18); border-radius:10px; padding:8px; background:rgba(0,0,0,0.08);"},`Input (${s})`));function D(R){const V=W("div",{"data-slot-index":String(R),style:"min-height:46px; display:flex; align-items:center; justify-content:center; border:1px dashed rgba(255,255,255,0.14); border-radius:10px; padding:8px; background:rgba(0,0,0,0.05); text-align:center; font-size:12px; cursor:copy;"}),O=jt({specs:S,startType:s,index:R}),H=R<S.length?S[R].io.input:void 0;return V.textContent=H?`Drop here (slot type: ${O} → next needs: ${H})`:`Drop here (slot type: ${O})`,V.addEventListener("dragenter",N=>{N.preventDefault(),V.style.background="rgba(80, 160, 255, 0.08)"}),V.addEventListener("dragover",N=>{N.preventDefault(),N.dataTransfer&&(N.dataTransfer.dropEffect="copy");const J=h(N.dataTransfer);if(!J)return;const Y=y(R,J);V.style.background=Y.ok?"rgba(80, 255, 140, 0.08)":"rgba(255, 80, 80, 0.06)"}),V.addEventListener("dragleave",()=>{V.style.background="rgba(0,0,0,0.05)"}),V.addEventListener("drop",N=>{N.preventDefault(),V.style.background="rgba(0,0,0,0.05)";const J=h(N.dataTransfer);if(!J){u("error","Drop refused: could not read operation id from the drag payload."),Z({scope:"panel",kind:"error",message:"Builder playground drop refused (missing opId)",meta:{index:R}});return}const Y=y(R,J);if(!Y.ok){u("info",`Drop refused: ${Y.reason??"operation cannot be inserted here."}`),Z({scope:"panel",kind:"info",message:"Builder playground drop refused (typing mismatch)",meta:{index:R,opId:J,reason:Y.reason??""}});return}d(R,J),u("info",`Inserted "${J}" at position ${R+1}.`),Z({scope:"panel",kind:"info",message:"Builder playground op inserted",meta:{index:R,opId:J}}),x()}),V}for(let R=0;R<=c.opIds.length;R++)if(A.appendChild(D(R)),R<c.opIds.length){const V=c.opIds[R],O=a.get(V),H=W("div",{class:"row",style:"gap:8px; align-items:flex-start;"}),N=W("div",{style:"flex:1;"});O?N.appendChild(Je(O,{compact:!0,showGroup:!0,showId:!0,portStyle:"puzzle",cardStyle:"puzzleFrame"})):N.appendChild(W("div",{class:"muted"},`Unknown op: ${V}`));const J=W("div",{style:"display:flex; flex-direction:column; gap:6px;"}),Y=W("button",{type:"button",class:"btn"},"Up");Y.disabled=R===0,Y.addEventListener("click",()=>{v(R,-1),x()});const le=W("button",{type:"button",class:"btn"},"Down");le.disabled=R===c.opIds.length-1,le.addEventListener("click",()=>{v(R,1),x()});const se=W("button",{type:"button",class:"btn"},"Remove");se.addEventListener("click",()=>{m(R),x()}),J.appendChild(Y),J.appendChild(le),J.appendChild(se),H.appendChild(N),H.appendChild(J),A.appendChild(H)}w.appendChild(A),t.appendChild(w)}return{render(w){o=w.opsLibrary??[],a=ia(o),x()},dispose(){n=!0,Gt(t)}}}function G(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function sa(e){const{dom:t,handlers:i}=e;let n=!1,o=!1,a="all",s="all",l=null,p=null,r="",g=null,u=null,h=null,c=null,d=null,m=null,v=null,y=null;function b(){if(u)return u;const M=G("div",{"data-role":"builderListMount",style:"margin-top:12px;"});return t.viewBuilder.appendChild(M),u=M,M}function x(){if(w(),h)return h;const M=G("div",{"data-role":"builderOpsMount"});return(d??t.viewBuilder).appendChild(M),h=M,M}function w(){c||(c=G("div",{"data-role":"builderLayout",style:"display:flex; gap:12px; align-items:flex-start; margin-top:12px;"}),d=G("div",{"data-role":"builderLeftCol",style:"flex:1; min-width:320px;"}),m=G("div",{"data-role":"builderRightCol",style:"flex:1; min-width:320px;"}),c.appendChild(d),c.appendChild(m),t.viewBuilder.appendChild(c))}function C(M,I){const S=G("select"),P=[{value:"all",label:"All"},{value:"image",label:"image"},{value:"mask",label:"mask"},{value:"svg",label:"svg"}];for(const k of P){const A=G("option");A.value=k.value,A.textContent=k.label,k.value===M&&(A.selected=!0),S.appendChild(A)}return S.addEventListener("change",()=>I(S.value)),S}function E(){if(w(),v)return v;const M=G("div",{"data-role":"builderPlaygroundMount"});return(m??t.viewBuilder).appendChild(M),v=M,y=aa({mountEl:v,onSavePipeline:async I=>{await i.onUpsertPipeline(I)}}),M}function L(M){const I=a==="all"?!0:M.io.input===a,S=s==="all"?!0:M.io.output===s;return I&&S}function T(M,I){const S=x();S.innerHTML="";const P=G("div",{class:"card",style:"padding:10px;"});P.appendChild(G("div",{class:"cardTitle"},"All operations"));const k=G("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px;"}),A=G("label",{class:"fieldInline"});A.appendChild(G("span",{},"Filter input")),l=C(String(a),O=>{a=O==="all"?"all":O,T(M)}),A.appendChild(l);const D=G("label",{class:"fieldInline"});D.appendChild(G("span",{},"Filter output")),p=C(String(s),O=>{s=O==="all"?"all":O,T(M)}),D.appendChild(p),k.appendChild(A),k.appendChild(D),P.appendChild(k);const R=M.filter(L);if(!R.length){P.appendChild(G("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No operations match the filter.")),S.appendChild(P);return}const V=G("div",{class:"opsGrid",style:"margin-top:10px;"});for(const O of R){const H=Je(O,{compact:!0,showGroup:!0,showId:!0,portStyle:"puzzle",cardStyle:"plain"});H.setAttribute("draggable","true"),H.addEventListener("dragstart",N=>{var J,Y;(J=N.dataTransfer)==null||J.setData("application/x-beemage-opid",O.id),(Y=N.dataTransfer)==null||Y.setData("text/plain",O.id),N.dataTransfer&&(N.dataTransfer.effectAllowed="copy")}),V.appendChild(H)}P.appendChild(V),S.appendChild(P)}function B(M,I){const S=b();S.innerHTML="";const P=G("div",{class:"card",style:"padding:10px;"});P.appendChild(G("div",{class:"cardTitle"},"Stored user pipelines"));const k=G("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px;"}),A=Array.isArray(I.examples)?I.examples:[],D=G("label",{class:"fieldInline"});D.appendChild(G("span",{},"Load example"));const R=G("select",{style:"min-width:260px;"});{const X=G("option");X.value="",X.textContent=A.length?"Select an example…":"No examples available",X.selected=!0,R.appendChild(X)}for(const X of A){const ne=G("option");ne.value=String(X.path??""),ne.textContent=String(X.title??X.id??X.path??"Example"),R.appendChild(ne)}D.appendChild(R);const V=G("button",{type:"button",class:"btn",style:"padding:4px 10px; font-size:12px;"},"Load");V.disabled=!0,R.addEventListener("change",()=>{V.disabled=!R.value}),V.addEventListener("click",()=>{const X=R.value;X&&(i.onLoadExample(X),R.value="",V.disabled=!0)});const O=G("label",{class:"fieldInline"});O.appendChild(G("span",{},"Filter pipelines")),g=G("input",{type:"text",value:r,placeholder:"Search by id or title…",style:"min-width:260px;"}),g.addEventListener("input",()=>{r=g?g.value:"",B(I.pipelines,I)}),O.appendChild(g);const H=G("button",{type:"button",class:"btn",style:"padding:4px 10px; font-size:12px;"},"Clear");H.addEventListener("click",()=>{r="",g&&(g.value=""),B(I.pipelines,I)}),k.appendChild(D),k.appendChild(V),k.appendChild(O),k.appendChild(H),P.appendChild(k);const N=Array.isArray(I.userPipelinesRaw)?I.userPipelinesRaw:[];if(!N.length){P.appendChild(G("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No user pipelines stored.")),S.appendChild(P);return}const J=r.trim().toLowerCase(),Y=J.length===0?N:N.filter(X=>{const ne=String(X.id??"").toLowerCase(),Ee=String(X.title??"").toLowerCase();return ne.includes(J)||Ee.includes(J)});if(!Y.length){P.appendChild(G("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No pipelines match the search.")),S.appendChild(P);return}const le=G("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:10px;"}),se=I.recipesAll??{};for(const X of Y){const ne=(se==null?void 0:se[X.id])??{recipesById:{},selectedRecipeId:void 0},Ee=(ne==null?void 0:ne.recipesById)??{},qe=Object.values(Ee),Ze=ne==null?void 0:ne.selectedRecipeId;le.appendChild(ta({pipeline:X,opsLibrary:I.ops??[],selectedRecipeId:Ze,recipes:qe,handlers:{onDeletePipeline:i.onDeletePipeline,onUpsertPipeline:i.onUpsertPipeline,onSelectRecipe:i.onSelectRecipe,onUpsertRecipe:i.onUpsertRecipe,onDeleteRecipe:i.onDeleteRecipe}}))}P.appendChild(le),S.appendChild(P)}function f(){o||(o=!0,t.builderImportFileEl.addEventListener("change",()=>{var M;(M=t.builderImportFileEl.files)==null||M[0]}),t.btnBuilderExportEl.addEventListener("click",()=>{i.onExport()}),t.builderImportFileEl.addEventListener("change",()=>{var I;const M=((I=t.builderImportFileEl.files)==null?void 0:I[0])??null;M&&(i.onImportFile(M),t.builderImportFileEl.value="")}))}function $(){n||(n=!0,w(),x(),E(),b())}function U(M){t.builderStatusEl.textContent=M.statusText||"Idle",w(),x(),E(),b(),y==null||y.render({opsLibrary:M.ops??[]}),T(M.ops??[]),B(M.pipelines,M)}function z(){n=!1,o=!1,a="all",s="all",r="",g=null,l=null,p=null,u&&(u.innerHTML="",u.remove(),u=null),h&&(h.innerHTML="",h.remove(),h=null),y==null||y.dispose(),y=null,v&&(v.innerHTML="",v.remove(),v=null),c&&(c.innerHTML="",c.remove(),c=null,d=null,m=null)}return{bind:f,mount:$,render:U,dispose:z}}function ra(e,t){const i=new Blob([t],{type:"application/json;charset=utf-8"}),n=URL.createObjectURL(i),o=document.createElement("a");o.href=n,o.download=e,o.rel="noopener",o.click(),setTimeout(()=>URL.revokeObjectURL(n),500)}function la(e,t){const i=Jo();let n=!1,o={},a=[],s="Idle",l=[],p=i.listOperations();async function r(){const w=wt("assets/pipelines/index.json"),C=await fetch(w,{cache:"no-store"});if(!C.ok)throw new Error(`Examples index not found: ${C.status}`);const E=await C.json().catch(()=>null),L=E==null?void 0:E.examples;return Array.isArray(L)?L.map(T=>({id:String((T==null?void 0:T.id)??""),title:String((T==null?void 0:T.title)??(T==null?void 0:T.id)??(T==null?void 0:T.path)??"Example"),path:String((T==null?void 0:T.path)??"")})).filter(T=>T.id&&T.path):[]}async function g(w){const C=wt(w),E=await fetch(C,{cache:"no-store"});if(!E.ok)throw new Error(`Example fetch failed (${E.status}): ${w}`);const L=await E.text();await i.importFromJsonText(L)}const u=sa({dom:e,handlers:{onImportFile:async w=>{try{s=`Importing: ${w.name}`,d();const C=await w.text(),E=await i.importFromJsonText(C);_({scope:"panel",kind:"info",message:`Builder import: imported=${E.imported}, skipped=${E.skipped}, total=${E.totalInFile}`}),s=`Imported ${E.imported} pipeline(s) (skipped ${E.skipped}).`,await h()}catch(C){const E=C instanceof Error?C.message:String(C);_({scope:"panel",kind:"error",message:`Builder import failed: ${E}`}),Z({scope:"panel",kind:"error",message:"Builder import failed",meta:{error:E}}),s=`Import failed: ${E}`,d()}},onExport:async()=>{try{s="Exporting…",d();const w=await i.exportToJsonText();ra("beemage-user-pipelines.json",w),_({scope:"panel",kind:"info",message:"Builder export: downloaded beemage-user-pipelines.json"}),s="Exported.",d()}catch(w){const C=w instanceof Error?w.message:String(w);_({scope:"panel",kind:"error",message:`Builder export failed: ${C}`}),Z({scope:"panel",kind:"error",message:"Builder export failed",meta:{error:C}}),s=`Export failed: ${C}`,d()}},onDeletePipeline:async w=>{try{await i.deleteUserPipelineById(w),await i.deleteAllRecipesForPipeline(w),_({scope:"panel",kind:"info",message:`Builder: deleted user pipeline "${w}" (and its recipes)`}),s=`Deleted pipeline ${w}.`,await h()}catch(C){const E=C instanceof Error?C.message:String(C);_({scope:"panel",kind:"error",message:`Delete pipeline failed: ${E}`}),Z({scope:"panel",kind:"error",message:"Delete pipeline failed",meta:{pipelineId:w,error:E}}),s=`Delete failed: ${E}`,d()}},onUpsertPipeline:async w=>{try{await i.upsertUserPipeline(w),_({scope:"panel",kind:"info",message:`Builder: saved user pipeline "${String((w==null?void 0:w.id)??"")}"`}),s=`Saved pipeline ${String((w==null?void 0:w.id)??"")}.`,await h()}catch(C){const E=C instanceof Error?C.message:String(C);_({scope:"panel",kind:"error",message:`Save pipeline failed: ${E}`}),Z({scope:"panel",kind:"error",message:"Save pipeline failed",meta:{error:E}}),s=`Save failed: ${E}`,d()}},onSelectRecipe:async(w,C)=>{try{await i.setSelectedRecipe(w,C),_({scope:"panel",kind:"info",message:`Builder: selected recipe "${C}" for pipeline "${w}"`}),s=`Selected recipe ${C} for ${w}.`,await h()}catch(E){const L=E instanceof Error?E.message:String(E);_({scope:"panel",kind:"error",message:`Select recipe failed: ${L}`}),Z({scope:"panel",kind:"error",message:"Select recipe failed",meta:{pipelineId:w,recipeId:C,error:L}}),s=`Select recipe failed: ${L}`,d()}},onUpsertRecipe:async(w,C)=>{try{await i.upsertRecipe(w,C),_({scope:"panel",kind:"info",message:`Builder: saved recipe "${String((C==null?void 0:C.id)??"")}" for pipeline "${w}"`}),s=`Saved recipe ${String((C==null?void 0:C.id)??"")} for ${w}.`,await h()}catch(E){const L=E instanceof Error?E.message:String(E);_({scope:"panel",kind:"error",message:`Save recipe failed: ${L}`}),Z({scope:"panel",kind:"error",message:"Save recipe failed",meta:{pipelineId:w,error:L}}),s=`Save recipe failed: ${L}`,d()}},onDeleteRecipe:async(w,C)=>{try{await i.deleteRecipe(w,C),_({scope:"panel",kind:"info",message:`Builder: deleted recipe "${C}" from pipeline "${w}"`}),s=`Deleted recipe ${C} from ${w}.`,await h()}catch(E){const L=E instanceof Error?E.message:String(E);_({scope:"panel",kind:"error",message:`Delete recipe failed: ${L}`}),Z({scope:"panel",kind:"error",message:"Delete recipe failed",meta:{pipelineId:w,recipeId:C,error:L}}),s=`Delete recipe failed: ${L}`,d()}},onLoadExample:async w=>{try{s=`Loading example: ${w}`,d(),await g(w),_({scope:"panel",kind:"info",message:`Builder example loaded: ${w}`}),s=`Loaded example: ${w}`,await h()}catch(C){const E=C instanceof Error?C.message:String(C);_({scope:"panel",kind:"error",message:`Load example failed: ${E}`}),Z({scope:"panel",kind:"error",message:"Load example failed",meta:{error:E,examplePath:w}}),s=`Load example failed: ${E}`,d()}}}});async function h(){const w=await i.listUserPipelines().catch(()=>[]);l=w,p=i.listOperations(),o=await i.listAllRecipes().catch(()=>({})),a=await r().catch(()=>[]),s=`Ready. User pipelines: ${w.length} · Operations: ${p.length} · Examples: ${a.length}`,d()}function c(){const w=l??[];return{statusText:s,pipelines:w.map(C=>({id:String(C.id),title:String(C.title),implemented:!!C.implemented,opCount:Array.isArray(C.ops)?C.ops.length:0})),userPipelinesRaw:w,ops:p,recipesAll:o??{},examples:a??[]}}function d(){u.mount(),u.render(c())}function m(){u.bind(),e.builderStatusEl.textContent="Idle"}async function v(){n=!0,s="Loading…",d(),await h()}async function y(){n&&(s="Refreshing…",d(),await h())}function b(){n=!1}function x(){u.dispose()}return{bind:m,mount:v,refresh:y,unmount:b,dispose:x}}async function ca(){const e=Dn();await st().catch(()=>null);const t=Un();t.start();const i=_n();globalThis.app__={...globalThis.app__,cache:i};const n=Gi({getRuntimeAvailability:()=>({opencvReady:!1}),debugTraceAppend:u=>Z({scope:"panel",kind:"debug",message:u}),actionLogAppend:u=>_({scope:"panel",kind:"info",message:u})});n.mount({mountEl:e.tuningMountEl,scopeRootId:"app"});const o=ti(e),a=pi(e),s=Ho(e,t,n),l=Ui(e,t),p=ji(e),r=la(e);o.bind(),s.bind(),a.bind(),l.bind(),p.bind(),r.bind();const g=jn(e,{image:o,pipeline:s,builder:r,colors:a,settings:l,logs:p});g.bind(),g.boot()}ca();
