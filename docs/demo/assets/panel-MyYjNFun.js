import{_ as gn}from"./index-DHluoiV1.js";function pn(){function e(He,dn){if(!He)throw new Error(`[dom] Missing #${dn}`);return He}const t=e(document.getElementById("appRoot"),"appRoot"),i=e(document.getElementById("tabImage"),"tabImage"),n=e(document.getElementById("tabColors"),"tabColors"),o=e(document.getElementById("tabSettings"),"tabSettings"),a=e(document.getElementById("tabLogs"),"tabLogs"),s=e(document.getElementById("tabPipeline"),"tabPipeline"),l=e(document.getElementById("tabBuilder"),"tabBuilder"),p=e(document.getElementById("viewImage"),"viewImage"),r=e(document.getElementById("viewColors"),"viewColors"),g=e(document.getElementById("viewSettings"),"viewSettings"),f=e(document.getElementById("viewLogs"),"viewLogs"),m=e(document.getElementById("viewPipeline"),"viewPipeline"),u=e(document.getElementById("viewBuilder"),"viewBuilder"),d=e(document.getElementById("dropZone"),"dropZone"),h=e(document.getElementById("fileInput"),"fileInput"),v=e(document.getElementById("srcCanvas"),"srcCanvas"),b=e(document.getElementById("pipelineStatus"),"pipelineStatus"),y=e(document.getElementById("pipelineTuningMount"),"pipelineTuningMount"),I=e(document.getElementById("pipelineViewMount"),"pipelineViewMount"),M=e(document.getElementById("builderImportFile"),"builderImportFile"),D=e(document.getElementById("btnBuilderExport"),"btnBuilderExport"),U=e(document.getElementById("builderStatus"),"builderStatus"),F=e(document.getElementById("colorsCanvas"),"colorsCanvas"),B=e(document.getElementById("palette"),"palette"),O=e(document.getElementById("btnColorsApply"),"btnColorsApply"),c=e(document.getElementById("btnColorsCancel"),"btnColorsCancel"),w=e(document.getElementById("btnColorsReset"),"btnColorsReset"),S=e(document.getElementById("edgesDark"),"edgesDark"),P=e(document.getElementById("edgeMaskThreshold"),"edgeMaskThreshold"),C=e(document.getElementById("edgeDilate"),"edgeDilate"),E=e(document.getElementById("maxRegionPx"),"maxRegionPx"),k=e(document.getElementById("colorsStatus"),"colorsStatus"),x=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),T=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),L=e(document.getElementById("devConfigDetails"),"devConfigDetails"),j=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),z=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),J=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),H=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),Nt=e(document.getElementById("logsCbDebug"),"logsCbDebug"),zt=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),Ft=e(document.getElementById("cfgStatus"),"cfgStatus"),jt=e(document.getElementById("cfgOpenCvSpinner"),"cfgOpenCvSpinner"),_t=e(document.getElementById("cfgOpenCvStatus"),"cfgOpenCvStatus"),Kt=e(document.getElementById("cfgOpenCvReport"),"cfgOpenCvReport"),Gt=e(document.getElementById("settingsEngineBox"),"settingsEngineBox"),Ht=e(document.getElementById("cfgUseOpenCv"),"cfgUseOpenCv"),Wt=e(document.getElementById("tuningMount"),"tuningMount"),Jt=e(document.getElementById("settingsVersion"),"settingsVersion"),qt=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),Yt=e(document.getElementById("logsLimit"),"logsLimit"),Zt=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),Xt=e(document.getElementById("logsStatus"),"logsStatus"),Qt=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),en=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),tn=e(document.getElementById("btnLogsExport"),"btnLogsExport"),nn=e(document.getElementById("btnLogsClear"),"btnLogsClear"),on=e(document.getElementById("logsOut"),"logsOut"),an=e(document.getElementById("debugLimit"),"debugLimit"),sn=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),rn=e(document.getElementById("btnDebugExport"),"btnDebugExport"),ln=e(document.getElementById("btnDebugClear"),"btnDebugClear"),cn=e(document.getElementById("debugStatus"),"debugStatus"),un=e(document.getElementById("debugOut"),"debugOut");return{rootEl:t,tabImage:i,tabColors:n,tabSettings:o,tabLogs:a,tabPipeline:s,tabBuilder:l,viewImage:p,viewColors:r,viewSettings:g,viewLogs:f,viewPipeline:m,viewBuilder:u,dropZoneEl:d,fileInputEl:h,srcCanvasEl:v,pipelineStatusEl:b,pipelineTuningMountEl:y,pipelineViewMountEl:I,builderImportFileEl:M,btnBuilderExportEl:D,builderStatusEl:U,colorsCanvasEl:F,paletteEl:B,btnColorsApplyEl:O,btnColorsCancelEl:c,btnColorsResetEl:w,edgesDarkEl:S,edgeMaskThresholdEl:P,edgeDilateEl:C,maxRegionPxEl:E,colorsStatusEl:k,cfgShowDevToolsEl:x,settingsGeneralStatusEl:T,devConfigDetailsEl:L,cfgTraceConsoleEl:j,cfgActionLogMaxEl:z,cfgDebugTraceMaxEl:J,cfgFailureLogsPerRunEl:H,logsCbDebugEl:Nt,btnCfgResetDefaults:zt,cfgStatusEl:Ft,settingsVersionEl:Jt,settingsGitHubLinkEl:qt,cfgOpenCvSpinner:jt,cfgOpenCvStatus:_t,cfgOpenCvReport:Kt,settingsEngineBoxEl:Gt,cfgUseOpenCvEl:Ht,tuningMountEl:Wt,logsLimitEl:Yt,btnLogsRefresh:Zt,logsStatusEl:Xt,logsTrimKeepEl:Qt,btnLogsTrim:en,btnLogsExport:tn,btnLogsClear:nn,logsOutEl:on,debugLimitEl:an,btnDebugRefresh:sn,btnDebugExport:rn,btnDebugClear:ln,debugStatusEl:cn,debugOutEl:un}}const fn=new Set;function hn(e){fn.add(e)}function mn(){const e=new Set;function t(n){return e.add(n),()=>e.delete(n)}function i(){hn(o=>{for(const a of e)a(o)})}return{on:t,start:i}}const bn=new Set;function ht(e){for(const t of bn)t(e,"local")}function se(e){const t=localStorage.getItem(e);if(t!==null)try{return JSON.parse(t)}catch{return t}}function yn(e,t){localStorage.setItem(e,JSON.stringify(t))}async function te(e){if(typeof e=="string")return{[e]:se(e)};if(Array.isArray(e)){const i={};for(const n of e)i[n]=se(n);return i}const t={};for(const[i,n]of Object.entries(e))t[i]=localStorage.getItem(i)!==null?se(i):n;return t}async function ne(e){const t={};for(const[i,n]of Object.entries(e)){const o=se(i);yn(i,n),t[i]={oldValue:o,newValue:n}}ht(t)}async function _e(e){const t=Array.isArray(e)?e:[e],i={};for(const n of t){const o=se(n);localStorage.removeItem(n),i[n]={oldValue:o,newValue:void 0}}ht(i)}function Z(e,t,i,n){const o=Number(String(e??"").trim());return Number.isFinite(o)?Math.max(t,Math.min(i,Math.floor(o))):n}const Oe="beemage.devConfig",G={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let $e=!1,ve={...G};function mt(e){const t=e||{};return{traceConsole:!!t.traceConsole,actionLogMax:Z(t.actionLogMax??G.actionLogMax,100,5e4,G.actionLogMax),debugTraceMax:Z(t.debugTraceMax??G.debugTraceMax,100,5e4,G.debugTraceMax),failureLogsPerRun:Z(t.failureLogsPerRun??G.failureLogsPerRun,0,5e4,G.failureLogsPerRun)}}async function Be(){if($e)return;const e=await te([Oe]).catch(()=>({}));ve=mt(e==null?void 0:e[Oe]),$e=!0}function we(){return ve}async function bt(e){ve=mt(e),$e=!0,await ne({[Oe]:ve}).catch(()=>null)}async function vn(){await bt({...G})}function wn(e,t){const i={pipeline:e.tabPipeline,image:e.tabImage,builder:e.tabBuilder,colors:e.tabColors,settings:e.tabSettings,logs:e.tabLogs},n={pipeline:e.viewPipeline,image:e.viewImage,builder:e.viewBuilder,colors:e.viewColors,settings:e.viewSettings,logs:e.viewLogs};let o="image";const a=new Set;function s(){const u=we();return!!(u!=null&&u.traceConsole)}function l(){const u=globalThis;u.__bctGlobalErrorHooksInstalled||(u.__bctGlobalErrorHooksInstalled=!0,window.addEventListener("error",d=>{var v;const h=d;console.error("[panel] window error",{message:h.message,filename:h.filename,lineno:h.lineno,colno:h.colno,error:h.error?String(h.error):null,stack:(v=h.error)!=null&&v.stack?String(h.error.stack):null})}),window.addEventListener("unhandledrejection",d=>{var h;console.error("[panel] unhandledrejection",{reason:d.reason?String(d.reason):null,stack:(h=d.reason)!=null&&h.stack?String(d.reason.stack):null})}))}s()&&l();function p(u){Object.keys(i).forEach(d=>{const h=d===u;i[d].classList.toggle("is-active",h),i[d].setAttribute("aria-selected",h?"true":"false"),n[d].hidden=!h,n[d].classList.toggle("is-active",h)})}function r(u){var d,h,v,b,y,I,M,D;if(u===o){(h=(d=t[u]).refresh)==null||h.call(d);return}(b=(v=t[o]).unmount)==null||b.call(v),o=u,p(o),a.has(o)?(D=(M=t[o]).refresh)==null||D.call(M):(a.add(o),(I=(y=t[o]).mount)==null||I.call(y))}function g(){i.image.addEventListener("click",u=>{var d;(d=u.preventDefault)==null||d.call(u),r("image")}),i.pipeline.addEventListener("click",u=>{var d;(d=u.preventDefault)==null||d.call(u),r("pipeline")}),i.colors.addEventListener("click",u=>{var d;(d=u.preventDefault)==null||d.call(u),r("colors")}),i.settings.addEventListener("click",u=>{var d;(d=u.preventDefault)==null||d.call(u),r("settings")}),i.logs.addEventListener("click",u=>{var d;(d=u.preventDefault)==null||d.call(u),r("logs")}),i.builder.addEventListener("click",u=>{var d;(d=u.preventDefault)==null||d.call(u),r("builder")})}function f(){var u,d,h,v;o="image",p(o),Object.keys(t).forEach(b=>{var y,I;return(I=(y=t[b]).boot)==null?void 0:I.call(y)}),a.has(o)?(v=(h=t[o]).refresh)==null||v.call(h):(a.add(o),(d=(u=t[o]).mount)==null||d.call(u))}function m(){Object.keys(t).forEach(u=>{var d,h;return(h=(d=t[u]).dispose)==null?void 0:h.call(d)})}return{bind:g,boot:f,activate:r,dispose:m}}function We(e){const t=e.items.length;return{items:e.items,counts:{items:t},meta:e.meta}}function En(){const e={items:[],meta:{}},t=new Set;function i(){const r=We(e);for(const g of t)try{g(r)}catch{}}function n(){return We(e)}function o(r){t.add(r);try{r(n())}catch{}return()=>t.delete(r)}function a(){e.items=[],e.meta={},i()}function s(r){e.meta.scopeUpdatedSince=r,i()}function l(){return String(e.meta.scopeUpdatedSince||"")}function p(r,g){e.items=r.slice(),e.meta.updatedTs=Date.now(),typeof(g==null?void 0:g.limit)=="number"&&(e.meta.limit=g.limit),i()}return{getSnapshot:n,subscribe:o,getScopeUpdatedSince:l,clearAll:a,setScopeUpdatedSince:s,setItems:p}}function Cn(e,t){function i(l){e.dropZoneEl.classList.toggle("is-hover",l)}function n(l,p){const r=l.getContext("2d",{willReadFrequently:!0});if(!r)return;const g=Math.max(1,l.width),f=Math.max(1,l.height);r.clearRect(0,0,g,f);const m=p.naturalWidth||p.width,u=p.naturalHeight||p.height;if(!m||!u)return;const d=Math.min(g/m,f/u),h=Math.max(1,Math.round(m*d)),v=Math.max(1,Math.round(u*d)),b=Math.floor((g-h)/2),y=Math.floor((f-v)/2);r.drawImage(p,b,y,h,v)}function o(l){n(e.srcCanvasEl,l)}function a(l){t.lastError=void 0,t.loadedImageName=l,t.hasImage=!0}function s(l){t.lastError=l,t.hasImage=!1}return{setHover:i,drawImageToSource:o,showLoadOk:a,showLoadError:s}}function kn(){return{loadedImageName:null,hasImage:!1,lastError:void 0}}const Ee="beemage.actionLog",In=5e3;function Sn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function xn(e){return Array.isArray(e)?e:[e]}function Ce(e,t,i){return Math.max(t,Math.min(i,Math.floor(e)))}async function re(){const e=await te(Ee),t=e==null?void 0:e[Ee];return Array.isArray(t)?t:[]}async function yt(e){await ne({[Ee]:e})}async function V(e,t){const i=Ce(In,100,5e4),o=xn(e).map(p=>({...p,id:Sn(),ts:Date.now()}));if(!o.length)return{total:(await re()).length};const s=(await re()).concat(o),l=s.length>i?s.slice(s.length-i):s;return await yt(l),{total:l.length}}async function Pn(e){const t=Ce((e==null?void 0:e.limit)??200,1,5e4),i=Ce((e==null?void 0:e.offset)??0,0,1e6);let o=await re();e!=null&&e.kind&&(o=o.filter(l=>l.kind===e.kind)),e!=null&&e.scope&&(o=o.filter(l=>l.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(o=o.filter(l=>l.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(o=o.filter(l=>l.ts<=e.untilTs));const a=o.length;o=o.slice().reverse();const s=o.slice(i,i+t);return{total:a,items:s}}async function An(e){let i=await re();if(typeof e.beforeTs=="number"&&(i=i.filter(n=>n.ts>=e.beforeTs)),typeof e.keepLast=="number"){const n=Ce(e.keepLast,0,5e4);n===0?i=[]:i.length>n&&(i=i.slice(i.length-n))}return await yt(i),{total:i.length}}async function Mn(){await _e(Ee)}async function Dn(e){const t=await re();return JSON.stringify(t,null,2)}const le="beemage.debugTrace",Ve="beemage.debugTrace.enabled",Tn=2e3;function Rn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function Ue(e,t,i){return Math.max(t,Math.min(i,Math.floor(e)))}async function ke(){const e=await te(le),t=e==null?void 0:e[le];return Array.isArray(t)?t:[]}async function Ln(e){await ne({[le]:e})}async function Ke(){const e=await te(Ve);return!!(e!=null&&e[Ve])}async function vt(e){await ne({[Ve]:!!e}),e||await _e(le)}async function wt(){await _e(le)}async function Y(e,t){if(!await Ke())return{total:0};const n=Ue((t==null?void 0:t.max)??Tn,100,5e4),o=(Array.isArray(e)?e:[e]).map(p=>({...p,id:Rn(),ts:Date.now()}));if(!o.length)return{total:(await ke()).length};const s=(await ke()).concat(o),l=s.length>n?s.slice(s.length-n):s;return await Ln(l),{total:l.length}}async function Et(e){const t=Ue((e==null?void 0:e.limit)??200,1,5e4),i=Ue((e==null?void 0:e.offset)??0,0,1e6),n=(e==null?void 0:e.reverse)??!0,o=await ke(),a=o.length,l=(n?o.slice().reverse():o).slice(i,i+t);return{total:a,items:l}}async function Ct(e){const t=await ke();return JSON.stringify(t,null,e!=null&&e.pretty?2:0)}const kt=Object.freeze(Object.defineProperty({__proto__:null,append:Y,clear:wt,exportJson:Ct,isEnabled:Ke,list:Et,setEnabled:vt},Symbol.toStringTag,{value:"Module"}));function On(e,t){const i=kn(),n=Cn(e,i);async function o(g){if(!g.type.startsWith("image/"))throw new Error(`Unsupported file type: ${g.type||"unknown"}`);const f=URL.createObjectURL(g);try{const m=new Image;return m.decoding="async",m.src=f,typeof m.decode=="function"?await m.decode():await new Promise((u,d)=>{m.onload=()=>u(),m.onerror=()=>d(new Error("Image decode failed."))}),m}finally{URL.revokeObjectURL(f)}}async function a(g){const f=await o(g);n.drawImageToSource(f),n.showLoadOk(g.name),V({scope:"panel",kind:"info",message:`Input loaded: ${g.name}`}),Y({scope:"panel",kind:"info",message:"Mage input loaded into srcCanvas",meta:{name:g.name,type:g.type,size:g.size,canvasW:e.srcCanvasEl.width,canvasH:e.srcCanvasEl.height,naturalW:f.naturalWidth||f.width,naturalH:f.naturalHeight||f.height}})}function s(){e.dropZoneEl.addEventListener("dragover",g=>{g.preventDefault(),n.setHover(!0)}),e.dropZoneEl.addEventListener("dragleave",()=>n.setHover(!1)),e.dropZoneEl.addEventListener("drop",g=>{var m,u;g.preventDefault(),n.setHover(!1);const f=(u=(m=g.dataTransfer)==null?void 0:m.files)==null?void 0:u[0];f&&a(f).catch(d=>{const h=d instanceof Error?d.message:String(d);n.showLoadError(h),V({scope:"panel",kind:"error",message:`Input load failed: ${h}`}),Y({scope:"panel",kind:"error",message:"Input load failed",meta:{error:h}})})}),e.fileInputEl.addEventListener("change",()=>{var f;const g=(f=e.fileInputEl.files)==null?void 0:f[0];g&&(a(g).catch(m=>{const u=m instanceof Error?m.message:String(m);n.showLoadError(u),V({scope:"panel",kind:"error",message:`Input load failed: ${u}`}),Y({scope:"panel",kind:"error",message:"Input load failed",meta:{error:u}})}),e.fileInputEl.value="")})}function l(){s()}function p(){}function r(){}return{id:"image",bind:l,mount:p,unmount:r}}function xe(e,t,i){return Number.isFinite(e)?Math.max(t,Math.min(i,Math.trunc(e))):t}function $n(e,t,i){return Math.round(.2126*e+.7152*t+.0722*i)}function It(e){return{edgesDark:!!(e.edgesDark??!0),edgeThreshold:xe(e.edgeThreshold??80,0,255),edgeDilate:xe(e.edgeDilate??2,0,6),maxRegionPx:xe(e.maxRegionPx??2e5,1e3,1e7)}}function Bn(e,t,i){const{data:n,width:o,height:a}=e,s=new Uint8Array(o*a);for(let l=0,p=0;l<s.length;l++,p+=4){const r=n[p+0],g=n[p+1],f=n[p+2];if(n[p+3]===0){s[l]=0;continue}const u=$n(r,g,f),d=t?u<=i:u>=255-i;s[l]=d?1:0}return s}function Vn(e,t,i,n){if(n<=0)return e;let o=e;for(let a=0;a<n;a++){const s=new Uint8Array(t*i);for(let l=0;l<i;l++)for(let p=0;p<t;p++){const r=l*t+p;if(o[r]){s[r]=1;continue}let g=0;for(let f=-1;f<=1&&!g;f++){const m=l+f;if(!(m<0||m>=i))for(let u=-1;u<=1;u++){const d=p+u;if(!(d<0||d>=t)&&o[m*t+d]){g=1;break}}}s[r]=g}o=s}return o}function Un(e,t,i,n,o,a){const s=t*n+e;if(i[s])return{ok:!1,message:"Click is on an edge; pick inside a region."};const l=new Uint8Array(n*o),p=new Int32Array(n*o),r=new Int32Array(n*o);let g=0,f=0;p[f]=e,r[f]=t,f++,l[s]=1;let m=1;for(;g<f;){const u=p[g],d=r[g];g++;const h=[[u-1,d],[u+1,d],[u,d-1],[u,d+1]];for(const[v,b]of h){if(v<0||v>=n||b<0||b>=o)continue;const y=b*n+v;if(!l[y]&&!i[y]&&(l[y]=1,p[f]=v,r[f]=b,f++,m++,m>a))return{ok:!1,message:`Region too large (>${a}px). Increase Max region or fix gaps.`}}}return{ok:!0,mask:l}}function Nn(e,t,i,n){const o=new Uint8Array(i*n);for(let a=1;a<n-1;a++)for(let s=1;s<i-1;s++){const l=a*i+s;if(!e[l])continue;const p=(a-1)*i+s,r=(a+1)*i+s,g=a*i+(s-1),f=a*i+(s+1);(!e[p]||!e[r]||!e[g]||!e[f]||t[p]||t[r]||t[g]||t[f])&&(o[l]=1)}return o}function zn(e,t,i,n){const o=It(n),a=e.width,s=e.height;let l=Bn(e,o.edgesDark,o.edgeThreshold);l=Vn(l,a,s,o.edgeDilate);const p=Un(t,i,l,a,s,o.maxRegionPx);if(!p.ok)return{ok:!1,message:p.message};const r=Nn(p.mask,l,a,s);return{ok:!0,preview:{mask:p.mask,outline:r,w:a,h:s}}}function Fn(e,t,i){const n=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),o=i.replace("#",""),a=parseInt(o.slice(0,2),16),s=parseInt(o.slice(2,4),16),l=parseInt(o.slice(4,6),16),p=n.data;for(let r=0,g=0;r<t.mask.length;r++,g+=4)t.mask[r]&&(p[g+0]=a,p[g+1]=s,p[g+2]=l);return n}function Pe(e,t,i){return Number.isFinite(e)?Math.max(t,Math.min(i,Math.trunc(e))):t}function Je(e){const t=(e||"").trim();if(!t)return null;const i=t.startsWith("#")?t:`#${t}`;return/^#[0-9a-fA-F]{6}$/.test(i)?i.toLowerCase():null}function jn(e){let t="#ff3b30",i=[],n=null;function o(h){e.colorsStatusEl.textContent=h||""}function a(){const h=!!e.edgesDarkEl.checked,v=Pe(parseInt(e.edgeMaskThresholdEl.value,10),0,255),b=Pe(parseInt(e.edgeDilateEl.value,10),0,6),y=Pe(parseInt(e.maxRegionPxEl.value,10),1e3,1e7);return e.edgeMaskThresholdEl.value=String(v),e.edgeDilateEl.value=String(b),e.maxRegionPxEl.value=String(y),It({edgesDark:h,edgeThreshold:v,edgeDilate:b,maxRegionPx:y})}function s(h){const v=Je(h);if(v){t=v;for(const b of Array.from(e.paletteEl.querySelectorAll(".paletteItem"))){const y=b.dataset.hex||"";b.classList.toggle("is-selected",y===t)}}}function l(){return t}function p(h){i=h.slice(),e.paletteEl.innerHTML="";for(const v of i){const b=Je(v);if(!b)continue;const y=document.createElement("button");y.type="button",y.className="paletteItem",y.style.background=b,y.dataset.hex=b,y.setAttribute("role","listitem"),y.setAttribute("aria-label",`Select ${b}`),y.addEventListener("click",()=>{s(b)}),e.paletteEl.appendChild(y)}s(t)}function r(h){const v=e.colorsCanvasEl;v.width=h.width,v.height=h.height,v.getContext("2d").putImageData(h,0,0)}function g(h,v){r(h);const b=e.colorsCanvasEl.getContext("2d"),{outline:y,w:I,h:M}=v,D=b.getImageData(0,0,I,M),U=D.data;for(let F=0,B=0;F<y.length;F++,B+=4)y[F]&&(U[B+0]=255,U[B+1]=60,U[B+2]=60,U[B+3]=220);b.putImageData(D,0,0)}function f(h){e.btnColorsApplyEl.disabled=!h}function m(h){e.btnColorsCancelEl.disabled=!h}function u(h){n=h}function d(){o("Idle"),f(!1),m(!1),e.colorsCanvasEl.addEventListener("click",h=>{if(!n)return;const v=e.colorsCanvasEl.getBoundingClientRect(),b=Math.floor((h.clientX-v.left)/v.width*e.colorsCanvasEl.width),y=Math.floor((h.clientY-v.top)/v.height*e.colorsCanvasEl.height);n(b,y)})}return{bind:d,setStatus:o,getSettings:a,setSelectedColor:s,getSelectedColor:l,renderPalette:p,drawBase:r,drawPreview:g,setApplyEnabled:f,setCancelEnabled:m,onCanvasClick:u}}let St={type:"none"};function ae(e){St=e}function qe(){return St}function Ae(e){var s,l,p,r,g;if(!e){ae({type:"none"});return}const t=(s=e.outputSvg)==null?void 0:s.svg;if(typeof t=="string"&&t.length>0){ae({type:"svg",svg:t});return}const i=(l=e.outputImage)==null?void 0:l.data;if(i){ae({type:"image",image:i});return}const n=(p=e.outputMask)==null?void 0:p.data,o=(r=e.outputMask)==null?void 0:r.width,a=(g=e.outputMask)==null?void 0:g.height;if(n&&typeof o=="number"&&typeof a=="number"){ae({type:"mask",mask:n,width:o,height:a});return}ae({type:"none"})}const _n=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#a2845e","#8e8e93","#1c1c1e","#ffffff","#000000","#4cd964","#5ac8fa","#ff6b6b","#7aa2ff","#f5a623","#50e3c2"];function Kn(e,t){const i=jn(e);let n=null,o=null;function a(u){i.setStatus(u)}function s(u,d,h){const v=new ImageData(d,h),b=v.data;for(let y=0,I=0;y<u.length;y++,I+=4){const D=(u[y]??0)>0?0:255;b[I+0]=D,b[I+1]=D,b[I+2]=D,b[I+3]=255}return v}function l(){const u=qe();return u.type==="image"?u.image:u.type==="mask"?s(u.mask,u.width,u.height):null}function p(){return qe().type==="svg"?"Pipeline output is SVG. Colors needs an image or mask output.":"No pipeline output available. Run the Pipeline first."}function r(){const u=l();if(!u){n=null,o=null,i.setApplyEnabled(!1),i.setCancelEnabled(!1),a(p());return}n=u,o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Ready. Pick a color, click inside a region.")}function g(){if(n){i.drawBase(n);return}const u=l();if(!u){a(p());return}n=u,o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Loaded pipeline output. Pick a color, click inside a region.")}function f(){if(!n||!o)return;const u=i.getSelectedColor();n=Fn(n,o,u),o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Fill applied. Click another region.")}function m(){n&&(o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Preview canceled."))}return{bind(){i.bind(),i.renderPalette(_n),i.onCanvasClick((u,d)=>{if(!n){a(p());return}const h=i.getSettings(),v=zn(n,u,d,h);if(!v.ok){o=null,i.setApplyEnabled(!1),i.setCancelEnabled(!1),a(v.message);return}o=v.preview,i.drawPreview(n,o),i.setApplyEnabled(!0),i.setCancelEnabled(!0),a("Preview shown. Apply fill or cancel.")}),e.btnColorsApplyEl.addEventListener("click",()=>f()),e.btnColorsCancelEl.addEventListener("click",()=>m()),e.btnColorsResetEl.addEventListener("click",()=>r()),e.tabColors.addEventListener("click",()=>{queueMicrotask(()=>g())}),a("Idle"),i.setApplyEnabled(!1),i.setCancelEnabled(!1)}}}const Ye="0.1.4";function Me(e){return`[BCT][${e}]`}function Gn(e){function t(...a){e.traceOn()&&console.log(Me("trace"),...a)}function i(...a){console.warn(Me("warn"),...a)}function n(...a){console.error(Me("error"),...a)}function o(a,s){t(a,s),Y({scope:e.scope,kind:"debug",message:a,meta:s})}return{logTrace:t,logWarn:i,logError:n,traceScope:o}}const{logTrace:R,logWarn:me,logError:X,traceScope:xt}=Gn({scope:"panel",traceOn:()=>!!we().traceConsole});let _=0;function K(){return _>0}function q(e,t){if(t){Pt(e);return}_=0,Ie(e,!1)}async function Hn(e,t){const i=`${Date.now()}-${Math.random().toString(16).slice(2)}`;R("[state] withBusy: enter",{id:i,busyCount:_}),Pt(e,i);try{R("[state] withBusy: before await fn",{id:i,busyCount:_});const n=await t();return R("[state] withBusy: after await fn (resolved)",{id:i,busyCount:_}),n}catch(n){throw X("[state] withBusy: fn threw",{id:i,busyCount:_,msg:String((n==null?void 0:n.message)??n),stack:String((n==null?void 0:n.stack)??"")}),n}finally{R("[state] withBusy: finally before endBusy",{id:i,busyCount:_}),Wn(e,i),R("[state] withBusy: finally after endBusy",{id:i,busyCount:_})}}function Pt(e,t){_++,R("[state] beginBusy",{id:t,busyCount:_}),_===1&&Ie(e,!0)}function Wn(e,t){if(_--,R("[state] endBusy: dec",{id:t,busyCount:_}),_<=0){_=0,R("[state] endBusy: applying busy=false",{id:t,busyCount:_}),Ie(e,!1);return}_===0&&(R("[state] endBusy: applying busy=false (redundant branch)",{id:t,busyCount:_}),Ie(e,!1))}function Ie(e,t){e.rootEl.classList.toggle("is-busy",t),e.cfgShowDevToolsEl.disabled=!1,e.fileInputEl.disabled=t,e.cfgTraceConsoleEl.disabled=t,e.cfgActionLogMaxEl.disabled=t,e.cfgDebugTraceMaxEl.disabled=t,e.cfgFailureLogsPerRunEl.disabled=t,e.btnCfgResetDefaults.disabled=t,e.logsCbDebugEl.disabled=t,e.cfgUseOpenCvEl.disabled=t,e.logsLimitEl.disabled=t,e.btnLogsRefresh.disabled=t,e.logsTrimKeepEl.disabled=t,e.btnLogsTrim.disabled=t,e.btnLogsExport.disabled=t,e.btnLogsClear.disabled=t,e.debugLimitEl.disabled=t,e.btnDebugRefresh.disabled=t,e.btnDebugExport.disabled=t,e.btnDebugClear.disabled=t,e.btnColorsApplyEl.disabled=t,e.btnColorsCancelEl.disabled=t,e.btnColorsResetEl.disabled=t,e.edgesDarkEl.disabled=t,e.edgeMaskThresholdEl.disabled=t,e.edgeDilateEl.disabled=t,e.maxRegionPxEl.disabled=t;for(const i of Array.from(e.paletteEl.querySelectorAll("button")))i.disabled=t;e.colorsCanvasEl.style.pointerEvents=t?"none":"auto"}const Ge={native:{available:!0},opencv:{available:!1,reason:"OpenCV not loaded"}};function Jn(e){Ge[e]={available:!0}}function qn(e,t){Ge[e]={available:!1,reason:t}}function Q(){return Ge.opencv.available===!0}async function Yn(e){const t=new URL(e.opencvJsRel,document.baseURI).toString(),i=new URL(e.opencvWasmRel,document.baseURI).toString(),n=globalThis;n.Module=n.Module||{},n.Module.locateFile=o=>o.endsWith(".wasm")?i:o,n.Module.print=()=>{},n.Module.printErr=()=>{},n.cv||await Zn(t),await Xn(e.timeoutMs)}function Zn(e){return new Promise((t,i)=>{const n=document.createElement("script");n.src=e,n.async=!0;const o=15e3,a=window.setTimeout(()=>{s(),i(new Error(`OpenCV script load timeout after ${o}ms: ${e}`))},o);function s(){window.clearTimeout(a),n.onload=null,n.onerror=null}n.onload=()=>{s(),t()},n.onerror=()=>{s(),i(new Error(`Failed to load OpenCV script: ${e}`))},document.head.appendChild(n)})}async function Xn(e){var n;const t=Date.now(),i=globalThis;for(;Date.now()-t<e;){try{if(i.cv&&typeof i.cv.Mat=="function"){const o=new i.cv.Mat;(n=o.delete)==null||n.call(o);return}}catch{}await new Promise(o=>setTimeout(o,75))}throw new Error(`OpenCV initialization timeout after ${e}ms`)}async function Qn(){try{await Yn({opencvJsRel:"../assets/opencv/opencv.js",opencvWasmRel:"../assets/opencv/opencv.wasm",timeoutMs:2e4}),Jn("opencv")}catch(e){throw qn("opencv",e!=null&&e.message?String(e.message):String(e)),e}}function N(e,t,i,n,o,a,s){return{id:e,title:t,implementedEngines:i,defaultEnginePolicy:n,params:o,children:a,description:s}}function ei(e){const t=new Map,i=new Map;function n(o,a){if(t.has(o.id))throw new Error(`[tuning] Duplicate component id: ${o.id}`);t.set(o.id,o),i.set(o.id,a);for(const s of o.children??[])n(s,o.id)}return n(e,null),{root:e,byId:t,parentById:i}}function At(){const e=N("app","BeeMage",["native","opencv"],"native",{},[N("edge","Edge",["native","opencv"],"auto",{},[N("edge.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),N("edge.threshold","Threshold",["native","opencv"],"auto",{manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128}},void 0,"Convert image into a binary mask before edge extraction."),N("edge.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:3},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Clean the mask before extracting edges."),N("edge.extract","Edge extract",["native","opencv"],"auto",{},void 0,"Extract a 1px outline from the cleaned mask.")],"Fixed-order edge pipeline (image -> mask -> edges). Presets configure each step."),N("svg","SVG",["native","opencv"],"auto",{},[N("svg.create","Create SVG",["native","opencv"],"auto",{scale:{kind:"number",label:"Scale",min:1,max:10,step:1,default:1},transparentBg:{kind:"number",label:"Transparent bg (0/1)",min:0,max:1,step:1,default:1},color:{kind:"text",label:"Color",default:"#3bca1e"}},void 0,"Convert the edge mask into an SVG.")],"SVG generation parameters."),N("segmentation","Segmentation",["native","opencv"],"auto",{},[N("segmentation.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),N("segmentation.denoise","Denoise",["native","opencv"],"auto",{denoiseAlgo:{kind:"number",label:"Denoise algo",min:0,max:2,step:1,default:1},blurK:{kind:"number",label:"Blur kernel",min:1,max:21,step:2,default:3},bilateralSigma:{kind:"number",label:"Bilateral sigma",min:1,max:150,step:1,default:35}},void 0,"Reduce noise before thresholding."),N("segmentation.color","Color / Gray",["native","opencv"],"auto",{colorMode:{kind:"number",label:"Color mode",min:0,max:3,step:1,default:1},hsvChannel:{kind:"number",label:"HSV channel",min:0,max:2,step:1,default:2}},void 0,"Select color space / channel features for thresholding."),N("segmentation.threshold","Threshold",["native","opencv"],"auto",{thresholdAlgo:{kind:"number",label:"Threshold algo",min:0,max:3,step:1,default:1},manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128},adaptBlock:{kind:"number",label:"Adaptive block",min:3,max:101,step:2,default:31},adaptC:{kind:"number",label:"Adaptive C",min:-50,max:50,step:1,default:3}},void 0,"Convert features into a binary mask."),N("segmentation.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:5},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Remove specks, fill holes, and stabilize regions.")],"Fixed-order segmentation pipeline. Presets configure each step."),N("image","iMage",["native","opencv"],"auto",{},[N("mage.process","Process",["native"],"auto",{imageScale:{kind:"number",label:"Processing scale",min:25,max:100,step:5,default:100},edgeThreshold:{kind:"number",label:"Edge threshold",min:1,max:255,step:1,default:70},invertOutput:{kind:"boolean",label:"White background",default:!0}}),N("mage.clean","Clean & Smooth",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:500,step:1,default:12},cleanRadius:{kind:"number",label:"Repair strength",min:1,max:3,step:1,default:1},cleanBinaryThreshold:{kind:"number",label:"Binary threshold",min:1,max:254,step:1,default:128}},[N("mage.clean.threshold","Threshold",["native"],"auto",{}),N("mage.clean.removeSmallComponents","Remove small components",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:5e3,step:1,default:12}},void 0,"Remove connected components smaller than the minimum area."),N("mage.clean.repair","Repair gaps",["native"],"auto",{}),N("mage.clean.smooth","Smooth mask",["native"],"auto",{}),N("mage.clean.quality","Quality metrics",["native"],"auto",{})]),N("mage.vectorize","Vectorize (SVG)",["native"],"native",{pathSmoothIters:{kind:"number",label:"Path smoothing",min:0,max:4,step:1,default:2}})]),N("colors","Colors",["native"],"auto",{},[N("colors.fill","Region fill",["native"],"auto",{edgesDark:{kind:"boolean",label:"Edges are dark",default:!0},edgeMaskThreshold:{kind:"number",label:"Edge threshold",min:0,max:255,step:1,default:80},edgeDilate:{kind:"number",label:"Gap close (px)",min:0,max:6,step:1,default:2},maxRegionPx:{kind:"number",label:"Max region (px)",min:1e3,step:1e3,default:2e5}})]),N("pipeline","Pipeline (UI)",["native","opencv"],"auto",{mode:{kind:"text",label:"Pipeline",default:"segmentation"},recipe:{kind:"text",label:"Recipe",default:"default"}},void 0,"UI state for the Pipeline tab (selected pipeline + recipe).")]);return ei(e)}function ti(e){return e.default}function ni(e,t){const i={};for(const[n,o]of Object.entries(e))i[n]=ti(o);for(const[n,o]of Object.entries(t??{}))i[n]=o;return i}function ii(e,t,i){var o;let n=e;for(;n;){const a=t.byId.get(n);if(!a)throw new Error(`[tuning] Unknown component: ${n}`);const l=((o=i[n])==null?void 0:o.enginePolicy)??a.defaultEnginePolicy;if(l!=="inherit")return l;n=t.parentById.get(n)??null}return"native"}function oi(e,t,i){const n=i.opencvReady&&e.includes("opencv");return e.includes("native")||e.length,t==="native"?{engine:"native"}:t==="opencv"?n?{engine:"opencv"}:{engine:"native",fallbackReason:i.opencvReady?"Policy=opencv, but component has no OpenCV implementation.":"Policy=opencv, but OpenCV is not available at runtime."}:t==="auto"?n?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}function Mt(e,t,i,n){var r;const o=t.byId.get(e);if(!o)throw new Error(`[tuning] Unknown component: ${e}`);const a=ii(e,t,i),{engine:s,fallbackReason:l}=oi(o.implementedEngines,a,n),p=ni(o.params,(r=i[e])==null?void 0:r.params);return{id:e,policy:a,engine:s,fallbackReason:l,params:p}}const Ne="beemage.tuning.components.v1";async function ce(){const e=await te([Ne]).catch(()=>({})),t=e==null?void 0:e[Ne];return!t||typeof t!="object"?{}:t}async function Dt(e){await ne({[Ne]:e}).catch(()=>null)}async function De(e,t){const i=await ce(),n=i[e]??{};i[e]={enginePolicy:t.enginePolicy??n.enginePolicy,params:{...n.params??{},...t.params??{}}},await Dt(i)}async function Ze(e){const t=await ce();delete t[e],await Dt(t)}function ai(){return{opencvReady:Q()}}function si(e){return Array.isArray(e.children)&&e.children.length>0}function Tt(e){const{id:t,registry:i,stored:n,runtime:o}=e,a=i.byId.get(t);if(!a)throw new Error(`[tuning] Unknown component: ${t}`);const s=Mt(t,i,n,o),l=n[t],p=l==null?void 0:l.enginePolicy,r=l==null?void 0:l.params,g=a.implementedEngines.includes("opencv"),f=!!o.opencvReady,m=[];for(const u of a.children??[])m.push(Tt({id:u.id,registry:i,stored:n,runtime:o}));return{id:a.id,title:a.title,description:a.description,isGroup:si(a),implementedEngines:a.implementedEngines,storedPolicy:p,storedParams:r,effectivePolicy:s.policy,effectiveEngine:s.engine,fallbackReason:s.fallbackReason,paramsSchema:a.params,effectiveParams:s.params,canImplementOpenCv:g,runtimeOpenCvReady:f,children:m}}function Rt(e={}){const t=e.registry??At(),i=e.getRuntimeAvailability??ai;async function n(p="app"){const r=await ce(),g=i();if(!t.byId.get(p))throw new Error(`[tuning] Unknown scope: ${p}`);const m=Tt({id:p,registry:t,stored:r,runtime:g});return{scopeId:p,runtime:g,stored:r,root:m}}async function o(p,r){await De(p,{enginePolicy:r})}async function a(p,r,g){await De(p,{params:{[r]:g}})}async function s(p){await Ze(p)}async function l(p,r){const f=(await ce())[p];if(!(f!=null&&f.params))return;const m={...f.params??{}};delete m[r];const u=typeof f.enginePolicy=="string",d=Object.keys(m).length>0;if(!u&&!d){await Ze(p);return}await De(p,{enginePolicy:f.enginePolicy,params:m})}return{getRegistry:()=>t,loadTree:n,setEnginePolicy:o,setParam:a,resetNode:s,resetParam:l}}function $(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function Xe(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function ri(e){return e.fallbackReason?`${e.effectiveEngine} (fallback)`:e.effectiveEngine}function li(e){const t=[{value:"native",label:"Native"},{value:"auto",label:"Auto"},...e.canImplementOpenCv?[{value:"opencv",label:"OpenCV"}]:[]];return e.isRoot?t:[{value:"inherit",label:"Inherit"},...t]}function ci(e){return!1}function ui(e,t,i){var o;const n=(o=e.storedParams)==null?void 0:o[t];return typeof n<"u"&&n!==i}function di(e){var f;const{node:t,compId:i,key:n,schema:o,value:a,handlers:s}=e,l=$("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),p=$("label",{class:"fieldInline"}),r=$("span",void 0,o.label);p.appendChild(r);let g;if(o.kind==="number"?(g=$("input"),g.type="number",typeof o.min=="number"&&(g.min=String(o.min)),typeof o.max=="number"&&(g.max=String(o.max)),typeof o.step=="number"&&(g.step=String(o.step)),g.value=String(a??o.default),g.addEventListener("change",()=>{const m=Number(g.value);s.onSetParam(i,n,Number.isFinite(m)?m:o.default)})):o.kind==="boolean"?(g=$("input"),g.type="checkbox",g.checked=!!a,g.addEventListener("change",()=>{s.onSetParam(i,n,!!g.checked)})):(g=$("input"),g.type="text",g.value=String(a??o.default),g.addEventListener("change",()=>{s.onSetParam(i,n,String(g.value??o.default))})),p.appendChild(g),l.appendChild(p),s.onResetParam&&typeof((f=t.storedParams)==null?void 0:f[n])<"u"){const m=$("button",{type:"button"},"Reset");m.addEventListener("click",u=>{var d;u.preventDefault(),(d=s.onResetParam)==null||d.call(s,i,n)}),l.appendChild(m)}return ui(t,n,a)&&l.appendChild($("span",{class:"muted",style:"font-size:12px;"},"override")),l}function Lt(e){const{node:t,depth:i,isRoot:n,handlers:o,treeScopeId:a}=e,s=$("div",{style:`margin-left:${Math.min(i*14,56)}px; margin-top:10px;`}),l=$("div",{style:"border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:10px; background:rgba(0,0,0,0.12);"}),p=$("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),r=$("div");r.appendChild($("div",{style:"font-weight:700;"},t.title)),t.description&&r.appendChild($("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},t.description)),t.isGroup&&r.appendChild($("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},"Group (policy affects children)")),p.appendChild(r);const g=$("div",{class:"row",style:"align-items:center; gap:10px;"});g.appendChild($("span",{class:"qBadge"},ri(t)));const f=$("select");f.style.background="rgba(255,255,255,0.05)",f.style.border="1px solid rgba(255,255,255,0.08)",f.style.color="rgba(255,255,255,0.92)",f.style.borderRadius="10px",f.style.padding="6px 8px";const m=li({isRoot:n,canImplementOpenCv:t.canImplementOpenCv});for(const I of m){const M=$("option");M.value=I.value,M.textContent=I.label,f.appendChild(M)}const u=new Set(m.map(I=>I.value)),d=t.effectivePolicy;u.has(d)?f.value=d:f.value=n?"native":"inherit",f.addEventListener("change",()=>{o.onSetPolicy(t.id,f.value)}),g.appendChild(f);const h=typeof t.storedPolicy<"u"||t.storedParams&&Object.keys(t.storedParams).length>0;if(o.onResetNode&&h){const I=$("button",{type:"button"},"Reset node");I.addEventListener("click",M=>{var D;M.preventDefault(),(D=o.onResetNode)==null||D.call(o,t.id)}),g.appendChild(I)}p.appendChild(g),l.appendChild(p),t.fallbackReason?l.appendChild($("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},t.fallbackReason)):t.effectivePolicy==="opencv"&&!t.runtimeOpenCvReady&&l.appendChild($("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},"OpenCV policy selected, but OpenCV is not available at runtime. It will fall back to native."));const v=Object.keys(t.paramsSchema??{}),b=v.length>0,y=t.children.length>0;if(b||y){const I=$("details",{style:"margin-top:10px;"});I.open=ci();const M=$("summary",{style:"cursor:pointer; user-select:none;"},"Details");if(I.appendChild(M),b){const D=$("div",{style:"margin-top:10px;"});D.appendChild($("div",{class:"muted",style:"font-weight:600; margin-bottom:6px;"},"Parameters"));for(const U of v){const F=t.paramsSchema[U],B=t.effectiveParams[U];D.appendChild(di({node:t,compId:t.id,key:U,schema:F,value:B,handlers:o}))}I.appendChild(D)}if(y){const D=$("div",{style:"margin-top:10px;"});for(const U of t.children)D.appendChild(Lt({node:U,depth:i+1,isRoot:!1,handlers:o,treeScopeId:a}));I.appendChild(D)}l.appendChild(I)}return s.appendChild(l),s}function Ot(e,t){let i=!1;function n(a){if(i)return;Xe(e);const s=a.scopeId==="app",l=$("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"});l.appendChild($("div",{style:"font-weight:700;"},"Tuning")),l.appendChild($("div",{class:"muted",style:"font-size:12px;"},`OpenCV runtime: ${a.runtime.opencvReady?"ready":"not available"}`)),e.appendChild(l),e.appendChild(Lt({node:a.root,depth:0,isRoot:s,handlers:t,treeScopeId:a.scopeId}))}function o(){i=!0,Xe(e)}return{render:n,dispose:o}}function gi(){let e=!1,t={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},i=!1,n="",o="";function a(r){e=r}function s(r){t={...t,...r}}function l(r){i=r}function p(r){typeof r.general=="string"&&(n=r.general),typeof r.dev=="string"&&(o=r.dev)}return{get showDevTools(){return e},get dev(){return t},get debugEnabled(){return i},get generalStatus(){return n},get devStatus(){return o},setShowDevTools:a,setDev:s,setDebugEnabled:l,setStatus:p}}function pi(e){function t(r){e.settingsGeneralStatusEl.textContent=r||""}function i(r){e.cfgStatusEl.textContent=r||""}function n(r){e.cfgShowDevToolsEl.checked=r}function o(r){e.tabLogs.hidden=!r,e.devConfigDetailsEl.classList.toggle("is-hidden",!r),r||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function a(r){e.cfgTraceConsoleEl.checked=!!r.traceConsole,e.cfgActionLogMaxEl.value=String(r.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(r.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(r.failureLogsPerRun??50)}function s(r){e.logsCbDebugEl.checked=r}function l(r,g){e.settingsVersionEl.textContent=r||"—",e.settingsGitHubLinkEl.href=g||"#",e.settingsGitHubLinkEl.hidden=!g}function p(r){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=r,e.cfgActionLogMaxEl.disabled=r,e.cfgDebugTraceMaxEl.disabled=r,e.cfgFailureLogsPerRunEl.disabled=r,e.btnCfgResetDefaults.disabled=r,e.logsCbDebugEl.disabled=r,e.cfgUseOpenCvEl.disabled=r}return{setGeneralStatus:t,setDevStatus:i,setShowDevToolsChecked:n,setDevToolsVisible:o,setDevConfig:a,setDebugEnabledChecked:s,setAbout:l,setBusy:p}}const Te="template.settings.showDevTools",Re="beemage.settings.engine.useOpenCv";function fi(){var e,t;try{const i=(e=globalThis==null?void 0:globalThis.chrome)==null?void 0:e.runtime,n=(t=i==null?void 0:i.getManifest)==null?void 0:t.call(i),o=typeof(n==null?void 0:n.version)=="string"?n.version:"";if(R("Settings: getManifestVersion manifest found version is ",{v:o}),o)return o}catch{}return R("Settings: getManifestVersion fallback",{APP_VERSION:Ye}),Ye}function Le(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??G.actionLogMax),debugTraceMax:Number(e.debugTraceMax??G.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??G.failureLogsPerRun)}}function hi(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:Z(e.cfgActionLogMaxEl.value,100,5e4,G.actionLogMax),debugTraceMax:Z(e.cfgDebugTraceMaxEl.value,100,5e4,G.debugTraceMax),failureLogsPerRun:Z(e.cfgFailureLogsPerRunEl.value,0,5e4,G.failureLogsPerRun)}}async function Qe(e){const t=kt;return typeof t.setEnabled=="function"?(await t.setEnabled(e),{ok:!0}):typeof t.enable=="function"&&typeof t.disable=="function"?(await(e?t.enable():t.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function mi(e,t){const i=gi(),n=pi(e),o=Rt({getRuntimeAvailability:()=>({opencvReady:e.cfgUseOpenCvEl.checked&&Q()})}),a=Ot(e.tuningMountEl,{onSetPolicy:async(c,w)=>{await o.setEnginePolicy(c,w),await y("policy change")},onSetParam:async(c,w,S)=>{await o.setParam(c,w,S),await y("param change")},onResetNode:async c=>{await o.resetNode(c),await y("reset node")},onResetParam:async(c,w)=>{await o.resetParam(c,w),await y("reset param")}});function s(c){e.settingsEngineBoxEl.classList.toggle("is-hidden",!1)}async function l(){const c=await te([Re]).catch(()=>({}));return(c==null?void 0:c[Re])===!0}async function p(c){await ne({[Re]:!!c}).catch(()=>null)}function r(c){var w;e.cfgUseOpenCvEl.checked=c,(w=e.cfgUseOpenCvEl.closest(".switch"))==null||w.classList.toggle("is-disabled",e.cfgUseOpenCvEl.disabled)}function g(c){e.cfgOpenCvSpinner.classList.toggle("is-hidden",!c),e.cfgOpenCvSpinner.setAttribute("aria-hidden",c?"false":"true")}function f(c){e.cfgOpenCvStatus.textContent=c||""}function m(c){e.cfgOpenCvReport.textContent=c||""}async function u(){if(K())return;if(!!!e.cfgUseOpenCvEl.checked){await p(!1),g(!1),f(Q()?"OpenCV loaded (native mode)":"Native mode"),m("Native mode. OpenCV is optional and demo-only."),await y("opencv mode disabled");return}g(!0),f("Loading OpenCV…"),m("Loading OpenCV…");try{if(await Hn(e,async()=>{await Qn()}),!Q())throw new Error("OpenCV load returned but runtime is not injected.");await p(!0),f("OpenCV mode enabled"),m("OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV."),await y("opencv mode enabled")}catch(w){const S=String((w==null?void 0:w.message)??w);await p(!1),r(!1),f("OpenCV load failed"),m(`ERROR

${S}`),X("[settings] OpenCV toggle failed",{msg:S})}finally{g(!1)}}async function d(){const c=await te([Te]).catch(()=>({}));return(c==null?void 0:c[Te])===!0}async function h(c){await ne({[Te]:!!c}).catch(()=>null)}function v(c){i.setShowDevTools(c),n.setShowDevToolsChecked(c),n.setDevToolsVisible(c)}async function b(){const c=await d();v(c),R("Settings: boot applyDevToolsVisibility",{showDevTools:c})}async function y(c){try{const w=await o.loadTree("app");a.render(w),R("[settings] tuning rendered",{reason:c,opencvInjected:Q(),opencvMode:!!e.cfgUseOpenCvEl.checked})}catch(w){X("[settings] tuning render failed",{reason:c,msg:String((w==null?void 0:w.message)??w)}),e.tuningMountEl.textContent="Tuning UI failed to load (see console)."}}async function I(){var C;n.setBusy(K());const c=await d();v(c),await Be().catch(()=>null);const w=we();i.setDev(Le(w)),n.setDevConfig(i.dev);const S=kt;let P=!1;try{typeof S.isEnabled=="function"?P=!!await S.isEnabled():P=!!S.enabled}catch(E){me("Settings: failed to read debug enabled state",{error:E instanceof Error?E.message:String(E)})}i.setDebugEnabled(P),n.setDebugEnabledChecked(P),n.setAbout(fi()||"—",((C=e.settingsGitHubLinkEl)==null?void 0:C.href)||"#"),s();{const E=await l();r(E),g(!1);const k=Q();E?(f(k?"OpenCV mode enabled":"OpenCV mode (not loaded)"),m(k?"OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV.":"OpenCV mode is enabled, but OpenCV is not loaded yet. Toggle OFF then ON to load OpenCV.")):(f(k?"OpenCV loaded (native mode)":"Native mode"),m("Native mode. OpenCV is optional and demo-only."))}n.setGeneralStatus(""),n.setDevStatus(""),await y("loadAll"),R("Settings: loaded",{showDevTools:c,debugTraceEnabled:P,dev:i.dev,opencvInjected:Q()})}async function M(){const c=!!e.cfgShowDevToolsEl.checked;v(c),await h(c),V({kind:"run",scope:"settings",message:c?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:c}}),R("Settings: ui toggle showDevTools",{showDevTools:c}),n.setGeneralStatus(c?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>n.setGeneralStatus(""),1200)}async function D(){const c=hi(e);n.setDevStatus("Saving…");try{await bt(c)}catch(w){X("Settings: failed to save dev config",{error:w instanceof Error?w.message:String(w),next:c}),n.setDevStatus("Save failed."),setTimeout(()=>n.setDevStatus(""),1200);return}i.setDev(Le(c)),n.setDevConfig(i.dev),V({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:c}),R("Settings: devConfig updated",c),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}async function U(){n.setDevStatus("Resetting…");try{await vn(),await Be().catch(()=>null);const w=we();i.setDev(Le(w)),n.setDevConfig(i.dev)}catch(w){X("Settings: failed to reset dev config defaults",{error:w instanceof Error?w.message:String(w)}),n.setDevStatus("Reset failed."),setTimeout(()=>n.setDevStatus(""),1200);return}const c=await Qe(!1);c.ok?(i.setDebugEnabled(!1),n.setDebugEnabledChecked(!1)):(me("Settings: failed to reset debug enabled state",{error:c.error||"unknown error"}),V({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:c.error||"unknown error"})),V({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...G,debugEnabled:!1}}),R("Settings: reset defaults",{...G,debugEnabled:!1}),n.setDevStatus("Reset."),setTimeout(()=>n.setDevStatus(""),1200)}async function F(){const c=!!e.logsCbDebugEl.checked;n.setDevStatus("Saving…");const w=await Qe(c);if(!w.ok){e.logsCbDebugEl.checked=!c,n.setDevStatus(`Save failed: ${w.error||"unknown error"}`),X("Settings: failed to change debug enabled state",{error:w.error||"unknown error",enabled:c}),V({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:w.error||"unknown error",meta:{enabled:c}});return}i.setDebugEnabled(c),V({kind:"run",scope:"settings",message:c?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:c}}),R("Settings: debug enabled changed",{enabled:c}),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}const B=t.on(()=>{});function O(){e.cfgShowDevToolsEl.addEventListener("change",()=>{M()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{K()||D()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{K()||D()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{K()||D()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{K()||D()}),e.btnCfgResetDefaults.addEventListener("click",()=>{K()||U()}),e.logsCbDebugEl.addEventListener("change",()=>{K()||F()}),e.cfgUseOpenCvEl.addEventListener("change",()=>{u()}),b().catch(c=>{me("Settings: initDevToolsVisibility failed",{error:c instanceof Error?c.message:String(c)})})}return{id:"settings",refresh(){I().catch(c=>{X("Settings: refresh failed",{error:c instanceof Error?c.message:String(c)})})},mount(){I().catch(c=>{X("Settings: mount failed",{error:c instanceof Error?c.message:String(c)})})},unmount(){},bind:O,dispose(){B()}}}function bi(){let e=[],t=0;function i(n){e=n.items,t=n.total}return{get items(){return e},get total(){return t},set:i}}function yi(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function et(e,t){const i=[];i.push(`Total entries: ${t.total}`),i.push("");for(const n of t.items){const o=typeof n.ok=="boolean"?n.ok?"ok":"fail":"",a=[];typeof n.status=="number"&&a.push(`status=${n.status}`),o&&a.push(o);const s=[n.scope,n.kind].filter(Boolean).join("/");i.push(`[${yi(n.ts)}] ${s}${a.length?` (${a.join(", ")})`:""}`),i.push(`  ${n.message}`),n.error&&i.push(`  error: ${n.error}`),i.push("")}e.textContent=i.join(`
`),e.scrollTop=0}function vi(e){function t(s){e.logsStatusEl.textContent=s}function i(s){e.debugStatusEl.textContent=s}function n(s){e.logsCbDebugEl.checked=s}function o(s){et(e.logsOutEl,{total:s.total,items:s.items.map(l=>({ts:l.ts,message:l.message,scope:l.scope,kind:l.kind,ok:l.ok,status:l.status,error:l.error,meta:l.meta}))})}function a(s){et(e.debugOutEl,{total:s.total,items:s.items.map(l=>({ts:l.ts,message:l.message,scope:l.scope,kind:l.kind,ok:l.ok,status:l.status,error:l.error,meta:l.meta}))})}return{setAuditStatus:t,setDebugStatus:i,setDebugChecked:n,renderAudit:o,renderDebug:a}}const tt="beemage";function wi(e,t){const i=bi(),n=vi(e);async function o(){n.setAuditStatus("Loading…"),q(e,!0);try{const d=Z(e.logsLimitEl.value,10,5e3,200),h=await Pn({limit:d,reverse:!0});i.set(h),n.renderAudit({items:i.items,total:i.total}),n.setAuditStatus(`Showing ${i.items.length} (newest first)`)}catch(d){n.setAuditStatus(`Failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{q(e,!1)}}async function a(){n.setDebugStatus("Loading…"),q(e,!0);try{const d=Z(e.debugLimitEl.value,10,5e3,200),h=await Et({limit:d,reverse:!0});n.renderDebug(h),n.setDebugStatus(`Showing ${h.items.length} (newest first)`)}catch(d){n.setDebugStatus(`Failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{q(e,!1)}}async function s(){const d=await Ke();n.setDebugChecked(d)}async function l(d){if(await vt(d),n.setDebugChecked(d),!d){n.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}n.setDebugStatus("Debug ON."),await a()}async function p(){const d=Z(e.logsTrimKeepEl.value,0,5e4,2e3);n.setAuditStatus("Trimming…"),q(e,!0);try{const h=await An({keepLast:d});await o(),n.setAuditStatus(`Trimmed. Remaining: ${h.total}`)}catch(h){n.setAuditStatus(`Trim failed: ${(h==null?void 0:h.message)||String(h)}`)}finally{q(e,!1)}}async function r(){n.setAuditStatus("Clearing…"),q(e,!0);try{await Mn(),await o(),n.setAuditStatus("Cleared.")}catch(d){n.setAuditStatus(`Clear failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{q(e,!1)}}async function g(){n.setAuditStatus("Exporting…");try{const d=await Dn({pretty:!0}),h=new Blob([d],{type:"application/json"}),v=URL.createObjectURL(h),b=document.createElement("a");b.href=v,b.download=`${tt}-audit-${Date.now()}.json`,b.click(),setTimeout(()=>URL.revokeObjectURL(v),1e3),n.setAuditStatus("Exported.")}catch(d){n.setAuditStatus(`Export failed: ${(d==null?void 0:d.message)||String(d)}`)}}async function f(){n.setDebugStatus("Clearing…"),q(e,!0);try{await wt(),await a(),n.setDebugStatus("Cleared.")}catch(d){n.setDebugStatus(`Clear failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{q(e,!1)}}async function m(){n.setDebugStatus("Exporting…");try{const d=await Ct({pretty:!0}),h=new Blob([d],{type:"application/json"}),v=URL.createObjectURL(h),b=document.createElement("a");b.href=v,b.download=`${tt}-debug-${Date.now()}.json`,b.click(),setTimeout(()=>URL.revokeObjectURL(v),1e3),n.setDebugStatus("Exported.")}catch(d){n.setDebugStatus(`Export failed: ${(d==null?void 0:d.message)||String(d)}`)}}function u(){e.btnLogsRefresh.addEventListener("click",()=>{K()||o()}),e.btnLogsTrim.addEventListener("click",()=>{K()||p()}),e.btnLogsClear.addEventListener("click",()=>{K()||r()}),e.btnLogsExport.addEventListener("click",()=>{K()||g()}),e.logsCbDebugEl.addEventListener("change",()=>{K()||l(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{K()||a()}),e.btnDebugClear.addEventListener("click",()=>{K()||f()}),e.btnDebugExport.addEventListener("click",()=>{K()||m()})}return{id:"logs",bind:u,mount(){s(),o(),a()},unmount(){},dispose(){}}}function Ei(e,t){if(e.id===t)return e;const i=[...e.children??[]];for(;i.length>0;){const n=i.shift();if(n.id===t)return n;for(const o of n.children??[])i.push(o)}throw new Error(`[tuning] scopeRootId not found in VM tree: ${t}`)}function Ci(e,t){if(e.id===t)return e;const i=[...e.children??[]];for(;i.length>0;){const n=i.shift();if(n.id===t)return n;for(const o of n.children??[])i.push(o)}return null}function ki(e){const t=Rt({getRuntimeAvailability:e.getRuntimeAvailability}),i=[];let n=!1;async function o(){return await t.loadTree("app")}async function a(){if(n)return;const b=await o();for(const y of i){if(y.scopeRootId==="app"){y.view.render(b);continue}const I=Ei(b.root,y.scopeRootId);y.view.render({...b,scopeId:y.scopeRootId,root:I})}}async function s(b,y){await t.setEnginePolicy(b,y),e.actionLogAppend(`[tuning] policy ${b} = ${y}`),e.debugTraceAppend(`[tuning] setPolicy id=${b} policy=${y}`),await a()}async function l(b,y,I){await t.setParam(b,y,I),e.actionLogAppend(`[tuning] param ${b}.${y} = ${String(I)}`),e.debugTraceAppend(`[tuning] setParam id=${b} key=${y} value=${String(I)}`),await a()}async function p(b){await t.resetNode(b),e.actionLogAppend(`[tuning] reset node ${b}`),e.debugTraceAppend(`[tuning] resetNode id=${b}`),await a()}async function r(b,y){await t.resetParam(b,y),e.actionLogAppend(`[tuning] reset param ${b}.${y}`),e.debugTraceAppend(`[tuning] resetParam id=${b} key=${y}`),await a()}async function g(b){var y,I;if(!n){if(b.policies)for(const M of b.policies)await t.setEnginePolicy(M.id,M.policy);if(b.params)for(const M of b.params)await t.setParam(M.id,M.key,M.value);e.actionLogAppend(`[tuning] preset ${b.id} (${b.title})`),e.debugTraceAppend(`[tuning] applyPreset id=${b.id} title=${b.title} policies=${((y=b.policies)==null?void 0:y.length)??0} params=${((I=b.params)==null?void 0:I.length)??0}`),await a()}}async function f(b){const y=await o(),I=Ci(y.root,b);if(!I)throw new Error(`[tuning] getEffectiveParams: unknown component id ${b}`);return{...I.effectiveParams??{}}}async function m(b,y,I){await t.setParam(b,y,I),e.actionLogAppend(`[tuning] param ${b}.${y} = ${String(I)}`),e.debugTraceAppend(`[tuning] setParamValue id=${b} key=${y} value=${String(I)}`),await a()}function u(b){if(n)return;const{mountEl:y,scopeRootId:I}=b;if(i.some(D=>D.mountEl===y))return;const M=Ot(y,{onSetPolicy:s,onSetParam:l,onResetNode:p,onResetParam:r});i.push({mountEl:y,scopeRootId:I,view:M}),a()}function d(b){const y=i.findIndex(I=>I.mountEl===b);y<0||(i[y].view.dispose(),i.splice(y,1))}async function h(){await a()}function v(){n=!0;for(const b of i)b.view.dispose();i.length=0}return{mount:u,unmount:d,refresh:h,applyPreset:g,getEffectiveParams:f,setParamValue:m,dispose:v}}function A(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function Ii(e){return e.type==="image"}function Si(e){return e.type==="mask"}function xi(e){return e.type==="svg"}function $t(e){return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(e)}`}function nt(e,t){if(Ii(e)){const n=A("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return be(n,e.image),n}if(Si(e)){const n=A("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return ze(n,e.mask,e.width,e.height),n}if(!xi(e))return A("div",{class:"muted",style:"margin-top:8px; font-size:12px;"},`Unsupported output: ${String(e.type)}`);const i=A("img",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`,"aria-label":"SVG preview"});return i.src=$t(e.svg),i}function Bt(e,t){const i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download=e,n.rel="noopener",n.click(),setTimeout(()=>URL.revokeObjectURL(i),500)}async function it(e,t){const i=await new Promise(n=>t.toBlob(o=>n(o),"image/png"));if(!i)throw new Error("Failed to create PNG blob.");Bt(e,i)}function be(e,t){e.width=t.width,e.height=t.height;const i=e.getContext("2d",{willReadFrequently:!0});i&&i.putImageData(t,0,0)}function ze(e,t,i,n){e.width=i,e.height=n;const o=e.getContext("2d",{willReadFrequently:!0});if(!o)return;let a=0;const s=i*n;for(let g=0;g<s;g++){const f=t[g]??0;f>a&&(a=f)}const l=a<=1,p=o.createImageData(i,n),r=p.data;for(let g=0;g<s;g++){const f=t[g]??0;let m;l?m=(f>0?1:0)?0:255:m=f;const u=g*4;r[u]=m,r[u+1]=m,r[u+2]=m,r[u+3]=255}o.putImageData(p,0,0)}function Pi(e){const{hostEl:t,statusEl:i,handlers:n}=e;let o=!1,a=null,s=null,l=null,p=null,r=null,g=null,f=null,m=null,u=null,d=null,h=null,v=null,b=null;function y(){for(;t.firstChild;)t.removeChild(t.firstChild)}async function I(c){var T,L,j,z,J;const S=(typeof(c==null?void 0:c.activePipelineId)=="string"?c.activePipelineId:"pipeline").replace(/[^a-z0-9_-]+/gi,"_").slice(0,40)||"pipeline",P=(T=c==null?void 0:c.outputSvg)==null?void 0:T.svg;if(typeof P=="string"&&P.length>0){const H=new Blob([P],{type:"image/svg+xml;charset=utf-8"});Bt(`beemage-${S}.svg`,H);return}const C=(L=c==null?void 0:c.outputImage)==null?void 0:L.data;if(C){const H=document.createElement("canvas");be(H,C),await it(`beemage-${S}.png`,H);return}const E=(j=c==null?void 0:c.outputMask)==null?void 0:j.data,k=(z=c==null?void 0:c.outputMask)==null?void 0:z.width,x=(J=c==null?void 0:c.outputMask)==null?void 0:J.height;if(E&&typeof k=="number"&&typeof x=="number"){const H=document.createElement("canvas");ze(H,E,k,x),await it(`beemage-${S}-mask.png`,H);return}throw new Error("No output to download.")}function M(){if(o)return;o=!0,y(),a=A("div",{class:"card"}),m=A("p",{class:"muted",style:"margin-top:0;"},"Universal pipeline runner. Select a pipeline and run it.");const c=A("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),w=A("label",{class:"fieldInline"});w.appendChild(A("span",{},"Pipeline")),s=A("select"),w.appendChild(s);const S=A("label",{class:"fieldInline"});S.appendChild(A("span",{},"Recipe")),l=A("select"),S.appendChild(l),p=A("button",{type:"button"},"Run all"),r=A("button",{type:"button"},"Next step"),g=A("button",{type:"button"},"Reset"),f=A("button",{type:"button"},"Download"),c.appendChild(w),c.appendChild(S),c.appendChild(p),c.appendChild(r),c.appendChild(g),c.appendChild(f);const P=A("div",{class:"grid4",style:"margin-top:12px;"}),C=A("div",{class:"card"});C.appendChild(A("div",{class:"cardTitle"},"Input (from source)")),u=A("canvas",{class:"canvas","aria-label":"Pipeline input preview"}),C.appendChild(u);const E=A("div",{class:"card"});E.appendChild(A("div",{class:"cardTitle"},"Current output")),d=A("canvas",{class:"canvas","aria-label":"Pipeline current output preview"}),h=A("img",{class:"canvas","aria-label":"Pipeline SVG output preview",style:"display:none;"}),E.appendChild(d),E.appendChild(h);const k=A("div",{class:"card",style:"grid-column:1 / -1;"});k.appendChild(A("div",{class:"cardTitle"},"Stages")),v=A("div"),k.appendChild(v),P.appendChild(C),P.appendChild(E),P.appendChild(k),a.appendChild(m),a.appendChild(c),a.appendChild(P),t.appendChild(a),s.addEventListener("change",()=>{const x=s?s.value:"segmentation";n.onSelectPipeline(x)}),l.addEventListener("change",()=>{const x=l?l.value:"default";n.onSelectRecipe(x)}),p.addEventListener("click",()=>n.onRunAll()),r.addEventListener("click",()=>n.onNext()),g.addEventListener("click",()=>n.onReset()),f.addEventListener("click",async()=>{try{await I(b)}catch(x){const T=x instanceof Error?x.message:String(x);i.textContent=`Download failed: ${T}`}})}function D(c){if(!s||!l)return;const w=Array.isArray(c==null?void 0:c.pipelines)?c.pipelines:[],S=Array.isArray(c==null?void 0:c.recipes)?c.recipes:[],P=typeof(c==null?void 0:c.activePipelineId)=="string"?c.activePipelineId:"segmentation",C=typeof(c==null?void 0:c.activeRecipeId)=="string"?c.activeRecipeId:"default";s.innerHTML="";for(const E of w){const k=A("option");k.value=E.id,k.textContent=E.title,E.id===P&&(k.selected=!0),s.appendChild(k)}l.innerHTML="";for(const E of S){const k=A("option");k.value=E.id,k.textContent=E.title,E.id===C&&(k.selected=!0),l.appendChild(k)}}function U(c){var S;if(!u)return;const w=(S=c==null?void 0:c.input)==null?void 0:S.data;if(!w){u.width=1,u.height=1;const P=u.getContext("2d");P&&P.clearRect(0,0,u.width,u.height);return}be(u,w)}function F(c){var x,T,L,j,z;if(!d||!h)return;const w=(x=c==null?void 0:c.outputSvg)==null?void 0:x.svg;if(typeof w=="string"&&w.length>0){d.style.display="none",h.style.display="block",h.src=$t(w);return}d.style.display="block",h.style.display="none",h.src="";const S=(T=c==null?void 0:c.outputImage)==null?void 0:T.data;if(S){be(d,S);return}const P=(L=c==null?void 0:c.outputMask)==null?void 0:L.data,C=(j=c==null?void 0:c.outputMask)==null?void 0:j.width,E=(z=c==null?void 0:c.outputMask)==null?void 0:z.height;if(P&&typeof C=="number"&&typeof E=="number"){ze(d,P,C,E);return}d.width=1,d.height=1;const k=d.getContext("2d");k&&k.clearRect(0,0,d.width,d.height)}function B(c){if(!v)return;v.innerHTML="";const w=Array.isArray(c==null?void 0:c.stages)?c.stages:[];if(!w.length){v.appendChild(A("div",{class:"muted",style:"font-size:12px;"},"No stages."));return}const S=A("div",{style:"display:flex; flex-direction:column; gap:10px;"});for(const P of w)S.appendChild(O(P));v.appendChild(S)}function O(c){const w=A("div",{class:"card",style:"padding:10px;"}),S=A("div",{class:"row",style:"align-items:center; justify-content:space-between;"});S.appendChild(A("div",{style:"font-weight:bold;"},String(c.title??c.stageId))),S.appendChild(A("div",{class:"status"},String(c.state??"idle"))),w.appendChild(S),w.appendChild(A("div",{class:"muted",style:"font-size:12px;"},`${c.input} -> ${c.output}`)),typeof c.error=="string"&&c.error.length>0&&w.appendChild(A("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Stage error: ${c.error}`));const P=c.outputArtifact;P&&w.appendChild(nt(P,260));const C=Array.isArray(c.ops)?c.ops:[];if(C.length){const E=A("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:8px;"});for(let k=0;k<C.length;k++){const x=C[k],T=k===C.length-1,L=A("div",{class:"card",style:"padding:8px;"}),j=A("div",{class:"row",style:"align-items:center; justify-content:space-between;"});j.appendChild(A("div",{style:"font-weight:bold; font-size:12px;"},String(x.title??x.opId))),j.appendChild(A("div",{class:"status"},String(x.state??"idle"))),L.appendChild(j),L.appendChild(A("div",{class:"muted",style:"font-size:12px;"},`${x.input} -> ${x.output}`)),typeof x.error=="string"&&x.error.length>0&&L.appendChild(A("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Op error: ${x.error}`));const z=P&&T?void 0:x.outputArtifact;z&&L.appendChild(nt(z,200)),E.appendChild(L)}w.appendChild(E)}return w}return{mount(){M()},render(c){var w,S,P;if(M(),b=c,D(c),i.textContent=typeof(c==null?void 0:c.statusText)=="string"?c.statusText:"Idle",m){const C=typeof(c==null?void 0:c.description)=="string"?c.description:"Universal pipeline runner.";m.textContent=C}if(f){const C=typeof((w=c==null?void 0:c.outputSvg)==null?void 0:w.svg)=="string"&&c.outputSvg.svg.length>0,E=!!((S=c==null?void 0:c.outputImage)!=null&&S.data),k=!!((P=c==null?void 0:c.outputMask)!=null&&P.data);f.disabled=!(C||E||k)}U(c),F(c),B(c)},dispose(){o=!1,a=null,s=null,l=null,p=null,r=null,g=null,f=null,m=null,u=null,d=null,h=null,v=null,b=null,y()}}}function ue(e,t){return e.find(i=>i.id===t)??null}function W(e,t){return{input:e,output:t}}function ot(e,t){return`${e}.${t+1}`}function at(e){const t=[{kind:"dispatch",id:"op.seg.resize",title:"Resize",io:W("image","image"),dispatchId:"segmentation.resize",tuningId:"segmentation.resize",group:"Segmentation"},{kind:"dispatch",id:"op.seg.denoise",title:"Denoise",io:W("image","image"),dispatchId:"segmentation.denoise",tuningId:"segmentation.denoise",group:"Segmentation"},{kind:"dispatch",id:"op.seg.color",title:"Color / Gray",io:W("image","image"),dispatchId:"segmentation.color",tuningId:"segmentation.color",group:"Segmentation"},{kind:"dispatch",id:"op.seg.threshold",title:"Threshold",io:W("image","mask"),dispatchId:"segmentation.threshold",tuningId:"segmentation.threshold",group:"Segmentation"},{kind:"dispatch",id:"op.seg.morphology",title:"Morphology cleanup",io:W("mask","mask"),dispatchId:"segmentation.morphology",tuningId:"segmentation.morphology",group:"Segmentation"},{kind:"dispatch",id:"op.edge.resize",title:"Resize",io:W("image","image"),dispatchId:"edge.resize",tuningId:"edge.resize",group:"Edge"},{kind:"dispatch",id:"op.edge.threshold",title:"Threshold",io:W("image","mask"),dispatchId:"edge.threshold",tuningId:"edge.threshold",group:"Edge"},{kind:"dispatch",id:"op.edge.morphology",title:"Morphology cleanup",io:W("mask","mask"),dispatchId:"edge.morphology",tuningId:"edge.morphology",group:"Edge"},{kind:"dispatch",id:"op.edge.extract",title:"Edge extract",io:W("mask","mask"),dispatchId:"edge.extract",tuningId:"edge.extract",group:"Edge"},{kind:"dispatch",id:"op.svg.create",title:"Create SVG",io:W("mask","svg"),dispatchId:"svg.create",tuningId:"svg.create",group:"SVG"},{kind:"dispatch",id:"op.mage.clean.removeSmallComponents",title:"Remove small components",io:W("mask","mask"),dispatchId:"mage.clean.removeSmallComponents",tuningId:"mage.clean.removeSmallComponents",group:"Cleanup"},{kind:"js",id:"op.util.pass.image",title:"Pass-through (image)",io:W("image","image"),group:"Utility",run:({input:r})=>r},{kind:"js",id:"op.util.pass.mask",title:"Pass-through (mask)",io:W("mask","mask"),group:"Utility",run:({input:r})=>r}];function i(r){return ue(t,r)}function n(r,g){return g.map((f,m)=>({instanceId:ot(r,m),opId:f,enabled:!0}))}const o=[{id:"segmentation",title:"Segmentation",implemented:!0,description:"Multi-step segmentation pipeline (image -> mask).",ops:n("segmentation",["op.seg.resize","op.seg.denoise","op.seg.color","op.seg.threshold","op.seg.morphology"])},{id:"edge",title:"Edge",implemented:!0,description:"Edge extraction pipeline (image -> mask -> edges).",ops:n("edge",["op.edge.resize","op.edge.threshold","op.edge.morphology","op.edge.extract"])},{id:"svg",title:"SVG",implemented:!0,description:"Image to SVG outline.",ops:n("svg",["op.edge.resize","op.edge.threshold","op.edge.morphology","op.edge.extract","op.svg.create"])},{id:"cleanup",title:"Cleanup (min area)",implemented:!0,description:"Image -> mask -> cleanup (morphology + remove small components).",ops:n("cleanup",["op.seg.resize","op.seg.threshold","op.seg.morphology","op.mage.clean.removeSmallComponents"])},{id:"surface",title:"Surface",implemented:!1,description:"Future: region labeling + vectorize pipeline.",ops:[]}],a=(e==null?void 0:e.userPipelines)??[];function s(r){return ue(o,r)}function l(r){return ue(a,r)??ue(o,r)}function p(){const r=new Set(a.map(f=>f.id));return[...o.filter(f=>!r.has(f.id)),...a]}return{ops:t,getOp:i,builtIns:o,getBuiltIn:s,listPipelines:p,getPipeline:l,createInstanceId:ot}}const st=At();function Ai(){return{opencvReady:Q()}}function Mi(e){const{implemented:t,policy:i,runtimeOpenCvReady:n}=e,o=n&&t.includes("opencv");return t.includes("native")||t.length,i==="native"?{engine:"native"}:i==="opencv"?o?{engine:"opencv"}:{engine:"native",fallbackReason:n?"Override policy=opencv, but this op has no OpenCV implementation.":"Override policy=opencv, but OpenCV is not available at runtime."}:i==="auto"?o?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}async function Di(e,t){const i=await ce(),n=Ai(),o=Mt(e,st,i,n),a=st.byId.get(e);if(!a)throw new Error(`[opsDispatch] Unknown op in registry: ${e}`);const l={...o.params,...(t==null?void 0:t.params)??{}},p=t!=null&&t.enginePolicy&&t.enginePolicy!=="inherit"?t.enginePolicy:o.policy;let r=o.engine,g=o.fallbackReason;if(t!=null&&t.enginePolicy&&t.enginePolicy!=="inherit"){const f=Mi({implemented:a.implementedEngines,policy:p,runtimeOpenCvReady:!!n.opencvReady});r=f.engine,g=f.fallbackReason}return{engine:r,params:l,fallbackReason:g,opencvReady:!!n.opencvReady}}async function Ti(e,t,i,n){const{engine:o,params:a,fallbackReason:s,opencvReady:l}=await Di(e,n);return o==="opencv"&&!l?(me(`OpenCV selected for ${e} but not ready; falling back to native. ${s??""}`.trim()),await i[e].native(t,a)):await i[e][o](t,a)}function de(e,t,i,n){if(!t||!i)return e;const o=Math.floor(Number(n.morphAlgo??2)),a=Li(Math.floor(Number(n.morphIters??1)),1,20),s=Math.floor(Number(n.morphK??5)),l=Ri(s),p=l-1>>1;if(o<=0||l<=1)return e;let r=e,g=new Uint8Array(t*i);for(let f=0;f<a;f++){if(o===1){lt(r,g,t,i,p);const m=r;r=g,g=m;continue}if(o===2){rt(r,g,t,i,p);const m=r;r=g,g=m;continue}rt(r,g,t,i,p),r===e&&f===0&&(r=new Uint8Array(e)),lt(g,r,t,i,p)}return r}function Ri(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:5}function rt(e,t,i,n,o){t.fill(0);for(let a=0;a<n;a++){const s=Math.max(0,a-o),l=Math.min(n-1,a+o);for(let p=0;p<i;p++){const r=Math.max(0,p-o),g=Math.min(i-1,p+o);let f=0;for(let m=s;m<=l&&!f;m++){let u=m*i+r;for(let d=r;d<=g;d++,u++)if(e[u]){f=1;break}}t[a*i+p]=f}}}function lt(e,t,i,n,o){t.fill(0);for(let a=0;a<n;a++){const s=Math.max(0,a-o),l=Math.min(n-1,a+o);for(let p=0;p<i;p++){const r=Math.max(0,p-o),g=Math.min(i-1,p+o);let f=1;for(let m=s;m<=l&&f;m++){let u=m*i+r;for(let d=r;d<=g;d++,u++)if(!e[u]){f=0;break}}t[a*i+p]=f}}}function Li(e,t,i){return e<t?t:e>i?i:e}function Vt(e,t,i,n){const o=Math.max(0,Math.floor(Number(n??0)));if(!t||!i||o<=1)return e;const a=new Uint8Array(e),s=new Uint8Array(e.length),l=new Int32Array(e.length),p=new Int32Array(e.length);for(let r=0;r<i;r++)for(let g=0;g<t;g++){const f=r*t+g;if(e[f]===0||s[f]===1)continue;let m=0,u=0;s[f]=1,l[u]=g,p[u]=r,u++;const d=[f];for(;m<u;){const h=l[m],v=p[m];m++;const b=h-1,y=v,I=h+1,M=v,D=h,U=v-1,F=h,B=v+1;if(b>=0){const O=y*t+b;e[O]!==0&&s[O]===0&&(s[O]=1,l[u]=b,p[u]=y,u++,d.push(O))}if(I<t){const O=M*t+I;e[O]!==0&&s[O]===0&&(s[O]=1,l[u]=I,p[u]=M,u++,d.push(O))}if(U>=0){const O=U*t+D;e[O]!==0&&s[O]===0&&(s[O]=1,l[u]=D,p[u]=U,u++,d.push(O))}if(B<i){const O=B*t+F;e[O]!==0&&s[O]===0&&(s[O]=1,l[u]=F,p[u]=B,u++,d.push(O))}}if(d.length<o)for(let h=0;h<d.length;h++)a[d[h]]=0}return a}function Oi(){const e=globalThis;return e!=null&&e.cv&&typeof e.cv.Mat=="function"?e.cv:null}function $i(e,t){const{width:i,height:n}=e,o=Math.max(0,Math.floor(Number(t.cleanMinArea??0)));if(xt("OpenCV removeSmallComponents params",{width:i,height:n,minArea:o}),!i||!n||o<=1)return e.mask;const a=Oi();if(!a)return Vt(e.mask,i,n,o);const s=new a.Mat(n,i,a.CV_8UC1);try{const l=s.data,p=e.mask;for(let m=0;m<p.length;m++)l[m]=p[m]?255:0;const r=new a.Mat,g=new a.Mat,f=new a.Mat;try{const m=a.connectedComponentsWithStats(s,r,g,f,8,a.CV_32S),u=a.CC_STAT_AREA??4,d=new Array(m).fill(!1);for(let b=1;b<m;b++)g.intAt(b,u)<o&&(d[b]=!0);const h=new Uint8Array(i*n),v=r.data32S;for(let b=0;b<h.length;b++){const y=v[b];h[b]=y>0&&!d[y]?1:0}return h}finally{r.delete(),g.delete(),f.delete()}}finally{s.delete()}}function ge(e,t,i,n){const o=Math.max(0,Math.min(255,Math.floor(Number(n.manualT??128)))),a=new Uint8Array(t*i),s=e.data;for(let l=0,p=0;l<a.length;l++,p+=4){const r=s[p],g=s[p+1],f=s[p+2],m=r*77+g*150+f*29>>8;a[l]=m>=o?1:0}return a}function pe(e,t,i,n){const o=Math.max(1,Math.floor(Number(n.targetMaxW??t)));if(!t||!i||t<=o)return e;const a=o/t,s=Math.max(1,Math.floor(t*a)),l=Math.max(1,Math.floor(i*a));return Math.floor(Number(n.resizeAlgo??1))===0?Bi(e,t,i,s,l):Vi(e,t,i,s,l)}function Bi(e,t,i,n,o){const a=e.data,s=new Uint8ClampedArray(n*o*4),l=t/n,p=i/o;for(let r=0;r<o;r++){const g=Math.min(i-1,Math.max(0,Math.floor((r+.5)*p-.5)));for(let f=0;f<n;f++){const m=Math.min(t-1,Math.max(0,Math.floor((f+.5)*l-.5))),u=(g*t+m)*4,d=(r*n+f)*4;s[d]=a[u],s[d+1]=a[u+1],s[d+2]=a[u+2],s[d+3]=a[u+3]}}return new ImageData(s,n,o)}function Vi(e,t,i,n,o){const a=e.data,s=new Uint8ClampedArray(n*o*4),l=t/n,p=i/o;for(let r=0;r<o;r++){const g=(r+.5)*p-.5,f=fe(Math.floor(g),0,i-1),m=fe(f+1,0,i-1),u=g-f;for(let d=0;d<n;d++){const h=(d+.5)*l-.5,v=fe(Math.floor(h),0,t-1),b=fe(v+1,0,t-1),y=h-v,I=(f*t+v)*4,M=(f*t+b)*4,D=(m*t+v)*4,U=(m*t+b)*4,F=(r*n+d)*4;for(let B=0;B<4;B++){const O=a[I+B],c=a[M+B],w=a[D+B],S=a[U+B],P=O+(c-O)*y,C=w+(S-w)*y,E=P+(C-P)*u;s[F+B]=Ui(E)}}}return new ImageData(s,n,o)}function fe(e,t,i){return e<t?t:e>i?i:e}function Ui(e){return e<=0?0:e>=255?255:e|0}function ct(e,t,i,n){if(!t||!i)return e;const o=Math.floor(Number(n.denoiseAlgo??1));if(o<=0)return e;const a=Math.floor(Number(n.blurK??3)),s=Ni(a);return o===2&&s<=3?Fi(e,t,i):s<=1?e:zi(e,t,i,s)}function Ni(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:3}function zi(e,t,i,n){const o=n-1>>1,a=e.data,s=new Uint8ClampedArray(t*i*4);for(let p=0;p<i;p++){let r=0,g=0,f=0,m=0;for(let u=-o;u<=o;u++){const d=ee(u,0,t-1),h=(p*t+d)*4;r+=a[h],g+=a[h+1],f+=a[h+2],m+=a[h+3]}for(let u=0;u<t;u++){const d=(p*t+u)*4;s[d]=r/n|0,s[d+1]=g/n|0,s[d+2]=f/n|0,s[d+3]=m/n|0;const h=ee(u-o,0,t-1),v=ee(u+o+1,0,t-1),b=(p*t+h)*4,y=(p*t+v)*4;r+=a[y]-a[b],g+=a[y+1]-a[b+1],f+=a[y+2]-a[b+2],m+=a[y+3]-a[b+3]}}const l=new Uint8ClampedArray(t*i*4);for(let p=0;p<t;p++){let r=0,g=0,f=0,m=0;for(let u=-o;u<=o;u++){const h=(ee(u,0,i-1)*t+p)*4;r+=s[h],g+=s[h+1],f+=s[h+2],m+=s[h+3]}for(let u=0;u<i;u++){const d=(u*t+p)*4;l[d]=r/n|0,l[d+1]=g/n|0,l[d+2]=f/n|0,l[d+3]=m/n|0;const h=ee(u-o,0,i-1),v=ee(u+o+1,0,i-1),b=(h*t+p)*4,y=(v*t+p)*4;r+=s[y]-s[b],g+=s[y+1]-s[b+1],f+=s[y+2]-s[b+2],m+=s[y+3]-s[b+3]}}return new ImageData(l,t,i)}function Fi(e,t,i){const n=e.data,o=new Uint8ClampedArray(t*i*4),a=new Array(9),s=new Array(9),l=new Array(9),p=new Array(9);for(let r=0;r<i;r++)for(let g=0;g<t;g++){let f=0;for(let u=-1;u<=1;u++){const d=ee(r+u,0,i-1);for(let h=-1;h<=1;h++){const v=ee(g+h,0,t-1),b=(d*t+v)*4;a[f]=n[b],s[f]=n[b+1],l[f]=n[b+2],p[f]=n[b+3],f++}}a.sort(he),s.sort(he),l.sort(he),p.sort(he);const m=(r*t+g)*4;o[m]=a[4]|0,o[m+1]=s[4]|0,o[m+2]=l[4]|0,o[m+3]=p[4]|0}return new ImageData(o,t,i)}function he(e,t){return e-t}function ee(e,t,i){return e<t?t:e>i?i:e}function ut(e,t,i,n){if(!t||!i)return e;const o=Math.floor(Number(n.colorMode??1));if(o===0)return e;const a=e.data,s=new Uint8ClampedArray(t*i*4),l=_i(Math.floor(Number(n.hsvChannel??2)),0,2);for(let p=0,r=0;p<t*i;p++,r+=4){const g=a[r],f=a[r+1],m=a[r+2],u=a[r+3];let d=0;if(o===1)d=g*77+f*150+m*29>>8;else if(o===2){const h=ji(g,f,m),v=l===0?h.h:l===1?h.s:h.v;d=Ki(v*255)}else d=255-(g*77+f*150+m*29>>8);s[r]=d,s[r+1]=d,s[r+2]=d,s[r+3]=u}return new ImageData(s,t,i)}function ji(e,t,i){const n=e/255,o=t/255,a=i/255,s=Math.max(n,o,a),l=Math.min(n,o,a),p=s-l;let r=0;p!==0&&(s===n?r=(o-a)/p%6:s===o?r=(a-n)/p+2:r=(n-o)/p+4,r/=6,r<0&&(r+=1));const g=s===0?0:p/s;return{h:r,s:g,v:s}}function _i(e,t,i){return e<t?t:e>i?i:e}function Ki(e){return e<=0?0:e>=255?255:e|0}function dt(e,t,i){const n=new Uint8Array(e.length),o=(a,s)=>s*t+a;for(let a=0;a<i;a++)for(let s=0;s<t;s++){const l=o(s,a);if(e[l]===0)continue;if(s===0||a===0||s===t-1||a===i-1){n[l]=255;continue}const r=e[o(s-1,a)],g=e[o(s+1,a)],f=e[o(s,a-1)],m=e[o(s,a+1)];(r===0||g===0||f===0||m===0)&&(n[l]=255)}return n}function gt(e,t,i,n){const o=Math.max(1,Math.floor(n.scale||1)),a=t*o,s=i*o,l=o;let p="";for(let m=0;m<i;m++){const u=m*t;for(let d=0;d<t;d++){if(e[u+d]===0)continue;const v=d*l,b=m*l;p+=`M${v} ${b}h${l}v${l}h-${l}Z`}}const r=n.transparentBg?"":`<rect x="0" y="0" width="${a}" height="${s}" fill="white"/>`,g=n.color||"#000",f=p.length>0?`<path d="${p}" fill="${g}" stroke="none"/>`:"";return`<svg xmlns="http://www.w3.org/2000/svg" width="${a}" height="${s}" viewBox="0 0 ${a} ${s}">`+r+f+"</svg>"}const Gi="demo",Hi={"mage.clean.removeSmallComponents":{native:(e,t)=>Vt(e.mask,e.width,e.height,t.cleanMinArea),opencv:(e,t)=>(R("OpenCV removeSmallComponents called (demo).",{width:e.width,height:e.height,cleanMinArea:t.cleanMinArea}),$i(e,t))},"segmentation.resize":{native:(e,t)=>(R("[demo op] segmentation.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),pe(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(R("[demo op] segmentation.resize opencv",{width:e.width,height:e.height}),pe(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"segmentation.denoise":{native:(e,t)=>(R("[demo op] segmentation.denoise native",{width:e.width,height:e.height,denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}),ct(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma})),opencv:(e,t)=>(R("[demo op] segmentation.denoise opencv",{width:e.width,height:e.height}),ct(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}))},"segmentation.color":{native:(e,t)=>(R("[demo op] segmentation.color native",{width:e.width,height:e.height,colorMode:t.colorMode,hsvChannel:t.hsvChannel}),ut(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel})),opencv:(e,t)=>(R("[demo op] segmentation.color opencv",{width:e.width,height:e.height}),ut(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel}))},"segmentation.threshold":{native:(e,t)=>(R("[demo op] segmentation.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),ge(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(R("[demo op] segmentation.threshold opencv",{width:e.width,height:e.height}),ge(e.image,e.width,e.height,{manualT:t.manualT}))},"segmentation.morphology":{native:(e,t)=>(R("[demo op] segmentation.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),de(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(R("[demo op] segmentation.morphology opencv",{width:e.width,height:e.height}),de(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.resize":{native:(e,t)=>(R("[demo op] edge.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),pe(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(R("[demo op] edge.resize opencv",{width:e.width,height:e.height}),pe(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"edge.threshold":{native:(e,t)=>(R("[demo op] edge.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),ge(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(R("[demo op] edge.threshold opencv",{width:e.width,height:e.height}),ge(e.image,e.width,e.height,{manualT:t.manualT}))},"edge.morphology":{native:(e,t)=>(R("[demo op] edge.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),de(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(R("[demo op] edge.morphology opencv",{width:e.width,height:e.height}),de(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.extract":{native:(e,t)=>(R("[demo op] edge.extract native",{width:e.width,height:e.height}),dt(e.mask,e.width,e.height)),opencv:(e,t)=>(R("[demo op] edge.extract opencv",{width:e.width,height:e.height}),dt(e.mask,e.width,e.height))},"svg.create":{native:(e,t)=>(R("[demo op] svg.create native",{width:e.width,height:e.height,scale:t.scale}),gt(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color})),opencv:(e,t)=>(R("[demo op] svg.create opencv",{width:e.width,height:e.height,scale:t.scale}),gt(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color}))}};async function oe(e,t,i){return xt("[opsDispatch] runOp",{op:e,implSource:Gi,inputKeys:t&&typeof t=="object"?Object.keys(t):typeof t,override:i?{enginePolicy:i.enginePolicy,paramsKeys:Object.keys(i.params??{})}:null}),Ti(e,t,Hi,i)}const Wi=Object.freeze(Object.defineProperty({__proto__:null,runOp:oe},Symbol.toStringTag,{value:"Module"}));function Ji(e){return{width:e.width,height:e.height}}function qi(e){return e.type==="image"}function Yi(e){return e.type==="mask"}function Ut(e){return{type:"image",width:e.width,height:e.height,image:e}}function pt(e,t,i){return{type:"mask",width:t,height:i,mask:e}}function ft(e,t,i){return{type:"svg",width:t,height:i,svg:e}}function Se(e,t){return`IO mismatch: expected ${e}, got ${t}`}function Zi(e,t){if(e.length===0)return"Pipeline has no ops";let i=t;for(const n of e){if(n.io.input!==i)return`Chain IO mismatch at "${n.title}": needs ${n.io.input} but current is ${i}`;i=n.io.output}return null}async function Xi(e,t,i){const n=t.override;if(e.io.input==="image"){if(!qi(i))throw new Error(Se("image",i.type));const{width:s,height:l}=i;if(e.io.output==="image"){const p=await oe(e.dispatchId,{image:i.image,width:s,height:l},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return Ut(p)}if(e.io.output==="mask"){const p=await oe(e.dispatchId,{image:i.image,width:s,height:l},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return pt(p,s,l)}if(e.io.output==="svg"){const p=await oe(e.dispatchId,{image:i.image,width:s,height:l},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return ft(p,s,l)}throw new Error(`Unsupported dispatch output: ${e.io.output}`)}if(!Yi(i))throw new Error(Se("mask",i.type));const{width:o,height:a}=i;if(e.io.output==="mask"){const s=await oe(e.dispatchId,{mask:i.mask,width:o,height:a},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return pt(s,o,a)}if(e.io.output==="svg"){const s=await oe(e.dispatchId,{mask:i.mask,width:o,height:a},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return ft(s,o,a)}throw new Error(`Invalid op spec: mask input cannot produce ${e.io.output} (unsupported here)`)}async function Qi(e,t,i,n){var l;if(e.kind==="dispatch")return await Xi(e,t,i);const a={...e.tuningId?await n.getEffectiveParams(e.tuningId).catch(()=>({})):{},...((l=t.override)==null?void 0:l.params)??{}};return await e.run({input:i,params:a})}async function eo(e){const{catalogue:t,pipeline:i,inputImage:n,deps:o}=e,a=Ut(n);if(!i.implemented)return{pipelineId:i.id,title:i.title,status:"error",error:"Not implemented yet",input:a,ops:[]};const s=i.ops.filter(f=>f.enabled!==!1),l=[];for(const f of s){const m=t.getOp(f.opId);if(!m)return{pipelineId:i.id,title:i.title,status:"error",error:`Unknown opId in pipeline: ${f.opId}`,input:a,ops:[]};l.push(m)}const p=Zi(l,"image");if(p)return o.debug("pipeline validation failed (linear)",{pipelineId:i.id,error:p}),{pipelineId:i.id,title:i.title,status:"error",error:p,input:a,ops:s.map((f,m)=>{var u,d;return{instanceId:f.instanceId,opId:f.opId,title:((u=l[m])==null?void 0:u.title)??f.opId,io:((d=l[m])==null?void 0:d.io)??{input:"image",output:"image"},status:"error",error:p}})};const r=[];let g=a;for(let f=0;f<l.length;f++){const m=s[f],u=l[f];try{if(u.io.input!==g.type)throw new Error(Se(u.io.input,g.type));const d=await Qi(u,m,g,o);if(d.type!==u.io.output)throw new Error(Se(u.io.output,d.type));r.push({instanceId:m.instanceId,opId:u.id,title:u.title,io:u.io,status:"ok",output:d}),g=d}catch(d){const h=d instanceof Error?d.message:String(d);return r.push({instanceId:m.instanceId,opId:u.id,title:u.title,io:u.io,status:"error",error:h}),o.debug("pipeline op failed (linear)",{pipelineId:i.id,opId:u.id,error:h,...Ji(g)}),{pipelineId:i.id,title:i.title,status:"error",error:`Op "${u.title}" failed: ${h}`,input:a,ops:r}}}return{pipelineId:i.id,title:i.title,status:"ok",input:a,output:g,ops:r}}const Fe="beemage.pipeline.userPipelines.v1";async function ye(){const e=await te([Fe]).catch(()=>({})),t=e==null?void 0:e[Fe];if(!Array.isArray(t))return[];const i=[];for(const n of t)!n||typeof n!="object"||typeof n.id=="string"&&Array.isArray(n.ops)&&i.push(n);return i}async function to(e){await ne({[Fe]:e}).catch(()=>null)}function no(e){return e.type==="image"}function io(e){return e.type==="mask"}function oo(e){return e.type==="svg"}function ao(e){var c,w,S,P;let t=at({userPipelines:[]}),n=((S=(w=(c=t.listPipelines)==null?void 0:c.call(t))==null?void 0:w[0])==null?void 0:S.id)??((P=t.builtIns[0])==null?void 0:P.id)??"segmentation",o="default",a=null,s="Idle",l=null,p=[],r=0,g=null;async function f(){var x,T;const C=await ye().catch(()=>[]);t=at({userPipelines:C});const E=((x=t.listPipelines)==null?void 0:x.call(t))??t.builtIns;E.some(L=>L.id===n)||(n=((T=E[0])==null?void 0:T.id)??"segmentation",o="default"),h()}function m(){var E,k,x;const C=((E=t.getPipeline)==null?void 0:E.call(t,n))??((x=(k=t.listPipelines)==null?void 0:k.call(t))==null?void 0:x[0]);if(!C)throw new Error("[pipeline] No pipelines available.");return C}function u(C){return[{id:"default",title:"Default",buildPipeline:k=>k}]}function d(){const C=m(),E=u(),k=E.find(x=>x.id===o)??E[0];return o=k.id,k.buildPipeline(C)}function h(){s=d().implemented?"Ready":"Not implemented yet",l=null,p=[],r=0,g=null}function v(){h()}function b(C){var k,x;C===n||!(((k=t.getPipeline)==null?void 0:k.call(t,C))??((x=t.getBuiltIn)==null?void 0:x.call(t,C)))||(n=C,o="default",v())}function y(C){C!==o&&(o=C,v())}function I(C){a=C,h()}function M(C){const E=C.ops.filter(x=>x.enabled!==!1),k=[];for(let x=0;x<E.length;x++){const T=E[x],L=t.getOp(T.opId);L&&k.push({index0:x,instanceId:T.instanceId,opSpec:L})}return k}function D(C){var T;const E=C.ops.map(L=>({instanceId:L.instanceId,opId:L.opId,title:L.title,input:L.io.input,output:L.io.output,state:L.status==="ok"?"ok":L.status==="error"?"error":"idle",error:L.error,outputArtifact:L.output})),k=C.status==="ok"?"ok":"error",x=C.output??((T=E.slice().reverse().find(L=>L.outputArtifact))==null?void 0:T.outputArtifact);return[{stageId:"pipeline",title:"Pipeline",input:"image",output:(x==null?void 0:x.type)??"image",ops:E,state:k,error:C.error,outputArtifact:x}]}function U(C,E){E&&(no(E)?C.outputImage={width:E.width,height:E.height,data:E.image}:io(E)?C.outputMask={width:E.width,height:E.height,data:E.mask}:oo(E)&&(C.outputSvg={width:E.width,height:E.height,svg:E.svg}))}async function F(){const C=d();if(!C.implemented){s="Not implemented yet";return}if(!a){s="No input image";return}s="Running all…";const E=await eo({catalogue:t,pipeline:C,inputImage:a,deps:e.runner});l=E,p=M(C),r=p.length,g=E.output??null,s=E.status==="ok"?"Done":E.error??"Error"}async function B(){const C=d();if(!C.implemented){s="Not implemented yet";return}if(!a){s="No input image";return}if(p.length===0&&(p=M(C),r=0,g={type:"image",width:a.width,height:a.height,image:a},l={pipelineId:C.id,title:C.title,status:"ok",input:{type:"image",width:a.width,height:a.height,image:a},output:{type:"image",width:a.width,height:a.height,image:a},ops:[]}),r>=p.length){s="Done";return}const E=p[r],k=E.opSpec;g||(g={type:"image",width:a.width,height:a.height,image:a});try{if(s=`Running: ${k.title}`,g.type!==k.io.input)throw new Error(`IO mismatch: expected ${k.io.input}, got ${g.type}`);const x=k.tuningId?await e.runner.getEffectiveParams(k.tuningId).catch(()=>({})):{};let T;if(k.kind==="dispatch"){const{runOp:z}=await gn(async()=>{const{runOp:J}=await Promise.resolve().then(()=>Wi);return{runOp:J}},void 0,import.meta.url);if(g.type==="image"){const J=await z(k.dispatchId,{image:g.image,width:g.width,height:g.height});if(k.io.output==="image"){const H=J;T={type:"image",width:H.width,height:H.height,image:H}}else if(k.io.output==="mask")T={type:"mask",width:g.width,height:g.height,mask:J};else throw new Error(`Unsupported dispatch output: ${k.io.output}`)}else if(g.type==="mask"){const J=await z(k.dispatchId,{mask:g.mask,width:g.width,height:g.height});if(k.io.output==="mask")T={type:"mask",width:g.width,height:g.height,mask:J};else if(k.io.output==="svg")T={type:"svg",width:g.width,height:g.height,svg:J};else throw new Error(`Invalid dispatch output: ${k.io.output}`)}else throw new Error("Dispatch ops cannot take svg input.")}else T=await k.run({input:g,params:x});if(T.type!==k.io.output)throw new Error(`IO mismatch: expected ${k.io.output}, got ${T.type}`);const j=((l==null?void 0:l.ops)??[]).concat([{instanceId:E.instanceId,opId:k.id,title:k.title,io:k.io,status:"ok",output:T}]);l={pipelineId:C.id,title:C.title,status:"ok",input:{type:"image",width:a.width,height:a.height,image:a},output:T,ops:j},g=T,r+=1,s=r>=p.length?"Done":"Ready"}catch(x){const T=x instanceof Error?x.message:String(x);s=`Error: ${k.title} — ${T}`;const j=((l==null?void 0:l.ops)??[]).concat([{instanceId:E.instanceId,opId:k.id,title:k.title,io:k.io,status:"error",error:T}]);l={pipelineId:C.id,title:C.title,status:"error",error:T,input:{type:"image",width:a.width,height:a.height,image:a},ops:j},e.runner.debug("pipeline next-step failed",{pipelineId:C.id,recipeId:o,instanceId:E.instanceId,opId:k.id,error:T})}}function O(){var j;m();const C=d(),E=u(),T={pipelines:(((j=t.listPipelines)==null?void 0:j.call(t))??t.builtIns).map(z=>({id:z.id,title:z.title})),recipes:E.map(z=>({id:z.id,title:z.title})),activePipelineId:n,activeRecipeId:o,statusText:s,description:C.description,stages:l?D(l):[],input:a?{width:a.width,height:a.height,data:a}:void 0,nextIndex:r,totalOps:p.length||C.ops.filter(z=>z.enabled!==!1).length},L=(l==null?void 0:l.output)??g??null;return U(T,L),T}return v(),{getVm:O,setActivePipeline:b,setActiveRecipe:y,setInputImageData:I,runAll:F,runNext:B,reset:v,reloadCatalogue:f}}function so(e,t,i){const n=ao({runner:{getEffectiveParams:async c=>await i.getEffectiveParams(c).catch(()=>({})),debug:(c,w)=>Y({scope:"panel",kind:"debug",message:c,meta:w})}});let o=null,a=!1,s=null,l=null;function p(){const c=n.getVm();if(!(c.stages.some(P=>P.state==="error")||String(c.statusText).toLowerCase().includes("error"))){l=null;return}const S=String(c.statusText||"Pipeline error");S!==l&&(l=S,V({scope:"panel",kind:"error",message:`Pipeline: ${S}`}))}function r(){e.pipelineTuningMountEl.innerHTML=""}function g(c){return[c,`pipeline.${c}`,"pipeline"]}function f(c){const w=g(c);if(s===w[0])return;r();let S=null,P=null;for(const C of w)try{i.mount({mountEl:e.pipelineTuningMountEl,scopeRootId:C}),S=C;break}catch(E){P=E,r()}if(!S){s=null,V({scope:"panel",kind:"info",message:`Pipeline tuning mount failed for "${c}" (no matching scope).`}),Y({scope:"panel",kind:"error",message:"Pipeline tuning mount failed (no candidate scopeRootId worked)",meta:{pipelineId:c,candidates:w,error:P instanceof Error?P.message:String(P)}});return}s=S,V({scope:"panel",kind:"info",message:`Pipeline tuning mount: pipelineId=${c}, scopeRootId=${S}`})}function m(){const c=n.getVm(),w=typeof c.activePipelineId=="string"?c.activePipelineId:"segmentation";f(w)}function u(){const c=e.srcCanvasEl,w=c.width,S=c.height;if(!w||!S)return null;const P=c.getContext("2d",{willReadFrequently:!0});return P?P.getImageData(0,0,w,S):null}function d(){if(n.getVm().input)return;const w=u();w&&n.setInputImageData(w)}function h(){const c=u();c&&n.setInputImageData(c)}async function v(){const c=await i.getEffectiveParams("pipeline").catch(()=>({})),w=c==null?void 0:c.mode,S=c==null?void 0:c.recipe,P=typeof w=="string"?w:"segmentation",C=typeof S=="string"?S:"default";n.setActivePipeline(P),n.setActiveRecipe(C),m()}function b(){return o||(V({scope:"panel",kind:"info",message:"Pipeline view: create + mount"}),o=Pi({hostEl:e.pipelineViewMountEl,statusEl:e.pipelineStatusEl,handlers:{onSelectPipeline:c=>{V({scope:"panel",kind:"info",message:`Pipeline select: ${c}`}),n.setActivePipeline(c),i.setParamValue("pipeline","mode",c),m(),y()},onSelectRecipe:c=>{V({scope:"panel",kind:"info",message:`Recipe select: ${c}`}),n.setActiveRecipe(c),i.setParamValue("pipeline","recipe",c),y()},onRunAll:()=>void I(),onNext:()=>void M(),onReset:()=>{n.reset();const c=u();c&&n.setInputImageData(c),Ae(n.getVm()),V({scope:"panel",kind:"info",message:"Pipeline reset (reseed from source)"}),m(),y()}}}),o.mount(),m(),o)}function y(){b().render(n.getVm())}async function I(){V({scope:"panel",kind:"info",message:"Pipeline run: all"}),h();try{await n.runAll()}finally{Ae(n.getVm()),y(),p()}}async function M(){V({scope:"panel",kind:"info",message:"Pipeline run: next"}),d();try{await n.runNext()}finally{Ae(n.getVm()),y(),p()}}function D(){}async function U(){a=!0,V({scope:"panel",kind:"info",message:"Pipeline tab: mount()"}),h(),await n.reloadCatalogue().catch(()=>null),await v(),V({scope:"panel",kind:"info",message:"Pipeline tab: render()"}),y()}async function F(){a&&(V({scope:"panel",kind:"info",message:"Pipeline tab: refresh()"}),h(),await n.reloadCatalogue().catch(()=>null),await v(),y())}function B(){a=!1,V({scope:"panel",kind:"info",message:"Pipeline tab: unmount()"})}function O(){V({scope:"panel",kind:"info",message:"Pipeline tab: dispose()"}),o==null||o.dispose(),o=null,s=null,r()}return{bind:D,mount:U,unmount:B,refresh:F,dispose:O}}function je(e){return!!e&&typeof e=="object"}function ro(e){if(!je(e)||typeof e.id!="string"||!e.id||typeof e.title!="string"||!e.title||typeof e.implemented!="boolean"||!Array.isArray(e.ops))return!1;for(const t of e.ops)if(!je(t)||typeof t.instanceId!="string"||!t.instanceId||typeof t.opId!="string"||!t.opId||t.enabled!==void 0&&typeof t.enabled!="boolean")return!1;return!0}function lo(){async function e(){return await ye().catch(()=>[])}async function t(n){let o;try{o=JSON.parse(n)}catch{throw new Error("Invalid JSON (parse failed).")}let a;if(Array.isArray(o))a=o;else if(je(o)&&Array.isArray(o.pipelines))a=o.pipelines;else throw new Error('Invalid file shape. Expected {"pipelines":[...]} or an array of pipelines.');const s=a,l=s.length,p=[];let r=0;for(const m of s){if(!ro(m)){r++;continue}p.push(m)}if(p.length===0)throw new Error("No valid pipelines found in the imported file.");const g=await ye().catch(()=>[]),f=new Map;for(const m of g)f.set(m.id,m);for(const m of p)f.set(m.id,m);return await to(Array.from(f.values())),{imported:p.length,skipped:r,totalInFile:l}}async function i(){const n=await ye().catch(()=>[]),o={format:"beemage.pipeline.userPipelines.v1",exportedAt:new Date().toISOString(),pipelines:n};return JSON.stringify(o,null,2)}return{listUserPipelines:e,importFromJsonText:t,exportToJsonText:i}}function ie(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function co(e){const{dom:t,handlers:i}=e;let n=!1,o=!1,a=null;function s(){if(a)return a;const u=ie("div",{"data-role":"builderListMount",style:"margin-top:12px;"});return t.viewBuilder.appendChild(u),a=u,u}function l(){a&&(a.innerHTML="")}function p(u){const d=s();d.innerHTML="";const h=ie("div",{class:"card",style:"padding:10px;"});if(h.appendChild(ie("div",{class:"cardTitle"},"Stored user pipelines")),!u.length){h.appendChild(ie("div",{class:"muted",style:"font-size:12px;"},"No user pipelines stored.")),d.appendChild(h);return}const v=ie("ul",{style:"margin:0; padding-left:18px;"});for(const b of u)v.appendChild(ie("li",{style:"font-size:12px; margin:4px 0;"},`${b.id} — ${b.title} (${b.implemented?"implemented":"not implemented"}, ops=${b.opCount})`));h.appendChild(v),d.appendChild(h)}function r(){o||(o=!0,t.builderImportFileEl.addEventListener("change",()=>{var u;(u=t.builderImportFileEl.files)==null||u[0]}),t.btnBuilderExportEl.addEventListener("click",()=>{i.onExport()}),t.builderImportFileEl.addEventListener("change",()=>{var d;const u=((d=t.builderImportFileEl.files)==null?void 0:d[0])??null;u&&(i.onImportFile(u),t.builderImportFileEl.value="")}))}function g(){n||(n=!0,s())}function f(u){t.builderStatusEl.textContent=u.statusText||"Idle",p(u.pipelines)}function m(){n=!1,o=!1,l(),a==null||a.remove(),a=null}return{bind:r,mount:g,render:f,dispose:m}}function uo(e,t){const i=new Blob([t],{type:"application/json;charset=utf-8"}),n=URL.createObjectURL(i),o=document.createElement("a");o.href=n,o.download=e,o.rel="noopener",o.click(),setTimeout(()=>URL.revokeObjectURL(n),500)}function go(e,t){const i=lo();let n=!1,o="Idle",a=[];const s=co({dom:e,handlers:{onImportFile:async h=>{try{o=`Importing: ${h.name}`,r();const v=await h.text(),b=await i.importFromJsonText(v);V({scope:"panel",kind:"info",message:`Builder import: imported=${b.imported}, skipped=${b.skipped}, total=${b.totalInFile}`}),o=`Imported ${b.imported} pipeline(s) (skipped ${b.skipped}).`,await l()}catch(v){const b=v instanceof Error?v.message:String(v);V({scope:"panel",kind:"error",message:`Builder import failed: ${b}`}),Y({scope:"panel",kind:"error",message:"Builder import failed",meta:{error:b}}),o=`Import failed: ${b}`,r()}},onExport:async()=>{try{o="Exporting…",r();const h=await i.exportToJsonText();uo("beemage-user-pipelines.json",h),V({scope:"panel",kind:"info",message:"Builder export: downloaded beemage-user-pipelines.json"}),o="Exported.",r()}catch(h){const v=h instanceof Error?h.message:String(h);V({scope:"panel",kind:"error",message:`Builder export failed: ${v}`}),Y({scope:"panel",kind:"error",message:"Builder export failed",meta:{error:v}}),o=`Export failed: ${v}`,r()}}}});async function l(){const h=await i.listUserPipelines().catch(()=>[]);a=h,o=`Ready. User pipelines: ${h.length}`,r()}function p(){return{statusText:o,pipelines:(a??[]).map(h=>({id:String(h.id),title:String(h.title),implemented:!!h.implemented,opCount:Array.isArray(h.ops)?h.ops.length:0}))}}function r(){s.mount(),s.render(p())}function g(){s.bind(),e.builderStatusEl.textContent="Idle"}async function f(){n=!0,o="Loading…",r(),await l()}async function m(){n&&(o="Refreshing…",r(),await l())}function u(){n=!1}function d(){s.dispose()}return{bind:g,mount:f,refresh:m,unmount:u,dispose:d}}async function po(){const e=pn();await Be().catch(()=>null);const t=mn();t.start();const i=En();globalThis.__APP__={...globalThis.__APP__,cache:i};const n=ki({getRuntimeAvailability:()=>({opencvReady:!1}),debugTraceAppend:f=>Y({scope:"panel",kind:"debug",message:f}),actionLogAppend:f=>V({scope:"panel",kind:"info",message:f})});n.mount({mountEl:e.tuningMountEl,scopeRootId:"app"});const o=On(e),a=Kn(e),s=so(e,t,n),l=mi(e,t),p=wi(e),r=go(e);o.bind(),s.bind(),a.bind(),l.bind(),p.bind(),r.bind();const g=wn(e,{image:o,pipeline:s,builder:r,colors:a,settings:l,logs:p});g.bind(),g.boot()}po();
