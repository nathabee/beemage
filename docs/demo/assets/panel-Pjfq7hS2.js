function It(){function e(me,Mt){if(!me)throw new Error(`[dom] Missing #${Mt}`);return me}const t=e(document.getElementById("appRoot"),"appRoot"),n=e(document.getElementById("tabContour"),"tabContour"),o=e(document.getElementById("tabColors"),"tabColors"),s=e(document.getElementById("tabSettings"),"tabSettings"),c=e(document.getElementById("tabLogs"),"tabLogs"),g=e(document.getElementById("tabSegmentation"),"tabSegmentation"),u=e(document.getElementById("viewContour"),"viewContour"),f=e(document.getElementById("viewColors"),"viewColors"),i=e(document.getElementById("viewSettings"),"viewSettings"),b=e(document.getElementById("viewLogs"),"viewLogs"),h=e(document.getElementById("viewSegmentation"),"viewSegmentation"),v=e(document.getElementById("dropZone"),"dropZone"),l=e(document.getElementById("fileInput"),"fileInput"),a=e(document.getElementById("btnProcess"),"btnProcess"),r=e(document.getElementById("btnClean"),"btnClean"),d=e(document.getElementById("btnDownload"),"btnDownload"),y=e(document.getElementById("contourStatus"),"contourStatus"),p=e(document.getElementById("contourSpinner"),"contourSpinner"),E=e(document.getElementById("srcCanvas"),"srcCanvas"),m=e(document.getElementById("outCanvas"),"outCanvas"),C=e(document.getElementById("clean1Canvas"),"clean1Canvas"),S=e(document.getElementById("clean2Canvas"),"clean2Canvas"),x=e(document.getElementById("edgeThreshold"),"edgeThreshold"),w=e(document.getElementById("invertOutput"),"invertOutput"),T=e(document.getElementById("cleanMinArea"),"cleanMinArea"),k=e(document.getElementById("cleanRadius"),"cleanRadius"),L=e(document.getElementById("cleanBinaryThreshold"),"cleanBinaryThreshold"),N=e(document.getElementById("cleanQualityBadge"),"cleanQualityBadge"),M=e(document.getElementById("cleanQualityFill"),"cleanQualityFill"),I=e(document.getElementById("cleanQualityText"),"cleanQualityText"),R=e(document.getElementById("contourScale"),"contourScale"),F=e(document.getElementById("btnVectorize"),"btnVectorize"),O=e(document.getElementById("btnDownloadSvg"),"btnDownloadSvg"),G=e(document.getElementById("svgPreviewImg"),"svgPreviewImg"),z=e(document.getElementById("svgPreviewText"),"svgPreviewText"),Q=e(document.getElementById("pathSmoothIters"),"pathSmoothIters"),q=e(document.getElementById("btnSegLoadCv"),"btnSegLoadCv"),qe=e(document.getElementById("segSpinner"),"segSpinner"),Ge=e(document.getElementById("segStatus"),"segStatus"),Qe=e(document.getElementById("segCvReport"),"segCvReport"),He=e(document.getElementById("colorsCanvas"),"colorsCanvas"),Ke=e(document.getElementById("palette"),"palette"),We=e(document.getElementById("btnColorsApply"),"btnColorsApply"),Je=e(document.getElementById("btnColorsCancel"),"btnColorsCancel"),Ye=e(document.getElementById("btnColorsReset"),"btnColorsReset"),Xe=e(document.getElementById("edgesDark"),"edgesDark"),Ze=e(document.getElementById("edgeMaskThreshold"),"edgeMaskThreshold"),et=e(document.getElementById("edgeDilate"),"edgeDilate"),tt=e(document.getElementById("maxRegionPx"),"maxRegionPx"),nt=e(document.getElementById("colorsStatus"),"colorsStatus"),ot=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),at=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),st=e(document.getElementById("devConfigDetails"),"devConfigDetails"),rt=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),it=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),lt=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),ct=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),ut=e(document.getElementById("logsCbDebug"),"logsCbDebug"),gt=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),dt=e(document.getElementById("cfgStatus"),"cfgStatus"),ft=e(document.getElementById("settingsVersion"),"settingsVersion"),bt=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),ht=e(document.getElementById("logsLimit"),"logsLimit"),vt=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),yt=e(document.getElementById("logsStatus"),"logsStatus"),Et=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),pt=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),mt=e(document.getElementById("btnLogsExport"),"btnLogsExport"),Ct=e(document.getElementById("btnLogsClear"),"btnLogsClear"),wt=e(document.getElementById("logsOut"),"logsOut"),St=e(document.getElementById("debugLimit"),"debugLimit"),xt=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),Dt=e(document.getElementById("btnDebugExport"),"btnDebugExport"),kt=e(document.getElementById("btnDebugClear"),"btnDebugClear"),Tt=e(document.getElementById("debugStatus"),"debugStatus"),Lt=e(document.getElementById("debugOut"),"debugOut");return{rootEl:t,tabContour:n,tabColors:o,tabSettings:s,tabLogs:c,tabSegmentation:g,viewContour:u,viewSegmentation:h,viewColors:f,viewSettings:i,viewLogs:b,dropZoneEl:v,fileInputEl:l,btnProcessEl:a,btnCleanEl:r,btnDownloadEl:d,contourStatusEl:y,contourSpinnerEl:p,srcCanvasEl:E,outCanvasEl:m,clean1CanvasEl:C,clean2CanvasEl:S,edgeThresholdEl:x,invertOutputEl:w,cleanMinAreaEl:T,cleanRadiusEl:k,cleanBinaryThresholdEl:L,cleanQualityBadgeEl:N,cleanQualityFillEl:M,cleanQualityTextEl:I,btnVectorizeEl:F,btnDownloadSvgEl:O,svgPreviewImgEl:G,svgPreviewTextEl:z,contourScaleEl:R,pathSmoothItersEl:Q,btnSegLoadCv:q,segSpinner:qe,segStatus:Ge,segCvReport:Qe,colorsCanvasEl:He,paletteEl:Ke,btnColorsApplyEl:We,btnColorsCancelEl:Je,btnColorsResetEl:Ye,edgesDarkEl:Xe,edgeMaskThresholdEl:Ze,edgeDilateEl:et,maxRegionPxEl:tt,colorsStatusEl:nt,cfgShowDevToolsEl:ot,settingsGeneralStatusEl:at,devConfigDetailsEl:st,cfgTraceConsoleEl:rt,cfgActionLogMaxEl:it,cfgDebugTraceMaxEl:lt,cfgFailureLogsPerRunEl:ct,logsCbDebugEl:ut,btnCfgResetDefaults:gt,cfgStatusEl:dt,settingsVersionEl:ft,settingsGitHubLinkEl:bt,logsLimitEl:ht,btnLogsRefresh:vt,logsStatusEl:yt,logsTrimKeepEl:Et,btnLogsTrim:pt,btnLogsExport:mt,btnLogsClear:Ct,logsOutEl:wt,debugLimitEl:St,btnDebugRefresh:xt,btnDebugExport:Dt,btnDebugClear:kt,debugStatusEl:Tt,debugOutEl:Lt}}const Bt=new Set;function Rt(e){Bt.add(e)}function At(){const e=new Set;function t(o){return e.add(o),()=>e.delete(o)}function n(){Rt(s=>{for(const c of e)c(s)})}return{on:t,start:n}}function Pt(e,t){const n={segmentation:e.tabSegmentation,contour:e.tabContour,colors:e.tabColors,settings:e.tabSettings,logs:e.tabLogs},o={segmentation:e.viewSegmentation,contour:e.viewContour,colors:e.viewColors,settings:e.viewSettings,logs:e.viewLogs};let s="contour";const c=new Set;function g(){const v=globalThis;v.__bctGlobalErrorHooksInstalled||(v.__bctGlobalErrorHooksInstalled=!0,window.addEventListener("error",l=>{console.error("[panel] window error",l)}),window.addEventListener("unhandledrejection",l=>{console.error("[panel] unhandledrejection",l)}),console.log("[panel] global error hooks installed"))}g();function u(v){Object.keys(n).forEach(l=>{const a=l===v;n[l].classList.toggle("is-active",a),n[l].setAttribute("aria-selected",a?"true":"false"),o[l].hidden=!a,o[l].classList.toggle("is-active",a)})}function f(v){var l,a,r,d,y,p,E,m;if(v===s){(a=(l=t[v]).refresh)==null||a.call(l);return}(d=(r=t[s]).unmount)==null||d.call(r),s=v,u(s),c.has(s)?(m=(E=t[s]).refresh)==null||m.call(E):(c.add(s),(p=(y=t[s]).mount)==null||p.call(y))}function i(){n.contour.addEventListener("click",v=>{var l;(l=v.preventDefault)==null||l.call(v),f("contour")}),n.segmentation.addEventListener("click",v=>{var l;(l=v.preventDefault)==null||l.call(v),f("segmentation")}),n.colors.addEventListener("click",v=>{var l;(l=v.preventDefault)==null||l.call(v),f("colors")}),n.settings.addEventListener("click",v=>{var l;(l=v.preventDefault)==null||l.call(v),f("settings")}),n.logs.addEventListener("click",v=>{var l;(l=v.preventDefault)==null||l.call(v),f("logs")})}function b(){var v,l,a,r;s="contour",u(s),Object.keys(t).forEach(d=>{var y,p;return(p=(y=t[d]).boot)==null?void 0:p.call(y)}),c.has(s)?(r=(a=t[s]).refresh)==null||r.call(a):(c.add(s),(l=(v=t[s]).mount)==null||l.call(v))}function h(){Object.keys(t).forEach(v=>{var l,a;return(a=(l=t[v]).dispose)==null?void 0:a.call(l)})}return{bind:i,boot:b,activate:f,dispose:h}}function Ce(e){const t=e.items.length;return{items:e.items,counts:{items:t},meta:e.meta}}function $t(){const e={items:[],meta:{}},t=new Set;function n(){const i=Ce(e);for(const b of t)try{b(i)}catch{}}function o(){return Ce(e)}function s(i){t.add(i);try{i(o())}catch{}return()=>t.delete(i)}function c(){e.items=[],e.meta={},n()}function g(i){e.meta.scopeUpdatedSince=i,n()}function u(){return String(e.meta.scopeUpdatedSince||"")}function f(i,b){e.items=i.slice(),e.meta.updatedTs=Date.now(),typeof(b==null?void 0:b.limit)=="number"&&(e.meta.limit=b.limit),n()}return{getSnapshot:o,subscribe:s,getScopeUpdatedSince:u,clearAll:c,setScopeUpdatedSince:g,setItems:f}}function Ot(){return{loadedImageName:null,hasImage:!1,hasOutput:!1,edgeMask:void 0,repairedMask:void 0,smoothedMask:void 0,svgText:void 0}}function Vt(e){e.loadedImageName=null,e.hasImage=!1,e.hasOutput=!1,e.edgeMask=void 0,e.repairedMask=void 0,e.smoothedMask=void 0,e.svgText=void 0}function Be(e,t,n){const o=new Uint8Array(e.length);function s(d,y){return y*t+d}function c(d,y){return d<0||y<0||d>=t||y>=n?!1:e[s(d,y)]===1}let g=0,u=0,f=0,i=0,b=0;const h=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];for(let d=0;d<n;d++)for(let y=0;y<t;y++){if(!c(y,d))continue;g++;let p=0,E=!1;for(const[m,C]of h)c(y+m,d+C)?p++:E=!0;E&&u++,p===1?f++:p>=3&&i++}const v=[[-1,0],[1,0],[0,-1],[0,1]],l=new Int32Array(e.length),a=new Int32Array(e.length);for(let d=0;d<n;d++)for(let y=0;y<t;y++){const p=s(y,d);if(e[p]===0||o[p]===1)continue;b++,o[p]=1;let E=0,m=0;for(l[m]=y,a[m]=d,m++;E<m;){const C=l[E],S=a[E];E++;for(const[x,w]of v){const T=C+x,k=S+w;if(T<0||k<0||T>=t||k>=n)continue;const L=s(T,k);e[L]===0||o[L]===1||(o[L]=1,l[m]=T,a[m]=k,m++)}}}const r=g/Math.max(1,u);return{onPixels:g,boundaryPixels:u,components:b,endpoints:f,junctions:i,thicknessRatio:r}}function Ft(e,t){function n(l){e.contourStatusEl.textContent=l}function o(l,a){e.contourSpinnerEl.classList.toggle("is-hidden",!l),a&&n(a)}function s(){e.btnProcessEl.disabled=!t.hasImage,e.btnDownloadEl.disabled=!t.hasOutput,e.btnCleanEl.disabled=!t.hasOutput,e.btnVectorizeEl.disabled=!t.smoothedMask,e.btnDownloadSvgEl.disabled=!t.svgText}function c(){t.svgText=void 0,e.svgPreviewTextEl.textContent="",e.svgPreviewImgEl.removeAttribute("src")}function g(){const l=e.srcCanvasEl.getContext("2d"),a=e.outCanvasEl.getContext("2d");l.clearRect(0,0,e.srcCanvasEl.width,e.srcCanvasEl.height),a.clearRect(0,0,e.outCanvasEl.width,e.outCanvasEl.height);const r=e.clean1CanvasEl.getContext("2d"),d=e.clean2CanvasEl.getContext("2d");r.clearRect(0,0,e.clean1CanvasEl.width,e.clean1CanvasEl.height),d.clearRect(0,0,e.clean2CanvasEl.width,e.clean2CanvasEl.height)}function u(){const l=e.clean1CanvasEl.getContext("2d"),a=e.clean2CanvasEl.getContext("2d");l.clearRect(0,0,e.clean1CanvasEl.width,e.clean1CanvasEl.height),a.clearRect(0,0,e.clean2CanvasEl.width,e.clean2CanvasEl.height)}function f(l,a){const r=Number(l.value);return Number.isFinite(r)?r:a}function i(l,a){const r=a instanceof Error?a.message:String(a);n(`${l} failed: ${r}`),o(!1),console.error(`[BeeContour] ${l} failed`,a)}function b(l,a){if(!t.smoothedMask){e.cleanQualityBadgeEl.textContent="—",e.cleanQualityBadgeEl.className="qBadge qBadge--off",e.cleanQualityFillEl.style.width="0%",e.cleanQualityTextEl.textContent="";return}const r=Be(t.smoothedMask,l,a),d=(T,k)=>Math.max(0,Math.min(1,T/Math.max(1,k))),y=d(r.components,800),p=d(r.endpoints,3e3),E=d(r.junctions,1500),m=r.thicknessRatio>5?1:r.thicknessRatio>3?.5:0,C=Math.round(100*(1-(.45*y+.45*p+.1*E)-.1*m)),S=Math.max(0,Math.min(100,C));let x="qBadge qBadge--bad",w=`Bad ${S}`;S>=70?(x="qBadge qBadge--ok",w=`Good ${S}`):S>=45&&(x="qBadge qBadge--warn",w=`OK ${S}`),e.cleanQualityBadgeEl.className=x,e.cleanQualityBadgeEl.textContent=w,e.cleanQualityFillEl.style.width=`${S}%`,e.cleanQualityTextEl.textContent=`CC:${r.components} end:${r.endpoints} j:${r.junctions} thick:${r.thicknessRatio.toFixed(2)}`}function h(){if(!t.hasOutput)return;const a=`${(t.loadedImageName||"beecontour").replace(/\.[a-z0-9]+$/i,"").replace(/[^a-z0-9-_]+/gi,"_")}_contour.png`,r=e.outCanvasEl.toDataURL("image/png"),d=document.createElement("a");d.href=r,d.download=a,document.body.appendChild(d),d.click(),d.remove(),n(`Downloaded: ${a}`)}function v(){if(!t.svgText)return;const a=`${(t.loadedImageName||"beecontour").replace(/\.[a-z0-9]+$/i,"").replace(/[^a-z0-9-_]+/gi,"_")}_contour.svg`,r=new Blob([t.svgText],{type:"image/svg+xml;charset=utf-8"}),d=URL.createObjectURL(r),y=document.createElement("a");y.href=d,y.download=a,document.body.appendChild(y),y.click(),y.remove(),URL.revokeObjectURL(d),n(`Downloaded: ${a}`)}return{setStatus:n,setContourBusyVisual:o,updateEnabled:s,clearSvgPreview:c,clearCanvases:g,clearCleanCanvasesOnly:u,getNumber:f,showError:i,updateCleanQualityUI:b,downloadPng:h,downloadSvg:v}}const Nt=new Set;function Re(e){for(const t of Nt)t(e,"local")}function K(e){const t=localStorage.getItem(e);if(t!==null)try{return JSON.parse(t)}catch{return t}}function Ut(e,t){localStorage.setItem(e,JSON.stringify(t))}async function Y(e){if(typeof e=="string")return{[e]:K(e)};if(Array.isArray(e)){const n={};for(const o of e)n[o]=K(o);return n}const t={};for(const[n,o]of Object.entries(e))t[n]=localStorage.getItem(n)!==null?K(n):o;return t}async function X(e){const t={};for(const[n,o]of Object.entries(e)){const s=K(n);Ut(n,o),t[n]={oldValue:s,newValue:o}}Re(t)}async function Ee(e){const t=Array.isArray(e)?e:[e],n={};for(const o of t){const s=K(o);localStorage.removeItem(o),n[o]={oldValue:s,newValue:void 0}}Re(n)}const W="beecontour.debugTrace",fe="beecontour.debugTrace.enabled",jt=2e3;function _t(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function be(e,t,n){return Math.max(t,Math.min(n,Math.floor(e)))}async function te(){const e=await Y(W),t=e==null?void 0:e[W];return Array.isArray(t)?t:[]}async function zt(e){await X({[W]:e})}async function pe(){const e=await Y(fe);return!!(e!=null&&e[fe])}async function Ae(e){await X({[fe]:!!e}),e||await Ee(W)}async function Pe(){await Ee(W)}async function $e(e,t){if(!await pe())return{total:0};const o=be((t==null?void 0:t.max)??jt,100,5e4),s=(Array.isArray(e)?e:[e]).map(f=>({...f,id:_t(),ts:Date.now()}));if(!s.length)return{total:(await te()).length};const g=(await te()).concat(s),u=g.length>o?g.slice(g.length-o):g;return await zt(u),{total:u.length}}async function Oe(e){const t=be((e==null?void 0:e.limit)??200,1,5e4),n=be((e==null?void 0:e.offset)??0,0,1e6),o=(e==null?void 0:e.reverse)??!0,s=await te(),c=s.length,u=(o?s.slice().reverse():s).slice(n,n+t);return{total:c,items:u}}async function Ve(e){const t=await te();return JSON.stringify(t,null,e!=null&&e.pretty?2:0)}const Fe=Object.freeze(Object.defineProperty({__proto__:null,append:$e,clear:Pe,exportJson:Ve,isEnabled:pe,list:Oe,setEnabled:Ae},Symbol.toStringTag,{value:"Module"}));function re(e){return`[BCT][${e}]`}function qt(e){function t(...c){e.traceOn()&&console.log(re("trace"),...c)}function n(...c){console.warn(re("warn"),...c)}function o(...c){console.error(re("error"),...c)}function s(c,g){t(c,g),$e({scope:e.scope,kind:"debug",message:c,meta:g})}return{logTrace:t,logWarn:n,logError:o,traceScope:s}}function _(e,t,n,o){const s=Number(String(e??"").trim());return Number.isFinite(s)?Math.max(t,Math.min(n,Math.floor(s))):o}const he="beecontour.devConfig",$={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let ve=!1,ne={...$};function Ne(e){const t=e||{};return{traceConsole:!!t.traceConsole,actionLogMax:_(t.actionLogMax??$.actionLogMax,100,5e4,$.actionLogMax),debugTraceMax:_(t.debugTraceMax??$.debugTraceMax,100,5e4,$.debugTraceMax),failureLogsPerRun:_(t.failureLogsPerRun??$.failureLogsPerRun,0,5e4,$.failureLogsPerRun)}}async function we(){if(ve)return;const e=await Y([he]).catch(()=>({}));ne=Ne(e==null?void 0:e[he]),ve=!0}function ye(){return ne}async function Ue(e){ne=Ne(e),ve=!0,await X({[he]:ne}).catch(()=>null)}async function Gt(){await Ue({...$})}const{logTrace:D,logWarn:j,logError:V,traceScope:P}=qt({scope:"panel",traceOn:()=>!!ye().traceConsole});let B=0;function A(){return B>0}function U(e,t){if(t){je(e);return}B=0,oe(e,!1)}async function Z(e,t){const n=`${Date.now()}-${Math.random().toString(16).slice(2)}`;D("[state] withBusy: enter",{id:n,busyCount:B}),je(e,n);try{D("[state] withBusy: before await fn",{id:n,busyCount:B});const o=await t();return D("[state] withBusy: after await fn (resolved)",{id:n,busyCount:B}),o}catch(o){throw V("[state] withBusy: fn threw",{id:n,busyCount:B,msg:String((o==null?void 0:o.message)??o),stack:String((o==null?void 0:o.stack)??"")}),o}finally{D("[state] withBusy: finally before endBusy",{id:n,busyCount:B}),Qt(e,n),D("[state] withBusy: finally after endBusy",{id:n,busyCount:B})}}function je(e,t){B++,D("[state] beginBusy",{id:t,busyCount:B}),B===1&&oe(e,!0)}function Qt(e,t){if(B--,D("[state] endBusy: dec",{id:t,busyCount:B}),B<=0){B=0,D("[state] endBusy: applying busy=false",{id:t,busyCount:B}),oe(e,!1);return}B===0&&(D("[state] endBusy: applying busy=false (redundant branch)",{id:t,busyCount:B}),oe(e,!1))}function oe(e,t){e.rootEl.classList.toggle("is-busy",t),e.cfgShowDevToolsEl.disabled=!1,e.fileInputEl.disabled=t,e.btnProcessEl.disabled=t,e.btnCleanEl.disabled=t,e.btnDownloadEl.disabled=t,e.edgeThresholdEl.disabled=t,e.invertOutputEl.disabled=t,e.cleanMinAreaEl.disabled=t,e.cleanRadiusEl.disabled=t,e.cleanBinaryThresholdEl.disabled=t,e.btnVectorizeEl.disabled=t,e.btnDownloadSvgEl.disabled=t,e.contourScaleEl.disabled=t,e.btnSegLoadCv.disabled=t,e.cfgTraceConsoleEl.disabled=t,e.cfgActionLogMaxEl.disabled=t,e.cfgDebugTraceMaxEl.disabled=t,e.cfgFailureLogsPerRunEl.disabled=t,e.btnCfgResetDefaults.disabled=t,e.logsCbDebugEl.disabled=t,e.logsLimitEl.disabled=t,e.btnLogsRefresh.disabled=t,e.logsTrimKeepEl.disabled=t,e.btnLogsTrim.disabled=t,e.btnLogsExport.disabled=t,e.btnLogsClear.disabled=t,e.debugLimitEl.disabled=t,e.btnDebugRefresh.disabled=t,e.btnDebugExport.disabled=t,e.btnDebugClear.disabled=t,e.btnColorsApplyEl.disabled=t,e.btnColorsCancelEl.disabled=t,e.btnColorsResetEl.disabled=t,e.edgesDarkEl.disabled=t,e.edgeMaskThresholdEl.disabled=t,e.edgeDilateEl.disabled=t,e.maxRegionPxEl.disabled=t;for(const n of Array.from(e.paletteEl.querySelectorAll("button")))n.disabled=t;e.colorsCanvasEl.style.pointerEvents=t?"none":"auto"}function ee(e,t,n){return Number.isFinite(e)?Math.max(t,Math.min(n,e|0)):t}function Se(e,t,n,o){const s=new ImageData(t,n),c=s.data;for(let g=0,u=0;g<e.length;g++,u+=4){const f=e[g]===1;if(o){const i=f?0:255;c[u]=i,c[u+1]=i,c[u+2]=i,c[u+3]=255}else{const i=f?255:0;c[u]=i,c[u+1]=i,c[u+2]=i,c[u+3]=255}}return s}function ie(e,t,n,o){const s=new Uint8Array(e.length),c=Math.max(1,o);for(let g=0;g<n;g++)for(let u=0;u<t;u++){let f=0;for(let i=-c;i<=c&&!f;i++){const b=g+i;if(b<0||b>=n)continue;const h=b*t;for(let v=-c;v<=c;v++){const l=u+v;if(!(l<0||l>=t)&&e[h+l]===1){f=1;break}}}s[g*t+u]=f}return s}function le(e,t,n,o){const s=new Uint8Array(e.length),c=Math.max(1,o);for(let g=0;g<n;g++)for(let u=0;u<t;u++){let f=1;for(let i=-c;i<=c&&f;i++){const b=g+i;if(b<0||b>=n){f=0;break}const h=b*t;for(let v=-c;v<=c;v++){const l=u+v;if(l<0||l>=t){f=0;break}if(e[h+l]===0){f=0;break}}}s[g*t+u]=f}return s}function Ht(e,t,n,o){const s=new Uint8Array(e),c=new Uint8Array(e.length),g=new Int32Array(e.length),u=new Int32Array(e.length);for(let f=0;f<n;f++)for(let i=0;i<t;i++){const b=f*t+i;if(e[b]===0||c[b]===1)continue;let h=0,v=0;c[b]=1,g[v]=i,u[v]=f,v++;const l=[b];for(;h<v;){const a=g[h],r=u[h];h++;const d=[[a-1,r],[a+1,r],[a,r-1],[a,r+1]];for(const[y,p]of d){if(y<0||y>=t||p<0||p>=n)continue;const E=p*t+y;e[E]===0||c[E]===1||(c[E]=1,g[v]=y,u[v]=p,v++,l.push(E))}}if(l.length<o)for(const a of l)s[a]=0}return s}async function xe(e,t,n,o){const{setStatus:s,setContourBusyVisual:c,clearCanvases:g,clearCleanCanvasesOnly:u,clearSvgPreview:f,updateEnabled:i,getNumber:b}=o;if(!n.type.startsWith("image/")){s("Unsupported file type (please drop an image)."),j("Contour load: rejected non-image file",{name:n.name,type:n.type,size:n.size}),P("Contour load: rejected non-image file",{name:n.name,type:n.type,size:n.size});return}const h=performance.now();await Z(e,async()=>{c(!0,"Loading image…"),t.loadedImageName=n.name||"image";const v=URL.createObjectURL(n);P("Contour load: start",{name:n.name,type:n.type,size:n.size});try{const l=await new Promise((S,x)=>{const w=new Image;w.onload=()=>S(w),w.onerror=()=>x(new Error("Failed to load image")),w.src=v}),a=e.srcCanvasEl,r=a.getContext("2d");if(!r){V("Contour load: missing 2D context",{canvasId:"srcCanvasEl"}),s("Load failed — canvas context not available.");return}g();const d=ee(b(e.contourScaleEl,100),10,100),y=d/100;let p=Math.max(64,Math.floor(l.naturalWidth*y)),E=Math.max(64,Math.floor(l.naturalHeight*y));const m=1600,C=Math.min(1,m/Math.max(p,E));p=Math.max(64,Math.floor(p*C)),E=Math.max(64,Math.floor(E*C)),a.width=p,a.height=E,r.imageSmoothingEnabled=!0,r.clearRect(0,0,a.width,a.height),r.drawImage(l,0,0,a.width,a.height),t.hasImage=!0,t.hasOutput=!1,t.edgeMask=void 0,t.repairedMask=void 0,t.smoothedMask=void 0,t.svgText=void 0,f(),u(),i(),s(`Loaded: ${t.loadedImageName} (${a.width}×${a.height})`),P("Contour load: done",{naturalW:l.naturalWidth,naturalH:l.naturalHeight,scalePct:d,maxSide:m,targetW:p,targetH:E,pixels:p*E,ms:Math.round((performance.now()-h)*10)/10})}catch(l){V("Contour load: exception",{error:l instanceof Error?l.message:String(l)}),s("Load failed — see console / debug trace.")}finally{URL.revokeObjectURL(v),c(!1)}})}async function Kt(e,t,n){const{setStatus:o,setContourBusyVisual:s,clearCleanCanvasesOnly:c,clearSvgPreview:g,updateEnabled:u,getNumber:f}=n;if(!t.hasImage){j("Contour process: skipped (no image loaded)");return}const i=performance.now();await Z(e,async()=>{s(!0,"Processing…"),await new Promise(b=>{setTimeout(()=>{(async()=>{try{const h=e.srcCanvasEl,v=e.outCanvasEl,l=h.width,a=h.height,r=l*a,d=Math.max(1,Math.min(255,f(e.edgeThresholdEl,70))),y=e.invertOutputEl.checked;P("Contour process: start",{width:l,height:a,pixels:r,threshold:d,whiteBg:y}),v.width=l,v.height=a;const p=v.getContext("2d",{willReadFrequently:!0}),E=h.getContext("2d",{willReadFrequently:!0});if(!E||!p){V("Contour process: missing 2D context",{hasSrc:!!E,hasOut:!!p}),o("Process failed — canvas context not available.");return}const C=E.getImageData(0,0,l,a).data,S=new Uint8ClampedArray(l*a);for(let M=0,I=0;M<C.length;M+=4,I++){const R=C[M],F=C[M+1],O=C[M+2];S[I]=.299*R+.587*F+.114*O|0}const x=[-1,0,1,-2,0,2,-1,0,1],w=[-1,-2,-1,0,0,0,1,2,1],T=new Uint8ClampedArray(l*a);for(let M=1;M<a-1;M++)for(let I=1;I<l-1;I++){let R=0,F=0,O=0;for(let z=-1;z<=1;z++)for(let Q=-1;Q<=1;Q++){const q=S[(M+z)*l+(I+Q)];R+=q*x[O],F+=q*w[O],O++}const G=Math.min(255,Math.sqrt(R*R+F*F)|0);T[M*l+I]=G>=d?255:0}const k=p.createImageData(l,a),L=k.data;let N=0;for(let M=0,I=0;M<T.length;M++,I+=4){const R=T[M];if(R===255&&N++,y){const O=R===255?0:255;L[I]=O,L[I+1]=O,L[I+2]=O,L[I+3]=255}else L[I]=R,L[I+1]=R,L[I+2]=R,L[I+3]=255}p.putImageData(k,0,0),t.hasOutput=!0,t.edgeMask=void 0,t.repairedMask=void 0,t.smoothedMask=void 0,g(),c(),o("Done. You can clean/smooth or download the PNG."),P("Contour process: done",{width:l,height:a,pixels:r,threshold:d,whiteBg:y,edgePixels:N,edgeRatio:Math.round(N/Math.max(1,r)*1e6)/1e6,ms:Math.round((performance.now()-i)*10)/10})}catch(h){V("Contour process: exception",{error:h instanceof Error?h.message:String(h)}),o("Process failed — see console / debug trace.")}finally{b()}})()},0)}),s(!1),u()})}async function Wt(e,t,n){const{setStatus:o,setContourBusyVisual:s,clearSvgPreview:c,updateEnabled:g,getNumber:u,updateCleanQualityUI:f}=n;if(!t.hasOutput){j("Contour clean: skipped (no output present)");return}const i=performance.now();await Z(e,async()=>{s(!0,"Cleaning…"),await new Promise(b=>{setTimeout(()=>{(async()=>{try{const h=e.outCanvasEl,v=e.clean1CanvasEl,l=e.clean2CanvasEl;P("Contour clean: raw inputs",{cleanRadiusVal:e.cleanRadiusEl.value,cleanMinAreaVal:e.cleanMinAreaEl.value,cleanBinaryThresholdVal:e.cleanBinaryThresholdEl.value});const a=ee(u(e.cleanRadiusEl,1),1,3),r=ee(u(e.cleanMinAreaEl,12),0,500),d=ee(u(e.cleanBinaryThresholdEl,128),1,254);v.width=h.width,v.height=h.height,l.width=h.width,l.height=h.height;const y=h.width,p=h.height,E=y*p,m=e.invertOutputEl.checked;P("Contour clean: start",{width:y,height:p,pixels:E,whiteBg:m,EDGE_T:d,minArea:r,radius:a});const C=h.getContext("2d",{willReadFrequently:!0}),S=v.getContext("2d",{willReadFrequently:!0}),x=l.getContext("2d",{willReadFrequently:!0});if(!C||!S||!x){V("Contour clean: missing 2D context",{hasOut:!!C,hasC1:!!S,hasC2:!!x}),o("Clean failed — canvas context not available.");return}const T=C.getImageData(0,0,y,p).data,k=new Uint8Array(y*p);let L=0;for(let O=0,G=0;O<k.length;O++,G+=4){const z=T[G],q=(m?z<d:z>=d)?1:0;k[O]=q,q===1&&L++}P("Contour removeSmallComponents: params",{edge:k,width:y,height:p,minArea:r});const N=Ht(k,y,p,r);P("Contour erode : params",{edgeNoSpeck:N,width:y,height:p,radius:a});const M=le(ie(N,y,p,a),y,p,a);S.putImageData(Se(M,y,p,m),0,0),P("Contour dilate : params",{repaired:M,width:y,height:p,radius:a});const I=ie(le(M,y,p,a),y,p,a);P("Contour erode : params",{opened:I,width:y,height:p,radius:a});const R=le(ie(I,y,p,a),y,p,a);x.putImageData(Se(R,y,p,m),0,0),t.edgeMask=k,t.repairedMask=M,t.smoothedMask=R,c();const F=Be(R,y,p);f(y,p),o(`Clean done — CC:${F.components} endpoints:${F.endpoints} junctions:${F.junctions} thickness:${F.thicknessRatio.toFixed(2)}`),P("Contour clean: done",{width:y,height:p,pixels:E,whiteBg:m,EDGE_T:d,minArea:r,radius:a,edgeOn:L,edgeRatio:Math.round(L/Math.max(1,E)*1e6)/1e6,quality:F,ms:Math.round((performance.now()-i)*10)/10})}catch(h){V("Contour clean: exception",{error:h instanceof Error?h.message:String(h)}),o("Clean failed — see console / debug trace.")}finally{b()}})()},0)}),s(!1),g()})}function Jt(e,t,n){const o=new Uint8Array(e.length),s=[];function c(l,a){return a*t+l}function g(l,a){return l<0||a<0||l>=t||a>=n?!1:e[c(l,a)]===1}function u(l,a){if(!g(l,a))return!1;for(let r=-1;r<=1;r++)for(let d=-1;d<=1;d++)if(!(d===0&&r===0)&&!g(l+d,a+r))return!0;return!1}const f=[{dx:1,dy:0},{dx:1,dy:1},{dx:0,dy:1},{dx:-1,dy:1},{dx:-1,dy:0},{dx:-1,dy:-1},{dx:0,dy:-1},{dx:1,dy:-1}],i=2e3,b=Math.max(2e3,Math.floor((t+n)*2)),h=Math.max(2e5,Math.floor(t*n*.25));let v=0;for(let l=0;l<n;l++)for(let a=0;a<t;a++){if(s.length>=i||v>=h)return s;const r=c(a,l);if(o[r]===1||!u(a,l))continue;const d=[];let y=a,p=l,E=4,m=0;const C=Math.min(t*n,b*4);for(;m<C;){m++;const S=c(y,p);if(o[S]===1||(d.push({x:y,y:p}),o[S]=1,v++,d.length>=b)||v>=h)break;let x=!1;const w=(E+6)%8;for(let T=0;T<8;T++){const k=(w+T)%8,L=y+f[k].dx,N=p+f[k].dy;if(!u(L,N))continue;const M=c(L,N);if(!(!(L===a&&N===l&&d.length>10)&&o[M]===1)){y=L,p=N,E=k,x=!0;break}}if(!x||y===a&&p===l&&d.length>10)break}d.length>=20&&s.push(d)}return s}function De(e,t){if(e.length<3)return e;const n=t*t;function o(i,b,h){const v=h.x-b.x,l=h.y-b.y,a=i.x-b.x,r=i.y-b.y,d=v*a+l*r;if(d<=0)return(i.x-b.x)**2+(i.y-b.y)**2;const y=v*v+l*l;if(y<=d)return(i.x-h.x)**2+(i.y-h.y)**2;const p=d/y,E=b.x+p*v,m=b.y+p*l;return(i.x-E)**2+(i.y-m)**2}const s=new Uint8Array(e.length);s[0]=1,s[e.length-1]=1;const c=[0],g=[e.length-1];for(;c.length>0;){const i=c.pop(),b=g.pop();if(b<=i+1)continue;const h=e[i],v=e[b];let l=0,a=-1;for(let r=i+1;r<b;r++){const d=o(e[r],h,v);d>l&&(l=d,a=r)}a!==-1&&l>n&&(s[a]=1,c.push(i),g.push(a),c.push(a),g.push(b))}const u=[];for(let i=0;i<e.length;i++)s[i]===1&&u.push(e[i]);const f=[];for(const i of u){const b=f[f.length-1];(!b||b.x!==i.x||b.y!==i.y)&&f.push(i)}return f}function Yt(e,t){let n=e;for(let o=0;o<t;o++){if(n.length<3)return n;const s=[];for(let b=0;b<n.length-1;b++){const h=n[b],v=n[b+1];s.push({x:.75*h.x+.25*v.x,y:.75*h.y+.25*v.y},{x:.25*h.x+.75*v.x,y:.25*h.y+.75*v.y})}const c=n[0],g=n[n.length-1],u=c.x-g.x,f=c.y-g.y;if(u*u+f*f<=4){const b=n[n.length-1],h=n[0];s.push({x:.75*b.x+.25*h.x,y:.75*b.y+.25*h.y},{x:.25*b.x+.75*h.x,y:.25*b.y+.75*h.y})}n=s}return n}function Xt(e,t,n){const o=[];for(const s of e){const c=Zt(s);c&&o.push(`<path d="${c}" fill="none" stroke="#000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>`)}return`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${t}" height="${n}" viewBox="0 0 ${t} ${n}">
<rect x="0" y="0" width="${t}" height="${n}" fill="#fff"/>
`+o.join(`
`)+`
</svg>
`}function Zt(e){if(e.length<2)return"";const t=e.slice(),n=t[0],o=t[t.length-1],s=n.x-o.x,c=n.y-o.y,g=s*s+c*c<=4;g&&t.push({x:n.x,y:n.y});let u=`M ${t[0].x.toFixed(2)} ${t[0].y.toFixed(2)}`;for(let f=0;f<t.length-1;f++){const i=t[Math.max(0,f-1)],b=t[f],h=t[f+1],v=t[Math.min(t.length-1,f+2)],l=b.x+(h.x-i.x)/6,a=b.y+(h.y-i.y)/6,r=h.x-(v.x-b.x)/6,d=h.y-(v.y-b.y)/6;u+=` C ${l.toFixed(2)} ${a.toFixed(2)}, ${r.toFixed(2)} ${d.toFixed(2)}, ${h.x.toFixed(2)} ${h.y.toFixed(2)}`}return g&&(u+=" Z"),u}async function en(e,t,n){if(!t.smoothedMask){j("Contour vectorize: skipped (no smoothed mask present)");return}const o=performance.now();await Z(e,async()=>{n.setContourBusyVisual(!0,"Vectorizing…");const s=()=>{t.svgText=void 0,e.svgPreviewTextEl.textContent="",e.svgPreviewImgEl.removeAttribute("src")};try{await new Promise((c,g)=>{setTimeout(()=>{(async()=>{try{const u=t.smoothedMask,f=e.outCanvasEl.width,i=e.outCanvasEl.height,b=f*i,h=1.5,v=Math.max(0,Math.min(4,n.getNumber(e.pathSmoothItersEl,2)|0));P("Contour vectorize: start",{width:f,height:i,pixels:b,epsilon:h,smoothIters:v});const l=Jt(u,f,i),a=l.length,r=l.reduce((x,w)=>x+w.length,0),d=l.reduce((x,w)=>Math.max(x,w.length),0);if(a===0||r===0){j("Contour vectorize: no boundaries found",{width:f,height:i,pixels:b,pathsRaw:a,pointsRaw:r}),s(),n.setStatus("No boundaries found to vectorize."),c();return}if(a>2e3||r>2e5){j("Contour vectorize: aborted (too complex)",{width:f,height:i,pixels:b,pathsRaw:a,pointsRaw:r,maxPolyline:d}),s(),n.setStatus(`Vectorize aborted: too complex (paths ${a}, points ${r}). Try stronger clean / higher minArea / lower resolution.`),c();return}P("Contour vectorize: traced boundaries",{pathsRaw:a,pointsRaw:r,maxPolyline:d});const y=l.filter(x=>x.length>=20).map(x=>{const w=De(x,h),T=v>0?Yt(w,v):w;return De(T,h)}).filter(x=>x.length>=3),p=y.length,E=y.reduce((x,w)=>x+w.length,0),m=y.reduce((x,w)=>Math.max(x,w.length),0);if(p===0||E===0){j("Contour vectorize: simplified to nothing",{pathsRaw:a,pointsRaw:r,pathsOut:p,pointsOut:E,smoothIters:v,epsilon:h}),s(),n.setStatus("Vectorize produced no usable paths (after simplification)."),c();return}P("Contour vectorize: simplified",{pathsOut:p,pointsOut:E,maxOut:m,smoothIters:v,epsilon:h});const C=Xt(y,f,i);t.svgText=C,e.svgPreviewTextEl.textContent=C;const S=encodeURIComponent(C).replace(/'/g,"%27").replace(/"/g,"%22");e.svgPreviewImgEl.src=`data:image/svg+xml;charset=utf-8,${S}`,n.setStatus(`SVG generated: paths ${p}, points ${r}→${E}, smooth ${v}`),P("Contour vectorize: done",{width:f,height:i,pixels:b,smoothIters:v,epsilon:h,pathsRaw:a,pointsRaw:r,pathsOut:p,pointsOut:E,svgChars:C.length,ms:Math.round((performance.now()-o)*10)/10}),c()}catch(u){V("Contour vectorize: exception",{error:u instanceof Error?u.message:String(u),ms:Math.round((performance.now()-o)*10)/10}),g(u)}})()},0)})}catch(c){n.showError("Vectorize",c),s()}finally{n.setContourBusyVisual(!1),n.updateEnabled()}})}function tn(e,t){const n=Ot(),o=Ft(e,n);function s(){const f=e.dropZoneEl;function i(b){f.classList.toggle("is-hover",b)}f.addEventListener("dragover",b=>{b.preventDefault(),i(!0)}),f.addEventListener("dragleave",()=>i(!1)),f.addEventListener("drop",b=>{var v;b.preventDefault(),i(!1);const h=(v=b.dataTransfer)==null?void 0:v.files;!h||h.length===0||xe(e,n,h[0],{setStatus:o.setStatus,setContourBusyVisual:o.setContourBusyVisual,clearCanvases:o.clearCanvases,clearCleanCanvasesOnly:o.clearCleanCanvasesOnly,clearSvgPreview:o.clearSvgPreview,updateEnabled:o.updateEnabled,getNumber:o.getNumber})}),e.fileInputEl.addEventListener("change",()=>{var h;const b=(h=e.fileInputEl.files)==null?void 0:h[0];b&&(xe(e,n,b,{setStatus:o.setStatus,setContourBusyVisual:o.setContourBusyVisual,clearCanvases:o.clearCanvases,clearCleanCanvasesOnly:o.clearCleanCanvasesOnly,clearSvgPreview:o.clearSvgPreview,updateEnabled:o.updateEnabled,getNumber:o.getNumber}),e.fileInputEl.value="")})}function c(){s(),e.btnDownloadEl.addEventListener("click",()=>o.downloadPng()),e.btnDownloadSvgEl.addEventListener("click",()=>o.downloadSvg()),e.btnProcessEl.addEventListener("click",()=>{Kt(e,n,{setStatus:o.setStatus,setContourBusyVisual:o.setContourBusyVisual,clearCleanCanvasesOnly:o.clearCleanCanvasesOnly,clearSvgPreview:o.clearSvgPreview,updateEnabled:o.updateEnabled,getNumber:o.getNumber})}),e.btnCleanEl.addEventListener("click",()=>{Wt(e,n,{setStatus:o.setStatus,setContourBusyVisual:o.setContourBusyVisual,clearSvgPreview:o.clearSvgPreview,updateEnabled:o.updateEnabled,getNumber:o.getNumber,updateCleanQualityUI:o.updateCleanQualityUI})}),e.btnVectorizeEl.addEventListener("click",()=>{en(e,n,{setStatus:o.setStatus,setContourBusyVisual:o.setContourBusyVisual,updateEnabled:o.updateEnabled,showError:o.showError,getNumber:o.getNumber})}),Vt(n),o.clearSvgPreview(),o.updateEnabled(),o.setStatus("No image loaded"),e.contourSpinnerEl.classList.add("is-hidden")}function g(){}function u(){}return{id:"contour",bind:c,mount:g,unmount:u}}function nn(e,t){function n(E){e.segSpinner.classList.toggle("is-hidden",!E),e.segSpinner.setAttribute("aria-hidden",E?"false":"true")}function o(E){e.segStatus.textContent=E||""}function s(E){e.segCvReport.textContent=E||""}const c="../assets/opencv/opencv.js",g="../assets/opencv/opencv.wasm";function u(){var m;const E=globalThis;E.Module=E.Module||{},E.Module.locateFile=C=>C.endsWith(".wasm")?g:C,E.Module.print=()=>{},E.Module.printErr=C=>{console.error("[OpenCV][stderr]",C)},E.Module.onAbort=C=>{V("[segmentation] OpenCV aborted",{msg:String(C)})},D("[segmentation] Module configured",{locateFileType:typeof E.Module.locateFile,expectedWasmUrl:g,docUrl:String(((m=globalThis.location)==null?void 0:m.href)||"")})}async function f(){try{const E=await fetch(g,{method:"GET",headers:{Range:"bytes=0-0"},cache:"no-store"});D("[segmentation] wasm reachability check",{wasmUrl:g,ok:E.ok,status:E.status})}catch(E){D("[segmentation] wasm reachability check failed (non-fatal)",{wasmUrl:g,msg:String((E==null?void 0:E.message)??E)})}}async function i(E){const m=new URL(E,document.baseURI).toString();if(Array.from(document.scripts).find(S=>S.src===m)){D("[segmentation] opencv.js script already present",{src:E,abs:m});return}D("[segmentation] injecting opencv.js script",{src:E,abs:m}),await new Promise((S,x)=>{const w=document.createElement("script");w.src=m,w.async=!0,w.onload=()=>{D("[segmentation] opencv.js script onload",{src:m}),S()},w.onerror=()=>x(new Error(`Failed to load script: ${m}`)),document.head.appendChild(w)})}async function b(E){var x;const m=globalThis,C=Date.now();let S=0;for(;Date.now()-C<E;){S++;const w=m.cv,T=typeof(w==null?void 0:w.Mat);if((S===1||S%10===0||T==="function")&&D("[segmentation] cv poll",{tick:S,elapsedMs:Date.now()-C,cvType:typeof w,matType:T}),w&&typeof w.Mat=="function")try{const k=new w.Mat;return typeof(k==null?void 0:k.delete)=="function"&&k.delete(),console.log("[segmentation] smoke ok: Mat ctor (console)"),!0}catch(k){(S===1||S%10===0)&&D("[segmentation] Mat ctor threw (still initializing)",{elapsedMs:Date.now()-C,msg:String((k==null?void 0:k.message)??k)})}D("[segmentation] waitForCvMatReady await setTimeout promise"),await new Promise(k=>setTimeout(k,75))}throw new Error(`OpenCV init timeout after ${E}ms. typeof globalThis.cv=${typeof m.cv}, typeof cv?.Mat=${typeof((x=m.cv)==null?void 0:x.Mat)}.`)}async function h(E){var S;u(),await f();const m=globalThis;m.cv?D("[segmentation] cv already exists before injection",{cvType:typeof m.cv}):await i(c),D("[segmentation] after inject/onload",{cvType:typeof globalThis.cv,moduleType:typeof globalThis.Module}),D("[segmentation] loadOpenCv: before waitForCvMatReady",{timeoutMs:E});const C=await b(E);if(console.log("[segmentation] loadOpenCv resumed after waitForCvMatReady (console)",C),!globalThis.cv||typeof((S=globalThis.cv)==null?void 0:S.Mat)!="function")throw new Error("OpenCV ready check failed: globalThis.cv missing or cv.Mat not a function");console.log("[segmentation] OpenCV ready (global cv present)")}function v(E){const m=[];m.push("OpenCV probe report"),m.push(`At: ${new Date().toISOString()}`),m.push(""),m.push(`cv present: ${!!E}`),m.push(`Mat: ${typeof(E==null?void 0:E.Mat)}`),m.push(`getBuildInformation: ${typeof(E==null?void 0:E.getBuildInformation)}`),m.push(""),m.push("Build info: (skipped — can be slow/hang in some builds)"),m.push(""),m.push("Top-level keys (first 80):");try{const C=Object.keys(E||{}).sort();m.push(C.slice(0,80).join(", ")),C.length>80&&m.push(`… (${C.length-80} more)`)}catch(C){m.push(`ERROR listing keys: ${String((C==null?void 0:C.message)??C)}`)}return m.join(`
`)}async function l(){if(A()){D("[segmentation] click ignored (busy)");return}n(!0),o("Loading OpenCV…"),s("Loading OpenCV…");let E=null;try{await Z(e,async()=>{D("[segmentation] load: start",{OPENCV_JS_URL:c,OPENCV_WASM_URL:g}),await h(2e4),E=globalThis.cv,D("[segmentation] load: cv ready (Mat usable)")}),o("OpenCV ready");const m=v(E);s(m),D("[segmentation] probe: report built",{reportChars:m.length}),D("[segmentation] load: done")}catch(m){const C=m!=null&&m.message?String(m.message):String(m);o("OpenCV load failed"),s(`ERROR

${C}`),V("[segmentation] load: fail",{msg:C})}finally{n(!1),D("[segmentation] load: finally (seg spinner cleared)")}}function a(){e.btnSegLoadCv.addEventListener("click",E=>{var m;if((m=E.preventDefault)==null||m.call(E),A()){D("[segmentation] click ignored (busy)");return}l()})}function r(){var E;n(!1),o("Idle"),(E=e.segCvReport.textContent)!=null&&E.trim()||s("Click “Load OpenCV & Probe”.")}function d(){}function y(){}function p(){}return{bind:a,mount:r,unmount:d,refresh:y,dispose:p}}function ce(e,t,n){return Number.isFinite(e)?Math.max(t,Math.min(n,Math.trunc(e))):t}function on(e,t,n){return Math.round(.2126*e+.7152*t+.0722*n)}function _e(e){return{edgesDark:!!(e.edgesDark??!0),edgeThreshold:ce(e.edgeThreshold??80,0,255),edgeDilate:ce(e.edgeDilate??2,0,6),maxRegionPx:ce(e.maxRegionPx??2e5,1e3,1e7)}}function an(e,t,n){const{data:o,width:s,height:c}=e,g=new Uint8Array(s*c);for(let u=0,f=0;u<g.length;u++,f+=4){const i=o[f+0],b=o[f+1],h=o[f+2];if(o[f+3]===0){g[u]=0;continue}const l=on(i,b,h),a=t?l<=n:l>=255-n;g[u]=a?1:0}return g}function sn(e,t,n,o){if(o<=0)return e;let s=e;for(let c=0;c<o;c++){const g=new Uint8Array(t*n);for(let u=0;u<n;u++)for(let f=0;f<t;f++){const i=u*t+f;if(s[i]){g[i]=1;continue}let b=0;for(let h=-1;h<=1&&!b;h++){const v=u+h;if(!(v<0||v>=n))for(let l=-1;l<=1;l++){const a=f+l;if(!(a<0||a>=t)&&s[v*t+a]){b=1;break}}}g[i]=b}s=g}return s}function rn(e,t,n,o,s,c){const g=t*o+e;if(n[g])return{ok:!1,message:"Click is on an edge; pick inside a region."};const u=new Uint8Array(o*s),f=new Int32Array(o*s),i=new Int32Array(o*s);let b=0,h=0;f[h]=e,i[h]=t,h++,u[g]=1;let v=1;for(;b<h;){const l=f[b],a=i[b];b++;const r=[[l-1,a],[l+1,a],[l,a-1],[l,a+1]];for(const[d,y]of r){if(d<0||d>=o||y<0||y>=s)continue;const p=y*o+d;if(!u[p]&&!n[p]&&(u[p]=1,f[h]=d,i[h]=y,h++,v++,v>c))return{ok:!1,message:`Region too large (>${c}px). Increase Max region or fix gaps.`}}}return{ok:!0,mask:u}}function ln(e,t,n,o){const s=new Uint8Array(n*o);for(let c=1;c<o-1;c++)for(let g=1;g<n-1;g++){const u=c*n+g;if(!e[u])continue;const f=(c-1)*n+g,i=(c+1)*n+g,b=c*n+(g-1),h=c*n+(g+1);(!e[f]||!e[i]||!e[b]||!e[h]||t[f]||t[i]||t[b]||t[h])&&(s[u]=1)}return s}function cn(e,t,n,o){const s=_e(o),c=e.width,g=e.height;let u=an(e,s.edgesDark,s.edgeThreshold);u=sn(u,c,g,s.edgeDilate);const f=rn(t,n,u,c,g,s.maxRegionPx);if(!f.ok)return{ok:!1,message:f.message};const i=ln(f.mask,u,c,g);return{ok:!0,preview:{mask:f.mask,outline:i,w:c,h:g}}}function un(e,t,n){const o=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),s=n.replace("#",""),c=parseInt(s.slice(0,2),16),g=parseInt(s.slice(2,4),16),u=parseInt(s.slice(4,6),16),f=o.data;for(let i=0,b=0;i<t.mask.length;i++,b+=4)t.mask[i]&&(f[b+0]=c,f[b+1]=g,f[b+2]=u);return o}function ue(e,t,n){return Number.isFinite(e)?Math.max(t,Math.min(n,Math.trunc(e))):t}function ke(e){const t=(e||"").trim();if(!t)return null;const n=t.startsWith("#")?t:`#${t}`;return/^#[0-9a-fA-F]{6}$/.test(n)?n.toLowerCase():null}function gn(e){let t="#ff3b30",n=[],o=null;function s(r){e.colorsStatusEl.textContent=r||""}function c(){const r=!!e.edgesDarkEl.checked,d=ue(parseInt(e.edgeMaskThresholdEl.value,10),0,255),y=ue(parseInt(e.edgeDilateEl.value,10),0,6),p=ue(parseInt(e.maxRegionPxEl.value,10),1e3,1e7);return e.edgeMaskThresholdEl.value=String(d),e.edgeDilateEl.value=String(y),e.maxRegionPxEl.value=String(p),_e({edgesDark:r,edgeThreshold:d,edgeDilate:y,maxRegionPx:p})}function g(r){const d=ke(r);if(d){t=d;for(const y of Array.from(e.paletteEl.querySelectorAll(".paletteItem"))){const p=y.dataset.hex||"";y.classList.toggle("is-selected",p===t)}}}function u(){return t}function f(r){n=r.slice(),e.paletteEl.innerHTML="";for(const d of n){const y=ke(d);if(!y)continue;const p=document.createElement("button");p.type="button",p.className="paletteItem",p.style.background=y,p.dataset.hex=y,p.setAttribute("role","listitem"),p.setAttribute("aria-label",`Select ${y}`),p.addEventListener("click",()=>{g(y)}),e.paletteEl.appendChild(p)}g(t)}function i(r){const d=e.colorsCanvasEl;d.width=r.width,d.height=r.height,d.getContext("2d").putImageData(r,0,0)}function b(r,d){i(r);const y=e.colorsCanvasEl.getContext("2d"),{outline:p,w:E,h:m}=d,C=y.getImageData(0,0,E,m),S=C.data;for(let x=0,w=0;x<p.length;x++,w+=4)p[x]&&(S[w+0]=255,S[w+1]=60,S[w+2]=60,S[w+3]=220);y.putImageData(C,0,0)}function h(r){e.btnColorsApplyEl.disabled=!r}function v(r){e.btnColorsCancelEl.disabled=!r}function l(r){o=r}function a(){s("Idle"),h(!1),v(!1),e.colorsCanvasEl.addEventListener("click",r=>{if(!o)return;const d=e.colorsCanvasEl.getBoundingClientRect(),y=Math.floor((r.clientX-d.left)/d.width*e.colorsCanvasEl.width),p=Math.floor((r.clientY-d.top)/d.height*e.colorsCanvasEl.height);o(y,p)})}return{bind:a,setStatus:s,getSettings:c,setSelectedColor:g,getSelectedColor:u,renderPalette:f,drawBase:i,drawPreview:b,setApplyEnabled:h,setCancelEnabled:v,onCanvasClick:l}}const dn=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#a2845e","#8e8e93","#1c1c1e","#ffffff","#000000","#4cd964","#5ac8fa","#ff6b6b","#7aa2ff","#f5a623","#50e3c2"];function fn(e,t){const n=gn(e);let o=null,s=null;function c(h){n.setStatus(h)}function g(){const h=e.outCanvasEl.getContext("2d");if(!h)return null;const v=e.outCanvasEl.width,l=e.outCanvasEl.height;return v<=0||l<=0?null:h.getImageData(0,0,v,l)}function u(){const h=g();if(!h){o=null,s=null,n.setApplyEnabled(!1),n.setCancelEnabled(!1),c("No output available. Run Process first.");return}o=h,s=null,n.drawBase(o),n.setApplyEnabled(!1),n.setCancelEnabled(!1),c("Ready. Pick a color, click inside a region.")}function f(){if(o){n.drawBase(o);return}const h=g();if(!h){c("No output available. Run Process first.");return}o=h,s=null,n.drawBase(o),n.setApplyEnabled(!1),n.setCancelEnabled(!1),c("Loaded output. Pick a color, click inside a region.")}function i(){if(!o||!s)return;const h=n.getSelectedColor();o=un(o,s,h),s=null,n.drawBase(o),n.setApplyEnabled(!1),n.setCancelEnabled(!1),c("Fill applied. Click another region.")}function b(){o&&(s=null,n.drawBase(o),n.setApplyEnabled(!1),n.setCancelEnabled(!1),c("Preview canceled."))}return{bind(){n.bind(),n.renderPalette(dn),n.onCanvasClick((h,v)=>{if(!o){c("No output available. Run Process first.");return}const l=n.getSettings(),a=cn(o,h,v,l);if(!a.ok){s=null,n.setApplyEnabled(!1),n.setCancelEnabled(!1),c(a.message);return}s=a.preview,n.drawPreview(o,s),n.setApplyEnabled(!0),n.setCancelEnabled(!0),c("Preview shown. Apply fill or cancel.")}),e.btnColorsApplyEl.addEventListener("click",()=>i()),e.btnColorsCancelEl.addEventListener("click",()=>b()),e.btnColorsResetEl.addEventListener("click",()=>u()),e.tabColors.addEventListener("click",()=>{queueMicrotask(()=>f())}),c("Idle"),n.setApplyEnabled(!1),n.setCancelEnabled(!1)}}}const ae="beecontour.actionLog",bn=5e3;function hn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function vn(e){return Array.isArray(e)?e:[e]}function se(e,t,n){return Math.max(t,Math.min(n,Math.floor(e)))}async function J(){const e=await Y(ae),t=e==null?void 0:e[ae];return Array.isArray(t)?t:[]}async function ze(e){await X({[ae]:e})}async function H(e,t){const n=se(bn,100,5e4),s=vn(e).map(f=>({...f,id:hn(),ts:Date.now()}));if(!s.length)return{total:(await J()).length};const g=(await J()).concat(s),u=g.length>n?g.slice(g.length-n):g;return await ze(u),{total:u.length}}async function yn(e){const t=se((e==null?void 0:e.limit)??200,1,5e4),n=se((e==null?void 0:e.offset)??0,0,1e6);let s=await J();e!=null&&e.kind&&(s=s.filter(u=>u.kind===e.kind)),e!=null&&e.scope&&(s=s.filter(u=>u.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(s=s.filter(u=>u.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(s=s.filter(u=>u.ts<=e.untilTs));const c=s.length;s=s.slice().reverse();const g=s.slice(n,n+t);return{total:c,items:g}}async function En(e){let n=await J();if(typeof e.beforeTs=="number"&&(n=n.filter(o=>o.ts>=e.beforeTs)),typeof e.keepLast=="number"){const o=se(e.keepLast,0,5e4);o===0?n=[]:n.length>o&&(n=n.slice(n.length-o))}return await ze(n),{total:n.length}}async function pn(){await Ee(ae)}async function mn(e){const t=await J();return JSON.stringify(t,null,2)}const Te="0.0.5";function Cn(){let e=!1,t={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},n=!1,o="",s="";function c(i){e=i}function g(i){t={...t,...i}}function u(i){n=i}function f(i){typeof i.general=="string"&&(o=i.general),typeof i.dev=="string"&&(s=i.dev)}return{get showDevTools(){return e},get dev(){return t},get debugEnabled(){return n},get generalStatus(){return o},get devStatus(){return s},setShowDevTools:c,setDev:g,setDebugEnabled:u,setStatus:f}}function wn(e){function t(i){e.settingsGeneralStatusEl.textContent=i||""}function n(i){e.cfgStatusEl.textContent=i||""}function o(i){e.cfgShowDevToolsEl.checked=i}function s(i){e.tabLogs.hidden=!i,e.devConfigDetailsEl.classList.toggle("is-hidden",!i),i||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function c(i){e.cfgTraceConsoleEl.checked=!!i.traceConsole,e.cfgActionLogMaxEl.value=String(i.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(i.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(i.failureLogsPerRun??50)}function g(i){e.logsCbDebugEl.checked=i}function u(i,b){e.settingsVersionEl.textContent=i||"—",e.settingsGitHubLinkEl.href=b||"#",e.settingsGitHubLinkEl.hidden=!b}function f(i){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=i,e.cfgActionLogMaxEl.disabled=i,e.cfgDebugTraceMaxEl.disabled=i,e.cfgFailureLogsPerRunEl.disabled=i,e.btnCfgResetDefaults.disabled=i,e.logsCbDebugEl.disabled=i}return{setGeneralStatus:t,setDevStatus:n,setShowDevToolsChecked:o,setDevToolsVisible:s,setDevConfig:c,setDebugEnabledChecked:g,setAbout:u,setBusy:f}}const ge="template.settings.showDevTools";function Sn(){var e,t;try{const n=(e=globalThis==null?void 0:globalThis.chrome)==null?void 0:e.runtime,o=(t=n==null?void 0:n.getManifest)==null?void 0:t.call(n),s=typeof(o==null?void 0:o.version)=="string"?o.version:"";if(D("Settings: getManifestVersion manifest found version is ",{v:s}),s)return s}catch{}return D("Settings: getManifestVersion fallback",{APP_VERSION:Te}),Te}function de(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??$.actionLogMax),debugTraceMax:Number(e.debugTraceMax??$.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??$.failureLogsPerRun)}}function xn(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:_(e.cfgActionLogMaxEl.value,100,5e4,$.actionLogMax),debugTraceMax:_(e.cfgDebugTraceMaxEl.value,100,5e4,$.debugTraceMax),failureLogsPerRun:_(e.cfgFailureLogsPerRunEl.value,0,5e4,$.failureLogsPerRun)}}async function Le(e){const t=Fe;return typeof t.setEnabled=="function"?(await t.setEnabled(e),{ok:!0}):typeof t.enable=="function"&&typeof t.disable=="function"?(await(e?t.enable():t.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function Dn(e,t){const n=Cn(),o=wn(e);async function s(){const r=await Y([ge]).catch(()=>({}));return(r==null?void 0:r[ge])===!0}async function c(r){await X({[ge]:!!r}).catch(()=>null)}function g(r){n.setShowDevTools(r),o.setShowDevToolsChecked(r),o.setDevToolsVisible(r),r||e.tabSettings.click()}async function u(){const r=await s();g(r),D("Settings: boot applyDevToolsVisibility",{showDevTools:r})}async function f(){var E;o.setBusy(A());const r=await s();g(r),await we().catch(()=>null);const d=ye();n.setDev(de(d)),o.setDevConfig(n.dev);const y=Fe;let p=!1;try{typeof y.isEnabled=="function"?p=!!await y.isEnabled():p=!!y.enabled}catch(m){j("Settings: failed to read debug enabled state",{error:m instanceof Error?m.message:String(m)})}n.setDebugEnabled(p),o.setDebugEnabledChecked(p),o.setAbout(Sn()||"—",((E=e.settingsGitHubLinkEl)==null?void 0:E.href)||"#"),o.setGeneralStatus(""),o.setDevStatus(""),D("Settings: loaded",{showDevTools:r,enabled:p,dev:n.dev})}async function i(){const r=!!e.cfgShowDevToolsEl.checked;g(r),await c(r),H({kind:"run",scope:"settings",message:r?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:r}}),D("Settings: ui toggle showDevTools",{showDevTools:r}),o.setGeneralStatus(r?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>o.setGeneralStatus(""),1200)}async function b(){const r=xn(e);o.setDevStatus("Saving…");try{await Ue(r)}catch(d){V("Settings: failed to save dev config",{error:d instanceof Error?d.message:String(d),next:r}),o.setDevStatus("Save failed."),setTimeout(()=>o.setDevStatus(""),1200);return}n.setDev(de(r)),o.setDevConfig(n.dev),H({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:r}),D("Settings: devConfig updated",r),o.setDevStatus("Saved."),setTimeout(()=>o.setDevStatus(""),1200)}async function h(){o.setDevStatus("Resetting…");try{await Gt(),await we().catch(()=>null);const d=ye();n.setDev(de(d)),o.setDevConfig(n.dev)}catch(d){V("Settings: failed to reset dev config defaults",{error:d instanceof Error?d.message:String(d)}),o.setDevStatus("Reset failed."),setTimeout(()=>o.setDevStatus(""),1200);return}const r=await Le(!1);r.ok?(n.setDebugEnabled(!1),o.setDebugEnabledChecked(!1)):(j("Settings: failed to reset debug enabled state",{error:r.error||"unknown error"}),H({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:r.error||"unknown error"})),H({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...$,debugEnabled:!1}}),D("Settings: reset defaults",{...$,debugEnabled:!1}),o.setDevStatus("Reset."),setTimeout(()=>o.setDevStatus(""),1200)}async function v(){const r=!!e.logsCbDebugEl.checked;o.setDevStatus("Saving…");const d=await Le(r);if(!d.ok){e.logsCbDebugEl.checked=!r,o.setDevStatus(`Save failed: ${d.error||"unknown error"}`),V("Settings: failed to change debug enabled state",{error:d.error||"unknown error",enabled:r}),H({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:d.error||"unknown error",meta:{enabled:r}});return}n.setDebugEnabled(r),H({kind:"run",scope:"settings",message:r?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:r}}),D("Settings: debug enabled changed",{enabled:r}),o.setDevStatus("Saved."),setTimeout(()=>o.setDevStatus(""),1200)}const l=t.on(()=>{});function a(){e.cfgShowDevToolsEl.addEventListener("change",()=>{i()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{A()||b()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{A()||b()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{A()||b()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{A()||b()}),e.btnCfgResetDefaults.addEventListener("click",()=>{A()||h()}),e.logsCbDebugEl.addEventListener("change",()=>{A()||v()}),u().catch(r=>{j("Settings: initDevToolsVisibility failed",{error:r instanceof Error?r.message:String(r)})})}return{id:"settings",refresh(){f().catch(r=>{V("Settings: refresh failed",{error:r instanceof Error?r.message:String(r)})})},mount(){f().catch(r=>{V("Settings: mount failed",{error:r instanceof Error?r.message:String(r)})})},unmount(){},bind:a,dispose(){l()}}}function kn(){let e=[],t=0;function n(o){e=o.items,t=o.total}return{get items(){return e},get total(){return t},set:n}}function Tn(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function Me(e,t){const n=[];n.push(`Total entries: ${t.total}`),n.push("");for(const o of t.items){const s=typeof o.ok=="boolean"?o.ok?"ok":"fail":"",c=[];typeof o.status=="number"&&c.push(`status=${o.status}`),s&&c.push(s);const g=[o.scope,o.kind].filter(Boolean).join("/");n.push(`[${Tn(o.ts)}] ${g}${c.length?` (${c.join(", ")})`:""}`),n.push(`  ${o.message}`),o.error&&n.push(`  error: ${o.error}`),n.push("")}e.textContent=n.join(`
`),e.scrollTop=0}function Ln(e){function t(g){e.logsStatusEl.textContent=g}function n(g){e.debugStatusEl.textContent=g}function o(g){e.logsCbDebugEl.checked=g}function s(g){Me(e.logsOutEl,{total:g.total,items:g.items.map(u=>({ts:u.ts,message:u.message,scope:u.scope,kind:u.kind,ok:u.ok,status:u.status,error:u.error,meta:u.meta}))})}function c(g){Me(e.debugOutEl,{total:g.total,items:g.items.map(u=>({ts:u.ts,message:u.message,scope:u.scope,kind:u.kind,ok:u.ok,status:u.status,error:u.error,meta:u.meta}))})}return{setAuditStatus:t,setDebugStatus:n,setDebugChecked:o,renderAudit:s,renderDebug:c}}const Ie="beecontour";function Mn(e,t){const n=kn(),o=Ln(e);async function s(){o.setAuditStatus("Loading…"),U(e,!0);try{const a=_(e.logsLimitEl.value,10,5e3,200),r=await yn({limit:a,reverse:!0});n.set(r),o.renderAudit({items:n.items,total:n.total}),o.setAuditStatus(`Showing ${n.items.length} (newest first)`)}catch(a){o.setAuditStatus(`Failed: ${(a==null?void 0:a.message)||String(a)}`)}finally{U(e,!1)}}async function c(){o.setDebugStatus("Loading…"),U(e,!0);try{const a=_(e.debugLimitEl.value,10,5e3,200),r=await Oe({limit:a,reverse:!0});o.renderDebug(r),o.setDebugStatus(`Showing ${r.items.length} (newest first)`)}catch(a){o.setDebugStatus(`Failed: ${(a==null?void 0:a.message)||String(a)}`)}finally{U(e,!1)}}async function g(){const a=await pe();o.setDebugChecked(a)}async function u(a){if(await Ae(a),o.setDebugChecked(a),!a){o.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}o.setDebugStatus("Debug ON."),await c()}async function f(){const a=_(e.logsTrimKeepEl.value,0,5e4,2e3);o.setAuditStatus("Trimming…"),U(e,!0);try{const r=await En({keepLast:a});await s(),o.setAuditStatus(`Trimmed. Remaining: ${r.total}`)}catch(r){o.setAuditStatus(`Trim failed: ${(r==null?void 0:r.message)||String(r)}`)}finally{U(e,!1)}}async function i(){o.setAuditStatus("Clearing…"),U(e,!0);try{await pn(),await s(),o.setAuditStatus("Cleared.")}catch(a){o.setAuditStatus(`Clear failed: ${(a==null?void 0:a.message)||String(a)}`)}finally{U(e,!1)}}async function b(){o.setAuditStatus("Exporting…");try{const a=await mn({pretty:!0}),r=new Blob([a],{type:"application/json"}),d=URL.createObjectURL(r),y=document.createElement("a");y.href=d,y.download=`${Ie}-audit-${Date.now()}.json`,y.click(),setTimeout(()=>URL.revokeObjectURL(d),1e3),o.setAuditStatus("Exported.")}catch(a){o.setAuditStatus(`Export failed: ${(a==null?void 0:a.message)||String(a)}`)}}async function h(){o.setDebugStatus("Clearing…"),U(e,!0);try{await Pe(),await c(),o.setDebugStatus("Cleared.")}catch(a){o.setDebugStatus(`Clear failed: ${(a==null?void 0:a.message)||String(a)}`)}finally{U(e,!1)}}async function v(){o.setDebugStatus("Exporting…");try{const a=await Ve({pretty:!0}),r=new Blob([a],{type:"application/json"}),d=URL.createObjectURL(r),y=document.createElement("a");y.href=d,y.download=`${Ie}-debug-${Date.now()}.json`,y.click(),setTimeout(()=>URL.revokeObjectURL(d),1e3),o.setDebugStatus("Exported.")}catch(a){o.setDebugStatus(`Export failed: ${(a==null?void 0:a.message)||String(a)}`)}}function l(){e.btnLogsRefresh.addEventListener("click",()=>{A()||s()}),e.btnLogsTrim.addEventListener("click",()=>{A()||f()}),e.btnLogsClear.addEventListener("click",()=>{A()||i()}),e.btnLogsExport.addEventListener("click",()=>{A()||b()}),e.logsCbDebugEl.addEventListener("change",()=>{A()||u(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{A()||c()}),e.btnDebugClear.addEventListener("click",()=>{A()||h()}),e.btnDebugExport.addEventListener("click",()=>{A()||v()})}return{id:"logs",bind:l,mount(){g(),s(),c()},unmount(){},dispose(){}}}(function(){const t=It(),n=At();n.start();const o=$t();globalThis.__APP__={...globalThis.__APP__,cache:o};const s=tn(t),c=fn(t),g=nn(t),u=Dn(t,n),f=Mn(t);s.bind(),g.bind(),c.bind(),u.bind(),f.bind();const i=Pt(t,{contour:s,segmentation:g,colors:c,settings:u,logs:f});i.bind(),i.boot()})();
