import{_ as kn}from"./index-BLL-tQym.js";function Sn(){function e(st,In){if(!st)throw new Error(`[dom] Missing #${In}`);return st}const t=e(document.getElementById("appRoot"),"appRoot"),n=e(document.getElementById("tabImage"),"tabImage"),i=e(document.getElementById("tabColors"),"tabColors"),o=e(document.getElementById("tabSettings"),"tabSettings"),s=e(document.getElementById("tabLogs"),"tabLogs"),a=e(document.getElementById("tabPipeline"),"tabPipeline"),l=e(document.getElementById("tabBuilder"),"tabBuilder"),p=e(document.getElementById("viewImage"),"viewImage"),r=e(document.getElementById("viewColors"),"viewColors"),f=e(document.getElementById("viewSettings"),"viewSettings"),g=e(document.getElementById("viewLogs"),"viewLogs"),h=e(document.getElementById("viewPipeline"),"viewPipeline"),u=e(document.getElementById("viewBuilder"),"viewBuilder"),d=e(document.getElementById("dropZone"),"dropZone"),m=e(document.getElementById("fileInput"),"fileInput"),v=e(document.getElementById("srcCanvas"),"srcCanvas"),y=e(document.getElementById("pipelineStatus"),"pipelineStatus"),b=e(document.getElementById("pipelineTuningMount"),"pipelineTuningMount"),k=e(document.getElementById("pipelineViewMount"),"pipelineViewMount"),C=e(document.getElementById("builderImportFile"),"builderImportFile"),E=e(document.getElementById("btnBuilderExport"),"btnBuilderExport"),I=e(document.getElementById("builderStatus"),"builderStatus"),A=e(document.getElementById("colorsCanvas"),"colorsCanvas"),D=e(document.getElementById("palette"),"palette"),O=e(document.getElementById("btnColorsApply"),"btnColorsApply"),c=e(document.getElementById("btnColorsCancel"),"btnColorsCancel"),w=e(document.getElementById("btnColorsReset"),"btnColorsReset"),R=e(document.getElementById("edgesDark"),"edgesDark"),M=e(document.getElementById("edgeMaskThreshold"),"edgeMaskThreshold"),B=e(document.getElementById("edgeDilate"),"edgeDilate"),S=e(document.getElementById("maxRegionPx"),"maxRegionPx"),x=e(document.getElementById("colorsStatus"),"colorsStatus"),P=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),L=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),$=e(document.getElementById("devConfigDetails"),"devConfigDetails"),U=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),z=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),H=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),T=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),K=e(document.getElementById("logsCbDebug"),"logsCbDebug"),W=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),ge=e(document.getElementById("cfgStatus"),"cfgStatus"),Be=e(document.getElementById("cfgOpenCvSpinner"),"cfgOpenCvSpinner"),tn=e(document.getElementById("cfgOpenCvStatus"),"cfgOpenCvStatus"),nn=e(document.getElementById("cfgOpenCvReport"),"cfgOpenCvReport"),on=e(document.getElementById("settingsEngineBox"),"settingsEngineBox"),an=e(document.getElementById("cfgUseOpenCv"),"cfgUseOpenCv"),sn=e(document.getElementById("tuningMount"),"tuningMount"),rn=e(document.getElementById("settingsVersion"),"settingsVersion"),ln=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),cn=e(document.getElementById("logsLimit"),"logsLimit"),dn=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),un=e(document.getElementById("logsStatus"),"logsStatus"),pn=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),gn=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),fn=e(document.getElementById("btnLogsExport"),"btnLogsExport"),hn=e(document.getElementById("btnLogsClear"),"btnLogsClear"),mn=e(document.getElementById("logsOut"),"logsOut"),bn=e(document.getElementById("debugLimit"),"debugLimit"),yn=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),vn=e(document.getElementById("btnDebugExport"),"btnDebugExport"),wn=e(document.getElementById("btnDebugClear"),"btnDebugClear"),En=e(document.getElementById("debugStatus"),"debugStatus"),Cn=e(document.getElementById("debugOut"),"debugOut");return{rootEl:t,tabImage:n,tabColors:i,tabSettings:o,tabLogs:s,tabPipeline:a,tabBuilder:l,viewImage:p,viewColors:r,viewSettings:f,viewLogs:g,viewPipeline:h,viewBuilder:u,dropZoneEl:d,fileInputEl:m,srcCanvasEl:v,pipelineStatusEl:y,pipelineTuningMountEl:b,pipelineViewMountEl:k,builderImportFileEl:C,btnBuilderExportEl:E,builderStatusEl:I,colorsCanvasEl:A,paletteEl:D,btnColorsApplyEl:O,btnColorsCancelEl:c,btnColorsResetEl:w,edgesDarkEl:R,edgeMaskThresholdEl:M,edgeDilateEl:B,maxRegionPxEl:S,colorsStatusEl:x,cfgShowDevToolsEl:P,settingsGeneralStatusEl:L,devConfigDetailsEl:$,cfgTraceConsoleEl:U,cfgActionLogMaxEl:z,cfgDebugTraceMaxEl:H,cfgFailureLogsPerRunEl:T,logsCbDebugEl:K,btnCfgResetDefaults:W,cfgStatusEl:ge,settingsVersionEl:rn,settingsGitHubLinkEl:ln,cfgOpenCvSpinner:Be,cfgOpenCvStatus:tn,cfgOpenCvReport:nn,settingsEngineBoxEl:on,cfgUseOpenCvEl:an,tuningMountEl:sn,logsLimitEl:cn,btnLogsRefresh:dn,logsStatusEl:un,logsTrimKeepEl:pn,btnLogsTrim:gn,btnLogsExport:fn,btnLogsClear:hn,logsOutEl:mn,debugLimitEl:bn,btnDebugRefresh:yn,btnDebugExport:vn,btnDebugClear:wn,debugStatusEl:En,debugOutEl:Cn}}const xn=new Set;function Pn(e){xn.add(e)}function rt(e){return`./${String(e||"").replace(/^\/+/,"")}`}function An(){const e=new Set;function t(i){return e.add(i),()=>e.delete(i)}function n(){Pn(o=>{for(const s of e)s(o)})}return{on:t,start:n}}const Rn=new Set;function Dt(e){for(const t of Rn)t(e,"local")}function he(e){const t=localStorage.getItem(e);if(t!==null)try{return JSON.parse(t)}catch{return t}}function Dn(e,t){localStorage.setItem(e,JSON.stringify(t))}async function oe(e){if(typeof e=="string")return{[e]:he(e)};if(Array.isArray(e)){const n={};for(const i of e)n[i]=he(i);return n}const t={};for(const[n,i]of Object.entries(e))t[n]=localStorage.getItem(n)!==null?he(n):i;return t}async function ae(e){const t={};for(const[n,i]of Object.entries(e)){const o=he(n);Dn(n,i),t[n]={oldValue:o,newValue:i}}Dt(t)}async function nt(e){const t=Array.isArray(e)?e:[e],n={};for(const i of t){const o=he(i);localStorage.removeItem(i),n[i]={oldValue:o,newValue:void 0}}Dt(n)}function ie(e,t,n,i){const o=Number(String(e??"").trim());return Number.isFinite(o)?Math.max(t,Math.min(n,Math.floor(o))):i}const Ke="beemage.devConfig",Z={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let He=!1,Ae={...Z};function Mt(e){const t=e||{};return{traceConsole:!!t.traceConsole,actionLogMax:ie(t.actionLogMax??Z.actionLogMax,100,5e4,Z.actionLogMax),debugTraceMax:ie(t.debugTraceMax??Z.debugTraceMax,100,5e4,Z.debugTraceMax),failureLogsPerRun:ie(t.failureLogsPerRun??Z.failureLogsPerRun,0,5e4,Z.failureLogsPerRun)}}async function We(){if(He)return;const e=await oe([Ke]).catch(()=>({}));Ae=Mt(e==null?void 0:e[Ke]),He=!0}function Re(){return Ae}async function Tt(e){Ae=Mt(e),He=!0,await ae({[Ke]:Ae}).catch(()=>null)}async function Mn(){await Tt({...Z})}function Tn(e,t){const n={pipeline:e.tabPipeline,image:e.tabImage,builder:e.tabBuilder,colors:e.tabColors,settings:e.tabSettings,logs:e.tabLogs},i={pipeline:e.viewPipeline,image:e.viewImage,builder:e.viewBuilder,colors:e.viewColors,settings:e.viewSettings,logs:e.viewLogs};let o="image";const s=new Set;function a(){const u=Re();return!!(u!=null&&u.traceConsole)}function l(){const u=globalThis;u.__bctGlobalErrorHooksInstalled||(u.__bctGlobalErrorHooksInstalled=!0,window.addEventListener("error",d=>{var v;const m=d;console.error("[panel] window error",{message:m.message,filename:m.filename,lineno:m.lineno,colno:m.colno,error:m.error?String(m.error):null,stack:(v=m.error)!=null&&v.stack?String(m.error.stack):null})}),window.addEventListener("unhandledrejection",d=>{var m;console.error("[panel] unhandledrejection",{reason:d.reason?String(d.reason):null,stack:(m=d.reason)!=null&&m.stack?String(d.reason.stack):null})}))}a()&&l();function p(u){Object.keys(n).forEach(d=>{const m=d===u;n[d].classList.toggle("is-active",m),n[d].setAttribute("aria-selected",m?"true":"false"),i[d].hidden=!m,i[d].classList.toggle("is-active",m)})}function r(u){var d,m,v,y,b,k,C,E;if(u===o){(m=(d=t[u]).refresh)==null||m.call(d);return}(y=(v=t[o]).unmount)==null||y.call(v),o=u,p(o),s.has(o)?(E=(C=t[o]).refresh)==null||E.call(C):(s.add(o),(k=(b=t[o]).mount)==null||k.call(b))}function f(){n.image.addEventListener("click",u=>{var d;(d=u.preventDefault)==null||d.call(u),r("image")}),n.pipeline.addEventListener("click",u=>{var d;(d=u.preventDefault)==null||d.call(u),r("pipeline")}),n.colors.addEventListener("click",u=>{var d;(d=u.preventDefault)==null||d.call(u),r("colors")}),n.settings.addEventListener("click",u=>{var d;(d=u.preventDefault)==null||d.call(u),r("settings")}),n.logs.addEventListener("click",u=>{var d;(d=u.preventDefault)==null||d.call(u),r("logs")}),n.builder.addEventListener("click",u=>{var d;(d=u.preventDefault)==null||d.call(u),r("builder")})}function g(){var u,d,m,v;o="image",p(o),Object.keys(t).forEach(y=>{var b,k;return(k=(b=t[y]).boot)==null?void 0:k.call(b)}),s.has(o)?(v=(m=t[o]).refresh)==null||v.call(m):(s.add(o),(d=(u=t[o]).mount)==null||d.call(u))}function h(){Object.keys(t).forEach(u=>{var d,m;return(m=(d=t[u]).dispose)==null?void 0:m.call(d)})}return{bind:f,boot:g,activate:r,dispose:h}}function lt(e){const t=e.items.length;return{items:e.items,counts:{items:t},meta:e.meta}}function Ln(){const e={items:[],meta:{}},t=new Set;function n(){const r=lt(e);for(const f of t)try{f(r)}catch{}}function i(){return lt(e)}function o(r){t.add(r);try{r(i())}catch{}return()=>t.delete(r)}function s(){e.items=[],e.meta={},n()}function a(r){e.meta.scopeUpdatedSince=r,n()}function l(){return String(e.meta.scopeUpdatedSince||"")}function p(r,f){e.items=r.slice(),e.meta.updatedTs=Date.now(),typeof(f==null?void 0:f.limit)=="number"&&(e.meta.limit=f.limit),n()}return{getSnapshot:i,subscribe:o,getScopeUpdatedSince:l,clearAll:s,setScopeUpdatedSince:a,setItems:p}}function On(e,t){function n(l){e.dropZoneEl.classList.toggle("is-hover",l)}function i(l,p){const r=l.getContext("2d",{willReadFrequently:!0});if(!r)return;const f=Math.max(1,l.width),g=Math.max(1,l.height);r.clearRect(0,0,f,g);const h=p.naturalWidth||p.width,u=p.naturalHeight||p.height;if(!h||!u)return;const d=Math.min(f/h,g/u),m=Math.max(1,Math.round(h*d)),v=Math.max(1,Math.round(u*d)),y=Math.floor((f-m)/2),b=Math.floor((g-v)/2);r.drawImage(p,y,b,m,v)}function o(l){i(e.srcCanvasEl,l)}function s(l){t.lastError=void 0,t.loadedImageName=l,t.hasImage=!0}function a(l){t.lastError=l,t.hasImage=!1}return{setHover:n,drawImageToSource:o,showLoadOk:s,showLoadError:a}}function $n(){return{loadedImageName:null,hasImage:!1,lastError:void 0}}const De="beemage.actionLog",Bn=5e3;function Un(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function Vn(e){return Array.isArray(e)?e:[e]}function Me(e,t,n){return Math.max(t,Math.min(n,Math.floor(e)))}async function me(){const e=await oe(De),t=e==null?void 0:e[De];return Array.isArray(t)?t:[]}async function Lt(e){await ae({[De]:e})}async function N(e,t){const n=Me(Bn,100,5e4),o=Vn(e).map(p=>({...p,id:Un(),ts:Date.now()}));if(!o.length)return{total:(await me()).length};const a=(await me()).concat(o),l=a.length>n?a.slice(a.length-n):a;return await Lt(l),{total:l.length}}async function Nn(e){const t=Me((e==null?void 0:e.limit)??200,1,5e4),n=Me((e==null?void 0:e.offset)??0,0,1e6);let o=await me();e!=null&&e.kind&&(o=o.filter(l=>l.kind===e.kind)),e!=null&&e.scope&&(o=o.filter(l=>l.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(o=o.filter(l=>l.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(o=o.filter(l=>l.ts<=e.untilTs));const s=o.length;o=o.slice().reverse();const a=o.slice(n,n+t);return{total:s,items:a}}async function jn(e){let n=await me();if(typeof e.beforeTs=="number"&&(n=n.filter(i=>i.ts>=e.beforeTs)),typeof e.keepLast=="number"){const i=Me(e.keepLast,0,5e4);i===0?n=[]:n.length>i&&(n=n.slice(n.length-i))}return await Lt(n),{total:n.length}}async function zn(){await nt(De)}async function Fn(e){const t=await me();return JSON.stringify(t,null,2)}const be="beemage.debugTrace",Je="beemage.debugTrace.enabled",_n=2e3;function Gn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function qe(e,t,n){return Math.max(t,Math.min(n,Math.floor(e)))}async function Te(){const e=await oe(be),t=e==null?void 0:e[be];return Array.isArray(t)?t:[]}async function Kn(e){await ae({[be]:e})}async function it(){const e=await oe(Je);return!!(e!=null&&e[Je])}async function Ot(e){await ae({[Je]:!!e}),e||await nt(be)}async function $t(){await nt(be)}async function q(e,t){if(!await it())return{total:0};const i=qe((t==null?void 0:t.max)??_n,100,5e4),o=(Array.isArray(e)?e:[e]).map(p=>({...p,id:Gn(),ts:Date.now()}));if(!o.length)return{total:(await Te()).length};const a=(await Te()).concat(o),l=a.length>i?a.slice(a.length-i):a;return await Kn(l),{total:l.length}}async function Bt(e){const t=qe((e==null?void 0:e.limit)??200,1,5e4),n=qe((e==null?void 0:e.offset)??0,0,1e6),i=(e==null?void 0:e.reverse)??!0,o=await Te(),s=o.length,l=(i?o.slice().reverse():o).slice(n,n+t);return{total:s,items:l}}async function Ut(e){const t=await Te();return JSON.stringify(t,null,e!=null&&e.pretty?2:0)}const Vt=Object.freeze(Object.defineProperty({__proto__:null,append:q,clear:$t,exportJson:Ut,isEnabled:it,list:Bt,setEnabled:Ot},Symbol.toStringTag,{value:"Module"}));function Hn(e,t){const n=$n(),i=On(e,n);async function o(f){if(!f.type.startsWith("image/"))throw new Error(`Unsupported file type: ${f.type||"unknown"}`);const g=URL.createObjectURL(f);try{const h=new Image;return h.decoding="async",h.src=g,typeof h.decode=="function"?await h.decode():await new Promise((u,d)=>{h.onload=()=>u(),h.onerror=()=>d(new Error("Image decode failed."))}),h}finally{URL.revokeObjectURL(g)}}async function s(f){const g=await o(f);i.drawImageToSource(g),i.showLoadOk(f.name),N({scope:"panel",kind:"info",message:`Input loaded: ${f.name}`}),q({scope:"panel",kind:"info",message:"Mage input loaded into srcCanvas",meta:{name:f.name,type:f.type,size:f.size,canvasW:e.srcCanvasEl.width,canvasH:e.srcCanvasEl.height,naturalW:g.naturalWidth||g.width,naturalH:g.naturalHeight||g.height}})}function a(){e.dropZoneEl.addEventListener("dragover",f=>{f.preventDefault(),i.setHover(!0)}),e.dropZoneEl.addEventListener("dragleave",()=>i.setHover(!1)),e.dropZoneEl.addEventListener("drop",f=>{var h,u;f.preventDefault(),i.setHover(!1);const g=(u=(h=f.dataTransfer)==null?void 0:h.files)==null?void 0:u[0];g&&s(g).catch(d=>{const m=d instanceof Error?d.message:String(d);i.showLoadError(m),N({scope:"panel",kind:"error",message:`Input load failed: ${m}`}),q({scope:"panel",kind:"error",message:"Input load failed",meta:{error:m}})})}),e.fileInputEl.addEventListener("change",()=>{var g;const f=(g=e.fileInputEl.files)==null?void 0:g[0];f&&(s(f).catch(h=>{const u=h instanceof Error?h.message:String(h);i.showLoadError(u),N({scope:"panel",kind:"error",message:`Input load failed: ${u}`}),q({scope:"panel",kind:"error",message:"Input load failed",meta:{error:u}})}),e.fileInputEl.value="")})}function l(){a()}function p(){}function r(){}return{id:"image",bind:l,mount:p,unmount:r}}function Ue(e,t,n){return Number.isFinite(e)?Math.max(t,Math.min(n,Math.trunc(e))):t}function Wn(e,t,n){return Math.round(.2126*e+.7152*t+.0722*n)}function Nt(e){return{edgesDark:!!(e.edgesDark??!0),edgeThreshold:Ue(e.edgeThreshold??80,0,255),edgeDilate:Ue(e.edgeDilate??2,0,6),maxRegionPx:Ue(e.maxRegionPx??2e5,1e3,1e7)}}function Jn(e,t,n){const{data:i,width:o,height:s}=e,a=new Uint8Array(o*s);for(let l=0,p=0;l<a.length;l++,p+=4){const r=i[p+0],f=i[p+1],g=i[p+2];if(i[p+3]===0){a[l]=0;continue}const u=Wn(r,f,g),d=t?u<=n:u>=255-n;a[l]=d?1:0}return a}function qn(e,t,n,i){if(i<=0)return e;let o=e;for(let s=0;s<i;s++){const a=new Uint8Array(t*n);for(let l=0;l<n;l++)for(let p=0;p<t;p++){const r=l*t+p;if(o[r]){a[r]=1;continue}let f=0;for(let g=-1;g<=1&&!f;g++){const h=l+g;if(!(h<0||h>=n))for(let u=-1;u<=1;u++){const d=p+u;if(!(d<0||d>=t)&&o[h*t+d]){f=1;break}}}a[r]=f}o=a}return o}function Yn(e,t,n,i,o,s){const a=t*i+e;if(n[a])return{ok:!1,message:"Click is on an edge; pick inside a region."};const l=new Uint8Array(i*o),p=new Int32Array(i*o),r=new Int32Array(i*o);let f=0,g=0;p[g]=e,r[g]=t,g++,l[a]=1;let h=1;for(;f<g;){const u=p[f],d=r[f];f++;const m=[[u-1,d],[u+1,d],[u,d-1],[u,d+1]];for(const[v,y]of m){if(v<0||v>=i||y<0||y>=o)continue;const b=y*i+v;if(!l[b]&&!n[b]&&(l[b]=1,p[g]=v,r[g]=y,g++,h++,h>s))return{ok:!1,message:`Region too large (>${s}px). Increase Max region or fix gaps.`}}}return{ok:!0,mask:l}}function Zn(e,t,n,i){const o=new Uint8Array(n*i);for(let s=1;s<i-1;s++)for(let a=1;a<n-1;a++){const l=s*n+a;if(!e[l])continue;const p=(s-1)*n+a,r=(s+1)*n+a,f=s*n+(a-1),g=s*n+(a+1);(!e[p]||!e[r]||!e[f]||!e[g]||t[p]||t[r]||t[f]||t[g])&&(o[l]=1)}return o}function Qn(e,t,n,i){const o=Nt(i),s=e.width,a=e.height;let l=Jn(e,o.edgesDark,o.edgeThreshold);l=qn(l,s,a,o.edgeDilate);const p=Yn(t,n,l,s,a,o.maxRegionPx);if(!p.ok)return{ok:!1,message:p.message};const r=Zn(p.mask,l,s,a);return{ok:!0,preview:{mask:p.mask,outline:r,w:s,h:a}}}function Xn(e,t,n){const i=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),o=n.replace("#",""),s=parseInt(o.slice(0,2),16),a=parseInt(o.slice(2,4),16),l=parseInt(o.slice(4,6),16),p=i.data;for(let r=0,f=0;r<t.mask.length;r++,f+=4)t.mask[r]&&(p[f+0]=s,p[f+1]=a,p[f+2]=l);return i}function Ve(e,t,n){return Number.isFinite(e)?Math.max(t,Math.min(n,Math.trunc(e))):t}function ct(e){const t=(e||"").trim();if(!t)return null;const n=t.startsWith("#")?t:`#${t}`;return/^#[0-9a-fA-F]{6}$/.test(n)?n.toLowerCase():null}function ei(e){let t="#ff3b30",n=[],i=null;function o(m){e.colorsStatusEl.textContent=m||""}function s(){const m=!!e.edgesDarkEl.checked,v=Ve(parseInt(e.edgeMaskThresholdEl.value,10),0,255),y=Ve(parseInt(e.edgeDilateEl.value,10),0,6),b=Ve(parseInt(e.maxRegionPxEl.value,10),1e3,1e7);return e.edgeMaskThresholdEl.value=String(v),e.edgeDilateEl.value=String(y),e.maxRegionPxEl.value=String(b),Nt({edgesDark:m,edgeThreshold:v,edgeDilate:y,maxRegionPx:b})}function a(m){const v=ct(m);if(v){t=v;for(const y of Array.from(e.paletteEl.querySelectorAll(".paletteItem"))){const b=y.dataset.hex||"";y.classList.toggle("is-selected",b===t)}}}function l(){return t}function p(m){n=m.slice(),e.paletteEl.innerHTML="";for(const v of n){const y=ct(v);if(!y)continue;const b=document.createElement("button");b.type="button",b.className="paletteItem",b.style.background=y,b.dataset.hex=y,b.setAttribute("role","listitem"),b.setAttribute("aria-label",`Select ${y}`),b.addEventListener("click",()=>{a(y)}),e.paletteEl.appendChild(b)}a(t)}function r(m){const v=e.colorsCanvasEl;v.width=m.width,v.height=m.height,v.getContext("2d").putImageData(m,0,0)}function f(m,v){r(m);const y=e.colorsCanvasEl.getContext("2d"),{outline:b,w:k,h:C}=v,E=y.getImageData(0,0,k,C),I=E.data;for(let A=0,D=0;A<b.length;A++,D+=4)b[A]&&(I[D+0]=255,I[D+1]=60,I[D+2]=60,I[D+3]=220);y.putImageData(E,0,0)}function g(m){e.btnColorsApplyEl.disabled=!m}function h(m){e.btnColorsCancelEl.disabled=!m}function u(m){i=m}function d(){o("Idle"),g(!1),h(!1),e.colorsCanvasEl.addEventListener("click",m=>{if(!i)return;const v=e.colorsCanvasEl.getBoundingClientRect(),y=Math.floor((m.clientX-v.left)/v.width*e.colorsCanvasEl.width),b=Math.floor((m.clientY-v.top)/v.height*e.colorsCanvasEl.height);i(y,b)})}return{bind:d,setStatus:o,getSettings:s,setSelectedColor:a,getSelectedColor:l,renderPalette:p,drawBase:r,drawPreview:f,setApplyEnabled:g,setCancelEnabled:h,onCanvasClick:u}}let jt={type:"none"};function fe(e){jt=e}function dt(){return jt}function Ne(e){var a,l,p,r,f;if(!e){fe({type:"none"});return}const t=(a=e.outputSvg)==null?void 0:a.svg;if(typeof t=="string"&&t.length>0){fe({type:"svg",svg:t});return}const n=(l=e.outputImage)==null?void 0:l.data;if(n){fe({type:"image",image:n});return}const i=(p=e.outputMask)==null?void 0:p.data,o=(r=e.outputMask)==null?void 0:r.width,s=(f=e.outputMask)==null?void 0:f.height;if(i&&typeof o=="number"&&typeof s=="number"){fe({type:"mask",mask:i,width:o,height:s});return}fe({type:"none"})}const ti=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#a2845e","#8e8e93","#1c1c1e","#ffffff","#000000","#4cd964","#5ac8fa","#ff6b6b","#7aa2ff","#f5a623","#50e3c2"];function ni(e,t){const n=ei(e);let i=null,o=null;function s(u){n.setStatus(u)}function a(u,d,m){const v=new ImageData(d,m),y=v.data;for(let b=0,k=0;b<u.length;b++,k+=4){const E=(u[b]??0)>0?0:255;y[k+0]=E,y[k+1]=E,y[k+2]=E,y[k+3]=255}return v}function l(){const u=dt();return u.type==="image"?u.image:u.type==="mask"?a(u.mask,u.width,u.height):null}function p(){return dt().type==="svg"?"Pipeline output is SVG. Colors needs an image or mask output.":"No pipeline output available. Run the Pipeline first."}function r(){const u=l();if(!u){i=null,o=null,n.setApplyEnabled(!1),n.setCancelEnabled(!1),s(p());return}i=u,o=null,n.drawBase(i),n.setApplyEnabled(!1),n.setCancelEnabled(!1),s("Ready. Pick a color, click inside a region.")}function f(){if(i){n.drawBase(i);return}const u=l();if(!u){s(p());return}i=u,o=null,n.drawBase(i),n.setApplyEnabled(!1),n.setCancelEnabled(!1),s("Loaded pipeline output. Pick a color, click inside a region.")}function g(){if(!i||!o)return;const u=n.getSelectedColor();i=Xn(i,o,u),o=null,n.drawBase(i),n.setApplyEnabled(!1),n.setCancelEnabled(!1),s("Fill applied. Click another region.")}function h(){i&&(o=null,n.drawBase(i),n.setApplyEnabled(!1),n.setCancelEnabled(!1),s("Preview canceled."))}return{bind(){n.bind(),n.renderPalette(ti),n.onCanvasClick((u,d)=>{if(!i){s(p());return}const m=n.getSettings(),v=Qn(i,u,d,m);if(!v.ok){o=null,n.setApplyEnabled(!1),n.setCancelEnabled(!1),s(v.message);return}o=v.preview,n.drawPreview(i,o),n.setApplyEnabled(!0),n.setCancelEnabled(!0),s("Preview shown. Apply fill or cancel.")}),e.btnColorsApplyEl.addEventListener("click",()=>g()),e.btnColorsCancelEl.addEventListener("click",()=>h()),e.btnColorsResetEl.addEventListener("click",()=>r()),e.tabColors.addEventListener("click",()=>{queueMicrotask(()=>f())}),s("Idle"),n.setApplyEnabled(!1),n.setCancelEnabled(!1)}}}const ut="0.1.7";function je(e){return`[BCT][${e}]`}function ii(e){function t(...s){e.traceOn()&&console.log(je("trace"),...s)}function n(...s){console.warn(je("warn"),...s)}function i(...s){console.error(je("error"),...s)}function o(s,a){t(s,a),q({scope:e.scope,kind:"debug",message:s,meta:a})}return{logTrace:t,logWarn:n,logError:i,traceScope:o}}const{logTrace:j,logWarn:xe,logError:re,traceScope:zt}=ii({scope:"panel",traceOn:()=>!!Re().traceConsole});let J=0;function Y(){return J>0}function te(e,t){if(t){Ft(e);return}J=0,Le(e,!1)}async function oi(e,t){const n=`${Date.now()}-${Math.random().toString(16).slice(2)}`;j("[state] withBusy: enter",{id:n,busyCount:J}),Ft(e,n);try{j("[state] withBusy: before await fn",{id:n,busyCount:J});const i=await t();return j("[state] withBusy: after await fn (resolved)",{id:n,busyCount:J}),i}catch(i){throw re("[state] withBusy: fn threw",{id:n,busyCount:J,msg:String((i==null?void 0:i.message)??i),stack:String((i==null?void 0:i.stack)??"")}),i}finally{j("[state] withBusy: finally before endBusy",{id:n,busyCount:J}),ai(e,n),j("[state] withBusy: finally after endBusy",{id:n,busyCount:J})}}function Ft(e,t){J++,j("[state] beginBusy",{id:t,busyCount:J}),J===1&&Le(e,!0)}function ai(e,t){if(J--,j("[state] endBusy: dec",{id:t,busyCount:J}),J<=0){J=0,j("[state] endBusy: applying busy=false",{id:t,busyCount:J}),Le(e,!1);return}J===0&&(j("[state] endBusy: applying busy=false (redundant branch)",{id:t,busyCount:J}),Le(e,!1))}function Le(e,t){e.rootEl.classList.toggle("is-busy",t),e.cfgShowDevToolsEl.disabled=!1,e.fileInputEl.disabled=t,e.cfgTraceConsoleEl.disabled=t,e.cfgActionLogMaxEl.disabled=t,e.cfgDebugTraceMaxEl.disabled=t,e.cfgFailureLogsPerRunEl.disabled=t,e.btnCfgResetDefaults.disabled=t,e.logsCbDebugEl.disabled=t,e.cfgUseOpenCvEl.disabled=t,e.logsLimitEl.disabled=t,e.btnLogsRefresh.disabled=t,e.logsTrimKeepEl.disabled=t,e.btnLogsTrim.disabled=t,e.btnLogsExport.disabled=t,e.btnLogsClear.disabled=t,e.debugLimitEl.disabled=t,e.btnDebugRefresh.disabled=t,e.btnDebugExport.disabled=t,e.btnDebugClear.disabled=t,e.btnColorsApplyEl.disabled=t,e.btnColorsCancelEl.disabled=t,e.btnColorsResetEl.disabled=t,e.edgesDarkEl.disabled=t,e.edgeMaskThresholdEl.disabled=t,e.edgeDilateEl.disabled=t,e.maxRegionPxEl.disabled=t;for(const n of Array.from(e.paletteEl.querySelectorAll("button")))n.disabled=t;e.colorsCanvasEl.style.pointerEvents=t?"none":"auto"}const ot={native:{available:!0},opencv:{available:!1,reason:"OpenCV not loaded"}};function si(e){ot[e]={available:!0}}function ri(e,t){ot[e]={available:!1,reason:t}}function le(){return ot.opencv.available===!0}async function li(e){const t=new URL(e.opencvJsRel,document.baseURI).toString(),n=new URL(e.opencvWasmRel,document.baseURI).toString(),i=globalThis;i.Module=i.Module||{},i.Module.locateFile=o=>o.endsWith(".wasm")?n:o,i.Module.print=()=>{},i.Module.printErr=()=>{},i.cv||await ci(t),await di(e.timeoutMs)}function ci(e){return new Promise((t,n)=>{const i=document.createElement("script");i.src=e,i.async=!0;const o=15e3,s=window.setTimeout(()=>{a(),n(new Error(`OpenCV script load timeout after ${o}ms: ${e}`))},o);function a(){window.clearTimeout(s),i.onload=null,i.onerror=null}i.onload=()=>{a(),t()},i.onerror=()=>{a(),n(new Error(`Failed to load OpenCV script: ${e}`))},document.head.appendChild(i)})}async function di(e){var i;const t=Date.now(),n=globalThis;for(;Date.now()-t<e;){try{if(n.cv&&typeof n.cv.Mat=="function"){const o=new n.cv.Mat;(i=o.delete)==null||i.call(o);return}}catch{}await new Promise(o=>setTimeout(o,75))}throw new Error(`OpenCV initialization timeout after ${e}ms`)}async function ui(){try{await li({opencvJsRel:"../assets/opencv/opencv.js",opencvWasmRel:"../assets/opencv/opencv.wasm",timeoutMs:2e4}),si("opencv")}catch(e){throw ri("opencv",e!=null&&e.message?String(e.message):String(e)),e}}function G(e,t,n,i,o,s,a){return{id:e,title:t,implementedEngines:n,defaultEnginePolicy:i,params:o,children:s,description:a}}function pi(e){const t=new Map,n=new Map;function i(o,s){if(t.has(o.id))throw new Error(`[tuning] Duplicate component id: ${o.id}`);t.set(o.id,o),n.set(o.id,s);for(const a of o.children??[])i(a,o.id)}return i(e,null),{root:e,byId:t,parentById:n}}function _t(){const e=G("app","BeeMage",["native","opencv"],"native",{},[G("edge","Edge",["native","opencv"],"auto",{},[G("edge.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),G("edge.threshold","Threshold",["native","opencv"],"auto",{manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128}},void 0,"Convert image into a binary mask before edge extraction."),G("edge.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:3},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Clean the mask before extracting edges."),G("edge.extract","Edge extract",["native","opencv"],"auto",{},void 0,"Extract a 1px outline from the cleaned mask.")],"Fixed-order edge pipeline (image -> mask -> edges). Presets configure each step."),G("svg","SVG",["native","opencv"],"auto",{},[G("svg.create","Create SVG",["native","opencv"],"auto",{scale:{kind:"number",label:"Scale",min:1,max:10,step:1,default:1},transparentBg:{kind:"number",label:"Transparent bg (0/1)",min:0,max:1,step:1,default:1},color:{kind:"text",label:"Color",default:"#3bca1e"}},void 0,"Convert the edge mask into an SVG.")],"SVG generation parameters."),G("segmentation","Segmentation",["native","opencv"],"auto",{},[G("segmentation.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),G("segmentation.denoise","Denoise",["native","opencv"],"auto",{denoiseAlgo:{kind:"number",label:"Denoise algo",min:0,max:2,step:1,default:1},blurK:{kind:"number",label:"Blur kernel",min:1,max:21,step:2,default:3},bilateralSigma:{kind:"number",label:"Bilateral sigma",min:1,max:150,step:1,default:35}},void 0,"Reduce noise before thresholding."),G("segmentation.color","Color / Gray",["native","opencv"],"auto",{colorMode:{kind:"number",label:"Color mode",min:0,max:3,step:1,default:1},hsvChannel:{kind:"number",label:"HSV channel",min:0,max:2,step:1,default:2}},void 0,"Select color space / channel features for thresholding."),G("segmentation.threshold","Threshold",["native","opencv"],"auto",{thresholdAlgo:{kind:"number",label:"Threshold algo",min:0,max:3,step:1,default:1},manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128},adaptBlock:{kind:"number",label:"Adaptive block",min:3,max:101,step:2,default:31},adaptC:{kind:"number",label:"Adaptive C",min:-50,max:50,step:1,default:3}},void 0,"Convert features into a binary mask."),G("segmentation.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:5},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Remove specks, fill holes, and stabilize regions.")],"Fixed-order segmentation pipeline. Presets configure each step."),G("image","iMage",["native","opencv"],"auto",{},[G("mage.process","Process",["native"],"auto",{imageScale:{kind:"number",label:"Processing scale",min:25,max:100,step:5,default:100},edgeThreshold:{kind:"number",label:"Edge threshold",min:1,max:255,step:1,default:70},invertOutput:{kind:"boolean",label:"White background",default:!0}}),G("mage.clean","Clean & Smooth",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:500,step:1,default:12},cleanRadius:{kind:"number",label:"Repair strength",min:1,max:3,step:1,default:1},cleanBinaryThreshold:{kind:"number",label:"Binary threshold",min:1,max:254,step:1,default:128}},[G("mage.clean.threshold","Threshold",["native"],"auto",{}),G("mage.clean.removeSmallComponents","Remove small components",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:5e3,step:1,default:12}},void 0,"Remove connected components smaller than the minimum area."),G("mage.clean.repair","Repair gaps",["native"],"auto",{}),G("mage.clean.smooth","Smooth mask",["native"],"auto",{}),G("mage.clean.quality","Quality metrics",["native"],"auto",{})]),G("mage.vectorize","Vectorize (SVG)",["native"],"native",{pathSmoothIters:{kind:"number",label:"Path smoothing",min:0,max:4,step:1,default:2}})]),G("colors","Colors",["native"],"auto",{},[G("colors.fill","Region fill",["native"],"auto",{edgesDark:{kind:"boolean",label:"Edges are dark",default:!0},edgeMaskThreshold:{kind:"number",label:"Edge threshold",min:0,max:255,step:1,default:80},edgeDilate:{kind:"number",label:"Gap close (px)",min:0,max:6,step:1,default:2},maxRegionPx:{kind:"number",label:"Max region (px)",min:1e3,step:1e3,default:2e5}})]),G("pipeline","Pipeline (UI)",["native","opencv"],"auto",{mode:{kind:"text",label:"Pipeline",default:"segmentation"},recipe:{kind:"text",label:"Recipe",default:"default"}},void 0,"UI state for the Pipeline tab (selected pipeline + recipe).")]);return pi(e)}function gi(e){return e.default}function fi(e,t){const n={};for(const[i,o]of Object.entries(e))n[i]=gi(o);for(const[i,o]of Object.entries(t??{}))n[i]=o;return n}function hi(e,t,n){var o;let i=e;for(;i;){const s=t.byId.get(i);if(!s)throw new Error(`[tuning] Unknown component: ${i}`);const l=((o=n[i])==null?void 0:o.enginePolicy)??s.defaultEnginePolicy;if(l!=="inherit")return l;i=t.parentById.get(i)??null}return"native"}function mi(e,t,n){const i=n.opencvReady&&e.includes("opencv");return e.includes("native")||e.length,t==="native"?{engine:"native"}:t==="opencv"?i?{engine:"opencv"}:{engine:"native",fallbackReason:n.opencvReady?"Policy=opencv, but component has no OpenCV implementation.":"Policy=opencv, but OpenCV is not available at runtime."}:t==="auto"?i?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}function Gt(e,t,n,i){var r;const o=t.byId.get(e);if(!o)throw new Error(`[tuning] Unknown component: ${e}`);const s=hi(e,t,n),{engine:a,fallbackReason:l}=mi(o.implementedEngines,s,i),p=fi(o.params,(r=n[e])==null?void 0:r.params);return{id:e,policy:s,engine:a,fallbackReason:l,params:p}}const Ye="beemage.tuning.components.v1";async function ye(){const e=await oe([Ye]).catch(()=>({})),t=e==null?void 0:e[Ye];return!t||typeof t!="object"?{}:t}async function Kt(e){await ae({[Ye]:e}).catch(()=>null)}async function ze(e,t){const n=await ye(),i=n[e]??{};n[e]={enginePolicy:t.enginePolicy??i.enginePolicy,params:{...i.params??{},...t.params??{}}},await Kt(n)}async function pt(e){const t=await ye();delete t[e],await Kt(t)}function bi(){return{opencvReady:le()}}function yi(e){return Array.isArray(e.children)&&e.children.length>0}function Ht(e){const{id:t,registry:n,stored:i,runtime:o}=e,s=n.byId.get(t);if(!s)throw new Error(`[tuning] Unknown component: ${t}`);const a=Gt(t,n,i,o),l=i[t],p=l==null?void 0:l.enginePolicy,r=l==null?void 0:l.params,f=s.implementedEngines.includes("opencv"),g=!!o.opencvReady,h=[];for(const u of s.children??[])h.push(Ht({id:u.id,registry:n,stored:i,runtime:o}));return{id:s.id,title:s.title,description:s.description,isGroup:yi(s),implementedEngines:s.implementedEngines,storedPolicy:p,storedParams:r,effectivePolicy:a.policy,effectiveEngine:a.engine,fallbackReason:a.fallbackReason,paramsSchema:s.params,effectiveParams:a.params,canImplementOpenCv:f,runtimeOpenCvReady:g,children:h}}function Wt(e={}){const t=e.registry??_t(),n=e.getRuntimeAvailability??bi;async function i(p="app"){const r=await ye(),f=n();if(!t.byId.get(p))throw new Error(`[tuning] Unknown scope: ${p}`);const h=Ht({id:p,registry:t,stored:r,runtime:f});return{scopeId:p,runtime:f,stored:r,root:h}}async function o(p,r){await ze(p,{enginePolicy:r})}async function s(p,r,f){await ze(p,{params:{[r]:f}})}async function a(p){await pt(p)}async function l(p,r){const g=(await ye())[p];if(!(g!=null&&g.params))return;const h={...g.params??{}};delete h[r];const u=typeof g.enginePolicy=="string",d=Object.keys(h).length>0;if(!u&&!d){await pt(p);return}await ze(p,{enginePolicy:g.enginePolicy,params:h})}return{getRegistry:()=>t,loadTree:i,setEnginePolicy:o,setParam:s,resetNode:a,resetParam:l}}function F(e,t,n){const i=document.createElement(e);if(t)for(const[o,s]of Object.entries(t))i.setAttribute(o,s);return typeof n=="string"&&(i.textContent=n),i}function gt(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function vi(e){return e.fallbackReason?`${e.effectiveEngine} (fallback)`:e.effectiveEngine}function wi(e){const t=[{value:"native",label:"Native"},{value:"auto",label:"Auto"},...e.canImplementOpenCv?[{value:"opencv",label:"OpenCV"}]:[]];return e.isRoot?t:[{value:"inherit",label:"Inherit"},...t]}function Ei(e){return!1}function Ci(e,t,n){var o;const i=(o=e.storedParams)==null?void 0:o[t];return typeof i<"u"&&i!==n}function Ii(e){var g;const{node:t,compId:n,key:i,schema:o,value:s,handlers:a}=e,l=F("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),p=F("label",{class:"fieldInline"}),r=F("span",void 0,o.label);p.appendChild(r);let f;if(o.kind==="number"?(f=F("input"),f.type="number",typeof o.min=="number"&&(f.min=String(o.min)),typeof o.max=="number"&&(f.max=String(o.max)),typeof o.step=="number"&&(f.step=String(o.step)),f.value=String(s??o.default),f.addEventListener("change",()=>{const h=Number(f.value);a.onSetParam(n,i,Number.isFinite(h)?h:o.default)})):o.kind==="boolean"?(f=F("input"),f.type="checkbox",f.checked=!!s,f.addEventListener("change",()=>{a.onSetParam(n,i,!!f.checked)})):(f=F("input"),f.type="text",f.value=String(s??o.default),f.addEventListener("change",()=>{a.onSetParam(n,i,String(f.value??o.default))})),p.appendChild(f),l.appendChild(p),a.onResetParam&&typeof((g=t.storedParams)==null?void 0:g[i])<"u"){const h=F("button",{type:"button"},"Reset");h.addEventListener("click",u=>{var d;u.preventDefault(),(d=a.onResetParam)==null||d.call(a,n,i)}),l.appendChild(h)}return Ci(t,i,s)&&l.appendChild(F("span",{class:"muted",style:"font-size:12px;"},"override")),l}function Jt(e){const{node:t,depth:n,isRoot:i,handlers:o,treeScopeId:s}=e,a=F("div",{style:`margin-left:${Math.min(n*14,56)}px; margin-top:10px;`}),l=F("div",{style:"border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:10px; background:rgba(0,0,0,0.12);"}),p=F("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),r=F("div");r.appendChild(F("div",{style:"font-weight:700;"},t.title)),t.description&&r.appendChild(F("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},t.description)),t.isGroup&&r.appendChild(F("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},"Group (policy affects children)")),p.appendChild(r);const f=F("div",{class:"row",style:"align-items:center; gap:10px;"});f.appendChild(F("span",{class:"qBadge"},vi(t)));const g=F("select");g.style.background="rgba(255,255,255,0.05)",g.style.border="1px solid rgba(255,255,255,0.08)",g.style.color="rgba(255,255,255,0.92)",g.style.borderRadius="10px",g.style.padding="6px 8px";const h=wi({isRoot:i,canImplementOpenCv:t.canImplementOpenCv});for(const k of h){const C=F("option");C.value=k.value,C.textContent=k.label,g.appendChild(C)}const u=new Set(h.map(k=>k.value)),d=t.effectivePolicy;u.has(d)?g.value=d:g.value=i?"native":"inherit",g.addEventListener("change",()=>{o.onSetPolicy(t.id,g.value)}),f.appendChild(g);const m=typeof t.storedPolicy<"u"||t.storedParams&&Object.keys(t.storedParams).length>0;if(o.onResetNode&&m){const k=F("button",{type:"button"},"Reset node");k.addEventListener("click",C=>{var E;C.preventDefault(),(E=o.onResetNode)==null||E.call(o,t.id)}),f.appendChild(k)}p.appendChild(f),l.appendChild(p),t.fallbackReason?l.appendChild(F("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},t.fallbackReason)):t.effectivePolicy==="opencv"&&!t.runtimeOpenCvReady&&l.appendChild(F("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},"OpenCV policy selected, but OpenCV is not available at runtime. It will fall back to native."));const v=Object.keys(t.paramsSchema??{}),y=v.length>0,b=t.children.length>0;if(y||b){const k=F("details",{style:"margin-top:10px;"});k.open=Ei();const C=F("summary",{style:"cursor:pointer; user-select:none;"},"Details");if(k.appendChild(C),y){const E=F("div",{style:"margin-top:10px;"});E.appendChild(F("div",{class:"muted",style:"font-weight:600; margin-bottom:6px;"},"Parameters"));for(const I of v){const A=t.paramsSchema[I],D=t.effectiveParams[I];E.appendChild(Ii({node:t,compId:t.id,key:I,schema:A,value:D,handlers:o}))}k.appendChild(E)}if(b){const E=F("div",{style:"margin-top:10px;"});for(const I of t.children)E.appendChild(Jt({node:I,depth:n+1,isRoot:!1,handlers:o,treeScopeId:s}));k.appendChild(E)}l.appendChild(k)}return a.appendChild(l),a}function qt(e,t){let n=!1;function i(s){if(n)return;gt(e);const a=s.scopeId==="app",l=F("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"});l.appendChild(F("div",{style:"font-weight:700;"},"Tuning")),l.appendChild(F("div",{class:"muted",style:"font-size:12px;"},`OpenCV runtime: ${s.runtime.opencvReady?"ready":"not available"}`)),e.appendChild(l),e.appendChild(Jt({node:s.root,depth:0,isRoot:a,handlers:t,treeScopeId:s.scopeId}))}function o(){n=!0,gt(e)}return{render:i,dispose:o}}function ki(){let e=!1,t={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},n=!1,i="",o="";function s(r){e=r}function a(r){t={...t,...r}}function l(r){n=r}function p(r){typeof r.general=="string"&&(i=r.general),typeof r.dev=="string"&&(o=r.dev)}return{get showDevTools(){return e},get dev(){return t},get debugEnabled(){return n},get generalStatus(){return i},get devStatus(){return o},setShowDevTools:s,setDev:a,setDebugEnabled:l,setStatus:p}}function Si(e){function t(r){e.settingsGeneralStatusEl.textContent=r||""}function n(r){e.cfgStatusEl.textContent=r||""}function i(r){e.cfgShowDevToolsEl.checked=r}function o(r){e.tabLogs.hidden=!r,e.devConfigDetailsEl.classList.toggle("is-hidden",!r),r||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function s(r){e.cfgTraceConsoleEl.checked=!!r.traceConsole,e.cfgActionLogMaxEl.value=String(r.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(r.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(r.failureLogsPerRun??50)}function a(r){e.logsCbDebugEl.checked=r}function l(r,f){e.settingsVersionEl.textContent=r||"—",e.settingsGitHubLinkEl.href=f||"#",e.settingsGitHubLinkEl.hidden=!f}function p(r){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=r,e.cfgActionLogMaxEl.disabled=r,e.cfgDebugTraceMaxEl.disabled=r,e.cfgFailureLogsPerRunEl.disabled=r,e.btnCfgResetDefaults.disabled=r,e.logsCbDebugEl.disabled=r,e.cfgUseOpenCvEl.disabled=r}return{setGeneralStatus:t,setDevStatus:n,setShowDevToolsChecked:i,setDevToolsVisible:o,setDevConfig:s,setDebugEnabledChecked:a,setAbout:l,setBusy:p}}const Fe="template.settings.showDevTools",_e="beemage.settings.engine.useOpenCv";function xi(){var e,t;try{const n=(e=globalThis==null?void 0:globalThis.chrome)==null?void 0:e.runtime,i=(t=n==null?void 0:n.getManifest)==null?void 0:t.call(n),o=typeof(i==null?void 0:i.version)=="string"?i.version:"";if(j("Settings: getManifestVersion manifest found version is ",{v:o}),o)return o}catch{}return j("Settings: getManifestVersion fallback",{APP_VERSION:ut}),ut}function Ge(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??Z.actionLogMax),debugTraceMax:Number(e.debugTraceMax??Z.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??Z.failureLogsPerRun)}}function Pi(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:ie(e.cfgActionLogMaxEl.value,100,5e4,Z.actionLogMax),debugTraceMax:ie(e.cfgDebugTraceMaxEl.value,100,5e4,Z.debugTraceMax),failureLogsPerRun:ie(e.cfgFailureLogsPerRunEl.value,0,5e4,Z.failureLogsPerRun)}}async function ft(e){const t=Vt;return typeof t.setEnabled=="function"?(await t.setEnabled(e),{ok:!0}):typeof t.enable=="function"&&typeof t.disable=="function"?(await(e?t.enable():t.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function Ai(e,t){const n=ki(),i=Si(e),o=Wt({getRuntimeAvailability:()=>({opencvReady:e.cfgUseOpenCvEl.checked&&le()})}),s=qt(e.tuningMountEl,{onSetPolicy:async(c,w)=>{await o.setEnginePolicy(c,w),await b("policy change")},onSetParam:async(c,w,R)=>{await o.setParam(c,w,R),await b("param change")},onResetNode:async c=>{await o.resetNode(c),await b("reset node")},onResetParam:async(c,w)=>{await o.resetParam(c,w),await b("reset param")}});function a(c){e.settingsEngineBoxEl.classList.toggle("is-hidden",!1)}async function l(){const c=await oe([_e]).catch(()=>({}));return(c==null?void 0:c[_e])===!0}async function p(c){await ae({[_e]:!!c}).catch(()=>null)}function r(c){var w;e.cfgUseOpenCvEl.checked=c,(w=e.cfgUseOpenCvEl.closest(".switch"))==null||w.classList.toggle("is-disabled",e.cfgUseOpenCvEl.disabled)}function f(c){e.cfgOpenCvSpinner.classList.toggle("is-hidden",!c),e.cfgOpenCvSpinner.setAttribute("aria-hidden",c?"false":"true")}function g(c){e.cfgOpenCvStatus.textContent=c||""}function h(c){e.cfgOpenCvReport.textContent=c||""}async function u(){if(Y())return;if(!!!e.cfgUseOpenCvEl.checked){await p(!1),f(!1),g(le()?"OpenCV loaded (native mode)":"Native mode"),h("Native mode. OpenCV is optional and demo-only."),await b("opencv mode disabled");return}f(!0),g("Loading OpenCV…"),h("Loading OpenCV…");try{if(await oi(e,async()=>{await ui()}),!le())throw new Error("OpenCV load returned but runtime is not injected.");await p(!0),g("OpenCV mode enabled"),h("OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV."),await b("opencv mode enabled")}catch(w){const R=String((w==null?void 0:w.message)??w);await p(!1),r(!1),g("OpenCV load failed"),h(`ERROR

${R}`),re("[settings] OpenCV toggle failed",{msg:R})}finally{f(!1)}}async function d(){const c=await oe([Fe]).catch(()=>({}));return(c==null?void 0:c[Fe])===!0}async function m(c){await ae({[Fe]:!!c}).catch(()=>null)}function v(c){n.setShowDevTools(c),i.setShowDevToolsChecked(c),i.setDevToolsVisible(c)}async function y(){const c=await d();v(c),j("Settings: boot applyDevToolsVisibility",{showDevTools:c})}async function b(c){try{const w=await o.loadTree("app");s.render(w),j("[settings] tuning rendered",{reason:c,opencvInjected:le(),opencvMode:!!e.cfgUseOpenCvEl.checked})}catch(w){re("[settings] tuning render failed",{reason:c,msg:String((w==null?void 0:w.message)??w)}),e.tuningMountEl.textContent="Tuning UI failed to load (see console)."}}async function k(){var B;i.setBusy(Y());const c=await d();v(c),await We().catch(()=>null);const w=Re();n.setDev(Ge(w)),i.setDevConfig(n.dev);const R=Vt;let M=!1;try{typeof R.isEnabled=="function"?M=!!await R.isEnabled():M=!!R.enabled}catch(S){xe("Settings: failed to read debug enabled state",{error:S instanceof Error?S.message:String(S)})}n.setDebugEnabled(M),i.setDebugEnabledChecked(M),i.setAbout(xi()||"—",((B=e.settingsGitHubLinkEl)==null?void 0:B.href)||"#"),a();{const S=await l();r(S),f(!1);const x=le();S?(g(x?"OpenCV mode enabled":"OpenCV mode (not loaded)"),h(x?"OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV.":"OpenCV mode is enabled, but OpenCV is not loaded yet. Toggle OFF then ON to load OpenCV.")):(g(x?"OpenCV loaded (native mode)":"Native mode"),h("Native mode. OpenCV is optional and demo-only."))}i.setGeneralStatus(""),i.setDevStatus(""),await b("loadAll"),j("Settings: loaded",{showDevTools:c,debugTraceEnabled:M,dev:n.dev,opencvInjected:le()})}async function C(){const c=!!e.cfgShowDevToolsEl.checked;v(c),await m(c),N({kind:"run",scope:"settings",message:c?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:c}}),j("Settings: ui toggle showDevTools",{showDevTools:c}),i.setGeneralStatus(c?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>i.setGeneralStatus(""),1200)}async function E(){const c=Pi(e);i.setDevStatus("Saving…");try{await Tt(c)}catch(w){re("Settings: failed to save dev config",{error:w instanceof Error?w.message:String(w),next:c}),i.setDevStatus("Save failed."),setTimeout(()=>i.setDevStatus(""),1200);return}n.setDev(Ge(c)),i.setDevConfig(n.dev),N({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:c}),j("Settings: devConfig updated",c),i.setDevStatus("Saved."),setTimeout(()=>i.setDevStatus(""),1200)}async function I(){i.setDevStatus("Resetting…");try{await Mn(),await We().catch(()=>null);const w=Re();n.setDev(Ge(w)),i.setDevConfig(n.dev)}catch(w){re("Settings: failed to reset dev config defaults",{error:w instanceof Error?w.message:String(w)}),i.setDevStatus("Reset failed."),setTimeout(()=>i.setDevStatus(""),1200);return}const c=await ft(!1);c.ok?(n.setDebugEnabled(!1),i.setDebugEnabledChecked(!1)):(xe("Settings: failed to reset debug enabled state",{error:c.error||"unknown error"}),N({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:c.error||"unknown error"})),N({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...Z,debugEnabled:!1}}),j("Settings: reset defaults",{...Z,debugEnabled:!1}),i.setDevStatus("Reset."),setTimeout(()=>i.setDevStatus(""),1200)}async function A(){const c=!!e.logsCbDebugEl.checked;i.setDevStatus("Saving…");const w=await ft(c);if(!w.ok){e.logsCbDebugEl.checked=!c,i.setDevStatus(`Save failed: ${w.error||"unknown error"}`),re("Settings: failed to change debug enabled state",{error:w.error||"unknown error",enabled:c}),N({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:w.error||"unknown error",meta:{enabled:c}});return}n.setDebugEnabled(c),N({kind:"run",scope:"settings",message:c?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:c}}),j("Settings: debug enabled changed",{enabled:c}),i.setDevStatus("Saved."),setTimeout(()=>i.setDevStatus(""),1200)}const D=t.on(()=>{});function O(){e.cfgShowDevToolsEl.addEventListener("change",()=>{C()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{Y()||E()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{Y()||E()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{Y()||E()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{Y()||E()}),e.btnCfgResetDefaults.addEventListener("click",()=>{Y()||I()}),e.logsCbDebugEl.addEventListener("change",()=>{Y()||A()}),e.cfgUseOpenCvEl.addEventListener("change",()=>{u()}),y().catch(c=>{xe("Settings: initDevToolsVisibility failed",{error:c instanceof Error?c.message:String(c)})})}return{id:"settings",refresh(){k().catch(c=>{re("Settings: refresh failed",{error:c instanceof Error?c.message:String(c)})})},mount(){k().catch(c=>{re("Settings: mount failed",{error:c instanceof Error?c.message:String(c)})})},unmount(){},bind:O,dispose(){D()}}}function Ri(){let e=[],t=0;function n(i){e=i.items,t=i.total}return{get items(){return e},get total(){return t},set:n}}function Di(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function ht(e,t){const n=[];n.push(`Total entries: ${t.total}`),n.push("");for(const i of t.items){const o=typeof i.ok=="boolean"?i.ok?"ok":"fail":"",s=[];typeof i.status=="number"&&s.push(`status=${i.status}`),o&&s.push(o);const a=[i.scope,i.kind].filter(Boolean).join("/");n.push(`[${Di(i.ts)}] ${a}${s.length?` (${s.join(", ")})`:""}`),n.push(`  ${i.message}`),i.error&&n.push(`  error: ${i.error}`),n.push("")}e.textContent=n.join(`
`),e.scrollTop=0}function Mi(e){function t(a){e.logsStatusEl.textContent=a}function n(a){e.debugStatusEl.textContent=a}function i(a){e.logsCbDebugEl.checked=a}function o(a){ht(e.logsOutEl,{total:a.total,items:a.items.map(l=>({ts:l.ts,message:l.message,scope:l.scope,kind:l.kind,ok:l.ok,status:l.status,error:l.error,meta:l.meta}))})}function s(a){ht(e.debugOutEl,{total:a.total,items:a.items.map(l=>({ts:l.ts,message:l.message,scope:l.scope,kind:l.kind,ok:l.ok,status:l.status,error:l.error,meta:l.meta}))})}return{setAuditStatus:t,setDebugStatus:n,setDebugChecked:i,renderAudit:o,renderDebug:s}}const mt="beemage";function Ti(e,t){const n=Ri(),i=Mi(e);async function o(){i.setAuditStatus("Loading…"),te(e,!0);try{const d=ie(e.logsLimitEl.value,10,5e3,200),m=await Nn({limit:d,reverse:!0});n.set(m),i.renderAudit({items:n.items,total:n.total}),i.setAuditStatus(`Showing ${n.items.length} (newest first)`)}catch(d){i.setAuditStatus(`Failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{te(e,!1)}}async function s(){i.setDebugStatus("Loading…"),te(e,!0);try{const d=ie(e.debugLimitEl.value,10,5e3,200),m=await Bt({limit:d,reverse:!0});i.renderDebug(m),i.setDebugStatus(`Showing ${m.items.length} (newest first)`)}catch(d){i.setDebugStatus(`Failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{te(e,!1)}}async function a(){const d=await it();i.setDebugChecked(d)}async function l(d){if(await Ot(d),i.setDebugChecked(d),!d){i.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}i.setDebugStatus("Debug ON."),await s()}async function p(){const d=ie(e.logsTrimKeepEl.value,0,5e4,2e3);i.setAuditStatus("Trimming…"),te(e,!0);try{const m=await jn({keepLast:d});await o(),i.setAuditStatus(`Trimmed. Remaining: ${m.total}`)}catch(m){i.setAuditStatus(`Trim failed: ${(m==null?void 0:m.message)||String(m)}`)}finally{te(e,!1)}}async function r(){i.setAuditStatus("Clearing…"),te(e,!0);try{await zn(),await o(),i.setAuditStatus("Cleared.")}catch(d){i.setAuditStatus(`Clear failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{te(e,!1)}}async function f(){i.setAuditStatus("Exporting…");try{const d=await Fn({pretty:!0}),m=new Blob([d],{type:"application/json"}),v=URL.createObjectURL(m),y=document.createElement("a");y.href=v,y.download=`${mt}-audit-${Date.now()}.json`,y.click(),setTimeout(()=>URL.revokeObjectURL(v),1e3),i.setAuditStatus("Exported.")}catch(d){i.setAuditStatus(`Export failed: ${(d==null?void 0:d.message)||String(d)}`)}}async function g(){i.setDebugStatus("Clearing…"),te(e,!0);try{await $t(),await s(),i.setDebugStatus("Cleared.")}catch(d){i.setDebugStatus(`Clear failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{te(e,!1)}}async function h(){i.setDebugStatus("Exporting…");try{const d=await Ut({pretty:!0}),m=new Blob([d],{type:"application/json"}),v=URL.createObjectURL(m),y=document.createElement("a");y.href=v,y.download=`${mt}-debug-${Date.now()}.json`,y.click(),setTimeout(()=>URL.revokeObjectURL(v),1e3),i.setDebugStatus("Exported.")}catch(d){i.setDebugStatus(`Export failed: ${(d==null?void 0:d.message)||String(d)}`)}}function u(){e.btnLogsRefresh.addEventListener("click",()=>{Y()||o()}),e.btnLogsTrim.addEventListener("click",()=>{Y()||p()}),e.btnLogsClear.addEventListener("click",()=>{Y()||r()}),e.btnLogsExport.addEventListener("click",()=>{Y()||f()}),e.logsCbDebugEl.addEventListener("change",()=>{Y()||l(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{Y()||s()}),e.btnDebugClear.addEventListener("click",()=>{Y()||g()}),e.btnDebugExport.addEventListener("click",()=>{Y()||h()})}return{id:"logs",bind:u,mount(){a(),o(),s()},unmount(){},dispose(){}}}function Li(e,t){if(e.id===t)return e;const n=[...e.children??[]];for(;n.length>0;){const i=n.shift();if(i.id===t)return i;for(const o of i.children??[])n.push(o)}throw new Error(`[tuning] scopeRootId not found in VM tree: ${t}`)}function Oi(e,t){if(e.id===t)return e;const n=[...e.children??[]];for(;n.length>0;){const i=n.shift();if(i.id===t)return i;for(const o of i.children??[])n.push(o)}return null}function $i(e){const t=Wt({getRuntimeAvailability:e.getRuntimeAvailability}),n=[];let i=!1;async function o(){return await t.loadTree("app")}async function s(){if(i)return;const y=await o();for(const b of n){if(b.scopeRootId==="app"){b.view.render(y);continue}const k=Li(y.root,b.scopeRootId);b.view.render({...y,scopeId:b.scopeRootId,root:k})}}async function a(y,b){await t.setEnginePolicy(y,b),e.actionLogAppend(`[tuning] policy ${y} = ${b}`),e.debugTraceAppend(`[tuning] setPolicy id=${y} policy=${b}`),await s()}async function l(y,b,k){await t.setParam(y,b,k),e.actionLogAppend(`[tuning] param ${y}.${b} = ${String(k)}`),e.debugTraceAppend(`[tuning] setParam id=${y} key=${b} value=${String(k)}`),await s()}async function p(y){await t.resetNode(y),e.actionLogAppend(`[tuning] reset node ${y}`),e.debugTraceAppend(`[tuning] resetNode id=${y}`),await s()}async function r(y,b){await t.resetParam(y,b),e.actionLogAppend(`[tuning] reset param ${y}.${b}`),e.debugTraceAppend(`[tuning] resetParam id=${y} key=${b}`),await s()}async function f(y){var b,k;if(!i){if(y.policies)for(const C of y.policies)await t.setEnginePolicy(C.id,C.policy);if(y.params)for(const C of y.params)await t.setParam(C.id,C.key,C.value);e.actionLogAppend(`[tuning] preset ${y.id} (${y.title})`),e.debugTraceAppend(`[tuning] applyPreset id=${y.id} title=${y.title} policies=${((b=y.policies)==null?void 0:b.length)??0} params=${((k=y.params)==null?void 0:k.length)??0}`),await s()}}async function g(y){const b=await o(),k=Oi(b.root,y);if(!k)throw new Error(`[tuning] getEffectiveParams: unknown component id ${y}`);return{...k.effectiveParams??{}}}async function h(y,b,k){await t.setParam(y,b,k),e.actionLogAppend(`[tuning] param ${y}.${b} = ${String(k)}`),e.debugTraceAppend(`[tuning] setParamValue id=${y} key=${b} value=${String(k)}`),await s()}function u(y){if(i)return;const{mountEl:b,scopeRootId:k}=y;if(n.some(E=>E.mountEl===b))return;const C=qt(b,{onSetPolicy:a,onSetParam:l,onResetNode:p,onResetParam:r});n.push({mountEl:b,scopeRootId:k,view:C}),s()}function d(y){const b=n.findIndex(k=>k.mountEl===y);b<0||(n[b].view.dispose(),n.splice(b,1))}async function m(){await s()}function v(){i=!0;for(const y of n)y.view.dispose();n.length=0}return{mount:u,unmount:d,refresh:m,applyPreset:f,getEffectiveParams:g,setParamValue:h,dispose:v}}function ee(e,t,n){const i=document.createElement(e);if(t)for(const[o,s]of Object.entries(t))i.setAttribute(o,s);return typeof n=="string"&&(i.textContent=n),i}function Bi(e){const t=[{kind:"input",type:e.io.input}],n=[{kind:"output",type:e.io.output}];return{id:e.id,title:e.title,group:e.group,inputs:t,outputs:n}}function Ui(e){const t=String(e||"").toLowerCase();return t==="image"?"opPort--image":t==="mask"?"opPort--mask":t==="svg"?"opPort--svg":"opPort--unknown"}function bt(e){const{ports:t,kind:n,getPortClass:i}=e,o=ee("div",{class:"opCard__portsRow"}),s=ee("div",{class:"opCard__portsLabel"},n==="input"?"IN":"OUT");o.appendChild(s);const a=ee("div",{class:"opCard__ports"});for(const l of t){const p=`opPort ${i(l.type)}`,r=l.label?`${l.label}: ${l.type}`:String(l.type),f=ee("div",{class:p,"data-port-kind":l.kind,"data-port-type":String(l.type)},r);a.appendChild(f)}return o.appendChild(a),o}function at(e,t){const n=Bi(e),i={compact:!!(t!=null&&t.compact),showId:(t==null?void 0:t.showId)??!0,showGroup:(t==null?void 0:t.showGroup)??!0,getPortClass:(t==null?void 0:t.getPortClass)??Ui,onClick:(t==null?void 0:t.onClick)??(()=>{})},o=ee("div",{class:`opCard${i.compact?" opCard--compact":""}`,"data-op-id":n.id}),s=ee("div",{class:"opCard__head"}),a=ee("div",{class:"opCard__title"},n.title);s.appendChild(a);const l=ee("div",{class:"opCard__meta"});i.showGroup&&n.group&&l.appendChild(ee("span",{class:"opBadge opBadge--group"},n.group)),i.showId&&l.appendChild(ee("span",{class:"opBadge opBadge--id"},n.id)),s.appendChild(l),o.appendChild(s);const p=ee("div",{class:"opCard__body"});return p.appendChild(bt({ports:n.inputs,kind:"input",getPortClass:i.getPortClass})),p.appendChild(bt({ports:n.outputs,kind:"output",getPortClass:i.getPortClass})),o.appendChild(p),t!=null&&t.onClick&&(o.classList.add("opCard--clickable"),o.addEventListener("click",r=>{var f,g;(f=r.preventDefault)==null||f.call(r),(g=t.onClick)==null||g.call(t,n.id)})),o}function V(e,t,n){const i=document.createElement(e);if(t)for(const[o,s]of Object.entries(t))i.setAttribute(o,s);return typeof n=="string"&&(i.textContent=n),i}function Vi(e){return e.type==="image"}function Ni(e){return e.type==="mask"}function ji(e){return e.type==="svg"}function Yt(e){return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(e)}`}function yt(e,t){if(Vi(e)){const i=V("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return Pe(i,e.image),i}if(Ni(e)){const i=V("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return Ze(i,e.mask,e.width,e.height),i}if(!ji(e))return V("div",{class:"muted",style:"margin-top:8px; font-size:12px;"},`Unsupported output: ${String(e.type)}`);const n=V("img",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`,"aria-label":"SVG preview"});return n.src=Yt(e.svg),n}function Zt(e,t){const n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download=e,i.rel="noopener",i.click(),setTimeout(()=>URL.revokeObjectURL(n),500)}async function vt(e,t){const n=await new Promise(i=>t.toBlob(o=>i(o),"image/png"));if(!n)throw new Error("Failed to create PNG blob.");Zt(e,n)}function Pe(e,t){e.width=t.width,e.height=t.height;const n=e.getContext("2d",{willReadFrequently:!0});n&&n.putImageData(t,0,0)}function Ze(e,t,n,i){e.width=n,e.height=i;const o=e.getContext("2d",{willReadFrequently:!0});if(!o)return;let s=0;const a=n*i;for(let f=0;f<a;f++){const g=t[f]??0;g>s&&(s=g)}const l=s<=1,p=o.createImageData(n,i),r=p.data;for(let f=0;f<a;f++){const g=t[f]??0;let h;l?h=(g>0?1:0)?0:255:h=g;const u=f*4;r[u]=h,r[u+1]=h,r[u+2]=h,r[u+3]=255}o.putImageData(p,0,0)}function zi(e){const{hostEl:t,statusEl:n,handlers:i}=e;let o=!1,s=null,a=null,l=null,p=null,r=null,f=null,g=null,h=null,u=null,d=null,m=null,v=null,y=null;function b(){for(;t.firstChild;)t.removeChild(t.firstChild)}async function k(c){var L,$,U,z,H;const R=(typeof(c==null?void 0:c.activePipelineId)=="string"?c.activePipelineId:"pipeline").replace(/[^a-z0-9_-]+/gi,"_").slice(0,40)||"pipeline",M=(L=c==null?void 0:c.outputSvg)==null?void 0:L.svg;if(typeof M=="string"&&M.length>0){const T=new Blob([M],{type:"image/svg+xml;charset=utf-8"});Zt(`beemage-${R}.svg`,T);return}const B=($=c==null?void 0:c.outputImage)==null?void 0:$.data;if(B){const T=document.createElement("canvas");Pe(T,B),await vt(`beemage-${R}.png`,T);return}const S=(U=c==null?void 0:c.outputMask)==null?void 0:U.data,x=(z=c==null?void 0:c.outputMask)==null?void 0:z.width,P=(H=c==null?void 0:c.outputMask)==null?void 0:H.height;if(S&&typeof x=="number"&&typeof P=="number"){const T=document.createElement("canvas");Ze(T,S,x,P),await vt(`beemage-${R}-mask.png`,T);return}throw new Error("No output to download.")}function C(){if(o)return;o=!0,b(),s=V("div",{class:"card"}),h=V("p",{class:"muted",style:"margin-top:0;"},"Universal pipeline runner. Select a pipeline and run it.");const c=V("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),w=V("label",{class:"fieldInline"});w.appendChild(V("span",{},"Pipeline")),a=V("select"),w.appendChild(a);const R=V("label",{class:"fieldInline"});R.appendChild(V("span",{},"Recipe")),l=V("select"),R.appendChild(l),p=V("button",{type:"button"},"Run all"),r=V("button",{type:"button"},"Next step"),f=V("button",{type:"button"},"Reset"),g=V("button",{type:"button"},"Download"),c.appendChild(w),c.appendChild(R),c.appendChild(p),c.appendChild(r),c.appendChild(f),c.appendChild(g);const M=V("div",{class:"grid4",style:"margin-top:12px;"}),B=V("div",{class:"card"});B.appendChild(V("div",{class:"cardTitle"},"Input (from source)")),u=V("canvas",{class:"canvas","aria-label":"Pipeline input preview"}),B.appendChild(u);const S=V("div",{class:"card"});S.appendChild(V("div",{class:"cardTitle"},"Current output")),d=V("canvas",{class:"canvas","aria-label":"Pipeline current output preview"}),m=V("img",{class:"canvas","aria-label":"Pipeline SVG output preview",style:"display:none;"}),S.appendChild(d),S.appendChild(m);const x=V("div",{class:"card",style:"grid-column:1 / -1;"});x.appendChild(V("div",{class:"cardTitle"},"Stages")),v=V("div"),x.appendChild(v),M.appendChild(B),M.appendChild(S),M.appendChild(x),s.appendChild(h),s.appendChild(c),s.appendChild(M),t.appendChild(s),a.addEventListener("change",()=>{const P=a?a.value:"segmentation";i.onSelectPipeline(P)}),l.addEventListener("change",()=>{const P=l?l.value:"default";i.onSelectRecipe(P)}),p.addEventListener("click",()=>i.onRunAll()),r.addEventListener("click",()=>i.onNext()),f.addEventListener("click",()=>i.onReset()),g.addEventListener("click",async()=>{try{await k(y)}catch(P){const L=P instanceof Error?P.message:String(P);n.textContent=`Download failed: ${L}`}})}function E(c){if(!a||!l)return;const w=Array.isArray(c==null?void 0:c.pipelines)?c.pipelines:[],R=Array.isArray(c==null?void 0:c.recipes)?c.recipes:[],M=typeof(c==null?void 0:c.activePipelineId)=="string"?c.activePipelineId:"segmentation",B=typeof(c==null?void 0:c.activeRecipeId)=="string"?c.activeRecipeId:"default";a.innerHTML="";for(const S of w){const x=V("option");x.value=S.id,x.textContent=S.title,S.id===M&&(x.selected=!0),a.appendChild(x)}l.innerHTML="";for(const S of R){const x=V("option");x.value=S.id,x.textContent=S.title,S.id===B&&(x.selected=!0),l.appendChild(x)}}function I(c){var R;if(!u)return;const w=(R=c==null?void 0:c.input)==null?void 0:R.data;if(!w){u.width=1,u.height=1;const M=u.getContext("2d");M&&M.clearRect(0,0,u.width,u.height);return}Pe(u,w)}function A(c){var P,L,$,U,z;if(!d||!m)return;const w=(P=c==null?void 0:c.outputSvg)==null?void 0:P.svg;if(typeof w=="string"&&w.length>0){d.style.display="none",m.style.display="block",m.src=Yt(w);return}d.style.display="block",m.style.display="none",m.src="";const R=(L=c==null?void 0:c.outputImage)==null?void 0:L.data;if(R){Pe(d,R);return}const M=($=c==null?void 0:c.outputMask)==null?void 0:$.data,B=(U=c==null?void 0:c.outputMask)==null?void 0:U.width,S=(z=c==null?void 0:c.outputMask)==null?void 0:z.height;if(M&&typeof B=="number"&&typeof S=="number"){Ze(d,M,B,S);return}d.width=1,d.height=1;const x=d.getContext("2d");x&&x.clearRect(0,0,d.width,d.height)}function D(c){if(!v)return;v.innerHTML="";const w=Array.isArray(c==null?void 0:c.stages)?c.stages:[];if(!w.length){v.appendChild(V("div",{class:"muted",style:"font-size:12px;"},"No stages."));return}const R=V("div",{style:"display:flex; flex-direction:column; gap:10px;"});for(const M of w)R.appendChild(O(M));v.appendChild(R)}function O(c){const w=V("div",{class:"card",style:"padding:10px;"}),R=V("div",{class:"row",style:"align-items:center; justify-content:space-between;"});R.appendChild(V("div",{style:"font-weight:bold;"},String(c.title??c.stageId))),R.appendChild(V("div",{class:"status"},String(c.state??"idle"))),w.appendChild(R),w.appendChild(V("div",{class:"muted",style:"font-size:12px;"},`${c.input} -> ${c.output}`)),typeof c.error=="string"&&c.error.length>0&&w.appendChild(V("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Stage error: ${c.error}`));const M=c.outputArtifact;M&&w.appendChild(yt(M,260));const B=Array.isArray(c.ops)?c.ops:[];if(B.length){const S=V("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:8px;"});for(let x=0;x<B.length;x++){const P=B[x],L=x===B.length-1,$=V("div",{class:"card",style:"padding:8px;"}),U=V("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),z={id:String(P.opId??""),title:String(P.title??P.opId??"Operation"),io:{input:P.input,output:P.output},group:P.group},H=at(z,{compact:!0,showGroup:!0,showId:!0});U.appendChild(H),U.appendChild(V("div",{class:"status"},String(P.state??"idle"))),$.appendChild(U),typeof P.error=="string"&&P.error.length>0&&$.appendChild(V("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Op error: ${P.error}`));const T=M&&L?void 0:P.outputArtifact;T&&$.appendChild(yt(T,200)),S.appendChild($)}w.appendChild(S)}return w}return{mount(){C()},render(c){var w,R,M;if(C(),y=c,E(c),n.textContent=typeof(c==null?void 0:c.statusText)=="string"?c.statusText:"Idle",h){const B=typeof(c==null?void 0:c.description)=="string"?c.description:"Universal pipeline runner.";h.textContent=B}if(g){const B=typeof((w=c==null?void 0:c.outputSvg)==null?void 0:w.svg)=="string"&&c.outputSvg.svg.length>0,S=!!((R=c==null?void 0:c.outputImage)!=null&&R.data),x=!!((M=c==null?void 0:c.outputMask)!=null&&M.data);g.disabled=!(B||S||x)}I(c),A(c),D(c)},dispose(){o=!1,s=null,a=null,l=null,p=null,r=null,f=null,g=null,h=null,u=null,d=null,m=null,v=null,y=null,b()}}}function we(e,t){return e.find(n=>n.id===t)??null}function Q(e,t){return{input:e,output:t}}function wt(e,t){return`${e}.${t+1}`}function Qe(e){const t=[{kind:"dispatch",id:"op.seg.resize",title:"Resize",io:Q("image","image"),dispatchId:"segmentation.resize",tuningId:"segmentation.resize",group:"Segmentation"},{kind:"dispatch",id:"op.seg.denoise",title:"Denoise",io:Q("image","image"),dispatchId:"segmentation.denoise",tuningId:"segmentation.denoise",group:"Segmentation"},{kind:"dispatch",id:"op.seg.color",title:"Color / Gray",io:Q("image","image"),dispatchId:"segmentation.color",tuningId:"segmentation.color",group:"Segmentation"},{kind:"dispatch",id:"op.seg.threshold",title:"Threshold",io:Q("image","mask"),dispatchId:"segmentation.threshold",tuningId:"segmentation.threshold",group:"Segmentation"},{kind:"dispatch",id:"op.seg.morphology",title:"Morphology cleanup",io:Q("mask","mask"),dispatchId:"segmentation.morphology",tuningId:"segmentation.morphology",group:"Segmentation"},{kind:"dispatch",id:"op.edge.resize",title:"Resize",io:Q("image","image"),dispatchId:"edge.resize",tuningId:"edge.resize",group:"Edge"},{kind:"dispatch",id:"op.edge.threshold",title:"Threshold",io:Q("image","mask"),dispatchId:"edge.threshold",tuningId:"edge.threshold",group:"Edge"},{kind:"dispatch",id:"op.edge.morphology",title:"Morphology cleanup",io:Q("mask","mask"),dispatchId:"edge.morphology",tuningId:"edge.morphology",group:"Edge"},{kind:"dispatch",id:"op.edge.extract",title:"Edge extract",io:Q("mask","mask"),dispatchId:"edge.extract",tuningId:"edge.extract",group:"Edge"},{kind:"dispatch",id:"op.svg.create",title:"Create SVG",io:Q("mask","svg"),dispatchId:"svg.create",tuningId:"svg.create",group:"SVG"},{kind:"dispatch",id:"op.mage.clean.removeSmallComponents",title:"Remove small components",io:Q("mask","mask"),dispatchId:"mage.clean.removeSmallComponents",tuningId:"mage.clean.removeSmallComponents",group:"Cleanup"},{kind:"js",id:"op.util.pass.image",title:"Pass-through (image)",io:Q("image","image"),group:"Utility",run:({input:r})=>r},{kind:"js",id:"op.util.pass.mask",title:"Pass-through (mask)",io:Q("mask","mask"),group:"Utility",run:({input:r})=>r}];function n(r){return we(t,r)}function i(r,f){return f.map((g,h)=>({instanceId:wt(r,h),opId:g,enabled:!0}))}const o=[{id:"segmentation",title:"Segmentation",implemented:!0,description:"Multi-step segmentation pipeline (image -> mask).",ops:i("segmentation",["op.seg.resize","op.seg.denoise","op.seg.color","op.seg.threshold","op.seg.morphology"])},{id:"edge",title:"Edge",implemented:!0,description:"Edge extraction pipeline (image -> mask -> edges).",ops:i("edge",["op.edge.resize","op.edge.threshold","op.edge.morphology","op.edge.extract"])},{id:"svg",title:"SVG",implemented:!0,description:"Image to SVG outline.",ops:i("svg",["op.edge.resize","op.edge.threshold","op.edge.morphology","op.edge.extract","op.svg.create"])},{id:"cleanup",title:"Cleanup (min area)",implemented:!0,description:"Image -> mask -> cleanup (morphology + remove small components).",ops:i("cleanup",["op.seg.resize","op.seg.threshold","op.seg.morphology","op.mage.clean.removeSmallComponents"])},{id:"surface",title:"Surface",implemented:!1,description:"Future: region labeling + vectorize pipeline.",ops:[]}],s=(e==null?void 0:e.userPipelines)??[];function a(r){return we(o,r)}function l(r){return we(s,r)??we(o,r)}function p(){const r=new Set(s.map(g=>g.id));return[...o.filter(g=>!r.has(g.id)),...s]}return{ops:t,getOp:n,builtIns:o,getBuiltIn:a,listPipelines:p,getPipeline:l,createInstanceId:wt}}const Et=_t();function Fi(){return{opencvReady:le()}}function _i(e){const{implemented:t,policy:n,runtimeOpenCvReady:i}=e,o=i&&t.includes("opencv");return t.includes("native")||t.length,n==="native"?{engine:"native"}:n==="opencv"?o?{engine:"opencv"}:{engine:"native",fallbackReason:i?"Override policy=opencv, but this op has no OpenCV implementation.":"Override policy=opencv, but OpenCV is not available at runtime."}:n==="auto"?o?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}async function Gi(e,t){const n=await ye(),i=Fi(),o=Gt(e,Et,n,i),s=Et.byId.get(e);if(!s)throw new Error(`[opsDispatch] Unknown op in registry: ${e}`);const l={...o.params,...(t==null?void 0:t.params)??{}},p=t!=null&&t.enginePolicy&&t.enginePolicy!=="inherit"?t.enginePolicy:o.policy;let r=o.engine,f=o.fallbackReason;if(t!=null&&t.enginePolicy&&t.enginePolicy!=="inherit"){const g=_i({implemented:s.implementedEngines,policy:p,runtimeOpenCvReady:!!i.opencvReady});r=g.engine,f=g.fallbackReason}return{engine:r,params:l,fallbackReason:f,opencvReady:!!i.opencvReady}}async function Ki(e,t,n,i){const{engine:o,params:s,fallbackReason:a,opencvReady:l}=await Gi(e,i);return o==="opencv"&&!l?(xe(`OpenCV selected for ${e} but not ready; falling back to native. ${a??""}`.trim()),await n[e].native(t,s)):await n[e][o](t,s)}function Ee(e,t,n,i){if(!t||!n)return e;const o=Math.floor(Number(i.morphAlgo??2)),s=Wi(Math.floor(Number(i.morphIters??1)),1,20),a=Math.floor(Number(i.morphK??5)),l=Hi(a),p=l-1>>1;if(o<=0||l<=1)return e;let r=e,f=new Uint8Array(t*n);for(let g=0;g<s;g++){if(o===1){It(r,f,t,n,p);const h=r;r=f,f=h;continue}if(o===2){Ct(r,f,t,n,p);const h=r;r=f,f=h;continue}Ct(r,f,t,n,p),r===e&&g===0&&(r=new Uint8Array(e)),It(f,r,t,n,p)}return r}function Hi(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:5}function Ct(e,t,n,i,o){t.fill(0);for(let s=0;s<i;s++){const a=Math.max(0,s-o),l=Math.min(i-1,s+o);for(let p=0;p<n;p++){const r=Math.max(0,p-o),f=Math.min(n-1,p+o);let g=0;for(let h=a;h<=l&&!g;h++){let u=h*n+r;for(let d=r;d<=f;d++,u++)if(e[u]){g=1;break}}t[s*n+p]=g}}}function It(e,t,n,i,o){t.fill(0);for(let s=0;s<i;s++){const a=Math.max(0,s-o),l=Math.min(i-1,s+o);for(let p=0;p<n;p++){const r=Math.max(0,p-o),f=Math.min(n-1,p+o);let g=1;for(let h=a;h<=l&&g;h++){let u=h*n+r;for(let d=r;d<=f;d++,u++)if(!e[u]){g=0;break}}t[s*n+p]=g}}}function Wi(e,t,n){return e<t?t:e>n?n:e}function Qt(e,t,n,i){const o=Math.max(0,Math.floor(Number(i??0)));if(!t||!n||o<=1)return e;const s=new Uint8Array(e),a=new Uint8Array(e.length),l=new Int32Array(e.length),p=new Int32Array(e.length);for(let r=0;r<n;r++)for(let f=0;f<t;f++){const g=r*t+f;if(e[g]===0||a[g]===1)continue;let h=0,u=0;a[g]=1,l[u]=f,p[u]=r,u++;const d=[g];for(;h<u;){const m=l[h],v=p[h];h++;const y=m-1,b=v,k=m+1,C=v,E=m,I=v-1,A=m,D=v+1;if(y>=0){const O=b*t+y;e[O]!==0&&a[O]===0&&(a[O]=1,l[u]=y,p[u]=b,u++,d.push(O))}if(k<t){const O=C*t+k;e[O]!==0&&a[O]===0&&(a[O]=1,l[u]=k,p[u]=C,u++,d.push(O))}if(I>=0){const O=I*t+E;e[O]!==0&&a[O]===0&&(a[O]=1,l[u]=E,p[u]=I,u++,d.push(O))}if(D<n){const O=D*t+A;e[O]!==0&&a[O]===0&&(a[O]=1,l[u]=A,p[u]=D,u++,d.push(O))}}if(d.length<o)for(let m=0;m<d.length;m++)s[d[m]]=0}return s}function Ji(){const e=globalThis;return e!=null&&e.cv&&typeof e.cv.Mat=="function"?e.cv:null}function qi(e,t){const{width:n,height:i}=e,o=Math.max(0,Math.floor(Number(t.cleanMinArea??0)));if(zt("OpenCV removeSmallComponents params",{width:n,height:i,minArea:o}),!n||!i||o<=1)return e.mask;const s=Ji();if(!s)return Qt(e.mask,n,i,o);const a=new s.Mat(i,n,s.CV_8UC1);try{const l=a.data,p=e.mask;for(let h=0;h<p.length;h++)l[h]=p[h]?255:0;const r=new s.Mat,f=new s.Mat,g=new s.Mat;try{const h=s.connectedComponentsWithStats(a,r,f,g,8,s.CV_32S),u=s.CC_STAT_AREA??4,d=new Array(h).fill(!1);for(let y=1;y<h;y++)f.intAt(y,u)<o&&(d[y]=!0);const m=new Uint8Array(n*i),v=r.data32S;for(let y=0;y<m.length;y++){const b=v[y];m[y]=b>0&&!d[b]?1:0}return m}finally{r.delete(),f.delete(),g.delete()}}finally{a.delete()}}function Ce(e,t,n,i){const o=Math.max(0,Math.min(255,Math.floor(Number(i.manualT??128)))),s=new Uint8Array(t*n),a=e.data;for(let l=0,p=0;l<s.length;l++,p+=4){const r=a[p],f=a[p+1],g=a[p+2],h=r*77+f*150+g*29>>8;s[l]=h>=o?1:0}return s}function Ie(e,t,n,i){const o=Math.max(1,Math.floor(Number(i.targetMaxW??t)));if(!t||!n||t<=o)return e;const s=o/t,a=Math.max(1,Math.floor(t*s)),l=Math.max(1,Math.floor(n*s));return Math.floor(Number(i.resizeAlgo??1))===0?Yi(e,t,n,a,l):Zi(e,t,n,a,l)}function Yi(e,t,n,i,o){const s=e.data,a=new Uint8ClampedArray(i*o*4),l=t/i,p=n/o;for(let r=0;r<o;r++){const f=Math.min(n-1,Math.max(0,Math.floor((r+.5)*p-.5)));for(let g=0;g<i;g++){const h=Math.min(t-1,Math.max(0,Math.floor((g+.5)*l-.5))),u=(f*t+h)*4,d=(r*i+g)*4;a[d]=s[u],a[d+1]=s[u+1],a[d+2]=s[u+2],a[d+3]=s[u+3]}}return new ImageData(a,i,o)}function Zi(e,t,n,i,o){const s=e.data,a=new Uint8ClampedArray(i*o*4),l=t/i,p=n/o;for(let r=0;r<o;r++){const f=(r+.5)*p-.5,g=ke(Math.floor(f),0,n-1),h=ke(g+1,0,n-1),u=f-g;for(let d=0;d<i;d++){const m=(d+.5)*l-.5,v=ke(Math.floor(m),0,t-1),y=ke(v+1,0,t-1),b=m-v,k=(g*t+v)*4,C=(g*t+y)*4,E=(h*t+v)*4,I=(h*t+y)*4,A=(r*i+d)*4;for(let D=0;D<4;D++){const O=s[k+D],c=s[C+D],w=s[E+D],R=s[I+D],M=O+(c-O)*b,B=w+(R-w)*b,S=M+(B-M)*u;a[A+D]=Qi(S)}}}return new ImageData(a,i,o)}function ke(e,t,n){return e<t?t:e>n?n:e}function Qi(e){return e<=0?0:e>=255?255:e|0}function kt(e,t,n,i){if(!t||!n)return e;const o=Math.floor(Number(i.denoiseAlgo??1));if(o<=0)return e;const s=Math.floor(Number(i.blurK??3)),a=Xi(s);return o===2&&a<=3?to(e,t,n):a<=1?e:eo(e,t,n,a)}function Xi(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:3}function eo(e,t,n,i){const o=i-1>>1,s=e.data,a=new Uint8ClampedArray(t*n*4);for(let p=0;p<n;p++){let r=0,f=0,g=0,h=0;for(let u=-o;u<=o;u++){const d=ce(u,0,t-1),m=(p*t+d)*4;r+=s[m],f+=s[m+1],g+=s[m+2],h+=s[m+3]}for(let u=0;u<t;u++){const d=(p*t+u)*4;a[d]=r/i|0,a[d+1]=f/i|0,a[d+2]=g/i|0,a[d+3]=h/i|0;const m=ce(u-o,0,t-1),v=ce(u+o+1,0,t-1),y=(p*t+m)*4,b=(p*t+v)*4;r+=s[b]-s[y],f+=s[b+1]-s[y+1],g+=s[b+2]-s[y+2],h+=s[b+3]-s[y+3]}}const l=new Uint8ClampedArray(t*n*4);for(let p=0;p<t;p++){let r=0,f=0,g=0,h=0;for(let u=-o;u<=o;u++){const m=(ce(u,0,n-1)*t+p)*4;r+=a[m],f+=a[m+1],g+=a[m+2],h+=a[m+3]}for(let u=0;u<n;u++){const d=(u*t+p)*4;l[d]=r/i|0,l[d+1]=f/i|0,l[d+2]=g/i|0,l[d+3]=h/i|0;const m=ce(u-o,0,n-1),v=ce(u+o+1,0,n-1),y=(m*t+p)*4,b=(v*t+p)*4;r+=a[b]-a[y],f+=a[b+1]-a[y+1],g+=a[b+2]-a[y+2],h+=a[b+3]-a[y+3]}}return new ImageData(l,t,n)}function to(e,t,n){const i=e.data,o=new Uint8ClampedArray(t*n*4),s=new Array(9),a=new Array(9),l=new Array(9),p=new Array(9);for(let r=0;r<n;r++)for(let f=0;f<t;f++){let g=0;for(let u=-1;u<=1;u++){const d=ce(r+u,0,n-1);for(let m=-1;m<=1;m++){const v=ce(f+m,0,t-1),y=(d*t+v)*4;s[g]=i[y],a[g]=i[y+1],l[g]=i[y+2],p[g]=i[y+3],g++}}s.sort(Se),a.sort(Se),l.sort(Se),p.sort(Se);const h=(r*t+f)*4;o[h]=s[4]|0,o[h+1]=a[4]|0,o[h+2]=l[4]|0,o[h+3]=p[4]|0}return new ImageData(o,t,n)}function Se(e,t){return e-t}function ce(e,t,n){return e<t?t:e>n?n:e}function St(e,t,n,i){if(!t||!n)return e;const o=Math.floor(Number(i.colorMode??1));if(o===0)return e;const s=e.data,a=new Uint8ClampedArray(t*n*4),l=io(Math.floor(Number(i.hsvChannel??2)),0,2);for(let p=0,r=0;p<t*n;p++,r+=4){const f=s[r],g=s[r+1],h=s[r+2],u=s[r+3];let d=0;if(o===1)d=f*77+g*150+h*29>>8;else if(o===2){const m=no(f,g,h),v=l===0?m.h:l===1?m.s:m.v;d=oo(v*255)}else d=255-(f*77+g*150+h*29>>8);a[r]=d,a[r+1]=d,a[r+2]=d,a[r+3]=u}return new ImageData(a,t,n)}function no(e,t,n){const i=e/255,o=t/255,s=n/255,a=Math.max(i,o,s),l=Math.min(i,o,s),p=a-l;let r=0;p!==0&&(a===i?r=(o-s)/p%6:a===o?r=(s-i)/p+2:r=(i-o)/p+4,r/=6,r<0&&(r+=1));const f=a===0?0:p/a;return{h:r,s:f,v:a}}function io(e,t,n){return e<t?t:e>n?n:e}function oo(e){return e<=0?0:e>=255?255:e|0}function xt(e,t,n){const i=new Uint8Array(e.length),o=(s,a)=>a*t+s;for(let s=0;s<n;s++)for(let a=0;a<t;a++){const l=o(a,s);if(e[l]===0)continue;if(a===0||s===0||a===t-1||s===n-1){i[l]=255;continue}const r=e[o(a-1,s)],f=e[o(a+1,s)],g=e[o(a,s-1)],h=e[o(a,s+1)];(r===0||f===0||g===0||h===0)&&(i[l]=255)}return i}function Pt(e,t,n,i){const o=Math.max(1,Math.floor(i.scale||1)),s=t*o,a=n*o,l=o;let p="";for(let h=0;h<n;h++){const u=h*t;for(let d=0;d<t;d++){if(e[u+d]===0)continue;const v=d*l,y=h*l;p+=`M${v} ${y}h${l}v${l}h-${l}Z`}}const r=i.transparentBg?"":`<rect x="0" y="0" width="${s}" height="${a}" fill="white"/>`,f=i.color||"#000",g=p.length>0?`<path d="${p}" fill="${f}" stroke="none"/>`:"";return`<svg xmlns="http://www.w3.org/2000/svg" width="${s}" height="${a}" viewBox="0 0 ${s} ${a}">`+r+g+"</svg>"}const ao="demo",so={"mage.clean.removeSmallComponents":{native:(e,t)=>Qt(e.mask,e.width,e.height,t.cleanMinArea),opencv:(e,t)=>(j("OpenCV removeSmallComponents called (demo).",{width:e.width,height:e.height,cleanMinArea:t.cleanMinArea}),qi(e,t))},"segmentation.resize":{native:(e,t)=>(j("[demo op] segmentation.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),Ie(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(j("[demo op] segmentation.resize opencv",{width:e.width,height:e.height}),Ie(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"segmentation.denoise":{native:(e,t)=>(j("[demo op] segmentation.denoise native",{width:e.width,height:e.height,denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}),kt(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma})),opencv:(e,t)=>(j("[demo op] segmentation.denoise opencv",{width:e.width,height:e.height}),kt(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}))},"segmentation.color":{native:(e,t)=>(j("[demo op] segmentation.color native",{width:e.width,height:e.height,colorMode:t.colorMode,hsvChannel:t.hsvChannel}),St(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel})),opencv:(e,t)=>(j("[demo op] segmentation.color opencv",{width:e.width,height:e.height}),St(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel}))},"segmentation.threshold":{native:(e,t)=>(j("[demo op] segmentation.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),Ce(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(j("[demo op] segmentation.threshold opencv",{width:e.width,height:e.height}),Ce(e.image,e.width,e.height,{manualT:t.manualT}))},"segmentation.morphology":{native:(e,t)=>(j("[demo op] segmentation.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),Ee(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(j("[demo op] segmentation.morphology opencv",{width:e.width,height:e.height}),Ee(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.resize":{native:(e,t)=>(j("[demo op] edge.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),Ie(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(j("[demo op] edge.resize opencv",{width:e.width,height:e.height}),Ie(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"edge.threshold":{native:(e,t)=>(j("[demo op] edge.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),Ce(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(j("[demo op] edge.threshold opencv",{width:e.width,height:e.height}),Ce(e.image,e.width,e.height,{manualT:t.manualT}))},"edge.morphology":{native:(e,t)=>(j("[demo op] edge.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),Ee(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(j("[demo op] edge.morphology opencv",{width:e.width,height:e.height}),Ee(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.extract":{native:(e,t)=>(j("[demo op] edge.extract native",{width:e.width,height:e.height}),xt(e.mask,e.width,e.height)),opencv:(e,t)=>(j("[demo op] edge.extract opencv",{width:e.width,height:e.height}),xt(e.mask,e.width,e.height))},"svg.create":{native:(e,t)=>(j("[demo op] svg.create native",{width:e.width,height:e.height,scale:t.scale}),Pt(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color})),opencv:(e,t)=>(j("[demo op] svg.create opencv",{width:e.width,height:e.height,scale:t.scale}),Pt(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color}))}};async function ue(e,t,n){return zt("[opsDispatch] runOp",{op:e,implSource:ao,inputKeys:t&&typeof t=="object"?Object.keys(t):typeof t,override:n?{enginePolicy:n.enginePolicy,paramsKeys:Object.keys(n.params??{})}:null}),Ki(e,t,so,n)}const ro=Object.freeze(Object.defineProperty({__proto__:null,runOp:ue},Symbol.toStringTag,{value:"Module"}));function lo(e){return{width:e.width,height:e.height}}function co(e){return e.type==="image"}function uo(e){return e.type==="mask"}function Xt(e){return{type:"image",width:e.width,height:e.height,image:e}}function At(e,t,n){return{type:"mask",width:t,height:n,mask:e}}function Rt(e,t,n){return{type:"svg",width:t,height:n,svg:e}}function Oe(e,t){return`IO mismatch: expected ${e}, got ${t}`}function po(e,t){if(e.length===0)return"Pipeline has no ops";let n=t;for(const i of e){if(i.io.input!==n)return`Chain IO mismatch at "${i.title}": needs ${i.io.input} but current is ${n}`;n=i.io.output}return null}async function go(e,t,n){const i=t.override;if(e.io.input==="image"){if(!co(n))throw new Error(Oe("image",n.type));const{width:a,height:l}=n;if(e.io.output==="image"){const p=await ue(e.dispatchId,{image:n.image,width:a,height:l},i?{enginePolicy:i.enginePolicy,params:i.params}:void 0);return Xt(p)}if(e.io.output==="mask"){const p=await ue(e.dispatchId,{image:n.image,width:a,height:l},i?{enginePolicy:i.enginePolicy,params:i.params}:void 0);return At(p,a,l)}if(e.io.output==="svg"){const p=await ue(e.dispatchId,{image:n.image,width:a,height:l},i?{enginePolicy:i.enginePolicy,params:i.params}:void 0);return Rt(p,a,l)}throw new Error(`Unsupported dispatch output: ${e.io.output}`)}if(!uo(n))throw new Error(Oe("mask",n.type));const{width:o,height:s}=n;if(e.io.output==="mask"){const a=await ue(e.dispatchId,{mask:n.mask,width:o,height:s},i?{enginePolicy:i.enginePolicy,params:i.params}:void 0);return At(a,o,s)}if(e.io.output==="svg"){const a=await ue(e.dispatchId,{mask:n.mask,width:o,height:s},i?{enginePolicy:i.enginePolicy,params:i.params}:void 0);return Rt(a,o,s)}throw new Error(`Invalid op spec: mask input cannot produce ${e.io.output} (unsupported here)`)}async function fo(e,t,n,i){var l;if(e.kind==="dispatch")return await go(e,t,n);const s={...e.tuningId?await i.getEffectiveParams(e.tuningId).catch(()=>({})):{},...((l=t.override)==null?void 0:l.params)??{}};return await e.run({input:n,params:s})}async function ho(e){const{catalogue:t,pipeline:n,inputImage:i,deps:o}=e,s=Xt(i);if(!n.implemented)return{pipelineId:n.id,title:n.title,status:"error",error:"Not implemented yet",input:s,ops:[]};const a=n.ops.filter(g=>g.enabled!==!1),l=[];for(const g of a){const h=t.getOp(g.opId);if(!h)return{pipelineId:n.id,title:n.title,status:"error",error:`Unknown opId in pipeline: ${g.opId}`,input:s,ops:[]};l.push(h)}const p=po(l,"image");if(p)return o.debug("pipeline validation failed (linear)",{pipelineId:n.id,error:p}),{pipelineId:n.id,title:n.title,status:"error",error:p,input:s,ops:a.map((g,h)=>{var u,d;return{instanceId:g.instanceId,opId:g.opId,title:((u=l[h])==null?void 0:u.title)??g.opId,io:((d=l[h])==null?void 0:d.io)??{input:"image",output:"image"},status:"error",error:p}})};const r=[];let f=s;for(let g=0;g<l.length;g++){const h=a[g],u=l[g];try{if(u.io.input!==f.type)throw new Error(Oe(u.io.input,f.type));const d=await fo(u,h,f,o);if(d.type!==u.io.output)throw new Error(Oe(u.io.output,d.type));r.push({instanceId:h.instanceId,opId:u.id,title:u.title,io:u.io,status:"ok",output:d}),f=d}catch(d){const m=d instanceof Error?d.message:String(d);return r.push({instanceId:h.instanceId,opId:u.id,title:u.title,io:u.io,status:"error",error:m}),o.debug("pipeline op failed (linear)",{pipelineId:n.id,opId:u.id,error:m,...lo(f)}),{pipelineId:n.id,title:n.title,status:"error",error:`Op "${u.title}" failed: ${m}`,input:s,ops:r}}}return{pipelineId:n.id,title:n.title,status:"ok",input:s,output:f,ops:r}}const Xe="beemage.pipeline.userPipelines.v1";async function pe(){const e=await oe([Xe]).catch(()=>({})),t=e==null?void 0:e[Xe];if(!Array.isArray(t))return[];const n=[];for(const i of t)!i||typeof i!="object"||typeof i.id=="string"&&Array.isArray(i.ops)&&n.push(i);return n}async function $e(e){await ae({[Xe]:e}).catch(()=>null)}async function mo(e){const t=await pe(),n=t.findIndex(i=>i.id===e.id);if(n>=0){const i=t.slice();i[n]=e,await $e(i);return}await $e([...t,e])}async function bo(e){const n=(await pe()).filter(i=>i.id!==e);await $e(n)}const et="beemage.pipeline.recipes.v1";function yo(){return Date.now()}function en(){return{recipesById:{}}}async function de(){const e=await oe([et]).catch(()=>({})),t=e==null?void 0:e[et];return!t||typeof t!="object"?{}:t}async function ve(e){await ae({[et]:e}).catch(()=>null)}async function vo(e,t){const n=await de(),i=n[e]??en();i.selectedRecipeId=t,n[e]=i,await ve(n)}async function wo(e,t){const n=await de(),i=n[e]??en();i.recipesById[t.id]={...t,updatedTs:yo()},i.selectedRecipeId||(i.selectedRecipeId=t.id),n[e]=i,await ve(n)}async function Eo(e,t){const n=await de(),i=n[e];if(i){if(delete i.recipesById[t],i.selectedRecipeId===t){const o=Object.keys(i.recipesById);i.selectedRecipeId=o.length?o[0]:void 0}n[e]=i,await ve(n)}}function Co(e){const t=[];for(const[n,i]of Object.entries(e??{})){const o=Object.values(i.recipesById??{});t.push({pipelineId:n,selectedRecipeId:i.selectedRecipeId,recipes:o})}return t.sort((n,i)=>n.pipelineId.localeCompare(i.pipelineId)),t}function Io(e){if(!Array.isArray(e))return{};const t={};for(const n of e){if(!n||typeof n!="object")continue;const i=n.pipelineId;if(typeof i!="string"||!i)continue;const o=n.selectedRecipeId,s=n.recipes,a={};if(Array.isArray(s))for(const l of s){if(!l||typeof l!="object")continue;const p=l.id,r=l.title,f=l.updatedTs,g=l.ops;typeof p!="string"||!p||typeof r!="string"||!r||typeof f=="number"&&Array.isArray(g)&&(a[p]=l)}t[i]={selectedRecipeId:typeof o=="string"?o:void 0,recipesById:a}}return t}function ko(e){return e.type==="image"}function So(e){return e.type==="mask"}function xo(e){return e.type==="svg"}function Po(e){var w,R,M,B;let t=Qe({userPipelines:[]}),n={},o=((M=(R=(w=t.listPipelines)==null?void 0:w.call(t))==null?void 0:R[0])==null?void 0:M.id)??((B=t.builtIns[0])==null?void 0:B.id)??"segmentation",s="default",a=null,l="Idle",p=null,r=[],f=0,g=null;async function h(){var $,U,z,H,T;const S=await pe().catch(()=>[]);t=Qe({userPipelines:S}),n=await de().catch(()=>({}));const x=(($=t.listPipelines)==null?void 0:$.call(t))??t.builtIns;x.some(K=>K.id===o)||(o=((U=x[0])==null?void 0:U.id)??"segmentation",s="default");const L=((z=t.getPipeline)==null?void 0:z.call(t,o))??((T=(H=t.listPipelines)==null?void 0:H.call(t))==null?void 0:T[0]);L&&d(L).some(ge=>ge.id===s)||(s="default"),v()}function u(){var x,P,L;const S=((x=t.getPipeline)==null?void 0:x.call(t,o))??((L=(P=t.listPipelines)==null?void 0:P.call(t))==null?void 0:L[0]);if(!S)throw new Error("[pipeline] No pipelines available.");return S}function d(S){const x={id:"default",title:"Default",buildPipeline:U=>U},P=n==null?void 0:n[S.id],L=(P==null?void 0:P.recipesById)??{},$=[x];for(const U of Object.keys(L)){const z=L[U];!z||typeof z.id!="string"||$.push({id:String(z.id),title:typeof z.title=="string"&&z.title.trim().length?z.title:String(z.id),buildPipeline:H=>{const T=Array.isArray(z.ops)?z.ops:null;if(!T)return H;const K=T.filter(W=>W&&typeof W=="object").map(W=>({instanceId:typeof W.instanceId=="string"?W.instanceId:String(W.instanceId??""),opId:typeof W.opId=="string"?W.opId:String(W.opId??""),enabled:W.enabled===void 0?!0:!!W.enabled})).filter(W=>W.instanceId&&W.opId);return K.length?{...H,ops:K}:H}})}return $.slice(0,1).concat($.slice(1).sort((U,z)=>String(U.title).localeCompare(String(z.title))))}function m(){const S=u(),x=d(S),P=x.find(L=>L.id===s)??x[0];return s=P.id,P.buildPipeline(S)}function v(){l=m().implemented?"Ready":"Not implemented yet",p=null,r=[],f=0,g=null}function y(){v()}function b(S){var P,L;S===o||!(((P=t.getPipeline)==null?void 0:P.call(t,S))??((L=t.getBuiltIn)==null?void 0:L.call(t,S)))||(o=S,s="default",y())}function k(S){if(S===s)return;const x=u();s=d(x).some($=>$.id===S)?S:"default",y()}function C(S){a=S,v()}function E(S){const x=S.ops.filter(L=>L.enabled!==!1),P=[];for(let L=0;L<x.length;L++){const $=x[L],U=t.getOp($.opId);U&&P.push({index0:L,instanceId:$.instanceId,opSpec:U})}return P}function I(S){var $;const x=S.ops.map(U=>({instanceId:U.instanceId,opId:U.opId,title:U.title,input:U.io.input,output:U.io.output,state:U.status==="ok"?"ok":U.status==="error"?"error":"idle",error:U.error,outputArtifact:U.output})),P=S.status==="ok"?"ok":"error",L=S.output??(($=x.slice().reverse().find(U=>U.outputArtifact))==null?void 0:$.outputArtifact);return[{stageId:"pipeline",title:"Pipeline",input:"image",output:(L==null?void 0:L.type)??"image",ops:x,state:P,error:S.error,outputArtifact:L}]}function A(S,x){x&&(ko(x)?S.outputImage={width:x.width,height:x.height,data:x.image}:So(x)?S.outputMask={width:x.width,height:x.height,data:x.mask}:xo(x)&&(S.outputSvg={width:x.width,height:x.height,svg:x.svg}))}async function D(){const S=m();if(!S.implemented){l="Not implemented yet";return}if(!a){l="No input image";return}l="Running all…";const x=await ho({catalogue:t,pipeline:S,inputImage:a,deps:e.runner});p=x,r=E(S),f=r.length,g=x.output??null,l=x.status==="ok"?"Done":x.error??"Error"}async function O(){const S=m();if(!S.implemented){l="Not implemented yet";return}if(!a){l="No input image";return}if(r.length===0&&(r=E(S),f=0,g={type:"image",width:a.width,height:a.height,image:a},p={pipelineId:S.id,title:S.title,status:"ok",input:{type:"image",width:a.width,height:a.height,image:a},output:{type:"image",width:a.width,height:a.height,image:a},ops:[]}),f>=r.length){l="Done";return}const x=r[f],P=x.opSpec;g||(g={type:"image",width:a.width,height:a.height,image:a});try{if(l=`Running: ${P.title}`,g.type!==P.io.input)throw new Error(`IO mismatch: expected ${P.io.input}, got ${g.type}`);const L=P.tuningId?await e.runner.getEffectiveParams(P.tuningId).catch(()=>({})):{};let $;if(P.kind==="dispatch"){const{runOp:H}=await kn(async()=>{const{runOp:T}=await Promise.resolve().then(()=>ro);return{runOp:T}},void 0,import.meta.url);if(g.type==="image"){const T=await H(P.dispatchId,{image:g.image,width:g.width,height:g.height});if(P.io.output==="image"){const K=T;$={type:"image",width:K.width,height:K.height,image:K}}else if(P.io.output==="mask")$={type:"mask",width:g.width,height:g.height,mask:T};else throw new Error(`Unsupported dispatch output: ${P.io.output}`)}else if(g.type==="mask"){const T=await H(P.dispatchId,{mask:g.mask,width:g.width,height:g.height});if(P.io.output==="mask")$={type:"mask",width:g.width,height:g.height,mask:T};else if(P.io.output==="svg")$={type:"svg",width:g.width,height:g.height,svg:T};else throw new Error(`Invalid dispatch output: ${P.io.output}`)}else throw new Error("Dispatch ops cannot take svg input.")}else $=await P.run({input:g,params:L});if($.type!==P.io.output)throw new Error(`IO mismatch: expected ${P.io.output}, got ${$.type}`);const z=((p==null?void 0:p.ops)??[]).concat([{instanceId:x.instanceId,opId:P.id,title:P.title,io:P.io,status:"ok",output:$}]);p={pipelineId:S.id,title:S.title,status:"ok",input:{type:"image",width:a.width,height:a.height,image:a},output:$,ops:z},g=$,f+=1,l=f>=r.length?"Done":"Ready"}catch(L){const $=L instanceof Error?L.message:String(L);l=`Error: ${P.title} — ${$}`;const z=((p==null?void 0:p.ops)??[]).concat([{instanceId:x.instanceId,opId:P.id,title:P.title,io:P.io,status:"error",error:$}]);p={pipelineId:S.id,title:S.title,status:"error",error:$,input:{type:"image",width:a.width,height:a.height,image:a},ops:z},e.runner.debug("pipeline next-step failed",{pipelineId:S.id,recipeId:s,instanceId:x.instanceId,opId:P.id,error:$})}}function c(){var H;const S=u(),x=m(),P=d(S),U={pipelines:(((H=t.listPipelines)==null?void 0:H.call(t))??t.builtIns).map(T=>({id:T.id,title:T.title})),recipes:P.map(T=>({id:T.id,title:T.title})),activePipelineId:o,activeRecipeId:s,statusText:l,description:x.description,stages:p?I(p):[],input:a?{width:a.width,height:a.height,data:a}:void 0,nextIndex:f,totalOps:r.length||x.ops.filter(T=>T.enabled!==!1).length},z=(p==null?void 0:p.output)??g??null;return A(U,z),U}return y(),{getVm:c,setActivePipeline:b,setActiveRecipe:k,setInputImageData:C,runAll:D,runNext:O,reset:y,reloadCatalogue:h}}function Ao(e,t,n){const i=Po({runner:{getEffectiveParams:async c=>await n.getEffectiveParams(c).catch(()=>({})),debug:(c,w)=>q({scope:"panel",kind:"debug",message:c,meta:w})}});let o=null,s=!1,a=null,l=null;function p(){const c=i.getVm();if(!(c.stages.some(M=>M.state==="error")||String(c.statusText).toLowerCase().includes("error"))){l=null;return}const R=String(c.statusText||"Pipeline error");R!==l&&(l=R,N({scope:"panel",kind:"error",message:`Pipeline: ${R}`}))}function r(){e.pipelineTuningMountEl.innerHTML=""}function f(c){return[c,`pipeline.${c}`,"pipeline"]}function g(c){const w=f(c);if(a===w[0])return;r();let R=null,M=null;for(const B of w)try{n.mount({mountEl:e.pipelineTuningMountEl,scopeRootId:B}),R=B;break}catch(S){M=S,r()}if(!R){a=null,N({scope:"panel",kind:"info",message:`Pipeline tuning mount failed for "${c}" (no matching scope).`}),q({scope:"panel",kind:"error",message:"Pipeline tuning mount failed (no candidate scopeRootId worked)",meta:{pipelineId:c,candidates:w,error:M instanceof Error?M.message:String(M)}});return}a=R,N({scope:"panel",kind:"info",message:`Pipeline tuning mount: pipelineId=${c}, scopeRootId=${R}`})}function h(){const c=i.getVm(),w=typeof c.activePipelineId=="string"?c.activePipelineId:"segmentation";g(w)}function u(){const c=e.srcCanvasEl,w=c.width,R=c.height;if(!w||!R)return null;const M=c.getContext("2d",{willReadFrequently:!0});return M?M.getImageData(0,0,w,R):null}function d(){if(i.getVm().input)return;const w=u();w&&i.setInputImageData(w)}function m(){const c=u();c&&i.setInputImageData(c)}async function v(){const c=await n.getEffectiveParams("pipeline").catch(()=>({})),w=c==null?void 0:c.mode,R=c==null?void 0:c.recipe,M=typeof w=="string"?w:"segmentation",B=typeof R=="string"?R:"default";i.setActivePipeline(M),i.setActiveRecipe(B),h()}function y(){return o||(N({scope:"panel",kind:"info",message:"Pipeline view: create + mount"}),o=zi({hostEl:e.pipelineViewMountEl,statusEl:e.pipelineStatusEl,handlers:{onSelectPipeline:c=>{N({scope:"panel",kind:"info",message:`Pipeline select: ${c}`}),i.setActivePipeline(c),n.setParamValue("pipeline","mode",c),h(),b()},onSelectRecipe:c=>{N({scope:"panel",kind:"info",message:`Recipe select: ${c}`}),i.setActiveRecipe(c),n.setParamValue("pipeline","recipe",c),b()},onRunAll:()=>void k(),onNext:()=>void C(),onReset:()=>{i.reset();const c=u();c&&i.setInputImageData(c),Ne(i.getVm()),N({scope:"panel",kind:"info",message:"Pipeline reset (reseed from source)"}),h(),b()}}}),o.mount(),h(),o)}function b(){y().render(i.getVm())}async function k(){N({scope:"panel",kind:"info",message:"Pipeline run: all"}),m();try{await i.runAll()}finally{Ne(i.getVm()),b(),p()}}async function C(){N({scope:"panel",kind:"info",message:"Pipeline run: next"}),d();try{await i.runNext()}finally{Ne(i.getVm()),b(),p()}}function E(){}async function I(){s=!0,N({scope:"panel",kind:"info",message:"Pipeline tab: mount()"}),m(),await i.reloadCatalogue().catch(()=>null),await v(),N({scope:"panel",kind:"info",message:"Pipeline tab: render()"}),b()}async function A(){s&&(N({scope:"panel",kind:"info",message:"Pipeline tab: refresh()"}),m(),await i.reloadCatalogue().catch(()=>null),await v(),b())}function D(){s=!1,N({scope:"panel",kind:"info",message:"Pipeline tab: unmount()"})}function O(){N({scope:"panel",kind:"info",message:"Pipeline tab: dispose()"}),o==null||o.dispose(),o=null,a=null,r()}return{bind:E,mount:I,unmount:D,refresh:A,dispose:O}}function tt(e){return!!e&&typeof e=="object"}function Ro(e){if(!tt(e)||typeof e.id!="string"||!e.id||typeof e.title!="string"||!e.title||typeof e.implemented!="boolean"||!Array.isArray(e.ops))return!1;for(const t of e.ops)if(!tt(t)||typeof t.instanceId!="string"||!t.instanceId||typeof t.opId!="string"||!t.opId||t.enabled!==void 0&&typeof t.enabled!="boolean")return!1;return!0}function Do(){const e=Qe({userPipelines:[]});async function t(){return await pe().catch(()=>[])}function n(){return e.ops}async function i(){return await de().catch(()=>({}))}async function o(h){await bo(h).catch(()=>null)}async function s(h){await mo(h).catch(()=>null)}async function a(h){const u=await de().catch(()=>({}));!u||typeof u!="object"||(delete u[h],await ve(u).catch(()=>null))}async function l(h,u){await vo(h,u).catch(()=>null)}async function p(h,u){await wo(h,u).catch(()=>null)}async function r(h,u){await Eo(h,u).catch(()=>null)}async function f(h){let u;try{u=JSON.parse(h)}catch{throw new Error("Invalid JSON (parse failed).")}let d,m;if(Array.isArray(u))d=u;else if(tt(u)&&Array.isArray(u.pipelines))d=u.pipelines,m=u.recipes;else throw new Error('Invalid file shape. Expected {"pipelines":[...]} or an array of pipelines.');const v=d,y=v.length,b=[];let k=0;for(const I of v){if(!Ro(I)){k++;continue}b.push(I)}if(b.length===0)throw new Error("No valid pipelines found in the imported file.");const C=await pe().catch(()=>[]),E=new Map;for(const I of C)E.set(I.id,I);for(const I of b)E.set(I.id,I);if(await $e(Array.from(E.values())),m!==void 0){if(!Array.isArray(m))throw new Error('Invalid "recipes" shape. Expected an array (or omit the field).');const I=Io(m);await ve(I).catch(()=>null)}return{imported:b.length,skipped:k,totalInFile:y}}async function g(){const h=await pe().catch(()=>[]),u=await de().catch(()=>({})),d={format:"beemage.pipeline.userPipelines.v2",exportedAt:new Date().toISOString(),pipelines:h,recipes:Co(u)};return JSON.stringify(d,null,2)}return{listUserPipelines:t,listOperations:n,importFromJsonText:f,exportToJsonText:g,listAllRecipes:i,deleteUserPipelineById:o,upsertUserPipeline:s,setSelectedRecipe:l,upsertRecipe:p,deleteRecipe:r,deleteAllRecipesForPipeline:a}}function ne(e,t,n){const i=document.createElement(e);if(t)for(const[o,s]of Object.entries(t))i.setAttribute(o,s);return typeof n=="string"&&(i.textContent=n),i}function Mo(e){return e.enabled!==!1}function To(e){const t=new Map;for(const n of e)t.set(n.id,n);return t}function Lo(e,t,n){const i={compactOps:n==null?void 0:n.compactOps},o=To(t),s=ne("div",{class:"pipelineCard"}),a=ne("div",{class:"pipelineCardHead"}),l=ne("div",{style:"display:flex; flex-direction:column; gap:2px;"});l.appendChild(ne("div",{class:"pipelineCardTitle"},e.title||e.id)),a.appendChild(l);{const g=e.implemented?"implemented":"not implemented";a.appendChild(ne("div",{class:"status"},g))}s.appendChild(a);const p=ne("div",{class:"pipelineOps",style:"margin-top:10px;"}),f=Array.isArray(e.ops)?e.ops:[];if(!f.length)return p.appendChild(ne("div",{class:"muted",style:"font-size:12px;"},"No operations in this pipeline.")),s.appendChild(p),s;for(let g=0;g<f.length;g++){const h=f[g],u=o.get(h.opId),d=!Mo(h),m=u?at(u,{compact:i.compactOps,showGroup:!0,showId:!0}):ne("div",{class:"opCard opCard--unknown",style:"padding:10px;"},`Unknown operation: ${h.opId}`);d&&m.classList.add("is-disabled"),p.appendChild(m),g<f.length-1&&p.appendChild(ne("div",{class:"pipelineConnector","aria-hidden":"true"}))}return s.appendChild(p),s}function X(e,t,n){const i=document.createElement(e);if(t)for(const[o,s]of Object.entries(t))i.setAttribute(o,s);return typeof n=="string"&&(i.textContent=n),i}function Oo(e){return JSON.parse(e)}function $o(e){const{pipelineId:t,instanceIds:n,selectedRecipeId:i,recipes:o,handlers:s}=e,a=X("div",{class:"card",style:"padding:10px; margin-top:8px;"});a.appendChild(X("div",{class:"cardTitle"},"Recipes"));const l=X("div",{class:"row",style:"gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px;"});a.appendChild(l);const p=X("label",{class:"fieldInline"});p.appendChild(X("span",{},"Selected"));const r=X("select"),f=X("option");f.value="",f.textContent="None",r.appendChild(f);for(const b of o){const k=X("option");k.value=b.id,k.textContent=`${b.title} (${b.id})`,r.appendChild(k)}r.value=i??"",r.addEventListener("change",()=>{const b=r.value;b&&s.onSelectRecipe(t,b)}),p.appendChild(r),l.appendChild(p);const g=X("button",{class:"btn",type:"button"},"New recipe"),h=X("button",{class:"btn",type:"button"},"Edit recipe"),u=X("button",{class:"btn",type:"button"},"Delete recipe");l.appendChild(g),l.appendChild(h),l.appendChild(u);const d=X("div",{class:"muted",style:"font-size:12px; margin-top:8px;"},`Recipes store only deltas per instanceId. Valid instanceIds: ${n.join(", ")||"(none)"}`);a.appendChild(d);function m(){const b=window.prompt("New recipe id (unique within this pipeline):","new");if(!b)return;const k=window.prompt("Recipe title:",b);k&&s.onUpsertRecipe(t,{id:b,title:k,ops:[]})}function v(){const b=(i??r.value)||"";if(!b){window.alert("Select a recipe first.");return}const k=o.find(I=>I.id===b);if(!k){window.alert("Recipe not found.");return}const C={id:k.id,title:k.title,ops:k.ops},E=window.prompt(`Edit recipe JSON (pipeline=${t}).

Structure: { id, title, ops: [{ instanceId, enabled?, override?: { enginePolicy?, params? } }] }

`,JSON.stringify(C,null,2));if(E)try{const I=Oo(E);if(typeof I.id!="string"||!I.id)throw new Error("Missing recipe.id");if(typeof I.title!="string"||!I.title)throw new Error("Missing recipe.title");if(!Array.isArray(I.ops))throw new Error("Missing recipe.ops array");for(const A of I.ops){if(!A||typeof A!="object")throw new Error("Invalid patch object in ops");if(typeof A.instanceId!="string"||!A.instanceId)throw new Error("Patch missing instanceId");n.length&&!n.includes(A.instanceId)&&console.warn("Recipe patch references unknown instanceId",t,A.instanceId)}s.onUpsertRecipe(t,{id:I.id,title:I.title,ops:I.ops})}catch(I){const A=I instanceof Error?I.message:String(I);window.alert(`Invalid recipe JSON: ${A}`)}}function y(){const b=(i??r.value)||"";if(!b){window.alert("Select a recipe first.");return}window.confirm(`Delete recipe "${b}" from pipeline "${t}"?`)&&s.onDeleteRecipe(t,b)}return g.addEventListener("click",m),h.addEventListener("click",v),u.addEventListener("click",y),o.length||(h.disabled=!0,u.disabled=!0),a}function se(e,t,n){const i=document.createElement(e);if(t)for(const[o,s]of Object.entries(t))i.setAttribute(o,s);return typeof n=="string"&&(i.textContent=n),i}function Bo(e){return JSON.parse(e)}function Uo(e){const{pipeline:t,opsLibrary:n,selectedRecipeId:i,recipes:o,handlers:s}=e,a=se("div",{class:"card",style:"padding:10px; margin-top:10px;"}),l=se("div",{class:"row",style:"justify-content:space-between; align-items:center; gap:10px;"}),p=se("div",{class:"cardTitle"},`${t.title} (${t.id})`);l.appendChild(p);const r=se("div",{class:"row",style:"gap:8px; align-items:center;"}),f=se("button",{class:"btn",type:"button"},"Edit"),g=se("button",{class:"btn",type:"button"},"Delete");r.appendChild(f),r.appendChild(g),l.appendChild(r),a.appendChild(l),t.description&&a.appendChild(se("div",{class:"muted",style:"font-size:12px; margin-top:6px;"},t.description));const h=se("div",{style:"margin-top:10px;"});h.appendChild(Lo(t,n,{compactOps:!0})),a.appendChild(h);const u=t.ops.map(v=>v.instanceId);a.appendChild($o({pipelineId:t.id,instanceIds:u,selectedRecipeId:i,recipes:o,handlers:s}));function d(){const v={id:t.id,title:t.title,description:t.description??"",implemented:t.implemented,ops:t.ops},y=window.prompt(`Edit pipeline JSON.

Structure: { id, title, description?, implemented, ops: [{ instanceId, opId, enabled?, override? }] }

`,JSON.stringify(v,null,2));if(y)try{const b=Bo(y);if(!b||typeof b!="object")throw new Error("Invalid JSON object");if(typeof b.id!="string"||!b.id)throw new Error("Missing pipeline.id");if(typeof b.title!="string"||!b.title)throw new Error("Missing pipeline.title");if(typeof b.implemented!="boolean")throw new Error("Missing pipeline.implemented boolean");if(!Array.isArray(b.ops))throw new Error("Missing pipeline.ops array");for(const k of b.ops){if(!k||typeof k!="object")throw new Error("Invalid op entry");if(typeof k.instanceId!="string"||!k.instanceId)throw new Error("Op missing instanceId");if(typeof k.opId!="string"||!k.opId)throw new Error("Op missing opId");if(k.enabled!==void 0&&typeof k.enabled!="boolean")throw new Error("Op.enabled must be boolean")}s.onUpsertPipeline(b)}catch(b){const k=b instanceof Error?b.message:String(b);window.alert(`Invalid pipeline JSON: ${k}`)}}function m(){window.confirm(`Delete pipeline "${t.id}"? This also deletes its recipes.`)&&s.onDeletePipeline(t.id)}return f.addEventListener("click",d),g.addEventListener("click",m),a}function _(e,t,n){const i=document.createElement(e);if(t)for(const[o,s]of Object.entries(t))i.setAttribute(o,s);return typeof n=="string"&&(i.textContent=n),i}function Vo(e){const{dom:t,handlers:n}=e;let i=!1,o=!1,s="all",a="all",l=null,p=null,r="",f=null,g=null,h=null;function u(){if(g)return g;const A=_("div",{"data-role":"builderListMount",style:"margin-top:12px;"});return t.viewBuilder.appendChild(A),g=A,A}function d(){if(h)return h;const A=_("div",{"data-role":"builderOpsMount",style:"margin-top:12px;"});return t.viewBuilder.appendChild(A),h=A,A}function m(A,D){const O=_("select"),c=[{value:"all",label:"All"},{value:"image",label:"image"},{value:"mask",label:"mask"},{value:"svg",label:"svg"}];for(const w of c){const R=_("option");R.value=w.value,R.textContent=w.label,w.value===A&&(R.selected=!0),O.appendChild(R)}return O.addEventListener("change",()=>D(O.value)),O}function v(A){const D=s==="all"?!0:A.io.input===s,O=a==="all"?!0:A.io.output===a;return D&&O}function y(A,D){const O=d();O.innerHTML="";const c=_("div",{class:"card",style:"padding:10px;"});c.appendChild(_("div",{class:"cardTitle"},"All operations"));const w=_("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px;"}),R=_("label",{class:"fieldInline"});R.appendChild(_("span",{},"Filter input")),l=m(String(s),x=>{s=x==="all"?"all":x,y(A)}),R.appendChild(l);const M=_("label",{class:"fieldInline"});M.appendChild(_("span",{},"Filter output")),p=m(String(a),x=>{a=x==="all"?"all":x,y(A)}),M.appendChild(p),w.appendChild(R),w.appendChild(M),c.appendChild(w);const B=A.filter(v);if(!B.length){c.appendChild(_("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No operations match the filter.")),O.appendChild(c);return}const S=_("div",{class:"opsGrid",style:"margin-top:10px;"});for(const x of B)S.appendChild(at(x,{compact:!0,showGroup:!0,showId:!0}));c.appendChild(S),O.appendChild(c)}function b(A,D){const O=u();O.innerHTML="";const c=_("div",{class:"card",style:"padding:10px;"});c.appendChild(_("div",{class:"cardTitle"},"Stored user pipelines"));const w=_("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px;"}),R=Array.isArray(D.examples)?D.examples:[],M=_("label",{class:"fieldInline"});M.appendChild(_("span",{},"Load example"));const B=_("select",{style:"min-width:260px;"});{const T=_("option");T.value="",T.textContent=R.length?"Select an example…":"No examples available",T.selected=!0,B.appendChild(T)}for(const T of R){const K=_("option");K.value=String(T.path??""),K.textContent=String(T.title??T.id??T.path??"Example"),B.appendChild(K)}M.appendChild(B);const S=_("button",{type:"button",class:"btn",style:"padding:4px 10px; font-size:12px;"},"Load");S.disabled=!0,B.addEventListener("change",()=>{S.disabled=!B.value}),S.addEventListener("click",()=>{const T=B.value;T&&(n.onLoadExample(T),B.value="",S.disabled=!0)});const x=_("label",{class:"fieldInline"});x.appendChild(_("span",{},"Filter pipelines")),f=_("input",{type:"text",value:r,placeholder:"Search by id or title…",style:"min-width:260px;"}),f.addEventListener("input",()=>{r=f?f.value:"",b(D.pipelines,D)}),x.appendChild(f);const P=_("button",{type:"button",class:"btn",style:"padding:4px 10px; font-size:12px;"},"Clear");P.addEventListener("click",()=>{r="",f&&(f.value=""),b(D.pipelines,D)}),w.appendChild(M),w.appendChild(S),w.appendChild(x),w.appendChild(P),c.appendChild(w);const L=Array.isArray(D.userPipelinesRaw)?D.userPipelinesRaw:[];if(!L.length){c.appendChild(_("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No user pipelines stored.")),O.appendChild(c);return}const $=r.trim().toLowerCase(),U=$.length===0?L:L.filter(T=>{const K=String(T.id??"").toLowerCase(),W=String(T.title??"").toLowerCase();return K.includes($)||W.includes($)});if(!U.length){c.appendChild(_("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No pipelines match the search.")),O.appendChild(c);return}const z=_("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:10px;"}),H=D.recipesAll??{};for(const T of U){const K=(H==null?void 0:H[T.id])??{recipesById:{},selectedRecipeId:void 0},W=(K==null?void 0:K.recipesById)??{},ge=Object.values(W),Be=K==null?void 0:K.selectedRecipeId;z.appendChild(Uo({pipeline:T,opsLibrary:D.ops??[],selectedRecipeId:Be,recipes:ge,handlers:{onDeletePipeline:n.onDeletePipeline,onUpsertPipeline:n.onUpsertPipeline,onSelectRecipe:n.onSelectRecipe,onUpsertRecipe:n.onUpsertRecipe,onDeleteRecipe:n.onDeleteRecipe}}))}c.appendChild(z),O.appendChild(c)}function k(){o||(o=!0,t.builderImportFileEl.addEventListener("change",()=>{var A;(A=t.builderImportFileEl.files)==null||A[0]}),t.btnBuilderExportEl.addEventListener("click",()=>{n.onExport()}),t.builderImportFileEl.addEventListener("change",()=>{var D;const A=((D=t.builderImportFileEl.files)==null?void 0:D[0])??null;A&&(n.onImportFile(A),t.builderImportFileEl.value="")}))}function C(){i||(i=!0,u(),d())}function E(A){t.builderStatusEl.textContent=A.statusText||"Idle",b(A.pipelines,A),y(A.ops??[])}function I(){i=!1,o=!1,s="all",a="all",r="",f=null,l=null,p=null,g&&(g.innerHTML="",g.remove(),g=null),h&&(h.innerHTML="",h.remove(),h=null)}return{bind:k,mount:C,render:E,dispose:I}}function No(e,t){const n=new Blob([t],{type:"application/json;charset=utf-8"}),i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download=e,o.rel="noopener",o.click(),setTimeout(()=>URL.revokeObjectURL(i),500)}function jo(e,t){const n=Do();let i=!1,o={},s=[],a="Idle",l=[],p=n.listOperations();async function r(){const C=rt("assets/pipelines/index.json"),E=await fetch(C,{cache:"no-store"});if(!E.ok)throw new Error(`Examples index not found: ${E.status}`);const I=await E.json().catch(()=>null),A=I==null?void 0:I.examples;return Array.isArray(A)?A.map(D=>({id:String((D==null?void 0:D.id)??""),title:String((D==null?void 0:D.title)??(D==null?void 0:D.id)??(D==null?void 0:D.path)??"Example"),path:String((D==null?void 0:D.path)??"")})).filter(D=>D.id&&D.path):[]}async function f(C){const E=rt(C),I=await fetch(E,{cache:"no-store"});if(!I.ok)throw new Error(`Example fetch failed (${I.status}): ${C}`);const A=await I.text();await n.importFromJsonText(A)}const g=Vo({dom:e,handlers:{onImportFile:async C=>{try{a=`Importing: ${C.name}`,d();const E=await C.text(),I=await n.importFromJsonText(E);N({scope:"panel",kind:"info",message:`Builder import: imported=${I.imported}, skipped=${I.skipped}, total=${I.totalInFile}`}),a=`Imported ${I.imported} pipeline(s) (skipped ${I.skipped}).`,await h()}catch(E){const I=E instanceof Error?E.message:String(E);N({scope:"panel",kind:"error",message:`Builder import failed: ${I}`}),q({scope:"panel",kind:"error",message:"Builder import failed",meta:{error:I}}),a=`Import failed: ${I}`,d()}},onExport:async()=>{try{a="Exporting…",d();const C=await n.exportToJsonText();No("beemage-user-pipelines.json",C),N({scope:"panel",kind:"info",message:"Builder export: downloaded beemage-user-pipelines.json"}),a="Exported.",d()}catch(C){const E=C instanceof Error?C.message:String(C);N({scope:"panel",kind:"error",message:`Builder export failed: ${E}`}),q({scope:"panel",kind:"error",message:"Builder export failed",meta:{error:E}}),a=`Export failed: ${E}`,d()}},onDeletePipeline:async C=>{try{await n.deleteUserPipelineById(C),await n.deleteAllRecipesForPipeline(C),N({scope:"panel",kind:"info",message:`Builder: deleted user pipeline "${C}" (and its recipes)`}),a=`Deleted pipeline ${C}.`,await h()}catch(E){const I=E instanceof Error?E.message:String(E);N({scope:"panel",kind:"error",message:`Delete pipeline failed: ${I}`}),q({scope:"panel",kind:"error",message:"Delete pipeline failed",meta:{pipelineId:C,error:I}}),a=`Delete failed: ${I}`,d()}},onUpsertPipeline:async C=>{try{await n.upsertUserPipeline(C),N({scope:"panel",kind:"info",message:`Builder: saved user pipeline "${String((C==null?void 0:C.id)??"")}"`}),a=`Saved pipeline ${String((C==null?void 0:C.id)??"")}.`,await h()}catch(E){const I=E instanceof Error?E.message:String(E);N({scope:"panel",kind:"error",message:`Save pipeline failed: ${I}`}),q({scope:"panel",kind:"error",message:"Save pipeline failed",meta:{error:I}}),a=`Save failed: ${I}`,d()}},onSelectRecipe:async(C,E)=>{try{await n.setSelectedRecipe(C,E),N({scope:"panel",kind:"info",message:`Builder: selected recipe "${E}" for pipeline "${C}"`}),a=`Selected recipe ${E} for ${C}.`,await h()}catch(I){const A=I instanceof Error?I.message:String(I);N({scope:"panel",kind:"error",message:`Select recipe failed: ${A}`}),q({scope:"panel",kind:"error",message:"Select recipe failed",meta:{pipelineId:C,recipeId:E,error:A}}),a=`Select recipe failed: ${A}`,d()}},onUpsertRecipe:async(C,E)=>{try{await n.upsertRecipe(C,E),N({scope:"panel",kind:"info",message:`Builder: saved recipe "${String((E==null?void 0:E.id)??"")}" for pipeline "${C}"`}),a=`Saved recipe ${String((E==null?void 0:E.id)??"")} for ${C}.`,await h()}catch(I){const A=I instanceof Error?I.message:String(I);N({scope:"panel",kind:"error",message:`Save recipe failed: ${A}`}),q({scope:"panel",kind:"error",message:"Save recipe failed",meta:{pipelineId:C,error:A}}),a=`Save recipe failed: ${A}`,d()}},onDeleteRecipe:async(C,E)=>{try{await n.deleteRecipe(C,E),N({scope:"panel",kind:"info",message:`Builder: deleted recipe "${E}" from pipeline "${C}"`}),a=`Deleted recipe ${E} from ${C}.`,await h()}catch(I){const A=I instanceof Error?I.message:String(I);N({scope:"panel",kind:"error",message:`Delete recipe failed: ${A}`}),q({scope:"panel",kind:"error",message:"Delete recipe failed",meta:{pipelineId:C,recipeId:E,error:A}}),a=`Delete recipe failed: ${A}`,d()}},onLoadExample:async C=>{try{a=`Loading example: ${C}`,d(),await f(C),N({scope:"panel",kind:"info",message:`Builder example loaded: ${C}`}),a=`Loaded example: ${C}`,await h()}catch(E){const I=E instanceof Error?E.message:String(E);N({scope:"panel",kind:"error",message:`Load example failed: ${I}`}),q({scope:"panel",kind:"error",message:"Load example failed",meta:{error:I,examplePath:C}}),a=`Load example failed: ${I}`,d()}}}});async function h(){const C=await n.listUserPipelines().catch(()=>[]);l=C,p=n.listOperations(),o=await n.listAllRecipes().catch(()=>({})),s=await r().catch(()=>[]),a=`Ready. User pipelines: ${C.length} · Operations: ${p.length} · Examples: ${s.length}`,d()}function u(){const C=l??[];return{statusText:a,pipelines:C.map(E=>({id:String(E.id),title:String(E.title),implemented:!!E.implemented,opCount:Array.isArray(E.ops)?E.ops.length:0})),userPipelinesRaw:C,ops:p,recipesAll:o??{},examples:s??[]}}function d(){g.mount(),g.render(u())}function m(){g.bind(),e.builderStatusEl.textContent="Idle"}async function v(){i=!0,a="Loading…",d(),await h()}async function y(){i&&(a="Refreshing…",d(),await h())}function b(){i=!1}function k(){g.dispose()}return{bind:m,mount:v,refresh:y,unmount:b,dispose:k}}async function zo(){const e=Sn();await We().catch(()=>null);const t=An();t.start();const n=Ln();globalThis.__APP__={...globalThis.__APP__,cache:n};const i=$i({getRuntimeAvailability:()=>({opencvReady:!1}),debugTraceAppend:g=>q({scope:"panel",kind:"debug",message:g}),actionLogAppend:g=>N({scope:"panel",kind:"info",message:g})});i.mount({mountEl:e.tuningMountEl,scopeRootId:"app"});const o=Hn(e),s=ni(e),a=Ao(e,t,i),l=Ai(e,t),p=Ti(e),r=jo(e);o.bind(),a.bind(),s.bind(),l.bind(),p.bind(),r.bind();const f=Tn(e,{image:o,pipeline:a,builder:r,colors:s,settings:l,logs:p});f.bind(),f.boot()}zo();
