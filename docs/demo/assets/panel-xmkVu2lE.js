function Cn(){function e(Fe,En){if(!Fe)throw new Error(`[dom] Missing #${En}`);return Fe}const t=e(document.getElementById("appRoot"),"appRoot"),o=e(document.getElementById("tabContour"),"tabContour"),n=e(document.getElementById("tabColors"),"tabColors"),a=e(document.getElementById("tabSettings"),"tabSettings"),s=e(document.getElementById("tabLogs"),"tabLogs"),l=e(document.getElementById("tabSegmentation"),"tabSegmentation"),d=e(document.getElementById("viewContour"),"viewContour"),g=e(document.getElementById("viewColors"),"viewColors"),i=e(document.getElementById("viewSettings"),"viewSettings"),u=e(document.getElementById("viewLogs"),"viewLogs"),m=e(document.getElementById("viewSegmentation"),"viewSegmentation"),v=e(document.getElementById("dropZone"),"dropZone"),f=e(document.getElementById("fileInput"),"fileInput"),r=e(document.getElementById("btnProcess"),"btnProcess"),c=e(document.getElementById("btnClean"),"btnClean"),p=e(document.getElementById("btnDownload"),"btnDownload"),h=e(document.getElementById("contourStatus"),"contourStatus"),b=e(document.getElementById("contourSpinner"),"contourSpinner"),w=e(document.getElementById("srcCanvas"),"srcCanvas"),E=e(document.getElementById("outCanvas"),"outCanvas"),C=e(document.getElementById("clean1Canvas"),"clean1Canvas"),x=e(document.getElementById("clean2Canvas"),"clean2Canvas"),M=e(document.getElementById("cleanQualityBadge"),"cleanQualityBadge"),k=e(document.getElementById("cleanQualityFill"),"cleanQualityFill"),D=e(document.getElementById("cleanQualityText"),"cleanQualityText"),y=e(document.getElementById("btnVectorize"),"btnVectorize"),S=e(document.getElementById("btnDownloadSvg"),"btnDownloadSvg"),P=e(document.getElementById("svgPreviewImg"),"svgPreviewImg"),R=e(document.getElementById("svgPreviewText"),"svgPreviewText"),L=e(document.getElementById("contourTuningMount"),"contourTuningMount"),A=e(document.getElementById("segPresetList"),"segPresetList"),V=e(document.getElementById("segRecipeDrop"),"segRecipeDrop"),F=e(document.getElementById("segStepResize"),"segStepResize"),ee=e(document.getElementById("segStepDenoise"),"segStepDenoise"),te=e(document.getElementById("segStepColor"),"segStepColor"),q=e(document.getElementById("segStepThreshold"),"segStepThreshold"),ie=e(document.getElementById("segStepMorphology"),"segStepMorphology"),kt=e(document.getElementById("segRunBtn"),"segRunBtn"),Mt=e(document.getElementById("segStatus"),"segStatus"),Dt=e(document.getElementById("segMaskCanvas"),"segMaskCanvas"),It=e(document.getElementById("segNextBtn"),"segNextBtn"),Rt=e(document.getElementById("segResetBtn"),"segResetBtn"),Tt=e(document.getElementById("segTuningMount"),"segTuningMount"),Lt=e(document.getElementById("colorsCanvas"),"colorsCanvas"),At=e(document.getElementById("palette"),"palette"),Pt=e(document.getElementById("btnColorsApply"),"btnColorsApply"),Bt=e(document.getElementById("btnColorsCancel"),"btnColorsCancel"),Ot=e(document.getElementById("btnColorsReset"),"btnColorsReset"),$t=e(document.getElementById("edgesDark"),"edgesDark"),Nt=e(document.getElementById("edgeMaskThreshold"),"edgeMaskThreshold"),Vt=e(document.getElementById("edgeDilate"),"edgeDilate"),Ut=e(document.getElementById("maxRegionPx"),"maxRegionPx"),zt=e(document.getElementById("colorsStatus"),"colorsStatus"),Ft=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),jt=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),_t=e(document.getElementById("devConfigDetails"),"devConfigDetails"),Kt=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),Gt=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),qt=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),Qt=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),Wt=e(document.getElementById("logsCbDebug"),"logsCbDebug"),Ht=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),Yt=e(document.getElementById("cfgStatus"),"cfgStatus"),Jt=e(document.getElementById("cfgOpenCvSpinner"),"cfgOpenCvSpinner"),Xt=e(document.getElementById("cfgOpenCvStatus"),"cfgOpenCvStatus"),Zt=e(document.getElementById("cfgOpenCvReport"),"cfgOpenCvReport"),en=e(document.getElementById("settingsEngineBox"),"settingsEngineBox"),tn=e(document.getElementById("cfgUseOpenCv"),"cfgUseOpenCv"),nn=e(document.getElementById("tuningMount"),"tuningMount"),on=e(document.getElementById("settingsVersion"),"settingsVersion"),an=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),sn=e(document.getElementById("logsLimit"),"logsLimit"),rn=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),ln=e(document.getElementById("logsStatus"),"logsStatus"),cn=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),un=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),dn=e(document.getElementById("btnLogsExport"),"btnLogsExport"),gn=e(document.getElementById("btnLogsClear"),"btnLogsClear"),fn=e(document.getElementById("logsOut"),"logsOut"),mn=e(document.getElementById("debugLimit"),"debugLimit"),pn=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),hn=e(document.getElementById("btnDebugExport"),"btnDebugExport"),vn=e(document.getElementById("btnDebugClear"),"btnDebugClear"),bn=e(document.getElementById("debugStatus"),"debugStatus"),yn=e(document.getElementById("debugOut"),"debugOut");return{rootEl:t,tabContour:o,tabColors:n,tabSettings:a,tabLogs:s,tabSegmentation:l,viewContour:d,viewSegmentation:m,viewColors:g,viewSettings:i,viewLogs:u,dropZoneEl:v,fileInputEl:f,btnProcessEl:r,btnCleanEl:c,btnDownloadEl:p,contourStatusEl:h,contourSpinnerEl:b,srcCanvasEl:w,outCanvasEl:E,clean1CanvasEl:C,clean2CanvasEl:x,cleanQualityBadgeEl:M,cleanQualityFillEl:k,cleanQualityTextEl:D,btnVectorizeEl:y,btnDownloadSvgEl:S,svgPreviewImgEl:P,svgPreviewTextEl:R,contourTuningMountEl:L,segPresetListEl:A,segRecipeDropEl:V,segStepResizeEl:F,segStepDenoiseEl:ee,segStepColorEl:te,segStepThresholdEl:q,segStepMorphologyEl:ie,segRunBtn:kt,segStatusEl:Mt,segMaskCanvasEl:Dt,segNextBtn:It,segResetBtn:Rt,segTuningMountEl:Tt,colorsCanvasEl:Lt,paletteEl:At,btnColorsApplyEl:Pt,btnColorsCancelEl:Bt,btnColorsResetEl:Ot,edgesDarkEl:$t,edgeMaskThresholdEl:Nt,edgeDilateEl:Vt,maxRegionPxEl:Ut,colorsStatusEl:zt,cfgShowDevToolsEl:Ft,settingsGeneralStatusEl:jt,devConfigDetailsEl:_t,cfgTraceConsoleEl:Kt,cfgActionLogMaxEl:Gt,cfgDebugTraceMaxEl:qt,cfgFailureLogsPerRunEl:Qt,logsCbDebugEl:Wt,btnCfgResetDefaults:Ht,cfgStatusEl:Yt,settingsVersionEl:on,settingsGitHubLinkEl:an,cfgOpenCvSpinner:Jt,cfgOpenCvStatus:Xt,cfgOpenCvReport:Zt,settingsEngineBoxEl:en,cfgUseOpenCvEl:tn,tuningMountEl:nn,logsLimitEl:sn,btnLogsRefresh:rn,logsStatusEl:ln,logsTrimKeepEl:cn,btnLogsTrim:un,btnLogsExport:dn,btnLogsClear:gn,logsOutEl:fn,debugLimitEl:mn,btnDebugRefresh:pn,btnDebugExport:hn,btnDebugClear:vn,debugStatusEl:bn,debugOutEl:yn}}const wn=new Set;function xn(e){wn.add(e)}function Sn(){const e=new Set;function t(n){return e.add(n),()=>e.delete(n)}function o(){xn(a=>{for(const s of e)s(a)})}return{on:t,start:o}}const kn=new Set;function it(e){for(const t of kn)t(e,"local")}function ne(e){const t=localStorage.getItem(e);if(t!==null)try{return JSON.parse(t)}catch{return t}}function Mn(e,t){localStorage.setItem(e,JSON.stringify(t))}async function J(e){if(typeof e=="string")return{[e]:ne(e)};if(Array.isArray(e)){const o={};for(const n of e)o[n]=ne(n);return o}const t={};for(const[o,n]of Object.entries(e))t[o]=localStorage.getItem(o)!==null?ne(o):n;return t}async function X(e){const t={};for(const[o,n]of Object.entries(e)){const a=ne(o);Mn(o,n),t[o]={oldValue:a,newValue:n}}it(t)}async function Oe(e){const t=Array.isArray(e)?e:[e],o={};for(const n of t){const a=ne(n);localStorage.removeItem(n),o[n]={oldValue:a,newValue:void 0}}it(o)}function G(e,t,o,n){const a=Number(String(e??"").trim());return Number.isFinite(a)?Math.max(t,Math.min(o,Math.floor(a))):n}const Ie="beecontour.devConfig",z={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let Re=!1,ue={...z};function rt(e){const t=e||{};return{traceConsole:!!t.traceConsole,actionLogMax:G(t.actionLogMax??z.actionLogMax,100,5e4,z.actionLogMax),debugTraceMax:G(t.debugTraceMax??z.debugTraceMax,100,5e4,z.debugTraceMax),failureLogsPerRun:G(t.failureLogsPerRun??z.failureLogsPerRun,0,5e4,z.failureLogsPerRun)}}async function Te(){if(Re)return;const e=await J([Ie]).catch(()=>({}));ue=rt(e==null?void 0:e[Ie]),Re=!0}function de(){return ue}async function lt(e){ue=rt(e),Re=!0,await X({[Ie]:ue}).catch(()=>null)}async function Dn(){await lt({...z})}function In(e,t){const o={segmentation:e.tabSegmentation,contour:e.tabContour,colors:e.tabColors,settings:e.tabSettings,logs:e.tabLogs},n={segmentation:e.viewSegmentation,contour:e.viewContour,colors:e.viewColors,settings:e.viewSettings,logs:e.viewLogs};let a="contour";const s=new Set;function l(){const f=de();return!!(f!=null&&f.traceConsole)}function d(){const f=globalThis;f.__bctGlobalErrorHooksInstalled||(f.__bctGlobalErrorHooksInstalled=!0,window.addEventListener("error",r=>{var p;const c=r;console.error("[panel] window error",{message:c.message,filename:c.filename,lineno:c.lineno,colno:c.colno,error:c.error?String(c.error):null,stack:(p=c.error)!=null&&p.stack?String(c.error.stack):null})}),window.addEventListener("unhandledrejection",r=>{var c;console.error("[panel] unhandledrejection",{reason:r.reason?String(r.reason):null,stack:(c=r.reason)!=null&&c.stack?String(r.reason.stack):null})}))}l()&&d();function g(f){Object.keys(o).forEach(r=>{const c=r===f;o[r].classList.toggle("is-active",c),o[r].setAttribute("aria-selected",c?"true":"false"),n[r].hidden=!c,n[r].classList.toggle("is-active",c)})}function i(f){var r,c,p,h,b,w,E,C;if(f===a){(c=(r=t[f]).refresh)==null||c.call(r);return}(h=(p=t[a]).unmount)==null||h.call(p),a=f,g(a),s.has(a)?(C=(E=t[a]).refresh)==null||C.call(E):(s.add(a),(w=(b=t[a]).mount)==null||w.call(b))}function u(){o.contour.addEventListener("click",f=>{var r;(r=f.preventDefault)==null||r.call(f),i("contour")}),o.segmentation.addEventListener("click",f=>{var r;(r=f.preventDefault)==null||r.call(f),i("segmentation")}),o.colors.addEventListener("click",f=>{var r;(r=f.preventDefault)==null||r.call(f),i("colors")}),o.settings.addEventListener("click",f=>{var r;(r=f.preventDefault)==null||r.call(f),i("settings")}),o.logs.addEventListener("click",f=>{var r;(r=f.preventDefault)==null||r.call(f),i("logs")})}function m(){var f,r,c,p;a="contour",g(a),Object.keys(t).forEach(h=>{var b,w;return(w=(b=t[h]).boot)==null?void 0:w.call(b)}),s.has(a)?(p=(c=t[a]).refresh)==null||p.call(c):(s.add(a),(r=(f=t[a]).mount)==null||r.call(f))}function v(){Object.keys(t).forEach(f=>{var r,c;return(c=(r=t[f]).dispose)==null?void 0:c.call(r)})}return{bind:u,boot:m,activate:i,dispose:v}}function je(e){const t=e.items.length;return{items:e.items,counts:{items:t},meta:e.meta}}function Rn(){const e={items:[],meta:{}},t=new Set;function o(){const i=je(e);for(const u of t)try{u(i)}catch{}}function n(){return je(e)}function a(i){t.add(i);try{i(n())}catch{}return()=>t.delete(i)}function s(){e.items=[],e.meta={},o()}function l(i){e.meta.scopeUpdatedSince=i,o()}function d(){return String(e.meta.scopeUpdatedSince||"")}function g(i,u){e.items=i.slice(),e.meta.updatedTs=Date.now(),typeof(u==null?void 0:u.limit)=="number"&&(e.meta.limit=u.limit),o()}return{getSnapshot:n,subscribe:a,getScopeUpdatedSince:d,clearAll:s,setScopeUpdatedSince:l,setItems:g}}function Tn(){return{loadedImageName:null,hasImage:!1,hasOutput:!1,edgeMask:void 0,repairedMask:void 0,smoothedMask:void 0,svgText:void 0}}function Ln(e){e.loadedImageName=null,e.hasImage=!1,e.hasOutput=!1,e.edgeMask=void 0,e.repairedMask=void 0,e.smoothedMask=void 0,e.svgText=void 0}function ct(e,t,o){const n=new Uint8Array(e.length);function a(p,h){return h*t+p}function s(p,h){return p<0||h<0||p>=t||h>=o?!1:e[a(p,h)]===1}let l=0,d=0,g=0,i=0,u=0;const m=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];for(let p=0;p<o;p++)for(let h=0;h<t;h++){if(!s(h,p))continue;l++;let b=0,w=!1;for(const[E,C]of m)s(h+E,p+C)?b++:w=!0;w&&d++,b===1?g++:b>=3&&i++}const v=[[-1,0],[1,0],[0,-1],[0,1]],f=new Int32Array(e.length),r=new Int32Array(e.length);for(let p=0;p<o;p++)for(let h=0;h<t;h++){const b=a(h,p);if(e[b]===0||n[b]===1)continue;u++,n[b]=1;let w=0,E=0;for(f[E]=h,r[E]=p,E++;w<E;){const C=f[w],x=r[w];w++;for(const[M,k]of v){const D=C+M,y=x+k;if(D<0||y<0||D>=t||y>=o)continue;const S=a(D,y);e[S]===0||n[S]===1||(n[S]=1,f[E]=D,r[E]=y,E++)}}}const c=l/Math.max(1,d);return{onPixels:l,boundaryPixels:d,components:u,endpoints:g,junctions:i,thicknessRatio:c}}function An(e,t){function o(f){e.contourStatusEl.textContent=f}function n(f,r){e.contourSpinnerEl.classList.toggle("is-hidden",!f),r&&o(r)}function a(){e.btnProcessEl.disabled=!t.hasImage,e.btnDownloadEl.disabled=!t.hasOutput,e.btnCleanEl.disabled=!t.hasOutput,e.btnVectorizeEl.disabled=!t.smoothedMask,e.btnDownloadSvgEl.disabled=!t.svgText}function s(){t.svgText=void 0,e.svgPreviewTextEl.textContent="",e.svgPreviewImgEl.removeAttribute("src")}function l(){const f=e.srcCanvasEl.getContext("2d"),r=e.outCanvasEl.getContext("2d");f.clearRect(0,0,e.srcCanvasEl.width,e.srcCanvasEl.height),r.clearRect(0,0,e.outCanvasEl.width,e.outCanvasEl.height);const c=e.clean1CanvasEl.getContext("2d"),p=e.clean2CanvasEl.getContext("2d");c.clearRect(0,0,e.clean1CanvasEl.width,e.clean1CanvasEl.height),p.clearRect(0,0,e.clean2CanvasEl.width,e.clean2CanvasEl.height)}function d(){const f=e.clean1CanvasEl.getContext("2d"),r=e.clean2CanvasEl.getContext("2d");f.clearRect(0,0,e.clean1CanvasEl.width,e.clean1CanvasEl.height),r.clearRect(0,0,e.clean2CanvasEl.width,e.clean2CanvasEl.height)}function g(f,r){const c=Number(f.value);return Number.isFinite(c)?c:r}function i(f,r){const c=r instanceof Error?r.message:String(r);o(`${f} failed: ${c}`),n(!1),console.error(`[BeeContour] ${f} failed`,r)}function u(f,r){if(!t.smoothedMask){e.cleanQualityBadgeEl.textContent="—",e.cleanQualityBadgeEl.className="qBadge qBadge--off",e.cleanQualityFillEl.style.width="0%",e.cleanQualityTextEl.textContent="";return}const c=ct(t.smoothedMask,f,r),p=(D,y)=>Math.max(0,Math.min(1,D/Math.max(1,y))),h=p(c.components,800),b=p(c.endpoints,3e3),w=p(c.junctions,1500),E=c.thicknessRatio>5?1:c.thicknessRatio>3?.5:0,C=Math.round(100*(1-(.45*h+.45*b+.1*w)-.1*E)),x=Math.max(0,Math.min(100,C));let M="qBadge qBadge--bad",k=`Bad ${x}`;x>=70?(M="qBadge qBadge--ok",k=`Good ${x}`):x>=45&&(M="qBadge qBadge--warn",k=`OK ${x}`),e.cleanQualityBadgeEl.className=M,e.cleanQualityBadgeEl.textContent=k,e.cleanQualityFillEl.style.width=`${x}%`,e.cleanQualityTextEl.textContent=`CC:${c.components} end:${c.endpoints} j:${c.junctions} thick:${c.thicknessRatio.toFixed(2)}`}function m(){if(!t.hasOutput)return;const r=`${(t.loadedImageName||"beecontour").replace(/\.[a-z0-9]+$/i,"").replace(/[^a-z0-9-_]+/gi,"_")}_contour.png`,c=e.outCanvasEl.toDataURL("image/png"),p=document.createElement("a");p.href=c,p.download=r,document.body.appendChild(p),p.click(),p.remove(),o(`Downloaded: ${r}`)}function v(){if(!t.svgText)return;const r=`${(t.loadedImageName||"beecontour").replace(/\.[a-z0-9]+$/i,"").replace(/[^a-z0-9-_]+/gi,"_")}_contour.svg`,c=new Blob([t.svgText],{type:"image/svg+xml;charset=utf-8"}),p=URL.createObjectURL(c),h=document.createElement("a");h.href=p,h.download=r,document.body.appendChild(h),h.click(),h.remove(),URL.revokeObjectURL(p),o(`Downloaded: ${r}`)}return{setStatus:o,setContourBusyVisual:n,updateEnabled:a,clearSvgPreview:s,clearCanvases:l,clearCleanCanvasesOnly:d,getNumber:g,showError:i,updateCleanQualityUI:u,downloadPng:m,downloadSvg:v}}const oe="beecontour.debugTrace",Le="beecontour.debugTrace.enabled",Pn=2e3;function Bn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function Ae(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}async function ge(){const e=await J(oe),t=e==null?void 0:e[oe];return Array.isArray(t)?t:[]}async function On(e){await X({[oe]:e})}async function $e(){const e=await J(Le);return!!(e!=null&&e[Le])}async function ut(e){await X({[Le]:!!e}),e||await Oe(oe)}async function dt(){await Oe(oe)}async function Ne(e,t){if(!await $e())return{total:0};const n=Ae((t==null?void 0:t.max)??Pn,100,5e4),a=(Array.isArray(e)?e:[e]).map(g=>({...g,id:Bn(),ts:Date.now()}));if(!a.length)return{total:(await ge()).length};const l=(await ge()).concat(a),d=l.length>n?l.slice(l.length-n):l;return await On(d),{total:d.length}}async function gt(e){const t=Ae((e==null?void 0:e.limit)??200,1,5e4),o=Ae((e==null?void 0:e.offset)??0,0,1e6),n=(e==null?void 0:e.reverse)??!0,a=await ge(),s=a.length,d=(n?a.slice().reverse():a).slice(o,o+t);return{total:s,items:d}}async function ft(e){const t=await ge();return JSON.stringify(t,null,e!=null&&e.pretty?2:0)}const mt=Object.freeze(Object.defineProperty({__proto__:null,append:Ne,clear:dt,exportJson:ft,isEnabled:$e,list:gt,setEnabled:ut},Symbol.toStringTag,{value:"Module"}));function be(e){return`[BCT][${e}]`}function $n(e){function t(...s){e.traceOn()&&console.log(be("trace"),...s)}function o(...s){console.warn(be("warn"),...s)}function n(...s){console.error(be("error"),...s)}function a(s,l){t(s,l),Ne({scope:e.scope,kind:"debug",message:s,meta:l})}return{logTrace:t,logWarn:o,logError:n,traceScope:a}}const{logTrace:I,logWarn:j,logError:O,traceScope:N}=$n({scope:"panel",traceOn:()=>!!de().traceConsole});let $=0;function U(){return $>0}function _(e,t){if(t){pt(e);return}$=0,fe(e,!1)}async function Z(e,t){const o=`${Date.now()}-${Math.random().toString(16).slice(2)}`;I("[state] withBusy: enter",{id:o,busyCount:$}),pt(e,o);try{I("[state] withBusy: before await fn",{id:o,busyCount:$});const n=await t();return I("[state] withBusy: after await fn (resolved)",{id:o,busyCount:$}),n}catch(n){throw O("[state] withBusy: fn threw",{id:o,busyCount:$,msg:String((n==null?void 0:n.message)??n),stack:String((n==null?void 0:n.stack)??"")}),n}finally{I("[state] withBusy: finally before endBusy",{id:o,busyCount:$}),Nn(e,o),I("[state] withBusy: finally after endBusy",{id:o,busyCount:$})}}function pt(e,t){$++,I("[state] beginBusy",{id:t,busyCount:$}),$===1&&fe(e,!0)}function Nn(e,t){if($--,I("[state] endBusy: dec",{id:t,busyCount:$}),$<=0){$=0,I("[state] endBusy: applying busy=false",{id:t,busyCount:$}),fe(e,!1);return}$===0&&(I("[state] endBusy: applying busy=false (redundant branch)",{id:t,busyCount:$}),fe(e,!1))}function fe(e,t){e.rootEl.classList.toggle("is-busy",t),e.cfgShowDevToolsEl.disabled=!1,e.fileInputEl.disabled=t,e.btnProcessEl.disabled=t,e.btnCleanEl.disabled=t,e.btnDownloadEl.disabled=t,e.btnVectorizeEl.disabled=t,e.btnDownloadSvgEl.disabled=t,e.cfgTraceConsoleEl.disabled=t,e.cfgActionLogMaxEl.disabled=t,e.cfgDebugTraceMaxEl.disabled=t,e.cfgFailureLogsPerRunEl.disabled=t,e.btnCfgResetDefaults.disabled=t,e.logsCbDebugEl.disabled=t,e.cfgUseOpenCvEl.disabled=t,e.logsLimitEl.disabled=t,e.btnLogsRefresh.disabled=t,e.logsTrimKeepEl.disabled=t,e.btnLogsTrim.disabled=t,e.btnLogsExport.disabled=t,e.btnLogsClear.disabled=t,e.debugLimitEl.disabled=t,e.btnDebugRefresh.disabled=t,e.btnDebugExport.disabled=t,e.btnDebugClear.disabled=t,e.btnColorsApplyEl.disabled=t,e.btnColorsCancelEl.disabled=t,e.btnColorsResetEl.disabled=t,e.edgesDarkEl.disabled=t,e.edgeMaskThresholdEl.disabled=t,e.edgeDilateEl.disabled=t,e.maxRegionPxEl.disabled=t;for(const o of Array.from(e.paletteEl.querySelectorAll("button")))o.disabled=t;e.colorsCanvasEl.style.pointerEvents=t?"none":"auto"}function B(e,t,o,n,a,s,l){return{id:e,title:t,implementedEngines:o,defaultEnginePolicy:n,params:a,children:s,description:l}}function Vn(e){const t=new Map,o=new Map;function n(a,s){if(t.has(a.id))throw new Error(`[tuning] Duplicate component id: ${a.id}`);t.set(a.id,a),o.set(a.id,s);for(const l of a.children??[])n(l,a.id)}return n(e,null),{root:e,byId:t,parentById:o}}function Ve(){const e=B("app","BeeContour",["native","opencv"],"native",{},[B("contour","Contour",["native","opencv"],"auto",{},[B("contour.process","Process",["native"],"auto",{contourScale:{kind:"number",label:"Processing scale",min:25,max:100,step:5,default:100},edgeThreshold:{kind:"number",label:"Edge threshold",min:1,max:255,step:1,default:70},invertOutput:{kind:"boolean",label:"White background",default:!0}}),B("contour.clean","Clean & Smooth",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:500,step:1,default:12},cleanRadius:{kind:"number",label:"Repair strength",min:1,max:3,step:1,default:1},cleanBinaryThreshold:{kind:"number",label:"Binary threshold",min:1,max:254,step:1,default:128}},[B("contour.clean.threshold","Threshold",["native"],"auto",{}),B("contour.clean.removeSmallComponents","Remove small components",["native","opencv"],"auto",{}),B("contour.clean.repair","Repair gaps",["native"],"auto",{}),B("contour.clean.smooth","Smooth mask",["native"],"auto",{}),B("contour.clean.quality","Quality metrics",["native"],"auto",{})]),B("contour.vectorize","Vectorize (SVG)",["native"],"native",{pathSmoothIters:{kind:"number",label:"Path smoothing",min:0,max:4,step:1,default:2}})]),B("colors","Colors",["native"],"auto",{},[B("colors.fill","Region fill",["native"],"auto",{edgesDark:{kind:"boolean",label:"Edges are dark",default:!0},edgeMaskThreshold:{kind:"number",label:"Edge threshold",min:0,max:255,step:1,default:80},edgeDilate:{kind:"number",label:"Gap close (px)",min:0,max:6,step:1,default:2},maxRegionPx:{kind:"number",label:"Max region (px)",min:1e3,step:1e3,default:2e5}})]),B("segmentation","Segmentation",["native","opencv"],"auto",{},[B("segmentation.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),B("segmentation.denoise","Denoise",["native","opencv"],"auto",{denoiseAlgo:{kind:"number",label:"Denoise algo",min:0,max:2,step:1,default:1},blurK:{kind:"number",label:"Blur kernel",min:1,max:21,step:2,default:3},bilateralSigma:{kind:"number",label:"Bilateral sigma",min:1,max:150,step:1,default:35}},void 0,"Reduce noise before thresholding."),B("segmentation.color","Color / Gray",["native","opencv"],"auto",{colorMode:{kind:"number",label:"Color mode",min:0,max:3,step:1,default:1},hsvChannel:{kind:"number",label:"HSV channel",min:0,max:2,step:1,default:2}},void 0,"Select color space / channel features for thresholding."),B("segmentation.threshold","Threshold",["native","opencv"],"auto",{thresholdAlgo:{kind:"number",label:"Threshold algo",min:0,max:3,step:1,default:1},manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128},adaptBlock:{kind:"number",label:"Adaptive block",min:3,max:101,step:2,default:31},adaptC:{kind:"number",label:"Adaptive C",min:-50,max:50,step:1,default:3}},void 0,"Convert features into a binary mask."),B("segmentation.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:5},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Remove specks, fill holes, and stabilize regions.")],"Fixed-order segmentation pipeline. Presets configure each step.")]);return Vn(e)}function Un(e){return e.default}function zn(e,t){const o={};for(const[n,a]of Object.entries(e))o[n]=Un(a);for(const[n,a]of Object.entries(t??{}))o[n]=a;return o}function Fn(e,t,o){var a;let n=e;for(;n;){const s=t.byId.get(n);if(!s)throw new Error(`[tuning] Unknown component: ${n}`);const d=((a=o[n])==null?void 0:a.enginePolicy)??s.defaultEnginePolicy;if(d!=="inherit")return d;n=t.parentById.get(n)??null}return"native"}function jn(e,t,o){const n=o.opencvReady&&e.includes("opencv");return e.includes("native")||e.length,t==="native"?{engine:"native"}:t==="opencv"?n?{engine:"opencv"}:{engine:"native",fallbackReason:o.opencvReady?"Policy=opencv, but component has no OpenCV implementation.":"Policy=opencv, but OpenCV is not available at runtime."}:t==="auto"?n?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}function ht(e,t,o,n){var i;const a=t.byId.get(e);if(!a)throw new Error(`[tuning] Unknown component: ${e}`);const s=Fn(e,t,o),{engine:l,fallbackReason:d}=jn(a.implementedEngines,s,n),g=zn(a.params,(i=o[e])==null?void 0:i.params);return{id:e,policy:s,engine:l,fallbackReason:d,params:g}}const Pe="beecontour.tuning.components.v1";async function ae(){const e=await J([Pe]).catch(()=>({})),t=e==null?void 0:e[Pe];return!t||typeof t!="object"?{}:t}async function vt(e){await X({[Pe]:e}).catch(()=>null)}async function ye(e,t){const o=await ae(),n=o[e]??{};o[e]={enginePolicy:t.enginePolicy??n.enginePolicy,params:{...n.params??{},...t.params??{}}},await vt(o)}async function _e(e){const t=await ae();delete t[e],await vt(t)}const Ue={native:{available:!0},opencv:{available:!1,reason:"OpenCV not loaded"}};function _n(e){Ue[e]={available:!0}}function Kn(e,t){Ue[e]={available:!1,reason:t}}function Q(){return Ue.opencv.available===!0}function Gn(){return{opencvReady:Q()}}function qn(e){return Array.isArray(e.children)&&e.children.length>0}function bt(e){const{id:t,registry:o,stored:n,runtime:a}=e,s=o.byId.get(t);if(!s)throw new Error(`[tuning] Unknown component: ${t}`);const l=ht(t,o,n,a),d=n[t],g=d==null?void 0:d.enginePolicy,i=d==null?void 0:d.params,u=s.implementedEngines.includes("opencv"),m=!!a.opencvReady,v=[];for(const f of s.children??[])v.push(bt({id:f.id,registry:o,stored:n,runtime:a}));return{id:s.id,title:s.title,description:s.description,isGroup:qn(s),implementedEngines:s.implementedEngines,storedPolicy:g,storedParams:i,effectivePolicy:l.policy,effectiveEngine:l.engine,fallbackReason:l.fallbackReason,paramsSchema:s.params,effectiveParams:l.params,canImplementOpenCv:u,runtimeOpenCvReady:m,children:v}}function ze(e={}){const t=e.registry??Ve(),o=e.getRuntimeAvailability??Gn;async function n(g="app"){const i=await ae(),u=o();if(!t.byId.get(g))throw new Error(`[tuning] Unknown scope: ${g}`);const v=bt({id:g,registry:t,stored:i,runtime:u});return{scopeId:g,runtime:u,stored:i,root:v}}async function a(g,i){await ye(g,{enginePolicy:i})}async function s(g,i,u){await ye(g,{params:{[i]:u}})}async function l(g){await _e(g)}async function d(g,i){const m=(await ae())[g];if(!(m!=null&&m.params))return;const v={...m.params??{}};delete v[i];const f=typeof m.enginePolicy=="string",r=Object.keys(v).length>0;if(!f&&!r){await _e(g);return}await ye(g,{enginePolicy:m.enginePolicy,params:v})}return{getRegistry:()=>t,loadTree:n,setEnginePolicy:a,setParam:s,resetNode:l,resetParam:d}}function Qn(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}function Wn(e,t){if(e.kind==="number"){const o=Number(t),n=e.default,a=Number.isFinite(o)?o:n,s=typeof e.min=="number"?e.min:a,l=typeof e.max=="number"?e.max:a;return Qn(a,s,l)}return e.kind==="boolean"?!!t:String(t??e.default)}function H(e,t,o,n){const a=e.byId.get(t);if(!a)throw new Error(`[tuningParams] unknown node: ${t}`);const s=a.params[o];if(!s)throw new Error(`[tuningParams] unknown param: ${t}.${o}`);return Wn(s,n)}function ce(e,t){if((e==null?void 0:e.id)===t)return e;for(const o of(e==null?void 0:e.children)??[]){const n=ce(o,t);if(n)return n}return null}async function ve(){const e=ze(),t=Ve(),o=await e.loadTree("app"),n=ce(o.root,"contour.process"),a=ce(o.root,"contour.clean"),s=ce(o.root,"contour.vectorize");if(!n||!a||!s)throw new Error("[contour] tuning nodes missing (registry mismatch)");const l=H(t,"contour.process","contourScale",n.effectiveParams.contourScale),d=H(t,"contour.process","edgeThreshold",n.effectiveParams.edgeThreshold),g=H(t,"contour.process","invertOutput",n.effectiveParams.invertOutput),i=H(t,"contour.clean","cleanMinArea",a.effectiveParams.cleanMinArea),u=H(t,"contour.clean","cleanRadius",a.effectiveParams.cleanRadius),m=H(t,"contour.clean","cleanBinaryThreshold",a.effectiveParams.cleanBinaryThreshold),v=H(t,"contour.vectorize","pathSmoothIters",s.effectiveParams.pathSmoothIters);return{contourScale:l,edgeThreshold:d,invertOutput:g,cleanMinArea:i,cleanRadius:u,cleanBinaryThreshold:m,pathSmoothIters:v}}async function Ke(e,t,o,n){const{setStatus:a,setContourBusyVisual:s,clearCanvases:l,clearCleanCanvasesOnly:d,clearSvgPreview:g,updateEnabled:i,getNumber:u}=n;if(!o.type.startsWith("image/")){a("Unsupported file type (please drop an image)."),j("Contour load: rejected non-image file",{name:o.name,type:o.type,size:o.size}),N("Contour load: rejected non-image file",{name:o.name,type:o.type,size:o.size});return}const m=performance.now();await Z(e,async()=>{s(!0,"Loading image…"),t.loadedImageName=o.name||"image";const v=URL.createObjectURL(o);N("Contour load: start",{name:o.name,type:o.type,size:o.size});try{const f=await new Promise((M,k)=>{const D=new Image;D.onload=()=>M(D),D.onerror=()=>k(new Error("Failed to load image")),D.src=v}),r=e.srcCanvasEl,c=r.getContext("2d");if(!c){O("Contour load: missing 2D context",{canvasId:"srcCanvasEl"}),a("Load failed — canvas context not available.");return}l();const h=(await ve()).contourScale,b=h/100;let w=Math.max(64,Math.floor(f.naturalWidth*b)),E=Math.max(64,Math.floor(f.naturalHeight*b));const C=1600,x=Math.min(1,C/Math.max(w,E));w=Math.max(64,Math.floor(w*x)),E=Math.max(64,Math.floor(E*x)),r.width=w,r.height=E,c.imageSmoothingEnabled=!0,c.clearRect(0,0,r.width,r.height),c.drawImage(f,0,0,r.width,r.height),t.hasImage=!0,t.hasOutput=!1,t.edgeMask=void 0,t.repairedMask=void 0,t.smoothedMask=void 0,t.svgText=void 0,g(),d(),i(),a(`Loaded: ${t.loadedImageName} (${r.width}×${r.height})`),N("Contour load: done",{naturalW:f.naturalWidth,naturalH:f.naturalHeight,scalePct:h,maxSide:C,targetW:w,targetH:E,pixels:w*E,ms:Math.round((performance.now()-m)*10)/10})}catch(f){O("Contour load: exception",{error:f instanceof Error?f.message:String(f)}),a("Load failed — see console / debug trace.")}finally{URL.revokeObjectURL(v),s(!1)}})}async function Hn(e,t,o){const{setStatus:n,setContourBusyVisual:a,clearCleanCanvasesOnly:s,clearSvgPreview:l,updateEnabled:d}=o;if(!t.hasImage){j("Contour process: skipped (no image loaded)");return}const g=performance.now();await Z(e,async()=>{a(!0,"Processing…"),await new Promise(i=>{setTimeout(()=>{(async()=>{try{const u=e.srcCanvasEl,m=e.outCanvasEl,v=u.width,f=u.height,r=v*f,c=await ve(),p=c.edgeThreshold,h=c.invertOutput;N("Contour process: start",{width:v,height:f,pixels:r,threshold:p,whiteBg:h}),m.width=v,m.height=f;const b=m.getContext("2d",{willReadFrequently:!0}),w=u.getContext("2d",{willReadFrequently:!0});if(!w||!b){O("Contour process: missing 2D context",{hasSrc:!!w,hasOut:!!b}),n("Process failed — canvas context not available.");return}const C=w.getImageData(0,0,v,f).data,x=new Uint8ClampedArray(v*f);for(let R=0,L=0;R<C.length;R+=4,L++){const A=C[R],V=C[R+1],F=C[R+2];x[L]=.299*A+.587*V+.114*F|0}const M=[-1,0,1,-2,0,2,-1,0,1],k=[-1,-2,-1,0,0,0,1,2,1],D=new Uint8ClampedArray(v*f);for(let R=1;R<f-1;R++)for(let L=1;L<v-1;L++){let A=0,V=0,F=0;for(let te=-1;te<=1;te++)for(let q=-1;q<=1;q++){const ie=x[(R+te)*v+(L+q)];A+=ie*M[F],V+=ie*k[F],F++}const ee=Math.min(255,Math.sqrt(A*A+V*V)|0);D[R*v+L]=ee>=p?255:0}const y=b.createImageData(v,f),S=y.data;let P=0;for(let R=0,L=0;R<D.length;R++,L+=4){const A=D[R];if(A===255&&P++,h){const F=A===255?0:255;S[L]=F,S[L+1]=F,S[L+2]=F,S[L+3]=255}else S[L]=A,S[L+1]=A,S[L+2]=A,S[L+3]=255}b.putImageData(y,0,0),t.hasOutput=!0,t.edgeMask=void 0,t.repairedMask=void 0,t.smoothedMask=void 0,l(),s(),n("Done. You can clean/smooth or download the PNG."),N("Contour process: done",{width:v,height:f,pixels:r,threshold:p,whiteBg:h,edgePixels:P,edgeRatio:Math.round(P/Math.max(1,r)*1e6)/1e6,ms:Math.round((performance.now()-g)*10)/10})}catch(u){O("Contour process: exception",{error:u instanceof Error?u.message:String(u)}),n("Process failed — see console / debug trace.")}finally{i()}})()},0)}),a(!1),d()})}function Be(e,t,o,n){const a=new ImageData(t,o),s=a.data;for(let l=0,d=0;l<e.length;l++,d+=4){const g=e[l]===1;if(n){const i=g?0:255;s[d]=i,s[d+1]=i,s[d+2]=i,s[d+3]=255}else{const i=g?255:0;s[d]=i,s[d+1]=i,s[d+2]=i,s[d+3]=255}}return a}function Ee(e,t,o,n){const a=new Uint8Array(e.length),s=Math.max(1,n);for(let l=0;l<o;l++)for(let d=0;d<t;d++){let g=0;for(let i=-s;i<=s&&!g;i++){const u=l+i;if(u<0||u>=o)continue;const m=u*t;for(let v=-s;v<=s;v++){const f=d+v;if(!(f<0||f>=t)&&e[m+f]===1){g=1;break}}}a[l*t+d]=g}return a}function Ce(e,t,o,n){const a=new Uint8Array(e.length),s=Math.max(1,n);for(let l=0;l<o;l++)for(let d=0;d<t;d++){let g=1;for(let i=-s;i<=s&&g;i++){const u=l+i;if(u<0||u>=o){g=0;break}const m=u*t;for(let v=-s;v<=s;v++){const f=d+v;if(f<0||f>=t){g=0;break}if(e[m+f]===0){g=0;break}}}a[l*t+d]=g}return a}function yt(e,t,o,n){const a=new Uint8Array(e),s=new Uint8Array(e.length),l=new Int32Array(e.length),d=new Int32Array(e.length);for(let g=0;g<o;g++)for(let i=0;i<t;i++){const u=g*t+i;if(e[u]===0||s[u]===1)continue;let m=0,v=0;s[u]=1,l[v]=i,d[v]=g,v++;const f=[u];for(;m<v;){const r=l[m],c=d[m];m++;const p=[[r-1,c],[r+1,c],[r,c-1],[r,c+1]];for(const[h,b]of p){if(h<0||h>=t||b<0||b>=o)continue;const w=b*t+h;e[w]===0||s[w]===1||(s[w]=1,l[v]=h,d[v]=b,v++,f.push(w))}}if(f.length<n)for(const r of f)a[r]=0}return a}const Yn=Ve();function Jn(){return{opencvReady:Q()}}async function Xn(e){const t=await ae(),o=Jn(),n=ht(e,Yn,t,o);if(e==="contour.clean.removeSmallComponents"){const a=Number(n.params.cleanMinArea??12);return{engine:n.engine,params:{cleanMinArea:a},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.resize"){const a=Number(n.params.resizeAlgo??1),s=Number(n.params.targetMaxW??900);return{engine:n.engine,params:{resizeAlgo:a,targetMaxW:s},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.denoise"){const a=Number(n.params.denoiseAlgo??1),s=Number(n.params.blurK??5),l=Number(n.params.bilateralSigma??35);return{engine:n.engine,params:{denoiseAlgo:a,blurK:s,bilateralSigma:l},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.color"){const a=Number(n.params.colorMode??1),s=Number(n.params.hsvChannel??2);return{engine:n.engine,params:{colorMode:a,hsvChannel:s},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.threshold"){const a=Number(n.params.thresholdAlgo??1),s=Number(n.params.manualT??128),l=Number(n.params.adaptBlock??21),d=Number(n.params.adaptC??2);return{engine:n.engine,params:{thresholdAlgo:a,manualT:s,adaptBlock:l,adaptC:d},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.morphology"){const a=Number(n.params.morphAlgo??2),s=Number(n.params.morphK??7),l=Number(n.params.morphIters??1);return{engine:n.engine,params:{morphAlgo:a,morphK:s,morphIters:l},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}throw new Error(`[opsDispatch] Unknown op: ${e}`)}async function Zn(e,t,o){const{engine:n,params:a,fallbackReason:s,opencvReady:l}=await Xn(e);return n==="opencv"&&!l?(j(`OpenCV selected for ${e} but not ready; falling back to native. ${s??""}`.trim()),await o[e].native(t,a)):await o[e][n](t,a)}function eo(){const e=globalThis;return e!=null&&e.cv&&typeof e.cv.Mat=="function"?e.cv:null}function to(e,t){const{width:o,height:n}=e,a=Math.max(0,Math.floor(Number(t.cleanMinArea??0)));if(N("oopenCV RemoveSmallComponents: params",{width:o,height:n,minArea:a}),a<=1)return e.mask;const s=eo();if(!s)return yt(e.mask,o,n,a);const l=new s.Mat(n,o,s.CV_8UC1);try{const d=l.data,g=e.mask;for(let v=0;v<g.length;v++)d[v]=g[v]?255:0;const i=new s.Mat,u=new s.Mat,m=new s.Mat;try{const v=s.connectedComponentsWithStats(l,i,u,m,8,s.CV_32S),f=s.CC_STAT_AREA??4,r=new Array(v).fill(!1);for(let h=1;h<v;h++)u.intAt(h,f)<a&&(r[h]=!0);const c=new Uint8Array(o*n),p=i.data32S;for(let h=0;h<c.length;h++){const b=p[h];c[h]=b>0&&!r[b]?1:0}return c}finally{i.delete(),u.delete(),m.delete()}}finally{l.delete()}}function Ge(e,t,o,n){const a=Math.max(0,Math.min(255,Math.floor(Number(n.manualT??128)))),s=new Uint8Array(t*o),l=e.data;for(let d=0,g=0;d<s.length;d++,g+=4){const i=l[g],u=l[g+1],m=l[g+2],v=i*77+u*150+m*29>>8;s[d]=v>=a?1:0}return s}function qe(e,t,o,n){const a=Math.max(1,Math.floor(Number(n.targetMaxW??t)));if(!t||!o||t<=a)return e;const s=a/t,l=Math.max(1,Math.floor(t*s)),d=Math.max(1,Math.floor(o*s));return Math.floor(Number(n.resizeAlgo??1))===0?no(e,t,o,l,d):oo(e,t,o,l,d)}function no(e,t,o,n,a){const s=e.data,l=new Uint8ClampedArray(n*a*4),d=t/n,g=o/a;for(let i=0;i<a;i++){const u=Math.min(o-1,Math.max(0,Math.floor((i+.5)*g-.5)));for(let m=0;m<n;m++){const v=Math.min(t-1,Math.max(0,Math.floor((m+.5)*d-.5))),f=(u*t+v)*4,r=(i*n+m)*4;l[r]=s[f],l[r+1]=s[f+1],l[r+2]=s[f+2],l[r+3]=s[f+3]}}return new ImageData(l,n,a)}function oo(e,t,o,n,a){const s=e.data,l=new Uint8ClampedArray(n*a*4),d=t/n,g=o/a;for(let i=0;i<a;i++){const u=(i+.5)*g-.5,m=re(Math.floor(u),0,o-1),v=re(m+1,0,o-1),f=u-m;for(let r=0;r<n;r++){const c=(r+.5)*d-.5,p=re(Math.floor(c),0,t-1),h=re(p+1,0,t-1),b=c-p,w=(m*t+p)*4,E=(m*t+h)*4,C=(v*t+p)*4,x=(v*t+h)*4,M=(i*n+r)*4;for(let k=0;k<4;k++){const D=s[w+k],y=s[E+k],S=s[C+k],P=s[x+k],R=D+(y-D)*b,L=S+(P-S)*b,A=R+(L-R)*f;l[M+k]=ao(A)}}}return new ImageData(l,n,a)}function re(e,t,o){return e<t?t:e>o?o:e}function ao(e){return e<=0?0:e>=255?255:e|0}function Qe(e,t,o,n){if(!t||!o)return e;const a=Math.floor(Number(n.denoiseAlgo??1));if(a<=0)return e;const s=Math.floor(Number(n.blurK??3)),l=so(s);return a===2&&l<=3?ro(e,t,o):l<=1?e:io(e,t,o,l)}function so(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:3}function io(e,t,o,n){const a=n-1>>1,s=e.data,l=new Uint8ClampedArray(t*o*4);for(let g=0;g<o;g++){let i=0,u=0,m=0,v=0;for(let f=-a;f<=a;f++){const r=W(f,0,t-1),c=(g*t+r)*4;i+=s[c],u+=s[c+1],m+=s[c+2],v+=s[c+3]}for(let f=0;f<t;f++){const r=(g*t+f)*4;l[r]=i/n|0,l[r+1]=u/n|0,l[r+2]=m/n|0,l[r+3]=v/n|0;const c=W(f-a,0,t-1),p=W(f+a+1,0,t-1),h=(g*t+c)*4,b=(g*t+p)*4;i+=s[b]-s[h],u+=s[b+1]-s[h+1],m+=s[b+2]-s[h+2],v+=s[b+3]-s[h+3]}}const d=new Uint8ClampedArray(t*o*4);for(let g=0;g<t;g++){let i=0,u=0,m=0,v=0;for(let f=-a;f<=a;f++){const c=(W(f,0,o-1)*t+g)*4;i+=l[c],u+=l[c+1],m+=l[c+2],v+=l[c+3]}for(let f=0;f<o;f++){const r=(f*t+g)*4;d[r]=i/n|0,d[r+1]=u/n|0,d[r+2]=m/n|0,d[r+3]=v/n|0;const c=W(f-a,0,o-1),p=W(f+a+1,0,o-1),h=(c*t+g)*4,b=(p*t+g)*4;i+=l[b]-l[h],u+=l[b+1]-l[h+1],m+=l[b+2]-l[h+2],v+=l[b+3]-l[h+3]}}return new ImageData(d,t,o)}function ro(e,t,o){const n=e.data,a=new Uint8ClampedArray(t*o*4),s=new Array(9),l=new Array(9),d=new Array(9),g=new Array(9);for(let i=0;i<o;i++)for(let u=0;u<t;u++){let m=0;for(let f=-1;f<=1;f++){const r=W(i+f,0,o-1);for(let c=-1;c<=1;c++){const p=W(u+c,0,t-1),h=(r*t+p)*4;s[m]=n[h],l[m]=n[h+1],d[m]=n[h+2],g[m]=n[h+3],m++}}s.sort(le),l.sort(le),d.sort(le),g.sort(le);const v=(i*t+u)*4;a[v]=s[4]|0,a[v+1]=l[4]|0,a[v+2]=d[4]|0,a[v+3]=g[4]|0}return new ImageData(a,t,o)}function le(e,t){return e-t}function W(e,t,o){return e<t?t:e>o?o:e}function We(e,t,o,n){if(!t||!o)return e;const a=Math.floor(Number(n.colorMode??1));if(a===0)return e;const s=e.data,l=new Uint8ClampedArray(t*o*4),d=co(Math.floor(Number(n.hsvChannel??2)),0,2);for(let g=0,i=0;g<t*o;g++,i+=4){const u=s[i],m=s[i+1],v=s[i+2],f=s[i+3];let r=0;if(a===1)r=u*77+m*150+v*29>>8;else if(a===2){const c=lo(u,m,v),p=d===0?c.h:d===1?c.s:c.v;r=uo(p*255)}else r=255-(u*77+m*150+v*29>>8);l[i]=r,l[i+1]=r,l[i+2]=r,l[i+3]=f}return new ImageData(l,t,o)}function lo(e,t,o){const n=e/255,a=t/255,s=o/255,l=Math.max(n,a,s),d=Math.min(n,a,s),g=l-d;let i=0;g!==0&&(l===n?i=(a-s)/g%6:l===a?i=(s-n)/g+2:i=(n-a)/g+4,i/=6,i<0&&(i+=1));const u=l===0?0:g/l;return{h:i,s:u,v:l}}function co(e,t,o){return e<t?t:e>o?o:e}function uo(e){return e<=0?0:e>=255?255:e|0}function He(e,t,o,n){if(!t||!o)return e;const a=Math.floor(Number(n.morphAlgo??2)),s=fo(Math.floor(Number(n.morphIters??1)),1,20),l=Math.floor(Number(n.morphK??5)),d=go(l),g=d-1>>1;if(a<=0||d<=1)return e;let i=e,u=new Uint8Array(t*o);for(let m=0;m<s;m++){if(a===1){Je(i,u,t,o,g);const v=i;i=u,u=v;continue}if(a===2){Ye(i,u,t,o,g);const v=i;i=u,u=v;continue}Ye(i,u,t,o,g),i===e&&m===0&&(i=new Uint8Array(e)),Je(u,i,t,o,g)}return i}function go(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:5}function Ye(e,t,o,n,a){t.fill(0);for(let s=0;s<n;s++){const l=Math.max(0,s-a),d=Math.min(n-1,s+a);for(let g=0;g<o;g++){const i=Math.max(0,g-a),u=Math.min(o-1,g+a);let m=0;for(let v=l;v<=d&&!m;v++){let f=v*o+i;for(let r=i;r<=u;r++,f++)if(e[f]){m=1;break}}t[s*o+g]=m}}}function Je(e,t,o,n,a){t.fill(0);for(let s=0;s<n;s++){const l=Math.max(0,s-a),d=Math.min(n-1,s+a);for(let g=0;g<o;g++){const i=Math.max(0,g-a),u=Math.min(o-1,g+a);let m=1;for(let v=l;v<=d&&m;v++){let f=v*o+i;for(let r=i;r<=u;r++,f++)if(!e[f]){m=0;break}}t[s*o+g]=m}}}function fo(e,t,o){return e<t?t:e>o?o:e}const mo="demo",po={"contour.clean.removeSmallComponents":{native:(e,t)=>yt(e.mask,e.width,e.height,t.cleanMinArea),opencv:(e,t)=>(I("OpenCV removeSmallComponents called (demo).",{width:e.width,height:e.height,cleanMinArea:t.cleanMinArea}),to(e,t))},"segmentation.resize":{native:(e,t)=>(I("[demo op] segmentation.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),qe(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(I("[demo op] segmentation.resize opencv",{width:e.width,height:e.height}),qe(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"segmentation.denoise":{native:(e,t)=>(I("[demo op] segmentation.denoise native",{width:e.width,height:e.height,denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}),Qe(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma})),opencv:(e,t)=>(I("[demo op] segmentation.denoise opencv",{width:e.width,height:e.height}),Qe(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}))},"segmentation.color":{native:(e,t)=>(I("[demo op] segmentation.color native",{width:e.width,height:e.height,colorMode:t.colorMode,hsvChannel:t.hsvChannel}),We(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel})),opencv:(e,t)=>(I("[demo op] segmentation.color opencv",{width:e.width,height:e.height}),We(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel}))},"segmentation.threshold":{native:(e,t)=>(I("[demo op] segmentation.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),Ge(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(I("[demo op] segmentation.threshold opencv",{width:e.width,height:e.height}),Ge(e.image,e.width,e.height,{manualT:t.manualT}))},"segmentation.morphology":{native:(e,t)=>(I("[demo op] segmentation.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),He(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(I("[demo op] segmentation.morphology opencv",{width:e.width,height:e.height}),He(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))}};async function me(e,t){return N("[opsDispatch] runOp",{op:e,implSource:mo,inputKeys:t&&typeof t=="object"?Object.keys(t):typeof t}),Zn(e,t,po)}async function ho(e,t){return me(e,t)}async function vo(e,t,o){const{setStatus:n,setContourBusyVisual:a,clearSvgPreview:s,updateEnabled:l,updateCleanQualityUI:d}=o;if(!t.hasOutput){j("Contour clean: skipped (no output present)");return}const g=performance.now();await Z(e,async()=>{a(!0,"Cleaning…"),await new Promise(i=>{setTimeout(()=>{(async()=>{try{const u=e.outCanvasEl,m=e.clean1CanvasEl,v=e.clean2CanvasEl,f=await ve(),r=f.cleanRadius,c=f.cleanBinaryThreshold,p=f.invertOutput;m.width=u.width,m.height=u.height,v.width=u.width,v.height=u.height;const h=u.width,b=u.height,w=h*b;N("Contour clean: start",{width:h,height:b,pixels:w,whiteBg:p,EDGE_T:c,radius:r});const E=u.getContext("2d",{willReadFrequently:!0}),C=m.getContext("2d",{willReadFrequently:!0}),x=v.getContext("2d",{willReadFrequently:!0});if(!E||!C||!x){O("Contour clean: missing 2D context",{hasOut:!!E,hasC1:!!C,hasC2:!!x}),n("Clean failed — canvas context not available.");return}const k=E.getImageData(0,0,h,b).data,D=new Uint8Array(h*b);let y=0;for(let V=0,F=0;V<D.length;V++,F+=4){const ee=k[F],q=(p?ee<c:ee>=c)?1:0;D[V]=q,q===1&&y++}N("Contour removeSmallComponents: params",{edge:D,width:h,height:b});const S=await ho("contour.clean.removeSmallComponents",{mask:D,width:h,height:b});N("Contour erode : params",{edgeNoSpeck:S,width:h,height:b,radius:r});const P=Ce(Ee(S,h,b,r),h,b,r);C.putImageData(Be(P,h,b,p),0,0),N("Contour dilate : params",{repaired:P,width:h,height:b,radius:r});const R=Ee(Ce(P,h,b,r),h,b,r);N("Contour erode : params",{opened:R,width:h,height:b,radius:r});const L=Ce(Ee(R,h,b,r),h,b,r);x.putImageData(Be(L,h,b,p),0,0),t.edgeMask=D,t.repairedMask=P,t.smoothedMask=L,s();const A=ct(L,h,b);d(h,b),n(`Clean done — CC:${A.components} endpoints:${A.endpoints} junctions:${A.junctions} thickness:${A.thicknessRatio.toFixed(2)}`),N("Contour clean: done",{width:h,height:b,pixels:w,whiteBg:p,EDGE_T:c,radius:r,edgeOn:y,edgeRatio:Math.round(y/Math.max(1,w)*1e6)/1e6,quality:A,ms:Math.round((performance.now()-g)*10)/10})}catch(u){O("Contour clean: exception",{error:u instanceof Error?u.message:String(u)}),n("Clean failed — see console / debug trace.")}finally{i()}})()},0)}),a(!1),l()})}function bo(e,t,o){const n=new Uint8Array(e.length),a=[];function s(f,r){return r*t+f}function l(f,r){return f<0||r<0||f>=t||r>=o?!1:e[s(f,r)]===1}function d(f,r){if(!l(f,r))return!1;for(let c=-1;c<=1;c++)for(let p=-1;p<=1;p++)if(!(p===0&&c===0)&&!l(f+p,r+c))return!0;return!1}const g=[{dx:1,dy:0},{dx:1,dy:1},{dx:0,dy:1},{dx:-1,dy:1},{dx:-1,dy:0},{dx:-1,dy:-1},{dx:0,dy:-1},{dx:1,dy:-1}],i=2e3,u=Math.max(2e3,Math.floor((t+o)*2)),m=Math.max(2e5,Math.floor(t*o*.25));let v=0;for(let f=0;f<o;f++)for(let r=0;r<t;r++){if(a.length>=i||v>=m)return a;const c=s(r,f);if(n[c]===1||!d(r,f))continue;const p=[];let h=r,b=f,w=4,E=0;const C=Math.min(t*o,u*4);for(;E<C;){E++;const x=s(h,b);if(n[x]===1||(p.push({x:h,y:b}),n[x]=1,v++,p.length>=u)||v>=m)break;let M=!1;const k=(w+6)%8;for(let D=0;D<8;D++){const y=(k+D)%8,S=h+g[y].dx,P=b+g[y].dy;if(!d(S,P))continue;const R=s(S,P);if(!(!(S===r&&P===f&&p.length>10)&&n[R]===1)){h=S,b=P,w=y,M=!0;break}}if(!M||h===r&&b===f&&p.length>10)break}p.length>=20&&a.push(p)}return a}function Xe(e,t){if(e.length<3)return e;const o=t*t;function n(i,u,m){const v=m.x-u.x,f=m.y-u.y,r=i.x-u.x,c=i.y-u.y,p=v*r+f*c;if(p<=0)return(i.x-u.x)**2+(i.y-u.y)**2;const h=v*v+f*f;if(h<=p)return(i.x-m.x)**2+(i.y-m.y)**2;const b=p/h,w=u.x+b*v,E=u.y+b*f;return(i.x-w)**2+(i.y-E)**2}const a=new Uint8Array(e.length);a[0]=1,a[e.length-1]=1;const s=[0],l=[e.length-1];for(;s.length>0;){const i=s.pop(),u=l.pop();if(u<=i+1)continue;const m=e[i],v=e[u];let f=0,r=-1;for(let c=i+1;c<u;c++){const p=n(e[c],m,v);p>f&&(f=p,r=c)}r!==-1&&f>o&&(a[r]=1,s.push(i),l.push(r),s.push(r),l.push(u))}const d=[];for(let i=0;i<e.length;i++)a[i]===1&&d.push(e[i]);const g=[];for(const i of d){const u=g[g.length-1];(!u||u.x!==i.x||u.y!==i.y)&&g.push(i)}return g}function yo(e,t){let o=e;for(let n=0;n<t;n++){if(o.length<3)return o;const a=[];for(let u=0;u<o.length-1;u++){const m=o[u],v=o[u+1];a.push({x:.75*m.x+.25*v.x,y:.75*m.y+.25*v.y},{x:.25*m.x+.75*v.x,y:.25*m.y+.75*v.y})}const s=o[0],l=o[o.length-1],d=s.x-l.x,g=s.y-l.y;if(d*d+g*g<=4){const u=o[o.length-1],m=o[0];a.push({x:.75*u.x+.25*m.x,y:.75*u.y+.25*m.y},{x:.25*u.x+.75*m.x,y:.25*u.y+.75*m.y})}o=a}return o}function Eo(e,t,o){const n=[];for(const a of e){const s=Co(a);s&&n.push(`<path d="${s}" fill="none" stroke="#000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>`)}return`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${t}" height="${o}" viewBox="0 0 ${t} ${o}">
<rect x="0" y="0" width="${t}" height="${o}" fill="#fff"/>
`+n.join(`
`)+`
</svg>
`}function Co(e){if(e.length<2)return"";const t=e.slice(),o=t[0],n=t[t.length-1],a=o.x-n.x,s=o.y-n.y,l=a*a+s*s<=4;l&&t.push({x:o.x,y:o.y});let d=`M ${t[0].x.toFixed(2)} ${t[0].y.toFixed(2)}`;for(let g=0;g<t.length-1;g++){const i=t[Math.max(0,g-1)],u=t[g],m=t[g+1],v=t[Math.min(t.length-1,g+2)],f=u.x+(m.x-i.x)/6,r=u.y+(m.y-i.y)/6,c=m.x-(v.x-u.x)/6,p=m.y-(v.y-u.y)/6;d+=` C ${f.toFixed(2)} ${r.toFixed(2)}, ${c.toFixed(2)} ${p.toFixed(2)}, ${m.x.toFixed(2)} ${m.y.toFixed(2)}`}return l&&(d+=" Z"),d}async function wo(e,t,o){if(!t.smoothedMask){j("Contour vectorize: skipped (no smoothed mask present)");return}const n=performance.now();await Z(e,async()=>{o.setContourBusyVisual(!0,"Vectorizing…");const a=()=>{t.svgText=void 0,e.svgPreviewTextEl.textContent="",e.svgPreviewImgEl.removeAttribute("src")};try{await new Promise((s,l)=>{setTimeout(()=>{(async()=>{try{const d=t.smoothedMask,g=e.outCanvasEl.width,i=e.outCanvasEl.height,u=g*i,m=1.5,f=(await ve()).pathSmoothIters;N("Contour vectorize: start",{width:g,height:i,pixels:u,epsilon:m,smoothIters:f});const r=bo(d,g,i),c=r.length,p=r.reduce((k,D)=>k+D.length,0),h=r.reduce((k,D)=>Math.max(k,D.length),0);if(c===0||p===0){j("Contour vectorize: no boundaries found",{width:g,height:i,pixels:u,pathsRaw:c,pointsRaw:p}),a(),o.setStatus("No boundaries found to vectorize."),s();return}if(c>2e3||p>2e5){j("Contour vectorize: aborted (too complex)",{width:g,height:i,pixels:u,pathsRaw:c,pointsRaw:p,maxPolyline:h}),a(),o.setStatus(`Vectorize aborted: too complex (paths ${c}, points ${p}). Try stronger clean / higher minArea / lower resolution.`),s();return}N("Contour vectorize: traced boundaries",{pathsRaw:c,pointsRaw:p,maxPolyline:h});const b=r.filter(k=>k.length>=20).map(k=>{const D=Xe(k,m),y=f>0?yo(D,f):D;return Xe(y,m)}).filter(k=>k.length>=3),w=b.length,E=b.reduce((k,D)=>k+D.length,0),C=b.reduce((k,D)=>Math.max(k,D.length),0);if(w===0||E===0){j("Contour vectorize: simplified to nothing",{pathsRaw:c,pointsRaw:p,pathsOut:w,pointsOut:E,smoothIters:f,epsilon:m}),a(),o.setStatus("Vectorize produced no usable paths (after simplification)."),s();return}N("Contour vectorize: simplified",{pathsOut:w,pointsOut:E,maxOut:C,smoothIters:f,epsilon:m});const x=Eo(b,g,i);t.svgText=x,e.svgPreviewTextEl.textContent=x;const M=encodeURIComponent(x).replace(/'/g,"%27").replace(/"/g,"%22");e.svgPreviewImgEl.src=`data:image/svg+xml;charset=utf-8,${M}`,o.setStatus(`SVG generated: paths ${w}, points ${p}→${E}, smooth ${f}`),N("Contour vectorize: done",{width:g,height:i,pixels:u,smoothIters:f,epsilon:m,pathsRaw:c,pointsRaw:p,pathsOut:w,pointsOut:E,svgChars:x.length,ms:Math.round((performance.now()-n)*10)/10}),s()}catch(d){O("Contour vectorize: exception",{error:d instanceof Error?d.message:String(d),ms:Math.round((performance.now()-n)*10)/10}),l(d)}})()},0)})}catch(s){o.showError("Vectorize",s),a()}finally{o.setContourBusyVisual(!1),o.updateEnabled()}})}function xo(e,t){const o=Tn(),n=An(e,o);function a(){const g=e.dropZoneEl;function i(u){g.classList.toggle("is-hover",u)}g.addEventListener("dragover",u=>{u.preventDefault(),i(!0)}),g.addEventListener("dragleave",()=>i(!1)),g.addEventListener("drop",u=>{var v;u.preventDefault(),i(!1);const m=(v=u.dataTransfer)==null?void 0:v.files;!m||m.length===0||Ke(e,o,m[0],{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearCanvases:n.clearCanvases,clearCleanCanvasesOnly:n.clearCleanCanvasesOnly,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,getNumber:n.getNumber})}),e.fileInputEl.addEventListener("change",()=>{var m;const u=(m=e.fileInputEl.files)==null?void 0:m[0];u&&(Ke(e,o,u,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearCanvases:n.clearCanvases,clearCleanCanvasesOnly:n.clearCleanCanvasesOnly,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,getNumber:n.getNumber}),e.fileInputEl.value="")})}function s(){a(),e.btnDownloadEl.addEventListener("click",()=>n.downloadPng()),e.btnDownloadSvgEl.addEventListener("click",()=>n.downloadSvg()),e.btnProcessEl.addEventListener("click",()=>{Hn(e,o,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearCleanCanvasesOnly:n.clearCleanCanvasesOnly,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled})}),e.btnCleanEl.addEventListener("click",()=>{vo(e,o,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,updateCleanQualityUI:n.updateCleanQualityUI})}),e.btnVectorizeEl.addEventListener("click",()=>{wo(e,o,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,updateEnabled:n.updateEnabled,showError:n.showError,getNumber:n.getNumber})}),Ln(o),n.clearSvgPreview(),n.updateEnabled(),n.setStatus("No image loaded"),e.contourSpinnerEl.classList.add("is-hidden")}function l(){}function d(){}return{id:"contour",bind:s,mount:l,unmount:d}}function So(){return{status:"Idle",report:["Segmentation placeholder","","Planned:","- Multi-step segmentation pipeline (process1..processN)","- Per-step engine selection: native / opencv / auto","- OpenCV injection + probing is managed in Settings (demo-only)."].join(`
`),assignedByStep:new Map,activeRecipePresetId:null,getStepEls(e){return{"segmentation.resize":e.segStepResizeEl,"segmentation.denoise":e.segStepDenoiseEl,"segmentation.color":e.segStepColorEl,"segmentation.threshold":e.segStepThresholdEl,"segmentation.morphology":e.segStepMorphologyEl}}}}const Et=[{id:"seg.recipe.document",title:"Recipe: Document scan",target:"segmentation",params:[{id:"segmentation.resize",key:"resizeAlgo",value:1},{id:"segmentation.resize",key:"targetMaxW",value:1200},{id:"segmentation.denoise",key:"denoiseAlgo",value:1},{id:"segmentation.denoise",key:"blurK",value:3},{id:"segmentation.color",key:"colorMode",value:1},{id:"segmentation.threshold",key:"thresholdAlgo",value:2},{id:"segmentation.threshold",key:"adaptBlock",value:31},{id:"segmentation.threshold",key:"adaptC",value:3},{id:"segmentation.morphology",key:"morphAlgo",value:2},{id:"segmentation.morphology",key:"morphK",value:5},{id:"segmentation.morphology",key:"morphIters",value:1}]},{id:"seg.threshold.otsu",title:"Threshold: Otsu",target:"segmentation.threshold",params:[{id:"segmentation.threshold",key:"thresholdAlgo",value:1}]},{id:"seg.morph.fill-holes",title:"Morphology: Fill holes (close)",target:"segmentation.morphology",params:[{id:"segmentation.morphology",key:"morphAlgo",value:3},{id:"segmentation.morphology",key:"morphK",value:7},{id:"segmentation.morphology",key:"morphIters",value:1}]}];function ko(e){return Et.find(t=>t.id===e)??null}function we(e,t,o){const n=document.createElement(e);return t&&(n.className=t),typeof o=="string"&&(n.textContent=o),n}function Mo(e,t){return t==="recipe"?e.target==="segmentation":e.target===t}function Do(e,t,o){const n=[],a=o.getStepEls(e);function s(){const c=e.segPresetListEl;c.innerHTML="";for(const p of Et){const h=we("div","segPresetCard");h.setAttribute("draggable","true"),h.setAttribute("data-preset-id",p.id),h.setAttribute("aria-label",`Preset: ${p.title}`);const b=we("div","segPresetCardTitle",p.title),w=we("div","segPresetCardDesc",p.description||`Target: ${p.target}`);h.appendChild(b),h.appendChild(w);const E=C=>{C.dataTransfer&&(C.dataTransfer.setData("text/plain",p.id),C.dataTransfer.effectAllowed="copy")};h.addEventListener("dragstart",E),n.push(()=>h.removeEventListener("dragstart",E)),c.appendChild(h)}}function l(c,p){const h=c.querySelector("[data-assigned]");h&&(h.textContent=p,h.classList.remove("muted"))}function d(c){const p=c.querySelector("[data-assigned]");p&&(p.textContent="Drop preset…",p.classList.add("muted"))}function g(c){for(const p of Object.keys(a))o.assignedByStep.set(p,c.id),l(a[p],c.title);o.activeRecipePresetId=c.id,l(e.segRecipeDropEl,c.title)}function i(c,p,h){o.assignedByStep.set(c,p.id),l(h,p.title)}function u(c,p){const h=C=>{C.preventDefault(),c.classList.add("is-over")},b=C=>{C.preventDefault(),c.classList.add("is-over"),C.dataTransfer&&(C.dataTransfer.dropEffect="copy")},w=()=>{c.classList.remove("is-over")},E=async C=>{var k;C.preventDefault(),c.classList.remove("is-over");const x=((k=C.dataTransfer)==null?void 0:k.getData("text/plain"))||"";if(!x)return;const M=ko(x);M&&Mo(M,p)&&(p==="recipe"?g(M):i(p,M,c),await t.applyPreset(M))};c.addEventListener("dragenter",h),c.addEventListener("dragover",b),c.addEventListener("dragleave",w),c.addEventListener("drop",E),n.push(()=>c.removeEventListener("dragenter",h)),n.push(()=>c.removeEventListener("dragover",b)),n.push(()=>c.removeEventListener("dragleave",w)),n.push(()=>c.removeEventListener("drop",E))}function m(){s(),u(e.segRecipeDropEl,"recipe"),u(a["segmentation.resize"],"segmentation.resize"),u(a["segmentation.denoise"],"segmentation.denoise"),u(a["segmentation.color"],"segmentation.color"),u(a["segmentation.threshold"],"segmentation.threshold"),u(a["segmentation.morphology"],"segmentation.morphology")}function v(){o.assignedByStep.clear(),o.activeRecipePresetId=null,d(e.segRecipeDropEl);for(const c of Object.keys(a))d(a[c])}function f(c){}function r(){for(const c of n)c();n.length=0}return m(),{set:f,resetUi:v,dispose:r}}async function Io(e,t){if(t.input.kind!=="image")throw new Error(`[segmentation] runImageOp: Mat input not supported yet for ${e}`);return{kind:"image",image:await me(e,{image:t.input.image,width:t.width,height:t.height})}}async function Ze(e,t){if(e==="segmentation.threshold"){const{input:s,width:l,height:d}=t;if(s.kind!=="image")throw new Error("[segmentation] runMaskOp(threshold): Mat input not supported yet");return await me(e,{image:s.image,width:l,height:d})}const{mask:o,width:n,height:a}=t;return await me(e,{mask:o,width:n,height:a})}const K=[{id:"segmentation.resize",kind:"image"},{id:"segmentation.denoise",kind:"image"},{id:"segmentation.color",kind:"image"},{id:"segmentation.threshold",kind:"mask"},{id:"segmentation.morphology",kind:"mask"}];function Ro(e,t,o){const n=So(),a=Do(e,o,n);let s=null;const l=n.getStepEls(e);function d(E){e.segStatusEl.textContent=E||""}function g(){for(const E of Object.values(l))E.classList.remove("is-active"),E.classList.remove("is-done")}function i(E){var C,x;for(const M of Object.values(l))M.classList.remove("is-active"),M.classList.remove("is-done");if(s){for(let M=0;M<Math.min(s.stepIndex,K.length);M++){const k=K[M].id;(C=l[k])==null||C.classList.add("is-done")}E&&((x=l[E])==null||x.classList.add("is-active"))}}function u(){if(!s)return;const{width:E,height:C}=s;e.segMaskCanvasEl.width=E,e.segMaskCanvasEl.height=C;const x=e.segMaskCanvasEl.getContext("2d",{willReadFrequently:!0});if(!x){O("[segmentation] preview: missing 2D context");return}if(s.artifact.kind==="image"){x.putImageData(s.artifact.image,0,0);return}x.putImageData(Be(s.artifact.mask,E,C,!0),0,0)}function m(){const E=e.srcCanvasEl,C=E.width,x=E.height;if(!C||!x)return null;const M=E.getContext("2d",{willReadFrequently:!0});if(!M)return null;const k=M.getImageData(0,0,C,x);return{width:C,height:x,stepIndex:0,artifact:{kind:"image",image:k}}}async function v(){if(!s&&(s=m(),!s)){d("No image");return}if(s.stepIndex>=K.length){d("Done");return}const E=K[s.stepIndex],{width:C,height:x}=s;if(i(E.id),d(`Running: ${E.id}`),N("[segmentation] next step",{stepIndex:s.stepIndex,stepId:E.id,width:C,height:x,artifact:s.artifact.kind}),E.id==="segmentation.resize"||E.id==="segmentation.denoise"||E.id==="segmentation.color"){if(s.artifact.kind!=="image")throw new Error(`[segmentation] step ${E.id} expected image input, got mask`);const M=await Io(E.id,{input:{kind:"image",image:s.artifact.image},width:C,height:x});if(M.kind!=="image")throw new Error(`[segmentation] step ${E.id} returned non-image`);const k=s.stepIndex<K.length?K[s.stepIndex].id:null;i(k),s.artifact={kind:"image",image:M.image},s.stepIndex++,u(),d(`Done: ${E.id}`);return}if(E.id==="segmentation.threshold"){if(s.artifact.kind!=="image")throw new Error("[segmentation] threshold expected image input, got mask");const M=await Ze("segmentation.threshold",{input:{kind:"image",image:s.artifact.image},width:C,height:x});s.artifact={kind:"mask",mask:M},s.stepIndex++,u(),i(null),d("Done: segmentation.threshold");return}if(E.id==="segmentation.morphology"){if(s.artifact.kind!=="mask")throw new Error("[segmentation] morphology expected mask input, got image");const M=await Ze("segmentation.morphology",{mask:s.artifact.mask,width:C,height:x});s.artifact={kind:"mask",mask:M},s.stepIndex++,u(),i(null),d("Done: segmentation.morphology");return}}async function f(){if(s=m(),!s){d("No image");return}for(u(),d("Running all…");s&&s.stepIndex<K.length;)await v();d("Done")}function r(){var x;a.resetUi(),s=null,g();const E=m();if(E){s=E,i((x=K[0])==null?void 0:x.id),u(),d("Ready (reset to source)");return}d("No image");const C=e.segMaskCanvasEl.getContext("2d");C&&C.clearRect(0,0,e.segMaskCanvasEl.width,e.segMaskCanvasEl.height)}function c(){e.segRunBtn.addEventListener("click",()=>{Z(e,async()=>{try{await f()}catch(E){O("[segmentation] runAll exception",{error:E instanceof Error?E.message:String(E)}),d("Failed")}})}),e.segNextBtn.addEventListener("click",()=>{Z(e,async()=>{try{await v()}catch(E){O("[segmentation] nextStep exception",{error:E instanceof Error?E.message:String(E)}),d("Failed")}})}),e.segResetBtn.addEventListener("click",()=>r())}function p(){var C;if(I("[segmentation] mount"),s){u(),d("Ready");return}const E=m();if(E)s=E,g(),i((C=K[0])==null?void 0:C.id),u(),d("Ready (source loaded)");else{g();const x=e.segMaskCanvasEl.getContext("2d");x&&x.clearRect(0,0,e.segMaskCanvasEl.width,e.segMaskCanvasEl.height),d("No image")}}function h(){var C;if(I("[segmentation] refresh"),s){u();return}const E=m();if(E){s=E,g(),i((C=K[0])==null?void 0:C.id),u(),d("Ready (source loaded)");return}d("No image")}function b(){}function w(){a.dispose()}return{bind:c,mount:p,refresh:h,unmount:b,dispose:w}}function xe(e,t,o){return Number.isFinite(e)?Math.max(t,Math.min(o,Math.trunc(e))):t}function To(e,t,o){return Math.round(.2126*e+.7152*t+.0722*o)}function Ct(e){return{edgesDark:!!(e.edgesDark??!0),edgeThreshold:xe(e.edgeThreshold??80,0,255),edgeDilate:xe(e.edgeDilate??2,0,6),maxRegionPx:xe(e.maxRegionPx??2e5,1e3,1e7)}}function Lo(e,t,o){const{data:n,width:a,height:s}=e,l=new Uint8Array(a*s);for(let d=0,g=0;d<l.length;d++,g+=4){const i=n[g+0],u=n[g+1],m=n[g+2];if(n[g+3]===0){l[d]=0;continue}const f=To(i,u,m),r=t?f<=o:f>=255-o;l[d]=r?1:0}return l}function Ao(e,t,o,n){if(n<=0)return e;let a=e;for(let s=0;s<n;s++){const l=new Uint8Array(t*o);for(let d=0;d<o;d++)for(let g=0;g<t;g++){const i=d*t+g;if(a[i]){l[i]=1;continue}let u=0;for(let m=-1;m<=1&&!u;m++){const v=d+m;if(!(v<0||v>=o))for(let f=-1;f<=1;f++){const r=g+f;if(!(r<0||r>=t)&&a[v*t+r]){u=1;break}}}l[i]=u}a=l}return a}function Po(e,t,o,n,a,s){const l=t*n+e;if(o[l])return{ok:!1,message:"Click is on an edge; pick inside a region."};const d=new Uint8Array(n*a),g=new Int32Array(n*a),i=new Int32Array(n*a);let u=0,m=0;g[m]=e,i[m]=t,m++,d[l]=1;let v=1;for(;u<m;){const f=g[u],r=i[u];u++;const c=[[f-1,r],[f+1,r],[f,r-1],[f,r+1]];for(const[p,h]of c){if(p<0||p>=n||h<0||h>=a)continue;const b=h*n+p;if(!d[b]&&!o[b]&&(d[b]=1,g[m]=p,i[m]=h,m++,v++,v>s))return{ok:!1,message:`Region too large (>${s}px). Increase Max region or fix gaps.`}}}return{ok:!0,mask:d}}function Bo(e,t,o,n){const a=new Uint8Array(o*n);for(let s=1;s<n-1;s++)for(let l=1;l<o-1;l++){const d=s*o+l;if(!e[d])continue;const g=(s-1)*o+l,i=(s+1)*o+l,u=s*o+(l-1),m=s*o+(l+1);(!e[g]||!e[i]||!e[u]||!e[m]||t[g]||t[i]||t[u]||t[m])&&(a[d]=1)}return a}function Oo(e,t,o,n){const a=Ct(n),s=e.width,l=e.height;let d=Lo(e,a.edgesDark,a.edgeThreshold);d=Ao(d,s,l,a.edgeDilate);const g=Po(t,o,d,s,l,a.maxRegionPx);if(!g.ok)return{ok:!1,message:g.message};const i=Bo(g.mask,d,s,l);return{ok:!0,preview:{mask:g.mask,outline:i,w:s,h:l}}}function $o(e,t,o){const n=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),a=o.replace("#",""),s=parseInt(a.slice(0,2),16),l=parseInt(a.slice(2,4),16),d=parseInt(a.slice(4,6),16),g=n.data;for(let i=0,u=0;i<t.mask.length;i++,u+=4)t.mask[i]&&(g[u+0]=s,g[u+1]=l,g[u+2]=d);return n}function Se(e,t,o){return Number.isFinite(e)?Math.max(t,Math.min(o,Math.trunc(e))):t}function et(e){const t=(e||"").trim();if(!t)return null;const o=t.startsWith("#")?t:`#${t}`;return/^#[0-9a-fA-F]{6}$/.test(o)?o.toLowerCase():null}function No(e){let t="#ff3b30",o=[],n=null;function a(c){e.colorsStatusEl.textContent=c||""}function s(){const c=!!e.edgesDarkEl.checked,p=Se(parseInt(e.edgeMaskThresholdEl.value,10),0,255),h=Se(parseInt(e.edgeDilateEl.value,10),0,6),b=Se(parseInt(e.maxRegionPxEl.value,10),1e3,1e7);return e.edgeMaskThresholdEl.value=String(p),e.edgeDilateEl.value=String(h),e.maxRegionPxEl.value=String(b),Ct({edgesDark:c,edgeThreshold:p,edgeDilate:h,maxRegionPx:b})}function l(c){const p=et(c);if(p){t=p;for(const h of Array.from(e.paletteEl.querySelectorAll(".paletteItem"))){const b=h.dataset.hex||"";h.classList.toggle("is-selected",b===t)}}}function d(){return t}function g(c){o=c.slice(),e.paletteEl.innerHTML="";for(const p of o){const h=et(p);if(!h)continue;const b=document.createElement("button");b.type="button",b.className="paletteItem",b.style.background=h,b.dataset.hex=h,b.setAttribute("role","listitem"),b.setAttribute("aria-label",`Select ${h}`),b.addEventListener("click",()=>{l(h)}),e.paletteEl.appendChild(b)}l(t)}function i(c){const p=e.colorsCanvasEl;p.width=c.width,p.height=c.height,p.getContext("2d").putImageData(c,0,0)}function u(c,p){i(c);const h=e.colorsCanvasEl.getContext("2d"),{outline:b,w,h:E}=p,C=h.getImageData(0,0,w,E),x=C.data;for(let M=0,k=0;M<b.length;M++,k+=4)b[M]&&(x[k+0]=255,x[k+1]=60,x[k+2]=60,x[k+3]=220);h.putImageData(C,0,0)}function m(c){e.btnColorsApplyEl.disabled=!c}function v(c){e.btnColorsCancelEl.disabled=!c}function f(c){n=c}function r(){a("Idle"),m(!1),v(!1),e.colorsCanvasEl.addEventListener("click",c=>{if(!n)return;const p=e.colorsCanvasEl.getBoundingClientRect(),h=Math.floor((c.clientX-p.left)/p.width*e.colorsCanvasEl.width),b=Math.floor((c.clientY-p.top)/p.height*e.colorsCanvasEl.height);n(h,b)})}return{bind:r,setStatus:a,getSettings:s,setSelectedColor:l,getSelectedColor:d,renderPalette:g,drawBase:i,drawPreview:u,setApplyEnabled:m,setCancelEnabled:v,onCanvasClick:f}}const Vo=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#a2845e","#8e8e93","#1c1c1e","#ffffff","#000000","#4cd964","#5ac8fa","#ff6b6b","#7aa2ff","#f5a623","#50e3c2"];function Uo(e,t){const o=No(e);let n=null,a=null;function s(m){o.setStatus(m)}function l(){const m=e.outCanvasEl.getContext("2d");if(!m)return null;const v=e.outCanvasEl.width,f=e.outCanvasEl.height;return v<=0||f<=0?null:m.getImageData(0,0,v,f)}function d(){const m=l();if(!m){n=null,a=null,o.setApplyEnabled(!1),o.setCancelEnabled(!1),s("No output available. Run Process first.");return}n=m,a=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),s("Ready. Pick a color, click inside a region.")}function g(){if(n){o.drawBase(n);return}const m=l();if(!m){s("No output available. Run Process first.");return}n=m,a=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),s("Loaded output. Pick a color, click inside a region.")}function i(){if(!n||!a)return;const m=o.getSelectedColor();n=$o(n,a,m),a=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),s("Fill applied. Click another region.")}function u(){n&&(a=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),s("Preview canceled."))}return{bind(){o.bind(),o.renderPalette(Vo),o.onCanvasClick((m,v)=>{if(!n){s("No output available. Run Process first.");return}const f=o.getSettings(),r=Oo(n,m,v,f);if(!r.ok){a=null,o.setApplyEnabled(!1),o.setCancelEnabled(!1),s(r.message);return}a=r.preview,o.drawPreview(n,a),o.setApplyEnabled(!0),o.setCancelEnabled(!0),s("Preview shown. Apply fill or cancel.")}),e.btnColorsApplyEl.addEventListener("click",()=>i()),e.btnColorsCancelEl.addEventListener("click",()=>u()),e.btnColorsResetEl.addEventListener("click",()=>d()),e.tabColors.addEventListener("click",()=>{queueMicrotask(()=>g())}),s("Idle"),o.setApplyEnabled(!1),o.setCancelEnabled(!1)}}}const pe="beecontour.actionLog",zo=5e3;function Fo(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function jo(e){return Array.isArray(e)?e:[e]}function he(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}async function se(){const e=await J(pe),t=e==null?void 0:e[pe];return Array.isArray(t)?t:[]}async function wt(e){await X({[pe]:e})}async function Y(e,t){const o=he(zo,100,5e4),a=jo(e).map(g=>({...g,id:Fo(),ts:Date.now()}));if(!a.length)return{total:(await se()).length};const l=(await se()).concat(a),d=l.length>o?l.slice(l.length-o):l;return await wt(d),{total:d.length}}async function _o(e){const t=he((e==null?void 0:e.limit)??200,1,5e4),o=he((e==null?void 0:e.offset)??0,0,1e6);let a=await se();e!=null&&e.kind&&(a=a.filter(d=>d.kind===e.kind)),e!=null&&e.scope&&(a=a.filter(d=>d.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(a=a.filter(d=>d.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(a=a.filter(d=>d.ts<=e.untilTs));const s=a.length;a=a.slice().reverse();const l=a.slice(o,o+t);return{total:s,items:l}}async function Ko(e){let o=await se();if(typeof e.beforeTs=="number"&&(o=o.filter(n=>n.ts>=e.beforeTs)),typeof e.keepLast=="number"){const n=he(e.keepLast,0,5e4);n===0?o=[]:o.length>n&&(o=o.slice(o.length-n))}return await wt(o),{total:o.length}}async function Go(){await Oe(pe)}async function qo(e){const t=await se();return JSON.stringify(t,null,2)}const tt="0.0.10";async function Qo(e){const t=new URL(e.opencvJsRel,document.baseURI).toString(),o=new URL(e.opencvWasmRel,document.baseURI).toString(),n=globalThis;n.Module=n.Module||{},n.Module.locateFile=a=>a.endsWith(".wasm")?o:a,n.Module.print=()=>{},n.Module.printErr=()=>{},n.cv||await Wo(t),await Ho(e.timeoutMs)}function Wo(e){return new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0;const a=15e3,s=window.setTimeout(()=>{l(),o(new Error(`OpenCV script load timeout after ${a}ms: ${e}`))},a);function l(){window.clearTimeout(s),n.onload=null,n.onerror=null}n.onload=()=>{l(),t()},n.onerror=()=>{l(),o(new Error(`Failed to load OpenCV script: ${e}`))},document.head.appendChild(n)})}async function Ho(e){var n;const t=Date.now(),o=globalThis;for(;Date.now()-t<e;){try{if(o.cv&&typeof o.cv.Mat=="function"){const a=new o.cv.Mat;(n=a.delete)==null||n.call(a);return}}catch{}await new Promise(a=>setTimeout(a,75))}throw new Error(`OpenCV initialization timeout after ${e}ms`)}async function Yo(){try{await Qo({opencvJsRel:"../assets/opencv/opencv.js",opencvWasmRel:"../assets/opencv/opencv.wasm",timeoutMs:2e4}),_n("opencv")}catch(e){throw Kn("opencv",e!=null&&e.message?String(e.message):String(e)),e}}function T(e,t,o){const n=document.createElement(e);if(t)for(const[a,s]of Object.entries(t))n.setAttribute(a,s);return typeof o=="string"&&(n.textContent=o),n}function nt(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function Jo(e){return e.fallbackReason?`${e.effectiveEngine} (fallback)`:e.effectiveEngine}function Xo(e){const t=[{value:"native",label:"Native"},{value:"auto",label:"Auto"},...e.canImplementOpenCv?[{value:"opencv",label:"OpenCV"}]:[]];return e.isRoot?t:[{value:"inherit",label:"Inherit"},...t]}function Zo(e){return!1}function ea(e,t,o){var a;const n=(a=e.storedParams)==null?void 0:a[t];return typeof n<"u"&&n!==o}function ta(e){var m;const{node:t,compId:o,key:n,schema:a,value:s,handlers:l}=e,d=T("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),g=T("label",{class:"fieldInline"}),i=T("span",void 0,a.label);g.appendChild(i);let u;if(a.kind==="number"?(u=T("input"),u.type="number",typeof a.min=="number"&&(u.min=String(a.min)),typeof a.max=="number"&&(u.max=String(a.max)),typeof a.step=="number"&&(u.step=String(a.step)),u.value=String(s??a.default),u.addEventListener("change",()=>{const v=Number(u.value);l.onSetParam(o,n,Number.isFinite(v)?v:a.default)})):a.kind==="boolean"?(u=T("input"),u.type="checkbox",u.checked=!!s,u.addEventListener("change",()=>{l.onSetParam(o,n,!!u.checked)})):(u=T("input"),u.type="text",u.value=String(s??a.default),u.addEventListener("change",()=>{l.onSetParam(o,n,String(u.value??a.default))})),g.appendChild(u),d.appendChild(g),l.onResetParam&&typeof((m=t.storedParams)==null?void 0:m[n])<"u"){const v=T("button",{type:"button"},"Reset");v.addEventListener("click",f=>{var r;f.preventDefault(),(r=l.onResetParam)==null||r.call(l,o,n)}),d.appendChild(v)}return ea(t,n,s)&&d.appendChild(T("span",{class:"muted",style:"font-size:12px;"},"override")),d}function xt(e){const{node:t,depth:o,isRoot:n,handlers:a,treeScopeId:s}=e,l=T("div",{style:`margin-left:${Math.min(o*14,56)}px; margin-top:10px;`}),d=T("div",{style:"border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:10px; background:rgba(0,0,0,0.12);"}),g=T("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),i=T("div");i.appendChild(T("div",{style:"font-weight:700;"},t.title)),t.description&&i.appendChild(T("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},t.description)),t.isGroup&&i.appendChild(T("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},"Group (policy affects children)")),g.appendChild(i);const u=T("div",{class:"row",style:"align-items:center; gap:10px;"});u.appendChild(T("span",{class:"qBadge"},Jo(t)));const m=T("select");m.style.background="rgba(255,255,255,0.05)",m.style.border="1px solid rgba(255,255,255,0.08)",m.style.color="rgba(255,255,255,0.92)",m.style.borderRadius="10px",m.style.padding="6px 8px";const v=Xo({isRoot:n,canImplementOpenCv:t.canImplementOpenCv});for(const w of v){const E=T("option");E.value=w.value,E.textContent=w.label,m.appendChild(E)}const f=new Set(v.map(w=>w.value)),r=t.effectivePolicy;f.has(r)?m.value=r:m.value=n?"native":"inherit",m.addEventListener("change",()=>{a.onSetPolicy(t.id,m.value)}),u.appendChild(m);const c=typeof t.storedPolicy<"u"||t.storedParams&&Object.keys(t.storedParams).length>0;if(a.onResetNode&&c){const w=T("button",{type:"button"},"Reset node");w.addEventListener("click",E=>{var C;E.preventDefault(),(C=a.onResetNode)==null||C.call(a,t.id)}),u.appendChild(w)}g.appendChild(u),d.appendChild(g),t.fallbackReason?d.appendChild(T("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},t.fallbackReason)):t.effectivePolicy==="opencv"&&!t.runtimeOpenCvReady&&d.appendChild(T("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},"OpenCV policy selected, but OpenCV is not available at runtime. It will fall back to native."));const p=Object.keys(t.paramsSchema??{}),h=p.length>0,b=t.children.length>0;if(h||b){const w=T("details",{style:"margin-top:10px;"});w.open=Zo();const E=T("summary",{style:"cursor:pointer; user-select:none;"},"Details");if(w.appendChild(E),h){const C=T("div",{style:"margin-top:10px;"});C.appendChild(T("div",{class:"muted",style:"font-weight:600; margin-bottom:6px;"},"Parameters"));for(const x of p){const M=t.paramsSchema[x],k=t.effectiveParams[x];C.appendChild(ta({node:t,compId:t.id,key:x,schema:M,value:k,handlers:a}))}w.appendChild(C)}if(b){const C=T("div",{style:"margin-top:10px;"});for(const x of t.children)C.appendChild(xt({node:x,depth:o+1,isRoot:!1,handlers:a,treeScopeId:s}));w.appendChild(C)}d.appendChild(w)}return l.appendChild(d),l}function St(e,t){let o=!1;function n(s){if(o)return;nt(e);const l=s.scopeId==="app",d=T("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"});d.appendChild(T("div",{style:"font-weight:700;"},"Tuning")),d.appendChild(T("div",{class:"muted",style:"font-size:12px;"},`OpenCV runtime: ${s.runtime.opencvReady?"ready":"not available"}`)),e.appendChild(d),e.appendChild(xt({node:s.root,depth:0,isRoot:l,handlers:t,treeScopeId:s.scopeId}))}function a(){o=!0,nt(e)}return{render:n,dispose:a}}function na(){let e=!1,t={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},o=!1,n="",a="";function s(i){e=i}function l(i){t={...t,...i}}function d(i){o=i}function g(i){typeof i.general=="string"&&(n=i.general),typeof i.dev=="string"&&(a=i.dev)}return{get showDevTools(){return e},get dev(){return t},get debugEnabled(){return o},get generalStatus(){return n},get devStatus(){return a},setShowDevTools:s,setDev:l,setDebugEnabled:d,setStatus:g}}function oa(e){function t(i){e.settingsGeneralStatusEl.textContent=i||""}function o(i){e.cfgStatusEl.textContent=i||""}function n(i){e.cfgShowDevToolsEl.checked=i}function a(i){e.tabLogs.hidden=!i,e.devConfigDetailsEl.classList.toggle("is-hidden",!i),i||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function s(i){e.cfgTraceConsoleEl.checked=!!i.traceConsole,e.cfgActionLogMaxEl.value=String(i.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(i.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(i.failureLogsPerRun??50)}function l(i){e.logsCbDebugEl.checked=i}function d(i,u){e.settingsVersionEl.textContent=i||"—",e.settingsGitHubLinkEl.href=u||"#",e.settingsGitHubLinkEl.hidden=!u}function g(i){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=i,e.cfgActionLogMaxEl.disabled=i,e.cfgDebugTraceMaxEl.disabled=i,e.cfgFailureLogsPerRunEl.disabled=i,e.btnCfgResetDefaults.disabled=i,e.logsCbDebugEl.disabled=i,e.cfgUseOpenCvEl.disabled=i}return{setGeneralStatus:t,setDevStatus:o,setShowDevToolsChecked:n,setDevToolsVisible:a,setDevConfig:s,setDebugEnabledChecked:l,setAbout:d,setBusy:g}}const ke="template.settings.showDevTools",Me="beecontour.settings.engine.useOpenCv";function aa(){var e,t;try{const o=(e=globalThis==null?void 0:globalThis.chrome)==null?void 0:e.runtime,n=(t=o==null?void 0:o.getManifest)==null?void 0:t.call(o),a=typeof(n==null?void 0:n.version)=="string"?n.version:"";if(I("Settings: getManifestVersion manifest found version is ",{v:a}),a)return a}catch{}return I("Settings: getManifestVersion fallback",{APP_VERSION:tt}),tt}function De(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??z.actionLogMax),debugTraceMax:Number(e.debugTraceMax??z.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??z.failureLogsPerRun)}}function sa(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:G(e.cfgActionLogMaxEl.value,100,5e4,z.actionLogMax),debugTraceMax:G(e.cfgDebugTraceMaxEl.value,100,5e4,z.debugTraceMax),failureLogsPerRun:G(e.cfgFailureLogsPerRunEl.value,0,5e4,z.failureLogsPerRun)}}async function ot(e){const t=mt;return typeof t.setEnabled=="function"?(await t.setEnabled(e),{ok:!0}):typeof t.enable=="function"&&typeof t.disable=="function"?(await(e?t.enable():t.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function ia(e,t){const o=na(),n=oa(e),a=ze({getRuntimeAvailability:()=>({opencvReady:e.cfgUseOpenCvEl.checked&&Q()})}),s=St(e.tuningMountEl,{onSetPolicy:async(y,S)=>{await a.setEnginePolicy(y,S),await b("policy change")},onSetParam:async(y,S,P)=>{await a.setParam(y,S,P),await b("param change")},onResetNode:async y=>{await a.resetNode(y),await b("reset node")},onResetParam:async(y,S)=>{await a.resetParam(y,S),await b("reset param")}});function l(y){e.settingsEngineBoxEl.classList.toggle("is-hidden",!1)}async function d(){const y=await J([Me]).catch(()=>({}));return(y==null?void 0:y[Me])===!0}async function g(y){await X({[Me]:!!y}).catch(()=>null)}function i(y){var S;e.cfgUseOpenCvEl.checked=y,(S=e.cfgUseOpenCvEl.closest(".switch"))==null||S.classList.toggle("is-disabled",e.cfgUseOpenCvEl.disabled)}function u(y){e.cfgOpenCvSpinner.classList.toggle("is-hidden",!y),e.cfgOpenCvSpinner.setAttribute("aria-hidden",y?"false":"true")}function m(y){e.cfgOpenCvStatus.textContent=y||""}function v(y){e.cfgOpenCvReport.textContent=y||""}async function f(){if(U())return;if(!!!e.cfgUseOpenCvEl.checked){await g(!1),u(!1),m(Q()?"OpenCV loaded (native mode)":"Native mode"),v("Native mode. OpenCV is optional and demo-only."),await b("opencv mode disabled");return}u(!0),m("Loading OpenCV…"),v("Loading OpenCV…");try{if(await Z(e,async()=>{await Yo()}),!Q())throw new Error("OpenCV load returned but runtime is not injected.");await g(!0),m("OpenCV mode enabled"),v("OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV."),await b("opencv mode enabled")}catch(S){const P=String((S==null?void 0:S.message)??S);await g(!1),i(!1),m("OpenCV load failed"),v(`ERROR

${P}`),O("[settings] OpenCV toggle failed",{msg:P})}finally{u(!1)}}async function r(){const y=await J([ke]).catch(()=>({}));return(y==null?void 0:y[ke])===!0}async function c(y){await X({[ke]:!!y}).catch(()=>null)}function p(y){o.setShowDevTools(y),n.setShowDevToolsChecked(y),n.setDevToolsVisible(y)}async function h(){const y=await r();p(y),I("Settings: boot applyDevToolsVisibility",{showDevTools:y})}async function b(y){try{const S=await a.loadTree("app");s.render(S),I("[settings] tuning rendered",{reason:y,opencvInjected:Q(),opencvMode:!!e.cfgUseOpenCvEl.checked})}catch(S){O("[settings] tuning render failed",{reason:y,msg:String((S==null?void 0:S.message)??S)}),e.tuningMountEl.textContent="Tuning UI failed to load (see console)."}}async function w(){var L;n.setBusy(U());const y=await r();p(y),await Te().catch(()=>null);const S=de();o.setDev(De(S)),n.setDevConfig(o.dev);const P=mt;let R=!1;try{typeof P.isEnabled=="function"?R=!!await P.isEnabled():R=!!P.enabled}catch(A){j("Settings: failed to read debug enabled state",{error:A instanceof Error?A.message:String(A)})}o.setDebugEnabled(R),n.setDebugEnabledChecked(R),n.setAbout(aa()||"—",((L=e.settingsGitHubLinkEl)==null?void 0:L.href)||"#"),l();{const A=await d();i(A),u(!1);const V=Q();A?(m(V?"OpenCV mode enabled":"OpenCV mode (not loaded)"),v(V?"OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV.":"OpenCV mode is enabled, but OpenCV is not loaded yet. Toggle OFF then ON to load OpenCV.")):(m(V?"OpenCV loaded (native mode)":"Native mode"),v("Native mode. OpenCV is optional and demo-only."))}n.setGeneralStatus(""),n.setDevStatus(""),await b("loadAll"),I("Settings: loaded",{showDevTools:y,debugTraceEnabled:R,dev:o.dev,opencvInjected:Q()})}async function E(){const y=!!e.cfgShowDevToolsEl.checked;p(y),await c(y),Y({kind:"run",scope:"settings",message:y?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:y}}),I("Settings: ui toggle showDevTools",{showDevTools:y}),n.setGeneralStatus(y?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>n.setGeneralStatus(""),1200)}async function C(){const y=sa(e);n.setDevStatus("Saving…");try{await lt(y)}catch(S){O("Settings: failed to save dev config",{error:S instanceof Error?S.message:String(S),next:y}),n.setDevStatus("Save failed."),setTimeout(()=>n.setDevStatus(""),1200);return}o.setDev(De(y)),n.setDevConfig(o.dev),Y({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:y}),I("Settings: devConfig updated",y),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}async function x(){n.setDevStatus("Resetting…");try{await Dn(),await Te().catch(()=>null);const S=de();o.setDev(De(S)),n.setDevConfig(o.dev)}catch(S){O("Settings: failed to reset dev config defaults",{error:S instanceof Error?S.message:String(S)}),n.setDevStatus("Reset failed."),setTimeout(()=>n.setDevStatus(""),1200);return}const y=await ot(!1);y.ok?(o.setDebugEnabled(!1),n.setDebugEnabledChecked(!1)):(j("Settings: failed to reset debug enabled state",{error:y.error||"unknown error"}),Y({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:y.error||"unknown error"})),Y({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...z,debugEnabled:!1}}),I("Settings: reset defaults",{...z,debugEnabled:!1}),n.setDevStatus("Reset."),setTimeout(()=>n.setDevStatus(""),1200)}async function M(){const y=!!e.logsCbDebugEl.checked;n.setDevStatus("Saving…");const S=await ot(y);if(!S.ok){e.logsCbDebugEl.checked=!y,n.setDevStatus(`Save failed: ${S.error||"unknown error"}`),O("Settings: failed to change debug enabled state",{error:S.error||"unknown error",enabled:y}),Y({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:S.error||"unknown error",meta:{enabled:y}});return}o.setDebugEnabled(y),Y({kind:"run",scope:"settings",message:y?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:y}}),I("Settings: debug enabled changed",{enabled:y}),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}const k=t.on(()=>{});function D(){e.cfgShowDevToolsEl.addEventListener("change",()=>{E()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{U()||C()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{U()||C()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{U()||C()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{U()||C()}),e.btnCfgResetDefaults.addEventListener("click",()=>{U()||x()}),e.logsCbDebugEl.addEventListener("change",()=>{U()||M()}),e.cfgUseOpenCvEl.addEventListener("change",()=>{f()}),h().catch(y=>{j("Settings: initDevToolsVisibility failed",{error:y instanceof Error?y.message:String(y)})})}return{id:"settings",refresh(){w().catch(y=>{O("Settings: refresh failed",{error:y instanceof Error?y.message:String(y)})})},mount(){w().catch(y=>{O("Settings: mount failed",{error:y instanceof Error?y.message:String(y)})})},unmount(){},bind:D,dispose(){k()}}}function ra(){let e=[],t=0;function o(n){e=n.items,t=n.total}return{get items(){return e},get total(){return t},set:o}}function la(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function at(e,t){const o=[];o.push(`Total entries: ${t.total}`),o.push("");for(const n of t.items){const a=typeof n.ok=="boolean"?n.ok?"ok":"fail":"",s=[];typeof n.status=="number"&&s.push(`status=${n.status}`),a&&s.push(a);const l=[n.scope,n.kind].filter(Boolean).join("/");o.push(`[${la(n.ts)}] ${l}${s.length?` (${s.join(", ")})`:""}`),o.push(`  ${n.message}`),n.error&&o.push(`  error: ${n.error}`),o.push("")}e.textContent=o.join(`
`),e.scrollTop=0}function ca(e){function t(l){e.logsStatusEl.textContent=l}function o(l){e.debugStatusEl.textContent=l}function n(l){e.logsCbDebugEl.checked=l}function a(l){at(e.logsOutEl,{total:l.total,items:l.items.map(d=>({ts:d.ts,message:d.message,scope:d.scope,kind:d.kind,ok:d.ok,status:d.status,error:d.error,meta:d.meta}))})}function s(l){at(e.debugOutEl,{total:l.total,items:l.items.map(d=>({ts:d.ts,message:d.message,scope:d.scope,kind:d.kind,ok:d.ok,status:d.status,error:d.error,meta:d.meta}))})}return{setAuditStatus:t,setDebugStatus:o,setDebugChecked:n,renderAudit:a,renderDebug:s}}const st="beecontour";function ua(e,t){const o=ra(),n=ca(e);async function a(){n.setAuditStatus("Loading…"),_(e,!0);try{const r=G(e.logsLimitEl.value,10,5e3,200),c=await _o({limit:r,reverse:!0});o.set(c),n.renderAudit({items:o.items,total:o.total}),n.setAuditStatus(`Showing ${o.items.length} (newest first)`)}catch(r){n.setAuditStatus(`Failed: ${(r==null?void 0:r.message)||String(r)}`)}finally{_(e,!1)}}async function s(){n.setDebugStatus("Loading…"),_(e,!0);try{const r=G(e.debugLimitEl.value,10,5e3,200),c=await gt({limit:r,reverse:!0});n.renderDebug(c),n.setDebugStatus(`Showing ${c.items.length} (newest first)`)}catch(r){n.setDebugStatus(`Failed: ${(r==null?void 0:r.message)||String(r)}`)}finally{_(e,!1)}}async function l(){const r=await $e();n.setDebugChecked(r)}async function d(r){if(await ut(r),n.setDebugChecked(r),!r){n.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}n.setDebugStatus("Debug ON."),await s()}async function g(){const r=G(e.logsTrimKeepEl.value,0,5e4,2e3);n.setAuditStatus("Trimming…"),_(e,!0);try{const c=await Ko({keepLast:r});await a(),n.setAuditStatus(`Trimmed. Remaining: ${c.total}`)}catch(c){n.setAuditStatus(`Trim failed: ${(c==null?void 0:c.message)||String(c)}`)}finally{_(e,!1)}}async function i(){n.setAuditStatus("Clearing…"),_(e,!0);try{await Go(),await a(),n.setAuditStatus("Cleared.")}catch(r){n.setAuditStatus(`Clear failed: ${(r==null?void 0:r.message)||String(r)}`)}finally{_(e,!1)}}async function u(){n.setAuditStatus("Exporting…");try{const r=await qo({pretty:!0}),c=new Blob([r],{type:"application/json"}),p=URL.createObjectURL(c),h=document.createElement("a");h.href=p,h.download=`${st}-audit-${Date.now()}.json`,h.click(),setTimeout(()=>URL.revokeObjectURL(p),1e3),n.setAuditStatus("Exported.")}catch(r){n.setAuditStatus(`Export failed: ${(r==null?void 0:r.message)||String(r)}`)}}async function m(){n.setDebugStatus("Clearing…"),_(e,!0);try{await dt(),await s(),n.setDebugStatus("Cleared.")}catch(r){n.setDebugStatus(`Clear failed: ${(r==null?void 0:r.message)||String(r)}`)}finally{_(e,!1)}}async function v(){n.setDebugStatus("Exporting…");try{const r=await ft({pretty:!0}),c=new Blob([r],{type:"application/json"}),p=URL.createObjectURL(c),h=document.createElement("a");h.href=p,h.download=`${st}-debug-${Date.now()}.json`,h.click(),setTimeout(()=>URL.revokeObjectURL(p),1e3),n.setDebugStatus("Exported.")}catch(r){n.setDebugStatus(`Export failed: ${(r==null?void 0:r.message)||String(r)}`)}}function f(){e.btnLogsRefresh.addEventListener("click",()=>{U()||a()}),e.btnLogsTrim.addEventListener("click",()=>{U()||g()}),e.btnLogsClear.addEventListener("click",()=>{U()||i()}),e.btnLogsExport.addEventListener("click",()=>{U()||u()}),e.logsCbDebugEl.addEventListener("change",()=>{U()||d(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{U()||s()}),e.btnDebugClear.addEventListener("click",()=>{U()||m()}),e.btnDebugExport.addEventListener("click",()=>{U()||v()})}return{id:"logs",bind:f,mount(){l(),a(),s()},unmount(){},dispose(){}}}function da(e,t){if(e.id===t)return e;const o=[...e.children??[]];for(;o.length>0;){const n=o.shift();if(n.id===t)return n;for(const a of n.children??[])o.push(a)}throw new Error(`[tuning] scopeRootId not found in VM tree: ${t}`)}function ga(e){const t=ze({getRuntimeAvailability:e.getRuntimeAvailability}),o=[];let n=!1;async function a(){return await t.loadTree("app")}async function s(){if(n)return;const c=await a();for(const p of o){if(p.scopeRootId==="app"){p.view.render(c);continue}const h=da(c.root,p.scopeRootId);p.view.render({...c,scopeId:p.scopeRootId,root:h})}}async function l(c,p){await t.setEnginePolicy(c,p),e.actionLogAppend(`[tuning] policy ${c} = ${p}`),e.debugTraceAppend(`[tuning] setPolicy id=${c} policy=${p}`),await s()}async function d(c,p,h){await t.setParam(c,p,h),e.actionLogAppend(`[tuning] param ${c}.${p} = ${String(h)}`),e.debugTraceAppend(`[tuning] setParam id=${c} key=${p} value=${String(h)}`),await s()}async function g(c){await t.resetNode(c),e.actionLogAppend(`[tuning] reset node ${c}`),e.debugTraceAppend(`[tuning] resetNode id=${c}`),await s()}async function i(c,p){await t.resetParam(c,p),e.actionLogAppend(`[tuning] reset param ${c}.${p}`),e.debugTraceAppend(`[tuning] resetParam id=${c} key=${p}`),await s()}async function u(c){var p,h;if(!n){if(c.policies)for(const b of c.policies)await t.setEnginePolicy(b.id,b.policy);if(c.params)for(const b of c.params)await t.setParam(b.id,b.key,b.value);e.actionLogAppend(`[tuning] preset ${c.id} (${c.title})`),e.debugTraceAppend(`[tuning] applyPreset id=${c.id} title=${c.title} policies=${((p=c.policies)==null?void 0:p.length)??0} params=${((h=c.params)==null?void 0:h.length)??0}`),await s()}}function m(c){if(n)return;const{mountEl:p,scopeRootId:h}=c;if(o.some(w=>w.mountEl===p))return;const b=St(p,{onSetPolicy:l,onSetParam:d,onResetNode:g,onResetParam:i});o.push({mountEl:p,scopeRootId:h,view:b}),s()}function v(c){const p=o.findIndex(h=>h.mountEl===c);p<0||(o[p].view.dispose(),o.splice(p,1))}async function f(){await s()}function r(){n=!0;for(const c of o)c.view.dispose();o.length=0}return{mount:m,unmount:v,refresh:f,applyPreset:u,dispose:r}}async function fa(){const e=Cn();await Te().catch(()=>null);const t=Sn();t.start();const o=Rn();globalThis.__APP__={...globalThis.__APP__,cache:o};const n=ga({getRuntimeAvailability:()=>({opencvReady:!1}),debugTraceAppend:u=>Ne({scope:"panel",kind:"debug",message:u}),actionLogAppend:u=>Y({scope:"panel",kind:"info",message:u})});n.mount({mountEl:e.tuningMountEl,scopeRootId:"app"}),n.mount({mountEl:e.contourTuningMountEl,scopeRootId:"contour"}),n.mount({mountEl:e.segTuningMountEl,scopeRootId:"segmentation"});const a=xo(e),s=Uo(e),l=Ro(e,t,n),d=ia(e,t),g=ua(e);a.bind(),l.bind(),s.bind(),d.bind(),g.bind();const i=In(e,{contour:a,segmentation:l,colors:s,settings:d,logs:g});i.bind(),i.boot()}fa();
