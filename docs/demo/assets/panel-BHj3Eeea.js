function Bn(){function e(Ze,On){if(!Ze)throw new Error(`[dom] Missing #${On}`);return Ze}const t=e(document.getElementById("appRoot"),"appRoot"),o=e(document.getElementById("tabContour"),"tabContour"),n=e(document.getElementById("tabColors"),"tabColors"),a=e(document.getElementById("tabSettings"),"tabSettings"),i=e(document.getElementById("tabLogs"),"tabLogs"),r=e(document.getElementById("tabSegmentation"),"tabSegmentation"),u=e(document.getElementById("tabPipeline"),"tabPipeline"),g=e(document.getElementById("viewContour"),"viewContour"),s=e(document.getElementById("viewColors"),"viewColors"),l=e(document.getElementById("viewSettings"),"viewSettings"),p=e(document.getElementById("viewLogs"),"viewLogs"),h=e(document.getElementById("viewSegmentation"),"viewSegmentation"),d=e(document.getElementById("viewPipeline"),"viewPipeline"),c=e(document.getElementById("dropZone"),"dropZone"),f=e(document.getElementById("fileInput"),"fileInput"),v=e(document.getElementById("btnProcess"),"btnProcess"),m=e(document.getElementById("btnClean"),"btnClean"),y=e(document.getElementById("btnDownload"),"btnDownload"),x=e(document.getElementById("contourStatus"),"contourStatus"),w=e(document.getElementById("contourSpinner"),"contourSpinner"),I=e(document.getElementById("srcCanvas"),"srcCanvas"),b=e(document.getElementById("outCanvas"),"outCanvas"),k=e(document.getElementById("clean1Canvas"),"clean1Canvas"),C=e(document.getElementById("clean2Canvas"),"clean2Canvas"),M=e(document.getElementById("cleanQualityBadge"),"cleanQualityBadge"),E=e(document.getElementById("cleanQualityFill"),"cleanQualityFill"),S=e(document.getElementById("cleanQualityText"),"cleanQualityText"),P=e(document.getElementById("btnVectorize"),"btnVectorize"),L=e(document.getElementById("btnDownloadSvg"),"btnDownloadSvg"),$=e(document.getElementById("svgPreviewImg"),"svgPreviewImg"),R=e(document.getElementById("svgPreviewText"),"svgPreviewText"),D=e(document.getElementById("contourTuningMount"),"contourTuningMount"),T=e(document.getElementById("pipelineStatus"),"pipelineStatus"),N=e(document.getElementById("pipelineTuningMount"),"pipelineTuningMount"),F=e(document.getElementById("pipelineViewMount"),"pipelineViewMount"),A=e(document.getElementById("segPresetList"),"segPresetList"),U=e(document.getElementById("segRecipeDrop"),"segRecipeDrop"),W=e(document.getElementById("segStepResize"),"segStepResize"),O=e(document.getElementById("segStepDenoise"),"segStepDenoise"),Y=e(document.getElementById("segStepColor"),"segStepColor"),ve=e(document.getElementById("segStepThreshold"),"segStepThreshold"),De=e(document.getElementById("segStepMorphology"),"segStepMorphology"),ne=e(document.getElementById("segRunBtn"),"segRunBtn"),ie=e(document.getElementById("segStatus"),"segStatus"),Ft=e(document.getElementById("segMaskCanvas"),"segMaskCanvas"),jt=e(document.getElementById("segNextBtn"),"segNextBtn"),_t=e(document.getElementById("segResetBtn"),"segResetBtn"),Kt=e(document.getElementById("segTuningMount"),"segTuningMount"),qt=e(document.getElementById("colorsCanvas"),"colorsCanvas"),Gt=e(document.getElementById("palette"),"palette"),Wt=e(document.getElementById("btnColorsApply"),"btnColorsApply"),Ht=e(document.getElementById("btnColorsCancel"),"btnColorsCancel"),Qt=e(document.getElementById("btnColorsReset"),"btnColorsReset"),Jt=e(document.getElementById("edgesDark"),"edgesDark"),Yt=e(document.getElementById("edgeMaskThreshold"),"edgeMaskThreshold"),Xt=e(document.getElementById("edgeDilate"),"edgeDilate"),Zt=e(document.getElementById("maxRegionPx"),"maxRegionPx"),en=e(document.getElementById("colorsStatus"),"colorsStatus"),tn=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),nn=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),on=e(document.getElementById("devConfigDetails"),"devConfigDetails"),an=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),sn=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),rn=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),ln=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),cn=e(document.getElementById("logsCbDebug"),"logsCbDebug"),un=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),dn=e(document.getElementById("cfgStatus"),"cfgStatus"),gn=e(document.getElementById("cfgOpenCvSpinner"),"cfgOpenCvSpinner"),pn=e(document.getElementById("cfgOpenCvStatus"),"cfgOpenCvStatus"),fn=e(document.getElementById("cfgOpenCvReport"),"cfgOpenCvReport"),mn=e(document.getElementById("settingsEngineBox"),"settingsEngineBox"),hn=e(document.getElementById("cfgUseOpenCv"),"cfgUseOpenCv"),vn=e(document.getElementById("tuningMount"),"tuningMount"),yn=e(document.getElementById("settingsVersion"),"settingsVersion"),bn=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),wn=e(document.getElementById("logsLimit"),"logsLimit"),En=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),Cn=e(document.getElementById("logsStatus"),"logsStatus"),xn=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),In=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),Sn=e(document.getElementById("btnLogsExport"),"btnLogsExport"),kn=e(document.getElementById("btnLogsClear"),"btnLogsClear"),Mn=e(document.getElementById("logsOut"),"logsOut"),Rn=e(document.getElementById("debugLimit"),"debugLimit"),Dn=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),Pn=e(document.getElementById("btnDebugExport"),"btnDebugExport"),Tn=e(document.getElementById("btnDebugClear"),"btnDebugClear"),An=e(document.getElementById("debugStatus"),"debugStatus"),Ln=e(document.getElementById("debugOut"),"debugOut");return{rootEl:t,tabContour:o,tabColors:n,tabSettings:a,tabLogs:i,tabSegmentation:r,tabPipeline:u,viewContour:g,viewSegmentation:h,viewColors:s,viewSettings:l,viewLogs:p,viewPipeline:d,dropZoneEl:c,fileInputEl:f,btnProcessEl:v,btnCleanEl:m,btnDownloadEl:y,contourStatusEl:x,contourSpinnerEl:w,srcCanvasEl:I,outCanvasEl:b,clean1CanvasEl:k,clean2CanvasEl:C,cleanQualityBadgeEl:M,cleanQualityFillEl:E,cleanQualityTextEl:S,btnVectorizeEl:P,btnDownloadSvgEl:L,svgPreviewImgEl:$,svgPreviewTextEl:R,contourTuningMountEl:D,pipelineStatusEl:T,pipelineTuningMountEl:N,pipelineViewMountEl:F,segPresetListEl:A,segRecipeDropEl:U,segStepResizeEl:W,segStepDenoiseEl:O,segStepColorEl:Y,segStepThresholdEl:ve,segStepMorphologyEl:De,segRunBtn:ne,segStatusEl:ie,segMaskCanvasEl:Ft,segNextBtn:jt,segResetBtn:_t,segTuningMountEl:Kt,colorsCanvasEl:qt,paletteEl:Gt,btnColorsApplyEl:Wt,btnColorsCancelEl:Ht,btnColorsResetEl:Qt,edgesDarkEl:Jt,edgeMaskThresholdEl:Yt,edgeDilateEl:Xt,maxRegionPxEl:Zt,colorsStatusEl:en,cfgShowDevToolsEl:tn,settingsGeneralStatusEl:nn,devConfigDetailsEl:on,cfgTraceConsoleEl:an,cfgActionLogMaxEl:sn,cfgDebugTraceMaxEl:rn,cfgFailureLogsPerRunEl:ln,logsCbDebugEl:cn,btnCfgResetDefaults:un,cfgStatusEl:dn,settingsVersionEl:yn,settingsGitHubLinkEl:bn,cfgOpenCvSpinner:gn,cfgOpenCvStatus:pn,cfgOpenCvReport:fn,settingsEngineBoxEl:mn,cfgUseOpenCvEl:hn,tuningMountEl:vn,logsLimitEl:wn,btnLogsRefresh:En,logsStatusEl:Cn,logsTrimKeepEl:xn,btnLogsTrim:In,btnLogsExport:Sn,btnLogsClear:kn,logsOutEl:Mn,debugLimitEl:Rn,btnDebugRefresh:Dn,btnDebugExport:Pn,btnDebugClear:Tn,debugStatusEl:An,debugOutEl:Ln}}const $n=new Set;function Nn(e){$n.add(e)}function Vn(){const e=new Set;function t(n){return e.add(n),()=>e.delete(n)}function o(){Nn(a=>{for(const i of e)i(a)})}return{on:t,start:o}}const zn=new Set;function Ct(e){for(const t of zn)t(e,"local")}function ge(e){const t=localStorage.getItem(e);if(t!==null)try{return JSON.parse(t)}catch{return t}}function Un(e,t){localStorage.setItem(e,JSON.stringify(t))}async function le(e){if(typeof e=="string")return{[e]:ge(e)};if(Array.isArray(e)){const o={};for(const n of e)o[n]=ge(n);return o}const t={};for(const[o,n]of Object.entries(e))t[o]=localStorage.getItem(o)!==null?ge(o):n;return t}async function ce(e){const t={};for(const[o,n]of Object.entries(e)){const a=ge(o);Un(o,n),t[o]={oldValue:a,newValue:n}}Ct(t)}async function He(e){const t=Array.isArray(e)?e:[e],o={};for(const n of t){const a=ge(n);localStorage.removeItem(n),o[n]={oldValue:a,newValue:void 0}}Ct(o)}function ee(e,t,o,n){const a=Number(String(e??"").trim());return Number.isFinite(a)?Math.max(t,Math.min(o,Math.floor(a))):n}const Fe="beecontour.devConfig",Q={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let je=!1,Ce={...Q};function xt(e){const t=e||{};return{traceConsole:!!t.traceConsole,actionLogMax:ee(t.actionLogMax??Q.actionLogMax,100,5e4,Q.actionLogMax),debugTraceMax:ee(t.debugTraceMax??Q.debugTraceMax,100,5e4,Q.debugTraceMax),failureLogsPerRun:ee(t.failureLogsPerRun??Q.failureLogsPerRun,0,5e4,Q.failureLogsPerRun)}}async function _e(){if(je)return;const e=await le([Fe]).catch(()=>({}));Ce=xt(e==null?void 0:e[Fe]),je=!0}function xe(){return Ce}async function It(e){Ce=xt(e),je=!0,await ce({[Fe]:Ce}).catch(()=>null)}async function Fn(){await It({...Q})}function jn(e,t){const o={segmentation:e.tabSegmentation,pipeline:e.tabPipeline,contour:e.tabContour,colors:e.tabColors,settings:e.tabSettings,logs:e.tabLogs},n={segmentation:e.viewSegmentation,pipeline:e.viewPipeline,contour:e.viewContour,colors:e.viewColors,settings:e.viewSettings,logs:e.viewLogs};let a="contour";const i=new Set;function r(){const d=xe();return!!(d!=null&&d.traceConsole)}function u(){const d=globalThis;d.__bctGlobalErrorHooksInstalled||(d.__bctGlobalErrorHooksInstalled=!0,window.addEventListener("error",c=>{var v;const f=c;console.error("[panel] window error",{message:f.message,filename:f.filename,lineno:f.lineno,colno:f.colno,error:f.error?String(f.error):null,stack:(v=f.error)!=null&&v.stack?String(f.error.stack):null})}),window.addEventListener("unhandledrejection",c=>{var f;console.error("[panel] unhandledrejection",{reason:c.reason?String(c.reason):null,stack:(f=c.reason)!=null&&f.stack?String(c.reason.stack):null})}))}r()&&u();function g(d){Object.keys(o).forEach(c=>{const f=c===d;o[c].classList.toggle("is-active",f),o[c].setAttribute("aria-selected",f?"true":"false"),n[c].hidden=!f,n[c].classList.toggle("is-active",f)})}function s(d){var c,f,v,m,y,x,w,I;if(d===a){(f=(c=t[d]).refresh)==null||f.call(c);return}(m=(v=t[a]).unmount)==null||m.call(v),a=d,g(a),i.has(a)?(I=(w=t[a]).refresh)==null||I.call(w):(i.add(a),(x=(y=t[a]).mount)==null||x.call(y))}function l(){o.contour.addEventListener("click",d=>{var c;(c=d.preventDefault)==null||c.call(d),s("contour")}),o.segmentation.addEventListener("click",d=>{var c;(c=d.preventDefault)==null||c.call(d),s("segmentation")}),o.pipeline.addEventListener("click",d=>{var c;(c=d.preventDefault)==null||c.call(d),s("pipeline")}),o.colors.addEventListener("click",d=>{var c;(c=d.preventDefault)==null||c.call(d),s("colors")}),o.settings.addEventListener("click",d=>{var c;(c=d.preventDefault)==null||c.call(d),s("settings")}),o.logs.addEventListener("click",d=>{var c;(c=d.preventDefault)==null||c.call(d),s("logs")})}function p(){var d,c,f,v;a="contour",g(a),Object.keys(t).forEach(m=>{var y,x;return(x=(y=t[m]).boot)==null?void 0:x.call(y)}),i.has(a)?(v=(f=t[a]).refresh)==null||v.call(f):(i.add(a),(c=(d=t[a]).mount)==null||c.call(d))}function h(){Object.keys(t).forEach(d=>{var c,f;return(f=(c=t[d]).dispose)==null?void 0:f.call(c)})}return{bind:l,boot:p,activate:s,dispose:h}}function et(e){const t=e.items.length;return{items:e.items,counts:{items:t},meta:e.meta}}function _n(){const e={items:[],meta:{}},t=new Set;function o(){const s=et(e);for(const l of t)try{l(s)}catch{}}function n(){return et(e)}function a(s){t.add(s);try{s(n())}catch{}return()=>t.delete(s)}function i(){e.items=[],e.meta={},o()}function r(s){e.meta.scopeUpdatedSince=s,o()}function u(){return String(e.meta.scopeUpdatedSince||"")}function g(s,l){e.items=s.slice(),e.meta.updatedTs=Date.now(),typeof(l==null?void 0:l.limit)=="number"&&(e.meta.limit=l.limit),o()}return{getSnapshot:n,subscribe:a,getScopeUpdatedSince:u,clearAll:i,setScopeUpdatedSince:r,setItems:g}}function Kn(){return{loadedImageName:null,hasImage:!1,hasOutput:!1,edgeMask:void 0,repairedMask:void 0,smoothedMask:void 0,svgText:void 0}}function qn(e){e.loadedImageName=null,e.hasImage=!1,e.hasOutput=!1,e.edgeMask=void 0,e.repairedMask=void 0,e.smoothedMask=void 0,e.svgText=void 0}function St(e,t,o){const n=new Uint8Array(e.length);function a(v,m){return m*t+v}function i(v,m){return v<0||m<0||v>=t||m>=o?!1:e[a(v,m)]===1}let r=0,u=0,g=0,s=0,l=0;const p=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];for(let v=0;v<o;v++)for(let m=0;m<t;m++){if(!i(m,v))continue;r++;let y=0,x=!1;for(const[w,I]of p)i(m+w,v+I)?y++:x=!0;x&&u++,y===1?g++:y>=3&&s++}const h=[[-1,0],[1,0],[0,-1],[0,1]],d=new Int32Array(e.length),c=new Int32Array(e.length);for(let v=0;v<o;v++)for(let m=0;m<t;m++){const y=a(m,v);if(e[y]===0||n[y]===1)continue;l++,n[y]=1;let x=0,w=0;for(d[w]=m,c[w]=v,w++;x<w;){const I=d[x],b=c[x];x++;for(const[k,C]of h){const M=I+k,E=b+C;if(M<0||E<0||M>=t||E>=o)continue;const S=a(M,E);e[S]===0||n[S]===1||(n[S]=1,d[w]=M,c[w]=E,w++)}}}const f=r/Math.max(1,u);return{onPixels:r,boundaryPixels:u,components:l,endpoints:g,junctions:s,thicknessRatio:f}}function Gn(e,t){function o(d){e.contourStatusEl.textContent=d}function n(d,c){e.contourSpinnerEl.classList.toggle("is-hidden",!d),c&&o(c)}function a(){e.btnProcessEl.disabled=!t.hasImage,e.btnDownloadEl.disabled=!t.hasOutput,e.btnCleanEl.disabled=!t.hasOutput,e.btnVectorizeEl.disabled=!t.smoothedMask,e.btnDownloadSvgEl.disabled=!t.svgText}function i(){t.svgText=void 0,e.svgPreviewTextEl.textContent="",e.svgPreviewImgEl.removeAttribute("src")}function r(){const d=e.srcCanvasEl.getContext("2d"),c=e.outCanvasEl.getContext("2d");d.clearRect(0,0,e.srcCanvasEl.width,e.srcCanvasEl.height),c.clearRect(0,0,e.outCanvasEl.width,e.outCanvasEl.height);const f=e.clean1CanvasEl.getContext("2d"),v=e.clean2CanvasEl.getContext("2d");f.clearRect(0,0,e.clean1CanvasEl.width,e.clean1CanvasEl.height),v.clearRect(0,0,e.clean2CanvasEl.width,e.clean2CanvasEl.height)}function u(){const d=e.clean1CanvasEl.getContext("2d"),c=e.clean2CanvasEl.getContext("2d");d.clearRect(0,0,e.clean1CanvasEl.width,e.clean1CanvasEl.height),c.clearRect(0,0,e.clean2CanvasEl.width,e.clean2CanvasEl.height)}function g(d,c){const f=Number(d.value);return Number.isFinite(f)?f:c}function s(d,c){const f=c instanceof Error?c.message:String(c);o(`${d} failed: ${f}`),n(!1),console.error(`[BeeContour] ${d} failed`,c)}function l(d,c){if(!t.smoothedMask){e.cleanQualityBadgeEl.textContent="—",e.cleanQualityBadgeEl.className="qBadge qBadge--off",e.cleanQualityFillEl.style.width="0%",e.cleanQualityTextEl.textContent="";return}const f=St(t.smoothedMask,d,c),v=(M,E)=>Math.max(0,Math.min(1,M/Math.max(1,E))),m=v(f.components,800),y=v(f.endpoints,3e3),x=v(f.junctions,1500),w=f.thicknessRatio>5?1:f.thicknessRatio>3?.5:0,I=Math.round(100*(1-(.45*m+.45*y+.1*x)-.1*w)),b=Math.max(0,Math.min(100,I));let k="qBadge qBadge--bad",C=`Bad ${b}`;b>=70?(k="qBadge qBadge--ok",C=`Good ${b}`):b>=45&&(k="qBadge qBadge--warn",C=`OK ${b}`),e.cleanQualityBadgeEl.className=k,e.cleanQualityBadgeEl.textContent=C,e.cleanQualityFillEl.style.width=`${b}%`,e.cleanQualityTextEl.textContent=`CC:${f.components} end:${f.endpoints} j:${f.junctions} thick:${f.thicknessRatio.toFixed(2)}`}function p(){if(!t.hasOutput)return;const c=`${(t.loadedImageName||"beecontour").replace(/\.[a-z0-9]+$/i,"").replace(/[^a-z0-9-_]+/gi,"_")}_contour.png`,f=e.outCanvasEl.toDataURL("image/png"),v=document.createElement("a");v.href=f,v.download=c,document.body.appendChild(v),v.click(),v.remove(),o(`Downloaded: ${c}`)}function h(){if(!t.svgText)return;const c=`${(t.loadedImageName||"beecontour").replace(/\.[a-z0-9]+$/i,"").replace(/[^a-z0-9-_]+/gi,"_")}_contour.svg`,f=new Blob([t.svgText],{type:"image/svg+xml;charset=utf-8"}),v=URL.createObjectURL(f),m=document.createElement("a");m.href=v,m.download=c,document.body.appendChild(m),m.click(),m.remove(),URL.revokeObjectURL(v),o(`Downloaded: ${c}`)}return{setStatus:o,setContourBusyVisual:n,updateEnabled:a,clearSvgPreview:i,clearCanvases:r,clearCleanCanvasesOnly:u,getNumber:g,showError:s,updateCleanQualityUI:l,downloadPng:p,downloadSvg:h}}const pe="beecontour.debugTrace",Ke="beecontour.debugTrace.enabled",Wn=2e3;function Hn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function qe(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}async function Ie(){const e=await le(pe),t=e==null?void 0:e[pe];return Array.isArray(t)?t:[]}async function Qn(e){await ce({[pe]:e})}async function Qe(){const e=await le(Ke);return!!(e!=null&&e[Ke])}async function kt(e){await ce({[Ke]:!!e}),e||await He(pe)}async function Mt(){await He(pe)}async function fe(e,t){if(!await Qe())return{total:0};const n=qe((t==null?void 0:t.max)??Wn,100,5e4),a=(Array.isArray(e)?e:[e]).map(g=>({...g,id:Hn(),ts:Date.now()}));if(!a.length)return{total:(await Ie()).length};const r=(await Ie()).concat(a),u=r.length>n?r.slice(r.length-n):r;return await Qn(u),{total:u.length}}async function Rt(e){const t=qe((e==null?void 0:e.limit)??200,1,5e4),o=qe((e==null?void 0:e.offset)??0,0,1e6),n=(e==null?void 0:e.reverse)??!0,a=await Ie(),i=a.length,u=(n?a.slice().reverse():a).slice(o,o+t);return{total:i,items:u}}async function Dt(e){const t=await Ie();return JSON.stringify(t,null,e!=null&&e.pretty?2:0)}const Pt=Object.freeze(Object.defineProperty({__proto__:null,append:fe,clear:Mt,exportJson:Dt,isEnabled:Qe,list:Rt,setEnabled:kt},Symbol.toStringTag,{value:"Module"}));function Pe(e){return`[BCT][${e}]`}function Jn(e){function t(...i){e.traceOn()&&console.log(Pe("trace"),...i)}function o(...i){console.warn(Pe("warn"),...i)}function n(...i){console.error(Pe("error"),...i)}function a(i,r){t(i,r),fe({scope:e.scope,kind:"debug",message:i,meta:r})}return{logTrace:t,logWarn:o,logError:n,traceScope:a}}const{logTrace:V,logWarn:J,logError:K,traceScope:G}=Jn({scope:"panel",traceOn:()=>!!xe().traceConsole});let q=0;function H(){return q>0}function X(e,t){if(t){Tt(e);return}q=0,Se(e,!1)}async function ue(e,t){const o=`${Date.now()}-${Math.random().toString(16).slice(2)}`;V("[state] withBusy: enter",{id:o,busyCount:q}),Tt(e,o);try{V("[state] withBusy: before await fn",{id:o,busyCount:q});const n=await t();return V("[state] withBusy: after await fn (resolved)",{id:o,busyCount:q}),n}catch(n){throw K("[state] withBusy: fn threw",{id:o,busyCount:q,msg:String((n==null?void 0:n.message)??n),stack:String((n==null?void 0:n.stack)??"")}),n}finally{V("[state] withBusy: finally before endBusy",{id:o,busyCount:q}),Yn(e,o),V("[state] withBusy: finally after endBusy",{id:o,busyCount:q})}}function Tt(e,t){q++,V("[state] beginBusy",{id:t,busyCount:q}),q===1&&Se(e,!0)}function Yn(e,t){if(q--,V("[state] endBusy: dec",{id:t,busyCount:q}),q<=0){q=0,V("[state] endBusy: applying busy=false",{id:t,busyCount:q}),Se(e,!1);return}q===0&&(V("[state] endBusy: applying busy=false (redundant branch)",{id:t,busyCount:q}),Se(e,!1))}function Se(e,t){e.rootEl.classList.toggle("is-busy",t),e.cfgShowDevToolsEl.disabled=!1,e.fileInputEl.disabled=t,e.btnProcessEl.disabled=t,e.btnCleanEl.disabled=t,e.btnDownloadEl.disabled=t,e.btnVectorizeEl.disabled=t,e.btnDownloadSvgEl.disabled=t,e.cfgTraceConsoleEl.disabled=t,e.cfgActionLogMaxEl.disabled=t,e.cfgDebugTraceMaxEl.disabled=t,e.cfgFailureLogsPerRunEl.disabled=t,e.btnCfgResetDefaults.disabled=t,e.logsCbDebugEl.disabled=t,e.cfgUseOpenCvEl.disabled=t,e.logsLimitEl.disabled=t,e.btnLogsRefresh.disabled=t,e.logsTrimKeepEl.disabled=t,e.btnLogsTrim.disabled=t,e.btnLogsExport.disabled=t,e.btnLogsClear.disabled=t,e.debugLimitEl.disabled=t,e.btnDebugRefresh.disabled=t,e.btnDebugExport.disabled=t,e.btnDebugClear.disabled=t,e.btnColorsApplyEl.disabled=t,e.btnColorsCancelEl.disabled=t,e.btnColorsResetEl.disabled=t,e.edgesDarkEl.disabled=t,e.edgeMaskThresholdEl.disabled=t,e.edgeDilateEl.disabled=t,e.maxRegionPxEl.disabled=t;for(const o of Array.from(e.paletteEl.querySelectorAll("button")))o.disabled=t;e.colorsCanvasEl.style.pointerEvents=t?"none":"auto"}function _(e,t,o,n,a,i,r){return{id:e,title:t,implementedEngines:o,defaultEnginePolicy:n,params:a,children:i,description:r}}function Xn(e){const t=new Map,o=new Map;function n(a,i){if(t.has(a.id))throw new Error(`[tuning] Duplicate component id: ${a.id}`);t.set(a.id,a),o.set(a.id,i);for(const r of a.children??[])n(r,a.id)}return n(e,null),{root:e,byId:t,parentById:o}}function Je(){const e=_("app","BeeContour",["native","opencv"],"native",{},[_("contour","Contour",["native","opencv"],"auto",{},[_("contour.process","Process",["native"],"auto",{contourScale:{kind:"number",label:"Processing scale",min:25,max:100,step:5,default:100},edgeThreshold:{kind:"number",label:"Edge threshold",min:1,max:255,step:1,default:70},invertOutput:{kind:"boolean",label:"White background",default:!0}}),_("contour.clean","Clean & Smooth",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:500,step:1,default:12},cleanRadius:{kind:"number",label:"Repair strength",min:1,max:3,step:1,default:1},cleanBinaryThreshold:{kind:"number",label:"Binary threshold",min:1,max:254,step:1,default:128}},[_("contour.clean.threshold","Threshold",["native"],"auto",{}),_("contour.clean.removeSmallComponents","Remove small components",["native","opencv"],"auto",{}),_("contour.clean.repair","Repair gaps",["native"],"auto",{}),_("contour.clean.smooth","Smooth mask",["native"],"auto",{}),_("contour.clean.quality","Quality metrics",["native"],"auto",{})]),_("contour.vectorize","Vectorize (SVG)",["native"],"native",{pathSmoothIters:{kind:"number",label:"Path smoothing",min:0,max:4,step:1,default:2}})]),_("colors","Colors",["native"],"auto",{},[_("colors.fill","Region fill",["native"],"auto",{edgesDark:{kind:"boolean",label:"Edges are dark",default:!0},edgeMaskThreshold:{kind:"number",label:"Edge threshold",min:0,max:255,step:1,default:80},edgeDilate:{kind:"number",label:"Gap close (px)",min:0,max:6,step:1,default:2},maxRegionPx:{kind:"number",label:"Max region (px)",min:1e3,step:1e3,default:2e5}})]),_("segmentation","Segmentation",["native","opencv"],"auto",{},[_("segmentation.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),_("segmentation.denoise","Denoise",["native","opencv"],"auto",{denoiseAlgo:{kind:"number",label:"Denoise algo",min:0,max:2,step:1,default:1},blurK:{kind:"number",label:"Blur kernel",min:1,max:21,step:2,default:3},bilateralSigma:{kind:"number",label:"Bilateral sigma",min:1,max:150,step:1,default:35}},void 0,"Reduce noise before thresholding."),_("segmentation.color","Color / Gray",["native","opencv"],"auto",{colorMode:{kind:"number",label:"Color mode",min:0,max:3,step:1,default:1},hsvChannel:{kind:"number",label:"HSV channel",min:0,max:2,step:1,default:2}},void 0,"Select color space / channel features for thresholding."),_("segmentation.threshold","Threshold",["native","opencv"],"auto",{thresholdAlgo:{kind:"number",label:"Threshold algo",min:0,max:3,step:1,default:1},manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128},adaptBlock:{kind:"number",label:"Adaptive block",min:3,max:101,step:2,default:31},adaptC:{kind:"number",label:"Adaptive C",min:-50,max:50,step:1,default:3}},void 0,"Convert features into a binary mask."),_("segmentation.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:5},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Remove specks, fill holes, and stabilize regions.")],"Fixed-order segmentation pipeline. Presets configure each step."),_("pipeline","Pipeline (UI)",["native","opencv"],"auto",{mode:{kind:"text",label:"Pipeline",default:"segmentation"},recipe:{kind:"text",label:"Recipe",default:"default"}},void 0,"UI state for the Pipeline tab (selected pipeline + recipe).")]);return Xn(e)}function Zn(e){return e.default}function eo(e,t){const o={};for(const[n,a]of Object.entries(e))o[n]=Zn(a);for(const[n,a]of Object.entries(t??{}))o[n]=a;return o}function to(e,t,o){var a;let n=e;for(;n;){const i=t.byId.get(n);if(!i)throw new Error(`[tuning] Unknown component: ${n}`);const u=((a=o[n])==null?void 0:a.enginePolicy)??i.defaultEnginePolicy;if(u!=="inherit")return u;n=t.parentById.get(n)??null}return"native"}function no(e,t,o){const n=o.opencvReady&&e.includes("opencv");return e.includes("native")||e.length,t==="native"?{engine:"native"}:t==="opencv"?n?{engine:"opencv"}:{engine:"native",fallbackReason:o.opencvReady?"Policy=opencv, but component has no OpenCV implementation.":"Policy=opencv, but OpenCV is not available at runtime."}:t==="auto"?n?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}function At(e,t,o,n){var s;const a=t.byId.get(e);if(!a)throw new Error(`[tuning] Unknown component: ${e}`);const i=to(e,t,o),{engine:r,fallbackReason:u}=no(a.implementedEngines,i,n),g=eo(a.params,(s=o[e])==null?void 0:s.params);return{id:e,policy:i,engine:r,fallbackReason:u,params:g}}const Ge="beecontour.tuning.components.v1";async function me(){const e=await le([Ge]).catch(()=>({})),t=e==null?void 0:e[Ge];return!t||typeof t!="object"?{}:t}async function Lt(e){await ce({[Ge]:e}).catch(()=>null)}async function Te(e,t){const o=await me(),n=o[e]??{};o[e]={enginePolicy:t.enginePolicy??n.enginePolicy,params:{...n.params??{},...t.params??{}}},await Lt(o)}async function tt(e){const t=await me();delete t[e],await Lt(t)}const Ye={native:{available:!0},opencv:{available:!1,reason:"OpenCV not loaded"}};function oo(e){Ye[e]={available:!0}}function ao(e,t){Ye[e]={available:!1,reason:t}}function oe(){return Ye.opencv.available===!0}function io(){return{opencvReady:oe()}}function so(e){return Array.isArray(e.children)&&e.children.length>0}function Ot(e){const{id:t,registry:o,stored:n,runtime:a}=e,i=o.byId.get(t);if(!i)throw new Error(`[tuning] Unknown component: ${t}`);const r=At(t,o,n,a),u=n[t],g=u==null?void 0:u.enginePolicy,s=u==null?void 0:u.params,l=i.implementedEngines.includes("opencv"),p=!!a.opencvReady,h=[];for(const d of i.children??[])h.push(Ot({id:d.id,registry:o,stored:n,runtime:a}));return{id:i.id,title:i.title,description:i.description,isGroup:so(i),implementedEngines:i.implementedEngines,storedPolicy:g,storedParams:s,effectivePolicy:r.policy,effectiveEngine:r.engine,fallbackReason:r.fallbackReason,paramsSchema:i.params,effectiveParams:r.params,canImplementOpenCv:l,runtimeOpenCvReady:p,children:h}}function Xe(e={}){const t=e.registry??Je(),o=e.getRuntimeAvailability??io;async function n(g="app"){const s=await me(),l=o();if(!t.byId.get(g))throw new Error(`[tuning] Unknown scope: ${g}`);const h=Ot({id:g,registry:t,stored:s,runtime:l});return{scopeId:g,runtime:l,stored:s,root:h}}async function a(g,s){await Te(g,{enginePolicy:s})}async function i(g,s,l){await Te(g,{params:{[s]:l}})}async function r(g){await tt(g)}async function u(g,s){const p=(await me())[g];if(!(p!=null&&p.params))return;const h={...p.params??{}};delete h[s];const d=typeof p.enginePolicy=="string",c=Object.keys(h).length>0;if(!d&&!c){await tt(g);return}await Te(g,{enginePolicy:p.enginePolicy,params:h})}return{getRegistry:()=>t,loadTree:n,setEnginePolicy:a,setParam:i,resetNode:r,resetParam:u}}function ro(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}function lo(e,t){if(e.kind==="number"){const o=Number(t),n=e.default,a=Number.isFinite(o)?o:n,i=typeof e.min=="number"?e.min:a,r=typeof e.max=="number"?e.max:a;return ro(a,i,r)}return e.kind==="boolean"?!!t:String(t??e.default)}function se(e,t,o,n){const a=e.byId.get(t);if(!a)throw new Error(`[tuningParams] unknown node: ${t}`);const i=a.params[o];if(!i)throw new Error(`[tuningParams] unknown param: ${t}.${o}`);return lo(i,n)}function Ee(e,t){if((e==null?void 0:e.id)===t)return e;for(const o of(e==null?void 0:e.children)??[]){const n=Ee(o,t);if(n)return n}return null}async function Re(){const e=Xe(),t=Je(),o=await e.loadTree("app"),n=Ee(o.root,"contour.process"),a=Ee(o.root,"contour.clean"),i=Ee(o.root,"contour.vectorize");if(!n||!a||!i)throw new Error("[contour] tuning nodes missing (registry mismatch)");const r=se(t,"contour.process","contourScale",n.effectiveParams.contourScale),u=se(t,"contour.process","edgeThreshold",n.effectiveParams.edgeThreshold),g=se(t,"contour.process","invertOutput",n.effectiveParams.invertOutput),s=se(t,"contour.clean","cleanMinArea",a.effectiveParams.cleanMinArea),l=se(t,"contour.clean","cleanRadius",a.effectiveParams.cleanRadius),p=se(t,"contour.clean","cleanBinaryThreshold",a.effectiveParams.cleanBinaryThreshold),h=se(t,"contour.vectorize","pathSmoothIters",i.effectiveParams.pathSmoothIters);return{contourScale:r,edgeThreshold:u,invertOutput:g,cleanMinArea:s,cleanRadius:l,cleanBinaryThreshold:p,pathSmoothIters:h}}async function nt(e,t,o,n){const{setStatus:a,setContourBusyVisual:i,clearCanvases:r,clearCleanCanvasesOnly:u,clearSvgPreview:g,updateEnabled:s,getNumber:l}=n;if(!o.type.startsWith("image/")){a("Unsupported file type (please drop an image)."),J("Contour load: rejected non-image file",{name:o.name,type:o.type,size:o.size}),G("Contour load: rejected non-image file",{name:o.name,type:o.type,size:o.size});return}const p=performance.now();await ue(e,async()=>{i(!0,"Loading image…"),t.loadedImageName=o.name||"image";const h=URL.createObjectURL(o);G("Contour load: start",{name:o.name,type:o.type,size:o.size});try{const d=await new Promise((k,C)=>{const M=new Image;M.onload=()=>k(M),M.onerror=()=>C(new Error("Failed to load image")),M.src=h}),c=e.srcCanvasEl,f=c.getContext("2d");if(!f){K("Contour load: missing 2D context",{canvasId:"srcCanvasEl"}),a("Load failed — canvas context not available.");return}r();const m=(await Re()).contourScale,y=m/100;let x=Math.max(64,Math.floor(d.naturalWidth*y)),w=Math.max(64,Math.floor(d.naturalHeight*y));const I=1600,b=Math.min(1,I/Math.max(x,w));x=Math.max(64,Math.floor(x*b)),w=Math.max(64,Math.floor(w*b)),c.width=x,c.height=w,f.imageSmoothingEnabled=!0,f.clearRect(0,0,c.width,c.height),f.drawImage(d,0,0,c.width,c.height),t.hasImage=!0,t.hasOutput=!1,t.edgeMask=void 0,t.repairedMask=void 0,t.smoothedMask=void 0,t.svgText=void 0,g(),u(),s(),a(`Loaded: ${t.loadedImageName} (${c.width}×${c.height})`),G("Contour load: done",{naturalW:d.naturalWidth,naturalH:d.naturalHeight,scalePct:m,maxSide:I,targetW:x,targetH:w,pixels:x*w,ms:Math.round((performance.now()-p)*10)/10})}catch(d){K("Contour load: exception",{error:d instanceof Error?d.message:String(d)}),a("Load failed — see console / debug trace.")}finally{URL.revokeObjectURL(h),i(!1)}})}async function co(e,t,o){const{setStatus:n,setContourBusyVisual:a,clearCleanCanvasesOnly:i,clearSvgPreview:r,updateEnabled:u}=o;if(!t.hasImage){J("Contour process: skipped (no image loaded)");return}const g=performance.now();await ue(e,async()=>{a(!0,"Processing…"),await new Promise(s=>{setTimeout(()=>{(async()=>{try{const l=e.srcCanvasEl,p=e.outCanvasEl,h=l.width,d=l.height,c=h*d,f=await Re(),v=f.edgeThreshold,m=f.invertOutput;G("Contour process: start",{width:h,height:d,pixels:c,threshold:v,whiteBg:m}),p.width=h,p.height=d;const y=p.getContext("2d",{willReadFrequently:!0}),x=l.getContext("2d",{willReadFrequently:!0});if(!x||!y){K("Contour process: missing 2D context",{hasSrc:!!x,hasOut:!!y}),n("Process failed — canvas context not available.");return}const I=x.getImageData(0,0,h,d).data,b=new Uint8ClampedArray(h*d);for(let L=0,$=0;L<I.length;L+=4,$++){const R=I[L],D=I[L+1],T=I[L+2];b[$]=.299*R+.587*D+.114*T|0}const k=[-1,0,1,-2,0,2,-1,0,1],C=[-1,-2,-1,0,0,0,1,2,1],M=new Uint8ClampedArray(h*d);for(let L=1;L<d-1;L++)for(let $=1;$<h-1;$++){let R=0,D=0,T=0;for(let F=-1;F<=1;F++)for(let A=-1;A<=1;A++){const U=b[(L+F)*h+($+A)];R+=U*k[T],D+=U*C[T],T++}const N=Math.min(255,Math.sqrt(R*R+D*D)|0);M[L*h+$]=N>=v?255:0}const E=y.createImageData(h,d),S=E.data;let P=0;for(let L=0,$=0;L<M.length;L++,$+=4){const R=M[L];if(R===255&&P++,m){const T=R===255?0:255;S[$]=T,S[$+1]=T,S[$+2]=T,S[$+3]=255}else S[$]=R,S[$+1]=R,S[$+2]=R,S[$+3]=255}y.putImageData(E,0,0),t.hasOutput=!0,t.edgeMask=void 0,t.repairedMask=void 0,t.smoothedMask=void 0,r(),i(),n("Done. You can clean/smooth or download the PNG."),G("Contour process: done",{width:h,height:d,pixels:c,threshold:v,whiteBg:m,edgePixels:P,edgeRatio:Math.round(P/Math.max(1,c)*1e6)/1e6,ms:Math.round((performance.now()-g)*10)/10})}catch(l){K("Contour process: exception",{error:l instanceof Error?l.message:String(l)}),n("Process failed — see console / debug trace.")}finally{s()}})()},0)}),a(!1),u()})}function We(e,t,o,n){const a=new ImageData(t,o),i=a.data;for(let r=0,u=0;r<e.length;r++,u+=4){const g=e[r]===1;if(n){const s=g?0:255;i[u]=s,i[u+1]=s,i[u+2]=s,i[u+3]=255}else{const s=g?255:0;i[u]=s,i[u+1]=s,i[u+2]=s,i[u+3]=255}}return a}function Ae(e,t,o,n){const a=new Uint8Array(e.length),i=Math.max(1,n);for(let r=0;r<o;r++)for(let u=0;u<t;u++){let g=0;for(let s=-i;s<=i&&!g;s++){const l=r+s;if(l<0||l>=o)continue;const p=l*t;for(let h=-i;h<=i;h++){const d=u+h;if(!(d<0||d>=t)&&e[p+d]===1){g=1;break}}}a[r*t+u]=g}return a}function Le(e,t,o,n){const a=new Uint8Array(e.length),i=Math.max(1,n);for(let r=0;r<o;r++)for(let u=0;u<t;u++){let g=1;for(let s=-i;s<=i&&g;s++){const l=r+s;if(l<0||l>=o){g=0;break}const p=l*t;for(let h=-i;h<=i;h++){const d=u+h;if(d<0||d>=t){g=0;break}if(e[p+d]===0){g=0;break}}}a[r*t+u]=g}return a}function Bt(e,t,o,n){const a=new Uint8Array(e),i=new Uint8Array(e.length),r=new Int32Array(e.length),u=new Int32Array(e.length);for(let g=0;g<o;g++)for(let s=0;s<t;s++){const l=g*t+s;if(e[l]===0||i[l]===1)continue;let p=0,h=0;i[l]=1,r[h]=s,u[h]=g,h++;const d=[l];for(;p<h;){const c=r[p],f=u[p];p++;const v=[[c-1,f],[c+1,f],[c,f-1],[c,f+1]];for(const[m,y]of v){if(m<0||m>=t||y<0||y>=o)continue;const x=y*t+m;e[x]===0||i[x]===1||(i[x]=1,r[h]=m,u[h]=y,h++,d.push(x))}}if(d.length<n)for(const c of d)a[c]=0}return a}const uo=Je();function go(){return{opencvReady:oe()}}async function po(e){const t=await me(),o=go(),n=At(e,uo,t,o);if(e==="contour.clean.removeSmallComponents"){const a=Number(n.params.cleanMinArea??12);return{engine:n.engine,params:{cleanMinArea:a},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.resize"){const a=Number(n.params.resizeAlgo??1),i=Number(n.params.targetMaxW??900);return{engine:n.engine,params:{resizeAlgo:a,targetMaxW:i},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.denoise"){const a=Number(n.params.denoiseAlgo??1),i=Number(n.params.blurK??5),r=Number(n.params.bilateralSigma??35);return{engine:n.engine,params:{denoiseAlgo:a,blurK:i,bilateralSigma:r},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.color"){const a=Number(n.params.colorMode??1),i=Number(n.params.hsvChannel??2);return{engine:n.engine,params:{colorMode:a,hsvChannel:i},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.threshold"){const a=Number(n.params.thresholdAlgo??1),i=Number(n.params.manualT??128),r=Number(n.params.adaptBlock??21),u=Number(n.params.adaptC??2);return{engine:n.engine,params:{thresholdAlgo:a,manualT:i,adaptBlock:r,adaptC:u},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.morphology"){const a=Number(n.params.morphAlgo??2),i=Number(n.params.morphK??7),r=Number(n.params.morphIters??1);return{engine:n.engine,params:{morphAlgo:a,morphK:i,morphIters:r},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}throw new Error(`[opsDispatch] Unknown op: ${e}`)}async function fo(e,t,o){const{engine:n,params:a,fallbackReason:i,opencvReady:r}=await po(e);return n==="opencv"&&!r?(J(`OpenCV selected for ${e} but not ready; falling back to native. ${i??""}`.trim()),await o[e].native(t,a)):await o[e][n](t,a)}function mo(){const e=globalThis;return e!=null&&e.cv&&typeof e.cv.Mat=="function"?e.cv:null}function ho(e,t){const{width:o,height:n}=e,a=Math.max(0,Math.floor(Number(t.cleanMinArea??0)));if(G("oopenCV RemoveSmallComponents: params",{width:o,height:n,minArea:a}),a<=1)return e.mask;const i=mo();if(!i)return Bt(e.mask,o,n,a);const r=new i.Mat(n,o,i.CV_8UC1);try{const u=r.data,g=e.mask;for(let h=0;h<g.length;h++)u[h]=g[h]?255:0;const s=new i.Mat,l=new i.Mat,p=new i.Mat;try{const h=i.connectedComponentsWithStats(r,s,l,p,8,i.CV_32S),d=i.CC_STAT_AREA??4,c=new Array(h).fill(!1);for(let m=1;m<h;m++)l.intAt(m,d)<a&&(c[m]=!0);const f=new Uint8Array(o*n),v=s.data32S;for(let m=0;m<f.length;m++){const y=v[m];f[m]=y>0&&!c[y]?1:0}return f}finally{s.delete(),l.delete(),p.delete()}}finally{r.delete()}}function ot(e,t,o,n){const a=Math.max(0,Math.min(255,Math.floor(Number(n.manualT??128)))),i=new Uint8Array(t*o),r=e.data;for(let u=0,g=0;u<i.length;u++,g+=4){const s=r[g],l=r[g+1],p=r[g+2],h=s*77+l*150+p*29>>8;i[u]=h>=a?1:0}return i}function at(e,t,o,n){const a=Math.max(1,Math.floor(Number(n.targetMaxW??t)));if(!t||!o||t<=a)return e;const i=a/t,r=Math.max(1,Math.floor(t*i)),u=Math.max(1,Math.floor(o*i));return Math.floor(Number(n.resizeAlgo??1))===0?vo(e,t,o,r,u):yo(e,t,o,r,u)}function vo(e,t,o,n,a){const i=e.data,r=new Uint8ClampedArray(n*a*4),u=t/n,g=o/a;for(let s=0;s<a;s++){const l=Math.min(o-1,Math.max(0,Math.floor((s+.5)*g-.5)));for(let p=0;p<n;p++){const h=Math.min(t-1,Math.max(0,Math.floor((p+.5)*u-.5))),d=(l*t+h)*4,c=(s*n+p)*4;r[c]=i[d],r[c+1]=i[d+1],r[c+2]=i[d+2],r[c+3]=i[d+3]}}return new ImageData(r,n,a)}function yo(e,t,o,n,a){const i=e.data,r=new Uint8ClampedArray(n*a*4),u=t/n,g=o/a;for(let s=0;s<a;s++){const l=(s+.5)*g-.5,p=ye(Math.floor(l),0,o-1),h=ye(p+1,0,o-1),d=l-p;for(let c=0;c<n;c++){const f=(c+.5)*u-.5,v=ye(Math.floor(f),0,t-1),m=ye(v+1,0,t-1),y=f-v,x=(p*t+v)*4,w=(p*t+m)*4,I=(h*t+v)*4,b=(h*t+m)*4,k=(s*n+c)*4;for(let C=0;C<4;C++){const M=i[x+C],E=i[w+C],S=i[I+C],P=i[b+C],L=M+(E-M)*y,$=S+(P-S)*y,R=L+($-L)*d;r[k+C]=bo(R)}}}return new ImageData(r,n,a)}function ye(e,t,o){return e<t?t:e>o?o:e}function bo(e){return e<=0?0:e>=255?255:e|0}function it(e,t,o,n){if(!t||!o)return e;const a=Math.floor(Number(n.denoiseAlgo??1));if(a<=0)return e;const i=Math.floor(Number(n.blurK??3)),r=wo(i);return a===2&&r<=3?Co(e,t,o):r<=1?e:Eo(e,t,o,r)}function wo(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:3}function Eo(e,t,o,n){const a=n-1>>1,i=e.data,r=new Uint8ClampedArray(t*o*4);for(let g=0;g<o;g++){let s=0,l=0,p=0,h=0;for(let d=-a;d<=a;d++){const c=ae(d,0,t-1),f=(g*t+c)*4;s+=i[f],l+=i[f+1],p+=i[f+2],h+=i[f+3]}for(let d=0;d<t;d++){const c=(g*t+d)*4;r[c]=s/n|0,r[c+1]=l/n|0,r[c+2]=p/n|0,r[c+3]=h/n|0;const f=ae(d-a,0,t-1),v=ae(d+a+1,0,t-1),m=(g*t+f)*4,y=(g*t+v)*4;s+=i[y]-i[m],l+=i[y+1]-i[m+1],p+=i[y+2]-i[m+2],h+=i[y+3]-i[m+3]}}const u=new Uint8ClampedArray(t*o*4);for(let g=0;g<t;g++){let s=0,l=0,p=0,h=0;for(let d=-a;d<=a;d++){const f=(ae(d,0,o-1)*t+g)*4;s+=r[f],l+=r[f+1],p+=r[f+2],h+=r[f+3]}for(let d=0;d<o;d++){const c=(d*t+g)*4;u[c]=s/n|0,u[c+1]=l/n|0,u[c+2]=p/n|0,u[c+3]=h/n|0;const f=ae(d-a,0,o-1),v=ae(d+a+1,0,o-1),m=(f*t+g)*4,y=(v*t+g)*4;s+=r[y]-r[m],l+=r[y+1]-r[m+1],p+=r[y+2]-r[m+2],h+=r[y+3]-r[m+3]}}return new ImageData(u,t,o)}function Co(e,t,o){const n=e.data,a=new Uint8ClampedArray(t*o*4),i=new Array(9),r=new Array(9),u=new Array(9),g=new Array(9);for(let s=0;s<o;s++)for(let l=0;l<t;l++){let p=0;for(let d=-1;d<=1;d++){const c=ae(s+d,0,o-1);for(let f=-1;f<=1;f++){const v=ae(l+f,0,t-1),m=(c*t+v)*4;i[p]=n[m],r[p]=n[m+1],u[p]=n[m+2],g[p]=n[m+3],p++}}i.sort(be),r.sort(be),u.sort(be),g.sort(be);const h=(s*t+l)*4;a[h]=i[4]|0,a[h+1]=r[4]|0,a[h+2]=u[4]|0,a[h+3]=g[4]|0}return new ImageData(a,t,o)}function be(e,t){return e-t}function ae(e,t,o){return e<t?t:e>o?o:e}function st(e,t,o,n){if(!t||!o)return e;const a=Math.floor(Number(n.colorMode??1));if(a===0)return e;const i=e.data,r=new Uint8ClampedArray(t*o*4),u=Io(Math.floor(Number(n.hsvChannel??2)),0,2);for(let g=0,s=0;g<t*o;g++,s+=4){const l=i[s],p=i[s+1],h=i[s+2],d=i[s+3];let c=0;if(a===1)c=l*77+p*150+h*29>>8;else if(a===2){const f=xo(l,p,h),v=u===0?f.h:u===1?f.s:f.v;c=So(v*255)}else c=255-(l*77+p*150+h*29>>8);r[s]=c,r[s+1]=c,r[s+2]=c,r[s+3]=d}return new ImageData(r,t,o)}function xo(e,t,o){const n=e/255,a=t/255,i=o/255,r=Math.max(n,a,i),u=Math.min(n,a,i),g=r-u;let s=0;g!==0&&(r===n?s=(a-i)/g%6:r===a?s=(i-n)/g+2:s=(n-a)/g+4,s/=6,s<0&&(s+=1));const l=r===0?0:g/r;return{h:s,s:l,v:r}}function Io(e,t,o){return e<t?t:e>o?o:e}function So(e){return e<=0?0:e>=255?255:e|0}function rt(e,t,o,n){if(!t||!o)return e;const a=Math.floor(Number(n.morphAlgo??2)),i=Mo(Math.floor(Number(n.morphIters??1)),1,20),r=Math.floor(Number(n.morphK??5)),u=ko(r),g=u-1>>1;if(a<=0||u<=1)return e;let s=e,l=new Uint8Array(t*o);for(let p=0;p<i;p++){if(a===1){ct(s,l,t,o,g);const h=s;s=l,l=h;continue}if(a===2){lt(s,l,t,o,g);const h=s;s=l,l=h;continue}lt(s,l,t,o,g),s===e&&p===0&&(s=new Uint8Array(e)),ct(l,s,t,o,g)}return s}function ko(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:5}function lt(e,t,o,n,a){t.fill(0);for(let i=0;i<n;i++){const r=Math.max(0,i-a),u=Math.min(n-1,i+a);for(let g=0;g<o;g++){const s=Math.max(0,g-a),l=Math.min(o-1,g+a);let p=0;for(let h=r;h<=u&&!p;h++){let d=h*o+s;for(let c=s;c<=l;c++,d++)if(e[d]){p=1;break}}t[i*o+g]=p}}}function ct(e,t,o,n,a){t.fill(0);for(let i=0;i<n;i++){const r=Math.max(0,i-a),u=Math.min(n-1,i+a);for(let g=0;g<o;g++){const s=Math.max(0,g-a),l=Math.min(o-1,g+a);let p=1;for(let h=r;h<=u&&p;h++){let d=h*o+s;for(let c=s;c<=l;c++,d++)if(!e[d]){p=0;break}}t[i*o+g]=p}}}function Mo(e,t,o){return e<t?t:e>o?o:e}const Ro="demo",Do={"contour.clean.removeSmallComponents":{native:(e,t)=>Bt(e.mask,e.width,e.height,t.cleanMinArea),opencv:(e,t)=>(V("OpenCV removeSmallComponents called (demo).",{width:e.width,height:e.height,cleanMinArea:t.cleanMinArea}),ho(e,t))},"segmentation.resize":{native:(e,t)=>(V("[demo op] segmentation.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),at(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(V("[demo op] segmentation.resize opencv",{width:e.width,height:e.height}),at(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"segmentation.denoise":{native:(e,t)=>(V("[demo op] segmentation.denoise native",{width:e.width,height:e.height,denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}),it(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma})),opencv:(e,t)=>(V("[demo op] segmentation.denoise opencv",{width:e.width,height:e.height}),it(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}))},"segmentation.color":{native:(e,t)=>(V("[demo op] segmentation.color native",{width:e.width,height:e.height,colorMode:t.colorMode,hsvChannel:t.hsvChannel}),st(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel})),opencv:(e,t)=>(V("[demo op] segmentation.color opencv",{width:e.width,height:e.height}),st(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel}))},"segmentation.threshold":{native:(e,t)=>(V("[demo op] segmentation.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),ot(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(V("[demo op] segmentation.threshold opencv",{width:e.width,height:e.height}),ot(e.image,e.width,e.height,{manualT:t.manualT}))},"segmentation.morphology":{native:(e,t)=>(V("[demo op] segmentation.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),rt(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(V("[demo op] segmentation.morphology opencv",{width:e.width,height:e.height}),rt(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))}};async function te(e,t){return G("[opsDispatch] runOp",{op:e,implSource:Ro,inputKeys:t&&typeof t=="object"?Object.keys(t):typeof t}),fo(e,t,Do)}async function Po(e,t){return te(e,t)}async function To(e,t,o){const{setStatus:n,setContourBusyVisual:a,clearSvgPreview:i,updateEnabled:r,updateCleanQualityUI:u}=o;if(!t.hasOutput){J("Contour clean: skipped (no output present)");return}const g=performance.now();await ue(e,async()=>{a(!0,"Cleaning…"),await new Promise(s=>{setTimeout(()=>{(async()=>{try{const l=e.outCanvasEl,p=e.clean1CanvasEl,h=e.clean2CanvasEl,d=await Re(),c=d.cleanRadius,f=d.cleanBinaryThreshold,v=d.invertOutput;p.width=l.width,p.height=l.height,h.width=l.width,h.height=l.height;const m=l.width,y=l.height,x=m*y;G("Contour clean: start",{width:m,height:y,pixels:x,whiteBg:v,EDGE_T:f,radius:c});const w=l.getContext("2d",{willReadFrequently:!0}),I=p.getContext("2d",{willReadFrequently:!0}),b=h.getContext("2d",{willReadFrequently:!0});if(!w||!I||!b){K("Contour clean: missing 2D context",{hasOut:!!w,hasC1:!!I,hasC2:!!b}),n("Clean failed — canvas context not available.");return}const C=w.getImageData(0,0,m,y).data,M=new Uint8Array(m*y);let E=0;for(let D=0,T=0;D<M.length;D++,T+=4){const N=C[T],A=(v?N<f:N>=f)?1:0;M[D]=A,A===1&&E++}G("Contour removeSmallComponents: params",{edge:M,width:m,height:y});const S=await Po("contour.clean.removeSmallComponents",{mask:M,width:m,height:y});G("Contour erode : params",{edgeNoSpeck:S,width:m,height:y,radius:c});const P=Le(Ae(S,m,y,c),m,y,c);I.putImageData(We(P,m,y,v),0,0),G("Contour dilate : params",{repaired:P,width:m,height:y,radius:c});const L=Ae(Le(P,m,y,c),m,y,c);G("Contour erode : params",{opened:L,width:m,height:y,radius:c});const $=Le(Ae(L,m,y,c),m,y,c);b.putImageData(We($,m,y,v),0,0),t.edgeMask=M,t.repairedMask=P,t.smoothedMask=$,i();const R=St($,m,y);u(m,y),n(`Clean done — CC:${R.components} endpoints:${R.endpoints} junctions:${R.junctions} thickness:${R.thicknessRatio.toFixed(2)}`),G("Contour clean: done",{width:m,height:y,pixels:x,whiteBg:v,EDGE_T:f,radius:c,edgeOn:E,edgeRatio:Math.round(E/Math.max(1,x)*1e6)/1e6,quality:R,ms:Math.round((performance.now()-g)*10)/10})}catch(l){K("Contour clean: exception",{error:l instanceof Error?l.message:String(l)}),n("Clean failed — see console / debug trace.")}finally{s()}})()},0)}),a(!1),r()})}function Ao(e,t,o){const n=new Uint8Array(e.length),a=[];function i(d,c){return c*t+d}function r(d,c){return d<0||c<0||d>=t||c>=o?!1:e[i(d,c)]===1}function u(d,c){if(!r(d,c))return!1;for(let f=-1;f<=1;f++)for(let v=-1;v<=1;v++)if(!(v===0&&f===0)&&!r(d+v,c+f))return!0;return!1}const g=[{dx:1,dy:0},{dx:1,dy:1},{dx:0,dy:1},{dx:-1,dy:1},{dx:-1,dy:0},{dx:-1,dy:-1},{dx:0,dy:-1},{dx:1,dy:-1}],s=2e3,l=Math.max(2e3,Math.floor((t+o)*2)),p=Math.max(2e5,Math.floor(t*o*.25));let h=0;for(let d=0;d<o;d++)for(let c=0;c<t;c++){if(a.length>=s||h>=p)return a;const f=i(c,d);if(n[f]===1||!u(c,d))continue;const v=[];let m=c,y=d,x=4,w=0;const I=Math.min(t*o,l*4);for(;w<I;){w++;const b=i(m,y);if(n[b]===1||(v.push({x:m,y}),n[b]=1,h++,v.length>=l)||h>=p)break;let k=!1;const C=(x+6)%8;for(let M=0;M<8;M++){const E=(C+M)%8,S=m+g[E].dx,P=y+g[E].dy;if(!u(S,P))continue;const L=i(S,P);if(!(!(S===c&&P===d&&v.length>10)&&n[L]===1)){m=S,y=P,x=E,k=!0;break}}if(!k||m===c&&y===d&&v.length>10)break}v.length>=20&&a.push(v)}return a}function ut(e,t){if(e.length<3)return e;const o=t*t;function n(s,l,p){const h=p.x-l.x,d=p.y-l.y,c=s.x-l.x,f=s.y-l.y,v=h*c+d*f;if(v<=0)return(s.x-l.x)**2+(s.y-l.y)**2;const m=h*h+d*d;if(m<=v)return(s.x-p.x)**2+(s.y-p.y)**2;const y=v/m,x=l.x+y*h,w=l.y+y*d;return(s.x-x)**2+(s.y-w)**2}const a=new Uint8Array(e.length);a[0]=1,a[e.length-1]=1;const i=[0],r=[e.length-1];for(;i.length>0;){const s=i.pop(),l=r.pop();if(l<=s+1)continue;const p=e[s],h=e[l];let d=0,c=-1;for(let f=s+1;f<l;f++){const v=n(e[f],p,h);v>d&&(d=v,c=f)}c!==-1&&d>o&&(a[c]=1,i.push(s),r.push(c),i.push(c),r.push(l))}const u=[];for(let s=0;s<e.length;s++)a[s]===1&&u.push(e[s]);const g=[];for(const s of u){const l=g[g.length-1];(!l||l.x!==s.x||l.y!==s.y)&&g.push(s)}return g}function Lo(e,t){let o=e;for(let n=0;n<t;n++){if(o.length<3)return o;const a=[];for(let l=0;l<o.length-1;l++){const p=o[l],h=o[l+1];a.push({x:.75*p.x+.25*h.x,y:.75*p.y+.25*h.y},{x:.25*p.x+.75*h.x,y:.25*p.y+.75*h.y})}const i=o[0],r=o[o.length-1],u=i.x-r.x,g=i.y-r.y;if(u*u+g*g<=4){const l=o[o.length-1],p=o[0];a.push({x:.75*l.x+.25*p.x,y:.75*l.y+.25*p.y},{x:.25*l.x+.75*p.x,y:.25*l.y+.75*p.y})}o=a}return o}function Oo(e,t,o){const n=[];for(const a of e){const i=Bo(a);i&&n.push(`<path d="${i}" fill="none" stroke="#000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>`)}return`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${t}" height="${o}" viewBox="0 0 ${t} ${o}">
<rect x="0" y="0" width="${t}" height="${o}" fill="#fff"/>
`+n.join(`
`)+`
</svg>
`}function Bo(e){if(e.length<2)return"";const t=e.slice(),o=t[0],n=t[t.length-1],a=o.x-n.x,i=o.y-n.y,r=a*a+i*i<=4;r&&t.push({x:o.x,y:o.y});let u=`M ${t[0].x.toFixed(2)} ${t[0].y.toFixed(2)}`;for(let g=0;g<t.length-1;g++){const s=t[Math.max(0,g-1)],l=t[g],p=t[g+1],h=t[Math.min(t.length-1,g+2)],d=l.x+(p.x-s.x)/6,c=l.y+(p.y-s.y)/6,f=p.x-(h.x-l.x)/6,v=p.y-(h.y-l.y)/6;u+=` C ${d.toFixed(2)} ${c.toFixed(2)}, ${f.toFixed(2)} ${v.toFixed(2)}, ${p.x.toFixed(2)} ${p.y.toFixed(2)}`}return r&&(u+=" Z"),u}async function $o(e,t,o){if(!t.smoothedMask){J("Contour vectorize: skipped (no smoothed mask present)");return}const n=performance.now();await ue(e,async()=>{o.setContourBusyVisual(!0,"Vectorizing…");const a=()=>{t.svgText=void 0,e.svgPreviewTextEl.textContent="",e.svgPreviewImgEl.removeAttribute("src")};try{await new Promise((i,r)=>{setTimeout(()=>{(async()=>{try{const u=t.smoothedMask,g=e.outCanvasEl.width,s=e.outCanvasEl.height,l=g*s,p=1.5,d=(await Re()).pathSmoothIters;G("Contour vectorize: start",{width:g,height:s,pixels:l,epsilon:p,smoothIters:d});const c=Ao(u,g,s),f=c.length,v=c.reduce((C,M)=>C+M.length,0),m=c.reduce((C,M)=>Math.max(C,M.length),0);if(f===0||v===0){J("Contour vectorize: no boundaries found",{width:g,height:s,pixels:l,pathsRaw:f,pointsRaw:v}),a(),o.setStatus("No boundaries found to vectorize."),i();return}if(f>2e3||v>2e5){J("Contour vectorize: aborted (too complex)",{width:g,height:s,pixels:l,pathsRaw:f,pointsRaw:v,maxPolyline:m}),a(),o.setStatus(`Vectorize aborted: too complex (paths ${f}, points ${v}). Try stronger clean / higher minArea / lower resolution.`),i();return}G("Contour vectorize: traced boundaries",{pathsRaw:f,pointsRaw:v,maxPolyline:m});const y=c.filter(C=>C.length>=20).map(C=>{const M=ut(C,p),E=d>0?Lo(M,d):M;return ut(E,p)}).filter(C=>C.length>=3),x=y.length,w=y.reduce((C,M)=>C+M.length,0),I=y.reduce((C,M)=>Math.max(C,M.length),0);if(x===0||w===0){J("Contour vectorize: simplified to nothing",{pathsRaw:f,pointsRaw:v,pathsOut:x,pointsOut:w,smoothIters:d,epsilon:p}),a(),o.setStatus("Vectorize produced no usable paths (after simplification)."),i();return}G("Contour vectorize: simplified",{pathsOut:x,pointsOut:w,maxOut:I,smoothIters:d,epsilon:p});const b=Oo(y,g,s);t.svgText=b,e.svgPreviewTextEl.textContent=b;const k=encodeURIComponent(b).replace(/'/g,"%27").replace(/"/g,"%22");e.svgPreviewImgEl.src=`data:image/svg+xml;charset=utf-8,${k}`,o.setStatus(`SVG generated: paths ${x}, points ${v}→${w}, smooth ${d}`),G("Contour vectorize: done",{width:g,height:s,pixels:l,smoothIters:d,epsilon:p,pathsRaw:f,pointsRaw:v,pathsOut:x,pointsOut:w,svgChars:b.length,ms:Math.round((performance.now()-n)*10)/10}),i()}catch(u){K("Contour vectorize: exception",{error:u instanceof Error?u.message:String(u),ms:Math.round((performance.now()-n)*10)/10}),r(u)}})()},0)})}catch(i){o.showError("Vectorize",i),a()}finally{o.setContourBusyVisual(!1),o.updateEnabled()}})}function No(e,t){const o=Kn(),n=Gn(e,o);function a(){const g=e.dropZoneEl;function s(l){g.classList.toggle("is-hover",l)}g.addEventListener("dragover",l=>{l.preventDefault(),s(!0)}),g.addEventListener("dragleave",()=>s(!1)),g.addEventListener("drop",l=>{var h;l.preventDefault(),s(!1);const p=(h=l.dataTransfer)==null?void 0:h.files;!p||p.length===0||nt(e,o,p[0],{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearCanvases:n.clearCanvases,clearCleanCanvasesOnly:n.clearCleanCanvasesOnly,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,getNumber:n.getNumber})}),e.fileInputEl.addEventListener("change",()=>{var p;const l=(p=e.fileInputEl.files)==null?void 0:p[0];l&&(nt(e,o,l,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearCanvases:n.clearCanvases,clearCleanCanvasesOnly:n.clearCleanCanvasesOnly,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,getNumber:n.getNumber}),e.fileInputEl.value="")})}function i(){a(),e.btnDownloadEl.addEventListener("click",()=>n.downloadPng()),e.btnDownloadSvgEl.addEventListener("click",()=>n.downloadSvg()),e.btnProcessEl.addEventListener("click",()=>{co(e,o,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearCleanCanvasesOnly:n.clearCleanCanvasesOnly,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled})}),e.btnCleanEl.addEventListener("click",()=>{To(e,o,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,updateCleanQualityUI:n.updateCleanQualityUI})}),e.btnVectorizeEl.addEventListener("click",()=>{$o(e,o,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,updateEnabled:n.updateEnabled,showError:n.showError,getNumber:n.getNumber})}),qn(o),n.clearSvgPreview(),n.updateEnabled(),n.setStatus("No image loaded"),e.contourSpinnerEl.classList.add("is-hidden")}function r(){}function u(){}return{id:"contour",bind:i,mount:r,unmount:u}}function Vo(){return{status:"Idle",report:["Segmentation placeholder","","Planned:","- Multi-step segmentation pipeline (process1..processN)","- Per-step engine selection: native / opencv / auto","- OpenCV injection + probing is managed in Settings (demo-only)."].join(`
`),assignedByStep:new Map,activeRecipePresetId:null,getStepEls(e){return{"segmentation.resize":e.segStepResizeEl,"segmentation.denoise":e.segStepDenoiseEl,"segmentation.color":e.segStepColorEl,"segmentation.threshold":e.segStepThresholdEl,"segmentation.morphology":e.segStepMorphologyEl}}}}const $t=[{id:"seg.recipe.document",title:"Recipe: Document scan",target:"segmentation",params:[{id:"segmentation.resize",key:"resizeAlgo",value:1},{id:"segmentation.resize",key:"targetMaxW",value:1200},{id:"segmentation.denoise",key:"denoiseAlgo",value:1},{id:"segmentation.denoise",key:"blurK",value:3},{id:"segmentation.color",key:"colorMode",value:1},{id:"segmentation.threshold",key:"thresholdAlgo",value:2},{id:"segmentation.threshold",key:"adaptBlock",value:31},{id:"segmentation.threshold",key:"adaptC",value:3},{id:"segmentation.morphology",key:"morphAlgo",value:2},{id:"segmentation.morphology",key:"morphK",value:5},{id:"segmentation.morphology",key:"morphIters",value:1}]},{id:"seg.threshold.otsu",title:"Threshold: Otsu",target:"segmentation.threshold",params:[{id:"segmentation.threshold",key:"thresholdAlgo",value:1}]},{id:"seg.morph.fill-holes",title:"Morphology: Fill holes (close)",target:"segmentation.morphology",params:[{id:"segmentation.morphology",key:"morphAlgo",value:3},{id:"segmentation.morphology",key:"morphK",value:7},{id:"segmentation.morphology",key:"morphIters",value:1}]}];function zo(e){return $t.find(t=>t.id===e)??null}function Oe(e,t,o){const n=document.createElement(e);return t&&(n.className=t),typeof o=="string"&&(n.textContent=o),n}function Uo(e,t){return t==="recipe"?e.target==="segmentation":e.target===t}function Fo(e,t,o){const n=[],a=o.getStepEls(e);function i(){const f=e.segPresetListEl;f.innerHTML="";for(const v of $t){const m=Oe("div","segPresetCard");m.setAttribute("draggable","true"),m.setAttribute("data-preset-id",v.id),m.setAttribute("aria-label",`Preset: ${v.title}`);const y=Oe("div","segPresetCardTitle",v.title),x=Oe("div","segPresetCardDesc",v.description||`Target: ${v.target}`);m.appendChild(y),m.appendChild(x);const w=I=>{I.dataTransfer&&(I.dataTransfer.setData("text/plain",v.id),I.dataTransfer.effectAllowed="copy")};m.addEventListener("dragstart",w),n.push(()=>m.removeEventListener("dragstart",w)),f.appendChild(m)}}function r(f,v){const m=f.querySelector("[data-assigned]");m&&(m.textContent=v,m.classList.remove("muted"))}function u(f){const v=f.querySelector("[data-assigned]");v&&(v.textContent="Drop preset…",v.classList.add("muted"))}function g(f){for(const v of Object.keys(a))o.assignedByStep.set(v,f.id),r(a[v],f.title);o.activeRecipePresetId=f.id,r(e.segRecipeDropEl,f.title)}function s(f,v,m){o.assignedByStep.set(f,v.id),r(m,v.title)}function l(f,v){const m=I=>{I.preventDefault(),f.classList.add("is-over")},y=I=>{I.preventDefault(),f.classList.add("is-over"),I.dataTransfer&&(I.dataTransfer.dropEffect="copy")},x=()=>{f.classList.remove("is-over")},w=async I=>{var C;I.preventDefault(),f.classList.remove("is-over");const b=((C=I.dataTransfer)==null?void 0:C.getData("text/plain"))||"";if(!b)return;const k=zo(b);k&&Uo(k,v)&&(v==="recipe"?g(k):s(v,k,f),await t.applyPreset(k))};f.addEventListener("dragenter",m),f.addEventListener("dragover",y),f.addEventListener("dragleave",x),f.addEventListener("drop",w),n.push(()=>f.removeEventListener("dragenter",m)),n.push(()=>f.removeEventListener("dragover",y)),n.push(()=>f.removeEventListener("dragleave",x)),n.push(()=>f.removeEventListener("drop",w))}function p(){i(),l(e.segRecipeDropEl,"recipe"),l(a["segmentation.resize"],"segmentation.resize"),l(a["segmentation.denoise"],"segmentation.denoise"),l(a["segmentation.color"],"segmentation.color"),l(a["segmentation.threshold"],"segmentation.threshold"),l(a["segmentation.morphology"],"segmentation.morphology")}function h(){o.assignedByStep.clear(),o.activeRecipePresetId=null,u(e.segRecipeDropEl);for(const f of Object.keys(a))u(a[f])}function d(f){}function c(){for(const f of n)f();n.length=0}return p(),{set:d,resetUi:h,dispose:c}}async function jo(e,t){if(t.input.kind!=="image")throw new Error(`[segmentation] runImageOp: Mat input not supported yet for ${e}`);return{kind:"image",image:await te(e,{image:t.input.image,width:t.width,height:t.height})}}async function dt(e,t){if(e==="segmentation.threshold"){const{input:i,width:r,height:u}=t;if(i.kind!=="image")throw new Error("[segmentation] runMaskOp(threshold): Mat input not supported yet");return await te(e,{image:i.image,width:r,height:u})}const{mask:o,width:n,height:a}=t;return await te(e,{mask:o,width:n,height:a})}const Z=[{id:"segmentation.resize",kind:"image"},{id:"segmentation.denoise",kind:"image"},{id:"segmentation.color",kind:"image"},{id:"segmentation.threshold",kind:"mask"},{id:"segmentation.morphology",kind:"mask"}];function _o(e,t,o){const n=Vo(),a=Fo(e,o,n);let i=null;const r=n.getStepEls(e);function u(w){e.segStatusEl.textContent=w||""}function g(){for(const w of Object.values(r))w.classList.remove("is-active"),w.classList.remove("is-done")}function s(w){var I,b;for(const k of Object.values(r))k.classList.remove("is-active"),k.classList.remove("is-done");if(i){for(let k=0;k<Math.min(i.stepIndex,Z.length);k++){const C=Z[k].id;(I=r[C])==null||I.classList.add("is-done")}w&&((b=r[w])==null||b.classList.add("is-active"))}}function l(){if(!i)return;const{width:w,height:I}=i;e.segMaskCanvasEl.width=w,e.segMaskCanvasEl.height=I;const b=e.segMaskCanvasEl.getContext("2d",{willReadFrequently:!0});if(!b){K("[segmentation] preview: missing 2D context");return}if(i.artifact.kind==="image"){b.putImageData(i.artifact.image,0,0);return}b.putImageData(We(i.artifact.mask,w,I,!0),0,0)}function p(){const w=e.srcCanvasEl,I=w.width,b=w.height;if(!I||!b)return null;const k=w.getContext("2d",{willReadFrequently:!0});if(!k)return null;const C=k.getImageData(0,0,I,b);return{width:I,height:b,stepIndex:0,artifact:{kind:"image",image:C}}}async function h(){if(!i&&(i=p(),!i)){u("No image");return}if(i.stepIndex>=Z.length){u("Done");return}const w=Z[i.stepIndex],{width:I,height:b}=i;if(s(w.id),u(`Running: ${w.id}`),G("[segmentation] next step",{stepIndex:i.stepIndex,stepId:w.id,width:I,height:b,artifact:i.artifact.kind}),w.id==="segmentation.resize"||w.id==="segmentation.denoise"||w.id==="segmentation.color"){if(i.artifact.kind!=="image")throw new Error(`[segmentation] step ${w.id} expected image input, got mask`);const k=await jo(w.id,{input:{kind:"image",image:i.artifact.image},width:I,height:b});if(k.kind!=="image")throw new Error(`[segmentation] step ${w.id} returned non-image`);const C=i.stepIndex<Z.length?Z[i.stepIndex].id:null;s(C),i.artifact={kind:"image",image:k.image},i.stepIndex++,l(),u(`Done: ${w.id}`);return}if(w.id==="segmentation.threshold"){if(i.artifact.kind!=="image")throw new Error("[segmentation] threshold expected image input, got mask");const k=await dt("segmentation.threshold",{input:{kind:"image",image:i.artifact.image},width:I,height:b});i.artifact={kind:"mask",mask:k},i.stepIndex++,l(),s(null),u("Done: segmentation.threshold");return}if(w.id==="segmentation.morphology"){if(i.artifact.kind!=="mask")throw new Error("[segmentation] morphology expected mask input, got image");const k=await dt("segmentation.morphology",{mask:i.artifact.mask,width:I,height:b});i.artifact={kind:"mask",mask:k},i.stepIndex++,l(),s(null),u("Done: segmentation.morphology");return}}async function d(){if(i=p(),!i){u("No image");return}for(l(),u("Running all…");i&&i.stepIndex<Z.length;)await h();u("Done")}function c(){var b;a.resetUi(),i=null,g();const w=p();if(w){i=w,s((b=Z[0])==null?void 0:b.id),l(),u("Ready (reset to source)");return}u("No image");const I=e.segMaskCanvasEl.getContext("2d");I&&I.clearRect(0,0,e.segMaskCanvasEl.width,e.segMaskCanvasEl.height)}function f(){e.segRunBtn.addEventListener("click",()=>{ue(e,async()=>{try{await d()}catch(w){K("[segmentation] runAll exception",{error:w instanceof Error?w.message:String(w)}),u("Failed")}})}),e.segNextBtn.addEventListener("click",()=>{ue(e,async()=>{try{await h()}catch(w){K("[segmentation] nextStep exception",{error:w instanceof Error?w.message:String(w)}),u("Failed")}})}),e.segResetBtn.addEventListener("click",()=>c())}function v(){var I;if(V("[segmentation] mount"),i){l(),u("Ready");return}const w=p();if(w)i=w,g(),s((I=Z[0])==null?void 0:I.id),l(),u("Ready (source loaded)");else{g();const b=e.segMaskCanvasEl.getContext("2d");b&&b.clearRect(0,0,e.segMaskCanvasEl.width,e.segMaskCanvasEl.height),u("No image")}}function m(){var I;if(V("[segmentation] refresh"),i){l();return}const w=p();if(w){i=w,g(),s((I=Z[0])==null?void 0:I.id),l(),u("Ready (source loaded)");return}u("No image")}function y(){}function x(){a.dispose()}return{bind:f,mount:v,refresh:m,unmount:y,dispose:x}}function Be(e,t,o){return Number.isFinite(e)?Math.max(t,Math.min(o,Math.trunc(e))):t}function Ko(e,t,o){return Math.round(.2126*e+.7152*t+.0722*o)}function Nt(e){return{edgesDark:!!(e.edgesDark??!0),edgeThreshold:Be(e.edgeThreshold??80,0,255),edgeDilate:Be(e.edgeDilate??2,0,6),maxRegionPx:Be(e.maxRegionPx??2e5,1e3,1e7)}}function qo(e,t,o){const{data:n,width:a,height:i}=e,r=new Uint8Array(a*i);for(let u=0,g=0;u<r.length;u++,g+=4){const s=n[g+0],l=n[g+1],p=n[g+2];if(n[g+3]===0){r[u]=0;continue}const d=Ko(s,l,p),c=t?d<=o:d>=255-o;r[u]=c?1:0}return r}function Go(e,t,o,n){if(n<=0)return e;let a=e;for(let i=0;i<n;i++){const r=new Uint8Array(t*o);for(let u=0;u<o;u++)for(let g=0;g<t;g++){const s=u*t+g;if(a[s]){r[s]=1;continue}let l=0;for(let p=-1;p<=1&&!l;p++){const h=u+p;if(!(h<0||h>=o))for(let d=-1;d<=1;d++){const c=g+d;if(!(c<0||c>=t)&&a[h*t+c]){l=1;break}}}r[s]=l}a=r}return a}function Wo(e,t,o,n,a,i){const r=t*n+e;if(o[r])return{ok:!1,message:"Click is on an edge; pick inside a region."};const u=new Uint8Array(n*a),g=new Int32Array(n*a),s=new Int32Array(n*a);let l=0,p=0;g[p]=e,s[p]=t,p++,u[r]=1;let h=1;for(;l<p;){const d=g[l],c=s[l];l++;const f=[[d-1,c],[d+1,c],[d,c-1],[d,c+1]];for(const[v,m]of f){if(v<0||v>=n||m<0||m>=a)continue;const y=m*n+v;if(!u[y]&&!o[y]&&(u[y]=1,g[p]=v,s[p]=m,p++,h++,h>i))return{ok:!1,message:`Region too large (>${i}px). Increase Max region or fix gaps.`}}}return{ok:!0,mask:u}}function Ho(e,t,o,n){const a=new Uint8Array(o*n);for(let i=1;i<n-1;i++)for(let r=1;r<o-1;r++){const u=i*o+r;if(!e[u])continue;const g=(i-1)*o+r,s=(i+1)*o+r,l=i*o+(r-1),p=i*o+(r+1);(!e[g]||!e[s]||!e[l]||!e[p]||t[g]||t[s]||t[l]||t[p])&&(a[u]=1)}return a}function Qo(e,t,o,n){const a=Nt(n),i=e.width,r=e.height;let u=qo(e,a.edgesDark,a.edgeThreshold);u=Go(u,i,r,a.edgeDilate);const g=Wo(t,o,u,i,r,a.maxRegionPx);if(!g.ok)return{ok:!1,message:g.message};const s=Ho(g.mask,u,i,r);return{ok:!0,preview:{mask:g.mask,outline:s,w:i,h:r}}}function Jo(e,t,o){const n=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),a=o.replace("#",""),i=parseInt(a.slice(0,2),16),r=parseInt(a.slice(2,4),16),u=parseInt(a.slice(4,6),16),g=n.data;for(let s=0,l=0;s<t.mask.length;s++,l+=4)t.mask[s]&&(g[l+0]=i,g[l+1]=r,g[l+2]=u);return n}function $e(e,t,o){return Number.isFinite(e)?Math.max(t,Math.min(o,Math.trunc(e))):t}function gt(e){const t=(e||"").trim();if(!t)return null;const o=t.startsWith("#")?t:`#${t}`;return/^#[0-9a-fA-F]{6}$/.test(o)?o.toLowerCase():null}function Yo(e){let t="#ff3b30",o=[],n=null;function a(f){e.colorsStatusEl.textContent=f||""}function i(){const f=!!e.edgesDarkEl.checked,v=$e(parseInt(e.edgeMaskThresholdEl.value,10),0,255),m=$e(parseInt(e.edgeDilateEl.value,10),0,6),y=$e(parseInt(e.maxRegionPxEl.value,10),1e3,1e7);return e.edgeMaskThresholdEl.value=String(v),e.edgeDilateEl.value=String(m),e.maxRegionPxEl.value=String(y),Nt({edgesDark:f,edgeThreshold:v,edgeDilate:m,maxRegionPx:y})}function r(f){const v=gt(f);if(v){t=v;for(const m of Array.from(e.paletteEl.querySelectorAll(".paletteItem"))){const y=m.dataset.hex||"";m.classList.toggle("is-selected",y===t)}}}function u(){return t}function g(f){o=f.slice(),e.paletteEl.innerHTML="";for(const v of o){const m=gt(v);if(!m)continue;const y=document.createElement("button");y.type="button",y.className="paletteItem",y.style.background=m,y.dataset.hex=m,y.setAttribute("role","listitem"),y.setAttribute("aria-label",`Select ${m}`),y.addEventListener("click",()=>{r(m)}),e.paletteEl.appendChild(y)}r(t)}function s(f){const v=e.colorsCanvasEl;v.width=f.width,v.height=f.height,v.getContext("2d").putImageData(f,0,0)}function l(f,v){s(f);const m=e.colorsCanvasEl.getContext("2d"),{outline:y,w:x,h:w}=v,I=m.getImageData(0,0,x,w),b=I.data;for(let k=0,C=0;k<y.length;k++,C+=4)y[k]&&(b[C+0]=255,b[C+1]=60,b[C+2]=60,b[C+3]=220);m.putImageData(I,0,0)}function p(f){e.btnColorsApplyEl.disabled=!f}function h(f){e.btnColorsCancelEl.disabled=!f}function d(f){n=f}function c(){a("Idle"),p(!1),h(!1),e.colorsCanvasEl.addEventListener("click",f=>{if(!n)return;const v=e.colorsCanvasEl.getBoundingClientRect(),m=Math.floor((f.clientX-v.left)/v.width*e.colorsCanvasEl.width),y=Math.floor((f.clientY-v.top)/v.height*e.colorsCanvasEl.height);n(m,y)})}return{bind:c,setStatus:a,getSettings:i,setSelectedColor:r,getSelectedColor:u,renderPalette:g,drawBase:s,drawPreview:l,setApplyEnabled:p,setCancelEnabled:h,onCanvasClick:d}}const Xo=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#a2845e","#8e8e93","#1c1c1e","#ffffff","#000000","#4cd964","#5ac8fa","#ff6b6b","#7aa2ff","#f5a623","#50e3c2"];function Zo(e,t){const o=Yo(e);let n=null,a=null;function i(p){o.setStatus(p)}function r(){const p=e.outCanvasEl.getContext("2d");if(!p)return null;const h=e.outCanvasEl.width,d=e.outCanvasEl.height;return h<=0||d<=0?null:p.getImageData(0,0,h,d)}function u(){const p=r();if(!p){n=null,a=null,o.setApplyEnabled(!1),o.setCancelEnabled(!1),i("No output available. Run Process first.");return}n=p,a=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),i("Ready. Pick a color, click inside a region.")}function g(){if(n){o.drawBase(n);return}const p=r();if(!p){i("No output available. Run Process first.");return}n=p,a=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),i("Loaded output. Pick a color, click inside a region.")}function s(){if(!n||!a)return;const p=o.getSelectedColor();n=Jo(n,a,p),a=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),i("Fill applied. Click another region.")}function l(){n&&(a=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),i("Preview canceled."))}return{bind(){o.bind(),o.renderPalette(Xo),o.onCanvasClick((p,h)=>{if(!n){i("No output available. Run Process first.");return}const d=o.getSettings(),c=Qo(n,p,h,d);if(!c.ok){a=null,o.setApplyEnabled(!1),o.setCancelEnabled(!1),i(c.message);return}a=c.preview,o.drawPreview(n,a),o.setApplyEnabled(!0),o.setCancelEnabled(!0),i("Preview shown. Apply fill or cancel.")}),e.btnColorsApplyEl.addEventListener("click",()=>s()),e.btnColorsCancelEl.addEventListener("click",()=>l()),e.btnColorsResetEl.addEventListener("click",()=>u()),e.tabColors.addEventListener("click",()=>{queueMicrotask(()=>g())}),i("Idle"),o.setApplyEnabled(!1),o.setCancelEnabled(!1)}}}const ke="beecontour.actionLog",ea=5e3;function ta(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function na(e){return Array.isArray(e)?e:[e]}function Me(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}async function he(){const e=await le(ke),t=e==null?void 0:e[ke];return Array.isArray(t)?t:[]}async function Vt(e){await ce({[ke]:e})}async function j(e,t){const o=Me(ea,100,5e4),a=na(e).map(g=>({...g,id:ta(),ts:Date.now()}));if(!a.length)return{total:(await he()).length};const r=(await he()).concat(a),u=r.length>o?r.slice(r.length-o):r;return await Vt(u),{total:u.length}}async function oa(e){const t=Me((e==null?void 0:e.limit)??200,1,5e4),o=Me((e==null?void 0:e.offset)??0,0,1e6);let a=await he();e!=null&&e.kind&&(a=a.filter(u=>u.kind===e.kind)),e!=null&&e.scope&&(a=a.filter(u=>u.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(a=a.filter(u=>u.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(a=a.filter(u=>u.ts<=e.untilTs));const i=a.length;a=a.slice().reverse();const r=a.slice(o,o+t);return{total:i,items:r}}async function aa(e){let o=await he();if(typeof e.beforeTs=="number"&&(o=o.filter(n=>n.ts>=e.beforeTs)),typeof e.keepLast=="number"){const n=Me(e.keepLast,0,5e4);n===0?o=[]:o.length>n&&(o=o.slice(o.length-n))}return await Vt(o),{total:o.length}}async function ia(){await He(ke)}async function sa(e){const t=await he();return JSON.stringify(t,null,2)}const pt="0.1.0";async function ra(e){const t=new URL(e.opencvJsRel,document.baseURI).toString(),o=new URL(e.opencvWasmRel,document.baseURI).toString(),n=globalThis;n.Module=n.Module||{},n.Module.locateFile=a=>a.endsWith(".wasm")?o:a,n.Module.print=()=>{},n.Module.printErr=()=>{},n.cv||await la(t),await ca(e.timeoutMs)}function la(e){return new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0;const a=15e3,i=window.setTimeout(()=>{r(),o(new Error(`OpenCV script load timeout after ${a}ms: ${e}`))},a);function r(){window.clearTimeout(i),n.onload=null,n.onerror=null}n.onload=()=>{r(),t()},n.onerror=()=>{r(),o(new Error(`Failed to load OpenCV script: ${e}`))},document.head.appendChild(n)})}async function ca(e){var n;const t=Date.now(),o=globalThis;for(;Date.now()-t<e;){try{if(o.cv&&typeof o.cv.Mat=="function"){const a=new o.cv.Mat;(n=a.delete)==null||n.call(a);return}}catch{}await new Promise(a=>setTimeout(a,75))}throw new Error(`OpenCV initialization timeout after ${e}ms`)}async function ua(){try{await ra({opencvJsRel:"../assets/opencv/opencv.js",opencvWasmRel:"../assets/opencv/opencv.wasm",timeoutMs:2e4}),oo("opencv")}catch(e){throw ao("opencv",e!=null&&e.message?String(e.message):String(e)),e}}function z(e,t,o){const n=document.createElement(e);if(t)for(const[a,i]of Object.entries(t))n.setAttribute(a,i);return typeof o=="string"&&(n.textContent=o),n}function ft(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function da(e){return e.fallbackReason?`${e.effectiveEngine} (fallback)`:e.effectiveEngine}function ga(e){const t=[{value:"native",label:"Native"},{value:"auto",label:"Auto"},...e.canImplementOpenCv?[{value:"opencv",label:"OpenCV"}]:[]];return e.isRoot?t:[{value:"inherit",label:"Inherit"},...t]}function pa(e){return!1}function fa(e,t,o){var a;const n=(a=e.storedParams)==null?void 0:a[t];return typeof n<"u"&&n!==o}function ma(e){var p;const{node:t,compId:o,key:n,schema:a,value:i,handlers:r}=e,u=z("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),g=z("label",{class:"fieldInline"}),s=z("span",void 0,a.label);g.appendChild(s);let l;if(a.kind==="number"?(l=z("input"),l.type="number",typeof a.min=="number"&&(l.min=String(a.min)),typeof a.max=="number"&&(l.max=String(a.max)),typeof a.step=="number"&&(l.step=String(a.step)),l.value=String(i??a.default),l.addEventListener("change",()=>{const h=Number(l.value);r.onSetParam(o,n,Number.isFinite(h)?h:a.default)})):a.kind==="boolean"?(l=z("input"),l.type="checkbox",l.checked=!!i,l.addEventListener("change",()=>{r.onSetParam(o,n,!!l.checked)})):(l=z("input"),l.type="text",l.value=String(i??a.default),l.addEventListener("change",()=>{r.onSetParam(o,n,String(l.value??a.default))})),g.appendChild(l),u.appendChild(g),r.onResetParam&&typeof((p=t.storedParams)==null?void 0:p[n])<"u"){const h=z("button",{type:"button"},"Reset");h.addEventListener("click",d=>{var c;d.preventDefault(),(c=r.onResetParam)==null||c.call(r,o,n)}),u.appendChild(h)}return fa(t,n,i)&&u.appendChild(z("span",{class:"muted",style:"font-size:12px;"},"override")),u}function zt(e){const{node:t,depth:o,isRoot:n,handlers:a,treeScopeId:i}=e,r=z("div",{style:`margin-left:${Math.min(o*14,56)}px; margin-top:10px;`}),u=z("div",{style:"border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:10px; background:rgba(0,0,0,0.12);"}),g=z("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),s=z("div");s.appendChild(z("div",{style:"font-weight:700;"},t.title)),t.description&&s.appendChild(z("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},t.description)),t.isGroup&&s.appendChild(z("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},"Group (policy affects children)")),g.appendChild(s);const l=z("div",{class:"row",style:"align-items:center; gap:10px;"});l.appendChild(z("span",{class:"qBadge"},da(t)));const p=z("select");p.style.background="rgba(255,255,255,0.05)",p.style.border="1px solid rgba(255,255,255,0.08)",p.style.color="rgba(255,255,255,0.92)",p.style.borderRadius="10px",p.style.padding="6px 8px";const h=ga({isRoot:n,canImplementOpenCv:t.canImplementOpenCv});for(const x of h){const w=z("option");w.value=x.value,w.textContent=x.label,p.appendChild(w)}const d=new Set(h.map(x=>x.value)),c=t.effectivePolicy;d.has(c)?p.value=c:p.value=n?"native":"inherit",p.addEventListener("change",()=>{a.onSetPolicy(t.id,p.value)}),l.appendChild(p);const f=typeof t.storedPolicy<"u"||t.storedParams&&Object.keys(t.storedParams).length>0;if(a.onResetNode&&f){const x=z("button",{type:"button"},"Reset node");x.addEventListener("click",w=>{var I;w.preventDefault(),(I=a.onResetNode)==null||I.call(a,t.id)}),l.appendChild(x)}g.appendChild(l),u.appendChild(g),t.fallbackReason?u.appendChild(z("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},t.fallbackReason)):t.effectivePolicy==="opencv"&&!t.runtimeOpenCvReady&&u.appendChild(z("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},"OpenCV policy selected, but OpenCV is not available at runtime. It will fall back to native."));const v=Object.keys(t.paramsSchema??{}),m=v.length>0,y=t.children.length>0;if(m||y){const x=z("details",{style:"margin-top:10px;"});x.open=pa();const w=z("summary",{style:"cursor:pointer; user-select:none;"},"Details");if(x.appendChild(w),m){const I=z("div",{style:"margin-top:10px;"});I.appendChild(z("div",{class:"muted",style:"font-weight:600; margin-bottom:6px;"},"Parameters"));for(const b of v){const k=t.paramsSchema[b],C=t.effectiveParams[b];I.appendChild(ma({node:t,compId:t.id,key:b,schema:k,value:C,handlers:a}))}x.appendChild(I)}if(y){const I=z("div",{style:"margin-top:10px;"});for(const b of t.children)I.appendChild(zt({node:b,depth:o+1,isRoot:!1,handlers:a,treeScopeId:i}));x.appendChild(I)}u.appendChild(x)}return r.appendChild(u),r}function Ut(e,t){let o=!1;function n(i){if(o)return;ft(e);const r=i.scopeId==="app",u=z("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"});u.appendChild(z("div",{style:"font-weight:700;"},"Tuning")),u.appendChild(z("div",{class:"muted",style:"font-size:12px;"},`OpenCV runtime: ${i.runtime.opencvReady?"ready":"not available"}`)),e.appendChild(u),e.appendChild(zt({node:i.root,depth:0,isRoot:r,handlers:t,treeScopeId:i.scopeId}))}function a(){o=!0,ft(e)}return{render:n,dispose:a}}function ha(){let e=!1,t={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},o=!1,n="",a="";function i(s){e=s}function r(s){t={...t,...s}}function u(s){o=s}function g(s){typeof s.general=="string"&&(n=s.general),typeof s.dev=="string"&&(a=s.dev)}return{get showDevTools(){return e},get dev(){return t},get debugEnabled(){return o},get generalStatus(){return n},get devStatus(){return a},setShowDevTools:i,setDev:r,setDebugEnabled:u,setStatus:g}}function va(e){function t(s){e.settingsGeneralStatusEl.textContent=s||""}function o(s){e.cfgStatusEl.textContent=s||""}function n(s){e.cfgShowDevToolsEl.checked=s}function a(s){e.tabLogs.hidden=!s,e.devConfigDetailsEl.classList.toggle("is-hidden",!s),s||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function i(s){e.cfgTraceConsoleEl.checked=!!s.traceConsole,e.cfgActionLogMaxEl.value=String(s.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(s.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(s.failureLogsPerRun??50)}function r(s){e.logsCbDebugEl.checked=s}function u(s,l){e.settingsVersionEl.textContent=s||"—",e.settingsGitHubLinkEl.href=l||"#",e.settingsGitHubLinkEl.hidden=!l}function g(s){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=s,e.cfgActionLogMaxEl.disabled=s,e.cfgDebugTraceMaxEl.disabled=s,e.cfgFailureLogsPerRunEl.disabled=s,e.btnCfgResetDefaults.disabled=s,e.logsCbDebugEl.disabled=s,e.cfgUseOpenCvEl.disabled=s}return{setGeneralStatus:t,setDevStatus:o,setShowDevToolsChecked:n,setDevToolsVisible:a,setDevConfig:i,setDebugEnabledChecked:r,setAbout:u,setBusy:g}}const Ne="template.settings.showDevTools",Ve="beecontour.settings.engine.useOpenCv";function ya(){var e,t;try{const o=(e=globalThis==null?void 0:globalThis.chrome)==null?void 0:e.runtime,n=(t=o==null?void 0:o.getManifest)==null?void 0:t.call(o),a=typeof(n==null?void 0:n.version)=="string"?n.version:"";if(V("Settings: getManifestVersion manifest found version is ",{v:a}),a)return a}catch{}return V("Settings: getManifestVersion fallback",{APP_VERSION:pt}),pt}function ze(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??Q.actionLogMax),debugTraceMax:Number(e.debugTraceMax??Q.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??Q.failureLogsPerRun)}}function ba(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:ee(e.cfgActionLogMaxEl.value,100,5e4,Q.actionLogMax),debugTraceMax:ee(e.cfgDebugTraceMaxEl.value,100,5e4,Q.debugTraceMax),failureLogsPerRun:ee(e.cfgFailureLogsPerRunEl.value,0,5e4,Q.failureLogsPerRun)}}async function mt(e){const t=Pt;return typeof t.setEnabled=="function"?(await t.setEnabled(e),{ok:!0}):typeof t.enable=="function"&&typeof t.disable=="function"?(await(e?t.enable():t.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function wa(e,t){const o=ha(),n=va(e),a=Xe({getRuntimeAvailability:()=>({opencvReady:e.cfgUseOpenCvEl.checked&&oe()})}),i=Ut(e.tuningMountEl,{onSetPolicy:async(E,S)=>{await a.setEnginePolicy(E,S),await y("policy change")},onSetParam:async(E,S,P)=>{await a.setParam(E,S,P),await y("param change")},onResetNode:async E=>{await a.resetNode(E),await y("reset node")},onResetParam:async(E,S)=>{await a.resetParam(E,S),await y("reset param")}});function r(E){e.settingsEngineBoxEl.classList.toggle("is-hidden",!1)}async function u(){const E=await le([Ve]).catch(()=>({}));return(E==null?void 0:E[Ve])===!0}async function g(E){await ce({[Ve]:!!E}).catch(()=>null)}function s(E){var S;e.cfgUseOpenCvEl.checked=E,(S=e.cfgUseOpenCvEl.closest(".switch"))==null||S.classList.toggle("is-disabled",e.cfgUseOpenCvEl.disabled)}function l(E){e.cfgOpenCvSpinner.classList.toggle("is-hidden",!E),e.cfgOpenCvSpinner.setAttribute("aria-hidden",E?"false":"true")}function p(E){e.cfgOpenCvStatus.textContent=E||""}function h(E){e.cfgOpenCvReport.textContent=E||""}async function d(){if(H())return;if(!!!e.cfgUseOpenCvEl.checked){await g(!1),l(!1),p(oe()?"OpenCV loaded (native mode)":"Native mode"),h("Native mode. OpenCV is optional and demo-only."),await y("opencv mode disabled");return}l(!0),p("Loading OpenCV…"),h("Loading OpenCV…");try{if(await ue(e,async()=>{await ua()}),!oe())throw new Error("OpenCV load returned but runtime is not injected.");await g(!0),p("OpenCV mode enabled"),h("OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV."),await y("opencv mode enabled")}catch(S){const P=String((S==null?void 0:S.message)??S);await g(!1),s(!1),p("OpenCV load failed"),h(`ERROR

${P}`),K("[settings] OpenCV toggle failed",{msg:P})}finally{l(!1)}}async function c(){const E=await le([Ne]).catch(()=>({}));return(E==null?void 0:E[Ne])===!0}async function f(E){await ce({[Ne]:!!E}).catch(()=>null)}function v(E){o.setShowDevTools(E),n.setShowDevToolsChecked(E),n.setDevToolsVisible(E)}async function m(){const E=await c();v(E),V("Settings: boot applyDevToolsVisibility",{showDevTools:E})}async function y(E){try{const S=await a.loadTree("app");i.render(S),V("[settings] tuning rendered",{reason:E,opencvInjected:oe(),opencvMode:!!e.cfgUseOpenCvEl.checked})}catch(S){K("[settings] tuning render failed",{reason:E,msg:String((S==null?void 0:S.message)??S)}),e.tuningMountEl.textContent="Tuning UI failed to load (see console)."}}async function x(){var $;n.setBusy(H());const E=await c();v(E),await _e().catch(()=>null);const S=xe();o.setDev(ze(S)),n.setDevConfig(o.dev);const P=Pt;let L=!1;try{typeof P.isEnabled=="function"?L=!!await P.isEnabled():L=!!P.enabled}catch(R){J("Settings: failed to read debug enabled state",{error:R instanceof Error?R.message:String(R)})}o.setDebugEnabled(L),n.setDebugEnabledChecked(L),n.setAbout(ya()||"—",(($=e.settingsGitHubLinkEl)==null?void 0:$.href)||"#"),r();{const R=await u();s(R),l(!1);const D=oe();R?(p(D?"OpenCV mode enabled":"OpenCV mode (not loaded)"),h(D?"OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV.":"OpenCV mode is enabled, but OpenCV is not loaded yet. Toggle OFF then ON to load OpenCV.")):(p(D?"OpenCV loaded (native mode)":"Native mode"),h("Native mode. OpenCV is optional and demo-only."))}n.setGeneralStatus(""),n.setDevStatus(""),await y("loadAll"),V("Settings: loaded",{showDevTools:E,debugTraceEnabled:L,dev:o.dev,opencvInjected:oe()})}async function w(){const E=!!e.cfgShowDevToolsEl.checked;v(E),await f(E),j({kind:"run",scope:"settings",message:E?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:E}}),V("Settings: ui toggle showDevTools",{showDevTools:E}),n.setGeneralStatus(E?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>n.setGeneralStatus(""),1200)}async function I(){const E=ba(e);n.setDevStatus("Saving…");try{await It(E)}catch(S){K("Settings: failed to save dev config",{error:S instanceof Error?S.message:String(S),next:E}),n.setDevStatus("Save failed."),setTimeout(()=>n.setDevStatus(""),1200);return}o.setDev(ze(E)),n.setDevConfig(o.dev),j({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:E}),V("Settings: devConfig updated",E),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}async function b(){n.setDevStatus("Resetting…");try{await Fn(),await _e().catch(()=>null);const S=xe();o.setDev(ze(S)),n.setDevConfig(o.dev)}catch(S){K("Settings: failed to reset dev config defaults",{error:S instanceof Error?S.message:String(S)}),n.setDevStatus("Reset failed."),setTimeout(()=>n.setDevStatus(""),1200);return}const E=await mt(!1);E.ok?(o.setDebugEnabled(!1),n.setDebugEnabledChecked(!1)):(J("Settings: failed to reset debug enabled state",{error:E.error||"unknown error"}),j({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:E.error||"unknown error"})),j({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...Q,debugEnabled:!1}}),V("Settings: reset defaults",{...Q,debugEnabled:!1}),n.setDevStatus("Reset."),setTimeout(()=>n.setDevStatus(""),1200)}async function k(){const E=!!e.logsCbDebugEl.checked;n.setDevStatus("Saving…");const S=await mt(E);if(!S.ok){e.logsCbDebugEl.checked=!E,n.setDevStatus(`Save failed: ${S.error||"unknown error"}`),K("Settings: failed to change debug enabled state",{error:S.error||"unknown error",enabled:E}),j({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:S.error||"unknown error",meta:{enabled:E}});return}o.setDebugEnabled(E),j({kind:"run",scope:"settings",message:E?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:E}}),V("Settings: debug enabled changed",{enabled:E}),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}const C=t.on(()=>{});function M(){e.cfgShowDevToolsEl.addEventListener("change",()=>{w()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{H()||I()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{H()||I()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{H()||I()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{H()||I()}),e.btnCfgResetDefaults.addEventListener("click",()=>{H()||b()}),e.logsCbDebugEl.addEventListener("change",()=>{H()||k()}),e.cfgUseOpenCvEl.addEventListener("change",()=>{d()}),m().catch(E=>{J("Settings: initDevToolsVisibility failed",{error:E instanceof Error?E.message:String(E)})})}return{id:"settings",refresh(){x().catch(E=>{K("Settings: refresh failed",{error:E instanceof Error?E.message:String(E)})})},mount(){x().catch(E=>{K("Settings: mount failed",{error:E instanceof Error?E.message:String(E)})})},unmount(){},bind:M,dispose(){C()}}}function Ea(){let e=[],t=0;function o(n){e=n.items,t=n.total}return{get items(){return e},get total(){return t},set:o}}function Ca(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function ht(e,t){const o=[];o.push(`Total entries: ${t.total}`),o.push("");for(const n of t.items){const a=typeof n.ok=="boolean"?n.ok?"ok":"fail":"",i=[];typeof n.status=="number"&&i.push(`status=${n.status}`),a&&i.push(a);const r=[n.scope,n.kind].filter(Boolean).join("/");o.push(`[${Ca(n.ts)}] ${r}${i.length?` (${i.join(", ")})`:""}`),o.push(`  ${n.message}`),n.error&&o.push(`  error: ${n.error}`),o.push("")}e.textContent=o.join(`
`),e.scrollTop=0}function xa(e){function t(r){e.logsStatusEl.textContent=r}function o(r){e.debugStatusEl.textContent=r}function n(r){e.logsCbDebugEl.checked=r}function a(r){ht(e.logsOutEl,{total:r.total,items:r.items.map(u=>({ts:u.ts,message:u.message,scope:u.scope,kind:u.kind,ok:u.ok,status:u.status,error:u.error,meta:u.meta}))})}function i(r){ht(e.debugOutEl,{total:r.total,items:r.items.map(u=>({ts:u.ts,message:u.message,scope:u.scope,kind:u.kind,ok:u.ok,status:u.status,error:u.error,meta:u.meta}))})}return{setAuditStatus:t,setDebugStatus:o,setDebugChecked:n,renderAudit:a,renderDebug:i}}const vt="beecontour";function Ia(e,t){const o=Ea(),n=xa(e);async function a(){n.setAuditStatus("Loading…"),X(e,!0);try{const c=ee(e.logsLimitEl.value,10,5e3,200),f=await oa({limit:c,reverse:!0});o.set(f),n.renderAudit({items:o.items,total:o.total}),n.setAuditStatus(`Showing ${o.items.length} (newest first)`)}catch(c){n.setAuditStatus(`Failed: ${(c==null?void 0:c.message)||String(c)}`)}finally{X(e,!1)}}async function i(){n.setDebugStatus("Loading…"),X(e,!0);try{const c=ee(e.debugLimitEl.value,10,5e3,200),f=await Rt({limit:c,reverse:!0});n.renderDebug(f),n.setDebugStatus(`Showing ${f.items.length} (newest first)`)}catch(c){n.setDebugStatus(`Failed: ${(c==null?void 0:c.message)||String(c)}`)}finally{X(e,!1)}}async function r(){const c=await Qe();n.setDebugChecked(c)}async function u(c){if(await kt(c),n.setDebugChecked(c),!c){n.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}n.setDebugStatus("Debug ON."),await i()}async function g(){const c=ee(e.logsTrimKeepEl.value,0,5e4,2e3);n.setAuditStatus("Trimming…"),X(e,!0);try{const f=await aa({keepLast:c});await a(),n.setAuditStatus(`Trimmed. Remaining: ${f.total}`)}catch(f){n.setAuditStatus(`Trim failed: ${(f==null?void 0:f.message)||String(f)}`)}finally{X(e,!1)}}async function s(){n.setAuditStatus("Clearing…"),X(e,!0);try{await ia(),await a(),n.setAuditStatus("Cleared.")}catch(c){n.setAuditStatus(`Clear failed: ${(c==null?void 0:c.message)||String(c)}`)}finally{X(e,!1)}}async function l(){n.setAuditStatus("Exporting…");try{const c=await sa({pretty:!0}),f=new Blob([c],{type:"application/json"}),v=URL.createObjectURL(f),m=document.createElement("a");m.href=v,m.download=`${vt}-audit-${Date.now()}.json`,m.click(),setTimeout(()=>URL.revokeObjectURL(v),1e3),n.setAuditStatus("Exported.")}catch(c){n.setAuditStatus(`Export failed: ${(c==null?void 0:c.message)||String(c)}`)}}async function p(){n.setDebugStatus("Clearing…"),X(e,!0);try{await Mt(),await i(),n.setDebugStatus("Cleared.")}catch(c){n.setDebugStatus(`Clear failed: ${(c==null?void 0:c.message)||String(c)}`)}finally{X(e,!1)}}async function h(){n.setDebugStatus("Exporting…");try{const c=await Dt({pretty:!0}),f=new Blob([c],{type:"application/json"}),v=URL.createObjectURL(f),m=document.createElement("a");m.href=v,m.download=`${vt}-debug-${Date.now()}.json`,m.click(),setTimeout(()=>URL.revokeObjectURL(v),1e3),n.setDebugStatus("Exported.")}catch(c){n.setDebugStatus(`Export failed: ${(c==null?void 0:c.message)||String(c)}`)}}function d(){e.btnLogsRefresh.addEventListener("click",()=>{H()||a()}),e.btnLogsTrim.addEventListener("click",()=>{H()||g()}),e.btnLogsClear.addEventListener("click",()=>{H()||s()}),e.btnLogsExport.addEventListener("click",()=>{H()||l()}),e.logsCbDebugEl.addEventListener("change",()=>{H()||u(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{H()||i()}),e.btnDebugClear.addEventListener("click",()=>{H()||p()}),e.btnDebugExport.addEventListener("click",()=>{H()||h()})}return{id:"logs",bind:d,mount(){r(),a(),i()},unmount(){},dispose(){}}}function Sa(e,t){if(e.id===t)return e;const o=[...e.children??[]];for(;o.length>0;){const n=o.shift();if(n.id===t)return n;for(const a of n.children??[])o.push(a)}throw new Error(`[tuning] scopeRootId not found in VM tree: ${t}`)}function ka(e,t){if(e.id===t)return e;const o=[...e.children??[]];for(;o.length>0;){const n=o.shift();if(n.id===t)return n;for(const a of n.children??[])o.push(a)}return null}function Ma(e){const t=Xe({getRuntimeAvailability:e.getRuntimeAvailability}),o=[];let n=!1;async function a(){return await t.loadTree("app")}async function i(){if(n)return;const m=await a();for(const y of o){if(y.scopeRootId==="app"){y.view.render(m);continue}const x=Sa(m.root,y.scopeRootId);y.view.render({...m,scopeId:y.scopeRootId,root:x})}}async function r(m,y){await t.setEnginePolicy(m,y),e.actionLogAppend(`[tuning] policy ${m} = ${y}`),e.debugTraceAppend(`[tuning] setPolicy id=${m} policy=${y}`),await i()}async function u(m,y,x){await t.setParam(m,y,x),e.actionLogAppend(`[tuning] param ${m}.${y} = ${String(x)}`),e.debugTraceAppend(`[tuning] setParam id=${m} key=${y} value=${String(x)}`),await i()}async function g(m){await t.resetNode(m),e.actionLogAppend(`[tuning] reset node ${m}`),e.debugTraceAppend(`[tuning] resetNode id=${m}`),await i()}async function s(m,y){await t.resetParam(m,y),e.actionLogAppend(`[tuning] reset param ${m}.${y}`),e.debugTraceAppend(`[tuning] resetParam id=${m} key=${y}`),await i()}async function l(m){var y,x;if(!n){if(m.policies)for(const w of m.policies)await t.setEnginePolicy(w.id,w.policy);if(m.params)for(const w of m.params)await t.setParam(w.id,w.key,w.value);e.actionLogAppend(`[tuning] preset ${m.id} (${m.title})`),e.debugTraceAppend(`[tuning] applyPreset id=${m.id} title=${m.title} policies=${((y=m.policies)==null?void 0:y.length)??0} params=${((x=m.params)==null?void 0:x.length)??0}`),await i()}}async function p(m){const y=await a(),x=ka(y.root,m);if(!x)throw new Error(`[tuning] getEffectiveParams: unknown component id ${m}`);return{...x.effectiveParams??{}}}async function h(m,y,x){await t.setParam(m,y,x),e.actionLogAppend(`[tuning] param ${m}.${y} = ${String(x)}`),e.debugTraceAppend(`[tuning] setParamValue id=${m} key=${y} value=${String(x)}`),await i()}function d(m){if(n)return;const{mountEl:y,scopeRootId:x}=m;if(o.some(I=>I.mountEl===y))return;const w=Ut(y,{onSetPolicy:r,onSetParam:u,onResetNode:g,onResetParam:s});o.push({mountEl:y,scopeRootId:x,view:w}),i()}function c(m){const y=o.findIndex(x=>x.mountEl===m);y<0||(o[y].view.dispose(),o.splice(y,1))}async function f(){await i()}function v(){n=!0;for(const m of o)m.view.dispose();o.length=0}return{mount:d,unmount:c,refresh:f,applyPreset:l,getEffectiveParams:p,setParamValue:h,dispose:v}}function B(e,t,o){const n=document.createElement(e);if(t)for(const[a,i]of Object.entries(t))n.setAttribute(a,i);return typeof o=="string"&&(n.textContent=o),n}function yt(e){return e.type==="image"}function bt(e){return e.type==="mask"}function we(e,t){e.width=t.width,e.height=t.height;const o=e.getContext("2d",{willReadFrequently:!0});o&&o.putImageData(t,0,0)}function Ue(e,t,o,n){e.width=o,e.height=n;const a=e.getContext("2d",{willReadFrequently:!0});if(!a)return;let i=0;const r=o*n;for(let l=0;l<r;l++){const p=t[l]??0;p>i&&(i=p)}const u=i<=1,g=a.createImageData(o,n),s=g.data;for(let l=0;l<r;l++){const p=t[l]??0;let h;u?h=(p>0?1:0)?0:255:h=p;const d=l*4;s[d]=h,s[d+1]=h,s[d+2]=h,s[d+3]=255}a.putImageData(g,0,0)}function Ra(e){const{hostEl:t,statusEl:o,handlers:n}=e;let a=!1,i=null,r=null,u=null,g=null,s=null,l=null,p=null,h=null,d=null,c=null;function f(){for(;t.firstChild;)t.removeChild(t.firstChild)}function v(){if(a)return;a=!0,f(),i=B("div",{class:"card"}),p=B("p",{class:"muted",style:"margin-top:0;"},"Universal pipeline runner. Select a pipeline and run it.");const b=B("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),k=B("label",{class:"fieldInline"});k.appendChild(B("span",{},"Pipeline")),r=B("select"),k.appendChild(r);const C=B("label",{class:"fieldInline"});C.appendChild(B("span",{},"Recipe")),u=B("select"),C.appendChild(u),g=B("button",{type:"button"},"Run all"),s=B("button",{type:"button"},"Next step"),l=B("button",{type:"button"},"Reset"),b.appendChild(k),b.appendChild(C),b.appendChild(g),b.appendChild(s),b.appendChild(l);const M=B("div",{class:"grid4",style:"margin-top:12px;"}),E=B("div",{class:"card"});E.appendChild(B("div",{class:"cardTitle"},"Input (from source)")),h=B("canvas",{class:"canvas","aria-label":"Pipeline input preview"}),E.appendChild(h);const S=B("div",{class:"card"});S.appendChild(B("div",{class:"cardTitle"},"Current output")),d=B("canvas",{class:"canvas","aria-label":"Pipeline current output preview"}),S.appendChild(d);const P=B("div",{class:"card",style:"grid-column:1 / -1;"});P.appendChild(B("div",{class:"cardTitle"},"Stages")),c=B("div"),P.appendChild(c),M.appendChild(E),M.appendChild(S),M.appendChild(P),i.appendChild(p),i.appendChild(b),i.appendChild(M),t.appendChild(i),r.addEventListener("change",()=>{const L=r?r.value:"segmentation";n.onSelectPipeline(L)}),u.addEventListener("change",()=>{const L=u?u.value:"default";n.onSelectRecipe(L)}),g.addEventListener("click",()=>n.onRunAll()),s.addEventListener("click",()=>n.onNext()),l.addEventListener("click",()=>n.onReset())}function m(b){if(!r||!u)return;const k=Array.isArray(b==null?void 0:b.pipelines)?b.pipelines:[],C=Array.isArray(b==null?void 0:b.recipes)?b.recipes:[],M=typeof(b==null?void 0:b.activePipelineId)=="string"?b.activePipelineId:"segmentation",E=typeof(b==null?void 0:b.activeRecipeId)=="string"?b.activeRecipeId:"default";r.innerHTML="";for(const S of k){const P=B("option");P.value=S.id,P.textContent=S.title,S.id===M&&(P.selected=!0),r.appendChild(P)}u.innerHTML="";for(const S of C){const P=B("option");P.value=S.id,P.textContent=S.title,S.id===E&&(P.selected=!0),u.appendChild(P)}}function y(b){var C;if(!h)return;const k=(C=b==null?void 0:b.input)==null?void 0:C.data;if(!k){h.width=1,h.height=1;const M=h.getContext("2d");M&&M.clearRect(0,0,h.width,h.height);return}we(h,k)}function x(b){var P,L,$,R;if(!d)return;const k=(P=b==null?void 0:b.outputImage)==null?void 0:P.data;if(k){we(d,k);return}const C=(L=b==null?void 0:b.outputMask)==null?void 0:L.data,M=($=b==null?void 0:b.outputMask)==null?void 0:$.width,E=(R=b==null?void 0:b.outputMask)==null?void 0:R.height;if(C&&typeof M=="number"&&typeof E=="number"){Ue(d,C,M,E);return}d.width=1,d.height=1;const S=d.getContext("2d");S&&S.clearRect(0,0,d.width,d.height)}function w(b){if(!c)return;c.innerHTML="";const k=Array.isArray(b==null?void 0:b.stages)?b.stages:[];if(!k.length){c.appendChild(B("div",{class:"muted",style:"font-size:12px;"},"No stages."));return}const C=B("div",{style:"display:flex; flex-direction:column; gap:10px;"});for(const M of k)C.appendChild(I(M));c.appendChild(C)}function I(b){const k=B("div",{class:"card",style:"padding:10px;"}),C=B("div",{class:"row",style:"align-items:center; justify-content:space-between;"});C.appendChild(B("div",{style:"font-weight:bold;"},String(b.title??b.stageId))),C.appendChild(B("div",{class:"status"},String(b.state??"idle"))),k.appendChild(C),k.appendChild(B("div",{class:"muted",style:"font-size:12px;"},`${b.input} -> ${b.output}`));const M=b.outputArtifact;if(M){const S=B("canvas",{class:"canvas",style:"margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:260px; width:auto; height:auto;"});yt(M)&&we(S,M.image),bt(M)&&Ue(S,M.mask,M.width,M.height),k.appendChild(S)}const E=Array.isArray(b.ops)?b.ops:[];if(E.length){const S=B("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:8px;"});for(let P=0;P<E.length;P++){const L=E[P],$=P===E.length-1,R=B("div",{class:"card",style:"padding:8px;"}),D=B("div",{class:"row",style:"align-items:center; justify-content:space-between;"});D.appendChild(B("div",{style:"font-weight:bold; font-size:12px;"},String(L.title??L.opId))),D.appendChild(B("div",{class:"status"},String(L.state??"idle"))),R.appendChild(D),R.appendChild(B("div",{class:"muted",style:"font-size:12px;"},`${L.input} -> ${L.output}`));const T=M&&$?void 0:L.outputArtifact;if(T){const N=B("canvas",{class:"canvas",style:"margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:200px; width:auto; height:auto;"});yt(T)&&we(N,T.image),bt(T)&&Ue(N,T.mask,T.width,T.height),R.appendChild(N)}S.appendChild(R)}k.appendChild(S)}return k}return{mount(){v()},render(b){if(v(),m(b),o.textContent=typeof(b==null?void 0:b.statusText)=="string"?b.statusText:"Idle",p){const k=typeof(b==null?void 0:b.description)=="string"?b.description:"Universal pipeline runner.";p.textContent=k}y(b),x(b),w(b)},dispose(){a=!1,i=null,r=null,u=null,g=null,s=null,l=null,p=null,h=null,d=null,c=null,f()}}}function Da(e,t){return`${e}.${t+1}`}function Pa(e){return{width:e.width,height:e.height}}function wt(e,t){return e.find(o=>o.id===t)??null}function Ta(){const e=[{kind:"dispatch",id:"op.seg.resize",title:"Resize",io:{input:"image",output:"image"},dispatchId:"segmentation.resize",tuningId:"segmentation.resize"},{kind:"dispatch",id:"op.seg.denoise",title:"Denoise",io:{input:"image",output:"image"},dispatchId:"segmentation.denoise",tuningId:"segmentation.denoise"},{kind:"dispatch",id:"op.seg.color",title:"Color / Gray",io:{input:"image",output:"image"},dispatchId:"segmentation.color",tuningId:"segmentation.color"},{kind:"dispatch",id:"op.seg.threshold",title:"Threshold",io:{input:"image",output:"mask"},dispatchId:"segmentation.threshold",tuningId:"segmentation.threshold"},{kind:"dispatch",id:"op.seg.morphology",title:"Morphology cleanup",io:{input:"mask",output:"mask"},dispatchId:"segmentation.morphology",tuningId:"segmentation.morphology"},{kind:"js",id:"op.util.pass",title:"Pass-through",io:{input:"image",output:"image"},run:({input:i})=>i}],t=[{id:"segmentation",title:"Segmentation",implemented:!0,description:"Multi-step segmentation pipeline (image -> mask).",stages:[{id:"stage.seg.prep",title:"Prep",io:{input:"image",output:"image"},allowedOps:["op.seg.resize","op.util.pass"],defaultOps:["op.seg.resize"]},{id:"stage.seg.denoise",title:"Denoise",io:{input:"image",output:"image"},allowedOps:["op.seg.denoise","op.util.pass"],defaultOps:["op.seg.denoise"]},{id:"stage.seg.features",title:"Color / channel features",io:{input:"image",output:"image"},allowedOps:["op.seg.color","op.util.pass"],defaultOps:["op.seg.color"]},{id:"stage.seg.binarize",title:"Binarize",io:{input:"image",output:"mask"},allowedOps:["op.seg.threshold"],defaultOps:["op.seg.threshold"]},{id:"stage.seg.cleanup",title:"Mask cleanup",io:{input:"mask",output:"mask"},allowedOps:["op.seg.morphology"],defaultOps:["op.seg.morphology"]}]},{id:"surface",title:"Surface",implemented:!1,description:"Future: region labeling + vectorize pipeline.",stages:[]}];function o(i){return wt(t,i)}function n(i){return wt(e,i)}function a(i){const r=o(i);return r?{pipelineId:r.id,stages:r.stages.map(u=>({stageId:u.id,ops:(u.defaultOps??[]).map((g,s)=>({instanceId:Da(u.id,s),opId:g}))}))}:null}return{pipelines:t,ops:e,getPipeline:o,getOp:n,makeDefaultInstalled:a}}function Aa(e){return e.type==="image"}function La(e){return e.type==="mask"}function re(e){return{type:"image",width:e.width,height:e.height,image:e}}function Et(e,t,o){return{type:"mask",width:t,height:o,mask:e}}function de(e,t){return`IO mismatch: expected ${e}, got ${t}`}function Oa(e,t){if(t.length===0)return"Stage has no installed ops";if(t[0].io.input!==e.input)return de(e.input,t[0].io.input);for(let n=0;n<t.length-1;n++){const a=t[n],i=t[n+1];if(a.io.output!==i.io.input)return`Chain IO mismatch between "${a.title}" (${a.io.output}) -> "${i.title}" (${i.io.input})`}const o=t[t.length-1];return o.io.output!==e.output?de(e.output,o.io.output):null}async function Ba(e,t,o){if(e.io.input==="image"){if(!Aa(t))throw new Error(de("image",t.type));const{width:r,height:u}=t;if(e.io.output==="image"){const s=await te(e.dispatchId,{image:t.image,width:r,height:u});return re(s)}const g=await te(e.dispatchId,{image:t.image,width:r,height:u});return Et(g,r,u)}if(!La(t))throw new Error(de("mask",t.type));const{width:n,height:a}=t;if(e.io.output!=="mask")throw new Error("Invalid op spec: mask input cannot produce image (not supported here)");const i=await te(e.dispatchId,{mask:t.mask,width:n,height:a});return Et(i,n,a)}async function $a(e,t,o){if(e.kind==="dispatch")return await Ba(e,t);const n=e.tuningId?await o.getEffectiveParams(e.tuningId).catch(()=>({})):{};return await e.run({input:t,params:n})}async function Na(e){var s;const{catalogue:t,installed:o,inputImage:n,deps:a}=e,i=t.getPipeline(o.pipelineId);if(!i)return{pipelineId:o.pipelineId,title:o.pipelineId,status:"error",error:`Unknown pipelineId: ${o.pipelineId}`,input:re(n),stages:[]};if(!i.implemented)return{pipelineId:i.id,title:i.title,status:"error",error:"Not implemented yet",input:re(n),stages:[]};const r=new Map;for(const l of o.stages)r.set(l.stageId,l);const u=[];let g=re(n);for(const l of i.stages){const p=r.get(l.id),h=(s=p==null?void 0:p.ops)!=null&&s.length?p.ops:(l.defaultOps??[]).map((w,I)=>({instanceId:`${l.id}.${I+1}`,opId:w})),d=[],c=[];let f=null;for(const w of h){const I=t.getOp(w.opId);if(!I){f=`Unknown opId: ${w.opId}`;break}if(!l.allowedOps.includes(I.id)){f=`Op not allowed in this stage: ${I.title} (${I.id})`;break}d.push(I)}if(!f){const w=Oa(l.io,d);w&&(f=w)}if(f){const w={stageId:l.id,title:l.title,io:l.io,status:"error",error:f,ops:h.map(I=>({instanceId:I.instanceId,opId:I.opId,title:I.opId,io:{input:l.io.input,output:l.io.output},status:"error",error:f}))};return u.push(w),a.debug("pipeline stage failed (validation)",{pipelineId:i.id,stageId:l.id,error:f}),{pipelineId:i.id,title:i.title,status:"error",error:`Stage "${l.title}" failed: ${f}`,input:re(n),stages:u}}let v=g,m=!0,y;for(let w=0;w<d.length;w++){const I=h[w],b=d[w];try{if(b.io.input!==v.type)throw new Error(de(b.io.input,v.type));const k=await $a(b,v,a);if(k.type!==b.io.output)throw new Error(de(b.io.output,k.type));c.push({instanceId:I.instanceId,opId:b.id,title:b.title,io:b.io,status:"ok",output:k}),v=k}catch(k){m=!1,y=k instanceof Error?k.message:String(k),c.push({instanceId:I.instanceId,opId:b.id,title:b.title,io:b.io,status:"error",error:y}),a.debug("pipeline op failed",{pipelineId:i.id,stageId:l.id,opId:b.id,error:y,...Pa(v)});break}}const x={stageId:l.id,title:l.title,io:l.io,status:m?"ok":"error",error:m?void 0:y,ops:c,output:m?v:void 0};if(u.push(x),!m)return{pipelineId:i.id,title:i.title,status:"error",error:`Stage "${l.title}" failed: ${y??"unknown error"}`,input:re(n),stages:u};g=v}return{pipelineId:i.id,title:i.title,status:"ok",input:re(n),output:g,stages:u}}function Va(e){var $;const t=Ta();let o=(($=t.pipelines[0])==null?void 0:$.id)??"segmentation",n="default",a=null,i=null,r="Idle",u=[],g=0,s=null,l={},p={},h=null,d={},c={};function f(){return t.getPipeline(o)??t.pipelines[0]}function v(R){const D={id:"default",title:"Default",buildInstalled:()=>{const T=t.makeDefaultInstalled(R.id);if(!T)throw new Error(`Cannot build default installed for pipeline: ${R.id}`);return T}};if(R.id==="segmentation"){const T=R.stages.map(A=>A.id);return[D,{id:"fast",title:"Fast (minimal)",buildInstalled:()=>({pipelineId:R.id,stages:T.map(A=>A.endsWith("prep")?{stageId:A,ops:[{instanceId:`${A}.1`,opId:"op.seg.resize"}]}:A.endsWith("binarize")?{stageId:A,ops:[{instanceId:`${A}.1`,opId:"op.seg.threshold"}]}:A.endsWith("cleanup")?{stageId:A,ops:[{instanceId:`${A}.1`,opId:"op.seg.morphology"}]}:{stageId:A,ops:[{instanceId:`${A}.1`,opId:"op.util.pass"}]})})},{id:"strong",title:"Strong cleanup (double morphology)",buildInstalled:()=>({pipelineId:R.id,stages:T.map(A=>{var W;if(A.endsWith("cleanup"))return{stageId:A,ops:[{instanceId:`${A}.1`,opId:"op.seg.morphology"},{instanceId:`${A}.2`,opId:"op.seg.morphology"}]};const U=((W=R.stages.find(O=>O.id===A))==null?void 0:W.defaultOps)??[];return{stageId:A,ops:U.map((O,Y)=>({instanceId:`${A}.${Y+1}`,opId:O}))}})})}]}return[D]}function m(){const R=f(),D=v(R),T=D.find(N=>N.id===n)??D[0];n=T.id,a=T.buildInstalled(R)}function y(){l={},p={},u=[],g=0,s=null,h=null,d={},c={},r=f().implemented?"Ready":"Not implemented yet"}function x(){m(),y()}function w(R){R!==o&&t.getPipeline(R)&&(o=R,n="default",x())}function I(R){R!==n&&(n=R,x())}function b(R){i=R,y()}function k(){return a||m(),a}function C(R,D){const T=f(),N=T.stages.find(U=>U.id===R);if(!N)return;const F=D.filter(U=>N.allowedOps.includes(U)),A=k().stages.map(U=>U.stageId!==R?U:{stageId:R,ops:F.map((W,O)=>({instanceId:`${R}.${O+1}`,opId:W}))});a={pipelineId:T.id,stages:A},y()}function M(){const R=f(),D=k(),T=new Map(R.stages.map(A=>[A.id,A])),N=new Map(t.ops.map(A=>[A.id,A])),F=[];for(const A of D.stages){const U=T.get(A.stageId);if(U)for(const W of A.ops){const O=N.get(W.opId);O&&(O.kind==="dispatch"?F.push({stageId:A.stageId,stageTitle:U.title,stageInput:U.io.input,stageOutput:U.io.output,instanceId:W.instanceId,opId:O.id,opTitle:O.title,opInput:O.io.input,opOutput:O.io.output,kind:"dispatch",dispatchId:O.dispatchId,tuningId:O.tuningId}):F.push({stageId:A.stageId,stageTitle:U.title,stageInput:U.io.input,stageOutput:U.io.output,instanceId:W.instanceId,opId:O.id,opTitle:O.title,opInput:O.io.input,opOutput:O.io.output,kind:"js",tuningId:O.tuningId,runJs:O.run}))}}u=F}function E(R){l={},p={},d={},c={};for(const D of R.stages){p[D.stageId]=D.status==="ok"?"ok":"error",D.output&&(c[D.stageId]=D.output);for(const T of D.ops)l[T.instanceId]=T.status==="ok"?"ok":"error",T.output&&(d[T.instanceId]=T.output)}h=R.output??null,r=R.status==="ok"?"Done":R.error??"Error"}async function S(){if(!f().implemented){r="Not implemented yet";return}if(!i){r="No input image";return}r="Running all…",l={},p={},d={},c={},g=0;const D=await Na({catalogue:t,installed:k(),inputImage:i,deps:e.runner});E(D),M(),g=u.length}async function P(){const R=f();if(!R.implemented){r="Not implemented yet";return}if(!i){r="No input image";return}if(u.length===0&&M(),u.length===0){r="No ops installed";return}if(s||(s={type:"image",width:i.width,height:i.height,image:i},h=null,l={},p={},d={},c={},g=0),g>=u.length){r="Done";return}const D=u[g];try{if(r=`Running: ${D.stageTitle} → ${D.opTitle}`,s.type!==D.opInput)throw new Error(`IO mismatch: expected ${D.opInput}, got ${s.type}`);const T=D.tuningId?await e.runner.getEffectiveParams(D.tuningId).catch(()=>({})):{};let N;if(D.kind==="dispatch"){const F=s.width,A=s.height;if(s.type==="image"){const U=s.image,W=await te(D.dispatchId,{image:U,width:F,height:A,params:T});if(D.opOutput==="image"){const O=W;N={type:"image",width:O.width,height:O.height,image:O}}else N={type:"mask",width:F,height:A,mask:W}}else{const U=await te(D.dispatchId,{mask:s.mask,width:F,height:A,params:T});N={type:"mask",width:F,height:A,mask:U}}}else{if(!D.runJs)throw new Error("Missing js op implementation");N=await D.runJs({input:s,params:T})}if(N.type!==D.opOutput)throw new Error(`IO mismatch: expected ${D.opOutput}, got ${N.type}`);l[D.instanceId]="ok",p[D.stageId]="ok",d[D.instanceId]=N,c[D.stageId]=N,s=N,h=N,g+=1,r=g>=u.length?"Done":"Ready"}catch(T){const N=T instanceof Error?T.message:String(T);l[D.instanceId]="error",p[D.stageId]="error",r=`Error: ${D.opTitle}`,e.runner.debug("pipeline next-step failed",{pipelineId:R.id,recipeId:n,stageId:D.stageId,instanceId:D.instanceId,opId:D.opId,error:N})}}function L(){const R=f(),D=v(R),T=t.pipelines.map(O=>({id:O.id,title:O.title})),N=k(),F=new Map(R.stages.map(O=>[O.id,O])),A=new Map(t.ops.map(O=>[O.id,O])),U=N.stages.map(O=>{const Y=F.get(O.stageId);if(!Y)return null;const ve=O.ops.map(ne=>{const ie=A.get(ne.opId);return ie?{instanceId:ne.instanceId,opId:ie.id,title:ie.title,input:ie.io.input,output:ie.io.output,state:l[ne.instanceId]??"idle",outputArtifact:d[ne.instanceId]}:null}).filter(Boolean),De=p[O.stageId]??(ve.some(ne=>ne.state==="error")?"error":"idle");return{stageId:O.stageId,title:Y.title,input:Y.io.input,output:Y.io.output,ops:ve,state:De,outputArtifact:c[O.stageId]}}).filter(Boolean),W={pipelines:T,recipes:D.map(O=>({id:O.id,title:O.title})),activePipelineId:o,activeRecipeId:n,statusText:r,stages:U,input:i?{width:i.width,height:i.height,data:i}:void 0,nextIndex:g,totalOps:u.length||U.reduce((O,Y)=>O+Y.ops.length,0)};return(h==null?void 0:h.type)==="image"?W.outputImage={width:h.width,height:h.height,data:h.image}:(h==null?void 0:h.type)==="mask"&&(W.outputMask={width:h.width,height:h.height,data:h.mask}),W}return x(),{getVm:L,setActivePipeline:w,setActiveRecipe:I,setInputImageData:b,getInstalled:k,setStageOps:C,runAll:S,runNext:P,reset:x}}function za(e,t,o){const n=Va({runner:{getEffectiveParams:async C=>await o.getEffectiveParams(C).catch(()=>({})),debug:(C,M)=>fe({scope:"panel",kind:"debug",message:C,meta:M})}});let a=null,i=!1,r=null;function u(){e.pipelineTuningMountEl.innerHTML=""}function g(C){return[C,`pipeline.${C}`,"pipeline"]}function s(C){const M=g(C);if(r===M[0])return;u();let E=null,S=null;for(const P of M)try{o.mount({mountEl:e.pipelineTuningMountEl,scopeRootId:P}),E=P;break}catch(L){S=L,u()}if(!E){r=null,j({scope:"panel",kind:"info",message:`Pipeline tuning mount failed for "${C}" (no matching scope).`}),fe({scope:"panel",kind:"error",message:"Pipeline tuning mount failed (no candidate scopeRootId worked)",meta:{pipelineId:C,candidates:M,error:S instanceof Error?S.message:String(S)}});return}r=E,j({scope:"panel",kind:"info",message:`Pipeline tuning mount: pipelineId=${C}, scopeRootId=${E}`})}function l(){const C=n.getVm(),M=typeof C.activePipelineId=="string"?C.activePipelineId:"segmentation";s(M)}function p(){const C=e.srcCanvasEl,M=C.width,E=C.height;if(!M||!E)return null;const S=C.getContext("2d",{willReadFrequently:!0});return S?S.getImageData(0,0,M,E):null}function h(){if(n.getVm().input)return;const M=p();M&&n.setInputImageData(M)}function d(){const C=p();C&&n.setInputImageData(C)}async function c(){const C=await o.getEffectiveParams("pipeline").catch(()=>({})),M=C==null?void 0:C.mode,E=C==null?void 0:C.recipe,S=typeof M=="string"?M:"segmentation",P=typeof E=="string"?E:"default";n.setActivePipeline(S),n.setActiveRecipe(P),l()}function f(){return a||(j({scope:"panel",kind:"info",message:"Pipeline view: create + mount"}),a=Ra({hostEl:e.pipelineViewMountEl,statusEl:e.pipelineStatusEl,handlers:{onSelectPipeline:C=>{j({scope:"panel",kind:"info",message:`Pipeline select: ${C}`}),n.setActivePipeline(C),o.setParamValue("pipeline","mode",C),l(),v()},onSelectRecipe:C=>{j({scope:"panel",kind:"info",message:`Recipe select: ${C}`}),n.setActiveRecipe(C),o.setParamValue("pipeline","recipe",C),v()},onRunAll:()=>void m(),onNext:()=>void y(),onReset:()=>{n.reset();const C=p();C&&n.setInputImageData(C),j({scope:"panel",kind:"info",message:"Pipeline reset (reseed from source)"}),l(),v()}}}),a.mount(),l(),a)}function v(){f().render(n.getVm())}async function m(){j({scope:"panel",kind:"info",message:"Pipeline run: all"}),d();try{await n.runAll()}finally{v()}}async function y(){j({scope:"panel",kind:"info",message:"Pipeline run: next"}),h();try{await n.runNext()}finally{v()}}function x(){}async function w(){i=!0,j({scope:"panel",kind:"info",message:"Pipeline tab: mount()"}),d(),await c(),j({scope:"panel",kind:"info",message:"Pipeline tab: render()"}),v()}async function I(){i&&(j({scope:"panel",kind:"info",message:"Pipeline tab: refresh()"}),d(),await c(),v())}function b(){i=!1,j({scope:"panel",kind:"info",message:"Pipeline tab: unmount()"})}function k(){j({scope:"panel",kind:"info",message:"Pipeline tab: dispose()"}),a==null||a.dispose(),a=null,r=null,u()}return{bind:x,mount:w,unmount:b,refresh:I,dispose:k}}async function Ua(){const e=Bn();await _e().catch(()=>null);const t=Vn();t.start();const o=_n();globalThis.__APP__={...globalThis.__APP__,cache:o};const n=Ma({getRuntimeAvailability:()=>({opencvReady:!1}),debugTraceAppend:p=>fe({scope:"panel",kind:"debug",message:p}),actionLogAppend:p=>j({scope:"panel",kind:"info",message:p})});n.mount({mountEl:e.tuningMountEl,scopeRootId:"app"}),n.mount({mountEl:e.contourTuningMountEl,scopeRootId:"contour"}),n.mount({mountEl:e.segTuningMountEl,scopeRootId:"segmentation"});const a=No(e),i=Zo(e),r=_o(e,t,n),u=za(e,t,n),g=wa(e,t),s=Ia(e);a.bind(),r.bind(),u.bind(),i.bind(),g.bind(),s.bind();const l=jn(e,{contour:a,segmentation:r,pipeline:u,colors:i,settings:g,logs:s});l.bind(),l.boot()}Ua();
