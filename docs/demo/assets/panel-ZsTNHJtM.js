function At(){function e(Se,Rt){if(!Se)throw new Error(`[dom] Missing #${Rt}`);return Se}const t=e(document.getElementById("appRoot"),"appRoot"),o=e(document.getElementById("tabContour"),"tabContour"),n=e(document.getElementById("tabColors"),"tabColors"),s=e(document.getElementById("tabSettings"),"tabSettings"),i=e(document.getElementById("tabLogs"),"tabLogs"),d=e(document.getElementById("tabSegmentation"),"tabSegmentation"),c=e(document.getElementById("viewContour"),"viewContour"),f=e(document.getElementById("viewColors"),"viewColors"),r=e(document.getElementById("viewSettings"),"viewSettings"),g=e(document.getElementById("viewLogs"),"viewLogs"),b=e(document.getElementById("viewSegmentation"),"viewSegmentation"),y=e(document.getElementById("dropZone"),"dropZone"),l=e(document.getElementById("fileInput"),"fileInput"),a=e(document.getElementById("btnProcess"),"btnProcess"),u=e(document.getElementById("btnClean"),"btnClean"),v=e(document.getElementById("btnDownload"),"btnDownload"),h=e(document.getElementById("contourStatus"),"contourStatus"),p=e(document.getElementById("contourSpinner"),"contourSpinner"),C=e(document.getElementById("srcCanvas"),"srcCanvas"),w=e(document.getElementById("outCanvas"),"outCanvas"),S=e(document.getElementById("clean1Canvas"),"clean1Canvas"),x=e(document.getElementById("clean2Canvas"),"clean2Canvas"),E=e(document.getElementById("edgeThreshold"),"edgeThreshold"),m=e(document.getElementById("invertOutput"),"invertOutput"),k=e(document.getElementById("cleanMinArea"),"cleanMinArea"),D=e(document.getElementById("cleanRadius"),"cleanRadius"),L=e(document.getElementById("cleanBinaryThreshold"),"cleanBinaryThreshold"),M=e(document.getElementById("cleanQualityBadge"),"cleanQualityBadge"),T=e(document.getElementById("cleanQualityFill"),"cleanQualityFill"),I=e(document.getElementById("cleanQualityText"),"cleanQualityText"),R=e(document.getElementById("contourScale"),"contourScale"),U=e(document.getElementById("btnVectorize"),"btnVectorize"),V=e(document.getElementById("btnDownloadSvg"),"btnDownloadSvg"),G=e(document.getElementById("svgPreviewImg"),"svgPreviewImg"),z=e(document.getElementById("svgPreviewText"),"svgPreviewText"),Q=e(document.getElementById("pathSmoothIters"),"pathSmoothIters"),q=e(document.getElementById("colorsCanvas"),"colorsCanvas"),He=e(document.getElementById("palette"),"palette"),Ke=e(document.getElementById("btnColorsApply"),"btnColorsApply"),We=e(document.getElementById("btnColorsCancel"),"btnColorsCancel"),Je=e(document.getElementById("btnColorsReset"),"btnColorsReset"),Ye=e(document.getElementById("edgesDark"),"edgesDark"),Xe=e(document.getElementById("edgeMaskThreshold"),"edgeMaskThreshold"),Ze=e(document.getElementById("edgeDilate"),"edgeDilate"),et=e(document.getElementById("maxRegionPx"),"maxRegionPx"),tt=e(document.getElementById("colorsStatus"),"colorsStatus"),nt=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),ot=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),at=e(document.getElementById("devConfigDetails"),"devConfigDetails"),st=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),rt=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),it=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),lt=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),ct=e(document.getElementById("logsCbDebug"),"logsCbDebug"),ut=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),dt=e(document.getElementById("cfgStatus"),"cfgStatus"),gt=e(document.getElementById("cfgOpenCvSpinner"),"cfgOpenCvSpinner"),ft=e(document.getElementById("cfgOpenCvStatus"),"cfgOpenCvStatus"),bt=e(document.getElementById("cfgOpenCvReport"),"cfgOpenCvReport"),vt=e(document.getElementById("settingsEngineBox"),"settingsEngineBox"),ht=e(document.getElementById("cfgUseOpenCv"),"cfgUseOpenCv"),Et=e(document.getElementById("settingsVersion"),"settingsVersion"),pt=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),yt=e(document.getElementById("logsLimit"),"logsLimit"),mt=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),Ct=e(document.getElementById("logsStatus"),"logsStatus"),wt=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),St=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),xt=e(document.getElementById("btnLogsExport"),"btnLogsExport"),Dt=e(document.getElementById("btnLogsClear"),"btnLogsClear"),kt=e(document.getElementById("logsOut"),"logsOut"),Tt=e(document.getElementById("debugLimit"),"debugLimit"),Lt=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),It=e(document.getElementById("btnDebugExport"),"btnDebugExport"),Mt=e(document.getElementById("btnDebugClear"),"btnDebugClear"),Bt=e(document.getElementById("debugStatus"),"debugStatus"),Ot=e(document.getElementById("debugOut"),"debugOut");return{rootEl:t,tabContour:o,tabColors:n,tabSettings:s,tabLogs:i,tabSegmentation:d,viewContour:c,viewSegmentation:b,viewColors:f,viewSettings:r,viewLogs:g,dropZoneEl:y,fileInputEl:l,btnProcessEl:a,btnCleanEl:u,btnDownloadEl:v,contourStatusEl:h,contourSpinnerEl:p,srcCanvasEl:C,outCanvasEl:w,clean1CanvasEl:S,clean2CanvasEl:x,edgeThresholdEl:E,invertOutputEl:m,cleanMinAreaEl:k,cleanRadiusEl:D,cleanBinaryThresholdEl:L,cleanQualityBadgeEl:M,cleanQualityFillEl:T,cleanQualityTextEl:I,btnVectorizeEl:U,btnDownloadSvgEl:V,svgPreviewImgEl:G,svgPreviewTextEl:z,contourScaleEl:R,pathSmoothItersEl:Q,colorsCanvasEl:q,paletteEl:He,btnColorsApplyEl:Ke,btnColorsCancelEl:We,btnColorsResetEl:Je,edgesDarkEl:Ye,edgeMaskThresholdEl:Xe,edgeDilateEl:Ze,maxRegionPxEl:et,colorsStatusEl:tt,cfgShowDevToolsEl:nt,settingsGeneralStatusEl:ot,devConfigDetailsEl:at,cfgTraceConsoleEl:st,cfgActionLogMaxEl:rt,cfgDebugTraceMaxEl:it,cfgFailureLogsPerRunEl:lt,logsCbDebugEl:ct,btnCfgResetDefaults:ut,cfgStatusEl:dt,settingsVersionEl:Et,settingsGitHubLinkEl:pt,cfgOpenCvSpinner:gt,cfgOpenCvStatus:ft,cfgOpenCvReport:bt,settingsEngineBoxEl:vt,cfgUseOpenCvEl:ht,logsLimitEl:yt,btnLogsRefresh:mt,logsStatusEl:Ct,logsTrimKeepEl:wt,btnLogsTrim:St,btnLogsExport:xt,btnLogsClear:Dt,logsOutEl:kt,debugLimitEl:Tt,btnDebugRefresh:Lt,btnDebugExport:It,btnDebugClear:Mt,debugStatusEl:Bt,debugOutEl:Ot}}const Pt=new Set;function $t(e){Pt.add(e)}function Vt(){const e=new Set;function t(n){return e.add(n),()=>e.delete(n)}function o(){$t(s=>{for(const i of e)i(s)})}return{on:t,start:o}}const Ut=new Set;function Ae(e){for(const t of Ut)t(e,"local")}function J(e){const t=localStorage.getItem(e);if(t!==null)try{return JSON.parse(t)}catch{return t}}function Nt(e,t){localStorage.setItem(e,JSON.stringify(t))}async function K(e){if(typeof e=="string")return{[e]:J(e)};if(Array.isArray(e)){const o={};for(const n of e)o[n]=J(n);return o}const t={};for(const[o,n]of Object.entries(e))t[o]=localStorage.getItem(o)!==null?J(o):n;return t}async function W(e){const t={};for(const[o,n]of Object.entries(e)){const s=J(o);Nt(o,n),t[o]={oldValue:s,newValue:n}}Ae(t)}async function me(e){const t=Array.isArray(e)?e:[e],o={};for(const n of t){const s=J(n);localStorage.removeItem(n),o[n]={oldValue:s,newValue:void 0}}Ae(o)}function _(e,t,o,n){const s=Number(String(e??"").trim());return Number.isFinite(s)?Math.max(t,Math.min(o,Math.floor(s))):n}const he="beecontour.devConfig",$={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let Ee=!1,ne={...$};function Pe(e){const t=e||{};return{traceConsole:!!t.traceConsole,actionLogMax:_(t.actionLogMax??$.actionLogMax,100,5e4,$.actionLogMax),debugTraceMax:_(t.debugTraceMax??$.debugTraceMax,100,5e4,$.debugTraceMax),failureLogsPerRun:_(t.failureLogsPerRun??$.failureLogsPerRun,0,5e4,$.failureLogsPerRun)}}async function xe(){if(Ee)return;const e=await K([he]).catch(()=>({}));ne=Pe(e==null?void 0:e[he]),Ee=!0}function oe(){return ne}async function $e(e){ne=Pe(e),Ee=!0,await W({[he]:ne}).catch(()=>null)}async function Ft(){await $e({...$})}function jt(e,t){const o={segmentation:e.tabSegmentation,contour:e.tabContour,colors:e.tabColors,settings:e.tabSettings,logs:e.tabLogs},n={segmentation:e.viewSegmentation,contour:e.viewContour,colors:e.viewColors,settings:e.viewSettings,logs:e.viewLogs};let s="contour";const i=new Set;function d(){const l=oe();return!!(l!=null&&l.traceConsole)}function c(){const l=globalThis;l.__bctGlobalErrorHooksInstalled||(l.__bctGlobalErrorHooksInstalled=!0,window.addEventListener("error",a=>{var v;const u=a;console.error("[panel] window error",{message:u.message,filename:u.filename,lineno:u.lineno,colno:u.colno,error:u.error?String(u.error):null,stack:(v=u.error)!=null&&v.stack?String(u.error.stack):null})}),window.addEventListener("unhandledrejection",a=>{var u;console.error("[panel] unhandledrejection",{reason:a.reason?String(a.reason):null,stack:(u=a.reason)!=null&&u.stack?String(a.reason.stack):null})}),console.log("[panel] global error hooks installed (traceConsole enabled)"))}d()&&c();function f(l){Object.keys(o).forEach(a=>{const u=a===l;o[a].classList.toggle("is-active",u),o[a].setAttribute("aria-selected",u?"true":"false"),n[a].hidden=!u,n[a].classList.toggle("is-active",u)})}function r(l){var a,u,v,h,p,C,w,S;if(l===s){(u=(a=t[l]).refresh)==null||u.call(a);return}(h=(v=t[s]).unmount)==null||h.call(v),s=l,f(s),i.has(s)?(S=(w=t[s]).refresh)==null||S.call(w):(i.add(s),(C=(p=t[s]).mount)==null||C.call(p))}function g(){o.contour.addEventListener("click",l=>{var a;(a=l.preventDefault)==null||a.call(l),r("contour")}),o.segmentation.addEventListener("click",l=>{var a;(a=l.preventDefault)==null||a.call(l),r("segmentation")}),o.colors.addEventListener("click",l=>{var a;(a=l.preventDefault)==null||a.call(l),r("colors")}),o.settings.addEventListener("click",l=>{var a;(a=l.preventDefault)==null||a.call(l),r("settings")}),o.logs.addEventListener("click",l=>{var a;(a=l.preventDefault)==null||a.call(l),r("logs")})}function b(){var l,a,u,v;s="contour",f(s),Object.keys(t).forEach(h=>{var p,C;return(C=(p=t[h]).boot)==null?void 0:C.call(p)}),i.has(s)?(v=(u=t[s]).refresh)==null||v.call(u):(i.add(s),(a=(l=t[s]).mount)==null||a.call(l))}function y(){Object.keys(t).forEach(l=>{var a,u;return(u=(a=t[l]).dispose)==null?void 0:u.call(a)})}return{bind:g,boot:b,activate:r,dispose:y}}function De(e){const t=e.items.length;return{items:e.items,counts:{items:t},meta:e.meta}}function _t(){const e={items:[],meta:{}},t=new Set;function o(){const r=De(e);for(const g of t)try{g(r)}catch{}}function n(){return De(e)}function s(r){t.add(r);try{r(n())}catch{}return()=>t.delete(r)}function i(){e.items=[],e.meta={},o()}function d(r){e.meta.scopeUpdatedSince=r,o()}function c(){return String(e.meta.scopeUpdatedSince||"")}function f(r,g){e.items=r.slice(),e.meta.updatedTs=Date.now(),typeof(g==null?void 0:g.limit)=="number"&&(e.meta.limit=g.limit),o()}return{getSnapshot:n,subscribe:s,getScopeUpdatedSince:c,clearAll:i,setScopeUpdatedSince:d,setItems:f}}function zt(){return{loadedImageName:null,hasImage:!1,hasOutput:!1,edgeMask:void 0,repairedMask:void 0,smoothedMask:void 0,svgText:void 0}}function qt(e){e.loadedImageName=null,e.hasImage=!1,e.hasOutput=!1,e.edgeMask=void 0,e.repairedMask=void 0,e.smoothedMask=void 0,e.svgText=void 0}function Ve(e,t,o){const n=new Uint8Array(e.length);function s(v,h){return h*t+v}function i(v,h){return v<0||h<0||v>=t||h>=o?!1:e[s(v,h)]===1}let d=0,c=0,f=0,r=0,g=0;const b=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];for(let v=0;v<o;v++)for(let h=0;h<t;h++){if(!i(h,v))continue;d++;let p=0,C=!1;for(const[w,S]of b)i(h+w,v+S)?p++:C=!0;C&&c++,p===1?f++:p>=3&&r++}const y=[[-1,0],[1,0],[0,-1],[0,1]],l=new Int32Array(e.length),a=new Int32Array(e.length);for(let v=0;v<o;v++)for(let h=0;h<t;h++){const p=s(h,v);if(e[p]===0||n[p]===1)continue;g++,n[p]=1;let C=0,w=0;for(l[w]=h,a[w]=v,w++;C<w;){const S=l[C],x=a[C];C++;for(const[E,m]of y){const k=S+E,D=x+m;if(k<0||D<0||k>=t||D>=o)continue;const L=s(k,D);e[L]===0||n[L]===1||(n[L]=1,l[w]=k,a[w]=D,w++)}}}const u=d/Math.max(1,c);return{onPixels:d,boundaryPixels:c,components:g,endpoints:f,junctions:r,thicknessRatio:u}}function Gt(e,t){function o(l){e.contourStatusEl.textContent=l}function n(l,a){e.contourSpinnerEl.classList.toggle("is-hidden",!l),a&&o(a)}function s(){e.btnProcessEl.disabled=!t.hasImage,e.btnDownloadEl.disabled=!t.hasOutput,e.btnCleanEl.disabled=!t.hasOutput,e.btnVectorizeEl.disabled=!t.smoothedMask,e.btnDownloadSvgEl.disabled=!t.svgText}function i(){t.svgText=void 0,e.svgPreviewTextEl.textContent="",e.svgPreviewImgEl.removeAttribute("src")}function d(){const l=e.srcCanvasEl.getContext("2d"),a=e.outCanvasEl.getContext("2d");l.clearRect(0,0,e.srcCanvasEl.width,e.srcCanvasEl.height),a.clearRect(0,0,e.outCanvasEl.width,e.outCanvasEl.height);const u=e.clean1CanvasEl.getContext("2d"),v=e.clean2CanvasEl.getContext("2d");u.clearRect(0,0,e.clean1CanvasEl.width,e.clean1CanvasEl.height),v.clearRect(0,0,e.clean2CanvasEl.width,e.clean2CanvasEl.height)}function c(){const l=e.clean1CanvasEl.getContext("2d"),a=e.clean2CanvasEl.getContext("2d");l.clearRect(0,0,e.clean1CanvasEl.width,e.clean1CanvasEl.height),a.clearRect(0,0,e.clean2CanvasEl.width,e.clean2CanvasEl.height)}function f(l,a){const u=Number(l.value);return Number.isFinite(u)?u:a}function r(l,a){const u=a instanceof Error?a.message:String(a);o(`${l} failed: ${u}`),n(!1),console.error(`[BeeContour] ${l} failed`,a)}function g(l,a){if(!t.smoothedMask){e.cleanQualityBadgeEl.textContent="—",e.cleanQualityBadgeEl.className="qBadge qBadge--off",e.cleanQualityFillEl.style.width="0%",e.cleanQualityTextEl.textContent="";return}const u=Ve(t.smoothedMask,l,a),v=(k,D)=>Math.max(0,Math.min(1,k/Math.max(1,D))),h=v(u.components,800),p=v(u.endpoints,3e3),C=v(u.junctions,1500),w=u.thicknessRatio>5?1:u.thicknessRatio>3?.5:0,S=Math.round(100*(1-(.45*h+.45*p+.1*C)-.1*w)),x=Math.max(0,Math.min(100,S));let E="qBadge qBadge--bad",m=`Bad ${x}`;x>=70?(E="qBadge qBadge--ok",m=`Good ${x}`):x>=45&&(E="qBadge qBadge--warn",m=`OK ${x}`),e.cleanQualityBadgeEl.className=E,e.cleanQualityBadgeEl.textContent=m,e.cleanQualityFillEl.style.width=`${x}%`,e.cleanQualityTextEl.textContent=`CC:${u.components} end:${u.endpoints} j:${u.junctions} thick:${u.thicknessRatio.toFixed(2)}`}function b(){if(!t.hasOutput)return;const a=`${(t.loadedImageName||"beecontour").replace(/\.[a-z0-9]+$/i,"").replace(/[^a-z0-9-_]+/gi,"_")}_contour.png`,u=e.outCanvasEl.toDataURL("image/png"),v=document.createElement("a");v.href=u,v.download=a,document.body.appendChild(v),v.click(),v.remove(),o(`Downloaded: ${a}`)}function y(){if(!t.svgText)return;const a=`${(t.loadedImageName||"beecontour").replace(/\.[a-z0-9]+$/i,"").replace(/[^a-z0-9-_]+/gi,"_")}_contour.svg`,u=new Blob([t.svgText],{type:"image/svg+xml;charset=utf-8"}),v=URL.createObjectURL(u),h=document.createElement("a");h.href=v,h.download=a,document.body.appendChild(h),h.click(),h.remove(),URL.revokeObjectURL(v),o(`Downloaded: ${a}`)}return{setStatus:o,setContourBusyVisual:n,updateEnabled:s,clearSvgPreview:i,clearCanvases:d,clearCleanCanvasesOnly:c,getNumber:f,showError:r,updateCleanQualityUI:g,downloadPng:b,downloadSvg:y}}const Y="beecontour.debugTrace",pe="beecontour.debugTrace.enabled",Qt=2e3;function Ht(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function ye(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}async function ae(){const e=await K(Y),t=e==null?void 0:e[Y];return Array.isArray(t)?t:[]}async function Kt(e){await W({[Y]:e})}async function Ce(){const e=await K(pe);return!!(e!=null&&e[pe])}async function Ue(e){await W({[pe]:!!e}),e||await me(Y)}async function Ne(){await me(Y)}async function Fe(e,t){if(!await Ce())return{total:0};const n=ye((t==null?void 0:t.max)??Qt,100,5e4),s=(Array.isArray(e)?e:[e]).map(f=>({...f,id:Ht(),ts:Date.now()}));if(!s.length)return{total:(await ae()).length};const d=(await ae()).concat(s),c=d.length>n?d.slice(d.length-n):d;return await Kt(c),{total:c.length}}async function je(e){const t=ye((e==null?void 0:e.limit)??200,1,5e4),o=ye((e==null?void 0:e.offset)??0,0,1e6),n=(e==null?void 0:e.reverse)??!0,s=await ae(),i=s.length,c=(n?s.slice().reverse():s).slice(o,o+t);return{total:i,items:c}}async function _e(e){const t=await ae();return JSON.stringify(t,null,e!=null&&e.pretty?2:0)}const ze=Object.freeze(Object.defineProperty({__proto__:null,append:Fe,clear:Ne,exportJson:_e,isEnabled:Ce,list:je,setEnabled:Ue},Symbol.toStringTag,{value:"Module"}));function le(e){return`[BCT][${e}]`}function Wt(e){function t(...i){e.traceOn()&&console.log(le("trace"),...i)}function o(...i){console.warn(le("warn"),...i)}function n(...i){console.error(le("error"),...i)}function s(i,d){t(i,d),Fe({scope:e.scope,kind:"debug",message:i,meta:d})}return{logTrace:t,logWarn:o,logError:n,traceScope:s}}const{logTrace:B,logWarn:j,logError:N,traceScope:P}=Wt({scope:"panel",traceOn:()=>!!oe().traceConsole});let O=0;function A(){return O>0}function F(e,t){if(t){qe(e);return}O=0,se(e,!1)}async function Z(e,t){const o=`${Date.now()}-${Math.random().toString(16).slice(2)}`;B("[state] withBusy: enter",{id:o,busyCount:O}),qe(e,o);try{B("[state] withBusy: before await fn",{id:o,busyCount:O});const n=await t();return B("[state] withBusy: after await fn (resolved)",{id:o,busyCount:O}),n}catch(n){throw N("[state] withBusy: fn threw",{id:o,busyCount:O,msg:String((n==null?void 0:n.message)??n),stack:String((n==null?void 0:n.stack)??"")}),n}finally{B("[state] withBusy: finally before endBusy",{id:o,busyCount:O}),Jt(e,o),B("[state] withBusy: finally after endBusy",{id:o,busyCount:O})}}function qe(e,t){O++,B("[state] beginBusy",{id:t,busyCount:O}),O===1&&se(e,!0)}function Jt(e,t){if(O--,B("[state] endBusy: dec",{id:t,busyCount:O}),O<=0){O=0,B("[state] endBusy: applying busy=false",{id:t,busyCount:O}),se(e,!1);return}O===0&&(B("[state] endBusy: applying busy=false (redundant branch)",{id:t,busyCount:O}),se(e,!1))}function se(e,t){e.rootEl.classList.toggle("is-busy",t),e.cfgShowDevToolsEl.disabled=!1,e.fileInputEl.disabled=t,e.btnProcessEl.disabled=t,e.btnCleanEl.disabled=t,e.btnDownloadEl.disabled=t,e.edgeThresholdEl.disabled=t,e.invertOutputEl.disabled=t,e.cleanMinAreaEl.disabled=t,e.cleanRadiusEl.disabled=t,e.cleanBinaryThresholdEl.disabled=t,e.btnVectorizeEl.disabled=t,e.btnDownloadSvgEl.disabled=t,e.contourScaleEl.disabled=t,e.cfgTraceConsoleEl.disabled=t,e.cfgActionLogMaxEl.disabled=t,e.cfgDebugTraceMaxEl.disabled=t,e.cfgFailureLogsPerRunEl.disabled=t,e.btnCfgResetDefaults.disabled=t,e.logsCbDebugEl.disabled=t,e.cfgUseOpenCvEl.disabled=t,e.logsLimitEl.disabled=t,e.btnLogsRefresh.disabled=t,e.logsTrimKeepEl.disabled=t,e.btnLogsTrim.disabled=t,e.btnLogsExport.disabled=t,e.btnLogsClear.disabled=t,e.debugLimitEl.disabled=t,e.btnDebugRefresh.disabled=t,e.btnDebugExport.disabled=t,e.btnDebugClear.disabled=t,e.btnColorsApplyEl.disabled=t,e.btnColorsCancelEl.disabled=t,e.btnColorsResetEl.disabled=t,e.edgesDarkEl.disabled=t,e.edgeMaskThresholdEl.disabled=t,e.edgeDilateEl.disabled=t,e.maxRegionPxEl.disabled=t;for(const o of Array.from(e.paletteEl.querySelectorAll("button")))o.disabled=t;e.colorsCanvasEl.style.pointerEvents=t?"none":"auto"}function te(e,t,o){return Number.isFinite(e)?Math.max(t,Math.min(o,e|0)):t}function ke(e,t,o,n){const s=new ImageData(t,o),i=s.data;for(let d=0,c=0;d<e.length;d++,c+=4){const f=e[d]===1;if(n){const r=f?0:255;i[c]=r,i[c+1]=r,i[c+2]=r,i[c+3]=255}else{const r=f?255:0;i[c]=r,i[c+1]=r,i[c+2]=r,i[c+3]=255}}return s}function ce(e,t,o,n){const s=new Uint8Array(e.length),i=Math.max(1,n);for(let d=0;d<o;d++)for(let c=0;c<t;c++){let f=0;for(let r=-i;r<=i&&!f;r++){const g=d+r;if(g<0||g>=o)continue;const b=g*t;for(let y=-i;y<=i;y++){const l=c+y;if(!(l<0||l>=t)&&e[b+l]===1){f=1;break}}}s[d*t+c]=f}return s}function ue(e,t,o,n){const s=new Uint8Array(e.length),i=Math.max(1,n);for(let d=0;d<o;d++)for(let c=0;c<t;c++){let f=1;for(let r=-i;r<=i&&f;r++){const g=d+r;if(g<0||g>=o){f=0;break}const b=g*t;for(let y=-i;y<=i;y++){const l=c+y;if(l<0||l>=t){f=0;break}if(e[b+l]===0){f=0;break}}}s[d*t+c]=f}return s}function Yt(e,t,o,n){const s=new Uint8Array(e),i=new Uint8Array(e.length),d=new Int32Array(e.length),c=new Int32Array(e.length);for(let f=0;f<o;f++)for(let r=0;r<t;r++){const g=f*t+r;if(e[g]===0||i[g]===1)continue;let b=0,y=0;i[g]=1,d[y]=r,c[y]=f,y++;const l=[g];for(;b<y;){const a=d[b],u=c[b];b++;const v=[[a-1,u],[a+1,u],[a,u-1],[a,u+1]];for(const[h,p]of v){if(h<0||h>=t||p<0||p>=o)continue;const C=p*t+h;e[C]===0||i[C]===1||(i[C]=1,d[y]=h,c[y]=p,y++,l.push(C))}}if(l.length<n)for(const a of l)s[a]=0}return s}async function Te(e,t,o,n){const{setStatus:s,setContourBusyVisual:i,clearCanvases:d,clearCleanCanvasesOnly:c,clearSvgPreview:f,updateEnabled:r,getNumber:g}=n;if(!o.type.startsWith("image/")){s("Unsupported file type (please drop an image)."),j("Contour load: rejected non-image file",{name:o.name,type:o.type,size:o.size}),P("Contour load: rejected non-image file",{name:o.name,type:o.type,size:o.size});return}const b=performance.now();await Z(e,async()=>{i(!0,"Loading image…"),t.loadedImageName=o.name||"image";const y=URL.createObjectURL(o);P("Contour load: start",{name:o.name,type:o.type,size:o.size});try{const l=await new Promise((x,E)=>{const m=new Image;m.onload=()=>x(m),m.onerror=()=>E(new Error("Failed to load image")),m.src=y}),a=e.srcCanvasEl,u=a.getContext("2d");if(!u){N("Contour load: missing 2D context",{canvasId:"srcCanvasEl"}),s("Load failed — canvas context not available.");return}d();const v=te(g(e.contourScaleEl,100),10,100),h=v/100;let p=Math.max(64,Math.floor(l.naturalWidth*h)),C=Math.max(64,Math.floor(l.naturalHeight*h));const w=1600,S=Math.min(1,w/Math.max(p,C));p=Math.max(64,Math.floor(p*S)),C=Math.max(64,Math.floor(C*S)),a.width=p,a.height=C,u.imageSmoothingEnabled=!0,u.clearRect(0,0,a.width,a.height),u.drawImage(l,0,0,a.width,a.height),t.hasImage=!0,t.hasOutput=!1,t.edgeMask=void 0,t.repairedMask=void 0,t.smoothedMask=void 0,t.svgText=void 0,f(),c(),r(),s(`Loaded: ${t.loadedImageName} (${a.width}×${a.height})`),P("Contour load: done",{naturalW:l.naturalWidth,naturalH:l.naturalHeight,scalePct:v,maxSide:w,targetW:p,targetH:C,pixels:p*C,ms:Math.round((performance.now()-b)*10)/10})}catch(l){N("Contour load: exception",{error:l instanceof Error?l.message:String(l)}),s("Load failed — see console / debug trace.")}finally{URL.revokeObjectURL(y),i(!1)}})}async function Xt(e,t,o){const{setStatus:n,setContourBusyVisual:s,clearCleanCanvasesOnly:i,clearSvgPreview:d,updateEnabled:c,getNumber:f}=o;if(!t.hasImage){j("Contour process: skipped (no image loaded)");return}const r=performance.now();await Z(e,async()=>{s(!0,"Processing…"),await new Promise(g=>{setTimeout(()=>{(async()=>{try{const b=e.srcCanvasEl,y=e.outCanvasEl,l=b.width,a=b.height,u=l*a,v=Math.max(1,Math.min(255,f(e.edgeThresholdEl,70))),h=e.invertOutputEl.checked;P("Contour process: start",{width:l,height:a,pixels:u,threshold:v,whiteBg:h}),y.width=l,y.height=a;const p=y.getContext("2d",{willReadFrequently:!0}),C=b.getContext("2d",{willReadFrequently:!0});if(!C||!p){N("Contour process: missing 2D context",{hasSrc:!!C,hasOut:!!p}),n("Process failed — canvas context not available.");return}const S=C.getImageData(0,0,l,a).data,x=new Uint8ClampedArray(l*a);for(let T=0,I=0;T<S.length;T+=4,I++){const R=S[T],U=S[T+1],V=S[T+2];x[I]=.299*R+.587*U+.114*V|0}const E=[-1,0,1,-2,0,2,-1,0,1],m=[-1,-2,-1,0,0,0,1,2,1],k=new Uint8ClampedArray(l*a);for(let T=1;T<a-1;T++)for(let I=1;I<l-1;I++){let R=0,U=0,V=0;for(let z=-1;z<=1;z++)for(let Q=-1;Q<=1;Q++){const q=x[(T+z)*l+(I+Q)];R+=q*E[V],U+=q*m[V],V++}const G=Math.min(255,Math.sqrt(R*R+U*U)|0);k[T*l+I]=G>=v?255:0}const D=p.createImageData(l,a),L=D.data;let M=0;for(let T=0,I=0;T<k.length;T++,I+=4){const R=k[T];if(R===255&&M++,h){const V=R===255?0:255;L[I]=V,L[I+1]=V,L[I+2]=V,L[I+3]=255}else L[I]=R,L[I+1]=R,L[I+2]=R,L[I+3]=255}p.putImageData(D,0,0),t.hasOutput=!0,t.edgeMask=void 0,t.repairedMask=void 0,t.smoothedMask=void 0,d(),i(),n("Done. You can clean/smooth or download the PNG."),P("Contour process: done",{width:l,height:a,pixels:u,threshold:v,whiteBg:h,edgePixels:M,edgeRatio:Math.round(M/Math.max(1,u)*1e6)/1e6,ms:Math.round((performance.now()-r)*10)/10})}catch(b){N("Contour process: exception",{error:b instanceof Error?b.message:String(b)}),n("Process failed — see console / debug trace.")}finally{g()}})()},0)}),s(!1),c()})}async function Zt(e,t,o){const{setStatus:n,setContourBusyVisual:s,clearSvgPreview:i,updateEnabled:d,getNumber:c,updateCleanQualityUI:f}=o;if(!t.hasOutput){j("Contour clean: skipped (no output present)");return}const r=performance.now();await Z(e,async()=>{s(!0,"Cleaning…"),await new Promise(g=>{setTimeout(()=>{(async()=>{try{const b=e.outCanvasEl,y=e.clean1CanvasEl,l=e.clean2CanvasEl;P("Contour clean: raw inputs",{cleanRadiusVal:e.cleanRadiusEl.value,cleanMinAreaVal:e.cleanMinAreaEl.value,cleanBinaryThresholdVal:e.cleanBinaryThresholdEl.value});const a=te(c(e.cleanRadiusEl,1),1,3),u=te(c(e.cleanMinAreaEl,12),0,500),v=te(c(e.cleanBinaryThresholdEl,128),1,254);y.width=b.width,y.height=b.height,l.width=b.width,l.height=b.height;const h=b.width,p=b.height,C=h*p,w=e.invertOutputEl.checked;P("Contour clean: start",{width:h,height:p,pixels:C,whiteBg:w,EDGE_T:v,minArea:u,radius:a});const S=b.getContext("2d",{willReadFrequently:!0}),x=y.getContext("2d",{willReadFrequently:!0}),E=l.getContext("2d",{willReadFrequently:!0});if(!S||!x||!E){N("Contour clean: missing 2D context",{hasOut:!!S,hasC1:!!x,hasC2:!!E}),n("Clean failed — canvas context not available.");return}const k=S.getImageData(0,0,h,p).data,D=new Uint8Array(h*p);let L=0;for(let V=0,G=0;V<D.length;V++,G+=4){const z=k[G],q=(w?z<v:z>=v)?1:0;D[V]=q,q===1&&L++}P("Contour removeSmallComponents: params",{edge:D,width:h,height:p,minArea:u});const M=Yt(D,h,p,u);P("Contour erode : params",{edgeNoSpeck:M,width:h,height:p,radius:a});const T=ue(ce(M,h,p,a),h,p,a);x.putImageData(ke(T,h,p,w),0,0),P("Contour dilate : params",{repaired:T,width:h,height:p,radius:a});const I=ce(ue(T,h,p,a),h,p,a);P("Contour erode : params",{opened:I,width:h,height:p,radius:a});const R=ue(ce(I,h,p,a),h,p,a);E.putImageData(ke(R,h,p,w),0,0),t.edgeMask=D,t.repairedMask=T,t.smoothedMask=R,i();const U=Ve(R,h,p);f(h,p),n(`Clean done — CC:${U.components} endpoints:${U.endpoints} junctions:${U.junctions} thickness:${U.thicknessRatio.toFixed(2)}`),P("Contour clean: done",{width:h,height:p,pixels:C,whiteBg:w,EDGE_T:v,minArea:u,radius:a,edgeOn:L,edgeRatio:Math.round(L/Math.max(1,C)*1e6)/1e6,quality:U,ms:Math.round((performance.now()-r)*10)/10})}catch(b){N("Contour clean: exception",{error:b instanceof Error?b.message:String(b)}),n("Clean failed — see console / debug trace.")}finally{g()}})()},0)}),s(!1),d()})}function en(e,t,o){const n=new Uint8Array(e.length),s=[];function i(l,a){return a*t+l}function d(l,a){return l<0||a<0||l>=t||a>=o?!1:e[i(l,a)]===1}function c(l,a){if(!d(l,a))return!1;for(let u=-1;u<=1;u++)for(let v=-1;v<=1;v++)if(!(v===0&&u===0)&&!d(l+v,a+u))return!0;return!1}const f=[{dx:1,dy:0},{dx:1,dy:1},{dx:0,dy:1},{dx:-1,dy:1},{dx:-1,dy:0},{dx:-1,dy:-1},{dx:0,dy:-1},{dx:1,dy:-1}],r=2e3,g=Math.max(2e3,Math.floor((t+o)*2)),b=Math.max(2e5,Math.floor(t*o*.25));let y=0;for(let l=0;l<o;l++)for(let a=0;a<t;a++){if(s.length>=r||y>=b)return s;const u=i(a,l);if(n[u]===1||!c(a,l))continue;const v=[];let h=a,p=l,C=4,w=0;const S=Math.min(t*o,g*4);for(;w<S;){w++;const x=i(h,p);if(n[x]===1||(v.push({x:h,y:p}),n[x]=1,y++,v.length>=g)||y>=b)break;let E=!1;const m=(C+6)%8;for(let k=0;k<8;k++){const D=(m+k)%8,L=h+f[D].dx,M=p+f[D].dy;if(!c(L,M))continue;const T=i(L,M);if(!(!(L===a&&M===l&&v.length>10)&&n[T]===1)){h=L,p=M,C=D,E=!0;break}}if(!E||h===a&&p===l&&v.length>10)break}v.length>=20&&s.push(v)}return s}function Le(e,t){if(e.length<3)return e;const o=t*t;function n(r,g,b){const y=b.x-g.x,l=b.y-g.y,a=r.x-g.x,u=r.y-g.y,v=y*a+l*u;if(v<=0)return(r.x-g.x)**2+(r.y-g.y)**2;const h=y*y+l*l;if(h<=v)return(r.x-b.x)**2+(r.y-b.y)**2;const p=v/h,C=g.x+p*y,w=g.y+p*l;return(r.x-C)**2+(r.y-w)**2}const s=new Uint8Array(e.length);s[0]=1,s[e.length-1]=1;const i=[0],d=[e.length-1];for(;i.length>0;){const r=i.pop(),g=d.pop();if(g<=r+1)continue;const b=e[r],y=e[g];let l=0,a=-1;for(let u=r+1;u<g;u++){const v=n(e[u],b,y);v>l&&(l=v,a=u)}a!==-1&&l>o&&(s[a]=1,i.push(r),d.push(a),i.push(a),d.push(g))}const c=[];for(let r=0;r<e.length;r++)s[r]===1&&c.push(e[r]);const f=[];for(const r of c){const g=f[f.length-1];(!g||g.x!==r.x||g.y!==r.y)&&f.push(r)}return f}function tn(e,t){let o=e;for(let n=0;n<t;n++){if(o.length<3)return o;const s=[];for(let g=0;g<o.length-1;g++){const b=o[g],y=o[g+1];s.push({x:.75*b.x+.25*y.x,y:.75*b.y+.25*y.y},{x:.25*b.x+.75*y.x,y:.25*b.y+.75*y.y})}const i=o[0],d=o[o.length-1],c=i.x-d.x,f=i.y-d.y;if(c*c+f*f<=4){const g=o[o.length-1],b=o[0];s.push({x:.75*g.x+.25*b.x,y:.75*g.y+.25*b.y},{x:.25*g.x+.75*b.x,y:.25*g.y+.75*b.y})}o=s}return o}function nn(e,t,o){const n=[];for(const s of e){const i=on(s);i&&n.push(`<path d="${i}" fill="none" stroke="#000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>`)}return`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${t}" height="${o}" viewBox="0 0 ${t} ${o}">
<rect x="0" y="0" width="${t}" height="${o}" fill="#fff"/>
`+n.join(`
`)+`
</svg>
`}function on(e){if(e.length<2)return"";const t=e.slice(),o=t[0],n=t[t.length-1],s=o.x-n.x,i=o.y-n.y,d=s*s+i*i<=4;d&&t.push({x:o.x,y:o.y});let c=`M ${t[0].x.toFixed(2)} ${t[0].y.toFixed(2)}`;for(let f=0;f<t.length-1;f++){const r=t[Math.max(0,f-1)],g=t[f],b=t[f+1],y=t[Math.min(t.length-1,f+2)],l=g.x+(b.x-r.x)/6,a=g.y+(b.y-r.y)/6,u=b.x-(y.x-g.x)/6,v=b.y-(y.y-g.y)/6;c+=` C ${l.toFixed(2)} ${a.toFixed(2)}, ${u.toFixed(2)} ${v.toFixed(2)}, ${b.x.toFixed(2)} ${b.y.toFixed(2)}`}return d&&(c+=" Z"),c}async function an(e,t,o){if(!t.smoothedMask){j("Contour vectorize: skipped (no smoothed mask present)");return}const n=performance.now();await Z(e,async()=>{o.setContourBusyVisual(!0,"Vectorizing…");const s=()=>{t.svgText=void 0,e.svgPreviewTextEl.textContent="",e.svgPreviewImgEl.removeAttribute("src")};try{await new Promise((i,d)=>{setTimeout(()=>{(async()=>{try{const c=t.smoothedMask,f=e.outCanvasEl.width,r=e.outCanvasEl.height,g=f*r,b=1.5,y=Math.max(0,Math.min(4,o.getNumber(e.pathSmoothItersEl,2)|0));P("Contour vectorize: start",{width:f,height:r,pixels:g,epsilon:b,smoothIters:y});const l=en(c,f,r),a=l.length,u=l.reduce((E,m)=>E+m.length,0),v=l.reduce((E,m)=>Math.max(E,m.length),0);if(a===0||u===0){j("Contour vectorize: no boundaries found",{width:f,height:r,pixels:g,pathsRaw:a,pointsRaw:u}),s(),o.setStatus("No boundaries found to vectorize."),i();return}if(a>2e3||u>2e5){j("Contour vectorize: aborted (too complex)",{width:f,height:r,pixels:g,pathsRaw:a,pointsRaw:u,maxPolyline:v}),s(),o.setStatus(`Vectorize aborted: too complex (paths ${a}, points ${u}). Try stronger clean / higher minArea / lower resolution.`),i();return}P("Contour vectorize: traced boundaries",{pathsRaw:a,pointsRaw:u,maxPolyline:v});const h=l.filter(E=>E.length>=20).map(E=>{const m=Le(E,b),k=y>0?tn(m,y):m;return Le(k,b)}).filter(E=>E.length>=3),p=h.length,C=h.reduce((E,m)=>E+m.length,0),w=h.reduce((E,m)=>Math.max(E,m.length),0);if(p===0||C===0){j("Contour vectorize: simplified to nothing",{pathsRaw:a,pointsRaw:u,pathsOut:p,pointsOut:C,smoothIters:y,epsilon:b}),s(),o.setStatus("Vectorize produced no usable paths (after simplification)."),i();return}P("Contour vectorize: simplified",{pathsOut:p,pointsOut:C,maxOut:w,smoothIters:y,epsilon:b});const S=nn(h,f,r);t.svgText=S,e.svgPreviewTextEl.textContent=S;const x=encodeURIComponent(S).replace(/'/g,"%27").replace(/"/g,"%22");e.svgPreviewImgEl.src=`data:image/svg+xml;charset=utf-8,${x}`,o.setStatus(`SVG generated: paths ${p}, points ${u}→${C}, smooth ${y}`),P("Contour vectorize: done",{width:f,height:r,pixels:g,smoothIters:y,epsilon:b,pathsRaw:a,pointsRaw:u,pathsOut:p,pointsOut:C,svgChars:S.length,ms:Math.round((performance.now()-n)*10)/10}),i()}catch(c){N("Contour vectorize: exception",{error:c instanceof Error?c.message:String(c),ms:Math.round((performance.now()-n)*10)/10}),d(c)}})()},0)})}catch(i){o.showError("Vectorize",i),s()}finally{o.setContourBusyVisual(!1),o.updateEnabled()}})}function sn(e,t){const o=zt(),n=Gt(e,o);function s(){const f=e.dropZoneEl;function r(g){f.classList.toggle("is-hover",g)}f.addEventListener("dragover",g=>{g.preventDefault(),r(!0)}),f.addEventListener("dragleave",()=>r(!1)),f.addEventListener("drop",g=>{var y;g.preventDefault(),r(!1);const b=(y=g.dataTransfer)==null?void 0:y.files;!b||b.length===0||Te(e,o,b[0],{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearCanvases:n.clearCanvases,clearCleanCanvasesOnly:n.clearCleanCanvasesOnly,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,getNumber:n.getNumber})}),e.fileInputEl.addEventListener("change",()=>{var b;const g=(b=e.fileInputEl.files)==null?void 0:b[0];g&&(Te(e,o,g,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearCanvases:n.clearCanvases,clearCleanCanvasesOnly:n.clearCleanCanvasesOnly,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,getNumber:n.getNumber}),e.fileInputEl.value="")})}function i(){s(),e.btnDownloadEl.addEventListener("click",()=>n.downloadPng()),e.btnDownloadSvgEl.addEventListener("click",()=>n.downloadSvg()),e.btnProcessEl.addEventListener("click",()=>{Xt(e,o,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearCleanCanvasesOnly:n.clearCleanCanvasesOnly,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,getNumber:n.getNumber})}),e.btnCleanEl.addEventListener("click",()=>{Zt(e,o,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,getNumber:n.getNumber,updateCleanQualityUI:n.updateCleanQualityUI})}),e.btnVectorizeEl.addEventListener("click",()=>{an(e,o,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,updateEnabled:n.updateEnabled,showError:n.showError,getNumber:n.getNumber})}),qt(o),n.clearSvgPreview(),n.updateEnabled(),n.setStatus("No image loaded"),e.contourSpinnerEl.classList.add("is-hidden")}function d(){}function c(){}return{id:"contour",bind:i,mount:d,unmount:c}}function rn(){return{status:"Idle",report:["Segmentation placeholder","","Planned:","- Multi-step segmentation pipeline (process1..processN)","- Per-step engine selection: native / opencv / auto","- OpenCV injection + probing is managed in Settings (demo-only)."].join(`
`)}}function ln(e){function t(){const n=e.viewSegmentation,s=n.querySelector('pre[data-bct="seg-report"]');if(s)return s;const i=document.createElement("pre");return i.className="report",i.setAttribute("data-bct","seg-report"),i.setAttribute("aria-label","Segmentation placeholder report"),i.style.marginTop="10px",n.appendChild(i),i}function o(n){const s=e.viewSegmentation.querySelector(".status");s&&(s.textContent=n.status);const i=t();i.textContent=n.report}return{set:o}}function cn(e,t){const o=rn(),n=ln(e);function s(){}function i(){B("[segmentation] mount (placeholder)"),o.status="Idle",n.set(o)}function d(){B("[segmentation] refresh (placeholder)"),n.set(o)}function c(){}function f(){}return{bind:s,mount:i,refresh:d,unmount:c,dispose:f}}function de(e,t,o){return Number.isFinite(e)?Math.max(t,Math.min(o,Math.trunc(e))):t}function un(e,t,o){return Math.round(.2126*e+.7152*t+.0722*o)}function Ge(e){return{edgesDark:!!(e.edgesDark??!0),edgeThreshold:de(e.edgeThreshold??80,0,255),edgeDilate:de(e.edgeDilate??2,0,6),maxRegionPx:de(e.maxRegionPx??2e5,1e3,1e7)}}function dn(e,t,o){const{data:n,width:s,height:i}=e,d=new Uint8Array(s*i);for(let c=0,f=0;c<d.length;c++,f+=4){const r=n[f+0],g=n[f+1],b=n[f+2];if(n[f+3]===0){d[c]=0;continue}const l=un(r,g,b),a=t?l<=o:l>=255-o;d[c]=a?1:0}return d}function gn(e,t,o,n){if(n<=0)return e;let s=e;for(let i=0;i<n;i++){const d=new Uint8Array(t*o);for(let c=0;c<o;c++)for(let f=0;f<t;f++){const r=c*t+f;if(s[r]){d[r]=1;continue}let g=0;for(let b=-1;b<=1&&!g;b++){const y=c+b;if(!(y<0||y>=o))for(let l=-1;l<=1;l++){const a=f+l;if(!(a<0||a>=t)&&s[y*t+a]){g=1;break}}}d[r]=g}s=d}return s}function fn(e,t,o,n,s,i){const d=t*n+e;if(o[d])return{ok:!1,message:"Click is on an edge; pick inside a region."};const c=new Uint8Array(n*s),f=new Int32Array(n*s),r=new Int32Array(n*s);let g=0,b=0;f[b]=e,r[b]=t,b++,c[d]=1;let y=1;for(;g<b;){const l=f[g],a=r[g];g++;const u=[[l-1,a],[l+1,a],[l,a-1],[l,a+1]];for(const[v,h]of u){if(v<0||v>=n||h<0||h>=s)continue;const p=h*n+v;if(!c[p]&&!o[p]&&(c[p]=1,f[b]=v,r[b]=h,b++,y++,y>i))return{ok:!1,message:`Region too large (>${i}px). Increase Max region or fix gaps.`}}}return{ok:!0,mask:c}}function bn(e,t,o,n){const s=new Uint8Array(o*n);for(let i=1;i<n-1;i++)for(let d=1;d<o-1;d++){const c=i*o+d;if(!e[c])continue;const f=(i-1)*o+d,r=(i+1)*o+d,g=i*o+(d-1),b=i*o+(d+1);(!e[f]||!e[r]||!e[g]||!e[b]||t[f]||t[r]||t[g]||t[b])&&(s[c]=1)}return s}function vn(e,t,o,n){const s=Ge(n),i=e.width,d=e.height;let c=dn(e,s.edgesDark,s.edgeThreshold);c=gn(c,i,d,s.edgeDilate);const f=fn(t,o,c,i,d,s.maxRegionPx);if(!f.ok)return{ok:!1,message:f.message};const r=bn(f.mask,c,i,d);return{ok:!0,preview:{mask:f.mask,outline:r,w:i,h:d}}}function hn(e,t,o){const n=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),s=o.replace("#",""),i=parseInt(s.slice(0,2),16),d=parseInt(s.slice(2,4),16),c=parseInt(s.slice(4,6),16),f=n.data;for(let r=0,g=0;r<t.mask.length;r++,g+=4)t.mask[r]&&(f[g+0]=i,f[g+1]=d,f[g+2]=c);return n}function ge(e,t,o){return Number.isFinite(e)?Math.max(t,Math.min(o,Math.trunc(e))):t}function Ie(e){const t=(e||"").trim();if(!t)return null;const o=t.startsWith("#")?t:`#${t}`;return/^#[0-9a-fA-F]{6}$/.test(o)?o.toLowerCase():null}function En(e){let t="#ff3b30",o=[],n=null;function s(u){e.colorsStatusEl.textContent=u||""}function i(){const u=!!e.edgesDarkEl.checked,v=ge(parseInt(e.edgeMaskThresholdEl.value,10),0,255),h=ge(parseInt(e.edgeDilateEl.value,10),0,6),p=ge(parseInt(e.maxRegionPxEl.value,10),1e3,1e7);return e.edgeMaskThresholdEl.value=String(v),e.edgeDilateEl.value=String(h),e.maxRegionPxEl.value=String(p),Ge({edgesDark:u,edgeThreshold:v,edgeDilate:h,maxRegionPx:p})}function d(u){const v=Ie(u);if(v){t=v;for(const h of Array.from(e.paletteEl.querySelectorAll(".paletteItem"))){const p=h.dataset.hex||"";h.classList.toggle("is-selected",p===t)}}}function c(){return t}function f(u){o=u.slice(),e.paletteEl.innerHTML="";for(const v of o){const h=Ie(v);if(!h)continue;const p=document.createElement("button");p.type="button",p.className="paletteItem",p.style.background=h,p.dataset.hex=h,p.setAttribute("role","listitem"),p.setAttribute("aria-label",`Select ${h}`),p.addEventListener("click",()=>{d(h)}),e.paletteEl.appendChild(p)}d(t)}function r(u){const v=e.colorsCanvasEl;v.width=u.width,v.height=u.height,v.getContext("2d").putImageData(u,0,0)}function g(u,v){r(u);const h=e.colorsCanvasEl.getContext("2d"),{outline:p,w:C,h:w}=v,S=h.getImageData(0,0,C,w),x=S.data;for(let E=0,m=0;E<p.length;E++,m+=4)p[E]&&(x[m+0]=255,x[m+1]=60,x[m+2]=60,x[m+3]=220);h.putImageData(S,0,0)}function b(u){e.btnColorsApplyEl.disabled=!u}function y(u){e.btnColorsCancelEl.disabled=!u}function l(u){n=u}function a(){s("Idle"),b(!1),y(!1),e.colorsCanvasEl.addEventListener("click",u=>{if(!n)return;const v=e.colorsCanvasEl.getBoundingClientRect(),h=Math.floor((u.clientX-v.left)/v.width*e.colorsCanvasEl.width),p=Math.floor((u.clientY-v.top)/v.height*e.colorsCanvasEl.height);n(h,p)})}return{bind:a,setStatus:s,getSettings:i,setSelectedColor:d,getSelectedColor:c,renderPalette:f,drawBase:r,drawPreview:g,setApplyEnabled:b,setCancelEnabled:y,onCanvasClick:l}}const pn=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#a2845e","#8e8e93","#1c1c1e","#ffffff","#000000","#4cd964","#5ac8fa","#ff6b6b","#7aa2ff","#f5a623","#50e3c2"];function yn(e,t){const o=En(e);let n=null,s=null;function i(b){o.setStatus(b)}function d(){const b=e.outCanvasEl.getContext("2d");if(!b)return null;const y=e.outCanvasEl.width,l=e.outCanvasEl.height;return y<=0||l<=0?null:b.getImageData(0,0,y,l)}function c(){const b=d();if(!b){n=null,s=null,o.setApplyEnabled(!1),o.setCancelEnabled(!1),i("No output available. Run Process first.");return}n=b,s=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),i("Ready. Pick a color, click inside a region.")}function f(){if(n){o.drawBase(n);return}const b=d();if(!b){i("No output available. Run Process first.");return}n=b,s=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),i("Loaded output. Pick a color, click inside a region.")}function r(){if(!n||!s)return;const b=o.getSelectedColor();n=hn(n,s,b),s=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),i("Fill applied. Click another region.")}function g(){n&&(s=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),i("Preview canceled."))}return{bind(){o.bind(),o.renderPalette(pn),o.onCanvasClick((b,y)=>{if(!n){i("No output available. Run Process first.");return}const l=o.getSettings(),a=vn(n,b,y,l);if(!a.ok){s=null,o.setApplyEnabled(!1),o.setCancelEnabled(!1),i(a.message);return}s=a.preview,o.drawPreview(n,s),o.setApplyEnabled(!0),o.setCancelEnabled(!0),i("Preview shown. Apply fill or cancel.")}),e.btnColorsApplyEl.addEventListener("click",()=>r()),e.btnColorsCancelEl.addEventListener("click",()=>g()),e.btnColorsResetEl.addEventListener("click",()=>c()),e.tabColors.addEventListener("click",()=>{queueMicrotask(()=>f())}),i("Idle"),o.setApplyEnabled(!1),o.setCancelEnabled(!1)}}}const re="beecontour.actionLog",mn=5e3;function Cn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function wn(e){return Array.isArray(e)?e:[e]}function ie(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}async function X(){const e=await K(re),t=e==null?void 0:e[re];return Array.isArray(t)?t:[]}async function Qe(e){await W({[re]:e})}async function H(e,t){const o=ie(mn,100,5e4),s=wn(e).map(f=>({...f,id:Cn(),ts:Date.now()}));if(!s.length)return{total:(await X()).length};const d=(await X()).concat(s),c=d.length>o?d.slice(d.length-o):d;return await Qe(c),{total:c.length}}async function Sn(e){const t=ie((e==null?void 0:e.limit)??200,1,5e4),o=ie((e==null?void 0:e.offset)??0,0,1e6);let s=await X();e!=null&&e.kind&&(s=s.filter(c=>c.kind===e.kind)),e!=null&&e.scope&&(s=s.filter(c=>c.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(s=s.filter(c=>c.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(s=s.filter(c=>c.ts<=e.untilTs));const i=s.length;s=s.slice().reverse();const d=s.slice(o,o+t);return{total:i,items:d}}async function xn(e){let o=await X();if(typeof e.beforeTs=="number"&&(o=o.filter(n=>n.ts>=e.beforeTs)),typeof e.keepLast=="number"){const n=ie(e.keepLast,0,5e4);n===0?o=[]:o.length>n&&(o=o.slice(o.length-n))}return await Qe(o),{total:o.length}}async function Dn(){await me(re)}async function kn(e){const t=await X();return JSON.stringify(t,null,2)}const Me="0.0.6",we={native:{available:!0},opencv:{available:!1,reason:"OpenCV not loaded"}};function Tn(e){we[e]={available:!0}}function Ln(e,t){we[e]={available:!1,reason:t}}function ee(){return we.opencv.available===!0}async function In(e){const t=new URL(e.opencvJsRel,document.baseURI).toString(),o=new URL(e.opencvWasmRel,document.baseURI).toString(),n=globalThis;n.Module=n.Module||{},n.Module.locateFile=s=>s.endsWith(".wasm")?o:s,n.Module.print=()=>{},n.Module.printErr=()=>{},n.cv||await Mn(t),await Bn(e.timeoutMs)}function Mn(e){return new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onload=()=>t(),n.onerror=()=>o(new Error(`Failed to load OpenCV script: ${e}`)),document.head.appendChild(n)})}async function Bn(e){var n;const t=Date.now(),o=globalThis;for(;Date.now()-t<e;){if(o.cv&&typeof o.cv.Mat=="function"){const s=new o.cv.Mat;(n=s.delete)==null||n.call(s);return}await new Promise(s=>setTimeout(s,75))}throw new Error("OpenCV initialization timeout")}async function On(){try{await In({opencvJsRel:"../assets/opencv/opencv.js",opencvWasmRel:"../assets/opencv/opencv.wasm",timeoutMs:2e4}),Tn("opencv")}catch(e){throw Ln("opencv",e!=null&&e.message?String(e.message):String(e)),e}}function Rn(){let e=!1,t={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},o=!1,n="",s="";function i(r){e=r}function d(r){t={...t,...r}}function c(r){o=r}function f(r){typeof r.general=="string"&&(n=r.general),typeof r.dev=="string"&&(s=r.dev)}return{get showDevTools(){return e},get dev(){return t},get debugEnabled(){return o},get generalStatus(){return n},get devStatus(){return s},setShowDevTools:i,setDev:d,setDebugEnabled:c,setStatus:f}}function An(e){function t(r){e.settingsGeneralStatusEl.textContent=r||""}function o(r){e.cfgStatusEl.textContent=r||""}function n(r){e.cfgShowDevToolsEl.checked=r}function s(r){e.tabLogs.hidden=!r,e.devConfigDetailsEl.classList.toggle("is-hidden",!r),r||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function i(r){e.cfgTraceConsoleEl.checked=!!r.traceConsole,e.cfgActionLogMaxEl.value=String(r.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(r.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(r.failureLogsPerRun??50)}function d(r){e.logsCbDebugEl.checked=r}function c(r,g){e.settingsVersionEl.textContent=r||"—",e.settingsGitHubLinkEl.href=g||"#",e.settingsGitHubLinkEl.hidden=!g}function f(r){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=r,e.cfgActionLogMaxEl.disabled=r,e.cfgDebugTraceMaxEl.disabled=r,e.cfgFailureLogsPerRunEl.disabled=r,e.btnCfgResetDefaults.disabled=r,e.logsCbDebugEl.disabled=r,e.cfgUseOpenCvEl.disabled=r}return{setGeneralStatus:t,setDevStatus:o,setShowDevToolsChecked:n,setDevToolsVisible:s,setDevConfig:i,setDebugEnabledChecked:d,setAbout:c,setBusy:f}}const fe="template.settings.showDevTools",be="beecontour.settings.engine.useOpenCv";function Pn(){var e,t;try{const o=(e=globalThis==null?void 0:globalThis.chrome)==null?void 0:e.runtime,n=(t=o==null?void 0:o.getManifest)==null?void 0:t.call(o),s=typeof(n==null?void 0:n.version)=="string"?n.version:"";if(B("Settings: getManifestVersion manifest found version is ",{v:s}),s)return s}catch{}return B("Settings: getManifestVersion fallback",{APP_VERSION:Me}),Me}function ve(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??$.actionLogMax),debugTraceMax:Number(e.debugTraceMax??$.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??$.failureLogsPerRun)}}function $n(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:_(e.cfgActionLogMaxEl.value,100,5e4,$.actionLogMax),debugTraceMax:_(e.cfgDebugTraceMaxEl.value,100,5e4,$.debugTraceMax),failureLogsPerRun:_(e.cfgFailureLogsPerRunEl.value,0,5e4,$.failureLogsPerRun)}}async function Be(e){const t=ze;return typeof t.setEnabled=="function"?(await t.setEnabled(e),{ok:!0}):typeof t.enable=="function"&&typeof t.disable=="function"?(await(e?t.enable():t.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function Vn(e,t){const o=Rn(),n=An(e);function s(E){e.settingsEngineBoxEl.classList.toggle("is-hidden",!1)}async function i(){const E=await K([be]).catch(()=>({}));return(E==null?void 0:E[be])===!0}async function d(E){await W({[be]:!!E}).catch(()=>null)}function c(E){var m;e.cfgUseOpenCvEl.checked=E,(m=e.cfgUseOpenCvEl.closest(".switch"))==null||m.classList.toggle("is-disabled",e.cfgUseOpenCvEl.disabled)}function f(E){e.cfgOpenCvSpinner.classList.toggle("is-hidden",!E),e.cfgOpenCvSpinner.setAttribute("aria-hidden",E?"false":"true")}function r(E){e.cfgOpenCvStatus.textContent=E||""}function g(E){e.cfgOpenCvReport.textContent=E||""}async function b(){if(A())return;if(!!!e.cfgUseOpenCvEl.checked){await d(!1),f(!1),r(ee()?"OpenCV loaded (native mode)":"Native mode"),g("Native mode. OpenCV is optional and demo-only.");return}f(!0),r("Loading OpenCV…"),g("Loading OpenCV…");try{if(await Z(e,async()=>{await On()}),!ee())throw new Error("OpenCV load returned but runtime is not injected.");await d(!0),r("OpenCV mode enabled"),g("OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV.")}catch(m){const k=String((m==null?void 0:m.message)??m);await d(!1),c(!1),r("OpenCV load failed"),g(`ERROR

${k}`),N("[settings] OpenCV toggle failed",{msg:k})}finally{f(!1)}}async function y(){const E=await K([fe]).catch(()=>({}));return(E==null?void 0:E[fe])===!0}async function l(E){await W({[fe]:!!E}).catch(()=>null)}function a(E){o.setShowDevTools(E),n.setShowDevToolsChecked(E),n.setDevToolsVisible(E),E||e.tabSettings.click()}async function u(){const E=await y();a(E),B("Settings: boot applyDevToolsVisibility",{showDevTools:E})}async function v(){var L;n.setBusy(A());const E=await y();a(E),await xe().catch(()=>null);const m=oe();o.setDev(ve(m)),n.setDevConfig(o.dev);const k=ze;let D=!1;try{typeof k.isEnabled=="function"?D=!!await k.isEnabled():D=!!k.enabled}catch(M){j("Settings: failed to read debug enabled state",{error:M instanceof Error?M.message:String(M)})}o.setDebugEnabled(D),n.setDebugEnabledChecked(D),n.setAbout(Pn()||"—",((L=e.settingsGitHubLinkEl)==null?void 0:L.href)||"#"),s();{const M=await i();c(M),f(!1);const T=ee();M?(r(T?"OpenCV mode enabled":"OpenCV mode (not loaded yet)"),g(T?"OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV.":"OpenCV mode is enabled, but OpenCV is not loaded yet. Toggle OFF then ON to load OpenCV.")):(r(T?"OpenCV loaded (native mode)":"Native mode"),g("Native mode. OpenCV is optional and demo-only."))}n.setGeneralStatus(""),n.setDevStatus(""),B("Settings: loaded",{showDevTools:E,enabled:D,dev:o.dev,opencvInjected:ee()})}async function h(){const E=!!e.cfgShowDevToolsEl.checked;a(E),await l(E),H({kind:"run",scope:"settings",message:E?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:E}}),B("Settings: ui toggle showDevTools",{showDevTools:E}),n.setGeneralStatus(E?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>n.setGeneralStatus(""),1200)}async function p(){const E=$n(e);n.setDevStatus("Saving…");try{await $e(E)}catch(m){N("Settings: failed to save dev config",{error:m instanceof Error?m.message:String(m),next:E}),n.setDevStatus("Save failed."),setTimeout(()=>n.setDevStatus(""),1200);return}o.setDev(ve(E)),n.setDevConfig(o.dev),H({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:E}),B("Settings: devConfig updated",E),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}async function C(){n.setDevStatus("Resetting…");try{await Ft(),await xe().catch(()=>null);const m=oe();o.setDev(ve(m)),n.setDevConfig(o.dev)}catch(m){N("Settings: failed to reset dev config defaults",{error:m instanceof Error?m.message:String(m)}),n.setDevStatus("Reset failed."),setTimeout(()=>n.setDevStatus(""),1200);return}const E=await Be(!1);E.ok?(o.setDebugEnabled(!1),n.setDebugEnabledChecked(!1)):(j("Settings: failed to reset debug enabled state",{error:E.error||"unknown error"}),H({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:E.error||"unknown error"})),H({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...$,debugEnabled:!1}}),B("Settings: reset defaults",{...$,debugEnabled:!1}),n.setDevStatus("Reset."),setTimeout(()=>n.setDevStatus(""),1200)}async function w(){const E=!!e.logsCbDebugEl.checked;n.setDevStatus("Saving…");const m=await Be(E);if(!m.ok){e.logsCbDebugEl.checked=!E,n.setDevStatus(`Save failed: ${m.error||"unknown error"}`),N("Settings: failed to change debug enabled state",{error:m.error||"unknown error",enabled:E}),H({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:m.error||"unknown error",meta:{enabled:E}});return}o.setDebugEnabled(E),H({kind:"run",scope:"settings",message:E?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:E}}),B("Settings: debug enabled changed",{enabled:E}),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}const S=t.on(()=>{});function x(){e.cfgShowDevToolsEl.addEventListener("change",()=>{h()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{A()||p()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{A()||p()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{A()||p()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{A()||p()}),e.btnCfgResetDefaults.addEventListener("click",()=>{A()||C()}),e.logsCbDebugEl.addEventListener("change",()=>{A()||w()}),e.cfgUseOpenCvEl.addEventListener("change",()=>{b()}),u().catch(E=>{j("Settings: initDevToolsVisibility failed",{error:E instanceof Error?E.message:String(E)})})}return{id:"settings",refresh(){v().catch(E=>{N("Settings: refresh failed",{error:E instanceof Error?E.message:String(E)})})},mount(){v().catch(E=>{N("Settings: mount failed",{error:E instanceof Error?E.message:String(E)})})},unmount(){},bind:x,dispose(){S()}}}function Un(){let e=[],t=0;function o(n){e=n.items,t=n.total}return{get items(){return e},get total(){return t},set:o}}function Nn(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function Oe(e,t){const o=[];o.push(`Total entries: ${t.total}`),o.push("");for(const n of t.items){const s=typeof n.ok=="boolean"?n.ok?"ok":"fail":"",i=[];typeof n.status=="number"&&i.push(`status=${n.status}`),s&&i.push(s);const d=[n.scope,n.kind].filter(Boolean).join("/");o.push(`[${Nn(n.ts)}] ${d}${i.length?` (${i.join(", ")})`:""}`),o.push(`  ${n.message}`),n.error&&o.push(`  error: ${n.error}`),o.push("")}e.textContent=o.join(`
`),e.scrollTop=0}function Fn(e){function t(d){e.logsStatusEl.textContent=d}function o(d){e.debugStatusEl.textContent=d}function n(d){e.logsCbDebugEl.checked=d}function s(d){Oe(e.logsOutEl,{total:d.total,items:d.items.map(c=>({ts:c.ts,message:c.message,scope:c.scope,kind:c.kind,ok:c.ok,status:c.status,error:c.error,meta:c.meta}))})}function i(d){Oe(e.debugOutEl,{total:d.total,items:d.items.map(c=>({ts:c.ts,message:c.message,scope:c.scope,kind:c.kind,ok:c.ok,status:c.status,error:c.error,meta:c.meta}))})}return{setAuditStatus:t,setDebugStatus:o,setDebugChecked:n,renderAudit:s,renderDebug:i}}const Re="beecontour";function jn(e,t){const o=Un(),n=Fn(e);async function s(){n.setAuditStatus("Loading…"),F(e,!0);try{const a=_(e.logsLimitEl.value,10,5e3,200),u=await Sn({limit:a,reverse:!0});o.set(u),n.renderAudit({items:o.items,total:o.total}),n.setAuditStatus(`Showing ${o.items.length} (newest first)`)}catch(a){n.setAuditStatus(`Failed: ${(a==null?void 0:a.message)||String(a)}`)}finally{F(e,!1)}}async function i(){n.setDebugStatus("Loading…"),F(e,!0);try{const a=_(e.debugLimitEl.value,10,5e3,200),u=await je({limit:a,reverse:!0});n.renderDebug(u),n.setDebugStatus(`Showing ${u.items.length} (newest first)`)}catch(a){n.setDebugStatus(`Failed: ${(a==null?void 0:a.message)||String(a)}`)}finally{F(e,!1)}}async function d(){const a=await Ce();n.setDebugChecked(a)}async function c(a){if(await Ue(a),n.setDebugChecked(a),!a){n.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}n.setDebugStatus("Debug ON."),await i()}async function f(){const a=_(e.logsTrimKeepEl.value,0,5e4,2e3);n.setAuditStatus("Trimming…"),F(e,!0);try{const u=await xn({keepLast:a});await s(),n.setAuditStatus(`Trimmed. Remaining: ${u.total}`)}catch(u){n.setAuditStatus(`Trim failed: ${(u==null?void 0:u.message)||String(u)}`)}finally{F(e,!1)}}async function r(){n.setAuditStatus("Clearing…"),F(e,!0);try{await Dn(),await s(),n.setAuditStatus("Cleared.")}catch(a){n.setAuditStatus(`Clear failed: ${(a==null?void 0:a.message)||String(a)}`)}finally{F(e,!1)}}async function g(){n.setAuditStatus("Exporting…");try{const a=await kn({pretty:!0}),u=new Blob([a],{type:"application/json"}),v=URL.createObjectURL(u),h=document.createElement("a");h.href=v,h.download=`${Re}-audit-${Date.now()}.json`,h.click(),setTimeout(()=>URL.revokeObjectURL(v),1e3),n.setAuditStatus("Exported.")}catch(a){n.setAuditStatus(`Export failed: ${(a==null?void 0:a.message)||String(a)}`)}}async function b(){n.setDebugStatus("Clearing…"),F(e,!0);try{await Ne(),await i(),n.setDebugStatus("Cleared.")}catch(a){n.setDebugStatus(`Clear failed: ${(a==null?void 0:a.message)||String(a)}`)}finally{F(e,!1)}}async function y(){n.setDebugStatus("Exporting…");try{const a=await _e({pretty:!0}),u=new Blob([a],{type:"application/json"}),v=URL.createObjectURL(u),h=document.createElement("a");h.href=v,h.download=`${Re}-debug-${Date.now()}.json`,h.click(),setTimeout(()=>URL.revokeObjectURL(v),1e3),n.setDebugStatus("Exported.")}catch(a){n.setDebugStatus(`Export failed: ${(a==null?void 0:a.message)||String(a)}`)}}function l(){e.btnLogsRefresh.addEventListener("click",()=>{A()||s()}),e.btnLogsTrim.addEventListener("click",()=>{A()||f()}),e.btnLogsClear.addEventListener("click",()=>{A()||r()}),e.btnLogsExport.addEventListener("click",()=>{A()||g()}),e.logsCbDebugEl.addEventListener("change",()=>{A()||c(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{A()||i()}),e.btnDebugClear.addEventListener("click",()=>{A()||b()}),e.btnDebugExport.addEventListener("click",()=>{A()||y()})}return{id:"logs",bind:l,mount(){d(),s(),i()},unmount(){},dispose(){}}}(function(){const t=At(),o=Vt();o.start();const n=_t();globalThis.__APP__={...globalThis.__APP__,cache:n};const s=sn(t),i=yn(t),d=cn(t),c=Vn(t,o),f=jn(t);s.bind(),d.bind(),i.bind(),c.bind(),f.bind();const r=jt(t,{contour:s,segmentation:d,colors:i,settings:c,logs:f});r.bind(),r.boot()})();
