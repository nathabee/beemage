function Xt(){function e(Je,Zt){if(!Je)throw new Error(`[dom] Missing #${Zt}`);return Je}const t=e(document.getElementById("appRoot"),"appRoot"),o=e(document.getElementById(" tabImage")," tabImage"),n=e(document.getElementById("tabColors"),"tabColors"),i=e(document.getElementById("tabSettings"),"tabSettings"),a=e(document.getElementById("tabLogs"),"tabLogs"),s=e(document.getElementById("tabPipeline"),"tabPipeline"),c=e(document.getElementById("viewMage"),"viewMage"),p=e(document.getElementById("viewColors"),"viewColors"),l=e(document.getElementById("viewSettings"),"viewSettings"),u=e(document.getElementById("viewLogs"),"viewLogs"),h=e(document.getElementById("viewPipeline"),"viewPipeline"),f=e(document.getElementById("dropZone"),"dropZone"),g=e(document.getElementById("fileInput"),"fileInput"),d=e(document.getElementById("srcCanvas"),"srcCanvas"),m=e(document.getElementById("pipelineStatus"),"pipelineStatus"),v=e(document.getElementById("pipelineTuningMount"),"pipelineTuningMount"),b=e(document.getElementById("pipelineViewMount"),"pipelineViewMount"),y=e(document.getElementById("colorsCanvas"),"colorsCanvas"),I=e(document.getElementById("palette"),"palette"),S=e(document.getElementById("btnColorsApply"),"btnColorsApply"),k=e(document.getElementById("btnColorsCancel"),"btnColorsCancel"),O=e(document.getElementById("btnColorsReset"),"btnColorsReset"),N=e(document.getElementById("edgesDark"),"edgesDark"),j=e(document.getElementById("edgeMaskThreshold"),"edgeMaskThreshold"),B=e(document.getElementById("edgeDilate"),"edgeDilate"),r=e(document.getElementById("maxRegionPx"),"maxRegionPx"),w=e(document.getElementById("colorsStatus"),"colorsStatus"),x=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),D=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),V=e(document.getElementById("devConfigDetails"),"devConfigDetails"),$=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),z=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),F=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),C=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),E=e(document.getElementById("logsCbDebug"),"logsCbDebug"),A=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),P=e(document.getElementById("cfgStatus"),"cfgStatus"),W=e(document.getElementById("cfgOpenCvSpinner"),"cfgOpenCvSpinner"),M=e(document.getElementById("cfgOpenCvStatus"),"cfgOpenCvStatus"),_=e(document.getElementById("cfgOpenCvReport"),"cfgOpenCvReport"),H=e(document.getElementById("settingsEngineBox"),"settingsEngineBox"),T=e(document.getElementById("cfgUseOpenCv"),"cfgUseOpenCv"),Z=e(document.getElementById("tuningMount"),"tuningMount"),he=e(document.getElementById("settingsVersion"),"settingsVersion"),Te=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),Q=e(document.getElementById("logsLimit"),"logsLimit"),ae=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),Ut=e(document.getElementById("logsStatus"),"logsStatus"),Nt=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),jt=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),Ft=e(document.getElementById("btnLogsExport"),"btnLogsExport"),_t=e(document.getElementById("btnLogsClear"),"btnLogsClear"),Gt=e(document.getElementById("logsOut"),"logsOut"),Kt=e(document.getElementById("debugLimit"),"debugLimit"),Wt=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),Ht=e(document.getElementById("btnDebugExport"),"btnDebugExport"),qt=e(document.getElementById("btnDebugClear"),"btnDebugClear"),Jt=e(document.getElementById("debugStatus"),"debugStatus"),Yt=e(document.getElementById("debugOut"),"debugOut");return{rootEl:t,tabImage:o,tabColors:n,tabSettings:i,tabLogs:a,tabPipeline:s,viewMage:c,viewColors:p,viewSettings:l,viewLogs:u,viewPipeline:h,dropZoneEl:f,fileInputEl:g,srcCanvasEl:d,pipelineStatusEl:m,pipelineTuningMountEl:v,pipelineViewMountEl:b,colorsCanvasEl:y,paletteEl:I,btnColorsApplyEl:S,btnColorsCancelEl:k,btnColorsResetEl:O,edgesDarkEl:N,edgeMaskThresholdEl:j,edgeDilateEl:B,maxRegionPxEl:r,colorsStatusEl:w,cfgShowDevToolsEl:x,settingsGeneralStatusEl:D,devConfigDetailsEl:V,cfgTraceConsoleEl:$,cfgActionLogMaxEl:z,cfgDebugTraceMaxEl:F,cfgFailureLogsPerRunEl:C,logsCbDebugEl:E,btnCfgResetDefaults:A,cfgStatusEl:P,settingsVersionEl:he,settingsGitHubLinkEl:Te,cfgOpenCvSpinner:W,cfgOpenCvStatus:M,cfgOpenCvReport:_,settingsEngineBoxEl:H,cfgUseOpenCvEl:T,tuningMountEl:Z,logsLimitEl:Q,btnLogsRefresh:ae,logsStatusEl:Ut,logsTrimKeepEl:Nt,btnLogsTrim:jt,btnLogsExport:Ft,btnLogsClear:_t,logsOutEl:Gt,debugLimitEl:Kt,btnDebugRefresh:Wt,btnDebugExport:Ht,btnDebugClear:qt,debugStatusEl:Jt,debugOutEl:Yt}}const Qt=new Set;function en(e){Qt.add(e)}function tn(){const e=new Set;function t(n){return e.add(n),()=>e.delete(n)}function o(){en(i=>{for(const a of e)a(i)})}return{on:t,start:o}}const nn=new Set;function mt(e){for(const t of nn)t(e,"local")}function de(e){const t=localStorage.getItem(e);if(t!==null)try{return JSON.parse(t)}catch{return t}}function on(e,t){localStorage.setItem(e,JSON.stringify(t))}async function le(e){if(typeof e=="string")return{[e]:de(e)};if(Array.isArray(e)){const o={};for(const n of e)o[n]=de(n);return o}const t={};for(const[o,n]of Object.entries(e))t[o]=localStorage.getItem(o)!==null?de(o):n;return t}async function ce(e){const t={};for(const[o,n]of Object.entries(e)){const i=de(o);on(o,n),t[o]={oldValue:i,newValue:n}}mt(t)}async function We(e){const t=Array.isArray(e)?e:[e],o={};for(const n of t){const i=de(n);localStorage.removeItem(n),o[n]={oldValue:i,newValue:void 0}}mt(o)}function ee(e,t,o,n){const i=Number(String(e??"").trim());return Number.isFinite(i)?Math.max(t,Math.min(o,Math.floor(i))):n}const Ue="beemage.devConfig",Y={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let Ne=!1,ke={...Y};function bt(e){const t=e||{};return{traceConsole:!!t.traceConsole,actionLogMax:ee(t.actionLogMax??Y.actionLogMax,100,5e4,Y.actionLogMax),debugTraceMax:ee(t.debugTraceMax??Y.debugTraceMax,100,5e4,Y.debugTraceMax),failureLogsPerRun:ee(t.failureLogsPerRun??Y.failureLogsPerRun,0,5e4,Y.failureLogsPerRun)}}async function je(){if(Ne)return;const e=await le([Ue]).catch(()=>({}));ke=bt(e==null?void 0:e[Ue]),Ne=!0}function Se(){return ke}async function yt(e){ke=bt(e),Ne=!0,await ce({[Ue]:ke}).catch(()=>null)}async function an(){await yt({...Y})}function sn(e,t){const o={pipeline:e.tabPipeline,image:e.tabImage,colors:e.tabColors,settings:e.tabSettings,logs:e.tabLogs},n={pipeline:e.viewPipeline,image:e.viewMage,colors:e.viewColors,settings:e.viewSettings,logs:e.viewLogs};let i="image";const a=new Set;function s(){const g=Se();return!!(g!=null&&g.traceConsole)}function c(){const g=globalThis;g.__bctGlobalErrorHooksInstalled||(g.__bctGlobalErrorHooksInstalled=!0,window.addEventListener("error",d=>{var v;const m=d;console.error("[panel] window error",{message:m.message,filename:m.filename,lineno:m.lineno,colno:m.colno,error:m.error?String(m.error):null,stack:(v=m.error)!=null&&v.stack?String(m.error.stack):null})}),window.addEventListener("unhandledrejection",d=>{var m;console.error("[panel] unhandledrejection",{reason:d.reason?String(d.reason):null,stack:(m=d.reason)!=null&&m.stack?String(d.reason.stack):null})}))}s()&&c();function p(g){Object.keys(o).forEach(d=>{const m=d===g;o[d].classList.toggle("is-active",m),o[d].setAttribute("aria-selected",m?"true":"false"),n[d].hidden=!m,n[d].classList.toggle("is-active",m)})}function l(g){var d,m,v,b,y,I,S,k;if(g===i){(m=(d=t[g]).refresh)==null||m.call(d);return}(b=(v=t[i]).unmount)==null||b.call(v),i=g,p(i),a.has(i)?(k=(S=t[i]).refresh)==null||k.call(S):(a.add(i),(I=(y=t[i]).mount)==null||I.call(y))}function u(){o.image.addEventListener("click",g=>{var d;(d=g.preventDefault)==null||d.call(g),l("image")}),o.pipeline.addEventListener("click",g=>{var d;(d=g.preventDefault)==null||d.call(g),l("pipeline")}),o.colors.addEventListener("click",g=>{var d;(d=g.preventDefault)==null||d.call(g),l("colors")}),o.settings.addEventListener("click",g=>{var d;(d=g.preventDefault)==null||d.call(g),l("settings")}),o.logs.addEventListener("click",g=>{var d;(d=g.preventDefault)==null||d.call(g),l("logs")})}function h(){var g,d,m,v;i="image",p(i),Object.keys(t).forEach(b=>{var y,I;return(I=(y=t[b]).boot)==null?void 0:I.call(y)}),a.has(i)?(v=(m=t[i]).refresh)==null||v.call(m):(a.add(i),(d=(g=t[i]).mount)==null||d.call(g))}function f(){Object.keys(t).forEach(g=>{var d,m;return(m=(d=t[g]).dispose)==null?void 0:m.call(d)})}return{bind:u,boot:h,activate:l,dispose:f}}function Ye(e){const t=e.items.length;return{items:e.items,counts:{items:t},meta:e.meta}}function rn(){const e={items:[],meta:{}},t=new Set;function o(){const l=Ye(e);for(const u of t)try{u(l)}catch{}}function n(){return Ye(e)}function i(l){t.add(l);try{l(n())}catch{}return()=>t.delete(l)}function a(){e.items=[],e.meta={},o()}function s(l){e.meta.scopeUpdatedSince=l,o()}function c(){return String(e.meta.scopeUpdatedSince||"")}function p(l,u){e.items=l.slice(),e.meta.updatedTs=Date.now(),typeof(u==null?void 0:u.limit)=="number"&&(e.meta.limit=u.limit),o()}return{getSnapshot:n,subscribe:i,getScopeUpdatedSince:c,clearAll:a,setScopeUpdatedSince:s,setItems:p}}function ln(e,t){function o(c){e.dropZoneEl.classList.toggle("is-hover",c)}function n(c,p){const l=c.getContext("2d",{willReadFrequently:!0});if(!l)return;const u=Math.max(1,c.width),h=Math.max(1,c.height);l.clearRect(0,0,u,h);const f=p.naturalWidth||p.width,g=p.naturalHeight||p.height;if(!f||!g)return;const d=Math.min(u/f,h/g),m=Math.max(1,Math.round(f*d)),v=Math.max(1,Math.round(g*d)),b=Math.floor((u-m)/2),y=Math.floor((h-v)/2);l.drawImage(p,b,y,m,v)}function i(c){n(e.srcCanvasEl,c)}function a(c){t.lastError=void 0,t.loadedImageName=c,t.hasImage=!0}function s(c){t.lastError=c,t.hasImage=!1}return{setHover:o,drawImageToSource:i,showLoadOk:a,showLoadError:s}}function cn(){return{loadedImageName:null,hasImage:!1,lastError:void 0}}const xe="beemage.actionLog",un=5e3;function dn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function gn(e){return Array.isArray(e)?e:[e]}function Me(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}async function ge(){const e=await le(xe),t=e==null?void 0:e[xe];return Array.isArray(t)?t:[]}async function vt(e){await ce({[xe]:e})}async function K(e,t){const o=Me(un,100,5e4),i=gn(e).map(p=>({...p,id:dn(),ts:Date.now()}));if(!i.length)return{total:(await ge()).length};const s=(await ge()).concat(i),c=s.length>o?s.slice(s.length-o):s;return await vt(c),{total:c.length}}async function pn(e){const t=Me((e==null?void 0:e.limit)??200,1,5e4),o=Me((e==null?void 0:e.offset)??0,0,1e6);let i=await ge();e!=null&&e.kind&&(i=i.filter(c=>c.kind===e.kind)),e!=null&&e.scope&&(i=i.filter(c=>c.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(i=i.filter(c=>c.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(i=i.filter(c=>c.ts<=e.untilTs));const a=i.length;i=i.slice().reverse();const s=i.slice(o,o+t);return{total:a,items:s}}async function fn(e){let o=await ge();if(typeof e.beforeTs=="number"&&(o=o.filter(n=>n.ts>=e.beforeTs)),typeof e.keepLast=="number"){const n=Me(e.keepLast,0,5e4);n===0?o=[]:o.length>n&&(o=o.slice(o.length-n))}return await vt(o),{total:o.length}}async function hn(){await We(xe)}async function mn(e){const t=await ge();return JSON.stringify(t,null,2)}const pe="beemage.debugTrace",Fe="beemage.debugTrace.enabled",bn=2e3;function yn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function _e(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}async function De(){const e=await le(pe),t=e==null?void 0:e[pe];return Array.isArray(t)?t:[]}async function vn(e){await ce({[pe]:e})}async function He(){const e=await le(Fe);return!!(e!=null&&e[Fe])}async function wt(e){await ce({[Fe]:!!e}),e||await We(pe)}async function Et(){await We(pe)}async function ie(e,t){if(!await He())return{total:0};const n=_e((t==null?void 0:t.max)??bn,100,5e4),i=(Array.isArray(e)?e:[e]).map(p=>({...p,id:yn(),ts:Date.now()}));if(!i.length)return{total:(await De()).length};const s=(await De()).concat(i),c=s.length>n?s.slice(s.length-n):s;return await vn(c),{total:c.length}}async function It(e){const t=_e((e==null?void 0:e.limit)??200,1,5e4),o=_e((e==null?void 0:e.offset)??0,0,1e6),n=(e==null?void 0:e.reverse)??!0,i=await De(),a=i.length,c=(n?i.slice().reverse():i).slice(o,o+t);return{total:a,items:c}}async function Ct(e){const t=await De();return JSON.stringify(t,null,e!=null&&e.pretty?2:0)}const kt=Object.freeze(Object.defineProperty({__proto__:null,append:ie,clear:Et,exportJson:Ct,isEnabled:He,list:It,setEnabled:wt},Symbol.toStringTag,{value:"Module"}));function wn(e,t){const o=cn(),n=ln(e,o);async function i(u){if(!u.type.startsWith("image/"))throw new Error(`Unsupported file type: ${u.type||"unknown"}`);const h=URL.createObjectURL(u);try{const f=new Image;return f.decoding="async",f.src=h,typeof f.decode=="function"?await f.decode():await new Promise((g,d)=>{f.onload=()=>g(),f.onerror=()=>d(new Error("Image decode failed."))}),f}finally{URL.revokeObjectURL(h)}}async function a(u){const h=await i(u);n.drawImageToSource(h),n.showLoadOk(u.name),K({scope:"panel",kind:"info",message:`Input loaded: ${u.name}`}),ie({scope:"panel",kind:"info",message:"Mage input loaded into srcCanvas",meta:{name:u.name,type:u.type,size:u.size,canvasW:e.srcCanvasEl.width,canvasH:e.srcCanvasEl.height,naturalW:h.naturalWidth||h.width,naturalH:h.naturalHeight||h.height}})}function s(){e.dropZoneEl.addEventListener("dragover",u=>{u.preventDefault(),n.setHover(!0)}),e.dropZoneEl.addEventListener("dragleave",()=>n.setHover(!1)),e.dropZoneEl.addEventListener("drop",u=>{var f,g;u.preventDefault(),n.setHover(!1);const h=(g=(f=u.dataTransfer)==null?void 0:f.files)==null?void 0:g[0];h&&a(h).catch(d=>{const m=d instanceof Error?d.message:String(d);n.showLoadError(m),K({scope:"panel",kind:"error",message:`Input load failed: ${m}`}),ie({scope:"panel",kind:"error",message:"Input load failed",meta:{error:m}})})}),e.fileInputEl.addEventListener("change",()=>{var h;const u=(h=e.fileInputEl.files)==null?void 0:h[0];u&&(a(u).catch(f=>{const g=f instanceof Error?f.message:String(f);n.showLoadError(g),K({scope:"panel",kind:"error",message:`Input load failed: ${g}`}),ie({scope:"panel",kind:"error",message:"Input load failed",meta:{error:g}})}),e.fileInputEl.value="")})}function c(){s()}function p(){}function l(){}return{id:"image",bind:c,mount:p,unmount:l}}function Re(e,t,o){return Number.isFinite(e)?Math.max(t,Math.min(o,Math.trunc(e))):t}function En(e,t,o){return Math.round(.2126*e+.7152*t+.0722*o)}function St(e){return{edgesDark:!!(e.edgesDark??!0),edgeThreshold:Re(e.edgeThreshold??80,0,255),edgeDilate:Re(e.edgeDilate??2,0,6),maxRegionPx:Re(e.maxRegionPx??2e5,1e3,1e7)}}function In(e,t,o){const{data:n,width:i,height:a}=e,s=new Uint8Array(i*a);for(let c=0,p=0;c<s.length;c++,p+=4){const l=n[p+0],u=n[p+1],h=n[p+2];if(n[p+3]===0){s[c]=0;continue}const g=En(l,u,h),d=t?g<=o:g>=255-o;s[c]=d?1:0}return s}function Cn(e,t,o,n){if(n<=0)return e;let i=e;for(let a=0;a<n;a++){const s=new Uint8Array(t*o);for(let c=0;c<o;c++)for(let p=0;p<t;p++){const l=c*t+p;if(i[l]){s[l]=1;continue}let u=0;for(let h=-1;h<=1&&!u;h++){const f=c+h;if(!(f<0||f>=o))for(let g=-1;g<=1;g++){const d=p+g;if(!(d<0||d>=t)&&i[f*t+d]){u=1;break}}}s[l]=u}i=s}return i}function kn(e,t,o,n,i,a){const s=t*n+e;if(o[s])return{ok:!1,message:"Click is on an edge; pick inside a region."};const c=new Uint8Array(n*i),p=new Int32Array(n*i),l=new Int32Array(n*i);let u=0,h=0;p[h]=e,l[h]=t,h++,c[s]=1;let f=1;for(;u<h;){const g=p[u],d=l[u];u++;const m=[[g-1,d],[g+1,d],[g,d-1],[g,d+1]];for(const[v,b]of m){if(v<0||v>=n||b<0||b>=i)continue;const y=b*n+v;if(!c[y]&&!o[y]&&(c[y]=1,p[h]=v,l[h]=b,h++,f++,f>a))return{ok:!1,message:`Region too large (>${a}px). Increase Max region or fix gaps.`}}}return{ok:!0,mask:c}}function Sn(e,t,o,n){const i=new Uint8Array(o*n);for(let a=1;a<n-1;a++)for(let s=1;s<o-1;s++){const c=a*o+s;if(!e[c])continue;const p=(a-1)*o+s,l=(a+1)*o+s,u=a*o+(s-1),h=a*o+(s+1);(!e[p]||!e[l]||!e[u]||!e[h]||t[p]||t[l]||t[u]||t[h])&&(i[c]=1)}return i}function xn(e,t,o,n){const i=St(n),a=e.width,s=e.height;let c=In(e,i.edgesDark,i.edgeThreshold);c=Cn(c,a,s,i.edgeDilate);const p=kn(t,o,c,a,s,i.maxRegionPx);if(!p.ok)return{ok:!1,message:p.message};const l=Sn(p.mask,c,a,s);return{ok:!0,preview:{mask:p.mask,outline:l,w:a,h:s}}}function Mn(e,t,o){const n=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),i=o.replace("#",""),a=parseInt(i.slice(0,2),16),s=parseInt(i.slice(2,4),16),c=parseInt(i.slice(4,6),16),p=n.data;for(let l=0,u=0;l<t.mask.length;l++,u+=4)t.mask[l]&&(p[u+0]=a,p[u+1]=s,p[u+2]=c);return n}function Pe(e,t,o){return Number.isFinite(e)?Math.max(t,Math.min(o,Math.trunc(e))):t}function Ze(e){const t=(e||"").trim();if(!t)return null;const o=t.startsWith("#")?t:`#${t}`;return/^#[0-9a-fA-F]{6}$/.test(o)?o.toLowerCase():null}function Dn(e){let t="#ff3b30",o=[],n=null;function i(m){e.colorsStatusEl.textContent=m||""}function a(){const m=!!e.edgesDarkEl.checked,v=Pe(parseInt(e.edgeMaskThresholdEl.value,10),0,255),b=Pe(parseInt(e.edgeDilateEl.value,10),0,6),y=Pe(parseInt(e.maxRegionPxEl.value,10),1e3,1e7);return e.edgeMaskThresholdEl.value=String(v),e.edgeDilateEl.value=String(b),e.maxRegionPxEl.value=String(y),St({edgesDark:m,edgeThreshold:v,edgeDilate:b,maxRegionPx:y})}function s(m){const v=Ze(m);if(v){t=v;for(const b of Array.from(e.paletteEl.querySelectorAll(".paletteItem"))){const y=b.dataset.hex||"";b.classList.toggle("is-selected",y===t)}}}function c(){return t}function p(m){o=m.slice(),e.paletteEl.innerHTML="";for(const v of o){const b=Ze(v);if(!b)continue;const y=document.createElement("button");y.type="button",y.className="paletteItem",y.style.background=b,y.dataset.hex=b,y.setAttribute("role","listitem"),y.setAttribute("aria-label",`Select ${b}`),y.addEventListener("click",()=>{s(b)}),e.paletteEl.appendChild(y)}s(t)}function l(m){const v=e.colorsCanvasEl;v.width=m.width,v.height=m.height,v.getContext("2d").putImageData(m,0,0)}function u(m,v){l(m);const b=e.colorsCanvasEl.getContext("2d"),{outline:y,w:I,h:S}=v,k=b.getImageData(0,0,I,S),O=k.data;for(let N=0,j=0;N<y.length;N++,j+=4)y[N]&&(O[j+0]=255,O[j+1]=60,O[j+2]=60,O[j+3]=220);b.putImageData(k,0,0)}function h(m){e.btnColorsApplyEl.disabled=!m}function f(m){e.btnColorsCancelEl.disabled=!m}function g(m){n=m}function d(){i("Idle"),h(!1),f(!1),e.colorsCanvasEl.addEventListener("click",m=>{if(!n)return;const v=e.colorsCanvasEl.getBoundingClientRect(),b=Math.floor((m.clientX-v.left)/v.width*e.colorsCanvasEl.width),y=Math.floor((m.clientY-v.top)/v.height*e.colorsCanvasEl.height);n(b,y)})}return{bind:d,setStatus:i,getSettings:a,setSelectedColor:s,getSelectedColor:c,renderPalette:p,drawBase:l,drawPreview:u,setApplyEnabled:h,setCancelEnabled:f,onCanvasClick:g}}let xt={type:"none"};function me(e){xt=e}function Xe(){return xt}function Oe(e){var s,c,p,l,u;const t=(s=e==null?void 0:e.outputSvg)==null?void 0:s.svg;if(typeof t=="string"&&t.length>0){me({type:"svg",svg:t});return}const o=(c=e==null?void 0:e.outputImage)==null?void 0:c.data;if(o){me({type:"image",image:o});return}const n=(p=e==null?void 0:e.outputMask)==null?void 0:p.data,i=(l=e==null?void 0:e.outputMask)==null?void 0:l.width,a=(u=e==null?void 0:e.outputMask)==null?void 0:u.height;if(n&&typeof i=="number"&&typeof a=="number"){me({type:"mask",mask:n,width:i,height:a});return}me({type:"none"})}const An=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#a2845e","#8e8e93","#1c1c1e","#ffffff","#000000","#4cd964","#5ac8fa","#ff6b6b","#7aa2ff","#f5a623","#50e3c2"];function Tn(e,t){const o=Dn(e);let n=null,i=null;function a(g){o.setStatus(g)}function s(g,d,m){const v=new ImageData(d,m),b=v.data;for(let y=0,I=0;y<g.length;y++,I+=4){const k=(g[y]??0)>0?0:255;b[I+0]=k,b[I+1]=k,b[I+2]=k,b[I+3]=255}return v}function c(){const g=Xe();return g.type==="image"?g.image:g.type==="mask"?s(g.mask,g.width,g.height):null}function p(){return Xe().type==="svg"?"Pipeline output is SVG. Colors needs an image or mask output.":"No pipeline output available. Run the Pipeline first."}function l(){const g=c();if(!g){n=null,i=null,o.setApplyEnabled(!1),o.setCancelEnabled(!1),a(p());return}n=g,i=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),a("Ready. Pick a color, click inside a region.")}function u(){if(n){o.drawBase(n);return}const g=c();if(!g){a(p());return}n=g,i=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),a("Loaded pipeline output. Pick a color, click inside a region.")}function h(){if(!n||!i)return;const g=o.getSelectedColor();n=Mn(n,i,g),i=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),a("Fill applied. Click another region.")}function f(){n&&(i=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),a("Preview canceled."))}return{bind(){o.bind(),o.renderPalette(An),o.onCanvasClick((g,d)=>{if(!n){a(p());return}const m=o.getSettings(),v=xn(n,g,d,m);if(!v.ok){i=null,o.setApplyEnabled(!1),o.setCancelEnabled(!1),a(v.message);return}i=v.preview,o.drawPreview(n,i),o.setApplyEnabled(!0),o.setCancelEnabled(!0),a("Preview shown. Apply fill or cancel.")}),e.btnColorsApplyEl.addEventListener("click",()=>h()),e.btnColorsCancelEl.addEventListener("click",()=>f()),e.btnColorsResetEl.addEventListener("click",()=>l()),e.tabColors.addEventListener("click",()=>{queueMicrotask(()=>u())}),a("Idle"),o.setApplyEnabled(!1),o.setCancelEnabled(!1)}}}const Qe="0.1.3";function Le(e){return`[BCT][${e}]`}function Rn(e){function t(...a){e.traceOn()&&console.log(Le("trace"),...a)}function o(...a){console.warn(Le("warn"),...a)}function n(...a){console.error(Le("error"),...a)}function i(a,s){t(a,s),ie({scope:e.scope,kind:"debug",message:a,meta:s})}return{logTrace:t,logWarn:o,logError:n,traceScope:i}}const{logTrace:L,logWarn:Ie,logError:te,traceScope:Mt}=Rn({scope:"panel",traceOn:()=>!!Se().traceConsole});let q=0;function J(){return q>0}function X(e,t){if(t){Dt(e);return}q=0,Ae(e,!1)}async function Pn(e,t){const o=`${Date.now()}-${Math.random().toString(16).slice(2)}`;L("[state] withBusy: enter",{id:o,busyCount:q}),Dt(e,o);try{L("[state] withBusy: before await fn",{id:o,busyCount:q});const n=await t();return L("[state] withBusy: after await fn (resolved)",{id:o,busyCount:q}),n}catch(n){throw te("[state] withBusy: fn threw",{id:o,busyCount:q,msg:String((n==null?void 0:n.message)??n),stack:String((n==null?void 0:n.stack)??"")}),n}finally{L("[state] withBusy: finally before endBusy",{id:o,busyCount:q}),On(e,o),L("[state] withBusy: finally after endBusy",{id:o,busyCount:q})}}function Dt(e,t){q++,L("[state] beginBusy",{id:t,busyCount:q}),q===1&&Ae(e,!0)}function On(e,t){if(q--,L("[state] endBusy: dec",{id:t,busyCount:q}),q<=0){q=0,L("[state] endBusy: applying busy=false",{id:t,busyCount:q}),Ae(e,!1);return}q===0&&(L("[state] endBusy: applying busy=false (redundant branch)",{id:t,busyCount:q}),Ae(e,!1))}function Ae(e,t){e.rootEl.classList.toggle("is-busy",t),e.cfgShowDevToolsEl.disabled=!1,e.fileInputEl.disabled=t,e.cfgTraceConsoleEl.disabled=t,e.cfgActionLogMaxEl.disabled=t,e.cfgDebugTraceMaxEl.disabled=t,e.cfgFailureLogsPerRunEl.disabled=t,e.btnCfgResetDefaults.disabled=t,e.logsCbDebugEl.disabled=t,e.cfgUseOpenCvEl.disabled=t,e.logsLimitEl.disabled=t,e.btnLogsRefresh.disabled=t,e.logsTrimKeepEl.disabled=t,e.btnLogsTrim.disabled=t,e.btnLogsExport.disabled=t,e.btnLogsClear.disabled=t,e.debugLimitEl.disabled=t,e.btnDebugRefresh.disabled=t,e.btnDebugExport.disabled=t,e.btnDebugClear.disabled=t,e.btnColorsApplyEl.disabled=t,e.btnColorsCancelEl.disabled=t,e.btnColorsResetEl.disabled=t,e.edgesDarkEl.disabled=t,e.edgeMaskThresholdEl.disabled=t,e.edgeDilateEl.disabled=t,e.maxRegionPxEl.disabled=t;for(const o of Array.from(e.paletteEl.querySelectorAll("button")))o.disabled=t;e.colorsCanvasEl.style.pointerEvents=t?"none":"auto"}const qe={native:{available:!0},opencv:{available:!1,reason:"OpenCV not loaded"}};function Ln(e){qe[e]={available:!0}}function $n(e,t){qe[e]={available:!1,reason:t}}function ne(){return qe.opencv.available===!0}async function Bn(e){const t=new URL(e.opencvJsRel,document.baseURI).toString(),o=new URL(e.opencvWasmRel,document.baseURI).toString(),n=globalThis;n.Module=n.Module||{},n.Module.locateFile=i=>i.endsWith(".wasm")?o:i,n.Module.print=()=>{},n.Module.printErr=()=>{},n.cv||await Vn(t),await zn(e.timeoutMs)}function Vn(e){return new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0;const i=15e3,a=window.setTimeout(()=>{s(),o(new Error(`OpenCV script load timeout after ${i}ms: ${e}`))},i);function s(){window.clearTimeout(a),n.onload=null,n.onerror=null}n.onload=()=>{s(),t()},n.onerror=()=>{s(),o(new Error(`Failed to load OpenCV script: ${e}`))},document.head.appendChild(n)})}async function zn(e){var n;const t=Date.now(),o=globalThis;for(;Date.now()-t<e;){try{if(o.cv&&typeof o.cv.Mat=="function"){const i=new o.cv.Mat;(n=i.delete)==null||n.call(i);return}}catch{}await new Promise(i=>setTimeout(i,75))}throw new Error(`OpenCV initialization timeout after ${e}ms`)}async function Un(){try{await Bn({opencvJsRel:"../assets/opencv/opencv.js",opencvWasmRel:"../assets/opencv/opencv.wasm",timeoutMs:2e4}),Ln("opencv")}catch(e){throw $n("opencv",e!=null&&e.message?String(e.message):String(e)),e}}function G(e,t,o,n,i,a,s){return{id:e,title:t,implementedEngines:o,defaultEnginePolicy:n,params:i,children:a,description:s}}function Nn(e){const t=new Map,o=new Map;function n(i,a){if(t.has(i.id))throw new Error(`[tuning] Duplicate component id: ${i.id}`);t.set(i.id,i),o.set(i.id,a);for(const s of i.children??[])n(s,i.id)}return n(e,null),{root:e,byId:t,parentById:o}}function At(){const e=G("app","BeeMage",["native","opencv"],"native",{},[G("edge","Edge",["native","opencv"],"auto",{},[G("edge.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),G("edge.threshold","Threshold",["native","opencv"],"auto",{manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128}},void 0,"Convert image into a binary mask before edge extraction."),G("edge.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:3},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Clean the mask before extracting edges."),G("edge.extract","Edge extract",["native","opencv"],"auto",{},void 0,"Extract a 1px outline from the cleaned mask.")],"Fixed-order edge pipeline (image -> mask -> edges). Presets configure each step."),G("svg","SVG",["native","opencv"],"auto",{},[G("svg.create","Create SVG",["native","opencv"],"auto",{scale:{kind:"number",label:"Scale",min:1,max:10,step:1,default:1},transparentBg:{kind:"number",label:"Transparent bg (0/1)",min:0,max:1,step:1,default:1},color:{kind:"text",label:"Color",default:"#3bca1e"}},void 0,"Convert the edge mask into an SVG.")],"SVG generation parameters."),G("segmentation","Segmentation",["native","opencv"],"auto",{},[G("segmentation.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),G("segmentation.denoise","Denoise",["native","opencv"],"auto",{denoiseAlgo:{kind:"number",label:"Denoise algo",min:0,max:2,step:1,default:1},blurK:{kind:"number",label:"Blur kernel",min:1,max:21,step:2,default:3},bilateralSigma:{kind:"number",label:"Bilateral sigma",min:1,max:150,step:1,default:35}},void 0,"Reduce noise before thresholding."),G("segmentation.color","Color / Gray",["native","opencv"],"auto",{colorMode:{kind:"number",label:"Color mode",min:0,max:3,step:1,default:1},hsvChannel:{kind:"number",label:"HSV channel",min:0,max:2,step:1,default:2}},void 0,"Select color space / channel features for thresholding."),G("segmentation.threshold","Threshold",["native","opencv"],"auto",{thresholdAlgo:{kind:"number",label:"Threshold algo",min:0,max:3,step:1,default:1},manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128},adaptBlock:{kind:"number",label:"Adaptive block",min:3,max:101,step:2,default:31},adaptC:{kind:"number",label:"Adaptive C",min:-50,max:50,step:1,default:3}},void 0,"Convert features into a binary mask."),G("segmentation.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:5},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Remove specks, fill holes, and stabilize regions.")],"Fixed-order segmentation pipeline. Presets configure each step."),G("image","iMage",["native","opencv"],"auto",{},[G("mage.process","Process",["native"],"auto",{imageScale:{kind:"number",label:"Processing scale",min:25,max:100,step:5,default:100},edgeThreshold:{kind:"number",label:"Edge threshold",min:1,max:255,step:1,default:70},invertOutput:{kind:"boolean",label:"White background",default:!0}}),G("mage.clean","Clean & Smooth",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:500,step:1,default:12},cleanRadius:{kind:"number",label:"Repair strength",min:1,max:3,step:1,default:1},cleanBinaryThreshold:{kind:"number",label:"Binary threshold",min:1,max:254,step:1,default:128}},[G("mage.clean.threshold","Threshold",["native"],"auto",{}),G("mage.clean.removeSmallComponents","Remove small components",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:5e3,step:1,default:12}},void 0,"Remove connected components smaller than the minimum area."),G("mage.clean.repair","Repair gaps",["native"],"auto",{}),G("mage.clean.smooth","Smooth mask",["native"],"auto",{}),G("mage.clean.quality","Quality metrics",["native"],"auto",{})]),G("mage.vectorize","Vectorize (SVG)",["native"],"native",{pathSmoothIters:{kind:"number",label:"Path smoothing",min:0,max:4,step:1,default:2}})]),G("colors","Colors",["native"],"auto",{},[G("colors.fill","Region fill",["native"],"auto",{edgesDark:{kind:"boolean",label:"Edges are dark",default:!0},edgeMaskThreshold:{kind:"number",label:"Edge threshold",min:0,max:255,step:1,default:80},edgeDilate:{kind:"number",label:"Gap close (px)",min:0,max:6,step:1,default:2},maxRegionPx:{kind:"number",label:"Max region (px)",min:1e3,step:1e3,default:2e5}})]),G("pipeline","Pipeline (UI)",["native","opencv"],"auto",{mode:{kind:"text",label:"Pipeline",default:"segmentation"},recipe:{kind:"text",label:"Recipe",default:"default"}},void 0,"UI state for the Pipeline tab (selected pipeline + recipe).")]);return Nn(e)}function jn(e){return e.default}function Fn(e,t){const o={};for(const[n,i]of Object.entries(e))o[n]=jn(i);for(const[n,i]of Object.entries(t??{}))o[n]=i;return o}function _n(e,t,o){var i;let n=e;for(;n;){const a=t.byId.get(n);if(!a)throw new Error(`[tuning] Unknown component: ${n}`);const c=((i=o[n])==null?void 0:i.enginePolicy)??a.defaultEnginePolicy;if(c!=="inherit")return c;n=t.parentById.get(n)??null}return"native"}function Gn(e,t,o){const n=o.opencvReady&&e.includes("opencv");return e.includes("native")||e.length,t==="native"?{engine:"native"}:t==="opencv"?n?{engine:"opencv"}:{engine:"native",fallbackReason:o.opencvReady?"Policy=opencv, but component has no OpenCV implementation.":"Policy=opencv, but OpenCV is not available at runtime."}:t==="auto"?n?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}function Tt(e,t,o,n){var l;const i=t.byId.get(e);if(!i)throw new Error(`[tuning] Unknown component: ${e}`);const a=_n(e,t,o),{engine:s,fallbackReason:c}=Gn(i.implementedEngines,a,n),p=Fn(i.params,(l=o[e])==null?void 0:l.params);return{id:e,policy:a,engine:s,fallbackReason:c,params:p}}const Ge="beemage.tuning.components.v1";async function fe(){const e=await le([Ge]).catch(()=>({})),t=e==null?void 0:e[Ge];return!t||typeof t!="object"?{}:t}async function Rt(e){await ce({[Ge]:e}).catch(()=>null)}async function $e(e,t){const o=await fe(),n=o[e]??{};o[e]={enginePolicy:t.enginePolicy??n.enginePolicy,params:{...n.params??{},...t.params??{}}},await Rt(o)}async function et(e){const t=await fe();delete t[e],await Rt(t)}function Kn(){return{opencvReady:ne()}}function Wn(e){return Array.isArray(e.children)&&e.children.length>0}function Pt(e){const{id:t,registry:o,stored:n,runtime:i}=e,a=o.byId.get(t);if(!a)throw new Error(`[tuning] Unknown component: ${t}`);const s=Tt(t,o,n,i),c=n[t],p=c==null?void 0:c.enginePolicy,l=c==null?void 0:c.params,u=a.implementedEngines.includes("opencv"),h=!!i.opencvReady,f=[];for(const g of a.children??[])f.push(Pt({id:g.id,registry:o,stored:n,runtime:i}));return{id:a.id,title:a.title,description:a.description,isGroup:Wn(a),implementedEngines:a.implementedEngines,storedPolicy:p,storedParams:l,effectivePolicy:s.policy,effectiveEngine:s.engine,fallbackReason:s.fallbackReason,paramsSchema:a.params,effectiveParams:s.params,canImplementOpenCv:u,runtimeOpenCvReady:h,children:f}}function Ot(e={}){const t=e.registry??At(),o=e.getRuntimeAvailability??Kn;async function n(p="app"){const l=await fe(),u=o();if(!t.byId.get(p))throw new Error(`[tuning] Unknown scope: ${p}`);const f=Pt({id:p,registry:t,stored:l,runtime:u});return{scopeId:p,runtime:u,stored:l,root:f}}async function i(p,l){await $e(p,{enginePolicy:l})}async function a(p,l,u){await $e(p,{params:{[l]:u}})}async function s(p){await et(p)}async function c(p,l){const h=(await fe())[p];if(!(h!=null&&h.params))return;const f={...h.params??{}};delete f[l];const g=typeof h.enginePolicy=="string",d=Object.keys(f).length>0;if(!g&&!d){await et(p);return}await $e(p,{enginePolicy:h.enginePolicy,params:f})}return{getRegistry:()=>t,loadTree:n,setEnginePolicy:i,setParam:a,resetNode:s,resetParam:c}}function U(e,t,o){const n=document.createElement(e);if(t)for(const[i,a]of Object.entries(t))n.setAttribute(i,a);return typeof o=="string"&&(n.textContent=o),n}function tt(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function Hn(e){return e.fallbackReason?`${e.effectiveEngine} (fallback)`:e.effectiveEngine}function qn(e){const t=[{value:"native",label:"Native"},{value:"auto",label:"Auto"},...e.canImplementOpenCv?[{value:"opencv",label:"OpenCV"}]:[]];return e.isRoot?t:[{value:"inherit",label:"Inherit"},...t]}function Jn(e){return!1}function Yn(e,t,o){var i;const n=(i=e.storedParams)==null?void 0:i[t];return typeof n<"u"&&n!==o}function Zn(e){var h;const{node:t,compId:o,key:n,schema:i,value:a,handlers:s}=e,c=U("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),p=U("label",{class:"fieldInline"}),l=U("span",void 0,i.label);p.appendChild(l);let u;if(i.kind==="number"?(u=U("input"),u.type="number",typeof i.min=="number"&&(u.min=String(i.min)),typeof i.max=="number"&&(u.max=String(i.max)),typeof i.step=="number"&&(u.step=String(i.step)),u.value=String(a??i.default),u.addEventListener("change",()=>{const f=Number(u.value);s.onSetParam(o,n,Number.isFinite(f)?f:i.default)})):i.kind==="boolean"?(u=U("input"),u.type="checkbox",u.checked=!!a,u.addEventListener("change",()=>{s.onSetParam(o,n,!!u.checked)})):(u=U("input"),u.type="text",u.value=String(a??i.default),u.addEventListener("change",()=>{s.onSetParam(o,n,String(u.value??i.default))})),p.appendChild(u),c.appendChild(p),s.onResetParam&&typeof((h=t.storedParams)==null?void 0:h[n])<"u"){const f=U("button",{type:"button"},"Reset");f.addEventListener("click",g=>{var d;g.preventDefault(),(d=s.onResetParam)==null||d.call(s,o,n)}),c.appendChild(f)}return Yn(t,n,a)&&c.appendChild(U("span",{class:"muted",style:"font-size:12px;"},"override")),c}function Lt(e){const{node:t,depth:o,isRoot:n,handlers:i,treeScopeId:a}=e,s=U("div",{style:`margin-left:${Math.min(o*14,56)}px; margin-top:10px;`}),c=U("div",{style:"border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:10px; background:rgba(0,0,0,0.12);"}),p=U("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),l=U("div");l.appendChild(U("div",{style:"font-weight:700;"},t.title)),t.description&&l.appendChild(U("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},t.description)),t.isGroup&&l.appendChild(U("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},"Group (policy affects children)")),p.appendChild(l);const u=U("div",{class:"row",style:"align-items:center; gap:10px;"});u.appendChild(U("span",{class:"qBadge"},Hn(t)));const h=U("select");h.style.background="rgba(255,255,255,0.05)",h.style.border="1px solid rgba(255,255,255,0.08)",h.style.color="rgba(255,255,255,0.92)",h.style.borderRadius="10px",h.style.padding="6px 8px";const f=qn({isRoot:n,canImplementOpenCv:t.canImplementOpenCv});for(const I of f){const S=U("option");S.value=I.value,S.textContent=I.label,h.appendChild(S)}const g=new Set(f.map(I=>I.value)),d=t.effectivePolicy;g.has(d)?h.value=d:h.value=n?"native":"inherit",h.addEventListener("change",()=>{i.onSetPolicy(t.id,h.value)}),u.appendChild(h);const m=typeof t.storedPolicy<"u"||t.storedParams&&Object.keys(t.storedParams).length>0;if(i.onResetNode&&m){const I=U("button",{type:"button"},"Reset node");I.addEventListener("click",S=>{var k;S.preventDefault(),(k=i.onResetNode)==null||k.call(i,t.id)}),u.appendChild(I)}p.appendChild(u),c.appendChild(p),t.fallbackReason?c.appendChild(U("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},t.fallbackReason)):t.effectivePolicy==="opencv"&&!t.runtimeOpenCvReady&&c.appendChild(U("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},"OpenCV policy selected, but OpenCV is not available at runtime. It will fall back to native."));const v=Object.keys(t.paramsSchema??{}),b=v.length>0,y=t.children.length>0;if(b||y){const I=U("details",{style:"margin-top:10px;"});I.open=Jn();const S=U("summary",{style:"cursor:pointer; user-select:none;"},"Details");if(I.appendChild(S),b){const k=U("div",{style:"margin-top:10px;"});k.appendChild(U("div",{class:"muted",style:"font-weight:600; margin-bottom:6px;"},"Parameters"));for(const O of v){const N=t.paramsSchema[O],j=t.effectiveParams[O];k.appendChild(Zn({node:t,compId:t.id,key:O,schema:N,value:j,handlers:i}))}I.appendChild(k)}if(y){const k=U("div",{style:"margin-top:10px;"});for(const O of t.children)k.appendChild(Lt({node:O,depth:o+1,isRoot:!1,handlers:i,treeScopeId:a}));I.appendChild(k)}c.appendChild(I)}return s.appendChild(c),s}function $t(e,t){let o=!1;function n(a){if(o)return;tt(e);const s=a.scopeId==="app",c=U("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"});c.appendChild(U("div",{style:"font-weight:700;"},"Tuning")),c.appendChild(U("div",{class:"muted",style:"font-size:12px;"},`OpenCV runtime: ${a.runtime.opencvReady?"ready":"not available"}`)),e.appendChild(c),e.appendChild(Lt({node:a.root,depth:0,isRoot:s,handlers:t,treeScopeId:a.scopeId}))}function i(){o=!0,tt(e)}return{render:n,dispose:i}}function Xn(){let e=!1,t={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},o=!1,n="",i="";function a(l){e=l}function s(l){t={...t,...l}}function c(l){o=l}function p(l){typeof l.general=="string"&&(n=l.general),typeof l.dev=="string"&&(i=l.dev)}return{get showDevTools(){return e},get dev(){return t},get debugEnabled(){return o},get generalStatus(){return n},get devStatus(){return i},setShowDevTools:a,setDev:s,setDebugEnabled:c,setStatus:p}}function Qn(e){function t(l){e.settingsGeneralStatusEl.textContent=l||""}function o(l){e.cfgStatusEl.textContent=l||""}function n(l){e.cfgShowDevToolsEl.checked=l}function i(l){e.tabLogs.hidden=!l,e.devConfigDetailsEl.classList.toggle("is-hidden",!l),l||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function a(l){e.cfgTraceConsoleEl.checked=!!l.traceConsole,e.cfgActionLogMaxEl.value=String(l.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(l.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(l.failureLogsPerRun??50)}function s(l){e.logsCbDebugEl.checked=l}function c(l,u){e.settingsVersionEl.textContent=l||"—",e.settingsGitHubLinkEl.href=u||"#",e.settingsGitHubLinkEl.hidden=!u}function p(l){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=l,e.cfgActionLogMaxEl.disabled=l,e.cfgDebugTraceMaxEl.disabled=l,e.cfgFailureLogsPerRunEl.disabled=l,e.btnCfgResetDefaults.disabled=l,e.logsCbDebugEl.disabled=l,e.cfgUseOpenCvEl.disabled=l}return{setGeneralStatus:t,setDevStatus:o,setShowDevToolsChecked:n,setDevToolsVisible:i,setDevConfig:a,setDebugEnabledChecked:s,setAbout:c,setBusy:p}}const Be="template.settings.showDevTools",Ve="beemage.settings.engine.useOpenCv";function eo(){var e,t;try{const o=(e=globalThis==null?void 0:globalThis.chrome)==null?void 0:e.runtime,n=(t=o==null?void 0:o.getManifest)==null?void 0:t.call(o),i=typeof(n==null?void 0:n.version)=="string"?n.version:"";if(L("Settings: getManifestVersion manifest found version is ",{v:i}),i)return i}catch{}return L("Settings: getManifestVersion fallback",{APP_VERSION:Qe}),Qe}function ze(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??Y.actionLogMax),debugTraceMax:Number(e.debugTraceMax??Y.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??Y.failureLogsPerRun)}}function to(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:ee(e.cfgActionLogMaxEl.value,100,5e4,Y.actionLogMax),debugTraceMax:ee(e.cfgDebugTraceMaxEl.value,100,5e4,Y.debugTraceMax),failureLogsPerRun:ee(e.cfgFailureLogsPerRunEl.value,0,5e4,Y.failureLogsPerRun)}}async function nt(e){const t=kt;return typeof t.setEnabled=="function"?(await t.setEnabled(e),{ok:!0}):typeof t.enable=="function"&&typeof t.disable=="function"?(await(e?t.enable():t.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function no(e,t){const o=Xn(),n=Qn(e),i=Ot({getRuntimeAvailability:()=>({opencvReady:e.cfgUseOpenCvEl.checked&&ne()})}),a=$t(e.tuningMountEl,{onSetPolicy:async(r,w)=>{await i.setEnginePolicy(r,w),await y("policy change")},onSetParam:async(r,w,x)=>{await i.setParam(r,w,x),await y("param change")},onResetNode:async r=>{await i.resetNode(r),await y("reset node")},onResetParam:async(r,w)=>{await i.resetParam(r,w),await y("reset param")}});function s(r){e.settingsEngineBoxEl.classList.toggle("is-hidden",!1)}async function c(){const r=await le([Ve]).catch(()=>({}));return(r==null?void 0:r[Ve])===!0}async function p(r){await ce({[Ve]:!!r}).catch(()=>null)}function l(r){var w;e.cfgUseOpenCvEl.checked=r,(w=e.cfgUseOpenCvEl.closest(".switch"))==null||w.classList.toggle("is-disabled",e.cfgUseOpenCvEl.disabled)}function u(r){e.cfgOpenCvSpinner.classList.toggle("is-hidden",!r),e.cfgOpenCvSpinner.setAttribute("aria-hidden",r?"false":"true")}function h(r){e.cfgOpenCvStatus.textContent=r||""}function f(r){e.cfgOpenCvReport.textContent=r||""}async function g(){if(J())return;if(!!!e.cfgUseOpenCvEl.checked){await p(!1),u(!1),h(ne()?"OpenCV loaded (native mode)":"Native mode"),f("Native mode. OpenCV is optional and demo-only."),await y("opencv mode disabled");return}u(!0),h("Loading OpenCV…"),f("Loading OpenCV…");try{if(await Pn(e,async()=>{await Un()}),!ne())throw new Error("OpenCV load returned but runtime is not injected.");await p(!0),h("OpenCV mode enabled"),f("OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV."),await y("opencv mode enabled")}catch(w){const x=String((w==null?void 0:w.message)??w);await p(!1),l(!1),h("OpenCV load failed"),f(`ERROR

${x}`),te("[settings] OpenCV toggle failed",{msg:x})}finally{u(!1)}}async function d(){const r=await le([Be]).catch(()=>({}));return(r==null?void 0:r[Be])===!0}async function m(r){await ce({[Be]:!!r}).catch(()=>null)}function v(r){o.setShowDevTools(r),n.setShowDevToolsChecked(r),n.setDevToolsVisible(r)}async function b(){const r=await d();v(r),L("Settings: boot applyDevToolsVisibility",{showDevTools:r})}async function y(r){try{const w=await i.loadTree("app");a.render(w),L("[settings] tuning rendered",{reason:r,opencvInjected:ne(),opencvMode:!!e.cfgUseOpenCvEl.checked})}catch(w){te("[settings] tuning render failed",{reason:r,msg:String((w==null?void 0:w.message)??w)}),e.tuningMountEl.textContent="Tuning UI failed to load (see console)."}}async function I(){var V;n.setBusy(J());const r=await d();v(r),await je().catch(()=>null);const w=Se();o.setDev(ze(w)),n.setDevConfig(o.dev);const x=kt;let D=!1;try{typeof x.isEnabled=="function"?D=!!await x.isEnabled():D=!!x.enabled}catch($){Ie("Settings: failed to read debug enabled state",{error:$ instanceof Error?$.message:String($)})}o.setDebugEnabled(D),n.setDebugEnabledChecked(D),n.setAbout(eo()||"—",((V=e.settingsGitHubLinkEl)==null?void 0:V.href)||"#"),s();{const $=await c();l($),u(!1);const z=ne();$?(h(z?"OpenCV mode enabled":"OpenCV mode (not loaded)"),f(z?"OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV.":"OpenCV mode is enabled, but OpenCV is not loaded yet. Toggle OFF then ON to load OpenCV.")):(h(z?"OpenCV loaded (native mode)":"Native mode"),f("Native mode. OpenCV is optional and demo-only."))}n.setGeneralStatus(""),n.setDevStatus(""),await y("loadAll"),L("Settings: loaded",{showDevTools:r,debugTraceEnabled:D,dev:o.dev,opencvInjected:ne()})}async function S(){const r=!!e.cfgShowDevToolsEl.checked;v(r),await m(r),K({kind:"run",scope:"settings",message:r?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:r}}),L("Settings: ui toggle showDevTools",{showDevTools:r}),n.setGeneralStatus(r?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>n.setGeneralStatus(""),1200)}async function k(){const r=to(e);n.setDevStatus("Saving…");try{await yt(r)}catch(w){te("Settings: failed to save dev config",{error:w instanceof Error?w.message:String(w),next:r}),n.setDevStatus("Save failed."),setTimeout(()=>n.setDevStatus(""),1200);return}o.setDev(ze(r)),n.setDevConfig(o.dev),K({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:r}),L("Settings: devConfig updated",r),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}async function O(){n.setDevStatus("Resetting…");try{await an(),await je().catch(()=>null);const w=Se();o.setDev(ze(w)),n.setDevConfig(o.dev)}catch(w){te("Settings: failed to reset dev config defaults",{error:w instanceof Error?w.message:String(w)}),n.setDevStatus("Reset failed."),setTimeout(()=>n.setDevStatus(""),1200);return}const r=await nt(!1);r.ok?(o.setDebugEnabled(!1),n.setDebugEnabledChecked(!1)):(Ie("Settings: failed to reset debug enabled state",{error:r.error||"unknown error"}),K({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:r.error||"unknown error"})),K({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...Y,debugEnabled:!1}}),L("Settings: reset defaults",{...Y,debugEnabled:!1}),n.setDevStatus("Reset."),setTimeout(()=>n.setDevStatus(""),1200)}async function N(){const r=!!e.logsCbDebugEl.checked;n.setDevStatus("Saving…");const w=await nt(r);if(!w.ok){e.logsCbDebugEl.checked=!r,n.setDevStatus(`Save failed: ${w.error||"unknown error"}`),te("Settings: failed to change debug enabled state",{error:w.error||"unknown error",enabled:r}),K({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:w.error||"unknown error",meta:{enabled:r}});return}o.setDebugEnabled(r),K({kind:"run",scope:"settings",message:r?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:r}}),L("Settings: debug enabled changed",{enabled:r}),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}const j=t.on(()=>{});function B(){e.cfgShowDevToolsEl.addEventListener("change",()=>{S()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{J()||k()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{J()||k()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{J()||k()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{J()||k()}),e.btnCfgResetDefaults.addEventListener("click",()=>{J()||O()}),e.logsCbDebugEl.addEventListener("change",()=>{J()||N()}),e.cfgUseOpenCvEl.addEventListener("change",()=>{g()}),b().catch(r=>{Ie("Settings: initDevToolsVisibility failed",{error:r instanceof Error?r.message:String(r)})})}return{id:"settings",refresh(){I().catch(r=>{te("Settings: refresh failed",{error:r instanceof Error?r.message:String(r)})})},mount(){I().catch(r=>{te("Settings: mount failed",{error:r instanceof Error?r.message:String(r)})})},unmount(){},bind:B,dispose(){j()}}}function oo(){let e=[],t=0;function o(n){e=n.items,t=n.total}return{get items(){return e},get total(){return t},set:o}}function io(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function ot(e,t){const o=[];o.push(`Total entries: ${t.total}`),o.push("");for(const n of t.items){const i=typeof n.ok=="boolean"?n.ok?"ok":"fail":"",a=[];typeof n.status=="number"&&a.push(`status=${n.status}`),i&&a.push(i);const s=[n.scope,n.kind].filter(Boolean).join("/");o.push(`[${io(n.ts)}] ${s}${a.length?` (${a.join(", ")})`:""}`),o.push(`  ${n.message}`),n.error&&o.push(`  error: ${n.error}`),o.push("")}e.textContent=o.join(`
`),e.scrollTop=0}function ao(e){function t(s){e.logsStatusEl.textContent=s}function o(s){e.debugStatusEl.textContent=s}function n(s){e.logsCbDebugEl.checked=s}function i(s){ot(e.logsOutEl,{total:s.total,items:s.items.map(c=>({ts:c.ts,message:c.message,scope:c.scope,kind:c.kind,ok:c.ok,status:c.status,error:c.error,meta:c.meta}))})}function a(s){ot(e.debugOutEl,{total:s.total,items:s.items.map(c=>({ts:c.ts,message:c.message,scope:c.scope,kind:c.kind,ok:c.ok,status:c.status,error:c.error,meta:c.meta}))})}return{setAuditStatus:t,setDebugStatus:o,setDebugChecked:n,renderAudit:i,renderDebug:a}}const it="beemage";function so(e,t){const o=oo(),n=ao(e);async function i(){n.setAuditStatus("Loading…"),X(e,!0);try{const d=ee(e.logsLimitEl.value,10,5e3,200),m=await pn({limit:d,reverse:!0});o.set(m),n.renderAudit({items:o.items,total:o.total}),n.setAuditStatus(`Showing ${o.items.length} (newest first)`)}catch(d){n.setAuditStatus(`Failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{X(e,!1)}}async function a(){n.setDebugStatus("Loading…"),X(e,!0);try{const d=ee(e.debugLimitEl.value,10,5e3,200),m=await It({limit:d,reverse:!0});n.renderDebug(m),n.setDebugStatus(`Showing ${m.items.length} (newest first)`)}catch(d){n.setDebugStatus(`Failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{X(e,!1)}}async function s(){const d=await He();n.setDebugChecked(d)}async function c(d){if(await wt(d),n.setDebugChecked(d),!d){n.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}n.setDebugStatus("Debug ON."),await a()}async function p(){const d=ee(e.logsTrimKeepEl.value,0,5e4,2e3);n.setAuditStatus("Trimming…"),X(e,!0);try{const m=await fn({keepLast:d});await i(),n.setAuditStatus(`Trimmed. Remaining: ${m.total}`)}catch(m){n.setAuditStatus(`Trim failed: ${(m==null?void 0:m.message)||String(m)}`)}finally{X(e,!1)}}async function l(){n.setAuditStatus("Clearing…"),X(e,!0);try{await hn(),await i(),n.setAuditStatus("Cleared.")}catch(d){n.setAuditStatus(`Clear failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{X(e,!1)}}async function u(){n.setAuditStatus("Exporting…");try{const d=await mn({pretty:!0}),m=new Blob([d],{type:"application/json"}),v=URL.createObjectURL(m),b=document.createElement("a");b.href=v,b.download=`${it}-audit-${Date.now()}.json`,b.click(),setTimeout(()=>URL.revokeObjectURL(v),1e3),n.setAuditStatus("Exported.")}catch(d){n.setAuditStatus(`Export failed: ${(d==null?void 0:d.message)||String(d)}`)}}async function h(){n.setDebugStatus("Clearing…"),X(e,!0);try{await Et(),await a(),n.setDebugStatus("Cleared.")}catch(d){n.setDebugStatus(`Clear failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{X(e,!1)}}async function f(){n.setDebugStatus("Exporting…");try{const d=await Ct({pretty:!0}),m=new Blob([d],{type:"application/json"}),v=URL.createObjectURL(m),b=document.createElement("a");b.href=v,b.download=`${it}-debug-${Date.now()}.json`,b.click(),setTimeout(()=>URL.revokeObjectURL(v),1e3),n.setDebugStatus("Exported.")}catch(d){n.setDebugStatus(`Export failed: ${(d==null?void 0:d.message)||String(d)}`)}}function g(){e.btnLogsRefresh.addEventListener("click",()=>{J()||i()}),e.btnLogsTrim.addEventListener("click",()=>{J()||p()}),e.btnLogsClear.addEventListener("click",()=>{J()||l()}),e.btnLogsExport.addEventListener("click",()=>{J()||u()}),e.logsCbDebugEl.addEventListener("change",()=>{J()||c(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{J()||a()}),e.btnDebugClear.addEventListener("click",()=>{J()||h()}),e.btnDebugExport.addEventListener("click",()=>{J()||f()})}return{id:"logs",bind:g,mount(){s(),i(),a()},unmount(){},dispose(){}}}function ro(e,t){if(e.id===t)return e;const o=[...e.children??[]];for(;o.length>0;){const n=o.shift();if(n.id===t)return n;for(const i of n.children??[])o.push(i)}throw new Error(`[tuning] scopeRootId not found in VM tree: ${t}`)}function lo(e,t){if(e.id===t)return e;const o=[...e.children??[]];for(;o.length>0;){const n=o.shift();if(n.id===t)return n;for(const i of n.children??[])o.push(i)}return null}function co(e){const t=Ot({getRuntimeAvailability:e.getRuntimeAvailability}),o=[];let n=!1;async function i(){return await t.loadTree("app")}async function a(){if(n)return;const b=await i();for(const y of o){if(y.scopeRootId==="app"){y.view.render(b);continue}const I=ro(b.root,y.scopeRootId);y.view.render({...b,scopeId:y.scopeRootId,root:I})}}async function s(b,y){await t.setEnginePolicy(b,y),e.actionLogAppend(`[tuning] policy ${b} = ${y}`),e.debugTraceAppend(`[tuning] setPolicy id=${b} policy=${y}`),await a()}async function c(b,y,I){await t.setParam(b,y,I),e.actionLogAppend(`[tuning] param ${b}.${y} = ${String(I)}`),e.debugTraceAppend(`[tuning] setParam id=${b} key=${y} value=${String(I)}`),await a()}async function p(b){await t.resetNode(b),e.actionLogAppend(`[tuning] reset node ${b}`),e.debugTraceAppend(`[tuning] resetNode id=${b}`),await a()}async function l(b,y){await t.resetParam(b,y),e.actionLogAppend(`[tuning] reset param ${b}.${y}`),e.debugTraceAppend(`[tuning] resetParam id=${b} key=${y}`),await a()}async function u(b){var y,I;if(!n){if(b.policies)for(const S of b.policies)await t.setEnginePolicy(S.id,S.policy);if(b.params)for(const S of b.params)await t.setParam(S.id,S.key,S.value);e.actionLogAppend(`[tuning] preset ${b.id} (${b.title})`),e.debugTraceAppend(`[tuning] applyPreset id=${b.id} title=${b.title} policies=${((y=b.policies)==null?void 0:y.length)??0} params=${((I=b.params)==null?void 0:I.length)??0}`),await a()}}async function h(b){const y=await i(),I=lo(y.root,b);if(!I)throw new Error(`[tuning] getEffectiveParams: unknown component id ${b}`);return{...I.effectiveParams??{}}}async function f(b,y,I){await t.setParam(b,y,I),e.actionLogAppend(`[tuning] param ${b}.${y} = ${String(I)}`),e.debugTraceAppend(`[tuning] setParamValue id=${b} key=${y} value=${String(I)}`),await a()}function g(b){if(n)return;const{mountEl:y,scopeRootId:I}=b;if(o.some(k=>k.mountEl===y))return;const S=$t(y,{onSetPolicy:s,onSetParam:c,onResetNode:p,onResetParam:l});o.push({mountEl:y,scopeRootId:I,view:S}),a()}function d(b){const y=o.findIndex(I=>I.mountEl===b);y<0||(o[y].view.dispose(),o.splice(y,1))}async function m(){await a()}function v(){n=!0;for(const b of o)b.view.dispose();o.length=0}return{mount:g,unmount:d,refresh:m,applyPreset:u,getEffectiveParams:h,setParamValue:f,dispose:v}}function R(e,t,o){const n=document.createElement(e);if(t)for(const[i,a]of Object.entries(t))n.setAttribute(i,a);return typeof o=="string"&&(n.textContent=o),n}function uo(e){return e.type==="image"}function go(e){return e.type==="mask"}function po(e){return e.type==="svg"}function Bt(e){return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(e)}`}function at(e,t){if(uo(e)){const n=R("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return Ce(n,e.image),n}if(go(e)){const n=R("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return Ke(n,e.mask,e.width,e.height),n}if(!po(e))return R("div",{class:"muted",style:"margin-top:8px; font-size:12px;"},`Unsupported output: ${String(e.type)}`);const o=R("img",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`,"aria-label":"SVG preview"});return o.src=Bt(e.svg),o}function Vt(e,t){const o=URL.createObjectURL(t),n=document.createElement("a");n.href=o,n.download=e,n.rel="noopener",n.click(),setTimeout(()=>URL.revokeObjectURL(o),500)}async function st(e,t){const o=await new Promise(n=>t.toBlob(i=>n(i),"image/png"));if(!o)throw new Error("Failed to create PNG blob.");Vt(e,o)}function Ce(e,t){e.width=t.width,e.height=t.height;const o=e.getContext("2d",{willReadFrequently:!0});o&&o.putImageData(t,0,0)}function Ke(e,t,o,n){e.width=o,e.height=n;const i=e.getContext("2d",{willReadFrequently:!0});if(!i)return;let a=0;const s=o*n;for(let u=0;u<s;u++){const h=t[u]??0;h>a&&(a=h)}const c=a<=1,p=i.createImageData(o,n),l=p.data;for(let u=0;u<s;u++){const h=t[u]??0;let f;c?f=(h>0?1:0)?0:255:f=h;const g=u*4;l[g]=f,l[g+1]=f,l[g+2]=f,l[g+3]=255}i.putImageData(p,0,0)}function fo(e){const{hostEl:t,statusEl:o,handlers:n}=e;let i=!1,a=null,s=null,c=null,p=null,l=null,u=null,h=null,f=null,g=null,d=null,m=null,v=null,b=null;function y(){for(;t.firstChild;)t.removeChild(t.firstChild)}async function I(r){var C,E,A,P,W;const x=(typeof(r==null?void 0:r.activePipelineId)=="string"?r.activePipelineId:"pipeline").replace(/[^a-z0-9_-]+/gi,"_").slice(0,40)||"pipeline",D=(C=r==null?void 0:r.outputSvg)==null?void 0:C.svg;if(typeof D=="string"&&D.length>0){const M=new Blob([D],{type:"image/svg+xml;charset=utf-8"});Vt(`beemage-${x}.svg`,M);return}const V=(E=r==null?void 0:r.outputImage)==null?void 0:E.data;if(V){const M=document.createElement("canvas");Ce(M,V),await st(`beemage-${x}.png`,M);return}const $=(A=r==null?void 0:r.outputMask)==null?void 0:A.data,z=(P=r==null?void 0:r.outputMask)==null?void 0:P.width,F=(W=r==null?void 0:r.outputMask)==null?void 0:W.height;if($&&typeof z=="number"&&typeof F=="number"){const M=document.createElement("canvas");Ke(M,$,z,F),await st(`beemage-${x}-mask.png`,M);return}throw new Error("No output to download.")}function S(){if(i)return;i=!0,y(),a=R("div",{class:"card"}),f=R("p",{class:"muted",style:"margin-top:0;"},"Universal pipeline runner. Select a pipeline and run it.");const r=R("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),w=R("label",{class:"fieldInline"});w.appendChild(R("span",{},"Pipeline")),s=R("select"),w.appendChild(s);const x=R("label",{class:"fieldInline"});x.appendChild(R("span",{},"Recipe")),c=R("select"),x.appendChild(c),p=R("button",{type:"button"},"Run all"),l=R("button",{type:"button"},"Next step"),u=R("button",{type:"button"},"Reset"),h=R("button",{type:"button"},"Download"),r.appendChild(w),r.appendChild(x),r.appendChild(p),r.appendChild(l),r.appendChild(u),r.appendChild(h);const D=R("div",{class:"grid4",style:"margin-top:12px;"}),V=R("div",{class:"card"});V.appendChild(R("div",{class:"cardTitle"},"Input (from source)")),g=R("canvas",{class:"canvas","aria-label":"Pipeline input preview"}),V.appendChild(g);const $=R("div",{class:"card"});$.appendChild(R("div",{class:"cardTitle"},"Current output")),d=R("canvas",{class:"canvas","aria-label":"Pipeline current output preview"}),m=R("img",{class:"canvas","aria-label":"Pipeline SVG output preview",style:"display:none;"}),$.appendChild(d),$.appendChild(m);const z=R("div",{class:"card",style:"grid-column:1 / -1;"});z.appendChild(R("div",{class:"cardTitle"},"Stages")),v=R("div"),z.appendChild(v),D.appendChild(V),D.appendChild($),D.appendChild(z),a.appendChild(f),a.appendChild(r),a.appendChild(D),t.appendChild(a),s.addEventListener("change",()=>{const F=s?s.value:"segmentation";n.onSelectPipeline(F)}),c.addEventListener("change",()=>{const F=c?c.value:"default";n.onSelectRecipe(F)}),p.addEventListener("click",()=>n.onRunAll()),l.addEventListener("click",()=>n.onNext()),u.addEventListener("click",()=>n.onReset()),h.addEventListener("click",async()=>{try{await I(b)}catch(F){const C=F instanceof Error?F.message:String(F);o.textContent=`Download failed: ${C}`}})}function k(r){if(!s||!c)return;const w=Array.isArray(r==null?void 0:r.pipelines)?r.pipelines:[],x=Array.isArray(r==null?void 0:r.recipes)?r.recipes:[],D=typeof(r==null?void 0:r.activePipelineId)=="string"?r.activePipelineId:"segmentation",V=typeof(r==null?void 0:r.activeRecipeId)=="string"?r.activeRecipeId:"default";s.innerHTML="";for(const $ of w){const z=R("option");z.value=$.id,z.textContent=$.title,$.id===D&&(z.selected=!0),s.appendChild(z)}c.innerHTML="";for(const $ of x){const z=R("option");z.value=$.id,z.textContent=$.title,$.id===V&&(z.selected=!0),c.appendChild(z)}}function O(r){var x;if(!g)return;const w=(x=r==null?void 0:r.input)==null?void 0:x.data;if(!w){g.width=1,g.height=1;const D=g.getContext("2d");D&&D.clearRect(0,0,g.width,g.height);return}Ce(g,w)}function N(r){var F,C,E,A,P;if(!d||!m)return;const w=(F=r==null?void 0:r.outputSvg)==null?void 0:F.svg;if(typeof w=="string"&&w.length>0){d.style.display="none",m.style.display="block",m.src=Bt(w);return}d.style.display="block",m.style.display="none",m.src="";const x=(C=r==null?void 0:r.outputImage)==null?void 0:C.data;if(x){Ce(d,x);return}const D=(E=r==null?void 0:r.outputMask)==null?void 0:E.data,V=(A=r==null?void 0:r.outputMask)==null?void 0:A.width,$=(P=r==null?void 0:r.outputMask)==null?void 0:P.height;if(D&&typeof V=="number"&&typeof $=="number"){Ke(d,D,V,$);return}d.width=1,d.height=1;const z=d.getContext("2d");z&&z.clearRect(0,0,d.width,d.height)}function j(r){if(!v)return;v.innerHTML="";const w=Array.isArray(r==null?void 0:r.stages)?r.stages:[];if(!w.length){v.appendChild(R("div",{class:"muted",style:"font-size:12px;"},"No stages."));return}const x=R("div",{style:"display:flex; flex-direction:column; gap:10px;"});for(const D of w)x.appendChild(B(D));v.appendChild(x)}function B(r){const w=R("div",{class:"card",style:"padding:10px;"}),x=R("div",{class:"row",style:"align-items:center; justify-content:space-between;"});x.appendChild(R("div",{style:"font-weight:bold;"},String(r.title??r.stageId))),x.appendChild(R("div",{class:"status"},String(r.state??"idle"))),w.appendChild(x),w.appendChild(R("div",{class:"muted",style:"font-size:12px;"},`${r.input} -> ${r.output}`)),typeof r.error=="string"&&r.error.length>0&&w.appendChild(R("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Stage error: ${r.error}`));const D=r.outputArtifact;D&&w.appendChild(at(D,260));const V=Array.isArray(r.ops)?r.ops:[];if(V.length){const $=R("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:8px;"});for(let z=0;z<V.length;z++){const F=V[z],C=z===V.length-1,E=R("div",{class:"card",style:"padding:8px;"}),A=R("div",{class:"row",style:"align-items:center; justify-content:space-between;"});A.appendChild(R("div",{style:"font-weight:bold; font-size:12px;"},String(F.title??F.opId))),A.appendChild(R("div",{class:"status"},String(F.state??"idle"))),E.appendChild(A),E.appendChild(R("div",{class:"muted",style:"font-size:12px;"},`${F.input} -> ${F.output}`)),typeof F.error=="string"&&F.error.length>0&&E.appendChild(R("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Op error: ${F.error}`));const P=D&&C?void 0:F.outputArtifact;P&&E.appendChild(at(P,200)),$.appendChild(E)}w.appendChild($)}return w}return{mount(){S()},render(r){var w,x,D;if(S(),b=r,k(r),o.textContent=typeof(r==null?void 0:r.statusText)=="string"?r.statusText:"Idle",f){const V=typeof(r==null?void 0:r.description)=="string"?r.description:"Universal pipeline runner.";f.textContent=V}if(h){const V=typeof((w=r==null?void 0:r.outputSvg)==null?void 0:w.svg)=="string"&&r.outputSvg.svg.length>0,$=!!((x=r==null?void 0:r.outputImage)!=null&&x.data),z=!!((D=r==null?void 0:r.outputMask)!=null&&D.data);h.disabled=!(V||$||z)}O(r),N(r),j(r)},dispose(){i=!1,a=null,s=null,c=null,p=null,l=null,u=null,h=null,f=null,g=null,d=null,m=null,v=null,b=null,y()}}}function ho(e,t){return`${e}.${t+1}`}function mo(e){return{width:e.width,height:e.height}}function rt(e,t){return e.find(o=>o.id===t)??null}function bo(){const e=[{kind:"dispatch",id:"op.seg.resize",title:"Resize",io:{input:"image",output:"image"},dispatchId:"segmentation.resize",tuningId:"segmentation.resize"},{kind:"dispatch",id:"op.seg.denoise",title:"Denoise",io:{input:"image",output:"image"},dispatchId:"segmentation.denoise",tuningId:"segmentation.denoise"},{kind:"dispatch",id:"op.seg.color",title:"Color / Gray",io:{input:"image",output:"image"},dispatchId:"segmentation.color",tuningId:"segmentation.color"},{kind:"dispatch",id:"op.seg.threshold",title:"Threshold",io:{input:"image",output:"mask"},dispatchId:"segmentation.threshold",tuningId:"segmentation.threshold"},{kind:"dispatch",id:"op.seg.morphology",title:"Morphology cleanup",io:{input:"mask",output:"mask"},dispatchId:"segmentation.morphology",tuningId:"segmentation.morphology"},{kind:"dispatch",id:"op.edge.resize",title:"Resize",io:{input:"image",output:"image"},dispatchId:"edge.resize",tuningId:"edge.resize"},{kind:"dispatch",id:"op.edge.threshold",title:"Threshold",io:{input:"image",output:"mask"},dispatchId:"edge.threshold",tuningId:"edge.threshold"},{kind:"dispatch",id:"op.edge.morphology",title:"Morphology cleanup",io:{input:"mask",output:"mask"},dispatchId:"edge.morphology",tuningId:"edge.morphology"},{kind:"dispatch",id:"op.edge.extract",title:"Edge extract",io:{input:"mask",output:"mask"},dispatchId:"edge.extract",tuningId:"edge.extract"},{kind:"dispatch",id:"op.svg.create",title:"Create SVG",io:{input:"mask",output:"svg"},dispatchId:"svg.create",tuningId:"svg.create"},{kind:"dispatch",id:"op.mage.clean.removeSmallComponents",title:"Remove small components",io:{input:"mask",output:"mask"},dispatchId:"mage.clean.removeSmallComponents",tuningId:"mage.clean.removeSmallComponents"},{kind:"js",id:"op.util.pass",title:"Pass-through",io:{input:"image",output:"image"},run:({input:a})=>a}],t=[{id:"segmentation",title:"Segmentation",implemented:!0,description:"Multi-step segmentation pipeline (image -> mask).",stages:[{id:"stage.seg.prep",title:"Prep",io:{input:"image",output:"image"},allowedOps:["op.seg.resize","op.util.pass"],defaultOps:["op.seg.resize"]},{id:"stage.seg.denoise",title:"Denoise",io:{input:"image",output:"image"},allowedOps:["op.seg.denoise","op.util.pass"],defaultOps:["op.seg.denoise"]},{id:"stage.seg.features",title:"Color / channel features",io:{input:"image",output:"image"},allowedOps:["op.seg.color","op.util.pass"],defaultOps:["op.seg.color"]},{id:"stage.seg.binarize",title:"Binarize",io:{input:"image",output:"mask"},allowedOps:["op.seg.threshold"],defaultOps:["op.seg.threshold"]},{id:"stage.seg.cleanup",title:"Mask cleanup",io:{input:"mask",output:"mask"},allowedOps:["op.seg.morphology"],defaultOps:["op.seg.morphology"]}]},{id:"svg",title:"SVG",implemented:!0,description:"Image to SVG outline (resize -> threshold -> morph -> edge -> svg).",stages:[{id:"stage.svg.prep",title:"Prep",io:{input:"image",output:"image"},allowedOps:["op.edge.resize","op.util.pass"],defaultOps:["op.edge.resize"]},{id:"stage.svg.binarize",title:"Binarize",io:{input:"image",output:"mask"},allowedOps:["op.edge.threshold"],defaultOps:["op.edge.threshold"]},{id:"stage.svg.cleanup",title:"Mask cleanup",io:{input:"mask",output:"mask"},allowedOps:["op.edge.morphology"],defaultOps:["op.edge.morphology"]},{id:"stage.svg.edge",title:"Extract edges",io:{input:"mask",output:"mask"},allowedOps:["op.edge.extract"],defaultOps:["op.edge.extract"]},{id:"stage.svg.emit",title:"Create SVG",io:{input:"mask",output:"svg"},allowedOps:["op.svg.create"],defaultOps:["op.svg.create"]}]},{id:"edge",title:"Edge",implemented:!0,description:"Edge extraction pipeline (image -> mask -> edges).",stages:[{id:"stage.edge.prep",title:"Prep",io:{input:"image",output:"image"},allowedOps:["op.edge.resize","op.util.pass"],defaultOps:["op.edge.resize"]},{id:"stage.edge.binarize",title:"Binarize",io:{input:"image",output:"mask"},allowedOps:["op.edge.threshold"],defaultOps:["op.edge.threshold"]},{id:"stage.edge.cleanup",title:"Mask cleanup",io:{input:"mask",output:"mask"},allowedOps:["op.edge.morphology"],defaultOps:["op.edge.morphology"]},{id:"stage.edge.extract",title:"Extract edges",io:{input:"mask",output:"mask"},allowedOps:["op.edge.extract"],defaultOps:["op.edge.extract"]}]},{id:"cleanup",title:"Cleanup (min area)",implemented:!0,description:"Image -> mask -> cleanup (morphology + remove small components).",stages:[{id:"stage.cleanup.prep",title:"Prep",io:{input:"image",output:"image"},allowedOps:["op.seg.resize","op.util.pass"],defaultOps:["op.seg.resize"]},{id:"stage.cleanup.binarize",title:"Binarize",io:{input:"image",output:"mask"},allowedOps:["op.seg.threshold"],defaultOps:["op.seg.threshold"]},{id:"stage.cleanup.morph",title:"Mask cleanup",io:{input:"mask",output:"mask"},allowedOps:["op.seg.morphology","op.mage.clean.removeSmallComponents"],defaultOps:["op.seg.morphology","op.mage.clean.removeSmallComponents"]}]},{id:"surface",title:"Surface",implemented:!1,description:"Future: region labeling + vectorize pipeline.",stages:[]}];function o(a){return rt(t,a)}function n(a){return rt(e,a)}function i(a){const s=o(a);return s?{pipelineId:s.id,stages:s.stages.map(c=>({stageId:c.id,ops:(c.defaultOps??[]).map((p,l)=>({instanceId:ho(c.id,l),opId:p}))}))}:null}return{pipelines:t,ops:e,getPipeline:o,getOp:n,makeDefaultInstalled:i}}const yo=At();function vo(){return{opencvReady:ne()}}async function wo(e){const t=await fe(),o=vo(),n=Tt(e,yo,t,o);return{engine:n.engine,params:n.params,fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}async function Eo(e,t,o){const{engine:n,params:i,fallbackReason:a,opencvReady:s}=await wo(e);return n==="opencv"&&!s?(Ie(`OpenCV selected for ${e} but not ready; falling back to native. ${a??""}`.trim()),await o[e].native(t,i)):await o[e][n](t,i)}function be(e,t,o,n){if(!t||!o)return e;const i=Math.floor(Number(n.morphAlgo??2)),a=Co(Math.floor(Number(n.morphIters??1)),1,20),s=Math.floor(Number(n.morphK??5)),c=Io(s),p=c-1>>1;if(i<=0||c<=1)return e;let l=e,u=new Uint8Array(t*o);for(let h=0;h<a;h++){if(i===1){ct(l,u,t,o,p);const f=l;l=u,u=f;continue}if(i===2){lt(l,u,t,o,p);const f=l;l=u,u=f;continue}lt(l,u,t,o,p),l===e&&h===0&&(l=new Uint8Array(e)),ct(u,l,t,o,p)}return l}function Io(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:5}function lt(e,t,o,n,i){t.fill(0);for(let a=0;a<n;a++){const s=Math.max(0,a-i),c=Math.min(n-1,a+i);for(let p=0;p<o;p++){const l=Math.max(0,p-i),u=Math.min(o-1,p+i);let h=0;for(let f=s;f<=c&&!h;f++){let g=f*o+l;for(let d=l;d<=u;d++,g++)if(e[g]){h=1;break}}t[a*o+p]=h}}}function ct(e,t,o,n,i){t.fill(0);for(let a=0;a<n;a++){const s=Math.max(0,a-i),c=Math.min(n-1,a+i);for(let p=0;p<o;p++){const l=Math.max(0,p-i),u=Math.min(o-1,p+i);let h=1;for(let f=s;f<=c&&h;f++){let g=f*o+l;for(let d=l;d<=u;d++,g++)if(!e[g]){h=0;break}}t[a*o+p]=h}}}function Co(e,t,o){return e<t?t:e>o?o:e}function zt(e,t,o,n){const i=Math.max(0,Math.floor(Number(n??0)));if(!t||!o||i<=1)return e;const a=new Uint8Array(e),s=new Uint8Array(e.length),c=new Int32Array(e.length),p=new Int32Array(e.length);for(let l=0;l<o;l++)for(let u=0;u<t;u++){const h=l*t+u;if(e[h]===0||s[h]===1)continue;let f=0,g=0;s[h]=1,c[g]=u,p[g]=l,g++;const d=[h];for(;f<g;){const m=c[f],v=p[f];f++;const b=m-1,y=v,I=m+1,S=v,k=m,O=v-1,N=m,j=v+1;if(b>=0){const B=y*t+b;e[B]!==0&&s[B]===0&&(s[B]=1,c[g]=b,p[g]=y,g++,d.push(B))}if(I<t){const B=S*t+I;e[B]!==0&&s[B]===0&&(s[B]=1,c[g]=I,p[g]=S,g++,d.push(B))}if(O>=0){const B=O*t+k;e[B]!==0&&s[B]===0&&(s[B]=1,c[g]=k,p[g]=O,g++,d.push(B))}if(j<o){const B=j*t+N;e[B]!==0&&s[B]===0&&(s[B]=1,c[g]=N,p[g]=j,g++,d.push(B))}}if(d.length<i)for(let m=0;m<d.length;m++)a[d[m]]=0}return a}function ko(){const e=globalThis;return e!=null&&e.cv&&typeof e.cv.Mat=="function"?e.cv:null}function So(e,t){const{width:o,height:n}=e,i=Math.max(0,Math.floor(Number(t.cleanMinArea??0)));if(Mt("OpenCV removeSmallComponents params",{width:o,height:n,minArea:i}),!o||!n||i<=1)return e.mask;const a=ko();if(!a)return zt(e.mask,o,n,i);const s=new a.Mat(n,o,a.CV_8UC1);try{const c=s.data,p=e.mask;for(let f=0;f<p.length;f++)c[f]=p[f]?255:0;const l=new a.Mat,u=new a.Mat,h=new a.Mat;try{const f=a.connectedComponentsWithStats(s,l,u,h,8,a.CV_32S),g=a.CC_STAT_AREA??4,d=new Array(f).fill(!1);for(let b=1;b<f;b++)u.intAt(b,g)<i&&(d[b]=!0);const m=new Uint8Array(o*n),v=l.data32S;for(let b=0;b<m.length;b++){const y=v[b];m[b]=y>0&&!d[y]?1:0}return m}finally{l.delete(),u.delete(),h.delete()}}finally{s.delete()}}function ye(e,t,o,n){const i=Math.max(0,Math.min(255,Math.floor(Number(n.manualT??128)))),a=new Uint8Array(t*o),s=e.data;for(let c=0,p=0;c<a.length;c++,p+=4){const l=s[p],u=s[p+1],h=s[p+2],f=l*77+u*150+h*29>>8;a[c]=f>=i?1:0}return a}function ve(e,t,o,n){const i=Math.max(1,Math.floor(Number(n.targetMaxW??t)));if(!t||!o||t<=i)return e;const a=i/t,s=Math.max(1,Math.floor(t*a)),c=Math.max(1,Math.floor(o*a));return Math.floor(Number(n.resizeAlgo??1))===0?xo(e,t,o,s,c):Mo(e,t,o,s,c)}function xo(e,t,o,n,i){const a=e.data,s=new Uint8ClampedArray(n*i*4),c=t/n,p=o/i;for(let l=0;l<i;l++){const u=Math.min(o-1,Math.max(0,Math.floor((l+.5)*p-.5)));for(let h=0;h<n;h++){const f=Math.min(t-1,Math.max(0,Math.floor((h+.5)*c-.5))),g=(u*t+f)*4,d=(l*n+h)*4;s[d]=a[g],s[d+1]=a[g+1],s[d+2]=a[g+2],s[d+3]=a[g+3]}}return new ImageData(s,n,i)}function Mo(e,t,o,n,i){const a=e.data,s=new Uint8ClampedArray(n*i*4),c=t/n,p=o/i;for(let l=0;l<i;l++){const u=(l+.5)*p-.5,h=we(Math.floor(u),0,o-1),f=we(h+1,0,o-1),g=u-h;for(let d=0;d<n;d++){const m=(d+.5)*c-.5,v=we(Math.floor(m),0,t-1),b=we(v+1,0,t-1),y=m-v,I=(h*t+v)*4,S=(h*t+b)*4,k=(f*t+v)*4,O=(f*t+b)*4,N=(l*n+d)*4;for(let j=0;j<4;j++){const B=a[I+j],r=a[S+j],w=a[k+j],x=a[O+j],D=B+(r-B)*y,V=w+(x-w)*y,$=D+(V-D)*g;s[N+j]=Do($)}}}return new ImageData(s,n,i)}function we(e,t,o){return e<t?t:e>o?o:e}function Do(e){return e<=0?0:e>=255?255:e|0}function ut(e,t,o,n){if(!t||!o)return e;const i=Math.floor(Number(n.denoiseAlgo??1));if(i<=0)return e;const a=Math.floor(Number(n.blurK??3)),s=Ao(a);return i===2&&s<=3?Ro(e,t,o):s<=1?e:To(e,t,o,s)}function Ao(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:3}function To(e,t,o,n){const i=n-1>>1,a=e.data,s=new Uint8ClampedArray(t*o*4);for(let p=0;p<o;p++){let l=0,u=0,h=0,f=0;for(let g=-i;g<=i;g++){const d=oe(g,0,t-1),m=(p*t+d)*4;l+=a[m],u+=a[m+1],h+=a[m+2],f+=a[m+3]}for(let g=0;g<t;g++){const d=(p*t+g)*4;s[d]=l/n|0,s[d+1]=u/n|0,s[d+2]=h/n|0,s[d+3]=f/n|0;const m=oe(g-i,0,t-1),v=oe(g+i+1,0,t-1),b=(p*t+m)*4,y=(p*t+v)*4;l+=a[y]-a[b],u+=a[y+1]-a[b+1],h+=a[y+2]-a[b+2],f+=a[y+3]-a[b+3]}}const c=new Uint8ClampedArray(t*o*4);for(let p=0;p<t;p++){let l=0,u=0,h=0,f=0;for(let g=-i;g<=i;g++){const m=(oe(g,0,o-1)*t+p)*4;l+=s[m],u+=s[m+1],h+=s[m+2],f+=s[m+3]}for(let g=0;g<o;g++){const d=(g*t+p)*4;c[d]=l/n|0,c[d+1]=u/n|0,c[d+2]=h/n|0,c[d+3]=f/n|0;const m=oe(g-i,0,o-1),v=oe(g+i+1,0,o-1),b=(m*t+p)*4,y=(v*t+p)*4;l+=s[y]-s[b],u+=s[y+1]-s[b+1],h+=s[y+2]-s[b+2],f+=s[y+3]-s[b+3]}}return new ImageData(c,t,o)}function Ro(e,t,o){const n=e.data,i=new Uint8ClampedArray(t*o*4),a=new Array(9),s=new Array(9),c=new Array(9),p=new Array(9);for(let l=0;l<o;l++)for(let u=0;u<t;u++){let h=0;for(let g=-1;g<=1;g++){const d=oe(l+g,0,o-1);for(let m=-1;m<=1;m++){const v=oe(u+m,0,t-1),b=(d*t+v)*4;a[h]=n[b],s[h]=n[b+1],c[h]=n[b+2],p[h]=n[b+3],h++}}a.sort(Ee),s.sort(Ee),c.sort(Ee),p.sort(Ee);const f=(l*t+u)*4;i[f]=a[4]|0,i[f+1]=s[4]|0,i[f+2]=c[4]|0,i[f+3]=p[4]|0}return new ImageData(i,t,o)}function Ee(e,t){return e-t}function oe(e,t,o){return e<t?t:e>o?o:e}function dt(e,t,o,n){if(!t||!o)return e;const i=Math.floor(Number(n.colorMode??1));if(i===0)return e;const a=e.data,s=new Uint8ClampedArray(t*o*4),c=Oo(Math.floor(Number(n.hsvChannel??2)),0,2);for(let p=0,l=0;p<t*o;p++,l+=4){const u=a[l],h=a[l+1],f=a[l+2],g=a[l+3];let d=0;if(i===1)d=u*77+h*150+f*29>>8;else if(i===2){const m=Po(u,h,f),v=c===0?m.h:c===1?m.s:m.v;d=Lo(v*255)}else d=255-(u*77+h*150+f*29>>8);s[l]=d,s[l+1]=d,s[l+2]=d,s[l+3]=g}return new ImageData(s,t,o)}function Po(e,t,o){const n=e/255,i=t/255,a=o/255,s=Math.max(n,i,a),c=Math.min(n,i,a),p=s-c;let l=0;p!==0&&(s===n?l=(i-a)/p%6:s===i?l=(a-n)/p+2:l=(n-i)/p+4,l/=6,l<0&&(l+=1));const u=s===0?0:p/s;return{h:l,s:u,v:s}}function Oo(e,t,o){return e<t?t:e>o?o:e}function Lo(e){return e<=0?0:e>=255?255:e|0}function gt(e,t,o){const n=new Uint8Array(e.length),i=(a,s)=>s*t+a;for(let a=0;a<o;a++)for(let s=0;s<t;s++){const c=i(s,a);if(e[c]===0)continue;if(s===0||a===0||s===t-1||a===o-1){n[c]=255;continue}const l=e[i(s-1,a)],u=e[i(s+1,a)],h=e[i(s,a-1)],f=e[i(s,a+1)];(l===0||u===0||h===0||f===0)&&(n[c]=255)}return n}function pt(e,t,o,n){const i=Math.max(1,Math.floor(n.scale||1)),a=t*i,s=o*i,c=i;let p="";for(let f=0;f<o;f++){const g=f*t;for(let d=0;d<t;d++){if(e[g+d]===0)continue;const v=d*c,b=f*c;p+=`M${v} ${b}h${c}v${c}h-${c}Z`}}const l=n.transparentBg?"":`<rect x="0" y="0" width="${a}" height="${s}" fill="white"/>`,u=n.color||"#000",h=p.length>0?`<path d="${p}" fill="${u}" stroke="none"/>`:"";return`<svg xmlns="http://www.w3.org/2000/svg" width="${a}" height="${s}" viewBox="0 0 ${a} ${s}">`+l+h+"</svg>"}const $o="demo",Bo={"mage.clean.removeSmallComponents":{native:(e,t)=>zt(e.mask,e.width,e.height,t.cleanMinArea),opencv:(e,t)=>(L("OpenCV removeSmallComponents called (demo).",{width:e.width,height:e.height,cleanMinArea:t.cleanMinArea}),So(e,t))},"segmentation.resize":{native:(e,t)=>(L("[demo op] segmentation.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),ve(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(L("[demo op] segmentation.resize opencv",{width:e.width,height:e.height}),ve(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"segmentation.denoise":{native:(e,t)=>(L("[demo op] segmentation.denoise native",{width:e.width,height:e.height,denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}),ut(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma})),opencv:(e,t)=>(L("[demo op] segmentation.denoise opencv",{width:e.width,height:e.height}),ut(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}))},"segmentation.color":{native:(e,t)=>(L("[demo op] segmentation.color native",{width:e.width,height:e.height,colorMode:t.colorMode,hsvChannel:t.hsvChannel}),dt(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel})),opencv:(e,t)=>(L("[demo op] segmentation.color opencv",{width:e.width,height:e.height}),dt(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel}))},"segmentation.threshold":{native:(e,t)=>(L("[demo op] segmentation.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),ye(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(L("[demo op] segmentation.threshold opencv",{width:e.width,height:e.height}),ye(e.image,e.width,e.height,{manualT:t.manualT}))},"segmentation.morphology":{native:(e,t)=>(L("[demo op] segmentation.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),be(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(L("[demo op] segmentation.morphology opencv",{width:e.width,height:e.height}),be(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.resize":{native:(e,t)=>(L("[demo op] edge.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),ve(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(L("[demo op] edge.resize opencv",{width:e.width,height:e.height}),ve(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"edge.threshold":{native:(e,t)=>(L("[demo op] edge.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),ye(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(L("[demo op] edge.threshold opencv",{width:e.width,height:e.height}),ye(e.image,e.width,e.height,{manualT:t.manualT}))},"edge.morphology":{native:(e,t)=>(L("[demo op] edge.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),be(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(L("[demo op] edge.morphology opencv",{width:e.width,height:e.height}),be(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.extract":{native:(e,t)=>(L("[demo op] edge.extract native",{width:e.width,height:e.height}),gt(e.mask,e.width,e.height)),opencv:(e,t)=>(L("[demo op] edge.extract opencv",{width:e.width,height:e.height}),gt(e.mask,e.width,e.height))},"svg.create":{native:(e,t)=>(L("[demo op] svg.create native",{width:e.width,height:e.height,scale:t.scale}),pt(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color})),opencv:(e,t)=>(L("[demo op] svg.create opencv",{width:e.width,height:e.height,scale:t.scale}),pt(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color}))}};async function re(e,t){return Mt("[opsDispatch] runOp",{op:e,implSource:$o,inputKeys:t&&typeof t=="object"?Object.keys(t):typeof t}),Eo(e,t,Bo)}function Vo(e){return e.type==="image"}function zo(e){return e.type==="mask"}function se(e){return{type:"image",width:e.width,height:e.height,image:e}}function ft(e,t,o){return{type:"mask",width:t,height:o,mask:e}}function ht(e,t,o){return{type:"svg",width:t,height:o,svg:e}}function ue(e,t){return`IO mismatch: expected ${e}, got ${t}`}function Uo(e,t){if(t.length===0)return"Stage has no installed ops";if(t[0].io.input!==e.input)return ue(e.input,t[0].io.input);for(let n=0;n<t.length-1;n++){const i=t[n],a=t[n+1];if(i.io.output!==a.io.input)return`Chain IO mismatch between "${i.title}" (${i.io.output}) -> "${a.title}" (${a.io.input})`}const o=t[t.length-1];return o.io.output!==e.output?ue(e.output,o.io.output):null}async function No(e,t,o){if(e.io.input==="image"){if(!Vo(t))throw new Error(ue("image",t.type));const{width:a,height:s}=t;if(e.io.output==="image"){const c=await re(e.dispatchId,{image:t.image,width:a,height:s});return se(c)}if(e.io.output==="mask"){const c=await re(e.dispatchId,{image:t.image,width:a,height:s});return ft(c,a,s)}if(e.io.output==="svg"){const c=await re(e.dispatchId,{image:t.image,width:a,height:s});return ht(c,a,s)}throw new Error(`Unsupported dispatch output: ${e.io.output}`)}if(!zo(t))throw new Error(ue("mask",t.type));const{width:n,height:i}=t;if(e.io.output==="mask"){const a=await re(e.dispatchId,{mask:t.mask,width:n,height:i});return ft(a,n,i)}if(e.io.output==="svg"){const a=await re(e.dispatchId,{mask:t.mask,width:n,height:i});return ht(a,n,i)}throw new Error(`Invalid op spec: mask input cannot produce ${e.io.output} (not supported here)`)}async function jo(e,t,o){if(e.kind==="dispatch")return await No(e,t);const n=e.tuningId?await o.getEffectiveParams(e.tuningId).catch(()=>({})):{};return await e.run({input:t,params:n})}async function Fo(e){var l;const{catalogue:t,installed:o,inputImage:n,deps:i}=e,a=t.getPipeline(o.pipelineId);if(!a)return{pipelineId:o.pipelineId,title:o.pipelineId,status:"error",error:`Unknown pipelineId: ${o.pipelineId}`,input:se(n),stages:[]};if(!a.implemented)return{pipelineId:a.id,title:a.title,status:"error",error:"Not implemented yet",input:se(n),stages:[]};const s=new Map;for(const u of o.stages)s.set(u.stageId,u);const c=[];let p=se(n);for(const u of a.stages){const h=s.get(u.id),f=(l=h==null?void 0:h.ops)!=null&&l.length?h.ops:(u.defaultOps??[]).map((S,k)=>({instanceId:`${u.id}.${k+1}`,opId:S})),g=[],d=[];let m=null;for(const S of f){const k=t.getOp(S.opId);if(!k){m=`Unknown opId: ${S.opId}`;break}if(!u.allowedOps.includes(k.id)){m=`Op not allowed in this stage: ${k.title} (${k.id})`;break}g.push(k)}if(!m){const S=Uo(u.io,g);S&&(m=S)}if(m){const S={stageId:u.id,title:u.title,io:u.io,status:"error",error:m,ops:f.map(k=>({instanceId:k.instanceId,opId:k.opId,title:k.opId,io:{input:u.io.input,output:u.io.output},status:"error",error:m}))};return c.push(S),i.debug("pipeline stage failed (validation)",{pipelineId:a.id,stageId:u.id,error:m}),{pipelineId:a.id,title:a.title,status:"error",error:`Stage "${u.title}" failed: ${m}`,input:se(n),stages:c}}let v=p,b=!0,y;for(let S=0;S<g.length;S++){const k=f[S],O=g[S];try{if(O.io.input!==v.type)throw new Error(ue(O.io.input,v.type));const N=await jo(O,v,i);if(N.type!==O.io.output)throw new Error(ue(O.io.output,N.type));d.push({instanceId:k.instanceId,opId:O.id,title:O.title,io:O.io,status:"ok",output:N}),v=N}catch(N){b=!1,y=N instanceof Error?N.message:String(N),d.push({instanceId:k.instanceId,opId:O.id,title:O.title,io:O.io,status:"error",error:y}),i.debug("pipeline op failed",{pipelineId:a.id,stageId:u.id,opId:O.id,error:y,...mo(v)});break}}const I={stageId:u.id,title:u.title,io:u.io,status:b?"ok":"error",error:b?void 0:y,ops:d,output:b?v:void 0};if(c.push(I),!b)return{pipelineId:a.id,title:a.title,status:"error",error:`Stage "${u.title}" failed: ${y??"unknown error"}`,input:se(n),stages:c};p=v}return{pipelineId:a.id,title:a.title,status:"ok",input:se(n),output:p,stages:c}}function _o(e){var F;const t=bo();let o=((F=t.pipelines[0])==null?void 0:F.id)??"segmentation",n="default",i=null,a=null,s="Idle",c=[],p=0,l=null,u={},h={},f=null,g={},d={},m={},v={};function b(){return t.getPipeline(o)??t.pipelines[0]}function y(C){const E={id:"default",title:"Default",buildInstalled:()=>{const A=t.makeDefaultInstalled(C.id);if(!A)throw new Error(`Cannot build default installed for pipeline: ${C.id}`);return A}};if(C.id==="segmentation"){const A=C.stages.map(M=>M.id);return[E,{id:"fast",title:"Fast (minimal)",buildInstalled:()=>({pipelineId:C.id,stages:A.map(M=>M.endsWith("prep")?{stageId:M,ops:[{instanceId:`${M}.1`,opId:"op.seg.resize"}]}:M.endsWith("binarize")?{stageId:M,ops:[{instanceId:`${M}.1`,opId:"op.seg.threshold"}]}:M.endsWith("cleanup")?{stageId:M,ops:[{instanceId:`${M}.1`,opId:"op.seg.morphology"}]}:{stageId:M,ops:[{instanceId:`${M}.1`,opId:"op.util.pass"}]})})},{id:"strong",title:"Strong cleanup (double morphology)",buildInstalled:()=>({pipelineId:C.id,stages:A.map(M=>{var H;if(M.endsWith("cleanup"))return{stageId:M,ops:[{instanceId:`${M}.1`,opId:"op.seg.morphology"},{instanceId:`${M}.2`,opId:"op.seg.morphology"}]};const _=((H=C.stages.find(T=>T.id===M))==null?void 0:H.defaultOps)??[];return{stageId:M,ops:_.map((T,Z)=>({instanceId:`${M}.${Z+1}`,opId:T}))}})})}]}return[E]}function I(){const C=b(),E=y(C),A=E.find(P=>P.id===n)??E[0];n=A.id,i=A.buildInstalled(C)}function S(){u={},h={},m={},v={},c=[],p=0,l=null,f=null,g={},d={},s=b().implemented?"Ready":"Not implemented yet"}function k(){I(),S()}function O(C){C!==o&&t.getPipeline(C)&&(o=C,n="default",k())}function N(C){C!==n&&(n=C,k())}function j(C){a=C,S()}function B(){return i||I(),i}function r(C,E){const A=b(),P=A.stages.find(_=>_.id===C);if(!P)return;const W=E.filter(_=>P.allowedOps.includes(_)),M=B().stages.map(_=>_.stageId!==C?_:{stageId:C,ops:W.map((H,T)=>({instanceId:`${C}.${T+1}`,opId:H}))});i={pipelineId:A.id,stages:M},S()}function w(){const C=b(),E=B(),A=new Map(C.stages.map(M=>[M.id,M])),P=new Map(t.ops.map(M=>[M.id,M])),W=[];for(const M of E.stages){const _=A.get(M.stageId);if(_)for(const H of M.ops){const T=P.get(H.opId);T&&(T.kind==="dispatch"?W.push({stageId:M.stageId,stageTitle:_.title,stageInput:_.io.input,stageOutput:_.io.output,instanceId:H.instanceId,opId:T.id,opTitle:T.title,opInput:T.io.input,opOutput:T.io.output,kind:"dispatch",dispatchId:T.dispatchId,tuningId:T.tuningId}):W.push({stageId:M.stageId,stageTitle:_.title,stageInput:_.io.input,stageOutput:_.io.output,instanceId:H.instanceId,opId:T.id,opTitle:T.title,opInput:T.io.input,opOutput:T.io.output,kind:"js",tuningId:T.tuningId,runJs:T.run}))}}c=W}function x(C){if(C.output)return C.output;for(let E=C.stages.length-1;E>=0;E--){const A=C.stages[E];if(A.output)return A.output;for(let P=A.ops.length-1;P>=0;P--){const W=A.ops[P];if(W.output)return W.output}}return null}function D(C){u={},h={},m={},v={},g={},d={};for(const E of C.stages){h[E.stageId]=E.status==="ok"?"ok":"error",E.error&&(v[E.stageId]=E.error),E.output&&(d[E.stageId]=E.output);for(const A of E.ops)u[A.instanceId]=A.status==="ok"?"ok":"error",A.error&&(m[A.instanceId]=A.error),A.output&&(g[A.instanceId]=A.output)}if(f=x(C),C.status==="ok"&&!f){e.runner.debug("pipeline ok but no output artifact",{pipelineId:C.pipelineId,stages:C.stages.length}),s="Done (but no output artifact)";return}s=C.status==="ok"?"Done":C.error??"Error"}async function V(){if(!b().implemented){s="Not implemented yet";return}if(!a){s="No input image";return}s="Running all…",u={},h={},g={},d={},p=0;const E=await Fo({catalogue:t,installed:B(),inputImage:a,deps:e.runner});D(E),w(),p=c.length}async function $(){const C=b();if(!C.implemented){s="Not implemented yet";return}if(!a){s="No input image";return}if(c.length===0&&w(),c.length===0){s="No ops installed";return}if(l||(l={type:"image",width:a.width,height:a.height,image:a},f=null,u={},h={},g={},d={},p=0),p>=c.length){s="Done";return}const E=c[p];try{if(s=`Running: ${E.stageTitle} → ${E.opTitle}`,l.type!==E.opInput)throw new Error(`IO mismatch: expected ${E.opInput}, got ${l.type}`);const A=E.tuningId?await e.runner.getEffectiveParams(E.tuningId).catch(()=>({})):{};let P;if(E.kind==="dispatch"){const W=l.width,M=l.height;if(l.type==="image"){const _=l.image,H=await re(E.dispatchId,{image:_,width:W,height:M,params:A});if(E.opOutput==="image"){const T=H;P={type:"image",width:T.width,height:T.height,image:T}}else if(E.opOutput==="mask")P={type:"mask",width:W,height:M,mask:H};else if(E.opOutput==="svg")P={type:"svg",width:W,height:M,svg:H};else throw new Error(`Unsupported op output kind: ${E.opOutput}`)}else if(l.type==="mask"){const _=await re(E.dispatchId,{mask:l.mask,width:W,height:M,params:A});if(E.opOutput==="mask")P={type:"mask",width:W,height:M,mask:_};else if(E.opOutput==="svg")P={type:"svg",width:W,height:M,svg:_};else throw new Error(`IO mismatch: mask input cannot produce ${E.opOutput} (yet)`)}else throw new Error(`Dispatch op cannot run on svg input (opInput=${E.opInput})`)}else{if(!E.runJs)throw new Error("Missing js op implementation");P=await E.runJs({input:l,params:A})}if(P.type!==E.opOutput)throw new Error(`IO mismatch: expected ${E.opOutput}, got ${P.type}`);u[E.instanceId]="ok",h[E.stageId]="ok",g[E.instanceId]=P,d[E.stageId]=P,l=P,f=P,p+=1,s=p>=c.length?"Done":"Ready"}catch(A){const P=A instanceof Error?A.message:String(A);u[E.instanceId]="error",h[E.stageId]="error",v[E.stageId]=P,m[E.instanceId]=P,s=`Error: ${E.opTitle} — ${P}`,e.runner.debug("pipeline next-step failed",{pipelineId:C.id,recipeId:n,stageId:E.stageId,instanceId:E.instanceId,opId:E.opId,error:P})}}function z(){const C=b(),E=y(C),A=t.pipelines.map(T=>({id:T.id,title:T.title})),P=B(),W=new Map(C.stages.map(T=>[T.id,T])),M=new Map(t.ops.map(T=>[T.id,T])),_=P.stages.map(T=>{const Z=W.get(T.stageId);if(!Z)return null;const he=T.ops.map(Q=>{const ae=M.get(Q.opId);return ae?{instanceId:Q.instanceId,opId:ae.id,title:ae.title,input:ae.io.input,output:ae.io.output,state:u[Q.instanceId]??"idle",error:m[Q.instanceId],outputArtifact:g[Q.instanceId]}:null}).filter(Boolean),Te=h[T.stageId]??(he.some(Q=>Q.state==="error")?"error":"idle");return{stageId:T.stageId,title:Z.title,input:Z.io.input,output:Z.io.output,ops:he,state:Te,error:v[T.stageId],outputArtifact:d[T.stageId]}}).filter(Boolean),H={pipelines:A,recipes:E.map(T=>({id:T.id,title:T.title})),activePipelineId:o,activeRecipeId:n,statusText:s,stages:_,input:a?{width:a.width,height:a.height,data:a}:void 0,nextIndex:p,totalOps:c.length||_.reduce((T,Z)=>T+Z.ops.length,0)};return(f==null?void 0:f.type)==="image"?H.outputImage={width:f.width,height:f.height,data:f.image}:(f==null?void 0:f.type)==="mask"?H.outputMask={width:f.width,height:f.height,data:f.mask}:(f==null?void 0:f.type)==="svg"&&(H.outputSvg={width:f.width,height:f.height,svg:f.svg}),H}return k(),{getVm:z,setActivePipeline:O,setActiveRecipe:N,setInputImageData:j,getInstalled:B,setStageOps:r,runAll:V,runNext:$,reset:k}}function Go(e,t,o){const n=_o({runner:{getEffectiveParams:async r=>await o.getEffectiveParams(r).catch(()=>({})),debug:(r,w)=>ie({scope:"panel",kind:"debug",message:r,meta:w})}});let i=null,a=!1,s=null,c=null;function p(){const r=n.getVm();if(!(r.stages.some(D=>D.state==="error")||String(r.statusText).toLowerCase().includes("error"))){c=null;return}const x=String(r.statusText||"Pipeline error");x!==c&&(c=x,K({scope:"panel",kind:"error",message:`Pipeline: ${x}`}))}function l(){e.pipelineTuningMountEl.innerHTML=""}function u(r){return[r,`pipeline.${r}`,"pipeline"]}function h(r){const w=u(r);if(s===w[0])return;l();let x=null,D=null;for(const V of w)try{o.mount({mountEl:e.pipelineTuningMountEl,scopeRootId:V}),x=V;break}catch($){D=$,l()}if(!x){s=null,K({scope:"panel",kind:"info",message:`Pipeline tuning mount failed for "${r}" (no matching scope).`}),ie({scope:"panel",kind:"error",message:"Pipeline tuning mount failed (no candidate scopeRootId worked)",meta:{pipelineId:r,candidates:w,error:D instanceof Error?D.message:String(D)}});return}s=x,K({scope:"panel",kind:"info",message:`Pipeline tuning mount: pipelineId=${r}, scopeRootId=${x}`})}function f(){const r=n.getVm(),w=typeof r.activePipelineId=="string"?r.activePipelineId:"segmentation";h(w)}function g(){const r=e.srcCanvasEl,w=r.width,x=r.height;if(!w||!x)return null;const D=r.getContext("2d",{willReadFrequently:!0});return D?D.getImageData(0,0,w,x):null}function d(){if(n.getVm().input)return;const w=g();w&&n.setInputImageData(w)}function m(){const r=g();r&&n.setInputImageData(r)}async function v(){const r=await o.getEffectiveParams("pipeline").catch(()=>({})),w=r==null?void 0:r.mode,x=r==null?void 0:r.recipe,D=typeof w=="string"?w:"segmentation",V=typeof x=="string"?x:"default";n.setActivePipeline(D),n.setActiveRecipe(V),f()}function b(){return i||(K({scope:"panel",kind:"info",message:"Pipeline view: create + mount"}),i=fo({hostEl:e.pipelineViewMountEl,statusEl:e.pipelineStatusEl,handlers:{onSelectPipeline:r=>{K({scope:"panel",kind:"info",message:`Pipeline select: ${r}`}),n.setActivePipeline(r),o.setParamValue("pipeline","mode",r),f(),y()},onSelectRecipe:r=>{K({scope:"panel",kind:"info",message:`Recipe select: ${r}`}),n.setActiveRecipe(r),o.setParamValue("pipeline","recipe",r),y()},onRunAll:()=>void I(),onNext:()=>void S(),onReset:()=>{n.reset();const r=g();r&&n.setInputImageData(r),Oe(n.getVm()),K({scope:"panel",kind:"info",message:"Pipeline reset (reseed from source)"}),f(),y()}}}),i.mount(),f(),i)}function y(){b().render(n.getVm())}async function I(){K({scope:"panel",kind:"info",message:"Pipeline run: all"}),m();try{await n.runAll()}finally{Oe(n.getVm()),y(),p()}}async function S(){K({scope:"panel",kind:"info",message:"Pipeline run: next"}),d();try{await n.runNext()}finally{Oe(n.getVm()),y(),p()}}function k(){}async function O(){a=!0,K({scope:"panel",kind:"info",message:"Pipeline tab: mount()"}),m(),await v(),K({scope:"panel",kind:"info",message:"Pipeline tab: render()"}),y()}async function N(){a&&(K({scope:"panel",kind:"info",message:"Pipeline tab: refresh()"}),m(),await v(),y())}function j(){a=!1,K({scope:"panel",kind:"info",message:"Pipeline tab: unmount()"})}function B(){K({scope:"panel",kind:"info",message:"Pipeline tab: dispose()"}),i==null||i.dispose(),i=null,s=null,l()}return{bind:k,mount:O,unmount:j,refresh:N,dispose:B}}async function Ko(){const e=Xt();await je().catch(()=>null);const t=tn();t.start();const o=rn();globalThis.__APP__={...globalThis.__APP__,cache:o};const n=co({getRuntimeAvailability:()=>({opencvReady:!1}),debugTraceAppend:u=>ie({scope:"panel",kind:"debug",message:u}),actionLogAppend:u=>K({scope:"panel",kind:"info",message:u})});n.mount({mountEl:e.tuningMountEl,scopeRootId:"app"});const i=wn(e),a=Tn(e),s=Go(e,t,n),c=no(e,t),p=so(e);i.bind(),s.bind(),a.bind(),c.bind(),p.bind();const l=sn(e,{image:i,pipeline:s,colors:a,settings:c,logs:p});l.bind(),l.boot()}Ko();
