function Un(){function e(it,Vn){if(!it)throw new Error(`[dom] Missing #${Vn}`);return it}const t=e(document.getElementById("appRoot"),"appRoot"),o=e(document.getElementById("tabContour"),"tabContour"),n=e(document.getElementById("tabColors"),"tabColors"),i=e(document.getElementById("tabSettings"),"tabSettings"),a=e(document.getElementById("tabLogs"),"tabLogs"),s=e(document.getElementById("tabSegmentation"),"tabSegmentation"),u=e(document.getElementById("tabPipeline"),"tabPipeline"),g=e(document.getElementById("viewContour"),"viewContour"),r=e(document.getElementById("viewColors"),"viewColors"),c=e(document.getElementById("viewSettings"),"viewSettings"),p=e(document.getElementById("viewLogs"),"viewLogs"),v=e(document.getElementById("viewSegmentation"),"viewSegmentation"),d=e(document.getElementById("viewPipeline"),"viewPipeline"),l=e(document.getElementById("dropZone"),"dropZone"),f=e(document.getElementById("fileInput"),"fileInput"),y=e(document.getElementById("btnProcess"),"btnProcess"),h=e(document.getElementById("btnClean"),"btnClean"),b=e(document.getElementById("btnDownload"),"btnDownload"),C=e(document.getElementById("contourStatus"),"contourStatus"),w=e(document.getElementById("contourSpinner"),"contourSpinner"),E=e(document.getElementById("srcCanvas"),"srcCanvas"),I=e(document.getElementById("outCanvas"),"outCanvas"),R=e(document.getElementById("clean1Canvas"),"clean1Canvas"),k=e(document.getElementById("clean2Canvas"),"clean2Canvas"),M=e(document.getElementById("cleanQualityBadge"),"cleanQualityBadge"),m=e(document.getElementById("cleanQualityFill"),"cleanQualityFill"),x=e(document.getElementById("cleanQualityText"),"cleanQualityText"),T=e(document.getElementById("btnVectorize"),"btnVectorize"),P=e(document.getElementById("btnDownloadSvg"),"btnDownloadSvg"),$=e(document.getElementById("svgPreviewImg"),"svgPreviewImg"),O=e(document.getElementById("svgPreviewText"),"svgPreviewText"),N=e(document.getElementById("contourTuningMount"),"contourTuningMount"),U=e(document.getElementById("pipelineStatus"),"pipelineStatus"),D=e(document.getElementById("pipelineTuningMount"),"pipelineTuningMount"),S=e(document.getElementById("pipelineViewMount"),"pipelineViewMount"),A=e(document.getElementById("segPresetList"),"segPresetList"),z=e(document.getElementById("segRecipeDrop"),"segRecipeDrop"),G=e(document.getElementById("segStepResize"),"segStepResize"),L=e(document.getElementById("segStepDenoise"),"segStepDenoise"),_=e(document.getElementById("segStepColor"),"segStepColor"),W=e(document.getElementById("segStepThreshold"),"segStepThreshold"),B=e(document.getElementById("segStepMorphology"),"segStepMorphology"),te=e(document.getElementById("segRunBtn"),"segRunBtn"),we=e(document.getElementById("segStatus"),"segStatus"),$e=e(document.getElementById("segMaskCanvas"),"segMaskCanvas"),ae=e(document.getElementById("segNextBtn"),"segNextBtn"),le=e(document.getElementById("segResetBtn"),"segResetBtn"),Qt=e(document.getElementById("segTuningMount"),"segTuningMount"),Jt=e(document.getElementById("colorsCanvas"),"colorsCanvas"),Yt=e(document.getElementById("palette"),"palette"),Xt=e(document.getElementById("btnColorsApply"),"btnColorsApply"),Zt=e(document.getElementById("btnColorsCancel"),"btnColorsCancel"),en=e(document.getElementById("btnColorsReset"),"btnColorsReset"),tn=e(document.getElementById("edgesDark"),"edgesDark"),nn=e(document.getElementById("edgeMaskThreshold"),"edgeMaskThreshold"),on=e(document.getElementById("edgeDilate"),"edgeDilate"),an=e(document.getElementById("maxRegionPx"),"maxRegionPx"),sn=e(document.getElementById("colorsStatus"),"colorsStatus"),rn=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),ln=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),cn=e(document.getElementById("devConfigDetails"),"devConfigDetails"),un=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),dn=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),gn=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),pn=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),fn=e(document.getElementById("logsCbDebug"),"logsCbDebug"),hn=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),mn=e(document.getElementById("cfgStatus"),"cfgStatus"),vn=e(document.getElementById("cfgOpenCvSpinner"),"cfgOpenCvSpinner"),yn=e(document.getElementById("cfgOpenCvStatus"),"cfgOpenCvStatus"),bn=e(document.getElementById("cfgOpenCvReport"),"cfgOpenCvReport"),wn=e(document.getElementById("settingsEngineBox"),"settingsEngineBox"),En=e(document.getElementById("cfgUseOpenCv"),"cfgUseOpenCv"),Cn=e(document.getElementById("tuningMount"),"tuningMount"),xn=e(document.getElementById("settingsVersion"),"settingsVersion"),kn=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),In=e(document.getElementById("logsLimit"),"logsLimit"),Sn=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),Mn=e(document.getElementById("logsStatus"),"logsStatus"),Rn=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),Dn=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),Pn=e(document.getElementById("btnLogsExport"),"btnLogsExport"),Tn=e(document.getElementById("btnLogsClear"),"btnLogsClear"),An=e(document.getElementById("logsOut"),"logsOut"),On=e(document.getElementById("debugLimit"),"debugLimit"),Ln=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),$n=e(document.getElementById("btnDebugExport"),"btnDebugExport"),Bn=e(document.getElementById("btnDebugClear"),"btnDebugClear"),Nn=e(document.getElementById("debugStatus"),"debugStatus"),zn=e(document.getElementById("debugOut"),"debugOut");return{rootEl:t,tabContour:o,tabColors:n,tabSettings:i,tabLogs:a,tabSegmentation:s,tabPipeline:u,viewContour:g,viewSegmentation:v,viewColors:r,viewSettings:c,viewLogs:p,viewPipeline:d,dropZoneEl:l,fileInputEl:f,btnProcessEl:y,btnCleanEl:h,btnDownloadEl:b,contourStatusEl:C,contourSpinnerEl:w,srcCanvasEl:E,outCanvasEl:I,clean1CanvasEl:R,clean2CanvasEl:k,cleanQualityBadgeEl:M,cleanQualityFillEl:m,cleanQualityTextEl:x,btnVectorizeEl:T,btnDownloadSvgEl:P,svgPreviewImgEl:$,svgPreviewTextEl:O,contourTuningMountEl:N,pipelineStatusEl:U,pipelineTuningMountEl:D,pipelineViewMountEl:S,segPresetListEl:A,segRecipeDropEl:z,segStepResizeEl:G,segStepDenoiseEl:L,segStepColorEl:_,segStepThresholdEl:W,segStepMorphologyEl:B,segRunBtn:te,segStatusEl:we,segMaskCanvasEl:$e,segNextBtn:ae,segResetBtn:le,segTuningMountEl:Qt,colorsCanvasEl:Jt,paletteEl:Yt,btnColorsApplyEl:Xt,btnColorsCancelEl:Zt,btnColorsResetEl:en,edgesDarkEl:tn,edgeMaskThresholdEl:nn,edgeDilateEl:on,maxRegionPxEl:an,colorsStatusEl:sn,cfgShowDevToolsEl:rn,settingsGeneralStatusEl:ln,devConfigDetailsEl:cn,cfgTraceConsoleEl:un,cfgActionLogMaxEl:dn,cfgDebugTraceMaxEl:gn,cfgFailureLogsPerRunEl:pn,logsCbDebugEl:fn,btnCfgResetDefaults:hn,cfgStatusEl:mn,settingsVersionEl:xn,settingsGitHubLinkEl:kn,cfgOpenCvSpinner:vn,cfgOpenCvStatus:yn,cfgOpenCvReport:bn,settingsEngineBoxEl:wn,cfgUseOpenCvEl:En,tuningMountEl:Cn,logsLimitEl:In,btnLogsRefresh:Sn,logsStatusEl:Mn,logsTrimKeepEl:Rn,btnLogsTrim:Dn,btnLogsExport:Pn,btnLogsClear:Tn,logsOutEl:An,debugLimitEl:On,btnDebugRefresh:Ln,btnDebugExport:$n,btnDebugClear:Bn,debugStatusEl:Nn,debugOutEl:zn}}const Fn=new Set;function jn(e){Fn.add(e)}function _n(){const e=new Set;function t(n){return e.add(n),()=>e.delete(n)}function o(){jn(i=>{for(const a of e)a(i)})}return{on:t,start:o}}const Kn=new Set;function Rt(e){for(const t of Kn)t(e,"local")}function he(e){const t=localStorage.getItem(e);if(t!==null)try{return JSON.parse(t)}catch{return t}}function Gn(e,t){localStorage.setItem(e,JSON.stringify(t))}async function de(e){if(typeof e=="string")return{[e]:he(e)};if(Array.isArray(e)){const o={};for(const n of e)o[n]=he(n);return o}const t={};for(const[o,n]of Object.entries(e))t[o]=localStorage.getItem(o)!==null?he(o):n;return t}async function ge(e){const t={};for(const[o,n]of Object.entries(e)){const i=he(o);Gn(o,n),t[o]={oldValue:i,newValue:n}}Rt(t)}async function et(e){const t=Array.isArray(e)?e:[e],o={};for(const n of t){const i=he(n);localStorage.removeItem(n),o[n]={oldValue:i,newValue:void 0}}Rt(o)}function ie(e,t,o,n){const i=Number(String(e??"").trim());return Number.isFinite(i)?Math.max(t,Math.min(o,Math.floor(i))):n}const qe="beecontour.devConfig",X={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let We=!1,Re={...X};function Dt(e){const t=e||{};return{traceConsole:!!t.traceConsole,actionLogMax:ie(t.actionLogMax??X.actionLogMax,100,5e4,X.actionLogMax),debugTraceMax:ie(t.debugTraceMax??X.debugTraceMax,100,5e4,X.debugTraceMax),failureLogsPerRun:ie(t.failureLogsPerRun??X.failureLogsPerRun,0,5e4,X.failureLogsPerRun)}}async function He(){if(We)return;const e=await de([qe]).catch(()=>({}));Re=Dt(e==null?void 0:e[qe]),We=!0}function De(){return Re}async function Pt(e){Re=Dt(e),We=!0,await ge({[qe]:Re}).catch(()=>null)}async function qn(){await Pt({...X})}function Wn(e,t){const o={segmentation:e.tabSegmentation,pipeline:e.tabPipeline,contour:e.tabContour,colors:e.tabColors,settings:e.tabSettings,logs:e.tabLogs},n={segmentation:e.viewSegmentation,pipeline:e.viewPipeline,contour:e.viewContour,colors:e.viewColors,settings:e.viewSettings,logs:e.viewLogs};let i="contour";const a=new Set;function s(){const d=De();return!!(d!=null&&d.traceConsole)}function u(){const d=globalThis;d.__bctGlobalErrorHooksInstalled||(d.__bctGlobalErrorHooksInstalled=!0,window.addEventListener("error",l=>{var y;const f=l;console.error("[panel] window error",{message:f.message,filename:f.filename,lineno:f.lineno,colno:f.colno,error:f.error?String(f.error):null,stack:(y=f.error)!=null&&y.stack?String(f.error.stack):null})}),window.addEventListener("unhandledrejection",l=>{var f;console.error("[panel] unhandledrejection",{reason:l.reason?String(l.reason):null,stack:(f=l.reason)!=null&&f.stack?String(l.reason.stack):null})}))}s()&&u();function g(d){Object.keys(o).forEach(l=>{const f=l===d;o[l].classList.toggle("is-active",f),o[l].setAttribute("aria-selected",f?"true":"false"),n[l].hidden=!f,n[l].classList.toggle("is-active",f)})}function r(d){var l,f,y,h,b,C,w,E;if(d===i){(f=(l=t[d]).refresh)==null||f.call(l);return}(h=(y=t[i]).unmount)==null||h.call(y),i=d,g(i),a.has(i)?(E=(w=t[i]).refresh)==null||E.call(w):(a.add(i),(C=(b=t[i]).mount)==null||C.call(b))}function c(){o.contour.addEventListener("click",d=>{var l;(l=d.preventDefault)==null||l.call(d),r("contour")}),o.segmentation.addEventListener("click",d=>{var l;(l=d.preventDefault)==null||l.call(d),r("segmentation")}),o.pipeline.addEventListener("click",d=>{var l;(l=d.preventDefault)==null||l.call(d),r("pipeline")}),o.colors.addEventListener("click",d=>{var l;(l=d.preventDefault)==null||l.call(d),r("colors")}),o.settings.addEventListener("click",d=>{var l;(l=d.preventDefault)==null||l.call(d),r("settings")}),o.logs.addEventListener("click",d=>{var l;(l=d.preventDefault)==null||l.call(d),r("logs")})}function p(){var d,l,f,y;i="contour",g(i),Object.keys(t).forEach(h=>{var b,C;return(C=(b=t[h]).boot)==null?void 0:C.call(b)}),a.has(i)?(y=(f=t[i]).refresh)==null||y.call(f):(a.add(i),(l=(d=t[i]).mount)==null||l.call(d))}function v(){Object.keys(t).forEach(d=>{var l,f;return(f=(l=t[d]).dispose)==null?void 0:f.call(l)})}return{bind:c,boot:p,activate:r,dispose:v}}function st(e){const t=e.items.length;return{items:e.items,counts:{items:t},meta:e.meta}}function Hn(){const e={items:[],meta:{}},t=new Set;function o(){const r=st(e);for(const c of t)try{c(r)}catch{}}function n(){return st(e)}function i(r){t.add(r);try{r(n())}catch{}return()=>t.delete(r)}function a(){e.items=[],e.meta={},o()}function s(r){e.meta.scopeUpdatedSince=r,o()}function u(){return String(e.meta.scopeUpdatedSince||"")}function g(r,c){e.items=r.slice(),e.meta.updatedTs=Date.now(),typeof(c==null?void 0:c.limit)=="number"&&(e.meta.limit=c.limit),o()}return{getSnapshot:n,subscribe:i,getScopeUpdatedSince:u,clearAll:a,setScopeUpdatedSince:s,setItems:g}}function Qn(){return{loadedImageName:null,hasImage:!1,hasOutput:!1,edgeMask:void 0,repairedMask:void 0,smoothedMask:void 0,svgText:void 0}}function Jn(e){e.loadedImageName=null,e.hasImage=!1,e.hasOutput=!1,e.edgeMask=void 0,e.repairedMask=void 0,e.smoothedMask=void 0,e.svgText=void 0}function Tt(e,t,o){const n=new Uint8Array(e.length);function i(y,h){return h*t+y}function a(y,h){return y<0||h<0||y>=t||h>=o?!1:e[i(y,h)]===1}let s=0,u=0,g=0,r=0,c=0;const p=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];for(let y=0;y<o;y++)for(let h=0;h<t;h++){if(!a(h,y))continue;s++;let b=0,C=!1;for(const[w,E]of p)a(h+w,y+E)?b++:C=!0;C&&u++,b===1?g++:b>=3&&r++}const v=[[-1,0],[1,0],[0,-1],[0,1]],d=new Int32Array(e.length),l=new Int32Array(e.length);for(let y=0;y<o;y++)for(let h=0;h<t;h++){const b=i(h,y);if(e[b]===0||n[b]===1)continue;c++,n[b]=1;let C=0,w=0;for(d[w]=h,l[w]=y,w++;C<w;){const E=d[C],I=l[C];C++;for(const[R,k]of v){const M=E+R,m=I+k;if(M<0||m<0||M>=t||m>=o)continue;const x=i(M,m);e[x]===0||n[x]===1||(n[x]=1,d[w]=M,l[w]=m,w++)}}}const f=s/Math.max(1,u);return{onPixels:s,boundaryPixels:u,components:c,endpoints:g,junctions:r,thicknessRatio:f}}function Yn(e,t){function o(d){e.contourStatusEl.textContent=d}function n(d,l){e.contourSpinnerEl.classList.toggle("is-hidden",!d),l&&o(l)}function i(){e.btnProcessEl.disabled=!t.hasImage,e.btnDownloadEl.disabled=!t.hasOutput,e.btnCleanEl.disabled=!t.hasOutput,e.btnVectorizeEl.disabled=!t.smoothedMask,e.btnDownloadSvgEl.disabled=!t.svgText}function a(){t.svgText=void 0,e.svgPreviewTextEl.textContent="",e.svgPreviewImgEl.removeAttribute("src")}function s(){const d=e.srcCanvasEl.getContext("2d"),l=e.outCanvasEl.getContext("2d");d.clearRect(0,0,e.srcCanvasEl.width,e.srcCanvasEl.height),l.clearRect(0,0,e.outCanvasEl.width,e.outCanvasEl.height);const f=e.clean1CanvasEl.getContext("2d"),y=e.clean2CanvasEl.getContext("2d");f.clearRect(0,0,e.clean1CanvasEl.width,e.clean1CanvasEl.height),y.clearRect(0,0,e.clean2CanvasEl.width,e.clean2CanvasEl.height)}function u(){const d=e.clean1CanvasEl.getContext("2d"),l=e.clean2CanvasEl.getContext("2d");d.clearRect(0,0,e.clean1CanvasEl.width,e.clean1CanvasEl.height),l.clearRect(0,0,e.clean2CanvasEl.width,e.clean2CanvasEl.height)}function g(d,l){const f=Number(d.value);return Number.isFinite(f)?f:l}function r(d,l){const f=l instanceof Error?l.message:String(l);o(`${d} failed: ${f}`),n(!1),console.error(`[BeeContour] ${d} failed`,l)}function c(d,l){if(!t.smoothedMask){e.cleanQualityBadgeEl.textContent="—",e.cleanQualityBadgeEl.className="qBadge qBadge--off",e.cleanQualityFillEl.style.width="0%",e.cleanQualityTextEl.textContent="";return}const f=Tt(t.smoothedMask,d,l),y=(M,m)=>Math.max(0,Math.min(1,M/Math.max(1,m))),h=y(f.components,800),b=y(f.endpoints,3e3),C=y(f.junctions,1500),w=f.thicknessRatio>5?1:f.thicknessRatio>3?.5:0,E=Math.round(100*(1-(.45*h+.45*b+.1*C)-.1*w)),I=Math.max(0,Math.min(100,E));let R="qBadge qBadge--bad",k=`Bad ${I}`;I>=70?(R="qBadge qBadge--ok",k=`Good ${I}`):I>=45&&(R="qBadge qBadge--warn",k=`OK ${I}`),e.cleanQualityBadgeEl.className=R,e.cleanQualityBadgeEl.textContent=k,e.cleanQualityFillEl.style.width=`${I}%`,e.cleanQualityTextEl.textContent=`CC:${f.components} end:${f.endpoints} j:${f.junctions} thick:${f.thicknessRatio.toFixed(2)}`}function p(){if(!t.hasOutput)return;const l=`${(t.loadedImageName||"beecontour").replace(/\.[a-z0-9]+$/i,"").replace(/[^a-z0-9-_]+/gi,"_")}_contour.png`,f=e.outCanvasEl.toDataURL("image/png"),y=document.createElement("a");y.href=f,y.download=l,document.body.appendChild(y),y.click(),y.remove(),o(`Downloaded: ${l}`)}function v(){if(!t.svgText)return;const l=`${(t.loadedImageName||"beecontour").replace(/\.[a-z0-9]+$/i,"").replace(/[^a-z0-9-_]+/gi,"_")}_contour.svg`,f=new Blob([t.svgText],{type:"image/svg+xml;charset=utf-8"}),y=URL.createObjectURL(f),h=document.createElement("a");h.href=y,h.download=l,document.body.appendChild(h),h.click(),h.remove(),URL.revokeObjectURL(y),o(`Downloaded: ${l}`)}return{setStatus:o,setContourBusyVisual:n,updateEnabled:i,clearSvgPreview:a,clearCanvases:s,clearCleanCanvasesOnly:u,getNumber:g,showError:r,updateCleanQualityUI:c,downloadPng:p,downloadSvg:v}}const me="beecontour.debugTrace",Qe="beecontour.debugTrace.enabled",Xn=2e3;function Zn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function Je(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}async function Pe(){const e=await de(me),t=e==null?void 0:e[me];return Array.isArray(t)?t:[]}async function eo(e){await ge({[me]:e})}async function tt(){const e=await de(Qe);return!!(e!=null&&e[Qe])}async function At(e){await ge({[Qe]:!!e}),e||await et(me)}async function Ot(){await et(me)}async function ve(e,t){if(!await tt())return{total:0};const n=Je((t==null?void 0:t.max)??Xn,100,5e4),i=(Array.isArray(e)?e:[e]).map(g=>({...g,id:Zn(),ts:Date.now()}));if(!i.length)return{total:(await Pe()).length};const s=(await Pe()).concat(i),u=s.length>n?s.slice(s.length-n):s;return await eo(u),{total:u.length}}async function Lt(e){const t=Je((e==null?void 0:e.limit)??200,1,5e4),o=Je((e==null?void 0:e.offset)??0,0,1e6),n=(e==null?void 0:e.reverse)??!0,i=await Pe(),a=i.length,u=(n?i.slice().reverse():i).slice(o,o+t);return{total:a,items:u}}async function $t(e){const t=await Pe();return JSON.stringify(t,null,e!=null&&e.pretty?2:0)}const Bt=Object.freeze(Object.defineProperty({__proto__:null,append:ve,clear:Ot,exportJson:$t,isEnabled:tt,list:Lt,setEnabled:At},Symbol.toStringTag,{value:"Module"}));function Be(e){return`[BCT][${e}]`}function to(e){function t(...a){e.traceOn()&&console.log(Be("trace"),...a)}function o(...a){console.warn(Be("warn"),...a)}function n(...a){console.error(Be("error"),...a)}function i(a,s){t(a,s),ve({scope:e.scope,kind:"debug",message:a,meta:s})}return{logTrace:t,logWarn:o,logError:n,traceScope:i}}const{logTrace:F,logWarn:ee,logError:H,traceScope:J}=to({scope:"panel",traceOn:()=>!!De().traceConsole});let Q=0;function Y(){return Q>0}function ne(e,t){if(t){Nt(e);return}Q=0,Te(e,!1)}async function pe(e,t){const o=`${Date.now()}-${Math.random().toString(16).slice(2)}`;F("[state] withBusy: enter",{id:o,busyCount:Q}),Nt(e,o);try{F("[state] withBusy: before await fn",{id:o,busyCount:Q});const n=await t();return F("[state] withBusy: after await fn (resolved)",{id:o,busyCount:Q}),n}catch(n){throw H("[state] withBusy: fn threw",{id:o,busyCount:Q,msg:String((n==null?void 0:n.message)??n),stack:String((n==null?void 0:n.stack)??"")}),n}finally{F("[state] withBusy: finally before endBusy",{id:o,busyCount:Q}),no(e,o),F("[state] withBusy: finally after endBusy",{id:o,busyCount:Q})}}function Nt(e,t){Q++,F("[state] beginBusy",{id:t,busyCount:Q}),Q===1&&Te(e,!0)}function no(e,t){if(Q--,F("[state] endBusy: dec",{id:t,busyCount:Q}),Q<=0){Q=0,F("[state] endBusy: applying busy=false",{id:t,busyCount:Q}),Te(e,!1);return}Q===0&&(F("[state] endBusy: applying busy=false (redundant branch)",{id:t,busyCount:Q}),Te(e,!1))}function Te(e,t){e.rootEl.classList.toggle("is-busy",t),e.cfgShowDevToolsEl.disabled=!1,e.fileInputEl.disabled=t,e.btnProcessEl.disabled=t,e.btnCleanEl.disabled=t,e.btnDownloadEl.disabled=t,e.btnVectorizeEl.disabled=t,e.btnDownloadSvgEl.disabled=t,e.cfgTraceConsoleEl.disabled=t,e.cfgActionLogMaxEl.disabled=t,e.cfgDebugTraceMaxEl.disabled=t,e.cfgFailureLogsPerRunEl.disabled=t,e.btnCfgResetDefaults.disabled=t,e.logsCbDebugEl.disabled=t,e.cfgUseOpenCvEl.disabled=t,e.logsLimitEl.disabled=t,e.btnLogsRefresh.disabled=t,e.logsTrimKeepEl.disabled=t,e.btnLogsTrim.disabled=t,e.btnLogsExport.disabled=t,e.btnLogsClear.disabled=t,e.debugLimitEl.disabled=t,e.btnDebugRefresh.disabled=t,e.btnDebugExport.disabled=t,e.btnDebugClear.disabled=t,e.btnColorsApplyEl.disabled=t,e.btnColorsCancelEl.disabled=t,e.btnColorsResetEl.disabled=t,e.edgesDarkEl.disabled=t,e.edgeMaskThresholdEl.disabled=t,e.edgeDilateEl.disabled=t,e.maxRegionPxEl.disabled=t;for(const o of Array.from(e.paletteEl.querySelectorAll("button")))o.disabled=t;e.colorsCanvasEl.style.pointerEvents=t?"none":"auto"}function K(e,t,o,n,i,a,s){return{id:e,title:t,implementedEngines:o,defaultEnginePolicy:n,params:i,children:a,description:s}}function oo(e){const t=new Map,o=new Map;function n(i,a){if(t.has(i.id))throw new Error(`[tuning] Duplicate component id: ${i.id}`);t.set(i.id,i),o.set(i.id,a);for(const s of i.children??[])n(s,i.id)}return n(e,null),{root:e,byId:t,parentById:o}}function nt(){const e=K("app","BeeContour",["native","opencv"],"native",{},[K("edge","Edge",["native","opencv"],"auto",{},[K("edge.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),K("edge.threshold","Threshold",["native","opencv"],"auto",{manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128}},void 0,"Convert image into a binary mask before edge extraction."),K("edge.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:3},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Clean the mask before extracting edges."),K("edge.extract","Edge extract",["native","opencv"],"auto",{},void 0,"Extract a 1px outline from the cleaned mask.")],"Fixed-order edge pipeline (image -> mask -> edges). Presets configure each step."),K("svg","SVG",["native","opencv"],"auto",{},[K("svg.create","Create SVG",["native","opencv"],"auto",{scale:{kind:"number",label:"Scale",min:1,max:10,step:1,default:1},transparentBg:{kind:"number",label:"Transparent bg (0/1)",min:0,max:1,step:1,default:1},color:{kind:"string",label:"Color",default:"#000"}},void 0,"Convert the edge mask into an SVG.")],"SVG generation parameters."),K("segmentation","Segmentation",["native","opencv"],"auto",{},[K("segmentation.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),K("segmentation.denoise","Denoise",["native","opencv"],"auto",{denoiseAlgo:{kind:"number",label:"Denoise algo",min:0,max:2,step:1,default:1},blurK:{kind:"number",label:"Blur kernel",min:1,max:21,step:2,default:3},bilateralSigma:{kind:"number",label:"Bilateral sigma",min:1,max:150,step:1,default:35}},void 0,"Reduce noise before thresholding."),K("segmentation.color","Color / Gray",["native","opencv"],"auto",{colorMode:{kind:"number",label:"Color mode",min:0,max:3,step:1,default:1},hsvChannel:{kind:"number",label:"HSV channel",min:0,max:2,step:1,default:2}},void 0,"Select color space / channel features for thresholding."),K("segmentation.threshold","Threshold",["native","opencv"],"auto",{thresholdAlgo:{kind:"number",label:"Threshold algo",min:0,max:3,step:1,default:1},manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128},adaptBlock:{kind:"number",label:"Adaptive block",min:3,max:101,step:2,default:31},adaptC:{kind:"number",label:"Adaptive C",min:-50,max:50,step:1,default:3}},void 0,"Convert features into a binary mask."),K("segmentation.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:5},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Remove specks, fill holes, and stabilize regions.")],"Fixed-order segmentation pipeline. Presets configure each step."),K("contour","Contour",["native","opencv"],"auto",{},[K("contour.process","Process",["native"],"auto",{contourScale:{kind:"number",label:"Processing scale",min:25,max:100,step:5,default:100},edgeThreshold:{kind:"number",label:"Edge threshold",min:1,max:255,step:1,default:70},invertOutput:{kind:"boolean",label:"White background",default:!0}}),K("contour.clean","Clean & Smooth",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:500,step:1,default:12},cleanRadius:{kind:"number",label:"Repair strength",min:1,max:3,step:1,default:1},cleanBinaryThreshold:{kind:"number",label:"Binary threshold",min:1,max:254,step:1,default:128}},[K("contour.clean.threshold","Threshold",["native"],"auto",{}),K("contour.clean.removeSmallComponents","Remove small components",["native","opencv"],"auto",{}),K("contour.clean.repair","Repair gaps",["native"],"auto",{}),K("contour.clean.smooth","Smooth mask",["native"],"auto",{}),K("contour.clean.quality","Quality metrics",["native"],"auto",{})]),K("contour.vectorize","Vectorize (SVG)",["native"],"native",{pathSmoothIters:{kind:"number",label:"Path smoothing",min:0,max:4,step:1,default:2}})]),K("colors","Colors",["native"],"auto",{},[K("colors.fill","Region fill",["native"],"auto",{edgesDark:{kind:"boolean",label:"Edges are dark",default:!0},edgeMaskThreshold:{kind:"number",label:"Edge threshold",min:0,max:255,step:1,default:80},edgeDilate:{kind:"number",label:"Gap close (px)",min:0,max:6,step:1,default:2},maxRegionPx:{kind:"number",label:"Max region (px)",min:1e3,step:1e3,default:2e5}})]),K("pipeline","Pipeline (UI)",["native","opencv"],"auto",{mode:{kind:"text",label:"Pipeline",default:"segmentation"},recipe:{kind:"text",label:"Recipe",default:"default"}},void 0,"UI state for the Pipeline tab (selected pipeline + recipe).")]);return oo(e)}function ao(e){return e.default}function io(e,t){const o={};for(const[n,i]of Object.entries(e))o[n]=ao(i);for(const[n,i]of Object.entries(t??{}))o[n]=i;return o}function so(e,t,o){var i;let n=e;for(;n;){const a=t.byId.get(n);if(!a)throw new Error(`[tuning] Unknown component: ${n}`);const u=((i=o[n])==null?void 0:i.enginePolicy)??a.defaultEnginePolicy;if(u!=="inherit")return u;n=t.parentById.get(n)??null}return"native"}function ro(e,t,o){const n=o.opencvReady&&e.includes("opencv");return e.includes("native")||e.length,t==="native"?{engine:"native"}:t==="opencv"?n?{engine:"opencv"}:{engine:"native",fallbackReason:o.opencvReady?"Policy=opencv, but component has no OpenCV implementation.":"Policy=opencv, but OpenCV is not available at runtime."}:t==="auto"?n?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}function zt(e,t,o,n){var r;const i=t.byId.get(e);if(!i)throw new Error(`[tuning] Unknown component: ${e}`);const a=so(e,t,o),{engine:s,fallbackReason:u}=ro(i.implementedEngines,a,n),g=io(i.params,(r=o[e])==null?void 0:r.params);return{id:e,policy:a,engine:s,fallbackReason:u,params:g}}const Ye="beecontour.tuning.components.v1";async function ye(){const e=await de([Ye]).catch(()=>({})),t=e==null?void 0:e[Ye];return!t||typeof t!="object"?{}:t}async function Vt(e){await ge({[Ye]:e}).catch(()=>null)}async function Ne(e,t){const o=await ye(),n=o[e]??{};o[e]={enginePolicy:t.enginePolicy??n.enginePolicy,params:{...n.params??{},...t.params??{}}},await Vt(o)}async function rt(e){const t=await ye();delete t[e],await Vt(t)}const ot={native:{available:!0},opencv:{available:!1,reason:"OpenCV not loaded"}};function lo(e){ot[e]={available:!0}}function co(e,t){ot[e]={available:!1,reason:t}}function se(){return ot.opencv.available===!0}function uo(){return{opencvReady:se()}}function go(e){return Array.isArray(e.children)&&e.children.length>0}function Ut(e){const{id:t,registry:o,stored:n,runtime:i}=e,a=o.byId.get(t);if(!a)throw new Error(`[tuning] Unknown component: ${t}`);const s=zt(t,o,n,i),u=n[t],g=u==null?void 0:u.enginePolicy,r=u==null?void 0:u.params,c=a.implementedEngines.includes("opencv"),p=!!i.opencvReady,v=[];for(const d of a.children??[])v.push(Ut({id:d.id,registry:o,stored:n,runtime:i}));return{id:a.id,title:a.title,description:a.description,isGroup:go(a),implementedEngines:a.implementedEngines,storedPolicy:g,storedParams:r,effectivePolicy:s.policy,effectiveEngine:s.engine,fallbackReason:s.fallbackReason,paramsSchema:a.params,effectiveParams:s.params,canImplementOpenCv:c,runtimeOpenCvReady:p,children:v}}function at(e={}){const t=e.registry??nt(),o=e.getRuntimeAvailability??uo;async function n(g="app"){const r=await ye(),c=o();if(!t.byId.get(g))throw new Error(`[tuning] Unknown scope: ${g}`);const v=Ut({id:g,registry:t,stored:r,runtime:c});return{scopeId:g,runtime:c,stored:r,root:v}}async function i(g,r){await Ne(g,{enginePolicy:r})}async function a(g,r,c){await Ne(g,{params:{[r]:c}})}async function s(g){await rt(g)}async function u(g,r){const p=(await ye())[g];if(!(p!=null&&p.params))return;const v={...p.params??{}};delete v[r];const d=typeof p.enginePolicy=="string",l=Object.keys(v).length>0;if(!d&&!l){await rt(g);return}await Ne(g,{enginePolicy:p.enginePolicy,params:v})}return{getRegistry:()=>t,loadTree:n,setEnginePolicy:i,setParam:a,resetNode:s,resetParam:u}}function po(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}function fo(e,t){if(e.kind==="number"){const o=Number(t),n=e.default,i=Number.isFinite(o)?o:n,a=typeof e.min=="number"?e.min:i,s=typeof e.max=="number"?e.max:i;return po(i,a,s)}return e.kind==="boolean"?!!t:String(t??e.default)}function ce(e,t,o,n){const i=e.byId.get(t);if(!i)throw new Error(`[tuningParams] unknown node: ${t}`);const a=i.params[o];if(!a)throw new Error(`[tuningParams] unknown param: ${t}.${o}`);return fo(a,n)}function Se(e,t){if((e==null?void 0:e.id)===t)return e;for(const o of(e==null?void 0:e.children)??[]){const n=Se(o,t);if(n)return n}return null}async function Le(){const e=at(),t=nt(),o=await e.loadTree("app"),n=Se(o.root,"contour.process"),i=Se(o.root,"contour.clean"),a=Se(o.root,"contour.vectorize");if(!n||!i||!a)throw new Error("[contour] tuning nodes missing (registry mismatch)");const s=ce(t,"contour.process","contourScale",n.effectiveParams.contourScale),u=ce(t,"contour.process","edgeThreshold",n.effectiveParams.edgeThreshold),g=ce(t,"contour.process","invertOutput",n.effectiveParams.invertOutput),r=ce(t,"contour.clean","cleanMinArea",i.effectiveParams.cleanMinArea),c=ce(t,"contour.clean","cleanRadius",i.effectiveParams.cleanRadius),p=ce(t,"contour.clean","cleanBinaryThreshold",i.effectiveParams.cleanBinaryThreshold),v=ce(t,"contour.vectorize","pathSmoothIters",a.effectiveParams.pathSmoothIters);return{contourScale:s,edgeThreshold:u,invertOutput:g,cleanMinArea:r,cleanRadius:c,cleanBinaryThreshold:p,pathSmoothIters:v}}async function lt(e,t,o,n){const{setStatus:i,setContourBusyVisual:a,clearCanvases:s,clearCleanCanvasesOnly:u,clearSvgPreview:g,updateEnabled:r,getNumber:c}=n;if(!o.type.startsWith("image/")){i("Unsupported file type (please drop an image)."),ee("Contour load: rejected non-image file",{name:o.name,type:o.type,size:o.size}),J("Contour load: rejected non-image file",{name:o.name,type:o.type,size:o.size});return}const p=performance.now();await pe(e,async()=>{a(!0,"Loading image…"),t.loadedImageName=o.name||"image";const v=URL.createObjectURL(o);J("Contour load: start",{name:o.name,type:o.type,size:o.size});try{const d=await new Promise((R,k)=>{const M=new Image;M.onload=()=>R(M),M.onerror=()=>k(new Error("Failed to load image")),M.src=v}),l=e.srcCanvasEl,f=l.getContext("2d");if(!f){H("Contour load: missing 2D context",{canvasId:"srcCanvasEl"}),i("Load failed — canvas context not available.");return}s();const h=(await Le()).contourScale,b=h/100;let C=Math.max(64,Math.floor(d.naturalWidth*b)),w=Math.max(64,Math.floor(d.naturalHeight*b));const E=1600,I=Math.min(1,E/Math.max(C,w));C=Math.max(64,Math.floor(C*I)),w=Math.max(64,Math.floor(w*I)),l.width=C,l.height=w,f.imageSmoothingEnabled=!0,f.clearRect(0,0,l.width,l.height),f.drawImage(d,0,0,l.width,l.height),t.hasImage=!0,t.hasOutput=!1,t.edgeMask=void 0,t.repairedMask=void 0,t.smoothedMask=void 0,t.svgText=void 0,g(),u(),r(),i(`Loaded: ${t.loadedImageName} (${l.width}×${l.height})`),J("Contour load: done",{naturalW:d.naturalWidth,naturalH:d.naturalHeight,scalePct:h,maxSide:E,targetW:C,targetH:w,pixels:C*w,ms:Math.round((performance.now()-p)*10)/10})}catch(d){H("Contour load: exception",{error:d instanceof Error?d.message:String(d)}),i("Load failed — see console / debug trace.")}finally{URL.revokeObjectURL(v),a(!1)}})}async function ho(e,t,o){const{setStatus:n,setContourBusyVisual:i,clearCleanCanvasesOnly:a,clearSvgPreview:s,updateEnabled:u}=o;if(!t.hasImage){ee("Contour process: skipped (no image loaded)");return}const g=performance.now();await pe(e,async()=>{i(!0,"Processing…"),await new Promise(r=>{setTimeout(()=>{(async()=>{try{const c=e.srcCanvasEl,p=e.outCanvasEl,v=c.width,d=c.height,l=v*d,f=await Le(),y=f.edgeThreshold,h=f.invertOutput;J("Contour process: start",{width:v,height:d,pixels:l,threshold:y,whiteBg:h}),p.width=v,p.height=d;const b=p.getContext("2d",{willReadFrequently:!0}),C=c.getContext("2d",{willReadFrequently:!0});if(!C||!b){H("Contour process: missing 2D context",{hasSrc:!!C,hasOut:!!b}),n("Process failed — canvas context not available.");return}const E=C.getImageData(0,0,v,d).data,I=new Uint8ClampedArray(v*d);for(let P=0,$=0;P<E.length;P+=4,$++){const O=E[P],N=E[P+1],U=E[P+2];I[$]=.299*O+.587*N+.114*U|0}const R=[-1,0,1,-2,0,2,-1,0,1],k=[-1,-2,-1,0,0,0,1,2,1],M=new Uint8ClampedArray(v*d);for(let P=1;P<d-1;P++)for(let $=1;$<v-1;$++){let O=0,N=0,U=0;for(let S=-1;S<=1;S++)for(let A=-1;A<=1;A++){const z=I[(P+S)*v+($+A)];O+=z*R[U],N+=z*k[U],U++}const D=Math.min(255,Math.sqrt(O*O+N*N)|0);M[P*v+$]=D>=y?255:0}const m=b.createImageData(v,d),x=m.data;let T=0;for(let P=0,$=0;P<M.length;P++,$+=4){const O=M[P];if(O===255&&T++,h){const U=O===255?0:255;x[$]=U,x[$+1]=U,x[$+2]=U,x[$+3]=255}else x[$]=O,x[$+1]=O,x[$+2]=O,x[$+3]=255}b.putImageData(m,0,0),t.hasOutput=!0,t.edgeMask=void 0,t.repairedMask=void 0,t.smoothedMask=void 0,s(),a(),n("Done. You can clean/smooth or download the PNG."),J("Contour process: done",{width:v,height:d,pixels:l,threshold:y,whiteBg:h,edgePixels:T,edgeRatio:Math.round(T/Math.max(1,l)*1e6)/1e6,ms:Math.round((performance.now()-g)*10)/10})}catch(c){H("Contour process: exception",{error:c instanceof Error?c.message:String(c)}),n("Process failed — see console / debug trace.")}finally{r()}})()},0)}),i(!1),u()})}function Xe(e,t,o,n){const i=new ImageData(t,o),a=i.data;for(let s=0,u=0;s<e.length;s++,u+=4){const g=e[s]===1;if(n){const r=g?0:255;a[u]=r,a[u+1]=r,a[u+2]=r,a[u+3]=255}else{const r=g?255:0;a[u]=r,a[u+1]=r,a[u+2]=r,a[u+3]=255}}return i}function ze(e,t,o,n){const i=new Uint8Array(e.length),a=Math.max(1,n);for(let s=0;s<o;s++)for(let u=0;u<t;u++){let g=0;for(let r=-a;r<=a&&!g;r++){const c=s+r;if(c<0||c>=o)continue;const p=c*t;for(let v=-a;v<=a;v++){const d=u+v;if(!(d<0||d>=t)&&e[p+d]===1){g=1;break}}}i[s*t+u]=g}return i}function Ve(e,t,o,n){const i=new Uint8Array(e.length),a=Math.max(1,n);for(let s=0;s<o;s++)for(let u=0;u<t;u++){let g=1;for(let r=-a;r<=a&&g;r++){const c=s+r;if(c<0||c>=o){g=0;break}const p=c*t;for(let v=-a;v<=a;v++){const d=u+v;if(d<0||d>=t){g=0;break}if(e[p+d]===0){g=0;break}}}i[s*t+u]=g}return i}function Ft(e,t,o,n){const i=new Uint8Array(e),a=new Uint8Array(e.length),s=new Int32Array(e.length),u=new Int32Array(e.length);for(let g=0;g<o;g++)for(let r=0;r<t;r++){const c=g*t+r;if(e[c]===0||a[c]===1)continue;let p=0,v=0;a[c]=1,s[v]=r,u[v]=g,v++;const d=[c];for(;p<v;){const l=s[p],f=u[p];p++;const y=[[l-1,f],[l+1,f],[l,f-1],[l,f+1]];for(const[h,b]of y){if(h<0||h>=t||b<0||b>=o)continue;const C=b*t+h;e[C]===0||a[C]===1||(a[C]=1,s[v]=h,u[v]=b,v++,d.push(C))}}if(d.length<n)for(const l of d)i[l]=0}return i}const mo=nt();function vo(){return{opencvReady:se()}}async function yo(e){const t=await ye(),o=vo(),n=zt(e,mo,t,o);if(e==="contour.clean.removeSmallComponents"){const i=Number(n.params.cleanMinArea??12);return{engine:n.engine,params:{cleanMinArea:i},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.resize"){const i=Number(n.params.resizeAlgo??1),a=Number(n.params.targetMaxW??900);return{engine:n.engine,params:{resizeAlgo:i,targetMaxW:a},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.denoise"){const i=Number(n.params.denoiseAlgo??1),a=Number(n.params.blurK??5),s=Number(n.params.bilateralSigma??35);return{engine:n.engine,params:{denoiseAlgo:i,blurK:a,bilateralSigma:s},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.color"){const i=Number(n.params.colorMode??1),a=Number(n.params.hsvChannel??2);return{engine:n.engine,params:{colorMode:i,hsvChannel:a},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.threshold"){const i=Number(n.params.thresholdAlgo??1),a=Number(n.params.manualT??128),s=Number(n.params.adaptBlock??21),u=Number(n.params.adaptC??2);return{engine:n.engine,params:{thresholdAlgo:i,manualT:a,adaptBlock:s,adaptC:u},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="segmentation.morphology"){const i=Number(n.params.morphAlgo??2),a=Number(n.params.morphK??7),s=Number(n.params.morphIters??1);return{engine:n.engine,params:{morphAlgo:i,morphK:a,morphIters:s},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="edge.resize"){const i=Number(n.params.resizeAlgo??1),a=Number(n.params.targetMaxW??1200);return{engine:n.engine,params:{resizeAlgo:i,targetMaxW:a},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="edge.threshold"){const i=Number(n.params.manualT??128);return{engine:n.engine,params:{manualT:i},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="edge.morphology"){const i=Number(n.params.morphAlgo??2),a=Number(n.params.morphK??3),s=Number(n.params.morphIters??1);return{engine:n.engine,params:{morphAlgo:i,morphK:a,morphIters:s},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}if(e==="edge.extract")return{engine:n.engine,params:{},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady};if(e==="svg.create"){const i=Number(n.params.scale??1),a=Number(n.params.transparentBg??1),s=String(n.params.color??"#000");return{engine:n.engine,params:{scale:i,transparentBg:a,color:s},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}throw new Error(`[opsDispatch] Unknown op: ${e}`)}async function bo(e,t,o){const{engine:n,params:i,fallbackReason:a,opencvReady:s}=await yo(e);return n==="opencv"&&!s?(ee(`OpenCV selected for ${e} but not ready; falling back to native. ${a??""}`.trim()),await o[e].native(t,i)):await o[e][n](t,i)}function wo(){const e=globalThis;return e!=null&&e.cv&&typeof e.cv.Mat=="function"?e.cv:null}function Eo(e,t){const{width:o,height:n}=e,i=Math.max(0,Math.floor(Number(t.cleanMinArea??0)));if(J("oopenCV RemoveSmallComponents: params",{width:o,height:n,minArea:i}),i<=1)return e.mask;const a=wo();if(!a)return Ft(e.mask,o,n,i);const s=new a.Mat(n,o,a.CV_8UC1);try{const u=s.data,g=e.mask;for(let v=0;v<g.length;v++)u[v]=g[v]?255:0;const r=new a.Mat,c=new a.Mat,p=new a.Mat;try{const v=a.connectedComponentsWithStats(s,r,c,p,8,a.CV_32S),d=a.CC_STAT_AREA??4,l=new Array(v).fill(!1);for(let h=1;h<v;h++)c.intAt(h,d)<i&&(l[h]=!0);const f=new Uint8Array(o*n),y=r.data32S;for(let h=0;h<f.length;h++){const b=y[h];f[h]=b>0&&!l[b]?1:0}return f}finally{r.delete(),c.delete(),p.delete()}}finally{s.delete()}}function Ee(e,t,o,n){const i=Math.max(0,Math.min(255,Math.floor(Number(n.manualT??128)))),a=new Uint8Array(t*o),s=e.data;for(let u=0,g=0;u<a.length;u++,g+=4){const r=s[g],c=s[g+1],p=s[g+2],v=r*77+c*150+p*29>>8;a[u]=v>=i?1:0}return a}function Ce(e,t,o,n){const i=Math.max(1,Math.floor(Number(n.targetMaxW??t)));if(!t||!o||t<=i)return e;const a=i/t,s=Math.max(1,Math.floor(t*a)),u=Math.max(1,Math.floor(o*a));return Math.floor(Number(n.resizeAlgo??1))===0?Co(e,t,o,s,u):xo(e,t,o,s,u)}function Co(e,t,o,n,i){const a=e.data,s=new Uint8ClampedArray(n*i*4),u=t/n,g=o/i;for(let r=0;r<i;r++){const c=Math.min(o-1,Math.max(0,Math.floor((r+.5)*g-.5)));for(let p=0;p<n;p++){const v=Math.min(t-1,Math.max(0,Math.floor((p+.5)*u-.5))),d=(c*t+v)*4,l=(r*n+p)*4;s[l]=a[d],s[l+1]=a[d+1],s[l+2]=a[d+2],s[l+3]=a[d+3]}}return new ImageData(s,n,i)}function xo(e,t,o,n,i){const a=e.data,s=new Uint8ClampedArray(n*i*4),u=t/n,g=o/i;for(let r=0;r<i;r++){const c=(r+.5)*g-.5,p=xe(Math.floor(c),0,o-1),v=xe(p+1,0,o-1),d=c-p;for(let l=0;l<n;l++){const f=(l+.5)*u-.5,y=xe(Math.floor(f),0,t-1),h=xe(y+1,0,t-1),b=f-y,C=(p*t+y)*4,w=(p*t+h)*4,E=(v*t+y)*4,I=(v*t+h)*4,R=(r*n+l)*4;for(let k=0;k<4;k++){const M=a[C+k],m=a[w+k],x=a[E+k],T=a[I+k],P=M+(m-M)*b,$=x+(T-x)*b,O=P+($-P)*d;s[R+k]=ko(O)}}}return new ImageData(s,n,i)}function xe(e,t,o){return e<t?t:e>o?o:e}function ko(e){return e<=0?0:e>=255?255:e|0}function ct(e,t,o,n){if(!t||!o)return e;const i=Math.floor(Number(n.denoiseAlgo??1));if(i<=0)return e;const a=Math.floor(Number(n.blurK??3)),s=Io(a);return i===2&&s<=3?Mo(e,t,o):s<=1?e:So(e,t,o,s)}function Io(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:3}function So(e,t,o,n){const i=n-1>>1,a=e.data,s=new Uint8ClampedArray(t*o*4);for(let g=0;g<o;g++){let r=0,c=0,p=0,v=0;for(let d=-i;d<=i;d++){const l=re(d,0,t-1),f=(g*t+l)*4;r+=a[f],c+=a[f+1],p+=a[f+2],v+=a[f+3]}for(let d=0;d<t;d++){const l=(g*t+d)*4;s[l]=r/n|0,s[l+1]=c/n|0,s[l+2]=p/n|0,s[l+3]=v/n|0;const f=re(d-i,0,t-1),y=re(d+i+1,0,t-1),h=(g*t+f)*4,b=(g*t+y)*4;r+=a[b]-a[h],c+=a[b+1]-a[h+1],p+=a[b+2]-a[h+2],v+=a[b+3]-a[h+3]}}const u=new Uint8ClampedArray(t*o*4);for(let g=0;g<t;g++){let r=0,c=0,p=0,v=0;for(let d=-i;d<=i;d++){const f=(re(d,0,o-1)*t+g)*4;r+=s[f],c+=s[f+1],p+=s[f+2],v+=s[f+3]}for(let d=0;d<o;d++){const l=(d*t+g)*4;u[l]=r/n|0,u[l+1]=c/n|0,u[l+2]=p/n|0,u[l+3]=v/n|0;const f=re(d-i,0,o-1),y=re(d+i+1,0,o-1),h=(f*t+g)*4,b=(y*t+g)*4;r+=s[b]-s[h],c+=s[b+1]-s[h+1],p+=s[b+2]-s[h+2],v+=s[b+3]-s[h+3]}}return new ImageData(u,t,o)}function Mo(e,t,o){const n=e.data,i=new Uint8ClampedArray(t*o*4),a=new Array(9),s=new Array(9),u=new Array(9),g=new Array(9);for(let r=0;r<o;r++)for(let c=0;c<t;c++){let p=0;for(let d=-1;d<=1;d++){const l=re(r+d,0,o-1);for(let f=-1;f<=1;f++){const y=re(c+f,0,t-1),h=(l*t+y)*4;a[p]=n[h],s[p]=n[h+1],u[p]=n[h+2],g[p]=n[h+3],p++}}a.sort(ke),s.sort(ke),u.sort(ke),g.sort(ke);const v=(r*t+c)*4;i[v]=a[4]|0,i[v+1]=s[4]|0,i[v+2]=u[4]|0,i[v+3]=g[4]|0}return new ImageData(i,t,o)}function ke(e,t){return e-t}function re(e,t,o){return e<t?t:e>o?o:e}function ut(e,t,o,n){if(!t||!o)return e;const i=Math.floor(Number(n.colorMode??1));if(i===0)return e;const a=e.data,s=new Uint8ClampedArray(t*o*4),u=Do(Math.floor(Number(n.hsvChannel??2)),0,2);for(let g=0,r=0;g<t*o;g++,r+=4){const c=a[r],p=a[r+1],v=a[r+2],d=a[r+3];let l=0;if(i===1)l=c*77+p*150+v*29>>8;else if(i===2){const f=Ro(c,p,v),y=u===0?f.h:u===1?f.s:f.v;l=Po(y*255)}else l=255-(c*77+p*150+v*29>>8);s[r]=l,s[r+1]=l,s[r+2]=l,s[r+3]=d}return new ImageData(s,t,o)}function Ro(e,t,o){const n=e/255,i=t/255,a=o/255,s=Math.max(n,i,a),u=Math.min(n,i,a),g=s-u;let r=0;g!==0&&(s===n?r=(i-a)/g%6:s===i?r=(a-n)/g+2:r=(n-i)/g+4,r/=6,r<0&&(r+=1));const c=s===0?0:g/s;return{h:r,s:c,v:s}}function Do(e,t,o){return e<t?t:e>o?o:e}function Po(e){return e<=0?0:e>=255?255:e|0}function Ie(e,t,o,n){if(!t||!o)return e;const i=Math.floor(Number(n.morphAlgo??2)),a=Ao(Math.floor(Number(n.morphIters??1)),1,20),s=Math.floor(Number(n.morphK??5)),u=To(s),g=u-1>>1;if(i<=0||u<=1)return e;let r=e,c=new Uint8Array(t*o);for(let p=0;p<a;p++){if(i===1){gt(r,c,t,o,g);const v=r;r=c,c=v;continue}if(i===2){dt(r,c,t,o,g);const v=r;r=c,c=v;continue}dt(r,c,t,o,g),r===e&&p===0&&(r=new Uint8Array(e)),gt(c,r,t,o,g)}return r}function To(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:5}function dt(e,t,o,n,i){t.fill(0);for(let a=0;a<n;a++){const s=Math.max(0,a-i),u=Math.min(n-1,a+i);for(let g=0;g<o;g++){const r=Math.max(0,g-i),c=Math.min(o-1,g+i);let p=0;for(let v=s;v<=u&&!p;v++){let d=v*o+r;for(let l=r;l<=c;l++,d++)if(e[d]){p=1;break}}t[a*o+g]=p}}}function gt(e,t,o,n,i){t.fill(0);for(let a=0;a<n;a++){const s=Math.max(0,a-i),u=Math.min(n-1,a+i);for(let g=0;g<o;g++){const r=Math.max(0,g-i),c=Math.min(o-1,g+i);let p=1;for(let v=s;v<=u&&p;v++){let d=v*o+r;for(let l=r;l<=c;l++,d++)if(!e[d]){p=0;break}}t[a*o+g]=p}}}function Ao(e,t,o){return e<t?t:e>o?o:e}function pt(e,t,o){const n=new Uint8Array(e.length),i=(a,s)=>s*t+a;for(let a=0;a<o;a++)for(let s=0;s<t;s++){const u=i(s,a);if(e[u]===0)continue;if(s===0||a===0||s===t-1||a===o-1){n[u]=255;continue}const r=e[i(s-1,a)],c=e[i(s+1,a)],p=e[i(s,a-1)],v=e[i(s,a+1)];(r===0||c===0||p===0||v===0)&&(n[u]=255)}return n}function ft(e,t,o,n){const i=Math.max(1,Math.floor(n.scale||1)),a=t*i,s=o*i,u=i;let g="";for(let v=0;v<o;v++){const d=v*t;for(let l=0;l<t;l++){if(e[d+l]===0)continue;const y=l*u,h=v*u;g+=`M${y} ${h}h${u}v${u}h-${u}Z`}}const r=n.transparentBg?"":`<rect x="0" y="0" width="${a}" height="${s}" fill="white"/>`,c=n.color||"#000",p=g.length>0?`<path d="${g}" fill="${c}" stroke="none"/>`:"";return`<svg xmlns="http://www.w3.org/2000/svg" width="${a}" height="${s}" viewBox="0 0 ${a} ${s}">`+r+p+"</svg>"}const Oo="demo",Lo={"contour.clean.removeSmallComponents":{native:(e,t)=>Ft(e.mask,e.width,e.height,t.cleanMinArea),opencv:(e,t)=>(F("OpenCV removeSmallComponents called (demo).",{width:e.width,height:e.height,cleanMinArea:t.cleanMinArea}),Eo(e,t))},"segmentation.resize":{native:(e,t)=>(F("[demo op] segmentation.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),Ce(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(F("[demo op] segmentation.resize opencv",{width:e.width,height:e.height}),Ce(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"segmentation.denoise":{native:(e,t)=>(F("[demo op] segmentation.denoise native",{width:e.width,height:e.height,denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}),ct(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma})),opencv:(e,t)=>(F("[demo op] segmentation.denoise opencv",{width:e.width,height:e.height}),ct(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}))},"segmentation.color":{native:(e,t)=>(F("[demo op] segmentation.color native",{width:e.width,height:e.height,colorMode:t.colorMode,hsvChannel:t.hsvChannel}),ut(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel})),opencv:(e,t)=>(F("[demo op] segmentation.color opencv",{width:e.width,height:e.height}),ut(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel}))},"segmentation.threshold":{native:(e,t)=>(F("[demo op] segmentation.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),Ee(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(F("[demo op] segmentation.threshold opencv",{width:e.width,height:e.height}),Ee(e.image,e.width,e.height,{manualT:t.manualT}))},"segmentation.morphology":{native:(e,t)=>(F("[demo op] segmentation.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),Ie(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(F("[demo op] segmentation.morphology opencv",{width:e.width,height:e.height}),Ie(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.resize":{native:(e,t)=>(F("[demo op] edge.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),Ce(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(F("[demo op] edge.resize opencv",{width:e.width,height:e.height}),Ce(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"edge.threshold":{native:(e,t)=>(F("[demo op] edge.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),Ee(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(F("[demo op] edge.threshold opencv",{width:e.width,height:e.height}),Ee(e.image,e.width,e.height,{manualT:t.manualT}))},"edge.morphology":{native:(e,t)=>(F("[demo op] edge.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),Ie(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(F("[demo op] edge.morphology opencv",{width:e.width,height:e.height}),Ie(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.extract":{native:(e,t)=>(F("[demo op] edge.extract native",{width:e.width,height:e.height}),pt(e.mask,e.width,e.height)),opencv:(e,t)=>(F("[demo op] edge.extract opencv",{width:e.width,height:e.height}),pt(e.mask,e.width,e.height))},"svg.create":{native:(e,t)=>(F("[demo op] svg.create native",{width:e.width,height:e.height,scale:t.scale}),ft(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color})),opencv:(e,t)=>(F("[demo op] svg.create opencv",{width:e.width,height:e.height,scale:t.scale}),ft(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color}))}};async function Z(e,t){return J("[opsDispatch] runOp",{op:e,implSource:Oo,inputKeys:t&&typeof t=="object"?Object.keys(t):typeof t}),bo(e,t,Lo)}async function $o(e,t){return Z(e,t)}async function Bo(e,t,o){const{setStatus:n,setContourBusyVisual:i,clearSvgPreview:a,updateEnabled:s,updateCleanQualityUI:u}=o;if(!t.hasOutput){ee("Contour clean: skipped (no output present)");return}const g=performance.now();await pe(e,async()=>{i(!0,"Cleaning…"),await new Promise(r=>{setTimeout(()=>{(async()=>{try{const c=e.outCanvasEl,p=e.clean1CanvasEl,v=e.clean2CanvasEl,d=await Le(),l=d.cleanRadius,f=d.cleanBinaryThreshold,y=d.invertOutput;p.width=c.width,p.height=c.height,v.width=c.width,v.height=c.height;const h=c.width,b=c.height,C=h*b;J("Contour clean: start",{width:h,height:b,pixels:C,whiteBg:y,EDGE_T:f,radius:l});const w=c.getContext("2d",{willReadFrequently:!0}),E=p.getContext("2d",{willReadFrequently:!0}),I=v.getContext("2d",{willReadFrequently:!0});if(!w||!E||!I){H("Contour clean: missing 2D context",{hasOut:!!w,hasC1:!!E,hasC2:!!I}),n("Clean failed — canvas context not available.");return}const k=w.getImageData(0,0,h,b).data,M=new Uint8Array(h*b);let m=0;for(let N=0,U=0;N<M.length;N++,U+=4){const D=k[U],A=(y?D<f:D>=f)?1:0;M[N]=A,A===1&&m++}J("Contour removeSmallComponents: params",{edge:M,width:h,height:b});const x=await $o("contour.clean.removeSmallComponents",{mask:M,width:h,height:b});J("Contour erode : params",{edgeNoSpeck:x,width:h,height:b,radius:l});const T=Ve(ze(x,h,b,l),h,b,l);E.putImageData(Xe(T,h,b,y),0,0),J("Contour dilate : params",{repaired:T,width:h,height:b,radius:l});const P=ze(Ve(T,h,b,l),h,b,l);J("Contour erode : params",{opened:P,width:h,height:b,radius:l});const $=Ve(ze(P,h,b,l),h,b,l);I.putImageData(Xe($,h,b,y),0,0),t.edgeMask=M,t.repairedMask=T,t.smoothedMask=$,a();const O=Tt($,h,b);u(h,b),n(`Clean done — CC:${O.components} endpoints:${O.endpoints} junctions:${O.junctions} thickness:${O.thicknessRatio.toFixed(2)}`),J("Contour clean: done",{width:h,height:b,pixels:C,whiteBg:y,EDGE_T:f,radius:l,edgeOn:m,edgeRatio:Math.round(m/Math.max(1,C)*1e6)/1e6,quality:O,ms:Math.round((performance.now()-g)*10)/10})}catch(c){H("Contour clean: exception",{error:c instanceof Error?c.message:String(c)}),n("Clean failed — see console / debug trace.")}finally{r()}})()},0)}),i(!1),s()})}function No(e,t,o){const n=new Uint8Array(e.length),i=[];function a(d,l){return l*t+d}function s(d,l){return d<0||l<0||d>=t||l>=o?!1:e[a(d,l)]===1}function u(d,l){if(!s(d,l))return!1;for(let f=-1;f<=1;f++)for(let y=-1;y<=1;y++)if(!(y===0&&f===0)&&!s(d+y,l+f))return!0;return!1}const g=[{dx:1,dy:0},{dx:1,dy:1},{dx:0,dy:1},{dx:-1,dy:1},{dx:-1,dy:0},{dx:-1,dy:-1},{dx:0,dy:-1},{dx:1,dy:-1}],r=2e3,c=Math.max(2e3,Math.floor((t+o)*2)),p=Math.max(2e5,Math.floor(t*o*.25));let v=0;for(let d=0;d<o;d++)for(let l=0;l<t;l++){if(i.length>=r||v>=p)return i;const f=a(l,d);if(n[f]===1||!u(l,d))continue;const y=[];let h=l,b=d,C=4,w=0;const E=Math.min(t*o,c*4);for(;w<E;){w++;const I=a(h,b);if(n[I]===1||(y.push({x:h,y:b}),n[I]=1,v++,y.length>=c)||v>=p)break;let R=!1;const k=(C+6)%8;for(let M=0;M<8;M++){const m=(k+M)%8,x=h+g[m].dx,T=b+g[m].dy;if(!u(x,T))continue;const P=a(x,T);if(!(!(x===l&&T===d&&y.length>10)&&n[P]===1)){h=x,b=T,C=m,R=!0;break}}if(!R||h===l&&b===d&&y.length>10)break}y.length>=20&&i.push(y)}return i}function ht(e,t){if(e.length<3)return e;const o=t*t;function n(r,c,p){const v=p.x-c.x,d=p.y-c.y,l=r.x-c.x,f=r.y-c.y,y=v*l+d*f;if(y<=0)return(r.x-c.x)**2+(r.y-c.y)**2;const h=v*v+d*d;if(h<=y)return(r.x-p.x)**2+(r.y-p.y)**2;const b=y/h,C=c.x+b*v,w=c.y+b*d;return(r.x-C)**2+(r.y-w)**2}const i=new Uint8Array(e.length);i[0]=1,i[e.length-1]=1;const a=[0],s=[e.length-1];for(;a.length>0;){const r=a.pop(),c=s.pop();if(c<=r+1)continue;const p=e[r],v=e[c];let d=0,l=-1;for(let f=r+1;f<c;f++){const y=n(e[f],p,v);y>d&&(d=y,l=f)}l!==-1&&d>o&&(i[l]=1,a.push(r),s.push(l),a.push(l),s.push(c))}const u=[];for(let r=0;r<e.length;r++)i[r]===1&&u.push(e[r]);const g=[];for(const r of u){const c=g[g.length-1];(!c||c.x!==r.x||c.y!==r.y)&&g.push(r)}return g}function zo(e,t){let o=e;for(let n=0;n<t;n++){if(o.length<3)return o;const i=[];for(let c=0;c<o.length-1;c++){const p=o[c],v=o[c+1];i.push({x:.75*p.x+.25*v.x,y:.75*p.y+.25*v.y},{x:.25*p.x+.75*v.x,y:.25*p.y+.75*v.y})}const a=o[0],s=o[o.length-1],u=a.x-s.x,g=a.y-s.y;if(u*u+g*g<=4){const c=o[o.length-1],p=o[0];i.push({x:.75*c.x+.25*p.x,y:.75*c.y+.25*p.y},{x:.25*c.x+.75*p.x,y:.25*c.y+.75*p.y})}o=i}return o}function Vo(e,t,o){const n=[];for(const i of e){const a=Uo(i);a&&n.push(`<path d="${a}" fill="none" stroke="#000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>`)}return`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${t}" height="${o}" viewBox="0 0 ${t} ${o}">
<rect x="0" y="0" width="${t}" height="${o}" fill="#fff"/>
`+n.join(`
`)+`
</svg>
`}function Uo(e){if(e.length<2)return"";const t=e.slice(),o=t[0],n=t[t.length-1],i=o.x-n.x,a=o.y-n.y,s=i*i+a*a<=4;s&&t.push({x:o.x,y:o.y});let u=`M ${t[0].x.toFixed(2)} ${t[0].y.toFixed(2)}`;for(let g=0;g<t.length-1;g++){const r=t[Math.max(0,g-1)],c=t[g],p=t[g+1],v=t[Math.min(t.length-1,g+2)],d=c.x+(p.x-r.x)/6,l=c.y+(p.y-r.y)/6,f=p.x-(v.x-c.x)/6,y=p.y-(v.y-c.y)/6;u+=` C ${d.toFixed(2)} ${l.toFixed(2)}, ${f.toFixed(2)} ${y.toFixed(2)}, ${p.x.toFixed(2)} ${p.y.toFixed(2)}`}return s&&(u+=" Z"),u}async function Fo(e,t,o){if(!t.smoothedMask){ee("Contour vectorize: skipped (no smoothed mask present)");return}const n=performance.now();await pe(e,async()=>{o.setContourBusyVisual(!0,"Vectorizing…");const i=()=>{t.svgText=void 0,e.svgPreviewTextEl.textContent="",e.svgPreviewImgEl.removeAttribute("src")};try{await new Promise((a,s)=>{setTimeout(()=>{(async()=>{try{const u=t.smoothedMask,g=e.outCanvasEl.width,r=e.outCanvasEl.height,c=g*r,p=1.5,d=(await Le()).pathSmoothIters;J("Contour vectorize: start",{width:g,height:r,pixels:c,epsilon:p,smoothIters:d});const l=No(u,g,r),f=l.length,y=l.reduce((k,M)=>k+M.length,0),h=l.reduce((k,M)=>Math.max(k,M.length),0);if(f===0||y===0){ee("Contour vectorize: no boundaries found",{width:g,height:r,pixels:c,pathsRaw:f,pointsRaw:y}),i(),o.setStatus("No boundaries found to vectorize."),a();return}if(f>2e3||y>2e5){ee("Contour vectorize: aborted (too complex)",{width:g,height:r,pixels:c,pathsRaw:f,pointsRaw:y,maxPolyline:h}),i(),o.setStatus(`Vectorize aborted: too complex (paths ${f}, points ${y}). Try stronger clean / higher minArea / lower resolution.`),a();return}J("Contour vectorize: traced boundaries",{pathsRaw:f,pointsRaw:y,maxPolyline:h});const b=l.filter(k=>k.length>=20).map(k=>{const M=ht(k,p),m=d>0?zo(M,d):M;return ht(m,p)}).filter(k=>k.length>=3),C=b.length,w=b.reduce((k,M)=>k+M.length,0),E=b.reduce((k,M)=>Math.max(k,M.length),0);if(C===0||w===0){ee("Contour vectorize: simplified to nothing",{pathsRaw:f,pointsRaw:y,pathsOut:C,pointsOut:w,smoothIters:d,epsilon:p}),i(),o.setStatus("Vectorize produced no usable paths (after simplification)."),a();return}J("Contour vectorize: simplified",{pathsOut:C,pointsOut:w,maxOut:E,smoothIters:d,epsilon:p});const I=Vo(b,g,r);t.svgText=I,e.svgPreviewTextEl.textContent=I;const R=encodeURIComponent(I).replace(/'/g,"%27").replace(/"/g,"%22");e.svgPreviewImgEl.src=`data:image/svg+xml;charset=utf-8,${R}`,o.setStatus(`SVG generated: paths ${C}, points ${y}→${w}, smooth ${d}`),J("Contour vectorize: done",{width:g,height:r,pixels:c,smoothIters:d,epsilon:p,pathsRaw:f,pointsRaw:y,pathsOut:C,pointsOut:w,svgChars:I.length,ms:Math.round((performance.now()-n)*10)/10}),a()}catch(u){H("Contour vectorize: exception",{error:u instanceof Error?u.message:String(u),ms:Math.round((performance.now()-n)*10)/10}),s(u)}})()},0)})}catch(a){o.showError("Vectorize",a),i()}finally{o.setContourBusyVisual(!1),o.updateEnabled()}})}function jo(e,t){const o=Qn(),n=Yn(e,o);function i(){const g=e.dropZoneEl;function r(c){g.classList.toggle("is-hover",c)}g.addEventListener("dragover",c=>{c.preventDefault(),r(!0)}),g.addEventListener("dragleave",()=>r(!1)),g.addEventListener("drop",c=>{var v;c.preventDefault(),r(!1);const p=(v=c.dataTransfer)==null?void 0:v.files;!p||p.length===0||lt(e,o,p[0],{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearCanvases:n.clearCanvases,clearCleanCanvasesOnly:n.clearCleanCanvasesOnly,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,getNumber:n.getNumber})}),e.fileInputEl.addEventListener("change",()=>{var p;const c=(p=e.fileInputEl.files)==null?void 0:p[0];c&&(lt(e,o,c,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearCanvases:n.clearCanvases,clearCleanCanvasesOnly:n.clearCleanCanvasesOnly,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,getNumber:n.getNumber}),e.fileInputEl.value="")})}function a(){i(),e.btnDownloadEl.addEventListener("click",()=>n.downloadPng()),e.btnDownloadSvgEl.addEventListener("click",()=>n.downloadSvg()),e.btnProcessEl.addEventListener("click",()=>{ho(e,o,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearCleanCanvasesOnly:n.clearCleanCanvasesOnly,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled})}),e.btnCleanEl.addEventListener("click",()=>{Bo(e,o,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,updateCleanQualityUI:n.updateCleanQualityUI})}),e.btnVectorizeEl.addEventListener("click",()=>{Fo(e,o,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,updateEnabled:n.updateEnabled,showError:n.showError,getNumber:n.getNumber})}),Jn(o),n.clearSvgPreview(),n.updateEnabled(),n.setStatus("No image loaded"),e.contourSpinnerEl.classList.add("is-hidden")}function s(){}function u(){}return{id:"contour",bind:a,mount:s,unmount:u}}function _o(){return{status:"Idle",report:["Segmentation placeholder","","Planned:","- Multi-step segmentation pipeline (process1..processN)","- Per-step engine selection: native / opencv / auto","- OpenCV injection + probing is managed in Settings (demo-only)."].join(`
`),assignedByStep:new Map,activeRecipePresetId:null,getStepEls(e){return{"segmentation.resize":e.segStepResizeEl,"segmentation.denoise":e.segStepDenoiseEl,"segmentation.color":e.segStepColorEl,"segmentation.threshold":e.segStepThresholdEl,"segmentation.morphology":e.segStepMorphologyEl}}}}const jt=[{id:"seg.recipe.document",title:"Recipe: Document scan",target:"segmentation",params:[{id:"segmentation.resize",key:"resizeAlgo",value:1},{id:"segmentation.resize",key:"targetMaxW",value:1200},{id:"segmentation.denoise",key:"denoiseAlgo",value:1},{id:"segmentation.denoise",key:"blurK",value:3},{id:"segmentation.color",key:"colorMode",value:1},{id:"segmentation.threshold",key:"thresholdAlgo",value:2},{id:"segmentation.threshold",key:"adaptBlock",value:31},{id:"segmentation.threshold",key:"adaptC",value:3},{id:"segmentation.morphology",key:"morphAlgo",value:2},{id:"segmentation.morphology",key:"morphK",value:5},{id:"segmentation.morphology",key:"morphIters",value:1}]},{id:"seg.threshold.otsu",title:"Threshold: Otsu",target:"segmentation.threshold",params:[{id:"segmentation.threshold",key:"thresholdAlgo",value:1}]},{id:"seg.morph.fill-holes",title:"Morphology: Fill holes (close)",target:"segmentation.morphology",params:[{id:"segmentation.morphology",key:"morphAlgo",value:3},{id:"segmentation.morphology",key:"morphK",value:7},{id:"segmentation.morphology",key:"morphIters",value:1}]}];function Ko(e){return jt.find(t=>t.id===e)??null}function Ue(e,t,o){const n=document.createElement(e);return t&&(n.className=t),typeof o=="string"&&(n.textContent=o),n}function Go(e,t){return t==="recipe"?e.target==="segmentation":e.target===t}function qo(e,t,o){const n=[],i=o.getStepEls(e);function a(){const f=e.segPresetListEl;f.innerHTML="";for(const y of jt){const h=Ue("div","segPresetCard");h.setAttribute("draggable","true"),h.setAttribute("data-preset-id",y.id),h.setAttribute("aria-label",`Preset: ${y.title}`);const b=Ue("div","segPresetCardTitle",y.title),C=Ue("div","segPresetCardDesc",y.description||`Target: ${y.target}`);h.appendChild(b),h.appendChild(C);const w=E=>{E.dataTransfer&&(E.dataTransfer.setData("text/plain",y.id),E.dataTransfer.effectAllowed="copy")};h.addEventListener("dragstart",w),n.push(()=>h.removeEventListener("dragstart",w)),f.appendChild(h)}}function s(f,y){const h=f.querySelector("[data-assigned]");h&&(h.textContent=y,h.classList.remove("muted"))}function u(f){const y=f.querySelector("[data-assigned]");y&&(y.textContent="Drop preset…",y.classList.add("muted"))}function g(f){for(const y of Object.keys(i))o.assignedByStep.set(y,f.id),s(i[y],f.title);o.activeRecipePresetId=f.id,s(e.segRecipeDropEl,f.title)}function r(f,y,h){o.assignedByStep.set(f,y.id),s(h,y.title)}function c(f,y){const h=E=>{E.preventDefault(),f.classList.add("is-over")},b=E=>{E.preventDefault(),f.classList.add("is-over"),E.dataTransfer&&(E.dataTransfer.dropEffect="copy")},C=()=>{f.classList.remove("is-over")},w=async E=>{var k;E.preventDefault(),f.classList.remove("is-over");const I=((k=E.dataTransfer)==null?void 0:k.getData("text/plain"))||"";if(!I)return;const R=Ko(I);R&&Go(R,y)&&(y==="recipe"?g(R):r(y,R,f),await t.applyPreset(R))};f.addEventListener("dragenter",h),f.addEventListener("dragover",b),f.addEventListener("dragleave",C),f.addEventListener("drop",w),n.push(()=>f.removeEventListener("dragenter",h)),n.push(()=>f.removeEventListener("dragover",b)),n.push(()=>f.removeEventListener("dragleave",C)),n.push(()=>f.removeEventListener("drop",w))}function p(){a(),c(e.segRecipeDropEl,"recipe"),c(i["segmentation.resize"],"segmentation.resize"),c(i["segmentation.denoise"],"segmentation.denoise"),c(i["segmentation.color"],"segmentation.color"),c(i["segmentation.threshold"],"segmentation.threshold"),c(i["segmentation.morphology"],"segmentation.morphology")}function v(){o.assignedByStep.clear(),o.activeRecipePresetId=null,u(e.segRecipeDropEl);for(const f of Object.keys(i))u(i[f])}function d(f){}function l(){for(const f of n)f();n.length=0}return p(),{set:d,resetUi:v,dispose:l}}async function Wo(e,t){if(t.input.kind!=="image")throw new Error(`[segmentation] runImageOp: Mat input not supported yet for ${e}`);return{kind:"image",image:await Z(e,{image:t.input.image,width:t.width,height:t.height})}}async function mt(e,t){if(e==="segmentation.threshold"){const{input:a,width:s,height:u}=t;if(a.kind!=="image")throw new Error("[segmentation] runMaskOp(threshold): Mat input not supported yet");return await Z(e,{image:a.image,width:s,height:u})}const{mask:o,width:n,height:i}=t;return await Z(e,{mask:o,width:n,height:i})}const oe=[{id:"segmentation.resize",kind:"image"},{id:"segmentation.denoise",kind:"image"},{id:"segmentation.color",kind:"image"},{id:"segmentation.threshold",kind:"mask"},{id:"segmentation.morphology",kind:"mask"}];function Ho(e,t,o){const n=_o(),i=qo(e,o,n);let a=null;const s=n.getStepEls(e);function u(w){e.segStatusEl.textContent=w||""}function g(){for(const w of Object.values(s))w.classList.remove("is-active"),w.classList.remove("is-done")}function r(w){var E,I;for(const R of Object.values(s))R.classList.remove("is-active"),R.classList.remove("is-done");if(a){for(let R=0;R<Math.min(a.stepIndex,oe.length);R++){const k=oe[R].id;(E=s[k])==null||E.classList.add("is-done")}w&&((I=s[w])==null||I.classList.add("is-active"))}}function c(){if(!a)return;const{width:w,height:E}=a;e.segMaskCanvasEl.width=w,e.segMaskCanvasEl.height=E;const I=e.segMaskCanvasEl.getContext("2d",{willReadFrequently:!0});if(!I){H("[segmentation] preview: missing 2D context");return}if(a.artifact.kind==="image"){I.putImageData(a.artifact.image,0,0);return}I.putImageData(Xe(a.artifact.mask,w,E,!0),0,0)}function p(){const w=e.srcCanvasEl,E=w.width,I=w.height;if(!E||!I)return null;const R=w.getContext("2d",{willReadFrequently:!0});if(!R)return null;const k=R.getImageData(0,0,E,I);return{width:E,height:I,stepIndex:0,artifact:{kind:"image",image:k}}}async function v(){if(!a&&(a=p(),!a)){u("No image");return}if(a.stepIndex>=oe.length){u("Done");return}const w=oe[a.stepIndex],{width:E,height:I}=a;if(r(w.id),u(`Running: ${w.id}`),J("[segmentation] next step",{stepIndex:a.stepIndex,stepId:w.id,width:E,height:I,artifact:a.artifact.kind}),w.id==="segmentation.resize"||w.id==="segmentation.denoise"||w.id==="segmentation.color"){if(a.artifact.kind!=="image")throw new Error(`[segmentation] step ${w.id} expected image input, got mask`);const R=await Wo(w.id,{input:{kind:"image",image:a.artifact.image},width:E,height:I});if(R.kind!=="image")throw new Error(`[segmentation] step ${w.id} returned non-image`);const k=a.stepIndex<oe.length?oe[a.stepIndex].id:null;r(k),a.artifact={kind:"image",image:R.image},a.stepIndex++,c(),u(`Done: ${w.id}`);return}if(w.id==="segmentation.threshold"){if(a.artifact.kind!=="image")throw new Error("[segmentation] threshold expected image input, got mask");const R=await mt("segmentation.threshold",{input:{kind:"image",image:a.artifact.image},width:E,height:I});a.artifact={kind:"mask",mask:R},a.stepIndex++,c(),r(null),u("Done: segmentation.threshold");return}if(w.id==="segmentation.morphology"){if(a.artifact.kind!=="mask")throw new Error("[segmentation] morphology expected mask input, got image");const R=await mt("segmentation.morphology",{mask:a.artifact.mask,width:E,height:I});a.artifact={kind:"mask",mask:R},a.stepIndex++,c(),r(null),u("Done: segmentation.morphology");return}}async function d(){if(a=p(),!a){u("No image");return}for(c(),u("Running all…");a&&a.stepIndex<oe.length;)await v();u("Done")}function l(){var I;i.resetUi(),a=null,g();const w=p();if(w){a=w,r((I=oe[0])==null?void 0:I.id),c(),u("Ready (reset to source)");return}u("No image");const E=e.segMaskCanvasEl.getContext("2d");E&&E.clearRect(0,0,e.segMaskCanvasEl.width,e.segMaskCanvasEl.height)}function f(){e.segRunBtn.addEventListener("click",()=>{pe(e,async()=>{try{await d()}catch(w){H("[segmentation] runAll exception",{error:w instanceof Error?w.message:String(w)}),u("Failed")}})}),e.segNextBtn.addEventListener("click",()=>{pe(e,async()=>{try{await v()}catch(w){H("[segmentation] nextStep exception",{error:w instanceof Error?w.message:String(w)}),u("Failed")}})}),e.segResetBtn.addEventListener("click",()=>l())}function y(){var E;if(F("[segmentation] mount"),a){c(),u("Ready");return}const w=p();if(w)a=w,g(),r((E=oe[0])==null?void 0:E.id),c(),u("Ready (source loaded)");else{g();const I=e.segMaskCanvasEl.getContext("2d");I&&I.clearRect(0,0,e.segMaskCanvasEl.width,e.segMaskCanvasEl.height),u("No image")}}function h(){var E;if(F("[segmentation] refresh"),a){c();return}const w=p();if(w){a=w,g(),r((E=oe[0])==null?void 0:E.id),c(),u("Ready (source loaded)");return}u("No image")}function b(){}function C(){i.dispose()}return{bind:f,mount:y,refresh:h,unmount:b,dispose:C}}function Fe(e,t,o){return Number.isFinite(e)?Math.max(t,Math.min(o,Math.trunc(e))):t}function Qo(e,t,o){return Math.round(.2126*e+.7152*t+.0722*o)}function _t(e){return{edgesDark:!!(e.edgesDark??!0),edgeThreshold:Fe(e.edgeThreshold??80,0,255),edgeDilate:Fe(e.edgeDilate??2,0,6),maxRegionPx:Fe(e.maxRegionPx??2e5,1e3,1e7)}}function Jo(e,t,o){const{data:n,width:i,height:a}=e,s=new Uint8Array(i*a);for(let u=0,g=0;u<s.length;u++,g+=4){const r=n[g+0],c=n[g+1],p=n[g+2];if(n[g+3]===0){s[u]=0;continue}const d=Qo(r,c,p),l=t?d<=o:d>=255-o;s[u]=l?1:0}return s}function Yo(e,t,o,n){if(n<=0)return e;let i=e;for(let a=0;a<n;a++){const s=new Uint8Array(t*o);for(let u=0;u<o;u++)for(let g=0;g<t;g++){const r=u*t+g;if(i[r]){s[r]=1;continue}let c=0;for(let p=-1;p<=1&&!c;p++){const v=u+p;if(!(v<0||v>=o))for(let d=-1;d<=1;d++){const l=g+d;if(!(l<0||l>=t)&&i[v*t+l]){c=1;break}}}s[r]=c}i=s}return i}function Xo(e,t,o,n,i,a){const s=t*n+e;if(o[s])return{ok:!1,message:"Click is on an edge; pick inside a region."};const u=new Uint8Array(n*i),g=new Int32Array(n*i),r=new Int32Array(n*i);let c=0,p=0;g[p]=e,r[p]=t,p++,u[s]=1;let v=1;for(;c<p;){const d=g[c],l=r[c];c++;const f=[[d-1,l],[d+1,l],[d,l-1],[d,l+1]];for(const[y,h]of f){if(y<0||y>=n||h<0||h>=i)continue;const b=h*n+y;if(!u[b]&&!o[b]&&(u[b]=1,g[p]=y,r[p]=h,p++,v++,v>a))return{ok:!1,message:`Region too large (>${a}px). Increase Max region or fix gaps.`}}}return{ok:!0,mask:u}}function Zo(e,t,o,n){const i=new Uint8Array(o*n);for(let a=1;a<n-1;a++)for(let s=1;s<o-1;s++){const u=a*o+s;if(!e[u])continue;const g=(a-1)*o+s,r=(a+1)*o+s,c=a*o+(s-1),p=a*o+(s+1);(!e[g]||!e[r]||!e[c]||!e[p]||t[g]||t[r]||t[c]||t[p])&&(i[u]=1)}return i}function ea(e,t,o,n){const i=_t(n),a=e.width,s=e.height;let u=Jo(e,i.edgesDark,i.edgeThreshold);u=Yo(u,a,s,i.edgeDilate);const g=Xo(t,o,u,a,s,i.maxRegionPx);if(!g.ok)return{ok:!1,message:g.message};const r=Zo(g.mask,u,a,s);return{ok:!0,preview:{mask:g.mask,outline:r,w:a,h:s}}}function ta(e,t,o){const n=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),i=o.replace("#",""),a=parseInt(i.slice(0,2),16),s=parseInt(i.slice(2,4),16),u=parseInt(i.slice(4,6),16),g=n.data;for(let r=0,c=0;r<t.mask.length;r++,c+=4)t.mask[r]&&(g[c+0]=a,g[c+1]=s,g[c+2]=u);return n}function je(e,t,o){return Number.isFinite(e)?Math.max(t,Math.min(o,Math.trunc(e))):t}function vt(e){const t=(e||"").trim();if(!t)return null;const o=t.startsWith("#")?t:`#${t}`;return/^#[0-9a-fA-F]{6}$/.test(o)?o.toLowerCase():null}function na(e){let t="#ff3b30",o=[],n=null;function i(f){e.colorsStatusEl.textContent=f||""}function a(){const f=!!e.edgesDarkEl.checked,y=je(parseInt(e.edgeMaskThresholdEl.value,10),0,255),h=je(parseInt(e.edgeDilateEl.value,10),0,6),b=je(parseInt(e.maxRegionPxEl.value,10),1e3,1e7);return e.edgeMaskThresholdEl.value=String(y),e.edgeDilateEl.value=String(h),e.maxRegionPxEl.value=String(b),_t({edgesDark:f,edgeThreshold:y,edgeDilate:h,maxRegionPx:b})}function s(f){const y=vt(f);if(y){t=y;for(const h of Array.from(e.paletteEl.querySelectorAll(".paletteItem"))){const b=h.dataset.hex||"";h.classList.toggle("is-selected",b===t)}}}function u(){return t}function g(f){o=f.slice(),e.paletteEl.innerHTML="";for(const y of o){const h=vt(y);if(!h)continue;const b=document.createElement("button");b.type="button",b.className="paletteItem",b.style.background=h,b.dataset.hex=h,b.setAttribute("role","listitem"),b.setAttribute("aria-label",`Select ${h}`),b.addEventListener("click",()=>{s(h)}),e.paletteEl.appendChild(b)}s(t)}function r(f){const y=e.colorsCanvasEl;y.width=f.width,y.height=f.height,y.getContext("2d").putImageData(f,0,0)}function c(f,y){r(f);const h=e.colorsCanvasEl.getContext("2d"),{outline:b,w:C,h:w}=y,E=h.getImageData(0,0,C,w),I=E.data;for(let R=0,k=0;R<b.length;R++,k+=4)b[R]&&(I[k+0]=255,I[k+1]=60,I[k+2]=60,I[k+3]=220);h.putImageData(E,0,0)}function p(f){e.btnColorsApplyEl.disabled=!f}function v(f){e.btnColorsCancelEl.disabled=!f}function d(f){n=f}function l(){i("Idle"),p(!1),v(!1),e.colorsCanvasEl.addEventListener("click",f=>{if(!n)return;const y=e.colorsCanvasEl.getBoundingClientRect(),h=Math.floor((f.clientX-y.left)/y.width*e.colorsCanvasEl.width),b=Math.floor((f.clientY-y.top)/y.height*e.colorsCanvasEl.height);n(h,b)})}return{bind:l,setStatus:i,getSettings:a,setSelectedColor:s,getSelectedColor:u,renderPalette:g,drawBase:r,drawPreview:c,setApplyEnabled:p,setCancelEnabled:v,onCanvasClick:d}}const oa=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#a2845e","#8e8e93","#1c1c1e","#ffffff","#000000","#4cd964","#5ac8fa","#ff6b6b","#7aa2ff","#f5a623","#50e3c2"];function aa(e,t){const o=na(e);let n=null,i=null;function a(p){o.setStatus(p)}function s(){const p=e.outCanvasEl.getContext("2d");if(!p)return null;const v=e.outCanvasEl.width,d=e.outCanvasEl.height;return v<=0||d<=0?null:p.getImageData(0,0,v,d)}function u(){const p=s();if(!p){n=null,i=null,o.setApplyEnabled(!1),o.setCancelEnabled(!1),a("No output available. Run Process first.");return}n=p,i=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),a("Ready. Pick a color, click inside a region.")}function g(){if(n){o.drawBase(n);return}const p=s();if(!p){a("No output available. Run Process first.");return}n=p,i=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),a("Loaded output. Pick a color, click inside a region.")}function r(){if(!n||!i)return;const p=o.getSelectedColor();n=ta(n,i,p),i=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),a("Fill applied. Click another region.")}function c(){n&&(i=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),a("Preview canceled."))}return{bind(){o.bind(),o.renderPalette(oa),o.onCanvasClick((p,v)=>{if(!n){a("No output available. Run Process first.");return}const d=o.getSettings(),l=ea(n,p,v,d);if(!l.ok){i=null,o.setApplyEnabled(!1),o.setCancelEnabled(!1),a(l.message);return}i=l.preview,o.drawPreview(n,i),o.setApplyEnabled(!0),o.setCancelEnabled(!0),a("Preview shown. Apply fill or cancel.")}),e.btnColorsApplyEl.addEventListener("click",()=>r()),e.btnColorsCancelEl.addEventListener("click",()=>c()),e.btnColorsResetEl.addEventListener("click",()=>u()),e.tabColors.addEventListener("click",()=>{queueMicrotask(()=>g())}),a("Idle"),o.setApplyEnabled(!1),o.setCancelEnabled(!1)}}}const Ae="beecontour.actionLog",ia=5e3;function sa(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function ra(e){return Array.isArray(e)?e:[e]}function Oe(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}async function be(){const e=await de(Ae),t=e==null?void 0:e[Ae];return Array.isArray(t)?t:[]}async function Kt(e){await ge({[Ae]:e})}async function q(e,t){const o=Oe(ia,100,5e4),i=ra(e).map(g=>({...g,id:sa(),ts:Date.now()}));if(!i.length)return{total:(await be()).length};const s=(await be()).concat(i),u=s.length>o?s.slice(s.length-o):s;return await Kt(u),{total:u.length}}async function la(e){const t=Oe((e==null?void 0:e.limit)??200,1,5e4),o=Oe((e==null?void 0:e.offset)??0,0,1e6);let i=await be();e!=null&&e.kind&&(i=i.filter(u=>u.kind===e.kind)),e!=null&&e.scope&&(i=i.filter(u=>u.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(i=i.filter(u=>u.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(i=i.filter(u=>u.ts<=e.untilTs));const a=i.length;i=i.slice().reverse();const s=i.slice(o,o+t);return{total:a,items:s}}async function ca(e){let o=await be();if(typeof e.beforeTs=="number"&&(o=o.filter(n=>n.ts>=e.beforeTs)),typeof e.keepLast=="number"){const n=Oe(e.keepLast,0,5e4);n===0?o=[]:o.length>n&&(o=o.slice(o.length-n))}return await Kt(o),{total:o.length}}async function ua(){await et(Ae)}async function da(e){const t=await be();return JSON.stringify(t,null,2)}const yt="0.1.1";async function ga(e){const t=new URL(e.opencvJsRel,document.baseURI).toString(),o=new URL(e.opencvWasmRel,document.baseURI).toString(),n=globalThis;n.Module=n.Module||{},n.Module.locateFile=i=>i.endsWith(".wasm")?o:i,n.Module.print=()=>{},n.Module.printErr=()=>{},n.cv||await pa(t),await fa(e.timeoutMs)}function pa(e){return new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0;const i=15e3,a=window.setTimeout(()=>{s(),o(new Error(`OpenCV script load timeout after ${i}ms: ${e}`))},i);function s(){window.clearTimeout(a),n.onload=null,n.onerror=null}n.onload=()=>{s(),t()},n.onerror=()=>{s(),o(new Error(`Failed to load OpenCV script: ${e}`))},document.head.appendChild(n)})}async function fa(e){var n;const t=Date.now(),o=globalThis;for(;Date.now()-t<e;){try{if(o.cv&&typeof o.cv.Mat=="function"){const i=new o.cv.Mat;(n=i.delete)==null||n.call(i);return}}catch{}await new Promise(i=>setTimeout(i,75))}throw new Error(`OpenCV initialization timeout after ${e}ms`)}async function ha(){try{await ga({opencvJsRel:"../assets/opencv/opencv.js",opencvWasmRel:"../assets/opencv/opencv.wasm",timeoutMs:2e4}),lo("opencv")}catch(e){throw co("opencv",e!=null&&e.message?String(e.message):String(e)),e}}function j(e,t,o){const n=document.createElement(e);if(t)for(const[i,a]of Object.entries(t))n.setAttribute(i,a);return typeof o=="string"&&(n.textContent=o),n}function bt(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function ma(e){return e.fallbackReason?`${e.effectiveEngine} (fallback)`:e.effectiveEngine}function va(e){const t=[{value:"native",label:"Native"},{value:"auto",label:"Auto"},...e.canImplementOpenCv?[{value:"opencv",label:"OpenCV"}]:[]];return e.isRoot?t:[{value:"inherit",label:"Inherit"},...t]}function ya(e){return!1}function ba(e,t,o){var i;const n=(i=e.storedParams)==null?void 0:i[t];return typeof n<"u"&&n!==o}function wa(e){var p;const{node:t,compId:o,key:n,schema:i,value:a,handlers:s}=e,u=j("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),g=j("label",{class:"fieldInline"}),r=j("span",void 0,i.label);g.appendChild(r);let c;if(i.kind==="number"?(c=j("input"),c.type="number",typeof i.min=="number"&&(c.min=String(i.min)),typeof i.max=="number"&&(c.max=String(i.max)),typeof i.step=="number"&&(c.step=String(i.step)),c.value=String(a??i.default),c.addEventListener("change",()=>{const v=Number(c.value);s.onSetParam(o,n,Number.isFinite(v)?v:i.default)})):i.kind==="boolean"?(c=j("input"),c.type="checkbox",c.checked=!!a,c.addEventListener("change",()=>{s.onSetParam(o,n,!!c.checked)})):(c=j("input"),c.type="text",c.value=String(a??i.default),c.addEventListener("change",()=>{s.onSetParam(o,n,String(c.value??i.default))})),g.appendChild(c),u.appendChild(g),s.onResetParam&&typeof((p=t.storedParams)==null?void 0:p[n])<"u"){const v=j("button",{type:"button"},"Reset");v.addEventListener("click",d=>{var l;d.preventDefault(),(l=s.onResetParam)==null||l.call(s,o,n)}),u.appendChild(v)}return ba(t,n,a)&&u.appendChild(j("span",{class:"muted",style:"font-size:12px;"},"override")),u}function Gt(e){const{node:t,depth:o,isRoot:n,handlers:i,treeScopeId:a}=e,s=j("div",{style:`margin-left:${Math.min(o*14,56)}px; margin-top:10px;`}),u=j("div",{style:"border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:10px; background:rgba(0,0,0,0.12);"}),g=j("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),r=j("div");r.appendChild(j("div",{style:"font-weight:700;"},t.title)),t.description&&r.appendChild(j("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},t.description)),t.isGroup&&r.appendChild(j("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},"Group (policy affects children)")),g.appendChild(r);const c=j("div",{class:"row",style:"align-items:center; gap:10px;"});c.appendChild(j("span",{class:"qBadge"},ma(t)));const p=j("select");p.style.background="rgba(255,255,255,0.05)",p.style.border="1px solid rgba(255,255,255,0.08)",p.style.color="rgba(255,255,255,0.92)",p.style.borderRadius="10px",p.style.padding="6px 8px";const v=va({isRoot:n,canImplementOpenCv:t.canImplementOpenCv});for(const C of v){const w=j("option");w.value=C.value,w.textContent=C.label,p.appendChild(w)}const d=new Set(v.map(C=>C.value)),l=t.effectivePolicy;d.has(l)?p.value=l:p.value=n?"native":"inherit",p.addEventListener("change",()=>{i.onSetPolicy(t.id,p.value)}),c.appendChild(p);const f=typeof t.storedPolicy<"u"||t.storedParams&&Object.keys(t.storedParams).length>0;if(i.onResetNode&&f){const C=j("button",{type:"button"},"Reset node");C.addEventListener("click",w=>{var E;w.preventDefault(),(E=i.onResetNode)==null||E.call(i,t.id)}),c.appendChild(C)}g.appendChild(c),u.appendChild(g),t.fallbackReason?u.appendChild(j("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},t.fallbackReason)):t.effectivePolicy==="opencv"&&!t.runtimeOpenCvReady&&u.appendChild(j("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},"OpenCV policy selected, but OpenCV is not available at runtime. It will fall back to native."));const y=Object.keys(t.paramsSchema??{}),h=y.length>0,b=t.children.length>0;if(h||b){const C=j("details",{style:"margin-top:10px;"});C.open=ya();const w=j("summary",{style:"cursor:pointer; user-select:none;"},"Details");if(C.appendChild(w),h){const E=j("div",{style:"margin-top:10px;"});E.appendChild(j("div",{class:"muted",style:"font-weight:600; margin-bottom:6px;"},"Parameters"));for(const I of y){const R=t.paramsSchema[I],k=t.effectiveParams[I];E.appendChild(wa({node:t,compId:t.id,key:I,schema:R,value:k,handlers:i}))}C.appendChild(E)}if(b){const E=j("div",{style:"margin-top:10px;"});for(const I of t.children)E.appendChild(Gt({node:I,depth:o+1,isRoot:!1,handlers:i,treeScopeId:a}));C.appendChild(E)}u.appendChild(C)}return s.appendChild(u),s}function qt(e,t){let o=!1;function n(a){if(o)return;bt(e);const s=a.scopeId==="app",u=j("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"});u.appendChild(j("div",{style:"font-weight:700;"},"Tuning")),u.appendChild(j("div",{class:"muted",style:"font-size:12px;"},`OpenCV runtime: ${a.runtime.opencvReady?"ready":"not available"}`)),e.appendChild(u),e.appendChild(Gt({node:a.root,depth:0,isRoot:s,handlers:t,treeScopeId:a.scopeId}))}function i(){o=!0,bt(e)}return{render:n,dispose:i}}function Ea(){let e=!1,t={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},o=!1,n="",i="";function a(r){e=r}function s(r){t={...t,...r}}function u(r){o=r}function g(r){typeof r.general=="string"&&(n=r.general),typeof r.dev=="string"&&(i=r.dev)}return{get showDevTools(){return e},get dev(){return t},get debugEnabled(){return o},get generalStatus(){return n},get devStatus(){return i},setShowDevTools:a,setDev:s,setDebugEnabled:u,setStatus:g}}function Ca(e){function t(r){e.settingsGeneralStatusEl.textContent=r||""}function o(r){e.cfgStatusEl.textContent=r||""}function n(r){e.cfgShowDevToolsEl.checked=r}function i(r){e.tabLogs.hidden=!r,e.devConfigDetailsEl.classList.toggle("is-hidden",!r),r||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function a(r){e.cfgTraceConsoleEl.checked=!!r.traceConsole,e.cfgActionLogMaxEl.value=String(r.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(r.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(r.failureLogsPerRun??50)}function s(r){e.logsCbDebugEl.checked=r}function u(r,c){e.settingsVersionEl.textContent=r||"—",e.settingsGitHubLinkEl.href=c||"#",e.settingsGitHubLinkEl.hidden=!c}function g(r){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=r,e.cfgActionLogMaxEl.disabled=r,e.cfgDebugTraceMaxEl.disabled=r,e.cfgFailureLogsPerRunEl.disabled=r,e.btnCfgResetDefaults.disabled=r,e.logsCbDebugEl.disabled=r,e.cfgUseOpenCvEl.disabled=r}return{setGeneralStatus:t,setDevStatus:o,setShowDevToolsChecked:n,setDevToolsVisible:i,setDevConfig:a,setDebugEnabledChecked:s,setAbout:u,setBusy:g}}const _e="template.settings.showDevTools",Ke="beecontour.settings.engine.useOpenCv";function xa(){var e,t;try{const o=(e=globalThis==null?void 0:globalThis.chrome)==null?void 0:e.runtime,n=(t=o==null?void 0:o.getManifest)==null?void 0:t.call(o),i=typeof(n==null?void 0:n.version)=="string"?n.version:"";if(F("Settings: getManifestVersion manifest found version is ",{v:i}),i)return i}catch{}return F("Settings: getManifestVersion fallback",{APP_VERSION:yt}),yt}function Ge(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??X.actionLogMax),debugTraceMax:Number(e.debugTraceMax??X.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??X.failureLogsPerRun)}}function ka(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:ie(e.cfgActionLogMaxEl.value,100,5e4,X.actionLogMax),debugTraceMax:ie(e.cfgDebugTraceMaxEl.value,100,5e4,X.debugTraceMax),failureLogsPerRun:ie(e.cfgFailureLogsPerRunEl.value,0,5e4,X.failureLogsPerRun)}}async function wt(e){const t=Bt;return typeof t.setEnabled=="function"?(await t.setEnabled(e),{ok:!0}):typeof t.enable=="function"&&typeof t.disable=="function"?(await(e?t.enable():t.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function Ia(e,t){const o=Ea(),n=Ca(e),i=at({getRuntimeAvailability:()=>({opencvReady:e.cfgUseOpenCvEl.checked&&se()})}),a=qt(e.tuningMountEl,{onSetPolicy:async(m,x)=>{await i.setEnginePolicy(m,x),await b("policy change")},onSetParam:async(m,x,T)=>{await i.setParam(m,x,T),await b("param change")},onResetNode:async m=>{await i.resetNode(m),await b("reset node")},onResetParam:async(m,x)=>{await i.resetParam(m,x),await b("reset param")}});function s(m){e.settingsEngineBoxEl.classList.toggle("is-hidden",!1)}async function u(){const m=await de([Ke]).catch(()=>({}));return(m==null?void 0:m[Ke])===!0}async function g(m){await ge({[Ke]:!!m}).catch(()=>null)}function r(m){var x;e.cfgUseOpenCvEl.checked=m,(x=e.cfgUseOpenCvEl.closest(".switch"))==null||x.classList.toggle("is-disabled",e.cfgUseOpenCvEl.disabled)}function c(m){e.cfgOpenCvSpinner.classList.toggle("is-hidden",!m),e.cfgOpenCvSpinner.setAttribute("aria-hidden",m?"false":"true")}function p(m){e.cfgOpenCvStatus.textContent=m||""}function v(m){e.cfgOpenCvReport.textContent=m||""}async function d(){if(Y())return;if(!!!e.cfgUseOpenCvEl.checked){await g(!1),c(!1),p(se()?"OpenCV loaded (native mode)":"Native mode"),v("Native mode. OpenCV is optional and demo-only."),await b("opencv mode disabled");return}c(!0),p("Loading OpenCV…"),v("Loading OpenCV…");try{if(await pe(e,async()=>{await ha()}),!se())throw new Error("OpenCV load returned but runtime is not injected.");await g(!0),p("OpenCV mode enabled"),v("OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV."),await b("opencv mode enabled")}catch(x){const T=String((x==null?void 0:x.message)??x);await g(!1),r(!1),p("OpenCV load failed"),v(`ERROR

${T}`),H("[settings] OpenCV toggle failed",{msg:T})}finally{c(!1)}}async function l(){const m=await de([_e]).catch(()=>({}));return(m==null?void 0:m[_e])===!0}async function f(m){await ge({[_e]:!!m}).catch(()=>null)}function y(m){o.setShowDevTools(m),n.setShowDevToolsChecked(m),n.setDevToolsVisible(m)}async function h(){const m=await l();y(m),F("Settings: boot applyDevToolsVisibility",{showDevTools:m})}async function b(m){try{const x=await i.loadTree("app");a.render(x),F("[settings] tuning rendered",{reason:m,opencvInjected:se(),opencvMode:!!e.cfgUseOpenCvEl.checked})}catch(x){H("[settings] tuning render failed",{reason:m,msg:String((x==null?void 0:x.message)??x)}),e.tuningMountEl.textContent="Tuning UI failed to load (see console)."}}async function C(){var $;n.setBusy(Y());const m=await l();y(m),await He().catch(()=>null);const x=De();o.setDev(Ge(x)),n.setDevConfig(o.dev);const T=Bt;let P=!1;try{typeof T.isEnabled=="function"?P=!!await T.isEnabled():P=!!T.enabled}catch(O){ee("Settings: failed to read debug enabled state",{error:O instanceof Error?O.message:String(O)})}o.setDebugEnabled(P),n.setDebugEnabledChecked(P),n.setAbout(xa()||"—",(($=e.settingsGitHubLinkEl)==null?void 0:$.href)||"#"),s();{const O=await u();r(O),c(!1);const N=se();O?(p(N?"OpenCV mode enabled":"OpenCV mode (not loaded)"),v(N?"OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV.":"OpenCV mode is enabled, but OpenCV is not loaded yet. Toggle OFF then ON to load OpenCV.")):(p(N?"OpenCV loaded (native mode)":"Native mode"),v("Native mode. OpenCV is optional and demo-only."))}n.setGeneralStatus(""),n.setDevStatus(""),await b("loadAll"),F("Settings: loaded",{showDevTools:m,debugTraceEnabled:P,dev:o.dev,opencvInjected:se()})}async function w(){const m=!!e.cfgShowDevToolsEl.checked;y(m),await f(m),q({kind:"run",scope:"settings",message:m?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:m}}),F("Settings: ui toggle showDevTools",{showDevTools:m}),n.setGeneralStatus(m?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>n.setGeneralStatus(""),1200)}async function E(){const m=ka(e);n.setDevStatus("Saving…");try{await Pt(m)}catch(x){H("Settings: failed to save dev config",{error:x instanceof Error?x.message:String(x),next:m}),n.setDevStatus("Save failed."),setTimeout(()=>n.setDevStatus(""),1200);return}o.setDev(Ge(m)),n.setDevConfig(o.dev),q({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:m}),F("Settings: devConfig updated",m),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}async function I(){n.setDevStatus("Resetting…");try{await qn(),await He().catch(()=>null);const x=De();o.setDev(Ge(x)),n.setDevConfig(o.dev)}catch(x){H("Settings: failed to reset dev config defaults",{error:x instanceof Error?x.message:String(x)}),n.setDevStatus("Reset failed."),setTimeout(()=>n.setDevStatus(""),1200);return}const m=await wt(!1);m.ok?(o.setDebugEnabled(!1),n.setDebugEnabledChecked(!1)):(ee("Settings: failed to reset debug enabled state",{error:m.error||"unknown error"}),q({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:m.error||"unknown error"})),q({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...X,debugEnabled:!1}}),F("Settings: reset defaults",{...X,debugEnabled:!1}),n.setDevStatus("Reset."),setTimeout(()=>n.setDevStatus(""),1200)}async function R(){const m=!!e.logsCbDebugEl.checked;n.setDevStatus("Saving…");const x=await wt(m);if(!x.ok){e.logsCbDebugEl.checked=!m,n.setDevStatus(`Save failed: ${x.error||"unknown error"}`),H("Settings: failed to change debug enabled state",{error:x.error||"unknown error",enabled:m}),q({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:x.error||"unknown error",meta:{enabled:m}});return}o.setDebugEnabled(m),q({kind:"run",scope:"settings",message:m?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:m}}),F("Settings: debug enabled changed",{enabled:m}),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}const k=t.on(()=>{});function M(){e.cfgShowDevToolsEl.addEventListener("change",()=>{w()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{Y()||E()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{Y()||E()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{Y()||E()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{Y()||E()}),e.btnCfgResetDefaults.addEventListener("click",()=>{Y()||I()}),e.logsCbDebugEl.addEventListener("change",()=>{Y()||R()}),e.cfgUseOpenCvEl.addEventListener("change",()=>{d()}),h().catch(m=>{ee("Settings: initDevToolsVisibility failed",{error:m instanceof Error?m.message:String(m)})})}return{id:"settings",refresh(){C().catch(m=>{H("Settings: refresh failed",{error:m instanceof Error?m.message:String(m)})})},mount(){C().catch(m=>{H("Settings: mount failed",{error:m instanceof Error?m.message:String(m)})})},unmount(){},bind:M,dispose(){k()}}}function Sa(){let e=[],t=0;function o(n){e=n.items,t=n.total}return{get items(){return e},get total(){return t},set:o}}function Ma(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function Et(e,t){const o=[];o.push(`Total entries: ${t.total}`),o.push("");for(const n of t.items){const i=typeof n.ok=="boolean"?n.ok?"ok":"fail":"",a=[];typeof n.status=="number"&&a.push(`status=${n.status}`),i&&a.push(i);const s=[n.scope,n.kind].filter(Boolean).join("/");o.push(`[${Ma(n.ts)}] ${s}${a.length?` (${a.join(", ")})`:""}`),o.push(`  ${n.message}`),n.error&&o.push(`  error: ${n.error}`),o.push("")}e.textContent=o.join(`
`),e.scrollTop=0}function Ra(e){function t(s){e.logsStatusEl.textContent=s}function o(s){e.debugStatusEl.textContent=s}function n(s){e.logsCbDebugEl.checked=s}function i(s){Et(e.logsOutEl,{total:s.total,items:s.items.map(u=>({ts:u.ts,message:u.message,scope:u.scope,kind:u.kind,ok:u.ok,status:u.status,error:u.error,meta:u.meta}))})}function a(s){Et(e.debugOutEl,{total:s.total,items:s.items.map(u=>({ts:u.ts,message:u.message,scope:u.scope,kind:u.kind,ok:u.ok,status:u.status,error:u.error,meta:u.meta}))})}return{setAuditStatus:t,setDebugStatus:o,setDebugChecked:n,renderAudit:i,renderDebug:a}}const Ct="beecontour";function Da(e,t){const o=Sa(),n=Ra(e);async function i(){n.setAuditStatus("Loading…"),ne(e,!0);try{const l=ie(e.logsLimitEl.value,10,5e3,200),f=await la({limit:l,reverse:!0});o.set(f),n.renderAudit({items:o.items,total:o.total}),n.setAuditStatus(`Showing ${o.items.length} (newest first)`)}catch(l){n.setAuditStatus(`Failed: ${(l==null?void 0:l.message)||String(l)}`)}finally{ne(e,!1)}}async function a(){n.setDebugStatus("Loading…"),ne(e,!0);try{const l=ie(e.debugLimitEl.value,10,5e3,200),f=await Lt({limit:l,reverse:!0});n.renderDebug(f),n.setDebugStatus(`Showing ${f.items.length} (newest first)`)}catch(l){n.setDebugStatus(`Failed: ${(l==null?void 0:l.message)||String(l)}`)}finally{ne(e,!1)}}async function s(){const l=await tt();n.setDebugChecked(l)}async function u(l){if(await At(l),n.setDebugChecked(l),!l){n.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}n.setDebugStatus("Debug ON."),await a()}async function g(){const l=ie(e.logsTrimKeepEl.value,0,5e4,2e3);n.setAuditStatus("Trimming…"),ne(e,!0);try{const f=await ca({keepLast:l});await i(),n.setAuditStatus(`Trimmed. Remaining: ${f.total}`)}catch(f){n.setAuditStatus(`Trim failed: ${(f==null?void 0:f.message)||String(f)}`)}finally{ne(e,!1)}}async function r(){n.setAuditStatus("Clearing…"),ne(e,!0);try{await ua(),await i(),n.setAuditStatus("Cleared.")}catch(l){n.setAuditStatus(`Clear failed: ${(l==null?void 0:l.message)||String(l)}`)}finally{ne(e,!1)}}async function c(){n.setAuditStatus("Exporting…");try{const l=await da({pretty:!0}),f=new Blob([l],{type:"application/json"}),y=URL.createObjectURL(f),h=document.createElement("a");h.href=y,h.download=`${Ct}-audit-${Date.now()}.json`,h.click(),setTimeout(()=>URL.revokeObjectURL(y),1e3),n.setAuditStatus("Exported.")}catch(l){n.setAuditStatus(`Export failed: ${(l==null?void 0:l.message)||String(l)}`)}}async function p(){n.setDebugStatus("Clearing…"),ne(e,!0);try{await Ot(),await a(),n.setDebugStatus("Cleared.")}catch(l){n.setDebugStatus(`Clear failed: ${(l==null?void 0:l.message)||String(l)}`)}finally{ne(e,!1)}}async function v(){n.setDebugStatus("Exporting…");try{const l=await $t({pretty:!0}),f=new Blob([l],{type:"application/json"}),y=URL.createObjectURL(f),h=document.createElement("a");h.href=y,h.download=`${Ct}-debug-${Date.now()}.json`,h.click(),setTimeout(()=>URL.revokeObjectURL(y),1e3),n.setDebugStatus("Exported.")}catch(l){n.setDebugStatus(`Export failed: ${(l==null?void 0:l.message)||String(l)}`)}}function d(){e.btnLogsRefresh.addEventListener("click",()=>{Y()||i()}),e.btnLogsTrim.addEventListener("click",()=>{Y()||g()}),e.btnLogsClear.addEventListener("click",()=>{Y()||r()}),e.btnLogsExport.addEventListener("click",()=>{Y()||c()}),e.logsCbDebugEl.addEventListener("change",()=>{Y()||u(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{Y()||a()}),e.btnDebugClear.addEventListener("click",()=>{Y()||p()}),e.btnDebugExport.addEventListener("click",()=>{Y()||v()})}return{id:"logs",bind:d,mount(){s(),i(),a()},unmount(){},dispose(){}}}function Pa(e,t){if(e.id===t)return e;const o=[...e.children??[]];for(;o.length>0;){const n=o.shift();if(n.id===t)return n;for(const i of n.children??[])o.push(i)}throw new Error(`[tuning] scopeRootId not found in VM tree: ${t}`)}function Ta(e,t){if(e.id===t)return e;const o=[...e.children??[]];for(;o.length>0;){const n=o.shift();if(n.id===t)return n;for(const i of n.children??[])o.push(i)}return null}function Aa(e){const t=at({getRuntimeAvailability:e.getRuntimeAvailability}),o=[];let n=!1;async function i(){return await t.loadTree("app")}async function a(){if(n)return;const h=await i();for(const b of o){if(b.scopeRootId==="app"){b.view.render(h);continue}const C=Pa(h.root,b.scopeRootId);b.view.render({...h,scopeId:b.scopeRootId,root:C})}}async function s(h,b){await t.setEnginePolicy(h,b),e.actionLogAppend(`[tuning] policy ${h} = ${b}`),e.debugTraceAppend(`[tuning] setPolicy id=${h} policy=${b}`),await a()}async function u(h,b,C){await t.setParam(h,b,C),e.actionLogAppend(`[tuning] param ${h}.${b} = ${String(C)}`),e.debugTraceAppend(`[tuning] setParam id=${h} key=${b} value=${String(C)}`),await a()}async function g(h){await t.resetNode(h),e.actionLogAppend(`[tuning] reset node ${h}`),e.debugTraceAppend(`[tuning] resetNode id=${h}`),await a()}async function r(h,b){await t.resetParam(h,b),e.actionLogAppend(`[tuning] reset param ${h}.${b}`),e.debugTraceAppend(`[tuning] resetParam id=${h} key=${b}`),await a()}async function c(h){var b,C;if(!n){if(h.policies)for(const w of h.policies)await t.setEnginePolicy(w.id,w.policy);if(h.params)for(const w of h.params)await t.setParam(w.id,w.key,w.value);e.actionLogAppend(`[tuning] preset ${h.id} (${h.title})`),e.debugTraceAppend(`[tuning] applyPreset id=${h.id} title=${h.title} policies=${((b=h.policies)==null?void 0:b.length)??0} params=${((C=h.params)==null?void 0:C.length)??0}`),await a()}}async function p(h){const b=await i(),C=Ta(b.root,h);if(!C)throw new Error(`[tuning] getEffectiveParams: unknown component id ${h}`);return{...C.effectiveParams??{}}}async function v(h,b,C){await t.setParam(h,b,C),e.actionLogAppend(`[tuning] param ${h}.${b} = ${String(C)}`),e.debugTraceAppend(`[tuning] setParamValue id=${h} key=${b} value=${String(C)}`),await a()}function d(h){if(n)return;const{mountEl:b,scopeRootId:C}=h;if(o.some(E=>E.mountEl===b))return;const w=qt(b,{onSetPolicy:s,onSetParam:u,onResetNode:g,onResetParam:r});o.push({mountEl:b,scopeRootId:C,view:w}),a()}function l(h){const b=o.findIndex(C=>C.mountEl===h);b<0||(o[b].view.dispose(),o.splice(b,1))}async function f(){await a()}function y(){n=!0;for(const h of o)h.view.dispose();o.length=0}return{mount:d,unmount:l,refresh:f,applyPreset:c,getEffectiveParams:p,setParamValue:v,dispose:y}}function V(e,t,o){const n=document.createElement(e);if(t)for(const[i,a]of Object.entries(t))n.setAttribute(i,a);return typeof o=="string"&&(n.textContent=o),n}function Oa(e){return e.type==="image"}function La(e){return e.type==="mask"}function $a(e){return e.type==="svg"}function Wt(e){return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(e)}`}function xt(e,t){if(Oa(e)){const n=V("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return Me(n,e.image),n}if(La(e)){const n=V("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return Ze(n,e.mask,e.width,e.height),n}if(!$a(e))return V("div",{class:"muted",style:"margin-top:8px; font-size:12px;"},`Unsupported output: ${String(e.type)}`);const o=V("img",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`,"aria-label":"SVG preview"});return o.src=Wt(e.svg),o}function Ht(e,t){const o=URL.createObjectURL(t),n=document.createElement("a");n.href=o,n.download=e,n.rel="noopener",n.click(),setTimeout(()=>URL.revokeObjectURL(o),500)}async function kt(e,t){const o=await new Promise(n=>t.toBlob(i=>n(i),"image/png"));if(!o)throw new Error("Failed to create PNG blob.");Ht(e,o)}function Me(e,t){e.width=t.width,e.height=t.height;const o=e.getContext("2d",{willReadFrequently:!0});o&&o.putImageData(t,0,0)}function Ze(e,t,o,n){e.width=o,e.height=n;const i=e.getContext("2d",{willReadFrequently:!0});if(!i)return;let a=0;const s=o*n;for(let c=0;c<s;c++){const p=t[c]??0;p>a&&(a=p)}const u=a<=1,g=i.createImageData(o,n),r=g.data;for(let c=0;c<s;c++){const p=t[c]??0;let v;u?v=(p>0?1:0)?0:255:v=p;const d=c*4;r[d]=v,r[d+1]=v,r[d+2]=v,r[d+3]=255}i.putImageData(g,0,0)}function Ba(e){const{hostEl:t,statusEl:o,handlers:n}=e;let i=!1,a=null,s=null,u=null,g=null,r=null,c=null,p=null,v=null,d=null,l=null,f=null,y=null,h=null;function b(){for(;t.firstChild;)t.removeChild(t.firstChild)}async function C(m){var D,S,A,z,G;const T=(typeof(m==null?void 0:m.activePipelineId)=="string"?m.activePipelineId:"pipeline").replace(/[^a-z0-9_-]+/gi,"_").slice(0,40)||"pipeline",P=(D=m==null?void 0:m.outputSvg)==null?void 0:D.svg;if(typeof P=="string"&&P.length>0){const L=new Blob([P],{type:"image/svg+xml;charset=utf-8"});Ht(`beecontour-${T}.svg`,L);return}const $=(S=m==null?void 0:m.outputImage)==null?void 0:S.data;if($){const L=document.createElement("canvas");Me(L,$),await kt(`beecontour-${T}.png`,L);return}const O=(A=m==null?void 0:m.outputMask)==null?void 0:A.data,N=(z=m==null?void 0:m.outputMask)==null?void 0:z.width,U=(G=m==null?void 0:m.outputMask)==null?void 0:G.height;if(O&&typeof N=="number"&&typeof U=="number"){const L=document.createElement("canvas");Ze(L,O,N,U),await kt(`beecontour-${T}-mask.png`,L);return}throw new Error("No output to download.")}function w(){if(i)return;i=!0,b(),a=V("div",{class:"card"}),v=V("p",{class:"muted",style:"margin-top:0;"},"Universal pipeline runner. Select a pipeline and run it.");const m=V("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),x=V("label",{class:"fieldInline"});x.appendChild(V("span",{},"Pipeline")),s=V("select"),x.appendChild(s);const T=V("label",{class:"fieldInline"});T.appendChild(V("span",{},"Recipe")),u=V("select"),T.appendChild(u),g=V("button",{type:"button"},"Run all"),r=V("button",{type:"button"},"Next step"),c=V("button",{type:"button"},"Reset"),p=V("button",{type:"button"},"Download"),m.appendChild(x),m.appendChild(T),m.appendChild(g),m.appendChild(r),m.appendChild(c),m.appendChild(p);const P=V("div",{class:"grid4",style:"margin-top:12px;"}),$=V("div",{class:"card"});$.appendChild(V("div",{class:"cardTitle"},"Input (from source)")),d=V("canvas",{class:"canvas","aria-label":"Pipeline input preview"}),$.appendChild(d);const O=V("div",{class:"card"});O.appendChild(V("div",{class:"cardTitle"},"Current output")),l=V("canvas",{class:"canvas","aria-label":"Pipeline current output preview"}),f=V("img",{class:"canvas","aria-label":"Pipeline SVG output preview",style:"display:none;"}),O.appendChild(l),O.appendChild(f);const N=V("div",{class:"card",style:"grid-column:1 / -1;"});N.appendChild(V("div",{class:"cardTitle"},"Stages")),y=V("div"),N.appendChild(y),P.appendChild($),P.appendChild(O),P.appendChild(N),a.appendChild(v),a.appendChild(m),a.appendChild(P),t.appendChild(a),s.addEventListener("change",()=>{const U=s?s.value:"segmentation";n.onSelectPipeline(U)}),u.addEventListener("change",()=>{const U=u?u.value:"default";n.onSelectRecipe(U)}),g.addEventListener("click",()=>n.onRunAll()),r.addEventListener("click",()=>n.onNext()),c.addEventListener("click",()=>n.onReset()),p.addEventListener("click",async()=>{try{await C(h)}catch(U){const D=U instanceof Error?U.message:String(U);o.textContent=`Download failed: ${D}`}})}function E(m){if(!s||!u)return;const x=Array.isArray(m==null?void 0:m.pipelines)?m.pipelines:[],T=Array.isArray(m==null?void 0:m.recipes)?m.recipes:[],P=typeof(m==null?void 0:m.activePipelineId)=="string"?m.activePipelineId:"segmentation",$=typeof(m==null?void 0:m.activeRecipeId)=="string"?m.activeRecipeId:"default";s.innerHTML="";for(const O of x){const N=V("option");N.value=O.id,N.textContent=O.title,O.id===P&&(N.selected=!0),s.appendChild(N)}u.innerHTML="";for(const O of T){const N=V("option");N.value=O.id,N.textContent=O.title,O.id===$&&(N.selected=!0),u.appendChild(N)}}function I(m){var T;if(!d)return;const x=(T=m==null?void 0:m.input)==null?void 0:T.data;if(!x){d.width=1,d.height=1;const P=d.getContext("2d");P&&P.clearRect(0,0,d.width,d.height);return}Me(d,x)}function R(m){var U,D,S,A,z;if(!l||!f)return;const x=(U=m==null?void 0:m.outputSvg)==null?void 0:U.svg;if(typeof x=="string"&&x.length>0){l.style.display="none",f.style.display="block",f.src=Wt(x);return}l.style.display="block",f.style.display="none",f.src="";const T=(D=m==null?void 0:m.outputImage)==null?void 0:D.data;if(T){Me(l,T);return}const P=(S=m==null?void 0:m.outputMask)==null?void 0:S.data,$=(A=m==null?void 0:m.outputMask)==null?void 0:A.width,O=(z=m==null?void 0:m.outputMask)==null?void 0:z.height;if(P&&typeof $=="number"&&typeof O=="number"){Ze(l,P,$,O);return}l.width=1,l.height=1;const N=l.getContext("2d");N&&N.clearRect(0,0,l.width,l.height)}function k(m){if(!y)return;y.innerHTML="";const x=Array.isArray(m==null?void 0:m.stages)?m.stages:[];if(!x.length){y.appendChild(V("div",{class:"muted",style:"font-size:12px;"},"No stages."));return}const T=V("div",{style:"display:flex; flex-direction:column; gap:10px;"});for(const P of x)T.appendChild(M(P));y.appendChild(T)}function M(m){const x=V("div",{class:"card",style:"padding:10px;"}),T=V("div",{class:"row",style:"align-items:center; justify-content:space-between;"});T.appendChild(V("div",{style:"font-weight:bold;"},String(m.title??m.stageId))),T.appendChild(V("div",{class:"status"},String(m.state??"idle"))),x.appendChild(T),x.appendChild(V("div",{class:"muted",style:"font-size:12px;"},`${m.input} -> ${m.output}`)),typeof m.error=="string"&&m.error.length>0&&x.appendChild(V("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Stage error: ${m.error}`));const P=m.outputArtifact;P&&x.appendChild(xt(P,260));const $=Array.isArray(m.ops)?m.ops:[];if($.length){const O=V("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:8px;"});for(let N=0;N<$.length;N++){const U=$[N],D=N===$.length-1,S=V("div",{class:"card",style:"padding:8px;"}),A=V("div",{class:"row",style:"align-items:center; justify-content:space-between;"});A.appendChild(V("div",{style:"font-weight:bold; font-size:12px;"},String(U.title??U.opId))),A.appendChild(V("div",{class:"status"},String(U.state??"idle"))),S.appendChild(A),S.appendChild(V("div",{class:"muted",style:"font-size:12px;"},`${U.input} -> ${U.output}`)),typeof U.error=="string"&&U.error.length>0&&S.appendChild(V("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Op error: ${U.error}`));const z=P&&D?void 0:U.outputArtifact;z&&S.appendChild(xt(z,200)),O.appendChild(S)}x.appendChild(O)}return x}return{mount(){w()},render(m){var x,T,P;if(w(),h=m,E(m),o.textContent=typeof(m==null?void 0:m.statusText)=="string"?m.statusText:"Idle",v){const $=typeof(m==null?void 0:m.description)=="string"?m.description:"Universal pipeline runner.";v.textContent=$}if(p){const $=typeof((x=m==null?void 0:m.outputSvg)==null?void 0:x.svg)=="string"&&m.outputSvg.svg.length>0,O=!!((T=m==null?void 0:m.outputImage)!=null&&T.data),N=!!((P=m==null?void 0:m.outputMask)!=null&&P.data);p.disabled=!($||O||N)}I(m),R(m),k(m)},dispose(){i=!1,a=null,s=null,u=null,g=null,r=null,c=null,p=null,v=null,d=null,l=null,f=null,y=null,h=null,b()}}}function Na(e,t){return`${e}.${t+1}`}function za(e){return{width:e.width,height:e.height}}function It(e,t){return e.find(o=>o.id===t)??null}function Va(){const e=[{kind:"dispatch",id:"op.seg.resize",title:"Resize",io:{input:"image",output:"image"},dispatchId:"segmentation.resize",tuningId:"segmentation.resize"},{kind:"dispatch",id:"op.seg.denoise",title:"Denoise",io:{input:"image",output:"image"},dispatchId:"segmentation.denoise",tuningId:"segmentation.denoise"},{kind:"dispatch",id:"op.seg.color",title:"Color / Gray",io:{input:"image",output:"image"},dispatchId:"segmentation.color",tuningId:"segmentation.color"},{kind:"dispatch",id:"op.seg.threshold",title:"Threshold",io:{input:"image",output:"mask"},dispatchId:"segmentation.threshold",tuningId:"segmentation.threshold"},{kind:"dispatch",id:"op.seg.morphology",title:"Morphology cleanup",io:{input:"mask",output:"mask"},dispatchId:"segmentation.morphology",tuningId:"segmentation.morphology"},{kind:"dispatch",id:"op.edge.resize",title:"Resize",io:{input:"image",output:"image"},dispatchId:"edge.resize",tuningId:"edge.resize"},{kind:"dispatch",id:"op.edge.threshold",title:"Threshold",io:{input:"image",output:"mask"},dispatchId:"edge.threshold",tuningId:"edge.threshold"},{kind:"dispatch",id:"op.edge.morphology",title:"Morphology cleanup",io:{input:"mask",output:"mask"},dispatchId:"edge.morphology",tuningId:"edge.morphology"},{kind:"dispatch",id:"op.edge.extract",title:"Edge extract",io:{input:"mask",output:"mask"},dispatchId:"edge.extract",tuningId:"edge.extract"},{kind:"dispatch",id:"op.svg.create",title:"Create SVG",io:{input:"mask",output:"svg"},dispatchId:"svg.create",tuningId:"svg.create"},{kind:"js",id:"op.util.pass",title:"Pass-through",io:{input:"image",output:"image"},run:({input:a})=>a}],t=[{id:"segmentation",title:"Segmentation",implemented:!0,description:"Multi-step segmentation pipeline (image -> mask).",stages:[{id:"stage.seg.prep",title:"Prep",io:{input:"image",output:"image"},allowedOps:["op.seg.resize","op.util.pass"],defaultOps:["op.seg.resize"]},{id:"stage.seg.denoise",title:"Denoise",io:{input:"image",output:"image"},allowedOps:["op.seg.denoise","op.util.pass"],defaultOps:["op.seg.denoise"]},{id:"stage.seg.features",title:"Color / channel features",io:{input:"image",output:"image"},allowedOps:["op.seg.color","op.util.pass"],defaultOps:["op.seg.color"]},{id:"stage.seg.binarize",title:"Binarize",io:{input:"image",output:"mask"},allowedOps:["op.seg.threshold"],defaultOps:["op.seg.threshold"]},{id:"stage.seg.cleanup",title:"Mask cleanup",io:{input:"mask",output:"mask"},allowedOps:["op.seg.morphology"],defaultOps:["op.seg.morphology"]}]},{id:"svg",title:"SVG",implemented:!0,description:"Image to SVG outline (resize -> threshold -> morph -> edge -> svg).",stages:[{id:"stage.svg.prep",title:"Prep",io:{input:"image",output:"image"},allowedOps:["op.edge.resize","op.util.pass"],defaultOps:["op.edge.resize"]},{id:"stage.svg.binarize",title:"Binarize",io:{input:"image",output:"mask"},allowedOps:["op.edge.threshold"],defaultOps:["op.edge.threshold"]},{id:"stage.svg.cleanup",title:"Mask cleanup",io:{input:"mask",output:"mask"},allowedOps:["op.edge.morphology"],defaultOps:["op.edge.morphology"]},{id:"stage.svg.edge",title:"Extract edges",io:{input:"mask",output:"mask"},allowedOps:["op.edge.extract"],defaultOps:["op.edge.extract"]},{id:"stage.svg.emit",title:"Create SVG",io:{input:"mask",output:"svg"},allowedOps:["op.svg.create"],defaultOps:["op.svg.create"]}]},{id:"edge",title:"Edge",implemented:!0,description:"Edge extraction pipeline (image -> mask -> edges).",stages:[{id:"stage.edge.prep",title:"Prep",io:{input:"image",output:"image"},allowedOps:["op.edge.resize","op.util.pass"],defaultOps:["op.edge.resize"]},{id:"stage.edge.binarize",title:"Binarize",io:{input:"image",output:"mask"},allowedOps:["op.edge.threshold"],defaultOps:["op.edge.threshold"]},{id:"stage.edge.cleanup",title:"Mask cleanup",io:{input:"mask",output:"mask"},allowedOps:["op.edge.morphology"],defaultOps:["op.edge.morphology"]},{id:"stage.edge.extract",title:"Extract edges",io:{input:"mask",output:"mask"},allowedOps:["op.edge.extract"],defaultOps:["op.edge.extract"]}]},{id:"surface",title:"Surface",implemented:!1,description:"Future: region labeling + vectorize pipeline.",stages:[]}];function o(a){return It(t,a)}function n(a){return It(e,a)}function i(a){const s=o(a);return s?{pipelineId:s.id,stages:s.stages.map(u=>({stageId:u.id,ops:(u.defaultOps??[]).map((g,r)=>({instanceId:Na(u.id,r),opId:g}))}))}:null}return{pipelines:t,ops:e,getPipeline:o,getOp:n,makeDefaultInstalled:i}}function Ua(e){return e.type==="image"}function Fa(e){return e.type==="mask"}function ue(e){return{type:"image",width:e.width,height:e.height,image:e}}function St(e,t,o){return{type:"mask",width:t,height:o,mask:e}}function Mt(e,t,o){return{type:"svg",width:t,height:o,svg:e}}function fe(e,t){return`IO mismatch: expected ${e}, got ${t}`}function ja(e,t){if(t.length===0)return"Stage has no installed ops";if(t[0].io.input!==e.input)return fe(e.input,t[0].io.input);for(let n=0;n<t.length-1;n++){const i=t[n],a=t[n+1];if(i.io.output!==a.io.input)return`Chain IO mismatch between "${i.title}" (${i.io.output}) -> "${a.title}" (${a.io.input})`}const o=t[t.length-1];return o.io.output!==e.output?fe(e.output,o.io.output):null}async function _a(e,t,o){if(e.io.input==="image"){if(!Ua(t))throw new Error(fe("image",t.type));const{width:a,height:s}=t;if(e.io.output==="image"){const u=await Z(e.dispatchId,{image:t.image,width:a,height:s});return ue(u)}if(e.io.output==="mask"){const u=await Z(e.dispatchId,{image:t.image,width:a,height:s});return St(u,a,s)}if(e.io.output==="svg"){const u=await Z(e.dispatchId,{image:t.image,width:a,height:s});return Mt(u,a,s)}throw new Error(`Unsupported dispatch output: ${e.io.output}`)}if(!Fa(t))throw new Error(fe("mask",t.type));const{width:n,height:i}=t;if(e.io.output==="mask"){const a=await Z(e.dispatchId,{mask:t.mask,width:n,height:i});return St(a,n,i)}if(e.io.output==="svg"){const a=await Z(e.dispatchId,{mask:t.mask,width:n,height:i});return Mt(a,n,i)}throw new Error(`Invalid op spec: mask input cannot produce ${e.io.output} (not supported here)`)}async function Ka(e,t,o){if(e.kind==="dispatch")return await _a(e,t);const n=e.tuningId?await o.getEffectiveParams(e.tuningId).catch(()=>({})):{};return await e.run({input:t,params:n})}async function Ga(e){var r;const{catalogue:t,installed:o,inputImage:n,deps:i}=e,a=t.getPipeline(o.pipelineId);if(!a)return{pipelineId:o.pipelineId,title:o.pipelineId,status:"error",error:`Unknown pipelineId: ${o.pipelineId}`,input:ue(n),stages:[]};if(!a.implemented)return{pipelineId:a.id,title:a.title,status:"error",error:"Not implemented yet",input:ue(n),stages:[]};const s=new Map;for(const c of o.stages)s.set(c.stageId,c);const u=[];let g=ue(n);for(const c of a.stages){const p=s.get(c.id),v=(r=p==null?void 0:p.ops)!=null&&r.length?p.ops:(c.defaultOps??[]).map((w,E)=>({instanceId:`${c.id}.${E+1}`,opId:w})),d=[],l=[];let f=null;for(const w of v){const E=t.getOp(w.opId);if(!E){f=`Unknown opId: ${w.opId}`;break}if(!c.allowedOps.includes(E.id)){f=`Op not allowed in this stage: ${E.title} (${E.id})`;break}d.push(E)}if(!f){const w=ja(c.io,d);w&&(f=w)}if(f){const w={stageId:c.id,title:c.title,io:c.io,status:"error",error:f,ops:v.map(E=>({instanceId:E.instanceId,opId:E.opId,title:E.opId,io:{input:c.io.input,output:c.io.output},status:"error",error:f}))};return u.push(w),i.debug("pipeline stage failed (validation)",{pipelineId:a.id,stageId:c.id,error:f}),{pipelineId:a.id,title:a.title,status:"error",error:`Stage "${c.title}" failed: ${f}`,input:ue(n),stages:u}}let y=g,h=!0,b;for(let w=0;w<d.length;w++){const E=v[w],I=d[w];try{if(I.io.input!==y.type)throw new Error(fe(I.io.input,y.type));const R=await Ka(I,y,i);if(R.type!==I.io.output)throw new Error(fe(I.io.output,R.type));l.push({instanceId:E.instanceId,opId:I.id,title:I.title,io:I.io,status:"ok",output:R}),y=R}catch(R){h=!1,b=R instanceof Error?R.message:String(R),l.push({instanceId:E.instanceId,opId:I.id,title:I.title,io:I.io,status:"error",error:b}),i.debug("pipeline op failed",{pipelineId:a.id,stageId:c.id,opId:I.id,error:b,...za(y)});break}}const C={stageId:c.id,title:c.title,io:c.io,status:h?"ok":"error",error:h?void 0:b,ops:l,output:h?y:void 0};if(u.push(C),!h)return{pipelineId:a.id,title:a.title,status:"error",error:`Stage "${c.title}" failed: ${b??"unknown error"}`,input:ue(n),stages:u};g=y}return{pipelineId:a.id,title:a.title,status:"ok",input:ue(n),output:g,stages:u}}function qa(e){var U;const t=Va();let o=((U=t.pipelines[0])==null?void 0:U.id)??"segmentation",n="default",i=null,a=null,s="Idle",u=[],g=0,r=null,c={},p={},v=null,d={},l={},f={},y={};function h(){return t.getPipeline(o)??t.pipelines[0]}function b(D){const S={id:"default",title:"Default",buildInstalled:()=>{const A=t.makeDefaultInstalled(D.id);if(!A)throw new Error(`Cannot build default installed for pipeline: ${D.id}`);return A}};if(D.id==="segmentation"){const A=D.stages.map(L=>L.id);return[S,{id:"fast",title:"Fast (minimal)",buildInstalled:()=>({pipelineId:D.id,stages:A.map(L=>L.endsWith("prep")?{stageId:L,ops:[{instanceId:`${L}.1`,opId:"op.seg.resize"}]}:L.endsWith("binarize")?{stageId:L,ops:[{instanceId:`${L}.1`,opId:"op.seg.threshold"}]}:L.endsWith("cleanup")?{stageId:L,ops:[{instanceId:`${L}.1`,opId:"op.seg.morphology"}]}:{stageId:L,ops:[{instanceId:`${L}.1`,opId:"op.util.pass"}]})})},{id:"strong",title:"Strong cleanup (double morphology)",buildInstalled:()=>({pipelineId:D.id,stages:A.map(L=>{var W;if(L.endsWith("cleanup"))return{stageId:L,ops:[{instanceId:`${L}.1`,opId:"op.seg.morphology"},{instanceId:`${L}.2`,opId:"op.seg.morphology"}]};const _=((W=D.stages.find(B=>B.id===L))==null?void 0:W.defaultOps)??[];return{stageId:L,ops:_.map((B,te)=>({instanceId:`${L}.${te+1}`,opId:B}))}})})}]}return[S]}function C(){const D=h(),S=b(D),A=S.find(z=>z.id===n)??S[0];n=A.id,i=A.buildInstalled(D)}function w(){c={},p={},f={},y={},u=[],g=0,r=null,v=null,d={},l={},s=h().implemented?"Ready":"Not implemented yet"}function E(){C(),w()}function I(D){D!==o&&t.getPipeline(D)&&(o=D,n="default",E())}function R(D){D!==n&&(n=D,E())}function k(D){a=D,w()}function M(){return i||C(),i}function m(D,S){const A=h(),z=A.stages.find(_=>_.id===D);if(!z)return;const G=S.filter(_=>z.allowedOps.includes(_)),L=M().stages.map(_=>_.stageId!==D?_:{stageId:D,ops:G.map((W,B)=>({instanceId:`${D}.${B+1}`,opId:W}))});i={pipelineId:A.id,stages:L},w()}function x(){const D=h(),S=M(),A=new Map(D.stages.map(L=>[L.id,L])),z=new Map(t.ops.map(L=>[L.id,L])),G=[];for(const L of S.stages){const _=A.get(L.stageId);if(_)for(const W of L.ops){const B=z.get(W.opId);B&&(B.kind==="dispatch"?G.push({stageId:L.stageId,stageTitle:_.title,stageInput:_.io.input,stageOutput:_.io.output,instanceId:W.instanceId,opId:B.id,opTitle:B.title,opInput:B.io.input,opOutput:B.io.output,kind:"dispatch",dispatchId:B.dispatchId,tuningId:B.tuningId}):G.push({stageId:L.stageId,stageTitle:_.title,stageInput:_.io.input,stageOutput:_.io.output,instanceId:W.instanceId,opId:B.id,opTitle:B.title,opInput:B.io.input,opOutput:B.io.output,kind:"js",tuningId:B.tuningId,runJs:B.run}))}}u=G}function T(D){if(D.output)return D.output;for(let S=D.stages.length-1;S>=0;S--){const A=D.stages[S];if(A.output)return A.output;for(let z=A.ops.length-1;z>=0;z--){const G=A.ops[z];if(G.output)return G.output}}return null}function P(D){c={},p={},f={},y={},d={},l={};for(const S of D.stages){p[S.stageId]=S.status==="ok"?"ok":"error",S.error&&(y[S.stageId]=S.error),S.output&&(l[S.stageId]=S.output);for(const A of S.ops)c[A.instanceId]=A.status==="ok"?"ok":"error",A.error&&(f[A.instanceId]=A.error),A.output&&(d[A.instanceId]=A.output)}if(v=T(D),D.status==="ok"&&!v){e.runner.debug("pipeline ok but no output artifact",{pipelineId:D.pipelineId,stages:D.stages.length}),s="Done (but no output artifact)";return}s=D.status==="ok"?"Done":D.error??"Error"}async function $(){if(!h().implemented){s="Not implemented yet";return}if(!a){s="No input image";return}s="Running all…",c={},p={},d={},l={},g=0;const S=await Ga({catalogue:t,installed:M(),inputImage:a,deps:e.runner});P(S),x(),g=u.length}async function O(){const D=h();if(!D.implemented){s="Not implemented yet";return}if(!a){s="No input image";return}if(u.length===0&&x(),u.length===0){s="No ops installed";return}if(r||(r={type:"image",width:a.width,height:a.height,image:a},v=null,c={},p={},d={},l={},g=0),g>=u.length){s="Done";return}const S=u[g];try{if(s=`Running: ${S.stageTitle} → ${S.opTitle}`,r.type!==S.opInput)throw new Error(`IO mismatch: expected ${S.opInput}, got ${r.type}`);const A=S.tuningId?await e.runner.getEffectiveParams(S.tuningId).catch(()=>({})):{};let z;if(S.kind==="dispatch"){const G=r.width,L=r.height;if(r.type==="image"){const _=r.image,W=await Z(S.dispatchId,{image:_,width:G,height:L,params:A});if(S.opOutput==="image"){const B=W;z={type:"image",width:B.width,height:B.height,image:B}}else if(S.opOutput==="mask")z={type:"mask",width:G,height:L,mask:W};else if(S.opOutput==="svg")z={type:"svg",width:G,height:L,svg:W};else throw new Error(`Unsupported op output kind: ${S.opOutput}`)}else if(r.type==="mask"){const _=await Z(S.dispatchId,{mask:r.mask,width:G,height:L,params:A});if(S.opOutput==="mask")z={type:"mask",width:G,height:L,mask:_};else if(S.opOutput==="svg")z={type:"svg",width:G,height:L,svg:_};else throw new Error(`IO mismatch: mask input cannot produce ${S.opOutput} (yet)`)}else throw new Error(`Dispatch op cannot run on svg input (opInput=${S.opInput})`)}else{if(!S.runJs)throw new Error("Missing js op implementation");z=await S.runJs({input:r,params:A})}if(z.type!==S.opOutput)throw new Error(`IO mismatch: expected ${S.opOutput}, got ${z.type}`);c[S.instanceId]="ok",p[S.stageId]="ok",d[S.instanceId]=z,l[S.stageId]=z,r=z,v=z,g+=1,s=g>=u.length?"Done":"Ready"}catch(A){const z=A instanceof Error?A.message:String(A);c[S.instanceId]="error",p[S.stageId]="error",y[S.stageId]=z,f[S.instanceId]=z,s=`Error: ${S.opTitle} — ${z}`,e.runner.debug("pipeline next-step failed",{pipelineId:D.id,recipeId:n,stageId:S.stageId,instanceId:S.instanceId,opId:S.opId,error:z})}}function N(){const D=h(),S=b(D),A=t.pipelines.map(B=>({id:B.id,title:B.title})),z=M(),G=new Map(D.stages.map(B=>[B.id,B])),L=new Map(t.ops.map(B=>[B.id,B])),_=z.stages.map(B=>{const te=G.get(B.stageId);if(!te)return null;const we=B.ops.map(ae=>{const le=L.get(ae.opId);return le?{instanceId:ae.instanceId,opId:le.id,title:le.title,input:le.io.input,output:le.io.output,state:c[ae.instanceId]??"idle",error:f[ae.instanceId],outputArtifact:d[ae.instanceId]}:null}).filter(Boolean),$e=p[B.stageId]??(we.some(ae=>ae.state==="error")?"error":"idle");return{stageId:B.stageId,title:te.title,input:te.io.input,output:te.io.output,ops:we,state:$e,error:y[B.stageId],outputArtifact:l[B.stageId]}}).filter(Boolean),W={pipelines:A,recipes:S.map(B=>({id:B.id,title:B.title})),activePipelineId:o,activeRecipeId:n,statusText:s,stages:_,input:a?{width:a.width,height:a.height,data:a}:void 0,nextIndex:g,totalOps:u.length||_.reduce((B,te)=>B+te.ops.length,0)};return(v==null?void 0:v.type)==="image"?W.outputImage={width:v.width,height:v.height,data:v.image}:(v==null?void 0:v.type)==="mask"?W.outputMask={width:v.width,height:v.height,data:v.mask}:(v==null?void 0:v.type)==="svg"&&(W.outputSvg={width:v.width,height:v.height,svg:v.svg}),W}return E(),{getVm:N,setActivePipeline:I,setActiveRecipe:R,setInputImageData:k,getInstalled:M,setStageOps:m,runAll:$,runNext:O,reset:E}}function Wa(e,t,o){const n=qa({runner:{getEffectiveParams:async k=>await o.getEffectiveParams(k).catch(()=>({})),debug:(k,M)=>ve({scope:"panel",kind:"debug",message:k,meta:M})}});let i=null,a=!1,s=null;function u(){e.pipelineTuningMountEl.innerHTML=""}function g(k){return[k,`pipeline.${k}`,"pipeline"]}function r(k){const M=g(k);if(s===M[0])return;u();let m=null,x=null;for(const T of M)try{o.mount({mountEl:e.pipelineTuningMountEl,scopeRootId:T}),m=T;break}catch(P){x=P,u()}if(!m){s=null,q({scope:"panel",kind:"info",message:`Pipeline tuning mount failed for "${k}" (no matching scope).`}),ve({scope:"panel",kind:"error",message:"Pipeline tuning mount failed (no candidate scopeRootId worked)",meta:{pipelineId:k,candidates:M,error:x instanceof Error?x.message:String(x)}});return}s=m,q({scope:"panel",kind:"info",message:`Pipeline tuning mount: pipelineId=${k}, scopeRootId=${m}`})}function c(){const k=n.getVm(),M=typeof k.activePipelineId=="string"?k.activePipelineId:"segmentation";r(M)}function p(){const k=e.srcCanvasEl,M=k.width,m=k.height;if(!M||!m)return null;const x=k.getContext("2d",{willReadFrequently:!0});return x?x.getImageData(0,0,M,m):null}function v(){if(n.getVm().input)return;const M=p();M&&n.setInputImageData(M)}function d(){const k=p();k&&n.setInputImageData(k)}async function l(){const k=await o.getEffectiveParams("pipeline").catch(()=>({})),M=k==null?void 0:k.mode,m=k==null?void 0:k.recipe,x=typeof M=="string"?M:"segmentation",T=typeof m=="string"?m:"default";n.setActivePipeline(x),n.setActiveRecipe(T),c()}function f(){return i||(q({scope:"panel",kind:"info",message:"Pipeline view: create + mount"}),i=Ba({hostEl:e.pipelineViewMountEl,statusEl:e.pipelineStatusEl,handlers:{onSelectPipeline:k=>{q({scope:"panel",kind:"info",message:`Pipeline select: ${k}`}),n.setActivePipeline(k),o.setParamValue("pipeline","mode",k),c(),y()},onSelectRecipe:k=>{q({scope:"panel",kind:"info",message:`Recipe select: ${k}`}),n.setActiveRecipe(k),o.setParamValue("pipeline","recipe",k),y()},onRunAll:()=>void h(),onNext:()=>void b(),onReset:()=>{n.reset();const k=p();k&&n.setInputImageData(k),q({scope:"panel",kind:"info",message:"Pipeline reset (reseed from source)"}),c(),y()}}}),i.mount(),c(),i)}function y(){f().render(n.getVm())}async function h(){q({scope:"panel",kind:"info",message:"Pipeline run: all"}),d();try{await n.runAll()}finally{y()}}async function b(){q({scope:"panel",kind:"info",message:"Pipeline run: next"}),v();try{await n.runNext()}finally{y()}}function C(){}async function w(){a=!0,q({scope:"panel",kind:"info",message:"Pipeline tab: mount()"}),d(),await l(),q({scope:"panel",kind:"info",message:"Pipeline tab: render()"}),y()}async function E(){a&&(q({scope:"panel",kind:"info",message:"Pipeline tab: refresh()"}),d(),await l(),y())}function I(){a=!1,q({scope:"panel",kind:"info",message:"Pipeline tab: unmount()"})}function R(){q({scope:"panel",kind:"info",message:"Pipeline tab: dispose()"}),i==null||i.dispose(),i=null,s=null,u()}return{bind:C,mount:w,unmount:I,refresh:E,dispose:R}}async function Ha(){const e=Un();await He().catch(()=>null);const t=_n();t.start();const o=Hn();globalThis.__APP__={...globalThis.__APP__,cache:o};const n=Aa({getRuntimeAvailability:()=>({opencvReady:!1}),debugTraceAppend:p=>ve({scope:"panel",kind:"debug",message:p}),actionLogAppend:p=>q({scope:"panel",kind:"info",message:p})});n.mount({mountEl:e.tuningMountEl,scopeRootId:"app"}),n.mount({mountEl:e.contourTuningMountEl,scopeRootId:"contour"}),n.mount({mountEl:e.segTuningMountEl,scopeRootId:"segmentation"});const i=jo(e),a=aa(e),s=Ho(e,t,n),u=Wa(e,t,n),g=Ia(e,t),r=Da(e);i.bind(),s.bind(),u.bind(),a.bind(),g.bind(),r.bind();const c=Wn(e,{contour:i,segmentation:s,pipeline:u,colors:a,settings:g,logs:r});c.bind(),c.boot()}Ha();
