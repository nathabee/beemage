function Be(){function e(ue,Re){if(!ue)throw new Error(`[dom] Missing #${Re}`);return ue}const n=e(document.getElementById("appRoot"),"appRoot"),s=e(document.getElementById("tabContour"),"tabContour"),t=e(document.getElementById("tabSettings"),"tabSettings"),a=e(document.getElementById("tabLogs"),"tabLogs"),u=e(document.getElementById("viewContour"),"viewContour"),l=e(document.getElementById("viewSettings"),"viewSettings"),i=e(document.getElementById("viewLogs"),"viewLogs"),f=e(document.getElementById("dropZone"),"dropZone"),c=e(document.getElementById("fileInput"),"fileInput"),E=e(document.getElementById("btnProcess"),"btnProcess"),A=e(document.getElementById("btnDownload"),"btnDownload"),R=e(document.getElementById("contourStatus"),"contourStatus"),B=e(document.getElementById("contourSpinner"),"contourSpinner"),r=e(document.getElementById("srcCanvas"),"srcCanvas"),o=e(document.getElementById("outCanvas"),"outCanvas"),g=e(document.getElementById("edgeThreshold"),"edgeThreshold"),d=e(document.getElementById("invertOutput"),"invertOutput"),b=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),S=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),T=e(document.getElementById("devConfigDetails"),"devConfigDetails"),L=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),k=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),x=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),O=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),F=e(document.getElementById("logsCbDebug"),"logsCbDebug"),$=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),U=e(document.getElementById("cfgStatus"),"cfgStatus"),j=e(document.getElementById("settingsVersion"),"settingsVersion"),I=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),C=e(document.getElementById("logsLimit"),"logsLimit"),h=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),v=e(document.getElementById("logsStatus"),"logsStatus"),y=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),w=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),P=e(document.getElementById("btnLogsExport"),"btnLogsExport"),te=e(document.getElementById("btnLogsClear"),"btnLogsClear"),G=e(document.getElementById("logsOut"),"logsOut"),N=e(document.getElementById("debugLimit"),"debugLimit"),W=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),ke=e(document.getElementById("btnDebugExport"),"btnDebugExport"),Ie=e(document.getElementById("btnDebugClear"),"btnDebugClear"),Me=e(document.getElementById("debugStatus"),"debugStatus"),Ae=e(document.getElementById("debugOut"),"debugOut");return{rootEl:n,tabContour:s,tabSettings:t,tabLogs:a,viewContour:u,viewSettings:l,viewLogs:i,dropZoneEl:f,fileInputEl:c,btnProcessEl:E,btnDownloadEl:A,contourStatusEl:R,contourSpinnerEl:B,srcCanvasEl:r,outCanvasEl:o,edgeThresholdEl:g,invertOutputEl:d,cfgShowDevToolsEl:b,settingsGeneralStatusEl:S,devConfigDetailsEl:T,cfgTraceConsoleEl:L,cfgActionLogMaxEl:k,cfgDebugTraceMaxEl:x,cfgFailureLogsPerRunEl:O,logsCbDebugEl:F,btnCfgResetDefaults:$,cfgStatusEl:U,settingsVersionEl:j,settingsGitHubLinkEl:I,logsLimitEl:C,btnLogsRefresh:h,logsStatusEl:v,logsTrimKeepEl:y,btnLogsTrim:w,btnLogsExport:P,btnLogsClear:te,logsOutEl:G,debugLimitEl:N,btnDebugRefresh:W,btnDebugExport:ke,btnDebugClear:Ie,debugStatusEl:Me,debugOutEl:Ae}}const xe=new Set;function $e(e){xe.add(e)}function Pe(){const e=new Set;function n(t){return e.add(t),()=>e.delete(t)}function s(){$e(a=>{for(const u of e)u(a)})}return{on:n,start:s}}function Oe(e,n){let s="contour";function t(i){const f=c=>i===c;e.tabContour.classList.toggle("is-active",f("contour")),e.tabContour.setAttribute("aria-selected",String(f("contour"))),e.viewContour.hidden=!f("contour"),e.tabSettings.classList.toggle("is-active",f("settings")),e.tabSettings.setAttribute("aria-selected",String(f("settings"))),e.viewSettings.hidden=!f("settings"),e.tabLogs.classList.toggle("is-active",f("logs")),e.tabLogs.setAttribute("aria-selected",String(f("logs"))),e.viewLogs.hidden=!f("logs")}function a(i){i!==s&&(n[s].unmount(),s=i,t(s),n[s].mount())}function u(){e.tabContour.addEventListener("click",()=>a("contour")),e.tabSettings.addEventListener("click",()=>a("settings")),e.tabLogs.addEventListener("click",()=>a("logs"))}function l(){t(s),n[s].mount()}return{bind:u,boot:l,switchTo:a}}function ge(e){const n=e.items.length;return{items:e.items,counts:{items:n},meta:e.meta}}function _e(){const e={items:[],meta:{}},n=new Set;function s(){const c=ge(e);for(const E of n)try{E(c)}catch{}}function t(){return ge(e)}function a(c){n.add(c);try{c(t())}catch{}return()=>n.delete(c)}function u(){e.items=[],e.meta={},s()}function l(c){e.meta.scopeUpdatedSince=c,s()}function i(){return String(e.meta.scopeUpdatedSince||"")}function f(c,E){e.items=c.slice(),e.meta.updatedTs=Date.now(),typeof(E==null?void 0:E.limit)=="number"&&(e.meta.limit=E.limit),s()}return{getSnapshot:t,subscribe:a,getScopeUpdatedSince:i,clearAll:u,setScopeUpdatedSince:l,setItems:f}}function Fe(e,n){let s=null,t=!1;function a(o,g){e.btnProcessEl.disabled=o||!t,e.btnDownloadEl.disabled=o||!t,e.fileInputEl.disabled=o,e.contourSpinnerEl.classList.toggle("is-hidden",!o),g&&(e.contourStatusEl.textContent=g)}function u(o){e.contourStatusEl.textContent=o}function l(){const o=e.srcCanvasEl.getContext("2d"),g=e.outCanvasEl.getContext("2d");o.clearRect(0,0,e.srcCanvasEl.width,e.srcCanvasEl.height),g.clearRect(0,0,e.outCanvasEl.width,e.outCanvasEl.height)}async function i(o){if(!o.type.startsWith("image/")){u("Unsupported file type (please drop an image).");return}a(!0,"Loading image…"),s=o.name||"image";const g=URL.createObjectURL(o);try{const d=await new Promise((U,j)=>{const I=new Image;I.onload=()=>U(I),I.onerror=()=>j(new Error("Failed to load image")),I.src=g}),b=e.srcCanvasEl,S=b.getContext("2d");l();const T=b.width,L=b.height,k=Math.min(T/d.width,L/d.height),x=Math.max(1,Math.floor(d.width*k)),O=Math.max(1,Math.floor(d.height*k)),F=Math.floor((T-x)/2),$=Math.floor((L-O)/2);S.drawImage(d,F,$,x,O),t=!0,e.btnProcessEl.disabled=!1,e.btnDownloadEl.disabled=!1,u(`Loaded: ${s}`)}finally{URL.revokeObjectURL(g),a(!1)}}function f(o,g){const d=Number(o.value);return Number.isFinite(d)?d:g}function c(){t&&(a(!0,"Processing…"),setTimeout(()=>{try{const o=e.srcCanvasEl,g=e.outCanvasEl,d=o.getContext("2d"),b=g.getContext("2d"),S=d.getImageData(0,0,o.width,o.height),{data:T,width:L,height:k}=S,x=new Uint8ClampedArray(L*k);for(let h=0,v=0;h<T.length;h+=4,v++){const y=T[h],w=T[h+1],P=T[h+2];x[v]=.299*y+.587*w+.114*P|0}const O=[-1,0,1,-2,0,2,-1,0,1],F=[-1,-2,-1,0,0,0,1,2,1],$=new Uint8ClampedArray(L*k),U=Math.max(1,Math.min(255,f(e.edgeThresholdEl,70))),j=e.invertOutputEl.checked;for(let h=1;h<k-1;h++)for(let v=1;v<L-1;v++){let y=0,w=0,P=0;for(let G=-1;G<=1;G++)for(let N=-1;N<=1;N++){const W=x[(h+G)*L+(v+N)];y+=W*O[P],w+=W*F[P],P++}const te=Math.min(255,Math.sqrt(y*y+w*w)|0);$[h*L+v]=te>=U?255:0}const I=b.createImageData(L,k),C=I.data;for(let h=0,v=0;h<$.length;h++,v+=4){const y=$[h];if(j){const w=y===255;C[v]=w?0:255,C[v+1]=w?0:255,C[v+2]=w?0:255,C[v+3]=255}else C[v]=y,C[v+1]=y,C[v+2]=y,C[v+3]=255}g.width=o.width,g.height=o.height,b.putImageData(I,0,0),u("Done. You can download the PNG.")}finally{a(!1)}},0))}function E(){if(!t)return;const g=`${(s||"beecontour").replace(/\.[a-z0-9]+$/i,"").replace(/[^a-z0-9-_]+/gi,"_")}_contour.png`,d=e.outCanvasEl.toDataURL("image/png"),b=document.createElement("a");b.href=d,b.download=g,document.body.appendChild(b),b.click(),b.remove(),u(`Downloaded: ${g}`)}function A(){const o=e.dropZoneEl;function g(d){o.classList.toggle("is-hover",d)}o.addEventListener("dragover",d=>{d.preventDefault(),g(!0)}),o.addEventListener("dragleave",()=>g(!1)),o.addEventListener("drop",d=>{var S;d.preventDefault(),g(!1);const b=(S=d.dataTransfer)==null?void 0:S.files;!b||b.length===0||i(b[0])}),e.fileInputEl.addEventListener("change",()=>{var b;const d=(b=e.fileInputEl.files)==null?void 0:b[0];d&&(i(d),e.fileInputEl.value="")})}function R(){A(),e.btnProcessEl.addEventListener("click",()=>c()),e.btnDownloadEl.addEventListener("click",()=>E()),t=!1,e.btnProcessEl.disabled=!0,e.btnDownloadEl.disabled=!0,u("No image loaded"),e.contourSpinnerEl.classList.add("is-hidden")}function B(){}function r(){}return{id:"contour",bind:R,mount:B,unmount:r}}const Ue=new Set;function he(e){for(const n of Ue)n(e,"local")}function K(e){const n=localStorage.getItem(e);if(n!==null)try{return JSON.parse(n)}catch{return n}}function je(e,n){localStorage.setItem(e,JSON.stringify(n))}async function Y(e){if(typeof e=="string")return{[e]:K(e)};if(Array.isArray(e)){const s={};for(const t of e)s[t]=K(t);return s}const n={};for(const[s,t]of Object.entries(e))n[s]=localStorage.getItem(s)!==null?K(s):t;return n}async function z(e){const n={};for(const[s,t]of Object.entries(e)){const a=K(s);je(s,t),n[s]={oldValue:a,newValue:t}}he(n)}async function re(e){const n=Array.isArray(e)?e:[e],s={};for(const t of n){const a=K(t);localStorage.removeItem(t),s[t]={oldValue:a,newValue:void 0}}he(s)}const Z="beecontour.actionLog",Ge=5e3;function Ne(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function Ve(e){return Array.isArray(e)?e:[e]}function X(e,n,s){return Math.max(n,Math.min(s,Math.floor(e)))}async function H(){const e=await Y(Z),n=e==null?void 0:e[Z];return Array.isArray(n)?n:[]}async function me(e){await z({[Z]:e})}async function _(e,n){const s=X(Ge,100,5e4),a=Ve(e).map(f=>({...f,id:Ne(),ts:Date.now()}));if(!a.length)return{total:(await H()).length};const l=(await H()).concat(a),i=l.length>s?l.slice(l.length-s):l;return await me(i),{total:i.length}}async function Ke(e){const n=X((e==null?void 0:e.limit)??200,1,5e4),s=X((e==null?void 0:e.offset)??0,0,1e6);let a=await H();e!=null&&e.kind&&(a=a.filter(i=>i.kind===e.kind)),e!=null&&e.scope&&(a=a.filter(i=>i.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(a=a.filter(i=>i.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(a=a.filter(i=>i.ts<=e.untilTs));const u=a.length;a=a.slice().reverse();const l=a.slice(s,s+n);return{total:u,items:l}}async function He(e){let s=await H();if(typeof e.beforeTs=="number"&&(s=s.filter(t=>t.ts>=e.beforeTs)),typeof e.keepLast=="number"){const t=X(e.keepLast,0,5e4);t===0?s=[]:s.length>t&&(s=s.slice(s.length-t))}return await me(s),{total:s.length}}async function Je(){await re(Z)}async function Ye(e){const n=await H();return JSON.stringify(n,null,2)}const J="beecontour.debugTrace",oe="beecontour.debugTrace.enabled",ze=2e3;function We(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function ae(e,n,s){return Math.max(n,Math.min(s,Math.floor(e)))}async function q(){const e=await Y(J),n=e==null?void 0:e[J];return Array.isArray(n)?n:[]}async function Ze(e){await z({[J]:e})}async function le(){const e=await Y(oe);return!!(e!=null&&e[oe])}async function De(e){await z({[oe]:!!e}),e||await re(J)}async function ye(){await re(J)}async function V(e,n){if(!await le())return{total:0};const t=ae((n==null?void 0:n.max)??ze,100,5e4),a=(Array.isArray(e)?e:[e]).map(f=>({...f,id:We(),ts:Date.now()}));if(!a.length)return{total:(await q()).length};const l=(await q()).concat(a),i=l.length>t?l.slice(l.length-t):l;return await Ze(i),{total:i.length}}async function Se(e){const n=ae((e==null?void 0:e.limit)??200,1,5e4),s=ae((e==null?void 0:e.offset)??0,0,1e6),t=(e==null?void 0:e.reverse)??!0,a=await q(),u=a.length,i=(t?a.slice().reverse():a).slice(s,s+n);return{total:u,items:i}}async function Le(e){const n=await q();return JSON.stringify(n,null,e!=null&&e.pretty?2:0)}const we=Object.freeze(Object.defineProperty({__proto__:null,append:V,clear:ye,exportJson:Le,isEnabled:le,list:Se,setEnabled:De},Symbol.toStringTag,{value:"Module"}));function M(e,n,s,t){const a=Number(String(e??"").trim());return Number.isFinite(a)?Math.max(n,Math.min(s,Math.floor(a))):t}let Q=0;function m(){return Q>0}function p(e,n){if(n){Xe(e);return}Q=0,Ce(e,!1)}function Xe(e){Q++,Q===1&&Ce(e,!0)}function Ce(e,n){e.rootEl.classList.toggle("is-busy",n),e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=n,e.cfgActionLogMaxEl.disabled=n,e.cfgDebugTraceMaxEl.disabled=n,e.cfgFailureLogsPerRunEl.disabled=n,e.btnCfgResetDefaults.disabled=n,e.logsCbDebugEl.disabled=n,e.logsLimitEl.disabled=n,e.btnLogsRefresh.disabled=n,e.logsTrimKeepEl.disabled=n,e.btnLogsTrim.disabled=n,e.btnLogsExport.disabled=n,e.btnLogsClear.disabled=n,e.debugLimitEl.disabled=n,e.btnDebugRefresh.disabled=n,e.btnDebugExport.disabled=n,e.btnDebugClear.disabled=n}const ie="beecontour.devConfig",D={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let ce=!1,ee={...D};function pe(e){const n=e||{};return{traceConsole:!!n.traceConsole,actionLogMax:M(n.actionLogMax??D.actionLogMax,100,5e4,D.actionLogMax),debugTraceMax:M(n.debugTraceMax??D.debugTraceMax,100,5e4,D.debugTraceMax),failureLogsPerRun:M(n.failureLogsPerRun??D.failureLogsPerRun,0,5e4,D.failureLogsPerRun)}}async function de(){if(ce)return;const e=await Y([ie]).catch(()=>({}));ee=pe(e==null?void 0:e[ie]),ce=!0}function fe(){return ee}async function Te(e){ee=pe(e),ce=!0,await z({[ie]:ee}).catch(()=>null)}async function qe(){await Te({...D})}function Qe(){let e=!1,n={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},s=!1,t="",a="";function u(c){e=c}function l(c){n={...n,...c}}function i(c){s=c}function f(c){typeof c.general=="string"&&(t=c.general),typeof c.dev=="string"&&(a=c.dev)}return{get showDevTools(){return e},get dev(){return n},get debugEnabled(){return s},get generalStatus(){return t},get devStatus(){return a},setShowDevTools:u,setDev:l,setDebugEnabled:i,setStatus:f}}function et(e){function n(c){e.settingsGeneralStatusEl.textContent=c||""}function s(c){e.cfgStatusEl.textContent=c||""}function t(c){e.cfgShowDevToolsEl.checked=c}function a(c){e.tabLogs.hidden=!c,e.devConfigDetailsEl.classList.toggle("is-hidden",!c),c||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function u(c){e.cfgTraceConsoleEl.checked=!!c.traceConsole,e.cfgActionLogMaxEl.value=String(c.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(c.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(c.failureLogsPerRun??50)}function l(c){e.logsCbDebugEl.checked=c}function i(c,E){e.settingsVersionEl.textContent=c||"—",e.settingsGitHubLinkEl.href=E||"#",e.settingsGitHubLinkEl.hidden=!E}function f(c){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=c,e.cfgActionLogMaxEl.disabled=c,e.cfgDebugTraceMaxEl.disabled=c,e.cfgFailureLogsPerRunEl.disabled=c,e.btnCfgResetDefaults.disabled=c,e.logsCbDebugEl.disabled=c}return{setGeneralStatus:n,setDevStatus:s,setShowDevToolsChecked:t,setDevToolsVisible:a,setDevConfig:u,setDebugEnabledChecked:l,setAbout:i,setBusy:f}}const ne="template.settings.showDevTools";function tt(){var e,n;try{const s=(e=globalThis==null?void 0:globalThis.chrome)==null?void 0:e.runtime,t=(n=s==null?void 0:s.getManifest)==null?void 0:n.call(s),a=typeof(t==null?void 0:t.version)=="string"?t.version:"";if(a)return a}catch{}return""}function se(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??D.actionLogMax),debugTraceMax:Number(e.debugTraceMax??D.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??D.failureLogsPerRun)}}function nt(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:M(e.cfgActionLogMaxEl.value,100,5e4,D.actionLogMax),debugTraceMax:M(e.cfgDebugTraceMaxEl.value,100,5e4,D.debugTraceMax),failureLogsPerRun:M(e.cfgFailureLogsPerRunEl.value,0,5e4,D.failureLogsPerRun)}}async function be(e){const n=we;return typeof n.setEnabled=="function"?(await n.setEnabled(e),{ok:!0}):typeof n.enable=="function"&&typeof n.disable=="function"?(await(e?n.enable():n.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function st(e,n){const s=Qe(),t=et(e);async function a(){const o=await Y([ne]).catch(()=>({}));return(o==null?void 0:o[ne])===!0}async function u(o){await z({[ne]:!!o}).catch(()=>null)}function l(o){s.setShowDevTools(o),t.setShowDevToolsChecked(o),t.setDevToolsVisible(o),o||e.tabSettings.click()}async function i(){const o=await a();l(o),V({scope:"settings",kind:"debug",message:"boot:applyDevToolsVisibility",meta:{showDevTools:o}})}async function f(){var S;t.setBusy(m());const o=await a();l(o),await de().catch(()=>null);const g=fe();s.setDev(se(g)),t.setDevConfig(s.dev);const d=we,b=typeof d.isEnabled=="function"?!!d.isEnabled():!!d.enabled;s.setDebugEnabled(b),t.setDebugEnabledChecked(b),t.setAbout(tt()||"—",((S=e.settingsGitHubLinkEl)==null?void 0:S.href)||"#"),t.setGeneralStatus(""),t.setDevStatus("")}async function c(){const o=!!e.cfgShowDevToolsEl.checked;l(o),await u(o),_({kind:"run",scope:"settings",message:o?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:o}}),V({scope:"settings",kind:"debug",message:"ui:toggle showDevTools",meta:{showDevTools:o}}),t.setGeneralStatus(o?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>t.setGeneralStatus(""),1200)}async function E(){const o=nt(e);t.setDevStatus("Saving…"),await Te(o),s.setDev(se(o)),t.setDevConfig(s.dev),_({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:o}),V({scope:"settings",kind:"debug",message:"devConfig:updated",meta:o}),t.setDevStatus("Saved."),setTimeout(()=>t.setDevStatus(""),1200)}async function A(){t.setDevStatus("Resetting…"),await qe(),await de().catch(()=>null);const o=fe();s.setDev(se(o)),t.setDevConfig(s.dev);const g=await be(!1);g.ok?(s.setDebugEnabled(!1),t.setDebugEnabledChecked(!1)):_({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:g.error||"unknown error"}),_({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...D,debugEnabled:!1}}),t.setDevStatus("Reset."),setTimeout(()=>t.setDevStatus(""),1200)}async function R(){const o=!!e.logsCbDebugEl.checked;t.setDevStatus("Saving…");const g=await be(o);if(!g.ok){e.logsCbDebugEl.checked=!o,t.setDevStatus(`Save failed: ${g.error||"unknown error"}`),_({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:g.error||"unknown error",meta:{enabled:o}});return}s.setDebugEnabled(o),_({kind:"run",scope:"settings",message:o?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:o}}),V({scope:"settings",kind:"debug",message:"debugTrace:enabledChanged",meta:{enabled:o}}),t.setDevStatus("Saved."),setTimeout(()=>t.setDevStatus(""),1200)}const B=n.on(()=>{});function r(){e.cfgShowDevToolsEl.addEventListener("change",()=>{c()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{m()||E()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{m()||E()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{m()||E()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{m()||E()}),e.btnCfgResetDefaults.addEventListener("click",()=>{m()||A()}),e.logsCbDebugEl.addEventListener("change",()=>{m()||R()}),i().catch(()=>null)}return{id:"settings",refresh(){f().catch(()=>null)},mount(){f().catch(()=>null)},unmount(){},bind:r,dispose(){B()}}}function ot(){let e=[],n=0;function s(t){e=t.items,n=t.total}return{get items(){return e},get total(){return n},set:s}}function at(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function Ee(e,n){const s=[];s.push(`Total entries: ${n.total}`),s.push("");for(const t of n.items){const a=typeof t.ok=="boolean"?t.ok?"ok":"fail":"",u=[];typeof t.status=="number"&&u.push(`status=${t.status}`),a&&u.push(a);const l=[t.scope,t.kind].filter(Boolean).join("/");s.push(`[${at(t.ts)}] ${l}${u.length?` (${u.join(", ")})`:""}`),s.push(`  ${t.message}`),t.error&&s.push(`  error: ${t.error}`),s.push("")}e.textContent=s.join(`
`),e.scrollTop=0}function it(e){function n(l){e.logsStatusEl.textContent=l}function s(l){e.debugStatusEl.textContent=l}function t(l){e.logsCbDebugEl.checked=l}function a(l){Ee(e.logsOutEl,{total:l.total,items:l.items.map(i=>({ts:i.ts,message:i.message,scope:i.scope,kind:i.kind,ok:i.ok,status:i.status,error:i.error,meta:i.meta}))})}function u(l){Ee(e.debugOutEl,{total:l.total,items:l.items.map(i=>({ts:i.ts,message:i.message,scope:i.scope,kind:i.kind,ok:i.ok,status:i.status,error:i.error,meta:i.meta}))})}return{setAuditStatus:n,setDebugStatus:s,setDebugChecked:t,renderAudit:a,renderDebug:u}}const ve="beecontour";function ct(e,n){const s=ot(),t=it(e);async function a(){t.setAuditStatus("Loading…"),p(e,!0);try{const r=M(e.logsLimitEl.value,10,5e3,200),o=await Ke({limit:r,reverse:!0});s.set(o),t.renderAudit({items:s.items,total:s.total}),t.setAuditStatus(`Showing ${s.items.length} (newest first)`)}catch(r){t.setAuditStatus(`Failed: ${(r==null?void 0:r.message)||String(r)}`)}finally{p(e,!1)}}async function u(){t.setDebugStatus("Loading…"),p(e,!0);try{const r=M(e.debugLimitEl.value,10,5e3,200),o=await Se({limit:r,reverse:!0});t.renderDebug(o),t.setDebugStatus(`Showing ${o.items.length} (newest first)`)}catch(r){t.setDebugStatus(`Failed: ${(r==null?void 0:r.message)||String(r)}`)}finally{p(e,!1)}}async function l(){const r=await le();t.setDebugChecked(r)}async function i(r){if(await De(r),t.setDebugChecked(r),!r){t.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}t.setDebugStatus("Debug ON."),await u()}async function f(){const r=M(e.logsTrimKeepEl.value,0,5e4,2e3);t.setAuditStatus("Trimming…"),p(e,!0);try{const o=await He({keepLast:r});await a(),t.setAuditStatus(`Trimmed. Remaining: ${o.total}`)}catch(o){t.setAuditStatus(`Trim failed: ${(o==null?void 0:o.message)||String(o)}`)}finally{p(e,!1)}}async function c(){t.setAuditStatus("Clearing…"),p(e,!0);try{await Je(),await a(),t.setAuditStatus("Cleared.")}catch(r){t.setAuditStatus(`Clear failed: ${(r==null?void 0:r.message)||String(r)}`)}finally{p(e,!1)}}async function E(){t.setAuditStatus("Exporting…");try{const r=await Ye({pretty:!0}),o=new Blob([r],{type:"application/json"}),g=URL.createObjectURL(o),d=document.createElement("a");d.href=g,d.download=`${ve}-audit-${Date.now()}.json`,d.click(),setTimeout(()=>URL.revokeObjectURL(g),1e3),t.setAuditStatus("Exported.")}catch(r){t.setAuditStatus(`Export failed: ${(r==null?void 0:r.message)||String(r)}`)}}async function A(){t.setDebugStatus("Clearing…"),p(e,!0);try{await ye(),await u(),t.setDebugStatus("Cleared.")}catch(r){t.setDebugStatus(`Clear failed: ${(r==null?void 0:r.message)||String(r)}`)}finally{p(e,!1)}}async function R(){t.setDebugStatus("Exporting…");try{const r=await Le({pretty:!0}),o=new Blob([r],{type:"application/json"}),g=URL.createObjectURL(o),d=document.createElement("a");d.href=g,d.download=`${ve}-debug-${Date.now()}.json`,d.click(),setTimeout(()=>URL.revokeObjectURL(g),1e3),t.setDebugStatus("Exported.")}catch(r){t.setDebugStatus(`Export failed: ${(r==null?void 0:r.message)||String(r)}`)}}function B(){e.btnLogsRefresh.addEventListener("click",()=>{m()||a()}),e.btnLogsTrim.addEventListener("click",()=>{m()||f()}),e.btnLogsClear.addEventListener("click",()=>{m()||c()}),e.btnLogsExport.addEventListener("click",()=>{m()||E()}),e.logsCbDebugEl.addEventListener("change",()=>{m()||i(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{m()||u()}),e.btnDebugClear.addEventListener("click",()=>{m()||A()}),e.btnDebugExport.addEventListener("click",()=>{m()||R()})}return{id:"logs",bind:B,mount(){l(),a(),u()},unmount(){},dispose(){}}}(function(){const n=Be(),s=Pe();s.start();const t=_e();globalThis.__APP__={...globalThis.__APP__,cache:t};const a=Fe(n),u=st(n,s),l=ct(n);a.bind(),u.bind(),l.bind();const i=Oe(n,{contour:a,settings:u,logs:l});i.bind(),i.boot()})();
