function xt(){function e(pe,St){if(!pe)throw new Error(`[dom] Missing #${St}`);return pe}const t=e(document.getElementById("appRoot"),"appRoot"),n=e(document.getElementById("tabContour"),"tabContour"),o=e(document.getElementById("tabColors"),"tabColors"),s=e(document.getElementById("tabSettings"),"tabSettings"),i=e(document.getElementById("tabLogs"),"tabLogs"),d=e(document.getElementById("viewContour"),"viewContour"),c=e(document.getElementById("viewColors"),"viewColors"),h=e(document.getElementById("viewSettings"),"viewSettings"),l=e(document.getElementById("viewLogs"),"viewLogs"),b=e(document.getElementById("dropZone"),"dropZone"),u=e(document.getElementById("fileInput"),"fileInput"),E=e(document.getElementById("btnProcess"),"btnProcess"),g=e(document.getElementById("btnClean"),"btnClean"),a=e(document.getElementById("btnDownload"),"btnDownload"),r=e(document.getElementById("contourStatus"),"contourStatus"),f=e(document.getElementById("contourSpinner"),"contourSpinner"),v=e(document.getElementById("srcCanvas"),"srcCanvas"),y=e(document.getElementById("outCanvas"),"outCanvas"),m=e(document.getElementById("clean1Canvas"),"clean1Canvas"),p=e(document.getElementById("clean2Canvas"),"clean2Canvas"),S=e(document.getElementById("edgeThreshold"),"edgeThreshold"),x=e(document.getElementById("invertOutput"),"invertOutput"),C=e(document.getElementById("cleanMinArea"),"cleanMinArea"),w=e(document.getElementById("cleanRadius"),"cleanRadius"),I=e(document.getElementById("cleanBinaryThreshold"),"cleanBinaryThreshold"),L=e(document.getElementById("cleanQualityBadge"),"cleanQualityBadge"),D=e(document.getElementById("cleanQualityFill"),"cleanQualityFill"),O=e(document.getElementById("cleanQualityText"),"cleanQualityText"),k=e(document.getElementById("contourScale"),"contourScale"),T=e(document.getElementById("btnVectorize"),"btnVectorize"),M=e(document.getElementById("btnDownloadSvg"),"btnDownloadSvg"),$=e(document.getElementById("svgPreviewImg"),"svgPreviewImg"),R=e(document.getElementById("svgPreviewText"),"svgPreviewText"),G=e(document.getElementById("pathSmoothIters"),"pathSmoothIters"),_=e(document.getElementById("colorsCanvas"),"colorsCanvas"),Q=e(document.getElementById("palette"),"palette"),q=e(document.getElementById("btnColorsApply"),"btnColorsApply"),qe=e(document.getElementById("btnColorsCancel"),"btnColorsCancel"),Ge=e(document.getElementById("btnColorsReset"),"btnColorsReset"),Qe=e(document.getElementById("edgesDark"),"edgesDark"),He=e(document.getElementById("edgeMaskThreshold"),"edgeMaskThreshold"),Ke=e(document.getElementById("edgeDilate"),"edgeDilate"),We=e(document.getElementById("maxRegionPx"),"maxRegionPx"),Ye=e(document.getElementById("colorsStatus"),"colorsStatus"),Je=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),Xe=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),Ze=e(document.getElementById("devConfigDetails"),"devConfigDetails"),et=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),tt=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),nt=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),ot=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),at=e(document.getElementById("logsCbDebug"),"logsCbDebug"),st=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),rt=e(document.getElementById("cfgStatus"),"cfgStatus"),lt=e(document.getElementById("settingsVersion"),"settingsVersion"),it=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),ct=e(document.getElementById("logsLimit"),"logsLimit"),ut=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),dt=e(document.getElementById("logsStatus"),"logsStatus"),gt=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),ft=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),bt=e(document.getElementById("btnLogsExport"),"btnLogsExport"),ht=e(document.getElementById("btnLogsClear"),"btnLogsClear"),vt=e(document.getElementById("logsOut"),"logsOut"),Et=e(document.getElementById("debugLimit"),"debugLimit"),yt=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),mt=e(document.getElementById("btnDebugExport"),"btnDebugExport"),pt=e(document.getElementById("btnDebugClear"),"btnDebugClear"),Ct=e(document.getElementById("debugStatus"),"debugStatus"),wt=e(document.getElementById("debugOut"),"debugOut");return{rootEl:t,tabContour:n,tabColors:o,tabSettings:s,tabLogs:i,viewContour:d,viewColors:c,viewSettings:h,viewLogs:l,dropZoneEl:b,fileInputEl:u,btnProcessEl:E,btnCleanEl:g,btnDownloadEl:a,contourStatusEl:r,contourSpinnerEl:f,srcCanvasEl:v,outCanvasEl:y,clean1CanvasEl:m,clean2CanvasEl:p,edgeThresholdEl:S,invertOutputEl:x,cleanMinAreaEl:C,cleanRadiusEl:w,cleanBinaryThresholdEl:I,cleanQualityBadgeEl:L,cleanQualityFillEl:D,cleanQualityTextEl:O,btnVectorizeEl:T,btnDownloadSvgEl:M,svgPreviewImgEl:$,svgPreviewTextEl:R,contourScaleEl:k,pathSmoothItersEl:G,colorsCanvasEl:_,paletteEl:Q,btnColorsApplyEl:q,btnColorsCancelEl:qe,btnColorsResetEl:Ge,edgesDarkEl:Qe,edgeMaskThresholdEl:He,edgeDilateEl:Ke,maxRegionPxEl:We,colorsStatusEl:Ye,cfgShowDevToolsEl:Je,settingsGeneralStatusEl:Xe,devConfigDetailsEl:Ze,cfgTraceConsoleEl:et,cfgActionLogMaxEl:tt,cfgDebugTraceMaxEl:nt,cfgFailureLogsPerRunEl:ot,logsCbDebugEl:at,btnCfgResetDefaults:st,cfgStatusEl:rt,settingsVersionEl:lt,settingsGitHubLinkEl:it,logsLimitEl:ct,btnLogsRefresh:ut,logsStatusEl:dt,logsTrimKeepEl:gt,btnLogsTrim:ft,btnLogsExport:bt,btnLogsClear:ht,logsOutEl:vt,debugLimitEl:Et,btnDebugRefresh:yt,btnDebugExport:mt,btnDebugClear:pt,debugStatusEl:Ct,debugOutEl:wt}}const Dt=new Set;function kt(e){Dt.add(e)}function Tt(){const e=new Set;function t(o){return e.add(o),()=>e.delete(o)}function n(){kt(s=>{for(const i of e)i(s)})}return{on:t,start:n}}function Lt(e,t){const n={contour:e.tabContour,colors:e.tabColors,settings:e.tabSettings,logs:e.tabLogs},o={contour:e.viewContour,colors:e.viewColors,settings:e.viewSettings,logs:e.viewLogs};let s="contour";const i=new Set;function d(u){Object.keys(n).forEach(E=>{const g=E===u;n[E].classList.toggle("is-active",g),n[E].setAttribute("aria-selected",g?"true":"false"),o[E].hidden=!g,o[E].classList.toggle("is-active",g)})}function c(u){var E,g,a,r,f,v,y,m;if(u===s){(g=(E=t[u]).refresh)==null||g.call(E);return}(r=(a=t[s]).unmount)==null||r.call(a),s=u,d(s),i.has(s)?(m=(y=t[s]).refresh)==null||m.call(y):(i.add(s),(v=(f=t[s]).mount)==null||v.call(f))}function h(){n.contour.addEventListener("click",u=>{var E;(E=u.preventDefault)==null||E.call(u),c("contour")}),n.colors.addEventListener("click",u=>{var E;(E=u.preventDefault)==null||E.call(u),c("colors")}),n.settings.addEventListener("click",u=>{var E;(E=u.preventDefault)==null||E.call(u),c("settings")}),n.logs.addEventListener("click",u=>{var E;(E=u.preventDefault)==null||E.call(u),c("logs")})}function l(){var u,E,g,a;s="contour",d(s),Object.keys(t).forEach(r=>{var f,v;return(v=(f=t[r]).boot)==null?void 0:v.call(f)}),i.has(s)?(a=(g=t[s]).refresh)==null||a.call(g):(i.add(s),(E=(u=t[s]).mount)==null||E.call(u))}function b(){Object.keys(t).forEach(u=>{var E,g;return(g=(E=t[u]).dispose)==null?void 0:g.call(E)})}return{bind:h,boot:l,activate:c,dispose:b}}function Ce(e){const t=e.items.length;return{items:e.items,counts:{items:t},meta:e.meta}}function It(){const e={items:[],meta:{}},t=new Set;function n(){const l=Ce(e);for(const b of t)try{b(l)}catch{}}function o(){return Ce(e)}function s(l){t.add(l);try{l(o())}catch{}return()=>t.delete(l)}function i(){e.items=[],e.meta={},n()}function d(l){e.meta.scopeUpdatedSince=l,n()}function c(){return String(e.meta.scopeUpdatedSince||"")}function h(l,b){e.items=l.slice(),e.meta.updatedTs=Date.now(),typeof(b==null?void 0:b.limit)=="number"&&(e.meta.limit=b.limit),n()}return{getSnapshot:o,subscribe:s,getScopeUpdatedSince:c,clearAll:i,setScopeUpdatedSince:d,setItems:h}}function Mt(){return{loadedImageName:null,hasImage:!1,hasOutput:!1,edgeMask:void 0,repairedMask:void 0,smoothedMask:void 0,svgText:void 0}}function Bt(e){e.loadedImageName=null,e.hasImage=!1,e.hasOutput=!1,e.edgeMask=void 0,e.repairedMask=void 0,e.smoothedMask=void 0,e.svgText=void 0}function Be(e,t,n){const o=new Uint8Array(e.length);function s(f,v){return v*t+f}function i(f,v){return f<0||v<0||f>=t||v>=n?!1:e[s(f,v)]===1}let d=0,c=0,h=0,l=0,b=0;const u=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];for(let f=0;f<n;f++)for(let v=0;v<t;v++){if(!i(v,f))continue;d++;let y=0,m=!1;for(const[p,S]of u)i(v+p,f+S)?y++:m=!0;m&&c++,y===1?h++:y>=3&&l++}const E=[[-1,0],[1,0],[0,-1],[0,1]],g=new Int32Array(e.length),a=new Int32Array(e.length);for(let f=0;f<n;f++)for(let v=0;v<t;v++){const y=s(v,f);if(e[y]===0||o[y]===1)continue;b++,o[y]=1;let m=0,p=0;for(g[p]=v,a[p]=f,p++;m<p;){const S=g[m],x=a[m];m++;for(const[C,w]of E){const I=S+C,L=x+w;if(I<0||L<0||I>=t||L>=n)continue;const D=s(I,L);e[D]===0||o[D]===1||(o[D]=1,g[p]=I,a[p]=L,p++)}}}const r=d/Math.max(1,c);return{onPixels:d,boundaryPixels:c,components:b,endpoints:h,junctions:l,thicknessRatio:r}}function At(e,t){function n(g){e.contourStatusEl.textContent=g}function o(g,a){e.contourSpinnerEl.classList.toggle("is-hidden",!g),a&&n(a)}function s(){e.btnProcessEl.disabled=!t.hasImage,e.btnDownloadEl.disabled=!t.hasOutput,e.btnCleanEl.disabled=!t.hasOutput,e.btnVectorizeEl.disabled=!t.smoothedMask,e.btnDownloadSvgEl.disabled=!t.svgText}function i(){t.svgText=void 0,e.svgPreviewTextEl.textContent="",e.svgPreviewImgEl.removeAttribute("src")}function d(){const g=e.srcCanvasEl.getContext("2d"),a=e.outCanvasEl.getContext("2d");g.clearRect(0,0,e.srcCanvasEl.width,e.srcCanvasEl.height),a.clearRect(0,0,e.outCanvasEl.width,e.outCanvasEl.height);const r=e.clean1CanvasEl.getContext("2d"),f=e.clean2CanvasEl.getContext("2d");r.clearRect(0,0,e.clean1CanvasEl.width,e.clean1CanvasEl.height),f.clearRect(0,0,e.clean2CanvasEl.width,e.clean2CanvasEl.height)}function c(){const g=e.clean1CanvasEl.getContext("2d"),a=e.clean2CanvasEl.getContext("2d");g.clearRect(0,0,e.clean1CanvasEl.width,e.clean1CanvasEl.height),a.clearRect(0,0,e.clean2CanvasEl.width,e.clean2CanvasEl.height)}function h(g,a){const r=Number(g.value);return Number.isFinite(r)?r:a}function l(g,a){const r=a instanceof Error?a.message:String(a);n(`${g} failed: ${r}`),o(!1),console.error(`[BeeContour] ${g} failed`,a)}function b(g,a){if(!t.smoothedMask){e.cleanQualityBadgeEl.textContent="—",e.cleanQualityBadgeEl.className="qBadge qBadge--off",e.cleanQualityFillEl.style.width="0%",e.cleanQualityTextEl.textContent="";return}const r=Be(t.smoothedMask,g,a),f=(I,L)=>Math.max(0,Math.min(1,I/Math.max(1,L))),v=f(r.components,800),y=f(r.endpoints,3e3),m=f(r.junctions,1500),p=r.thicknessRatio>5?1:r.thicknessRatio>3?.5:0,S=Math.round(100*(1-(.45*v+.45*y+.1*m)-.1*p)),x=Math.max(0,Math.min(100,S));let C="qBadge qBadge--bad",w=`Bad ${x}`;x>=70?(C="qBadge qBadge--ok",w=`Good ${x}`):x>=45&&(C="qBadge qBadge--warn",w=`OK ${x}`),e.cleanQualityBadgeEl.className=C,e.cleanQualityBadgeEl.textContent=w,e.cleanQualityFillEl.style.width=`${x}%`,e.cleanQualityTextEl.textContent=`CC:${r.components} end:${r.endpoints} j:${r.junctions} thick:${r.thicknessRatio.toFixed(2)}`}function u(){if(!t.hasOutput)return;const a=`${(t.loadedImageName||"beecontour").replace(/\.[a-z0-9]+$/i,"").replace(/[^a-z0-9-_]+/gi,"_")}_contour.png`,r=e.outCanvasEl.toDataURL("image/png"),f=document.createElement("a");f.href=r,f.download=a,document.body.appendChild(f),f.click(),f.remove(),n(`Downloaded: ${a}`)}function E(){if(!t.svgText)return;const a=`${(t.loadedImageName||"beecontour").replace(/\.[a-z0-9]+$/i,"").replace(/[^a-z0-9-_]+/gi,"_")}_contour.svg`,r=new Blob([t.svgText],{type:"image/svg+xml;charset=utf-8"}),f=URL.createObjectURL(r),v=document.createElement("a");v.href=f,v.download=a,document.body.appendChild(v),v.click(),v.remove(),URL.revokeObjectURL(f),n(`Downloaded: ${a}`)}return{setStatus:n,setContourBusyVisual:o,updateEnabled:s,clearSvgPreview:i,clearCanvases:d,clearCleanCanvasesOnly:c,getNumber:h,showError:l,updateCleanQualityUI:b,downloadPng:u,downloadSvg:E}}let z=0;function P(){return z>0}async function se(e,t){Ae(e);try{return await t()}finally{Rt(e)}}function F(e,t){if(t){Ae(e);return}z=0,ee(e,!1)}function Ae(e){z++,z===1&&ee(e,!0)}function Rt(e){if(z--,z<=0){z=0,ee(e,!1);return}z===0&&ee(e,!1)}function ee(e,t){e.rootEl.classList.toggle("is-busy",t),e.cfgShowDevToolsEl.disabled=!1,e.fileInputEl.disabled=t,e.btnProcessEl.disabled=t,e.btnCleanEl.disabled=t,e.btnDownloadEl.disabled=t,e.edgeThresholdEl.disabled=t,e.invertOutputEl.disabled=t,e.cleanMinAreaEl.disabled=t,e.cleanRadiusEl.disabled=t,e.cleanBinaryThresholdEl.disabled=t,e.btnVectorizeEl.disabled=t,e.btnDownloadSvgEl.disabled=t,e.contourScaleEl.disabled=t,e.cfgTraceConsoleEl.disabled=t,e.cfgActionLogMaxEl.disabled=t,e.cfgDebugTraceMaxEl.disabled=t,e.cfgFailureLogsPerRunEl.disabled=t,e.btnCfgResetDefaults.disabled=t,e.logsCbDebugEl.disabled=t,e.logsLimitEl.disabled=t,e.btnLogsRefresh.disabled=t,e.logsTrimKeepEl.disabled=t,e.btnLogsTrim.disabled=t,e.btnLogsExport.disabled=t,e.btnLogsClear.disabled=t,e.debugLimitEl.disabled=t,e.btnDebugRefresh.disabled=t,e.btnDebugExport.disabled=t,e.btnDebugClear.disabled=t,e.btnColorsApplyEl.disabled=t,e.btnColorsCancelEl.disabled=t,e.btnColorsResetEl.disabled=t,e.edgesDarkEl.disabled=t,e.edgeMaskThresholdEl.disabled=t,e.edgeDilateEl.disabled=t,e.maxRegionPxEl.disabled=t;for(const n of Array.from(e.paletteEl.querySelectorAll("button")))n.disabled=t;e.colorsCanvasEl.style.pointerEvents=t?"none":"auto"}function Z(e,t,n){return Number.isFinite(e)?Math.max(t,Math.min(n,e|0)):t}function we(e,t,n,o){const s=new ImageData(t,n),i=s.data;for(let d=0,c=0;d<e.length;d++,c+=4){const h=e[d]===1;if(o){const l=h?0:255;i[c]=l,i[c+1]=l,i[c+2]=l,i[c+3]=255}else{const l=h?255:0;i[c]=l,i[c+1]=l,i[c+2]=l,i[c+3]=255}}return s}function re(e,t,n,o){const s=new Uint8Array(e.length),i=Math.max(1,o);for(let d=0;d<n;d++)for(let c=0;c<t;c++){let h=0;for(let l=-i;l<=i&&!h;l++){const b=d+l;if(b<0||b>=n)continue;const u=b*t;for(let E=-i;E<=i;E++){const g=c+E;if(!(g<0||g>=t)&&e[u+g]===1){h=1;break}}}s[d*t+c]=h}return s}function le(e,t,n,o){const s=new Uint8Array(e.length),i=Math.max(1,o);for(let d=0;d<n;d++)for(let c=0;c<t;c++){let h=1;for(let l=-i;l<=i&&h;l++){const b=d+l;if(b<0||b>=n){h=0;break}const u=b*t;for(let E=-i;E<=i;E++){const g=c+E;if(g<0||g>=t){h=0;break}if(e[u+g]===0){h=0;break}}}s[d*t+c]=h}return s}function Pt(e,t,n,o){const s=new Uint8Array(e),i=new Uint8Array(e.length),d=new Int32Array(e.length),c=new Int32Array(e.length);for(let h=0;h<n;h++)for(let l=0;l<t;l++){const b=h*t+l;if(e[b]===0||i[b]===1)continue;let u=0,E=0;i[b]=1,d[E]=l,c[E]=h,E++;const g=[b];for(;u<E;){const a=d[u],r=c[u];u++;const f=[[a-1,r],[a+1,r],[a,r-1],[a,r+1]];for(const[v,y]of f){if(v<0||v>=t||y<0||y>=n)continue;const m=y*t+v;e[m]===0||i[m]===1||(i[m]=1,d[E]=v,c[E]=y,E++,g.push(m))}}if(g.length<o)for(const a of g)s[a]=0}return s}const $t=new Set;function Re(e){for(const t of $t)t(e,"local")}function K(e){const t=localStorage.getItem(e);if(t!==null)try{return JSON.parse(t)}catch{return t}}function Ot(e,t){localStorage.setItem(e,JSON.stringify(t))}async function J(e){if(typeof e=="string")return{[e]:K(e)};if(Array.isArray(e)){const n={};for(const o of e)n[o]=K(o);return n}const t={};for(const[n,o]of Object.entries(e))t[n]=localStorage.getItem(n)!==null?K(n):o;return t}async function X(e){const t={};for(const[n,o]of Object.entries(e)){const s=K(n);Ot(n,o),t[n]={oldValue:s,newValue:o}}Re(t)}async function ye(e){const t=Array.isArray(e)?e:[e],n={};for(const o of t){const s=K(o);localStorage.removeItem(o),n[o]={oldValue:s,newValue:void 0}}Re(n)}const W="beecontour.debugTrace",fe="beecontour.debugTrace.enabled",Nt=2e3;function Ft(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function be(e,t,n){return Math.max(t,Math.min(n,Math.floor(e)))}async function te(){const e=await J(W),t=e==null?void 0:e[W];return Array.isArray(t)?t:[]}async function Vt(e){await X({[W]:e})}async function me(){const e=await J(fe);return!!(e!=null&&e[fe])}async function Pe(e){await X({[fe]:!!e}),e||await ye(W)}async function $e(){await ye(W)}async function Oe(e,t){if(!await me())return{total:0};const o=be((t==null?void 0:t.max)??Nt,100,5e4),s=(Array.isArray(e)?e:[e]).map(h=>({...h,id:Ft(),ts:Date.now()}));if(!s.length)return{total:(await te()).length};const d=(await te()).concat(s),c=d.length>o?d.slice(d.length-o):d;return await Vt(c),{total:c.length}}async function Ne(e){const t=be((e==null?void 0:e.limit)??200,1,5e4),n=be((e==null?void 0:e.offset)??0,0,1e6),o=(e==null?void 0:e.reverse)??!0,s=await te(),i=s.length,c=(o?s.slice().reverse():s).slice(n,n+t);return{total:i,items:c}}async function Fe(e){const t=await te();return JSON.stringify(t,null,e!=null&&e.pretty?2:0)}const Ve=Object.freeze(Object.defineProperty({__proto__:null,append:Oe,clear:$e,exportJson:Fe,isEnabled:me,list:Ne,setEnabled:Pe},Symbol.toStringTag,{value:"Module"}));function ie(e){return`[BCT][${e}]`}function Ut(e){function t(...i){e.traceOn()&&console.log(ie("trace"),...i)}function n(...i){console.warn(ie("warn"),...i)}function o(...i){console.error(ie("error"),...i)}function s(i,d){t(i,d),Oe({scope:e.scope,kind:"debug",message:i,meta:d})}return{logTrace:t,logWarn:n,logError:o,traceScope:s}}function U(e,t,n,o){const s=Number(String(e??"").trim());return Number.isFinite(s)?Math.max(t,Math.min(n,Math.floor(s))):o}const he="beecontour.devConfig",A={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let ve=!1,ne={...A};function Ue(e){const t=e||{};return{traceConsole:!!t.traceConsole,actionLogMax:U(t.actionLogMax??A.actionLogMax,100,5e4,A.actionLogMax),debugTraceMax:U(t.debugTraceMax??A.debugTraceMax,100,5e4,A.debugTraceMax),failureLogsPerRun:U(t.failureLogsPerRun??A.failureLogsPerRun,0,5e4,A.failureLogsPerRun)}}async function Se(){if(ve)return;const e=await J([he]).catch(()=>({}));ne=Ue(e==null?void 0:e[he]),ve=!0}function Ee(){return ne}async function _e(e){ne=Ue(e),ve=!0,await X({[he]:ne}).catch(()=>null)}async function _t(){await _e({...A})}const{logTrace:j,logWarn:V,logError:N,traceScope:B}=Ut({scope:"panel",traceOn:()=>!!Ee().traceConsole});async function xe(e,t,n,o){const{setStatus:s,setContourBusyVisual:i,clearCanvases:d,clearCleanCanvasesOnly:c,clearSvgPreview:h,updateEnabled:l,getNumber:b}=o;if(!n.type.startsWith("image/")){s("Unsupported file type (please drop an image)."),V("Contour load: rejected non-image file",{name:n.name,type:n.type,size:n.size}),B("Contour load: rejected non-image file",{name:n.name,type:n.type,size:n.size});return}const u=performance.now();await se(e,async()=>{i(!0,"Loading image…"),t.loadedImageName=n.name||"image";const E=URL.createObjectURL(n);B("Contour load: start",{name:n.name,type:n.type,size:n.size});try{const g=await new Promise((x,C)=>{const w=new Image;w.onload=()=>x(w),w.onerror=()=>C(new Error("Failed to load image")),w.src=E}),a=e.srcCanvasEl,r=a.getContext("2d");if(!r){N("Contour load: missing 2D context",{canvasId:"srcCanvasEl"}),s("Load failed — canvas context not available.");return}d();const f=Z(b(e.contourScaleEl,100),10,100),v=f/100;let y=Math.max(64,Math.floor(g.naturalWidth*v)),m=Math.max(64,Math.floor(g.naturalHeight*v));const p=1600,S=Math.min(1,p/Math.max(y,m));y=Math.max(64,Math.floor(y*S)),m=Math.max(64,Math.floor(m*S)),a.width=y,a.height=m,r.imageSmoothingEnabled=!0,r.clearRect(0,0,a.width,a.height),r.drawImage(g,0,0,a.width,a.height),t.hasImage=!0,t.hasOutput=!1,t.edgeMask=void 0,t.repairedMask=void 0,t.smoothedMask=void 0,t.svgText=void 0,h(),c(),l(),s(`Loaded: ${t.loadedImageName} (${a.width}×${a.height})`),B("Contour load: done",{naturalW:g.naturalWidth,naturalH:g.naturalHeight,scalePct:f,maxSide:p,targetW:y,targetH:m,pixels:y*m,ms:Math.round((performance.now()-u)*10)/10})}catch(g){N("Contour load: exception",{error:g instanceof Error?g.message:String(g)}),s("Load failed — see console / debug trace.")}finally{URL.revokeObjectURL(E),i(!1)}})}async function jt(e,t,n){const{setStatus:o,setContourBusyVisual:s,clearCleanCanvasesOnly:i,clearSvgPreview:d,updateEnabled:c,getNumber:h}=n;if(!t.hasImage){V("Contour process: skipped (no image loaded)");return}const l=performance.now();await se(e,async()=>{s(!0,"Processing…"),await new Promise(b=>{setTimeout(()=>{(async()=>{try{const u=e.srcCanvasEl,E=e.outCanvasEl,g=u.width,a=u.height,r=g*a,f=Math.max(1,Math.min(255,h(e.edgeThresholdEl,70))),v=e.invertOutputEl.checked;B("Contour process: start",{width:g,height:a,pixels:r,threshold:f,whiteBg:v}),E.width=g,E.height=a;const y=E.getContext("2d",{willReadFrequently:!0}),m=u.getContext("2d",{willReadFrequently:!0});if(!m||!y){N("Contour process: missing 2D context",{hasSrc:!!m,hasOut:!!y}),o("Process failed — canvas context not available.");return}const S=m.getImageData(0,0,g,a).data,x=new Uint8ClampedArray(g*a);for(let k=0,T=0;k<S.length;k+=4,T++){const M=S[k],$=S[k+1],R=S[k+2];x[T]=.299*M+.587*$+.114*R|0}const C=[-1,0,1,-2,0,2,-1,0,1],w=[-1,-2,-1,0,0,0,1,2,1],I=new Uint8ClampedArray(g*a);for(let k=1;k<a-1;k++)for(let T=1;T<g-1;T++){let M=0,$=0,R=0;for(let _=-1;_<=1;_++)for(let Q=-1;Q<=1;Q++){const q=x[(k+_)*g+(T+Q)];M+=q*C[R],$+=q*w[R],R++}const G=Math.min(255,Math.sqrt(M*M+$*$)|0);I[k*g+T]=G>=f?255:0}const L=y.createImageData(g,a),D=L.data;let O=0;for(let k=0,T=0;k<I.length;k++,T+=4){const M=I[k];if(M===255&&O++,v){const R=M===255?0:255;D[T]=R,D[T+1]=R,D[T+2]=R,D[T+3]=255}else D[T]=M,D[T+1]=M,D[T+2]=M,D[T+3]=255}y.putImageData(L,0,0),t.hasOutput=!0,t.edgeMask=void 0,t.repairedMask=void 0,t.smoothedMask=void 0,d(),i(),o("Done. You can clean/smooth or download the PNG."),B("Contour process: done",{width:g,height:a,pixels:r,threshold:f,whiteBg:v,edgePixels:O,edgeRatio:Math.round(O/Math.max(1,r)*1e6)/1e6,ms:Math.round((performance.now()-l)*10)/10})}catch(u){N("Contour process: exception",{error:u instanceof Error?u.message:String(u)}),o("Process failed — see console / debug trace.")}finally{b()}})()},0)}),s(!1),c()})}async function zt(e,t,n){const{setStatus:o,setContourBusyVisual:s,clearSvgPreview:i,updateEnabled:d,getNumber:c,updateCleanQualityUI:h}=n;if(!t.hasOutput){V("Contour clean: skipped (no output present)");return}const l=performance.now();await se(e,async()=>{s(!0,"Cleaning…"),await new Promise(b=>{setTimeout(()=>{(async()=>{try{const u=e.outCanvasEl,E=e.clean1CanvasEl,g=e.clean2CanvasEl;B("Contour clean: raw inputs",{cleanRadiusVal:e.cleanRadiusEl.value,cleanMinAreaVal:e.cleanMinAreaEl.value,cleanBinaryThresholdVal:e.cleanBinaryThresholdEl.value});const a=Z(c(e.cleanRadiusEl,1),1,3),r=Z(c(e.cleanMinAreaEl,12),0,500),f=Z(c(e.cleanBinaryThresholdEl,128),1,254);E.width=u.width,E.height=u.height,g.width=u.width,g.height=u.height;const v=u.width,y=u.height,m=v*y,p=e.invertOutputEl.checked;B("Contour clean: start",{width:v,height:y,pixels:m,whiteBg:p,EDGE_T:f,minArea:r,radius:a});const S=u.getContext("2d",{willReadFrequently:!0}),x=E.getContext("2d",{willReadFrequently:!0}),C=g.getContext("2d",{willReadFrequently:!0});if(!S||!x||!C){N("Contour clean: missing 2D context",{hasOut:!!S,hasC1:!!x,hasC2:!!C}),o("Clean failed — canvas context not available.");return}const I=S.getImageData(0,0,v,y).data,L=new Uint8Array(v*y);let D=0;for(let R=0,G=0;R<L.length;R++,G+=4){const _=I[G],q=(p?_<f:_>=f)?1:0;L[R]=q,q===1&&D++}B("Contour removeSmallComponents: params",{edge:L,width:v,height:y,minArea:r});const O=Pt(L,v,y,r);B("Contour erode : params",{edgeNoSpeck:O,width:v,height:y,radius:a});const k=le(re(O,v,y,a),v,y,a);x.putImageData(we(k,v,y,p),0,0),B("Contour dilate : params",{repaired:k,width:v,height:y,radius:a});const T=re(le(k,v,y,a),v,y,a);B("Contour erode : params",{opened:T,width:v,height:y,radius:a});const M=le(re(T,v,y,a),v,y,a);C.putImageData(we(M,v,y,p),0,0),t.edgeMask=L,t.repairedMask=k,t.smoothedMask=M,i();const $=Be(M,v,y);h(v,y),o(`Clean done — CC:${$.components} endpoints:${$.endpoints} junctions:${$.junctions} thickness:${$.thicknessRatio.toFixed(2)}`),B("Contour clean: done",{width:v,height:y,pixels:m,whiteBg:p,EDGE_T:f,minArea:r,radius:a,edgeOn:D,edgeRatio:Math.round(D/Math.max(1,m)*1e6)/1e6,quality:$,ms:Math.round((performance.now()-l)*10)/10})}catch(u){N("Contour clean: exception",{error:u instanceof Error?u.message:String(u)}),o("Clean failed — see console / debug trace.")}finally{b()}})()},0)}),s(!1),d()})}function qt(e,t,n){const o=new Uint8Array(e.length),s=[];function i(g,a){return a*t+g}function d(g,a){return g<0||a<0||g>=t||a>=n?!1:e[i(g,a)]===1}function c(g,a){if(!d(g,a))return!1;for(let r=-1;r<=1;r++)for(let f=-1;f<=1;f++)if(!(f===0&&r===0)&&!d(g+f,a+r))return!0;return!1}const h=[{dx:1,dy:0},{dx:1,dy:1},{dx:0,dy:1},{dx:-1,dy:1},{dx:-1,dy:0},{dx:-1,dy:-1},{dx:0,dy:-1},{dx:1,dy:-1}],l=2e3,b=Math.max(2e3,Math.floor((t+n)*2)),u=Math.max(2e5,Math.floor(t*n*.25));let E=0;for(let g=0;g<n;g++)for(let a=0;a<t;a++){if(s.length>=l||E>=u)return s;const r=i(a,g);if(o[r]===1||!c(a,g))continue;const f=[];let v=a,y=g,m=4,p=0;const S=Math.min(t*n,b*4);for(;p<S;){p++;const x=i(v,y);if(o[x]===1||(f.push({x:v,y}),o[x]=1,E++,f.length>=b)||E>=u)break;let C=!1;const w=(m+6)%8;for(let I=0;I<8;I++){const L=(w+I)%8,D=v+h[L].dx,O=y+h[L].dy;if(!c(D,O))continue;const k=i(D,O);if(!(!(D===a&&O===g&&f.length>10)&&o[k]===1)){v=D,y=O,m=L,C=!0;break}}if(!C||v===a&&y===g&&f.length>10)break}f.length>=20&&s.push(f)}return s}function De(e,t){if(e.length<3)return e;const n=t*t;function o(l,b,u){const E=u.x-b.x,g=u.y-b.y,a=l.x-b.x,r=l.y-b.y,f=E*a+g*r;if(f<=0)return(l.x-b.x)**2+(l.y-b.y)**2;const v=E*E+g*g;if(v<=f)return(l.x-u.x)**2+(l.y-u.y)**2;const y=f/v,m=b.x+y*E,p=b.y+y*g;return(l.x-m)**2+(l.y-p)**2}const s=new Uint8Array(e.length);s[0]=1,s[e.length-1]=1;const i=[0],d=[e.length-1];for(;i.length>0;){const l=i.pop(),b=d.pop();if(b<=l+1)continue;const u=e[l],E=e[b];let g=0,a=-1;for(let r=l+1;r<b;r++){const f=o(e[r],u,E);f>g&&(g=f,a=r)}a!==-1&&g>n&&(s[a]=1,i.push(l),d.push(a),i.push(a),d.push(b))}const c=[];for(let l=0;l<e.length;l++)s[l]===1&&c.push(e[l]);const h=[];for(const l of c){const b=h[h.length-1];(!b||b.x!==l.x||b.y!==l.y)&&h.push(l)}return h}function Gt(e,t){let n=e;for(let o=0;o<t;o++){if(n.length<3)return n;const s=[];for(let b=0;b<n.length-1;b++){const u=n[b],E=n[b+1];s.push({x:.75*u.x+.25*E.x,y:.75*u.y+.25*E.y},{x:.25*u.x+.75*E.x,y:.25*u.y+.75*E.y})}const i=n[0],d=n[n.length-1],c=i.x-d.x,h=i.y-d.y;if(c*c+h*h<=4){const b=n[n.length-1],u=n[0];s.push({x:.75*b.x+.25*u.x,y:.75*b.y+.25*u.y},{x:.25*b.x+.75*u.x,y:.25*b.y+.75*u.y})}n=s}return n}function Qt(e,t,n){const o=[];for(const s of e){const i=Ht(s);i&&o.push(`<path d="${i}" fill="none" stroke="#000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>`)}return`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${t}" height="${n}" viewBox="0 0 ${t} ${n}">
<rect x="0" y="0" width="${t}" height="${n}" fill="#fff"/>
`+o.join(`
`)+`
</svg>
`}function Ht(e){if(e.length<2)return"";const t=e.slice(),n=t[0],o=t[t.length-1],s=n.x-o.x,i=n.y-o.y,d=s*s+i*i<=4;d&&t.push({x:n.x,y:n.y});let c=`M ${t[0].x.toFixed(2)} ${t[0].y.toFixed(2)}`;for(let h=0;h<t.length-1;h++){const l=t[Math.max(0,h-1)],b=t[h],u=t[h+1],E=t[Math.min(t.length-1,h+2)],g=b.x+(u.x-l.x)/6,a=b.y+(u.y-l.y)/6,r=u.x-(E.x-b.x)/6,f=u.y-(E.y-b.y)/6;c+=` C ${g.toFixed(2)} ${a.toFixed(2)}, ${r.toFixed(2)} ${f.toFixed(2)}, ${u.x.toFixed(2)} ${u.y.toFixed(2)}`}return d&&(c+=" Z"),c}async function Kt(e,t,n){if(!t.smoothedMask){V("Contour vectorize: skipped (no smoothed mask present)");return}const o=performance.now();await se(e,async()=>{n.setContourBusyVisual(!0,"Vectorizing…");const s=()=>{t.svgText=void 0,e.svgPreviewTextEl.textContent="",e.svgPreviewImgEl.removeAttribute("src")};try{await new Promise((i,d)=>{setTimeout(()=>{(async()=>{try{const c=t.smoothedMask,h=e.outCanvasEl.width,l=e.outCanvasEl.height,b=h*l,u=1.5,E=Math.max(0,Math.min(4,n.getNumber(e.pathSmoothItersEl,2)|0));B("Contour vectorize: start",{width:h,height:l,pixels:b,epsilon:u,smoothIters:E});const g=qt(c,h,l),a=g.length,r=g.reduce((C,w)=>C+w.length,0),f=g.reduce((C,w)=>Math.max(C,w.length),0);if(a===0||r===0){V("Contour vectorize: no boundaries found",{width:h,height:l,pixels:b,pathsRaw:a,pointsRaw:r}),s(),n.setStatus("No boundaries found to vectorize."),i();return}if(a>2e3||r>2e5){V("Contour vectorize: aborted (too complex)",{width:h,height:l,pixels:b,pathsRaw:a,pointsRaw:r,maxPolyline:f}),s(),n.setStatus(`Vectorize aborted: too complex (paths ${a}, points ${r}). Try stronger clean / higher minArea / lower resolution.`),i();return}B("Contour vectorize: traced boundaries",{pathsRaw:a,pointsRaw:r,maxPolyline:f});const v=g.filter(C=>C.length>=20).map(C=>{const w=De(C,u),I=E>0?Gt(w,E):w;return De(I,u)}).filter(C=>C.length>=3),y=v.length,m=v.reduce((C,w)=>C+w.length,0),p=v.reduce((C,w)=>Math.max(C,w.length),0);if(y===0||m===0){V("Contour vectorize: simplified to nothing",{pathsRaw:a,pointsRaw:r,pathsOut:y,pointsOut:m,smoothIters:E,epsilon:u}),s(),n.setStatus("Vectorize produced no usable paths (after simplification)."),i();return}B("Contour vectorize: simplified",{pathsOut:y,pointsOut:m,maxOut:p,smoothIters:E,epsilon:u});const S=Qt(v,h,l);t.svgText=S,e.svgPreviewTextEl.textContent=S;const x=encodeURIComponent(S).replace(/'/g,"%27").replace(/"/g,"%22");e.svgPreviewImgEl.src=`data:image/svg+xml;charset=utf-8,${x}`,n.setStatus(`SVG generated: paths ${y}, points ${r}→${m}, smooth ${E}`),B("Contour vectorize: done",{width:h,height:l,pixels:b,smoothIters:E,epsilon:u,pathsRaw:a,pointsRaw:r,pathsOut:y,pointsOut:m,svgChars:S.length,ms:Math.round((performance.now()-o)*10)/10}),i()}catch(c){N("Contour vectorize: exception",{error:c instanceof Error?c.message:String(c),ms:Math.round((performance.now()-o)*10)/10}),d(c)}})()},0)})}catch(i){n.showError("Vectorize",i),s()}finally{n.setContourBusyVisual(!1),n.updateEnabled()}})}function Wt(e,t){const n=Mt(),o=At(e,n);function s(){const h=e.dropZoneEl;function l(b){h.classList.toggle("is-hover",b)}h.addEventListener("dragover",b=>{b.preventDefault(),l(!0)}),h.addEventListener("dragleave",()=>l(!1)),h.addEventListener("drop",b=>{var E;b.preventDefault(),l(!1);const u=(E=b.dataTransfer)==null?void 0:E.files;!u||u.length===0||xe(e,n,u[0],{setStatus:o.setStatus,setContourBusyVisual:o.setContourBusyVisual,clearCanvases:o.clearCanvases,clearCleanCanvasesOnly:o.clearCleanCanvasesOnly,clearSvgPreview:o.clearSvgPreview,updateEnabled:o.updateEnabled,getNumber:o.getNumber})}),e.fileInputEl.addEventListener("change",()=>{var u;const b=(u=e.fileInputEl.files)==null?void 0:u[0];b&&(xe(e,n,b,{setStatus:o.setStatus,setContourBusyVisual:o.setContourBusyVisual,clearCanvases:o.clearCanvases,clearCleanCanvasesOnly:o.clearCleanCanvasesOnly,clearSvgPreview:o.clearSvgPreview,updateEnabled:o.updateEnabled,getNumber:o.getNumber}),e.fileInputEl.value="")})}function i(){s(),e.btnDownloadEl.addEventListener("click",()=>o.downloadPng()),e.btnDownloadSvgEl.addEventListener("click",()=>o.downloadSvg()),e.btnProcessEl.addEventListener("click",()=>{jt(e,n,{setStatus:o.setStatus,setContourBusyVisual:o.setContourBusyVisual,clearCleanCanvasesOnly:o.clearCleanCanvasesOnly,clearSvgPreview:o.clearSvgPreview,updateEnabled:o.updateEnabled,getNumber:o.getNumber})}),e.btnCleanEl.addEventListener("click",()=>{zt(e,n,{setStatus:o.setStatus,setContourBusyVisual:o.setContourBusyVisual,clearSvgPreview:o.clearSvgPreview,updateEnabled:o.updateEnabled,getNumber:o.getNumber,updateCleanQualityUI:o.updateCleanQualityUI})}),e.btnVectorizeEl.addEventListener("click",()=>{Kt(e,n,{setStatus:o.setStatus,setContourBusyVisual:o.setContourBusyVisual,updateEnabled:o.updateEnabled,showError:o.showError,getNumber:o.getNumber})}),Bt(n),o.clearSvgPreview(),o.updateEnabled(),o.setStatus("No image loaded"),e.contourSpinnerEl.classList.add("is-hidden")}function d(){}function c(){}return{id:"contour",bind:i,mount:d,unmount:c}}function ce(e,t,n){return Number.isFinite(e)?Math.max(t,Math.min(n,Math.trunc(e))):t}function Yt(e,t,n){return Math.round(.2126*e+.7152*t+.0722*n)}function je(e){return{edgesDark:!!(e.edgesDark??!0),edgeThreshold:ce(e.edgeThreshold??80,0,255),edgeDilate:ce(e.edgeDilate??2,0,6),maxRegionPx:ce(e.maxRegionPx??2e5,1e3,1e7)}}function Jt(e,t,n){const{data:o,width:s,height:i}=e,d=new Uint8Array(s*i);for(let c=0,h=0;c<d.length;c++,h+=4){const l=o[h+0],b=o[h+1],u=o[h+2];if(o[h+3]===0){d[c]=0;continue}const g=Yt(l,b,u),a=t?g<=n:g>=255-n;d[c]=a?1:0}return d}function Xt(e,t,n,o){if(o<=0)return e;let s=e;for(let i=0;i<o;i++){const d=new Uint8Array(t*n);for(let c=0;c<n;c++)for(let h=0;h<t;h++){const l=c*t+h;if(s[l]){d[l]=1;continue}let b=0;for(let u=-1;u<=1&&!b;u++){const E=c+u;if(!(E<0||E>=n))for(let g=-1;g<=1;g++){const a=h+g;if(!(a<0||a>=t)&&s[E*t+a]){b=1;break}}}d[l]=b}s=d}return s}function Zt(e,t,n,o,s,i){const d=t*o+e;if(n[d])return{ok:!1,message:"Click is on an edge; pick inside a region."};const c=new Uint8Array(o*s),h=new Int32Array(o*s),l=new Int32Array(o*s);let b=0,u=0;h[u]=e,l[u]=t,u++,c[d]=1;let E=1;for(;b<u;){const g=h[b],a=l[b];b++;const r=[[g-1,a],[g+1,a],[g,a-1],[g,a+1]];for(const[f,v]of r){if(f<0||f>=o||v<0||v>=s)continue;const y=v*o+f;if(!c[y]&&!n[y]&&(c[y]=1,h[u]=f,l[u]=v,u++,E++,E>i))return{ok:!1,message:`Region too large (>${i}px). Increase Max region or fix gaps.`}}}return{ok:!0,mask:c}}function en(e,t,n,o){const s=new Uint8Array(n*o);for(let i=1;i<o-1;i++)for(let d=1;d<n-1;d++){const c=i*n+d;if(!e[c])continue;const h=(i-1)*n+d,l=(i+1)*n+d,b=i*n+(d-1),u=i*n+(d+1);(!e[h]||!e[l]||!e[b]||!e[u]||t[h]||t[l]||t[b]||t[u])&&(s[c]=1)}return s}function tn(e,t,n,o){const s=je(o),i=e.width,d=e.height;let c=Jt(e,s.edgesDark,s.edgeThreshold);c=Xt(c,i,d,s.edgeDilate);const h=Zt(t,n,c,i,d,s.maxRegionPx);if(!h.ok)return{ok:!1,message:h.message};const l=en(h.mask,c,i,d);return{ok:!0,preview:{mask:h.mask,outline:l,w:i,h:d}}}function nn(e,t,n){const o=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),s=n.replace("#",""),i=parseInt(s.slice(0,2),16),d=parseInt(s.slice(2,4),16),c=parseInt(s.slice(4,6),16),h=o.data;for(let l=0,b=0;l<t.mask.length;l++,b+=4)t.mask[l]&&(h[b+0]=i,h[b+1]=d,h[b+2]=c);return o}function ue(e,t,n){return Number.isFinite(e)?Math.max(t,Math.min(n,Math.trunc(e))):t}function ke(e){const t=(e||"").trim();if(!t)return null;const n=t.startsWith("#")?t:`#${t}`;return/^#[0-9a-fA-F]{6}$/.test(n)?n.toLowerCase():null}function on(e){let t="#ff3b30",n=[],o=null;function s(r){e.colorsStatusEl.textContent=r||""}function i(){const r=!!e.edgesDarkEl.checked,f=ue(parseInt(e.edgeMaskThresholdEl.value,10),0,255),v=ue(parseInt(e.edgeDilateEl.value,10),0,6),y=ue(parseInt(e.maxRegionPxEl.value,10),1e3,1e7);return e.edgeMaskThresholdEl.value=String(f),e.edgeDilateEl.value=String(v),e.maxRegionPxEl.value=String(y),je({edgesDark:r,edgeThreshold:f,edgeDilate:v,maxRegionPx:y})}function d(r){const f=ke(r);if(f){t=f;for(const v of Array.from(e.paletteEl.querySelectorAll(".paletteItem"))){const y=v.dataset.hex||"";v.classList.toggle("is-selected",y===t)}}}function c(){return t}function h(r){n=r.slice(),e.paletteEl.innerHTML="";for(const f of n){const v=ke(f);if(!v)continue;const y=document.createElement("button");y.type="button",y.className="paletteItem",y.style.background=v,y.dataset.hex=v,y.setAttribute("role","listitem"),y.setAttribute("aria-label",`Select ${v}`),y.addEventListener("click",()=>{d(v)}),e.paletteEl.appendChild(y)}d(t)}function l(r){const f=e.colorsCanvasEl;f.width=r.width,f.height=r.height,f.getContext("2d").putImageData(r,0,0)}function b(r,f){l(r);const v=e.colorsCanvasEl.getContext("2d"),{outline:y,w:m,h:p}=f,S=v.getImageData(0,0,m,p),x=S.data;for(let C=0,w=0;C<y.length;C++,w+=4)y[C]&&(x[w+0]=255,x[w+1]=60,x[w+2]=60,x[w+3]=220);v.putImageData(S,0,0)}function u(r){e.btnColorsApplyEl.disabled=!r}function E(r){e.btnColorsCancelEl.disabled=!r}function g(r){o=r}function a(){s("Idle"),u(!1),E(!1),e.colorsCanvasEl.addEventListener("click",r=>{if(!o)return;const f=e.colorsCanvasEl.getBoundingClientRect(),v=Math.floor((r.clientX-f.left)/f.width*e.colorsCanvasEl.width),y=Math.floor((r.clientY-f.top)/f.height*e.colorsCanvasEl.height);o(v,y)})}return{bind:a,setStatus:s,getSettings:i,setSelectedColor:d,getSelectedColor:c,renderPalette:h,drawBase:l,drawPreview:b,setApplyEnabled:u,setCancelEnabled:E,onCanvasClick:g}}const an=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#a2845e","#8e8e93","#1c1c1e","#ffffff","#000000","#4cd964","#5ac8fa","#ff6b6b","#7aa2ff","#f5a623","#50e3c2"];function sn(e,t){const n=on(e);let o=null,s=null;function i(u){n.setStatus(u)}function d(){const u=e.outCanvasEl.getContext("2d");if(!u)return null;const E=e.outCanvasEl.width,g=e.outCanvasEl.height;return E<=0||g<=0?null:u.getImageData(0,0,E,g)}function c(){const u=d();if(!u){o=null,s=null,n.setApplyEnabled(!1),n.setCancelEnabled(!1),i("No output available. Run Process first.");return}o=u,s=null,n.drawBase(o),n.setApplyEnabled(!1),n.setCancelEnabled(!1),i("Ready. Pick a color, click inside a region.")}function h(){if(o){n.drawBase(o);return}const u=d();if(!u){i("No output available. Run Process first.");return}o=u,s=null,n.drawBase(o),n.setApplyEnabled(!1),n.setCancelEnabled(!1),i("Loaded output. Pick a color, click inside a region.")}function l(){if(!o||!s)return;const u=n.getSelectedColor();o=nn(o,s,u),s=null,n.drawBase(o),n.setApplyEnabled(!1),n.setCancelEnabled(!1),i("Fill applied. Click another region.")}function b(){o&&(s=null,n.drawBase(o),n.setApplyEnabled(!1),n.setCancelEnabled(!1),i("Preview canceled."))}return{bind(){n.bind(),n.renderPalette(an),n.onCanvasClick((u,E)=>{if(!o){i("No output available. Run Process first.");return}const g=n.getSettings(),a=tn(o,u,E,g);if(!a.ok){s=null,n.setApplyEnabled(!1),n.setCancelEnabled(!1),i(a.message);return}s=a.preview,n.drawPreview(o,s),n.setApplyEnabled(!0),n.setCancelEnabled(!0),i("Preview shown. Apply fill or cancel.")}),e.btnColorsApplyEl.addEventListener("click",()=>l()),e.btnColorsCancelEl.addEventListener("click",()=>b()),e.btnColorsResetEl.addEventListener("click",()=>c()),e.tabColors.addEventListener("click",()=>{queueMicrotask(()=>h())}),i("Idle"),n.setApplyEnabled(!1),n.setCancelEnabled(!1)}}}const oe="beecontour.actionLog",rn=5e3;function ln(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function cn(e){return Array.isArray(e)?e:[e]}function ae(e,t,n){return Math.max(t,Math.min(n,Math.floor(e)))}async function Y(){const e=await J(oe),t=e==null?void 0:e[oe];return Array.isArray(t)?t:[]}async function ze(e){await X({[oe]:e})}async function H(e,t){const n=ae(rn,100,5e4),s=cn(e).map(h=>({...h,id:ln(),ts:Date.now()}));if(!s.length)return{total:(await Y()).length};const d=(await Y()).concat(s),c=d.length>n?d.slice(d.length-n):d;return await ze(c),{total:c.length}}async function un(e){const t=ae((e==null?void 0:e.limit)??200,1,5e4),n=ae((e==null?void 0:e.offset)??0,0,1e6);let s=await Y();e!=null&&e.kind&&(s=s.filter(c=>c.kind===e.kind)),e!=null&&e.scope&&(s=s.filter(c=>c.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(s=s.filter(c=>c.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(s=s.filter(c=>c.ts<=e.untilTs));const i=s.length;s=s.slice().reverse();const d=s.slice(n,n+t);return{total:i,items:d}}async function dn(e){let n=await Y();if(typeof e.beforeTs=="number"&&(n=n.filter(o=>o.ts>=e.beforeTs)),typeof e.keepLast=="number"){const o=ae(e.keepLast,0,5e4);o===0?n=[]:n.length>o&&(n=n.slice(n.length-o))}return await ze(n),{total:n.length}}async function gn(){await ye(oe)}async function fn(e){const t=await Y();return JSON.stringify(t,null,2)}const Te="0.0.4";function bn(){let e=!1,t={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},n=!1,o="",s="";function i(l){e=l}function d(l){t={...t,...l}}function c(l){n=l}function h(l){typeof l.general=="string"&&(o=l.general),typeof l.dev=="string"&&(s=l.dev)}return{get showDevTools(){return e},get dev(){return t},get debugEnabled(){return n},get generalStatus(){return o},get devStatus(){return s},setShowDevTools:i,setDev:d,setDebugEnabled:c,setStatus:h}}function hn(e){function t(l){e.settingsGeneralStatusEl.textContent=l||""}function n(l){e.cfgStatusEl.textContent=l||""}function o(l){e.cfgShowDevToolsEl.checked=l}function s(l){e.tabLogs.hidden=!l,e.devConfigDetailsEl.classList.toggle("is-hidden",!l),l||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function i(l){e.cfgTraceConsoleEl.checked=!!l.traceConsole,e.cfgActionLogMaxEl.value=String(l.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(l.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(l.failureLogsPerRun??50)}function d(l){e.logsCbDebugEl.checked=l}function c(l,b){e.settingsVersionEl.textContent=l||"—",e.settingsGitHubLinkEl.href=b||"#",e.settingsGitHubLinkEl.hidden=!b}function h(l){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=l,e.cfgActionLogMaxEl.disabled=l,e.cfgDebugTraceMaxEl.disabled=l,e.cfgFailureLogsPerRunEl.disabled=l,e.btnCfgResetDefaults.disabled=l,e.logsCbDebugEl.disabled=l}return{setGeneralStatus:t,setDevStatus:n,setShowDevToolsChecked:o,setDevToolsVisible:s,setDevConfig:i,setDebugEnabledChecked:d,setAbout:c,setBusy:h}}const de="template.settings.showDevTools";function vn(){var e,t;try{const n=(e=globalThis==null?void 0:globalThis.chrome)==null?void 0:e.runtime,o=(t=n==null?void 0:n.getManifest)==null?void 0:t.call(n),s=typeof(o==null?void 0:o.version)=="string"?o.version:"";if(j("Settings: getManifestVersion manifest found version is ",{v:s}),s)return s}catch{}return j("Settings: getManifestVersion fallback",{APP_VERSION:Te}),Te}function ge(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??A.actionLogMax),debugTraceMax:Number(e.debugTraceMax??A.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??A.failureLogsPerRun)}}function En(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:U(e.cfgActionLogMaxEl.value,100,5e4,A.actionLogMax),debugTraceMax:U(e.cfgDebugTraceMaxEl.value,100,5e4,A.debugTraceMax),failureLogsPerRun:U(e.cfgFailureLogsPerRunEl.value,0,5e4,A.failureLogsPerRun)}}async function Le(e){const t=Ve;return typeof t.setEnabled=="function"?(await t.setEnabled(e),{ok:!0}):typeof t.enable=="function"&&typeof t.disable=="function"?(await(e?t.enable():t.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function yn(e,t){const n=bn(),o=hn(e);async function s(){const r=await J([de]).catch(()=>({}));return(r==null?void 0:r[de])===!0}async function i(r){await X({[de]:!!r}).catch(()=>null)}function d(r){n.setShowDevTools(r),o.setShowDevToolsChecked(r),o.setDevToolsVisible(r),r||e.tabSettings.click()}async function c(){const r=await s();d(r),j("Settings: boot applyDevToolsVisibility",{showDevTools:r})}async function h(){var m;o.setBusy(P());const r=await s();d(r),await Se().catch(()=>null);const f=Ee();n.setDev(ge(f)),o.setDevConfig(n.dev);const v=Ve;let y=!1;try{typeof v.isEnabled=="function"?y=!!await v.isEnabled():y=!!v.enabled}catch(p){V("Settings: failed to read debug enabled state",{error:p instanceof Error?p.message:String(p)})}n.setDebugEnabled(y),o.setDebugEnabledChecked(y),o.setAbout(vn()||"—",((m=e.settingsGitHubLinkEl)==null?void 0:m.href)||"#"),o.setGeneralStatus(""),o.setDevStatus(""),j("Settings: loaded",{showDevTools:r,enabled:y,dev:n.dev})}async function l(){const r=!!e.cfgShowDevToolsEl.checked;d(r),await i(r),H({kind:"run",scope:"settings",message:r?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:r}}),j("Settings: ui toggle showDevTools",{showDevTools:r}),o.setGeneralStatus(r?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>o.setGeneralStatus(""),1200)}async function b(){const r=En(e);o.setDevStatus("Saving…");try{await _e(r)}catch(f){N("Settings: failed to save dev config",{error:f instanceof Error?f.message:String(f),next:r}),o.setDevStatus("Save failed."),setTimeout(()=>o.setDevStatus(""),1200);return}n.setDev(ge(r)),o.setDevConfig(n.dev),H({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:r}),j("Settings: devConfig updated",r),o.setDevStatus("Saved."),setTimeout(()=>o.setDevStatus(""),1200)}async function u(){o.setDevStatus("Resetting…");try{await _t(),await Se().catch(()=>null);const f=Ee();n.setDev(ge(f)),o.setDevConfig(n.dev)}catch(f){N("Settings: failed to reset dev config defaults",{error:f instanceof Error?f.message:String(f)}),o.setDevStatus("Reset failed."),setTimeout(()=>o.setDevStatus(""),1200);return}const r=await Le(!1);r.ok?(n.setDebugEnabled(!1),o.setDebugEnabledChecked(!1)):(V("Settings: failed to reset debug enabled state",{error:r.error||"unknown error"}),H({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:r.error||"unknown error"})),H({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...A,debugEnabled:!1}}),j("Settings: reset defaults",{...A,debugEnabled:!1}),o.setDevStatus("Reset."),setTimeout(()=>o.setDevStatus(""),1200)}async function E(){const r=!!e.logsCbDebugEl.checked;o.setDevStatus("Saving…");const f=await Le(r);if(!f.ok){e.logsCbDebugEl.checked=!r,o.setDevStatus(`Save failed: ${f.error||"unknown error"}`),N("Settings: failed to change debug enabled state",{error:f.error||"unknown error",enabled:r}),H({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:f.error||"unknown error",meta:{enabled:r}});return}n.setDebugEnabled(r),H({kind:"run",scope:"settings",message:r?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:r}}),j("Settings: debug enabled changed",{enabled:r}),o.setDevStatus("Saved."),setTimeout(()=>o.setDevStatus(""),1200)}const g=t.on(()=>{});function a(){e.cfgShowDevToolsEl.addEventListener("change",()=>{l()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{P()||b()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{P()||b()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{P()||b()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{P()||b()}),e.btnCfgResetDefaults.addEventListener("click",()=>{P()||u()}),e.logsCbDebugEl.addEventListener("change",()=>{P()||E()}),c().catch(r=>{V("Settings: initDevToolsVisibility failed",{error:r instanceof Error?r.message:String(r)})})}return{id:"settings",refresh(){h().catch(r=>{N("Settings: refresh failed",{error:r instanceof Error?r.message:String(r)})})},mount(){h().catch(r=>{N("Settings: mount failed",{error:r instanceof Error?r.message:String(r)})})},unmount(){},bind:a,dispose(){g()}}}function mn(){let e=[],t=0;function n(o){e=o.items,t=o.total}return{get items(){return e},get total(){return t},set:n}}function pn(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function Ie(e,t){const n=[];n.push(`Total entries: ${t.total}`),n.push("");for(const o of t.items){const s=typeof o.ok=="boolean"?o.ok?"ok":"fail":"",i=[];typeof o.status=="number"&&i.push(`status=${o.status}`),s&&i.push(s);const d=[o.scope,o.kind].filter(Boolean).join("/");n.push(`[${pn(o.ts)}] ${d}${i.length?` (${i.join(", ")})`:""}`),n.push(`  ${o.message}`),o.error&&n.push(`  error: ${o.error}`),n.push("")}e.textContent=n.join(`
`),e.scrollTop=0}function Cn(e){function t(d){e.logsStatusEl.textContent=d}function n(d){e.debugStatusEl.textContent=d}function o(d){e.logsCbDebugEl.checked=d}function s(d){Ie(e.logsOutEl,{total:d.total,items:d.items.map(c=>({ts:c.ts,message:c.message,scope:c.scope,kind:c.kind,ok:c.ok,status:c.status,error:c.error,meta:c.meta}))})}function i(d){Ie(e.debugOutEl,{total:d.total,items:d.items.map(c=>({ts:c.ts,message:c.message,scope:c.scope,kind:c.kind,ok:c.ok,status:c.status,error:c.error,meta:c.meta}))})}return{setAuditStatus:t,setDebugStatus:n,setDebugChecked:o,renderAudit:s,renderDebug:i}}const Me="beecontour";function wn(e,t){const n=mn(),o=Cn(e);async function s(){o.setAuditStatus("Loading…"),F(e,!0);try{const a=U(e.logsLimitEl.value,10,5e3,200),r=await un({limit:a,reverse:!0});n.set(r),o.renderAudit({items:n.items,total:n.total}),o.setAuditStatus(`Showing ${n.items.length} (newest first)`)}catch(a){o.setAuditStatus(`Failed: ${(a==null?void 0:a.message)||String(a)}`)}finally{F(e,!1)}}async function i(){o.setDebugStatus("Loading…"),F(e,!0);try{const a=U(e.debugLimitEl.value,10,5e3,200),r=await Ne({limit:a,reverse:!0});o.renderDebug(r),o.setDebugStatus(`Showing ${r.items.length} (newest first)`)}catch(a){o.setDebugStatus(`Failed: ${(a==null?void 0:a.message)||String(a)}`)}finally{F(e,!1)}}async function d(){const a=await me();o.setDebugChecked(a)}async function c(a){if(await Pe(a),o.setDebugChecked(a),!a){o.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}o.setDebugStatus("Debug ON."),await i()}async function h(){const a=U(e.logsTrimKeepEl.value,0,5e4,2e3);o.setAuditStatus("Trimming…"),F(e,!0);try{const r=await dn({keepLast:a});await s(),o.setAuditStatus(`Trimmed. Remaining: ${r.total}`)}catch(r){o.setAuditStatus(`Trim failed: ${(r==null?void 0:r.message)||String(r)}`)}finally{F(e,!1)}}async function l(){o.setAuditStatus("Clearing…"),F(e,!0);try{await gn(),await s(),o.setAuditStatus("Cleared.")}catch(a){o.setAuditStatus(`Clear failed: ${(a==null?void 0:a.message)||String(a)}`)}finally{F(e,!1)}}async function b(){o.setAuditStatus("Exporting…");try{const a=await fn({pretty:!0}),r=new Blob([a],{type:"application/json"}),f=URL.createObjectURL(r),v=document.createElement("a");v.href=f,v.download=`${Me}-audit-${Date.now()}.json`,v.click(),setTimeout(()=>URL.revokeObjectURL(f),1e3),o.setAuditStatus("Exported.")}catch(a){o.setAuditStatus(`Export failed: ${(a==null?void 0:a.message)||String(a)}`)}}async function u(){o.setDebugStatus("Clearing…"),F(e,!0);try{await $e(),await i(),o.setDebugStatus("Cleared.")}catch(a){o.setDebugStatus(`Clear failed: ${(a==null?void 0:a.message)||String(a)}`)}finally{F(e,!1)}}async function E(){o.setDebugStatus("Exporting…");try{const a=await Fe({pretty:!0}),r=new Blob([a],{type:"application/json"}),f=URL.createObjectURL(r),v=document.createElement("a");v.href=f,v.download=`${Me}-debug-${Date.now()}.json`,v.click(),setTimeout(()=>URL.revokeObjectURL(f),1e3),o.setDebugStatus("Exported.")}catch(a){o.setDebugStatus(`Export failed: ${(a==null?void 0:a.message)||String(a)}`)}}function g(){e.btnLogsRefresh.addEventListener("click",()=>{P()||s()}),e.btnLogsTrim.addEventListener("click",()=>{P()||h()}),e.btnLogsClear.addEventListener("click",()=>{P()||l()}),e.btnLogsExport.addEventListener("click",()=>{P()||b()}),e.logsCbDebugEl.addEventListener("change",()=>{P()||c(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{P()||i()}),e.btnDebugClear.addEventListener("click",()=>{P()||u()}),e.btnDebugExport.addEventListener("click",()=>{P()||E()})}return{id:"logs",bind:g,mount(){d(),s(),i()},unmount(){},dispose(){}}}(function(){const t=xt(),n=Tt();n.start();const o=It();globalThis.__APP__={...globalThis.__APP__,cache:o};const s=Wt(t),i=sn(t),d=yn(t,n),c=wn(t);s.bind(),i.bind(),d.bind(),c.bind();const h=Lt(t,{contour:s,colors:i,settings:d,logs:c});h.bind(),h.boot()})();
