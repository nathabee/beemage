function We(){function e(Ee,Ye){if(!Ee)throw new Error(`[dom] Missing #${Ye}`);return Ee}const t=e(document.getElementById("appRoot"),"appRoot"),s=e(document.getElementById("tabContour"),"tabContour"),n=e(document.getElementById("tabColors"),"tabColors"),o=e(document.getElementById("tabSettings"),"tabSettings"),r=e(document.getElementById("tabLogs"),"tabLogs"),i=e(document.getElementById("viewContour"),"viewContour"),l=e(document.getElementById("viewColors"),"viewColors"),g=e(document.getElementById("viewSettings"),"viewSettings"),a=e(document.getElementById("viewLogs"),"viewLogs"),E=e(document.getElementById("dropZone"),"dropZone"),h=e(document.getElementById("fileInput"),"fileInput"),m=e(document.getElementById("btnProcess"),"btnProcess"),v=e(document.getElementById("btnDownload"),"btnDownload"),u=e(document.getElementById("contourStatus"),"contourStatus"),c=e(document.getElementById("contourSpinner"),"contourSpinner"),d=e(document.getElementById("srcCanvas"),"srcCanvas"),f=e(document.getElementById("outCanvas"),"outCanvas"),b=e(document.getElementById("edgeThreshold"),"edgeThreshold"),y=e(document.getElementById("invertOutput"),"invertOutput"),I=e(document.getElementById("colorsCanvas"),"colorsCanvas"),R=e(document.getElementById("palette"),"palette"),k=e(document.getElementById("btnColorsApply"),"btnColorsApply"),C=e(document.getElementById("btnColorsCancel"),"btnColorsCancel"),w=e(document.getElementById("btnColorsReset"),"btnColorsReset"),O=e(document.getElementById("edgesDark"),"edgesDark"),N=e(document.getElementById("edgeMaskThreshold"),"edgeMaskThreshold"),j=e(document.getElementById("edgeDilate"),"edgeDilate"),F=e(document.getElementById("maxRegionPx"),"maxRegionPx"),V=e(document.getElementById("colorsStatus"),"colorsStatus"),P=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),Z=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),x=e(document.getElementById("devConfigDetails"),"devConfigDetails"),p=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),D=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),T=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),A=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),_=e(document.getElementById("logsCbDebug"),"logsCbDebug"),oe=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),G=e(document.getElementById("cfgStatus"),"cfgStatus"),K=e(document.getElementById("settingsVersion"),"settingsVersion"),X=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),$e=e(document.getElementById("logsLimit"),"logsLimit"),Oe=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),Fe=e(document.getElementById("logsStatus"),"logsStatus"),_e=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),Ue=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),Ne=e(document.getElementById("btnLogsExport"),"btnLogsExport"),je=e(document.getElementById("btnLogsClear"),"btnLogsClear"),Ve=e(document.getElementById("logsOut"),"logsOut"),Ge=e(document.getElementById("debugLimit"),"debugLimit"),Ke=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),He=e(document.getElementById("btnDebugExport"),"btnDebugExport"),qe=e(document.getElementById("btnDebugClear"),"btnDebugClear"),ze=e(document.getElementById("debugStatus"),"debugStatus"),Je=e(document.getElementById("debugOut"),"debugOut");return{rootEl:t,tabContour:s,tabColors:n,tabSettings:o,tabLogs:r,viewContour:i,viewColors:l,viewSettings:g,viewLogs:a,dropZoneEl:E,fileInputEl:h,btnProcessEl:m,btnDownloadEl:v,contourStatusEl:u,contourSpinnerEl:c,srcCanvasEl:d,outCanvasEl:f,edgeThresholdEl:b,invertOutputEl:y,colorsCanvasEl:I,paletteEl:R,btnColorsApplyEl:k,btnColorsCancelEl:C,btnColorsResetEl:w,edgesDarkEl:O,edgeMaskThresholdEl:N,edgeDilateEl:j,maxRegionPxEl:F,colorsStatusEl:V,cfgShowDevToolsEl:P,settingsGeneralStatusEl:Z,devConfigDetailsEl:x,cfgTraceConsoleEl:p,cfgActionLogMaxEl:D,cfgDebugTraceMaxEl:T,cfgFailureLogsPerRunEl:A,logsCbDebugEl:_,btnCfgResetDefaults:oe,cfgStatusEl:G,settingsVersionEl:K,settingsGitHubLinkEl:X,logsLimitEl:$e,btnLogsRefresh:Oe,logsStatusEl:Fe,logsTrimKeepEl:_e,btnLogsTrim:Ue,btnLogsExport:Ne,btnLogsClear:je,logsOutEl:Ve,debugLimitEl:Ge,btnDebugRefresh:Ke,btnDebugExport:He,btnDebugClear:qe,debugStatusEl:ze,debugOutEl:Je}}const Ze=new Set;function Xe(e){Ze.add(e)}function Qe(){const e=new Set;function t(n){return e.add(n),()=>e.delete(n)}function s(){Xe(o=>{for(const r of e)r(o)})}return{on:t,start:s}}function et(e,t){const s={contour:e.tabContour,colors:e.tabColors,settings:e.tabSettings,logs:e.tabLogs},n={contour:e.viewContour,colors:e.viewColors,settings:e.viewSettings,logs:e.viewLogs};function o(l){Object.keys(s).forEach(g=>{const a=g===l;s[g].classList.toggle("is-active",a),s[g].setAttribute("aria-selected",a?"true":"false"),n[g].hidden=!a,n[g].classList.toggle("is-active",a)})}function r(){s.contour.addEventListener("click",()=>o("contour")),s.colors.addEventListener("click",()=>o("colors")),s.settings.addEventListener("click",()=>o("settings")),s.logs.addEventListener("click",()=>o("logs"))}function i(){o("contour"),Object.keys(t).forEach(l=>{var g,a;return(a=(g=t[l]).boot)==null?void 0:a.call(g)})}return{bind:r,boot:i}}function he(e){const t=e.items.length;return{items:e.items,counts:{items:t},meta:e.meta}}function tt(){const e={items:[],meta:{}},t=new Set;function s(){const a=he(e);for(const E of t)try{E(a)}catch{}}function n(){return he(e)}function o(a){t.add(a);try{a(n())}catch{}return()=>t.delete(a)}function r(){e.items=[],e.meta={},s()}function i(a){e.meta.scopeUpdatedSince=a,s()}function l(){return String(e.meta.scopeUpdatedSince||"")}function g(a,E){e.items=a.slice(),e.meta.updatedTs=Date.now(),typeof(E==null?void 0:E.limit)=="number"&&(e.meta.limit=E.limit),s()}return{getSnapshot:n,subscribe:o,getScopeUpdatedSince:l,clearAll:r,setScopeUpdatedSince:i,setItems:g}}let $=0;function S(){return $>0}async function ve(e,t){Se(e);try{return await t()}finally{nt(e)}}function M(e,t){if(t){Se(e);return}$=0,Q(e,!1)}function Se(e){$++,$===1&&Q(e,!0)}function nt(e){if($--,$<=0){$=0,Q(e,!1);return}$===0&&Q(e,!1)}function Q(e,t){e.rootEl.classList.toggle("is-busy",t),e.cfgShowDevToolsEl.disabled=!1,e.fileInputEl.disabled=t,e.btnProcessEl.disabled=t,e.btnDownloadEl.disabled=t,e.edgeThresholdEl.disabled=t,e.invertOutputEl.disabled=t,e.cfgTraceConsoleEl.disabled=t,e.cfgActionLogMaxEl.disabled=t,e.cfgDebugTraceMaxEl.disabled=t,e.cfgFailureLogsPerRunEl.disabled=t,e.btnCfgResetDefaults.disabled=t,e.logsCbDebugEl.disabled=t,e.logsLimitEl.disabled=t,e.btnLogsRefresh.disabled=t,e.logsTrimKeepEl.disabled=t,e.btnLogsTrim.disabled=t,e.btnLogsExport.disabled=t,e.btnLogsClear.disabled=t,e.debugLimitEl.disabled=t,e.btnDebugRefresh.disabled=t,e.btnDebugExport.disabled=t,e.btnDebugClear.disabled=t,e.btnColorsApplyEl.disabled=t,e.btnColorsCancelEl.disabled=t,e.btnColorsResetEl.disabled=t,e.edgesDarkEl.disabled=t,e.edgeMaskThresholdEl.disabled=t,e.edgeDilateEl.disabled=t,e.maxRegionPxEl.disabled=t;for(const s of Array.from(e.paletteEl.querySelectorAll("button")))s.disabled=t;e.colorsCanvasEl.style.pointerEvents=t?"none":"auto"}function st(e,t){let s=null,n=!1;function o(d){e.contourStatusEl.textContent=d}function r(d,f){e.contourSpinnerEl.classList.toggle("is-hidden",!d),f&&o(f)}function i(){e.btnProcessEl.disabled=!n,e.btnDownloadEl.disabled=!n}function l(){const d=e.srcCanvasEl.getContext("2d"),f=e.outCanvasEl.getContext("2d");d.clearRect(0,0,e.srcCanvasEl.width,e.srcCanvasEl.height),f.clearRect(0,0,e.outCanvasEl.width,e.outCanvasEl.height)}async function g(d){if(!d.type.startsWith("image/")){o("Unsupported file type (please drop an image).");return}await ve(e,async()=>{r(!0,"Loading image…"),s=d.name||"image";const f=URL.createObjectURL(d);try{const b=await new Promise((F,V)=>{const P=new Image;P.onload=()=>F(P),P.onerror=()=>V(new Error("Failed to load image")),P.src=f}),y=e.srcCanvasEl,I=y.getContext("2d");l();const R=y.width,k=y.height,C=Math.min(R/b.width,k/b.height),w=Math.max(1,Math.floor(b.width*C)),O=Math.max(1,Math.floor(b.height*C)),N=Math.floor((R-w)/2),j=Math.floor((k-O)/2);I.drawImage(b,N,j,w,O),n=!0,i(),o(`Loaded: ${s}`)}finally{URL.revokeObjectURL(f),r(!1)}})}function a(d,f){const b=Number(d.value);return Number.isFinite(b)?b:f}async function E(){n&&await ve(e,async()=>{r(!0,"Processing…"),await new Promise(d=>{setTimeout(()=>{try{const f=e.srcCanvasEl,b=e.outCanvasEl,y=f.getContext("2d"),I=b.getContext("2d"),R=y.getImageData(0,0,f.width,f.height),{data:k,width:C,height:w}=R,O=new Uint8ClampedArray(C*w);for(let p=0,D=0;p<k.length;p+=4,D++){const T=k[p],A=k[p+1],_=k[p+2];O[D]=.299*T+.587*A+.114*_|0}const N=[-1,0,1,-2,0,2,-1,0,1],j=[-1,-2,-1,0,0,0,1,2,1],F=new Uint8ClampedArray(C*w),V=Math.max(1,Math.min(255,a(e.edgeThresholdEl,70))),P=e.invertOutputEl.checked;for(let p=1;p<w-1;p++)for(let D=1;D<C-1;D++){let T=0,A=0,_=0;for(let G=-1;G<=1;G++)for(let K=-1;K<=1;K++){const X=O[(p+G)*C+(D+K)];T+=X*N[_],A+=X*j[_],_++}const oe=Math.min(255,Math.sqrt(T*T+A*A)|0);F[p*C+D]=oe>=V?255:0}const Z=I.createImageData(C,w),x=Z.data;for(let p=0,D=0;p<F.length;p++,D+=4){const T=F[p];if(P){const A=T===255;x[D]=A?0:255,x[D+1]=A?0:255,x[D+2]=A?0:255,x[D+3]=255}else x[D]=T,x[D+1]=T,x[D+2]=T,x[D+3]=255}b.width=f.width,b.height=f.height,I.putImageData(Z,0,0),o("Done. You can download the PNG.")}finally{d()}},0)}),r(!1),i()})}function h(){if(!n)return;const f=`${(s||"beecontour").replace(/\.[a-z0-9]+$/i,"").replace(/[^a-z0-9-_]+/gi,"_")}_contour.png`,b=e.outCanvasEl.toDataURL("image/png"),y=document.createElement("a");y.href=b,y.download=f,document.body.appendChild(y),y.click(),y.remove(),o(`Downloaded: ${f}`)}function m(){const d=e.dropZoneEl;function f(b){d.classList.toggle("is-hover",b)}d.addEventListener("dragover",b=>{b.preventDefault(),f(!0)}),d.addEventListener("dragleave",()=>f(!1)),d.addEventListener("drop",b=>{var I;b.preventDefault(),f(!1);const y=(I=b.dataTransfer)==null?void 0:I.files;!y||y.length===0||g(y[0])}),e.fileInputEl.addEventListener("change",()=>{var y;const b=(y=e.fileInputEl.files)==null?void 0:y[0];b&&(g(b),e.fileInputEl.value="")})}function v(){m(),e.btnProcessEl.addEventListener("click",()=>void E()),e.btnDownloadEl.addEventListener("click",()=>h()),n=!1,i(),o("No image loaded"),e.contourSpinnerEl.classList.add("is-hidden")}function u(){}function c(){}return{id:"contour",bind:v,mount:u,unmount:c}}function ae(e,t,s){return Number.isFinite(e)?Math.max(t,Math.min(s,Math.trunc(e))):t}function ot(e,t,s){return Math.round(.2126*e+.7152*t+.0722*s)}function Le(e){return{edgesDark:!!(e.edgesDark??!0),edgeThreshold:ae(e.edgeThreshold??80,0,255),edgeDilate:ae(e.edgeDilate??2,0,6),maxRegionPx:ae(e.maxRegionPx??2e5,1e3,1e7)}}function at(e,t,s){const{data:n,width:o,height:r}=e,i=new Uint8Array(o*r);for(let l=0,g=0;l<i.length;l++,g+=4){const a=n[g+0],E=n[g+1],h=n[g+2];if(n[g+3]===0){i[l]=0;continue}const v=ot(a,E,h),u=t?v<=s:v>=255-s;i[l]=u?1:0}return i}function it(e,t,s,n){if(n<=0)return e;let o=e;for(let r=0;r<n;r++){const i=new Uint8Array(t*s);for(let l=0;l<s;l++)for(let g=0;g<t;g++){const a=l*t+g;if(o[a]){i[a]=1;continue}let E=0;for(let h=-1;h<=1&&!E;h++){const m=l+h;if(!(m<0||m>=s))for(let v=-1;v<=1;v++){const u=g+v;if(!(u<0||u>=t)&&o[m*t+u]){E=1;break}}}i[a]=E}o=i}return o}function lt(e,t,s,n,o,r){const i=t*n+e;if(s[i])return{ok:!1,message:"Click is on an edge; pick inside a region."};const l=new Uint8Array(n*o),g=new Int32Array(n*o),a=new Int32Array(n*o);let E=0,h=0;g[h]=e,a[h]=t,h++,l[i]=1;let m=1;for(;E<h;){const v=g[E],u=a[E];E++;const c=[[v-1,u],[v+1,u],[v,u-1],[v,u+1]];for(const[d,f]of c){if(d<0||d>=n||f<0||f>=o)continue;const b=f*n+d;if(!l[b]&&!s[b]&&(l[b]=1,g[h]=d,a[h]=f,h++,m++,m>r))return{ok:!1,message:`Region too large (>${r}px). Increase Max region or fix gaps.`}}}return{ok:!0,mask:l}}function ct(e,t,s,n){const o=new Uint8Array(s*n);for(let r=1;r<n-1;r++)for(let i=1;i<s-1;i++){const l=r*s+i;if(!e[l])continue;const g=(r-1)*s+i,a=(r+1)*s+i,E=r*s+(i-1),h=r*s+(i+1);(!e[g]||!e[a]||!e[E]||!e[h]||t[g]||t[a]||t[E]||t[h])&&(o[l]=1)}return o}function rt(e,t,s,n){const o=Le(n),r=e.width,i=e.height;let l=at(e,o.edgesDark,o.edgeThreshold);l=it(l,r,i,o.edgeDilate);const g=lt(t,s,l,r,i,o.maxRegionPx);if(!g.ok)return{ok:!1,message:g.message};const a=ct(g.mask,l,r,i);return{ok:!0,preview:{mask:g.mask,outline:a,w:r,h:i}}}function ut(e,t,s){const n=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),o=s.replace("#",""),r=parseInt(o.slice(0,2),16),i=parseInt(o.slice(2,4),16),l=parseInt(o.slice(4,6),16),g=n.data;for(let a=0,E=0;a<t.mask.length;a++,E+=4)t.mask[a]&&(g[E+0]=r,g[E+1]=i,g[E+2]=l);return n}function ie(e,t,s){return Number.isFinite(e)?Math.max(t,Math.min(s,Math.trunc(e))):t}function ye(e){const t=(e||"").trim();if(!t)return null;const s=t.startsWith("#")?t:`#${t}`;return/^#[0-9a-fA-F]{6}$/.test(s)?s.toLowerCase():null}function gt(e){let t="#ff3b30",s=[],n=null;function o(c){e.colorsStatusEl.textContent=c||""}function r(){const c=!!e.edgesDarkEl.checked,d=ie(parseInt(e.edgeMaskThresholdEl.value,10),0,255),f=ie(parseInt(e.edgeDilateEl.value,10),0,6),b=ie(parseInt(e.maxRegionPxEl.value,10),1e3,1e7);return e.edgeMaskThresholdEl.value=String(d),e.edgeDilateEl.value=String(f),e.maxRegionPxEl.value=String(b),Le({edgesDark:c,edgeThreshold:d,edgeDilate:f,maxRegionPx:b})}function i(c){const d=ye(c);if(d){t=d;for(const f of Array.from(e.paletteEl.querySelectorAll(".paletteItem"))){const b=f.dataset.hex||"";f.classList.toggle("is-selected",b===t)}}}function l(){return t}function g(c){s=c.slice(),e.paletteEl.innerHTML="";for(const d of s){const f=ye(d);if(!f)continue;const b=document.createElement("button");b.type="button",b.className="paletteItem",b.style.background=f,b.dataset.hex=f,b.setAttribute("role","listitem"),b.setAttribute("aria-label",`Select ${f}`),b.addEventListener("click",()=>{i(f)}),e.paletteEl.appendChild(b)}i(t)}function a(c){const d=e.colorsCanvasEl;d.width=c.width,d.height=c.height,d.getContext("2d").putImageData(c,0,0)}function E(c,d){a(c);const f=e.colorsCanvasEl.getContext("2d"),{outline:b,w:y,h:I}=d,R=f.getImageData(0,0,y,I),k=R.data;for(let C=0,w=0;C<b.length;C++,w+=4)b[C]&&(k[w+0]=255,k[w+1]=60,k[w+2]=60,k[w+3]=220);f.putImageData(R,0,0)}function h(c){e.btnColorsApplyEl.disabled=!c}function m(c){e.btnColorsCancelEl.disabled=!c}function v(c){n=c}function u(){o("Idle"),h(!1),m(!1),e.colorsCanvasEl.addEventListener("click",c=>{if(!n)return;const d=e.colorsCanvasEl.getBoundingClientRect(),f=Math.floor((c.clientX-d.left)/d.width*e.colorsCanvasEl.width),b=Math.floor((c.clientY-d.top)/d.height*e.colorsCanvasEl.height);n(f,b)})}return{bind:u,setStatus:o,getSettings:r,setSelectedColor:i,getSelectedColor:l,renderPalette:g,drawBase:a,drawPreview:E,setApplyEnabled:h,setCancelEnabled:m,onCanvasClick:v}}const dt=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#a2845e","#8e8e93","#1c1c1e","#ffffff","#000000","#4cd964","#5ac8fa","#ff6b6b","#7aa2ff","#f5a623","#50e3c2"];function ft(e,t){const s=gt(e);let n=null,o=null;function r(h){s.setStatus(h)}function i(){const h=e.outCanvasEl.getContext("2d");if(!h)return null;const m=e.outCanvasEl.width,v=e.outCanvasEl.height;return m<=0||v<=0?null:h.getImageData(0,0,m,v)}function l(){const h=i();if(!h){n=null,o=null,s.setApplyEnabled(!1),s.setCancelEnabled(!1),r("No output available. Run Process first.");return}n=h,o=null,s.drawBase(n),s.setApplyEnabled(!1),s.setCancelEnabled(!1),r("Ready. Pick a color, click inside a region.")}function g(){if(n){s.drawBase(n);return}const h=i();if(!h){r("No output available. Run Process first.");return}n=h,o=null,s.drawBase(n),s.setApplyEnabled(!1),s.setCancelEnabled(!1),r("Loaded output. Pick a color, click inside a region.")}function a(){if(!n||!o)return;const h=s.getSelectedColor();n=ut(n,o,h),o=null,s.drawBase(n),s.setApplyEnabled(!1),s.setCancelEnabled(!1),r("Fill applied. Click another region.")}function E(){n&&(o=null,s.drawBase(n),s.setApplyEnabled(!1),s.setCancelEnabled(!1),r("Preview canceled."))}return{bind(){s.bind(),s.renderPalette(dt),s.onCanvasClick((h,m)=>{if(!n){r("No output available. Run Process first.");return}const v=s.getSettings(),u=rt(n,h,m,v);if(!u.ok){o=null,s.setApplyEnabled(!1),s.setCancelEnabled(!1),r(u.message);return}o=u.preview,s.drawPreview(n,o),s.setApplyEnabled(!0),s.setCancelEnabled(!0),r("Preview shown. Apply fill or cancel.")}),e.btnColorsApplyEl.addEventListener("click",()=>a()),e.btnColorsCancelEl.addEventListener("click",()=>E()),e.btnColorsResetEl.addEventListener("click",()=>l()),e.tabColors.addEventListener("click",()=>{queueMicrotask(()=>g())}),r("Idle"),s.setApplyEnabled(!1),s.setCancelEnabled(!1)}}}const bt=new Set;function ke(e){for(const t of bt)t(e,"local")}function q(e){const t=localStorage.getItem(e);if(t!==null)try{return JSON.parse(t)}catch{return t}}function Et(e,t){localStorage.setItem(e,JSON.stringify(t))}async function Y(e){if(typeof e=="string")return{[e]:q(e)};if(Array.isArray(e)){const s={};for(const n of e)s[n]=q(n);return s}const t={};for(const[s,n]of Object.entries(e))t[s]=localStorage.getItem(s)!==null?q(s):n;return t}async function W(e){const t={};for(const[s,n]of Object.entries(e)){const o=q(s);Et(s,n),t[s]={oldValue:o,newValue:n}}ke(t)}async function fe(e){const t=Array.isArray(e)?e:[e],s={};for(const n of t){const o=q(n);localStorage.removeItem(n),s[n]={oldValue:o,newValue:void 0}}ke(s)}const ee="beecontour.actionLog",ht=5e3;function vt(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function yt(e){return Array.isArray(e)?e:[e]}function te(e,t,s){return Math.max(t,Math.min(s,Math.floor(e)))}async function z(){const e=await Y(ee),t=e==null?void 0:e[ee];return Array.isArray(t)?t:[]}async function Te(e){await W({[ee]:e})}async function U(e,t){const s=te(ht,100,5e4),o=yt(e).map(g=>({...g,id:vt(),ts:Date.now()}));if(!o.length)return{total:(await z()).length};const i=(await z()).concat(o),l=i.length>s?i.slice(i.length-s):i;return await Te(l),{total:l.length}}async function mt(e){const t=te((e==null?void 0:e.limit)??200,1,5e4),s=te((e==null?void 0:e.offset)??0,0,1e6);let o=await z();e!=null&&e.kind&&(o=o.filter(l=>l.kind===e.kind)),e!=null&&e.scope&&(o=o.filter(l=>l.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(o=o.filter(l=>l.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(o=o.filter(l=>l.ts<=e.untilTs));const r=o.length;o=o.slice().reverse();const i=o.slice(s,s+t);return{total:r,items:i}}async function Dt(e){let s=await z();if(typeof e.beforeTs=="number"&&(s=s.filter(n=>n.ts>=e.beforeTs)),typeof e.keepLast=="number"){const n=te(e.keepLast,0,5e4);n===0?s=[]:s.length>n&&(s=s.slice(s.length-n))}return await Te(s),{total:s.length}}async function pt(){await fe(ee)}async function Ct(e){const t=await z();return JSON.stringify(t,null,2)}const J="beecontour.debugTrace",re="beecontour.debugTrace.enabled",wt=2e3;function St(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function ue(e,t,s){return Math.max(t,Math.min(s,Math.floor(e)))}async function ne(){const e=await Y(J),t=e==null?void 0:e[J];return Array.isArray(t)?t:[]}async function Lt(e){await W({[J]:e})}async function be(){const e=await Y(re);return!!(e!=null&&e[re])}async function Ie(e){await W({[re]:!!e}),e||await fe(J)}async function Ae(){await fe(J)}async function H(e,t){if(!await be())return{total:0};const n=ue((t==null?void 0:t.max)??wt,100,5e4),o=(Array.isArray(e)?e:[e]).map(g=>({...g,id:St(),ts:Date.now()}));if(!o.length)return{total:(await ne()).length};const i=(await ne()).concat(o),l=i.length>n?i.slice(i.length-n):i;return await Lt(l),{total:l.length}}async function xe(e){const t=ue((e==null?void 0:e.limit)??200,1,5e4),s=ue((e==null?void 0:e.offset)??0,0,1e6),n=(e==null?void 0:e.reverse)??!0,o=await ne(),r=o.length,l=(n?o.slice().reverse():o).slice(s,s+t);return{total:r,items:l}}async function Me(e){const t=await ne();return JSON.stringify(t,null,e!=null&&e.pretty?2:0)}const Re=Object.freeze(Object.defineProperty({__proto__:null,append:H,clear:Ae,exportJson:Me,isEnabled:be,list:xe,setEnabled:Ie},Symbol.toStringTag,{value:"Module"}));function B(e,t,s,n){const o=Number(String(e??"").trim());return Number.isFinite(o)?Math.max(t,Math.min(s,Math.floor(o))):n}const ge="beecontour.devConfig",L={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let de=!1,se={...L};function Be(e){const t=e||{};return{traceConsole:!!t.traceConsole,actionLogMax:B(t.actionLogMax??L.actionLogMax,100,5e4,L.actionLogMax),debugTraceMax:B(t.debugTraceMax??L.debugTraceMax,100,5e4,L.debugTraceMax),failureLogsPerRun:B(t.failureLogsPerRun??L.failureLogsPerRun,0,5e4,L.failureLogsPerRun)}}async function me(){if(de)return;const e=await Y([ge]).catch(()=>({}));se=Be(e==null?void 0:e[ge]),de=!0}function De(){return se}async function Pe(e){se=Be(e),de=!0,await W({[ge]:se}).catch(()=>null)}async function kt(){await Pe({...L})}function Tt(){let e=!1,t={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},s=!1,n="",o="";function r(a){e=a}function i(a){t={...t,...a}}function l(a){s=a}function g(a){typeof a.general=="string"&&(n=a.general),typeof a.dev=="string"&&(o=a.dev)}return{get showDevTools(){return e},get dev(){return t},get debugEnabled(){return s},get generalStatus(){return n},get devStatus(){return o},setShowDevTools:r,setDev:i,setDebugEnabled:l,setStatus:g}}function It(e){function t(a){e.settingsGeneralStatusEl.textContent=a||""}function s(a){e.cfgStatusEl.textContent=a||""}function n(a){e.cfgShowDevToolsEl.checked=a}function o(a){e.tabLogs.hidden=!a,e.devConfigDetailsEl.classList.toggle("is-hidden",!a),a||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function r(a){e.cfgTraceConsoleEl.checked=!!a.traceConsole,e.cfgActionLogMaxEl.value=String(a.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(a.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(a.failureLogsPerRun??50)}function i(a){e.logsCbDebugEl.checked=a}function l(a,E){e.settingsVersionEl.textContent=a||"—",e.settingsGitHubLinkEl.href=E||"#",e.settingsGitHubLinkEl.hidden=!E}function g(a){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=a,e.cfgActionLogMaxEl.disabled=a,e.cfgDebugTraceMaxEl.disabled=a,e.cfgFailureLogsPerRunEl.disabled=a,e.btnCfgResetDefaults.disabled=a,e.logsCbDebugEl.disabled=a}return{setGeneralStatus:t,setDevStatus:s,setShowDevToolsChecked:n,setDevToolsVisible:o,setDevConfig:r,setDebugEnabledChecked:i,setAbout:l,setBusy:g}}const le="template.settings.showDevTools";function At(){var e,t;try{const s=(e=globalThis==null?void 0:globalThis.chrome)==null?void 0:e.runtime,n=(t=s==null?void 0:s.getManifest)==null?void 0:t.call(s),o=typeof(n==null?void 0:n.version)=="string"?n.version:"";if(o)return o}catch{}return""}function ce(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??L.actionLogMax),debugTraceMax:Number(e.debugTraceMax??L.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??L.failureLogsPerRun)}}function xt(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:B(e.cfgActionLogMaxEl.value,100,5e4,L.actionLogMax),debugTraceMax:B(e.cfgDebugTraceMaxEl.value,100,5e4,L.debugTraceMax),failureLogsPerRun:B(e.cfgFailureLogsPerRunEl.value,0,5e4,L.failureLogsPerRun)}}async function pe(e){const t=Re;return typeof t.setEnabled=="function"?(await t.setEnabled(e),{ok:!0}):typeof t.enable=="function"&&typeof t.disable=="function"?(await(e?t.enable():t.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function Mt(e,t){const s=Tt(),n=It(e);async function o(){const c=await Y([le]).catch(()=>({}));return(c==null?void 0:c[le])===!0}async function r(c){await W({[le]:!!c}).catch(()=>null)}function i(c){s.setShowDevTools(c),n.setShowDevToolsChecked(c),n.setDevToolsVisible(c),c||e.tabSettings.click()}async function l(){const c=await o();i(c),H({scope:"settings",kind:"debug",message:"boot:applyDevToolsVisibility",meta:{showDevTools:c}})}async function g(){var y;n.setBusy(S());const c=await o();i(c),await me().catch(()=>null);const d=De();s.setDev(ce(d)),n.setDevConfig(s.dev);const f=Re,b=typeof f.isEnabled=="function"?!!f.isEnabled():!!f.enabled;s.setDebugEnabled(b),n.setDebugEnabledChecked(b),n.setAbout(At()||"—",((y=e.settingsGitHubLinkEl)==null?void 0:y.href)||"#"),n.setGeneralStatus(""),n.setDevStatus("")}async function a(){const c=!!e.cfgShowDevToolsEl.checked;i(c),await r(c),U({kind:"run",scope:"settings",message:c?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:c}}),H({scope:"settings",kind:"debug",message:"ui:toggle showDevTools",meta:{showDevTools:c}}),n.setGeneralStatus(c?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>n.setGeneralStatus(""),1200)}async function E(){const c=xt(e);n.setDevStatus("Saving…"),await Pe(c),s.setDev(ce(c)),n.setDevConfig(s.dev),U({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:c}),H({scope:"settings",kind:"debug",message:"devConfig:updated",meta:c}),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}async function h(){n.setDevStatus("Resetting…"),await kt(),await me().catch(()=>null);const c=De();s.setDev(ce(c)),n.setDevConfig(s.dev);const d=await pe(!1);d.ok?(s.setDebugEnabled(!1),n.setDebugEnabledChecked(!1)):U({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:d.error||"unknown error"}),U({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...L,debugEnabled:!1}}),n.setDevStatus("Reset."),setTimeout(()=>n.setDevStatus(""),1200)}async function m(){const c=!!e.logsCbDebugEl.checked;n.setDevStatus("Saving…");const d=await pe(c);if(!d.ok){e.logsCbDebugEl.checked=!c,n.setDevStatus(`Save failed: ${d.error||"unknown error"}`),U({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:d.error||"unknown error",meta:{enabled:c}});return}s.setDebugEnabled(c),U({kind:"run",scope:"settings",message:c?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:c}}),H({scope:"settings",kind:"debug",message:"debugTrace:enabledChanged",meta:{enabled:c}}),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}const v=t.on(()=>{});function u(){e.cfgShowDevToolsEl.addEventListener("change",()=>{a()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{S()||E()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{S()||E()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{S()||E()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{S()||E()}),e.btnCfgResetDefaults.addEventListener("click",()=>{S()||h()}),e.logsCbDebugEl.addEventListener("change",()=>{S()||m()}),l().catch(()=>null)}return{id:"settings",refresh(){g().catch(()=>null)},mount(){g().catch(()=>null)},unmount(){},bind:u,dispose(){v()}}}function Rt(){let e=[],t=0;function s(n){e=n.items,t=n.total}return{get items(){return e},get total(){return t},set:s}}function Bt(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function Ce(e,t){const s=[];s.push(`Total entries: ${t.total}`),s.push("");for(const n of t.items){const o=typeof n.ok=="boolean"?n.ok?"ok":"fail":"",r=[];typeof n.status=="number"&&r.push(`status=${n.status}`),o&&r.push(o);const i=[n.scope,n.kind].filter(Boolean).join("/");s.push(`[${Bt(n.ts)}] ${i}${r.length?` (${r.join(", ")})`:""}`),s.push(`  ${n.message}`),n.error&&s.push(`  error: ${n.error}`),s.push("")}e.textContent=s.join(`
`),e.scrollTop=0}function Pt(e){function t(i){e.logsStatusEl.textContent=i}function s(i){e.debugStatusEl.textContent=i}function n(i){e.logsCbDebugEl.checked=i}function o(i){Ce(e.logsOutEl,{total:i.total,items:i.items.map(l=>({ts:l.ts,message:l.message,scope:l.scope,kind:l.kind,ok:l.ok,status:l.status,error:l.error,meta:l.meta}))})}function r(i){Ce(e.debugOutEl,{total:i.total,items:i.items.map(l=>({ts:l.ts,message:l.message,scope:l.scope,kind:l.kind,ok:l.ok,status:l.status,error:l.error,meta:l.meta}))})}return{setAuditStatus:t,setDebugStatus:s,setDebugChecked:n,renderAudit:o,renderDebug:r}}const we="beecontour";function $t(e,t){const s=Rt(),n=Pt(e);async function o(){n.setAuditStatus("Loading…"),M(e,!0);try{const u=B(e.logsLimitEl.value,10,5e3,200),c=await mt({limit:u,reverse:!0});s.set(c),n.renderAudit({items:s.items,total:s.total}),n.setAuditStatus(`Showing ${s.items.length} (newest first)`)}catch(u){n.setAuditStatus(`Failed: ${(u==null?void 0:u.message)||String(u)}`)}finally{M(e,!1)}}async function r(){n.setDebugStatus("Loading…"),M(e,!0);try{const u=B(e.debugLimitEl.value,10,5e3,200),c=await xe({limit:u,reverse:!0});n.renderDebug(c),n.setDebugStatus(`Showing ${c.items.length} (newest first)`)}catch(u){n.setDebugStatus(`Failed: ${(u==null?void 0:u.message)||String(u)}`)}finally{M(e,!1)}}async function i(){const u=await be();n.setDebugChecked(u)}async function l(u){if(await Ie(u),n.setDebugChecked(u),!u){n.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}n.setDebugStatus("Debug ON."),await r()}async function g(){const u=B(e.logsTrimKeepEl.value,0,5e4,2e3);n.setAuditStatus("Trimming…"),M(e,!0);try{const c=await Dt({keepLast:u});await o(),n.setAuditStatus(`Trimmed. Remaining: ${c.total}`)}catch(c){n.setAuditStatus(`Trim failed: ${(c==null?void 0:c.message)||String(c)}`)}finally{M(e,!1)}}async function a(){n.setAuditStatus("Clearing…"),M(e,!0);try{await pt(),await o(),n.setAuditStatus("Cleared.")}catch(u){n.setAuditStatus(`Clear failed: ${(u==null?void 0:u.message)||String(u)}`)}finally{M(e,!1)}}async function E(){n.setAuditStatus("Exporting…");try{const u=await Ct({pretty:!0}),c=new Blob([u],{type:"application/json"}),d=URL.createObjectURL(c),f=document.createElement("a");f.href=d,f.download=`${we}-audit-${Date.now()}.json`,f.click(),setTimeout(()=>URL.revokeObjectURL(d),1e3),n.setAuditStatus("Exported.")}catch(u){n.setAuditStatus(`Export failed: ${(u==null?void 0:u.message)||String(u)}`)}}async function h(){n.setDebugStatus("Clearing…"),M(e,!0);try{await Ae(),await r(),n.setDebugStatus("Cleared.")}catch(u){n.setDebugStatus(`Clear failed: ${(u==null?void 0:u.message)||String(u)}`)}finally{M(e,!1)}}async function m(){n.setDebugStatus("Exporting…");try{const u=await Me({pretty:!0}),c=new Blob([u],{type:"application/json"}),d=URL.createObjectURL(c),f=document.createElement("a");f.href=d,f.download=`${we}-debug-${Date.now()}.json`,f.click(),setTimeout(()=>URL.revokeObjectURL(d),1e3),n.setDebugStatus("Exported.")}catch(u){n.setDebugStatus(`Export failed: ${(u==null?void 0:u.message)||String(u)}`)}}function v(){e.btnLogsRefresh.addEventListener("click",()=>{S()||o()}),e.btnLogsTrim.addEventListener("click",()=>{S()||g()}),e.btnLogsClear.addEventListener("click",()=>{S()||a()}),e.btnLogsExport.addEventListener("click",()=>{S()||E()}),e.logsCbDebugEl.addEventListener("change",()=>{S()||l(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{S()||r()}),e.btnDebugClear.addEventListener("click",()=>{S()||h()}),e.btnDebugExport.addEventListener("click",()=>{S()||m()})}return{id:"logs",bind:v,mount(){i(),o(),r()},unmount(){},dispose(){}}}(function(){const t=We(),s=Qe();s.start();const n=tt();globalThis.__APP__={...globalThis.__APP__,cache:n};const o=st(t),r=ft(t),i=Mt(t,s),l=$t(t);o.bind(),r.bind(),i.bind(),l.bind();const g=et(t,{contour:o,colors:r,settings:i,logs:l});g.bind(),g.boot()})();
