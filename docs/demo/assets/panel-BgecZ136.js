function Qt(){function e(Oe,Gt){if(!Oe)throw new Error(`[dom] Missing #${Gt}`);return Oe}const t=e(document.getElementById("appRoot"),"appRoot"),o=e(document.getElementById("tabContour"),"tabContour"),n=e(document.getElementById("tabColors"),"tabColors"),a=e(document.getElementById("tabSettings"),"tabSettings"),i=e(document.getElementById("tabLogs"),"tabLogs"),l=e(document.getElementById("tabSegmentation"),"tabSegmentation"),u=e(document.getElementById("viewContour"),"viewContour"),f=e(document.getElementById("viewColors"),"viewColors"),r=e(document.getElementById("viewSettings"),"viewSettings"),c=e(document.getElementById("viewLogs"),"viewLogs"),v=e(document.getElementById("viewSegmentation"),"viewSegmentation"),b=e(document.getElementById("dropZone"),"dropZone"),g=e(document.getElementById("fileInput"),"fileInput"),s=e(document.getElementById("btnProcess"),"btnProcess"),d=e(document.getElementById("btnClean"),"btnClean"),p=e(document.getElementById("btnDownload"),"btnDownload"),m=e(document.getElementById("contourStatus"),"contourStatus"),h=e(document.getElementById("contourSpinner"),"contourSpinner"),C=e(document.getElementById("srcCanvas"),"srcCanvas"),w=e(document.getElementById("outCanvas"),"outCanvas"),D=e(document.getElementById("clean1Canvas"),"clean1Canvas"),k=e(document.getElementById("clean2Canvas"),"clean2Canvas"),M=e(document.getElementById("cleanQualityBadge"),"cleanQualityBadge"),x=e(document.getElementById("cleanQualityFill"),"cleanQualityFill"),S=e(document.getElementById("cleanQualityText"),"cleanQualityText"),y=e(document.getElementById("btnVectorize"),"btnVectorize"),E=e(document.getElementById("btnDownloadSvg"),"btnDownloadSvg"),P=e(document.getElementById("svgPreviewImg"),"svgPreviewImg"),I=e(document.getElementById("svgPreviewText"),"svgPreviewText"),R=e(document.getElementById("contourTuningMount"),"contourTuningMount"),L=e(document.getElementById("colorsCanvas"),"colorsCanvas"),A=e(document.getElementById("palette"),"palette"),j=e(document.getElementById("btnColorsApply"),"btnColorsApply"),J=e(document.getElementById("btnColorsCancel"),"btnColorsCancel"),X=e(document.getElementById("btnColorsReset"),"btnColorsReset"),G=e(document.getElementById("edgesDark"),"edgesDark"),ae=e(document.getElementById("edgeMaskThreshold"),"edgeMaskThreshold"),ut=e(document.getElementById("edgeDilate"),"edgeDilate"),dt=e(document.getElementById("maxRegionPx"),"maxRegionPx"),gt=e(document.getElementById("colorsStatus"),"colorsStatus"),ft=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),pt=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),vt=e(document.getElementById("devConfigDetails"),"devConfigDetails"),mt=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),bt=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),ht=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),yt=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),Et=e(document.getElementById("logsCbDebug"),"logsCbDebug"),Ct=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),wt=e(document.getElementById("cfgStatus"),"cfgStatus"),St=e(document.getElementById("cfgOpenCvSpinner"),"cfgOpenCvSpinner"),xt=e(document.getElementById("cfgOpenCvStatus"),"cfgOpenCvStatus"),kt=e(document.getElementById("cfgOpenCvReport"),"cfgOpenCvReport"),Dt=e(document.getElementById("settingsEngineBox"),"settingsEngineBox"),Tt=e(document.getElementById("cfgUseOpenCv"),"cfgUseOpenCv"),It=e(document.getElementById("tuningMount"),"tuningMount"),Rt=e(document.getElementById("settingsVersion"),"settingsVersion"),Lt=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),Pt=e(document.getElementById("logsLimit"),"logsLimit"),Mt=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),Ot=e(document.getElementById("logsStatus"),"logsStatus"),Bt=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),At=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),$t=e(document.getElementById("btnLogsExport"),"btnLogsExport"),Vt=e(document.getElementById("btnLogsClear"),"btnLogsClear"),Ut=e(document.getElementById("logsOut"),"logsOut"),Nt=e(document.getElementById("debugLimit"),"debugLimit"),jt=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),Ft=e(document.getElementById("btnDebugExport"),"btnDebugExport"),_t=e(document.getElementById("btnDebugClear"),"btnDebugClear"),zt=e(document.getElementById("debugStatus"),"debugStatus"),qt=e(document.getElementById("debugOut"),"debugOut");return{rootEl:t,tabContour:o,tabColors:n,tabSettings:a,tabLogs:i,tabSegmentation:l,viewContour:u,viewSegmentation:v,viewColors:f,viewSettings:r,viewLogs:c,dropZoneEl:b,fileInputEl:g,btnProcessEl:s,btnCleanEl:d,btnDownloadEl:p,contourStatusEl:m,contourSpinnerEl:h,srcCanvasEl:C,outCanvasEl:w,clean1CanvasEl:D,clean2CanvasEl:k,cleanQualityBadgeEl:M,cleanQualityFillEl:x,cleanQualityTextEl:S,btnVectorizeEl:y,btnDownloadSvgEl:E,svgPreviewImgEl:P,svgPreviewTextEl:I,contourTuningMountEl:R,colorsCanvasEl:L,paletteEl:A,btnColorsApplyEl:j,btnColorsCancelEl:J,btnColorsResetEl:X,edgesDarkEl:G,edgeMaskThresholdEl:ae,edgeDilateEl:ut,maxRegionPxEl:dt,colorsStatusEl:gt,cfgShowDevToolsEl:ft,settingsGeneralStatusEl:pt,devConfigDetailsEl:vt,cfgTraceConsoleEl:mt,cfgActionLogMaxEl:bt,cfgDebugTraceMaxEl:ht,cfgFailureLogsPerRunEl:yt,logsCbDebugEl:Et,btnCfgResetDefaults:Ct,cfgStatusEl:wt,settingsVersionEl:Rt,settingsGitHubLinkEl:Lt,cfgOpenCvSpinner:St,cfgOpenCvStatus:xt,cfgOpenCvReport:kt,settingsEngineBoxEl:Dt,cfgUseOpenCvEl:Tt,tuningMountEl:It,logsLimitEl:Pt,btnLogsRefresh:Mt,logsStatusEl:Ot,logsTrimKeepEl:Bt,btnLogsTrim:At,btnLogsExport:$t,btnLogsClear:Vt,logsOutEl:Ut,debugLimitEl:Nt,btnDebugRefresh:jt,btnDebugExport:Ft,btnDebugClear:_t,debugStatusEl:zt,debugOutEl:qt}}const Ht=new Set;function Kt(e){Ht.add(e)}function Wt(){const e=new Set;function t(n){return e.add(n),()=>e.delete(n)}function o(){Kt(a=>{for(const i of e)i(a)})}return{on:t,start:o}}const Yt=new Set;function Qe(e){for(const t of Yt)t(e,"local")}function Z(e){const t=localStorage.getItem(e);if(t!==null)try{return JSON.parse(t)}catch{return t}}function Jt(e,t){localStorage.setItem(e,JSON.stringify(t))}async function W(e){if(typeof e=="string")return{[e]:Z(e)};if(Array.isArray(e)){const o={};for(const n of e)o[n]=Z(n);return o}const t={};for(const[o,n]of Object.entries(e))t[o]=localStorage.getItem(o)!==null?Z(o):n;return t}async function Y(e){const t={};for(const[o,n]of Object.entries(e)){const a=Z(o);Jt(o,n),t[o]={oldValue:a,newValue:n}}Qe(t)}async function Te(e){const t=Array.isArray(e)?e:[e],o={};for(const n of t){const a=Z(n);localStorage.removeItem(n),o[n]={oldValue:a,newValue:void 0}}Qe(o)}function q(e,t,o,n){const a=Number(String(e??"").trim());return Number.isFinite(a)?Math.max(t,Math.min(o,Math.floor(a))):n}const we="beecontour.devConfig",V={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let Se=!1,ie={...V};function He(e){const t=e||{};return{traceConsole:!!t.traceConsole,actionLogMax:q(t.actionLogMax??V.actionLogMax,100,5e4,V.actionLogMax),debugTraceMax:q(t.debugTraceMax??V.debugTraceMax,100,5e4,V.debugTraceMax),failureLogsPerRun:q(t.failureLogsPerRun??V.failureLogsPerRun,0,5e4,V.failureLogsPerRun)}}async function Be(){if(Se)return;const e=await W([we]).catch(()=>({}));ie=He(e==null?void 0:e[we]),Se=!0}function re(){return ie}async function Ke(e){ie=He(e),Se=!0,await Y({[we]:ie}).catch(()=>null)}async function Xt(){await Ke({...V})}function Zt(e,t){const o={segmentation:e.tabSegmentation,contour:e.tabContour,colors:e.tabColors,settings:e.tabSettings,logs:e.tabLogs},n={segmentation:e.viewSegmentation,contour:e.viewContour,colors:e.viewColors,settings:e.viewSettings,logs:e.viewLogs};let a="contour";const i=new Set;function l(){const g=re();return!!(g!=null&&g.traceConsole)}function u(){const g=globalThis;g.__bctGlobalErrorHooksInstalled||(g.__bctGlobalErrorHooksInstalled=!0,window.addEventListener("error",s=>{var p;const d=s;console.error("[panel] window error",{message:d.message,filename:d.filename,lineno:d.lineno,colno:d.colno,error:d.error?String(d.error):null,stack:(p=d.error)!=null&&p.stack?String(d.error.stack):null})}),window.addEventListener("unhandledrejection",s=>{var d;console.error("[panel] unhandledrejection",{reason:s.reason?String(s.reason):null,stack:(d=s.reason)!=null&&d.stack?String(s.reason.stack):null})}))}l()&&u();function f(g){Object.keys(o).forEach(s=>{const d=s===g;o[s].classList.toggle("is-active",d),o[s].setAttribute("aria-selected",d?"true":"false"),n[s].hidden=!d,n[s].classList.toggle("is-active",d)})}function r(g){var s,d,p,m,h,C,w,D;if(g===a){(d=(s=t[g]).refresh)==null||d.call(s);return}(m=(p=t[a]).unmount)==null||m.call(p),a=g,f(a),i.has(a)?(D=(w=t[a]).refresh)==null||D.call(w):(i.add(a),(C=(h=t[a]).mount)==null||C.call(h))}function c(){o.contour.addEventListener("click",g=>{var s;(s=g.preventDefault)==null||s.call(g),r("contour")}),o.segmentation.addEventListener("click",g=>{var s;(s=g.preventDefault)==null||s.call(g),r("segmentation")}),o.colors.addEventListener("click",g=>{var s;(s=g.preventDefault)==null||s.call(g),r("colors")}),o.settings.addEventListener("click",g=>{var s;(s=g.preventDefault)==null||s.call(g),r("settings")}),o.logs.addEventListener("click",g=>{var s;(s=g.preventDefault)==null||s.call(g),r("logs")})}function v(){var g,s,d,p;a="contour",f(a),Object.keys(t).forEach(m=>{var h,C;return(C=(h=t[m]).boot)==null?void 0:C.call(h)}),i.has(a)?(p=(d=t[a]).refresh)==null||p.call(d):(i.add(a),(s=(g=t[a]).mount)==null||s.call(g))}function b(){Object.keys(t).forEach(g=>{var s,d;return(d=(s=t[g]).dispose)==null?void 0:d.call(s)})}return{bind:c,boot:v,activate:r,dispose:b}}function Ae(e){const t=e.items.length;return{items:e.items,counts:{items:t},meta:e.meta}}function en(){const e={items:[],meta:{}},t=new Set;function o(){const r=Ae(e);for(const c of t)try{c(r)}catch{}}function n(){return Ae(e)}function a(r){t.add(r);try{r(n())}catch{}return()=>t.delete(r)}function i(){e.items=[],e.meta={},o()}function l(r){e.meta.scopeUpdatedSince=r,o()}function u(){return String(e.meta.scopeUpdatedSince||"")}function f(r,c){e.items=r.slice(),e.meta.updatedTs=Date.now(),typeof(c==null?void 0:c.limit)=="number"&&(e.meta.limit=c.limit),o()}return{getSnapshot:n,subscribe:a,getScopeUpdatedSince:u,clearAll:i,setScopeUpdatedSince:l,setItems:f}}function tn(){return{loadedImageName:null,hasImage:!1,hasOutput:!1,edgeMask:void 0,repairedMask:void 0,smoothedMask:void 0,svgText:void 0}}function nn(e){e.loadedImageName=null,e.hasImage=!1,e.hasOutput=!1,e.edgeMask=void 0,e.repairedMask=void 0,e.smoothedMask=void 0,e.svgText=void 0}function We(e,t,o){const n=new Uint8Array(e.length);function a(p,m){return m*t+p}function i(p,m){return p<0||m<0||p>=t||m>=o?!1:e[a(p,m)]===1}let l=0,u=0,f=0,r=0,c=0;const v=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];for(let p=0;p<o;p++)for(let m=0;m<t;m++){if(!i(m,p))continue;l++;let h=0,C=!1;for(const[w,D]of v)i(m+w,p+D)?h++:C=!0;C&&u++,h===1?f++:h>=3&&r++}const b=[[-1,0],[1,0],[0,-1],[0,1]],g=new Int32Array(e.length),s=new Int32Array(e.length);for(let p=0;p<o;p++)for(let m=0;m<t;m++){const h=a(m,p);if(e[h]===0||n[h]===1)continue;c++,n[h]=1;let C=0,w=0;for(g[w]=m,s[w]=p,w++;C<w;){const D=g[C],k=s[C];C++;for(const[M,x]of b){const S=D+M,y=k+x;if(S<0||y<0||S>=t||y>=o)continue;const E=a(S,y);e[E]===0||n[E]===1||(n[E]=1,g[w]=S,s[w]=y,w++)}}}const d=l/Math.max(1,u);return{onPixels:l,boundaryPixels:u,components:c,endpoints:f,junctions:r,thicknessRatio:d}}function on(e,t){function o(g){e.contourStatusEl.textContent=g}function n(g,s){e.contourSpinnerEl.classList.toggle("is-hidden",!g),s&&o(s)}function a(){e.btnProcessEl.disabled=!t.hasImage,e.btnDownloadEl.disabled=!t.hasOutput,e.btnCleanEl.disabled=!t.hasOutput,e.btnVectorizeEl.disabled=!t.smoothedMask,e.btnDownloadSvgEl.disabled=!t.svgText}function i(){t.svgText=void 0,e.svgPreviewTextEl.textContent="",e.svgPreviewImgEl.removeAttribute("src")}function l(){const g=e.srcCanvasEl.getContext("2d"),s=e.outCanvasEl.getContext("2d");g.clearRect(0,0,e.srcCanvasEl.width,e.srcCanvasEl.height),s.clearRect(0,0,e.outCanvasEl.width,e.outCanvasEl.height);const d=e.clean1CanvasEl.getContext("2d"),p=e.clean2CanvasEl.getContext("2d");d.clearRect(0,0,e.clean1CanvasEl.width,e.clean1CanvasEl.height),p.clearRect(0,0,e.clean2CanvasEl.width,e.clean2CanvasEl.height)}function u(){const g=e.clean1CanvasEl.getContext("2d"),s=e.clean2CanvasEl.getContext("2d");g.clearRect(0,0,e.clean1CanvasEl.width,e.clean1CanvasEl.height),s.clearRect(0,0,e.clean2CanvasEl.width,e.clean2CanvasEl.height)}function f(g,s){const d=Number(g.value);return Number.isFinite(d)?d:s}function r(g,s){const d=s instanceof Error?s.message:String(s);o(`${g} failed: ${d}`),n(!1),console.error(`[BeeContour] ${g} failed`,s)}function c(g,s){if(!t.smoothedMask){e.cleanQualityBadgeEl.textContent="—",e.cleanQualityBadgeEl.className="qBadge qBadge--off",e.cleanQualityFillEl.style.width="0%",e.cleanQualityTextEl.textContent="";return}const d=We(t.smoothedMask,g,s),p=(S,y)=>Math.max(0,Math.min(1,S/Math.max(1,y))),m=p(d.components,800),h=p(d.endpoints,3e3),C=p(d.junctions,1500),w=d.thicknessRatio>5?1:d.thicknessRatio>3?.5:0,D=Math.round(100*(1-(.45*m+.45*h+.1*C)-.1*w)),k=Math.max(0,Math.min(100,D));let M="qBadge qBadge--bad",x=`Bad ${k}`;k>=70?(M="qBadge qBadge--ok",x=`Good ${k}`):k>=45&&(M="qBadge qBadge--warn",x=`OK ${k}`),e.cleanQualityBadgeEl.className=M,e.cleanQualityBadgeEl.textContent=x,e.cleanQualityFillEl.style.width=`${k}%`,e.cleanQualityTextEl.textContent=`CC:${d.components} end:${d.endpoints} j:${d.junctions} thick:${d.thicknessRatio.toFixed(2)}`}function v(){if(!t.hasOutput)return;const s=`${(t.loadedImageName||"beecontour").replace(/\.[a-z0-9]+$/i,"").replace(/[^a-z0-9-_]+/gi,"_")}_contour.png`,d=e.outCanvasEl.toDataURL("image/png"),p=document.createElement("a");p.href=d,p.download=s,document.body.appendChild(p),p.click(),p.remove(),o(`Downloaded: ${s}`)}function b(){if(!t.svgText)return;const s=`${(t.loadedImageName||"beecontour").replace(/\.[a-z0-9]+$/i,"").replace(/[^a-z0-9-_]+/gi,"_")}_contour.svg`,d=new Blob([t.svgText],{type:"image/svg+xml;charset=utf-8"}),p=URL.createObjectURL(d),m=document.createElement("a");m.href=p,m.download=s,document.body.appendChild(m),m.click(),m.remove(),URL.revokeObjectURL(p),o(`Downloaded: ${s}`)}return{setStatus:o,setContourBusyVisual:n,updateEnabled:a,clearSvgPreview:i,clearCanvases:l,clearCleanCanvasesOnly:u,getNumber:f,showError:r,updateCleanQualityUI:c,downloadPng:v,downloadSvg:b}}const ee="beecontour.debugTrace",xe="beecontour.debugTrace.enabled",an=2e3;function sn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function ke(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}async function ce(){const e=await W(ee),t=e==null?void 0:e[ee];return Array.isArray(t)?t:[]}async function rn(e){await Y({[ee]:e})}async function Ie(){const e=await W(xe);return!!(e!=null&&e[xe])}async function Ye(e){await Y({[xe]:!!e}),e||await Te(ee)}async function Je(){await Te(ee)}async function Re(e,t){if(!await Ie())return{total:0};const n=ke((t==null?void 0:t.max)??an,100,5e4),a=(Array.isArray(e)?e:[e]).map(f=>({...f,id:sn(),ts:Date.now()}));if(!a.length)return{total:(await ce()).length};const l=(await ce()).concat(a),u=l.length>n?l.slice(l.length-n):l;return await rn(u),{total:u.length}}async function Xe(e){const t=ke((e==null?void 0:e.limit)??200,1,5e4),o=ke((e==null?void 0:e.offset)??0,0,1e6),n=(e==null?void 0:e.reverse)??!0,a=await ce(),i=a.length,u=(n?a.slice().reverse():a).slice(o,o+t);return{total:i,items:u}}async function Ze(e){const t=await ce();return JSON.stringify(t,null,e!=null&&e.pretty?2:0)}const et=Object.freeze(Object.defineProperty({__proto__:null,append:Re,clear:Je,exportJson:Ze,isEnabled:Ie,list:Xe,setEnabled:Ye},Symbol.toStringTag,{value:"Module"}));function fe(e){return`[BCT][${e}]`}function cn(e){function t(...i){e.traceOn()&&console.log(fe("trace"),...i)}function o(...i){console.warn(fe("warn"),...i)}function n(...i){console.error(fe("error"),...i)}function a(i,l){t(i,l),Re({scope:e.scope,kind:"debug",message:i,meta:l})}return{logTrace:t,logWarn:o,logError:n,traceScope:a}}const{logTrace:O,logWarn:_,logError:N,traceScope:U}=cn({scope:"panel",traceOn:()=>!!re().traceConsole});let B=0;function $(){return B>0}function z(e,t){if(t){tt(e);return}B=0,le(e,!1)}async function oe(e,t){const o=`${Date.now()}-${Math.random().toString(16).slice(2)}`;O("[state] withBusy: enter",{id:o,busyCount:B}),tt(e,o);try{O("[state] withBusy: before await fn",{id:o,busyCount:B});const n=await t();return O("[state] withBusy: after await fn (resolved)",{id:o,busyCount:B}),n}catch(n){throw N("[state] withBusy: fn threw",{id:o,busyCount:B,msg:String((n==null?void 0:n.message)??n),stack:String((n==null?void 0:n.stack)??"")}),n}finally{O("[state] withBusy: finally before endBusy",{id:o,busyCount:B}),ln(e,o),O("[state] withBusy: finally after endBusy",{id:o,busyCount:B})}}function tt(e,t){B++,O("[state] beginBusy",{id:t,busyCount:B}),B===1&&le(e,!0)}function ln(e,t){if(B--,O("[state] endBusy: dec",{id:t,busyCount:B}),B<=0){B=0,O("[state] endBusy: applying busy=false",{id:t,busyCount:B}),le(e,!1);return}B===0&&(O("[state] endBusy: applying busy=false (redundant branch)",{id:t,busyCount:B}),le(e,!1))}function le(e,t){e.rootEl.classList.toggle("is-busy",t),e.cfgShowDevToolsEl.disabled=!1,e.fileInputEl.disabled=t,e.btnProcessEl.disabled=t,e.btnCleanEl.disabled=t,e.btnDownloadEl.disabled=t,e.btnVectorizeEl.disabled=t,e.btnDownloadSvgEl.disabled=t,e.cfgTraceConsoleEl.disabled=t,e.cfgActionLogMaxEl.disabled=t,e.cfgDebugTraceMaxEl.disabled=t,e.cfgFailureLogsPerRunEl.disabled=t,e.btnCfgResetDefaults.disabled=t,e.logsCbDebugEl.disabled=t,e.cfgUseOpenCvEl.disabled=t,e.logsLimitEl.disabled=t,e.btnLogsRefresh.disabled=t,e.logsTrimKeepEl.disabled=t,e.btnLogsTrim.disabled=t,e.btnLogsExport.disabled=t,e.btnLogsClear.disabled=t,e.debugLimitEl.disabled=t,e.btnDebugRefresh.disabled=t,e.btnDebugExport.disabled=t,e.btnDebugClear.disabled=t,e.btnColorsApplyEl.disabled=t,e.btnColorsCancelEl.disabled=t,e.btnColorsResetEl.disabled=t,e.edgesDarkEl.disabled=t,e.edgeMaskThresholdEl.disabled=t,e.edgeDilateEl.disabled=t,e.maxRegionPxEl.disabled=t;for(const o of Array.from(e.paletteEl.querySelectorAll("button")))o.disabled=t;e.colorsCanvasEl.style.pointerEvents=t?"none":"auto"}function F(e,t,o,n,a,i,l){return{id:e,title:t,implementedEngines:o,defaultEnginePolicy:n,params:a,children:i,description:l}}function un(e){const t=new Map,o=new Map;function n(a,i){if(t.has(a.id))throw new Error(`[tuning] Duplicate component id: ${a.id}`);t.set(a.id,a),o.set(a.id,i);for(const l of a.children??[])n(l,a.id)}return n(e,null),{root:e,byId:t,parentById:o}}function Le(){const e=F("app","BeeContour",["native","opencv"],"native",{},[F("contour","Contour",["native","opencv"],"auto",{},[F("contour.process","Process",["native"],"auto",{contourScale:{kind:"number",label:"Processing scale",min:25,max:100,step:5,default:100},edgeThreshold:{kind:"number",label:"Edge threshold",min:1,max:255,step:1,default:70},invertOutput:{kind:"boolean",label:"White background",default:!0}}),F("contour.clean","Clean & Smooth",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:500,step:1,default:12},cleanRadius:{kind:"number",label:"Repair strength",min:1,max:3,step:1,default:1},cleanBinaryThreshold:{kind:"number",label:"Binary threshold",min:1,max:254,step:1,default:128}},[F("contour.clean.threshold","Threshold",["native"],"auto",{}),F("contour.clean.removeSmallComponents","Remove small components",["native","opencv"],"auto",{}),F("contour.clean.repair","Repair gaps",["native"],"auto",{}),F("contour.clean.smooth","Smooth mask",["native"],"auto",{}),F("contour.clean.quality","Quality metrics",["native"],"auto",{})]),F("contour.vectorize","Vectorize (SVG)",["native"],"native",{pathSmoothIters:{kind:"number",label:"Path smoothing",min:0,max:4,step:1,default:2}})]),F("colors","Colors",["native"],"auto",{},[F("colors.fill","Region fill",["native"],"auto",{edgesDark:{kind:"boolean",label:"Edges are dark",default:!0},edgeMaskThreshold:{kind:"number",label:"Edge threshold",min:0,max:255,step:1,default:80},edgeDilate:{kind:"number",label:"Gap close (px)",min:0,max:6,step:1,default:2},maxRegionPx:{kind:"number",label:"Max region (px)",min:1e3,step:1e3,default:2e5}})]),F("segmentation","Segmentation",["native"],"auto",{},[],"Placeholder: will become multi-step segmentation pipeline.")]);return un(e)}function dn(e){return e.default}function gn(e,t){const o={};for(const[n,a]of Object.entries(e))o[n]=dn(a);for(const[n,a]of Object.entries(t??{}))o[n]=a;return o}function fn(e,t,o){var a;let n=e;for(;n;){const i=t.byId.get(n);if(!i)throw new Error(`[tuning] Unknown component: ${n}`);const u=((a=o[n])==null?void 0:a.enginePolicy)??i.defaultEnginePolicy;if(u!=="inherit")return u;n=t.parentById.get(n)??null}return"native"}function pn(e,t,o){const n=o.opencvReady&&e.includes("opencv");return e.includes("native")||e.length,t==="native"?{engine:"native"}:t==="opencv"?n?{engine:"opencv"}:{engine:"native",fallbackReason:o.opencvReady?"Policy=opencv, but component has no OpenCV implementation.":"Policy=opencv, but OpenCV is not available at runtime."}:t==="auto"?n?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}function nt(e,t,o,n){var r;const a=t.byId.get(e);if(!a)throw new Error(`[tuning] Unknown component: ${e}`);const i=fn(e,t,o),{engine:l,fallbackReason:u}=pn(a.implementedEngines,i,n),f=gn(a.params,(r=o[e])==null?void 0:r.params);return{id:e,policy:i,engine:l,fallbackReason:u,params:f}}const De="beecontour.tuning.components.v1";async function te(){const e=await W([De]).catch(()=>({})),t=e==null?void 0:e[De];return!t||typeof t!="object"?{}:t}async function ot(e){await Y({[De]:e}).catch(()=>null)}async function pe(e,t){const o=await te(),n=o[e]??{};o[e]={enginePolicy:t.enginePolicy??n.enginePolicy,params:{...n.params??{},...t.params??{}}},await ot(o)}async function $e(e){const t=await te();delete t[e],await ot(t)}const Pe={native:{available:!0},opencv:{available:!1,reason:"OpenCV not loaded"}};function vn(e){Pe[e]={available:!0}}function mn(e,t){Pe[e]={available:!1,reason:t}}function Q(){return Pe.opencv.available===!0}function bn(){return{opencvReady:Q()}}function hn(e){return Array.isArray(e.children)&&e.children.length>0}function at(e){const{id:t,registry:o,stored:n,runtime:a}=e,i=o.byId.get(t);if(!i)throw new Error(`[tuning] Unknown component: ${t}`);const l=nt(t,o,n,a),u=n[t],f=u==null?void 0:u.enginePolicy,r=u==null?void 0:u.params,c=i.implementedEngines.includes("opencv"),v=!!a.opencvReady,b=[];for(const g of i.children??[])b.push(at({id:g.id,registry:o,stored:n,runtime:a}));return{id:i.id,title:i.title,description:i.description,isGroup:hn(i),implementedEngines:i.implementedEngines,storedPolicy:f,storedParams:r,effectivePolicy:l.policy,effectiveEngine:l.engine,fallbackReason:l.fallbackReason,paramsSchema:i.params,effectiveParams:l.params,canImplementOpenCv:c,runtimeOpenCvReady:v,children:b}}function Me(e={}){const t=e.registry??Le(),o=e.getRuntimeAvailability??bn;async function n(f="app"){const r=await te(),c=o();if(!t.byId.get(f))throw new Error(`[tuning] Unknown scope: ${f}`);const b=at({id:f,registry:t,stored:r,runtime:c});return{scopeId:f,runtime:c,stored:r,root:b}}async function a(f,r){await pe(f,{enginePolicy:r})}async function i(f,r,c){await pe(f,{params:{[r]:c}})}async function l(f){await $e(f)}async function u(f,r){const v=(await te())[f];if(!(v!=null&&v.params))return;const b={...v.params??{}};delete b[r];const g=typeof v.enginePolicy=="string",s=Object.keys(b).length>0;if(!g&&!s){await $e(f);return}await pe(f,{enginePolicy:v.enginePolicy,params:b})}return{getRegistry:()=>t,loadTree:n,setEnginePolicy:a,setParam:i,resetNode:l,resetParam:u}}function yn(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}function En(e,t){if(e.kind==="number"){const o=Number(t),n=e.default,a=Number.isFinite(o)?o:n,i=typeof e.min=="number"?e.min:a,l=typeof e.max=="number"?e.max:a;return yn(a,i,l)}return e.kind==="boolean"?!!t:String(t??e.default)}function H(e,t,o,n){const a=e.byId.get(t);if(!a)throw new Error(`[tuningParams] unknown node: ${t}`);const i=a.params[o];if(!i)throw new Error(`[tuningParams] unknown param: ${t}.${o}`);return En(i,n)}function se(e,t){if((e==null?void 0:e.id)===t)return e;for(const o of(e==null?void 0:e.children)??[]){const n=se(o,t);if(n)return n}return null}async function ge(){const e=Me(),t=Le(),o=await e.loadTree("app"),n=se(o.root,"contour.process"),a=se(o.root,"contour.clean"),i=se(o.root,"contour.vectorize");if(!n||!a||!i)throw new Error("[contour] tuning nodes missing (registry mismatch)");const l=H(t,"contour.process","contourScale",n.effectiveParams.contourScale),u=H(t,"contour.process","edgeThreshold",n.effectiveParams.edgeThreshold),f=H(t,"contour.process","invertOutput",n.effectiveParams.invertOutput),r=H(t,"contour.clean","cleanMinArea",a.effectiveParams.cleanMinArea),c=H(t,"contour.clean","cleanRadius",a.effectiveParams.cleanRadius),v=H(t,"contour.clean","cleanBinaryThreshold",a.effectiveParams.cleanBinaryThreshold),b=H(t,"contour.vectorize","pathSmoothIters",i.effectiveParams.pathSmoothIters);return{contourScale:l,edgeThreshold:u,invertOutput:f,cleanMinArea:r,cleanRadius:c,cleanBinaryThreshold:v,pathSmoothIters:b}}async function Ve(e,t,o,n){const{setStatus:a,setContourBusyVisual:i,clearCanvases:l,clearCleanCanvasesOnly:u,clearSvgPreview:f,updateEnabled:r,getNumber:c}=n;if(!o.type.startsWith("image/")){a("Unsupported file type (please drop an image)."),_("Contour load: rejected non-image file",{name:o.name,type:o.type,size:o.size}),U("Contour load: rejected non-image file",{name:o.name,type:o.type,size:o.size});return}const v=performance.now();await oe(e,async()=>{i(!0,"Loading image…"),t.loadedImageName=o.name||"image";const b=URL.createObjectURL(o);U("Contour load: start",{name:o.name,type:o.type,size:o.size});try{const g=await new Promise((M,x)=>{const S=new Image;S.onload=()=>M(S),S.onerror=()=>x(new Error("Failed to load image")),S.src=b}),s=e.srcCanvasEl,d=s.getContext("2d");if(!d){N("Contour load: missing 2D context",{canvasId:"srcCanvasEl"}),a("Load failed — canvas context not available.");return}l();const m=(await ge()).contourScale,h=m/100;let C=Math.max(64,Math.floor(g.naturalWidth*h)),w=Math.max(64,Math.floor(g.naturalHeight*h));const D=1600,k=Math.min(1,D/Math.max(C,w));C=Math.max(64,Math.floor(C*k)),w=Math.max(64,Math.floor(w*k)),s.width=C,s.height=w,d.imageSmoothingEnabled=!0,d.clearRect(0,0,s.width,s.height),d.drawImage(g,0,0,s.width,s.height),t.hasImage=!0,t.hasOutput=!1,t.edgeMask=void 0,t.repairedMask=void 0,t.smoothedMask=void 0,t.svgText=void 0,f(),u(),r(),a(`Loaded: ${t.loadedImageName} (${s.width}×${s.height})`),U("Contour load: done",{naturalW:g.naturalWidth,naturalH:g.naturalHeight,scalePct:m,maxSide:D,targetW:C,targetH:w,pixels:C*w,ms:Math.round((performance.now()-v)*10)/10})}catch(g){N("Contour load: exception",{error:g instanceof Error?g.message:String(g)}),a("Load failed — see console / debug trace.")}finally{URL.revokeObjectURL(b),i(!1)}})}async function Cn(e,t,o){const{setStatus:n,setContourBusyVisual:a,clearCleanCanvasesOnly:i,clearSvgPreview:l,updateEnabled:u}=o;if(!t.hasImage){_("Contour process: skipped (no image loaded)");return}const f=performance.now();await oe(e,async()=>{a(!0,"Processing…"),await new Promise(r=>{setTimeout(()=>{(async()=>{try{const c=e.srcCanvasEl,v=e.outCanvasEl,b=c.width,g=c.height,s=b*g,d=await ge(),p=d.edgeThreshold,m=d.invertOutput;U("Contour process: start",{width:b,height:g,pixels:s,threshold:p,whiteBg:m}),v.width=b,v.height=g;const h=v.getContext("2d",{willReadFrequently:!0}),C=c.getContext("2d",{willReadFrequently:!0});if(!C||!h){N("Contour process: missing 2D context",{hasSrc:!!C,hasOut:!!h}),n("Process failed — canvas context not available.");return}const D=C.getImageData(0,0,b,g).data,k=new Uint8ClampedArray(b*g);for(let I=0,R=0;I<D.length;I+=4,R++){const L=D[I],A=D[I+1],j=D[I+2];k[R]=.299*L+.587*A+.114*j|0}const M=[-1,0,1,-2,0,2,-1,0,1],x=[-1,-2,-1,0,0,0,1,2,1],S=new Uint8ClampedArray(b*g);for(let I=1;I<g-1;I++)for(let R=1;R<b-1;R++){let L=0,A=0,j=0;for(let X=-1;X<=1;X++)for(let G=-1;G<=1;G++){const ae=k[(I+X)*b+(R+G)];L+=ae*M[j],A+=ae*x[j],j++}const J=Math.min(255,Math.sqrt(L*L+A*A)|0);S[I*b+R]=J>=p?255:0}const y=h.createImageData(b,g),E=y.data;let P=0;for(let I=0,R=0;I<S.length;I++,R+=4){const L=S[I];if(L===255&&P++,m){const j=L===255?0:255;E[R]=j,E[R+1]=j,E[R+2]=j,E[R+3]=255}else E[R]=L,E[R+1]=L,E[R+2]=L,E[R+3]=255}h.putImageData(y,0,0),t.hasOutput=!0,t.edgeMask=void 0,t.repairedMask=void 0,t.smoothedMask=void 0,l(),i(),n("Done. You can clean/smooth or download the PNG."),U("Contour process: done",{width:b,height:g,pixels:s,threshold:p,whiteBg:m,edgePixels:P,edgeRatio:Math.round(P/Math.max(1,s)*1e6)/1e6,ms:Math.round((performance.now()-f)*10)/10})}catch(c){N("Contour process: exception",{error:c instanceof Error?c.message:String(c)}),n("Process failed — see console / debug trace.")}finally{r()}})()},0)}),a(!1),u()})}function Ue(e,t,o,n){const a=new ImageData(t,o),i=a.data;for(let l=0,u=0;l<e.length;l++,u+=4){const f=e[l]===1;if(n){const r=f?0:255;i[u]=r,i[u+1]=r,i[u+2]=r,i[u+3]=255}else{const r=f?255:0;i[u]=r,i[u+1]=r,i[u+2]=r,i[u+3]=255}}return a}function ve(e,t,o,n){const a=new Uint8Array(e.length),i=Math.max(1,n);for(let l=0;l<o;l++)for(let u=0;u<t;u++){let f=0;for(let r=-i;r<=i&&!f;r++){const c=l+r;if(c<0||c>=o)continue;const v=c*t;for(let b=-i;b<=i;b++){const g=u+b;if(!(g<0||g>=t)&&e[v+g]===1){f=1;break}}}a[l*t+u]=f}return a}function me(e,t,o,n){const a=new Uint8Array(e.length),i=Math.max(1,n);for(let l=0;l<o;l++)for(let u=0;u<t;u++){let f=1;for(let r=-i;r<=i&&f;r++){const c=l+r;if(c<0||c>=o){f=0;break}const v=c*t;for(let b=-i;b<=i;b++){const g=u+b;if(g<0||g>=t){f=0;break}if(e[v+g]===0){f=0;break}}}a[l*t+u]=f}return a}function st(e,t,o,n){const a=new Uint8Array(e),i=new Uint8Array(e.length),l=new Int32Array(e.length),u=new Int32Array(e.length);for(let f=0;f<o;f++)for(let r=0;r<t;r++){const c=f*t+r;if(e[c]===0||i[c]===1)continue;let v=0,b=0;i[c]=1,l[b]=r,u[b]=f,b++;const g=[c];for(;v<b;){const s=l[v],d=u[v];v++;const p=[[s-1,d],[s+1,d],[s,d-1],[s,d+1]];for(const[m,h]of p){if(m<0||m>=t||h<0||h>=o)continue;const C=h*t+m;e[C]===0||i[C]===1||(i[C]=1,l[b]=m,u[b]=h,b++,g.push(C))}}if(g.length<n)for(const s of g)a[s]=0}return a}const wn=Le();function Sn(){return{opencvReady:Q()}}async function xn(e){const t=await te(),o=Sn(),n=nt(e,wn,t,o);{const a=Number(n.params.cleanMinArea??12);return{engine:n.engine,params:{cleanMinArea:a},fallbackReason:n.fallbackReason,opencvReady:!!o.opencvReady}}}async function kn(e,t,o){const{engine:n,params:a,fallbackReason:i,opencvReady:l}=await xn(e);return n==="opencv"&&!l?(_(`OpenCV selected for ${e} but not ready; falling back to native. ${i??""}`.trim()),await o[e].native(t,a)):await o[e][n](t,a)}function Dn(){const e=globalThis;return e!=null&&e.cv&&typeof e.cv.Mat=="function"?e.cv:null}function Tn(e,t){const{width:o,height:n}=e,a=Math.max(0,Math.floor(Number(t.cleanMinArea??0)));if(U("oopenCV RemoveSmallComponents: params",{width:o,height:n,minArea:a}),a<=1)return e.mask;const i=Dn();if(!i)return st(e.mask,o,n,a);const l=new i.Mat(n,o,i.CV_8UC1);try{const u=l.data,f=e.mask;for(let b=0;b<f.length;b++)u[b]=f[b]?255:0;const r=new i.Mat,c=new i.Mat,v=new i.Mat;try{const b=i.connectedComponentsWithStats(l,r,c,v,8,i.CV_32S),g=i.CC_STAT_AREA??4,s=new Array(b).fill(!1);for(let m=1;m<b;m++)c.intAt(m,g)<a&&(s[m]=!0);const d=new Uint8Array(o*n),p=r.data32S;for(let m=0;m<d.length;m++){const h=p[m];d[m]=h>0&&!s[h]?1:0}return d}finally{r.delete(),c.delete(),v.delete()}}finally{l.delete()}}const In={"contour.clean.removeSmallComponents":{native:(e,t)=>st(e.mask,e.width,e.height,t.cleanMinArea),opencv:(e,t)=>(O("OpenCV removeSmallComponents called (demo).",{width:e.width,height:e.height,cleanMinArea:t.cleanMinArea}),Tn(e,t))}};async function Rn(e,t){return kn(e,t,In)}async function Ln(e,t,o){const{setStatus:n,setContourBusyVisual:a,clearSvgPreview:i,updateEnabled:l,updateCleanQualityUI:u}=o;if(!t.hasOutput){_("Contour clean: skipped (no output present)");return}const f=performance.now();await oe(e,async()=>{a(!0,"Cleaning…"),await new Promise(r=>{setTimeout(()=>{(async()=>{try{const c=e.outCanvasEl,v=e.clean1CanvasEl,b=e.clean2CanvasEl,g=await ge(),s=g.cleanRadius,d=g.cleanBinaryThreshold,p=g.invertOutput;v.width=c.width,v.height=c.height,b.width=c.width,b.height=c.height;const m=c.width,h=c.height,C=m*h;U("Contour clean: start",{width:m,height:h,pixels:C,whiteBg:p,EDGE_T:d,radius:s});const w=c.getContext("2d",{willReadFrequently:!0}),D=v.getContext("2d",{willReadFrequently:!0}),k=b.getContext("2d",{willReadFrequently:!0});if(!w||!D||!k){N("Contour clean: missing 2D context",{hasOut:!!w,hasC1:!!D,hasC2:!!k}),n("Clean failed — canvas context not available.");return}const x=w.getImageData(0,0,m,h).data,S=new Uint8Array(m*h);let y=0;for(let A=0,j=0;A<S.length;A++,j+=4){const J=x[j],G=(p?J<d:J>=d)?1:0;S[A]=G,G===1&&y++}U("Contour removeSmallComponents: params",{edge:S,width:m,height:h});const E=await Rn("contour.clean.removeSmallComponents",{mask:S,width:m,height:h});U("Contour erode : params",{edgeNoSpeck:E,width:m,height:h,radius:s});const P=me(ve(E,m,h,s),m,h,s);D.putImageData(Ue(P,m,h,p),0,0),U("Contour dilate : params",{repaired:P,width:m,height:h,radius:s});const I=ve(me(P,m,h,s),m,h,s);U("Contour erode : params",{opened:I,width:m,height:h,radius:s});const R=me(ve(I,m,h,s),m,h,s);k.putImageData(Ue(R,m,h,p),0,0),t.edgeMask=S,t.repairedMask=P,t.smoothedMask=R,i();const L=We(R,m,h);u(m,h),n(`Clean done — CC:${L.components} endpoints:${L.endpoints} junctions:${L.junctions} thickness:${L.thicknessRatio.toFixed(2)}`),U("Contour clean: done",{width:m,height:h,pixels:C,whiteBg:p,EDGE_T:d,radius:s,edgeOn:y,edgeRatio:Math.round(y/Math.max(1,C)*1e6)/1e6,quality:L,ms:Math.round((performance.now()-f)*10)/10})}catch(c){N("Contour clean: exception",{error:c instanceof Error?c.message:String(c)}),n("Clean failed — see console / debug trace.")}finally{r()}})()},0)}),a(!1),l()})}function Pn(e,t,o){const n=new Uint8Array(e.length),a=[];function i(g,s){return s*t+g}function l(g,s){return g<0||s<0||g>=t||s>=o?!1:e[i(g,s)]===1}function u(g,s){if(!l(g,s))return!1;for(let d=-1;d<=1;d++)for(let p=-1;p<=1;p++)if(!(p===0&&d===0)&&!l(g+p,s+d))return!0;return!1}const f=[{dx:1,dy:0},{dx:1,dy:1},{dx:0,dy:1},{dx:-1,dy:1},{dx:-1,dy:0},{dx:-1,dy:-1},{dx:0,dy:-1},{dx:1,dy:-1}],r=2e3,c=Math.max(2e3,Math.floor((t+o)*2)),v=Math.max(2e5,Math.floor(t*o*.25));let b=0;for(let g=0;g<o;g++)for(let s=0;s<t;s++){if(a.length>=r||b>=v)return a;const d=i(s,g);if(n[d]===1||!u(s,g))continue;const p=[];let m=s,h=g,C=4,w=0;const D=Math.min(t*o,c*4);for(;w<D;){w++;const k=i(m,h);if(n[k]===1||(p.push({x:m,y:h}),n[k]=1,b++,p.length>=c)||b>=v)break;let M=!1;const x=(C+6)%8;for(let S=0;S<8;S++){const y=(x+S)%8,E=m+f[y].dx,P=h+f[y].dy;if(!u(E,P))continue;const I=i(E,P);if(!(!(E===s&&P===g&&p.length>10)&&n[I]===1)){m=E,h=P,C=y,M=!0;break}}if(!M||m===s&&h===g&&p.length>10)break}p.length>=20&&a.push(p)}return a}function Ne(e,t){if(e.length<3)return e;const o=t*t;function n(r,c,v){const b=v.x-c.x,g=v.y-c.y,s=r.x-c.x,d=r.y-c.y,p=b*s+g*d;if(p<=0)return(r.x-c.x)**2+(r.y-c.y)**2;const m=b*b+g*g;if(m<=p)return(r.x-v.x)**2+(r.y-v.y)**2;const h=p/m,C=c.x+h*b,w=c.y+h*g;return(r.x-C)**2+(r.y-w)**2}const a=new Uint8Array(e.length);a[0]=1,a[e.length-1]=1;const i=[0],l=[e.length-1];for(;i.length>0;){const r=i.pop(),c=l.pop();if(c<=r+1)continue;const v=e[r],b=e[c];let g=0,s=-1;for(let d=r+1;d<c;d++){const p=n(e[d],v,b);p>g&&(g=p,s=d)}s!==-1&&g>o&&(a[s]=1,i.push(r),l.push(s),i.push(s),l.push(c))}const u=[];for(let r=0;r<e.length;r++)a[r]===1&&u.push(e[r]);const f=[];for(const r of u){const c=f[f.length-1];(!c||c.x!==r.x||c.y!==r.y)&&f.push(r)}return f}function Mn(e,t){let o=e;for(let n=0;n<t;n++){if(o.length<3)return o;const a=[];for(let c=0;c<o.length-1;c++){const v=o[c],b=o[c+1];a.push({x:.75*v.x+.25*b.x,y:.75*v.y+.25*b.y},{x:.25*v.x+.75*b.x,y:.25*v.y+.75*b.y})}const i=o[0],l=o[o.length-1],u=i.x-l.x,f=i.y-l.y;if(u*u+f*f<=4){const c=o[o.length-1],v=o[0];a.push({x:.75*c.x+.25*v.x,y:.75*c.y+.25*v.y},{x:.25*c.x+.75*v.x,y:.25*c.y+.75*v.y})}o=a}return o}function On(e,t,o){const n=[];for(const a of e){const i=Bn(a);i&&n.push(`<path d="${i}" fill="none" stroke="#000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>`)}return`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${t}" height="${o}" viewBox="0 0 ${t} ${o}">
<rect x="0" y="0" width="${t}" height="${o}" fill="#fff"/>
`+n.join(`
`)+`
</svg>
`}function Bn(e){if(e.length<2)return"";const t=e.slice(),o=t[0],n=t[t.length-1],a=o.x-n.x,i=o.y-n.y,l=a*a+i*i<=4;l&&t.push({x:o.x,y:o.y});let u=`M ${t[0].x.toFixed(2)} ${t[0].y.toFixed(2)}`;for(let f=0;f<t.length-1;f++){const r=t[Math.max(0,f-1)],c=t[f],v=t[f+1],b=t[Math.min(t.length-1,f+2)],g=c.x+(v.x-r.x)/6,s=c.y+(v.y-r.y)/6,d=v.x-(b.x-c.x)/6,p=v.y-(b.y-c.y)/6;u+=` C ${g.toFixed(2)} ${s.toFixed(2)}, ${d.toFixed(2)} ${p.toFixed(2)}, ${v.x.toFixed(2)} ${v.y.toFixed(2)}`}return l&&(u+=" Z"),u}async function An(e,t,o){if(!t.smoothedMask){_("Contour vectorize: skipped (no smoothed mask present)");return}const n=performance.now();await oe(e,async()=>{o.setContourBusyVisual(!0,"Vectorizing…");const a=()=>{t.svgText=void 0,e.svgPreviewTextEl.textContent="",e.svgPreviewImgEl.removeAttribute("src")};try{await new Promise((i,l)=>{setTimeout(()=>{(async()=>{try{const u=t.smoothedMask,f=e.outCanvasEl.width,r=e.outCanvasEl.height,c=f*r,v=1.5,g=(await ge()).pathSmoothIters;U("Contour vectorize: start",{width:f,height:r,pixels:c,epsilon:v,smoothIters:g});const s=Pn(u,f,r),d=s.length,p=s.reduce((x,S)=>x+S.length,0),m=s.reduce((x,S)=>Math.max(x,S.length),0);if(d===0||p===0){_("Contour vectorize: no boundaries found",{width:f,height:r,pixels:c,pathsRaw:d,pointsRaw:p}),a(),o.setStatus("No boundaries found to vectorize."),i();return}if(d>2e3||p>2e5){_("Contour vectorize: aborted (too complex)",{width:f,height:r,pixels:c,pathsRaw:d,pointsRaw:p,maxPolyline:m}),a(),o.setStatus(`Vectorize aborted: too complex (paths ${d}, points ${p}). Try stronger clean / higher minArea / lower resolution.`),i();return}U("Contour vectorize: traced boundaries",{pathsRaw:d,pointsRaw:p,maxPolyline:m});const h=s.filter(x=>x.length>=20).map(x=>{const S=Ne(x,v),y=g>0?Mn(S,g):S;return Ne(y,v)}).filter(x=>x.length>=3),C=h.length,w=h.reduce((x,S)=>x+S.length,0),D=h.reduce((x,S)=>Math.max(x,S.length),0);if(C===0||w===0){_("Contour vectorize: simplified to nothing",{pathsRaw:d,pointsRaw:p,pathsOut:C,pointsOut:w,smoothIters:g,epsilon:v}),a(),o.setStatus("Vectorize produced no usable paths (after simplification)."),i();return}U("Contour vectorize: simplified",{pathsOut:C,pointsOut:w,maxOut:D,smoothIters:g,epsilon:v});const k=On(h,f,r);t.svgText=k,e.svgPreviewTextEl.textContent=k;const M=encodeURIComponent(k).replace(/'/g,"%27").replace(/"/g,"%22");e.svgPreviewImgEl.src=`data:image/svg+xml;charset=utf-8,${M}`,o.setStatus(`SVG generated: paths ${C}, points ${p}→${w}, smooth ${g}`),U("Contour vectorize: done",{width:f,height:r,pixels:c,smoothIters:g,epsilon:v,pathsRaw:d,pointsRaw:p,pathsOut:C,pointsOut:w,svgChars:k.length,ms:Math.round((performance.now()-n)*10)/10}),i()}catch(u){N("Contour vectorize: exception",{error:u instanceof Error?u.message:String(u),ms:Math.round((performance.now()-n)*10)/10}),l(u)}})()},0)})}catch(i){o.showError("Vectorize",i),a()}finally{o.setContourBusyVisual(!1),o.updateEnabled()}})}function $n(e,t){const o=tn(),n=on(e,o);function a(){const f=e.dropZoneEl;function r(c){f.classList.toggle("is-hover",c)}f.addEventListener("dragover",c=>{c.preventDefault(),r(!0)}),f.addEventListener("dragleave",()=>r(!1)),f.addEventListener("drop",c=>{var b;c.preventDefault(),r(!1);const v=(b=c.dataTransfer)==null?void 0:b.files;!v||v.length===0||Ve(e,o,v[0],{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearCanvases:n.clearCanvases,clearCleanCanvasesOnly:n.clearCleanCanvasesOnly,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,getNumber:n.getNumber})}),e.fileInputEl.addEventListener("change",()=>{var v;const c=(v=e.fileInputEl.files)==null?void 0:v[0];c&&(Ve(e,o,c,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearCanvases:n.clearCanvases,clearCleanCanvasesOnly:n.clearCleanCanvasesOnly,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,getNumber:n.getNumber}),e.fileInputEl.value="")})}function i(){a(),e.btnDownloadEl.addEventListener("click",()=>n.downloadPng()),e.btnDownloadSvgEl.addEventListener("click",()=>n.downloadSvg()),e.btnProcessEl.addEventListener("click",()=>{Cn(e,o,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearCleanCanvasesOnly:n.clearCleanCanvasesOnly,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled})}),e.btnCleanEl.addEventListener("click",()=>{Ln(e,o,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,clearSvgPreview:n.clearSvgPreview,updateEnabled:n.updateEnabled,updateCleanQualityUI:n.updateCleanQualityUI})}),e.btnVectorizeEl.addEventListener("click",()=>{An(e,o,{setStatus:n.setStatus,setContourBusyVisual:n.setContourBusyVisual,updateEnabled:n.updateEnabled,showError:n.showError,getNumber:n.getNumber})}),nn(o),n.clearSvgPreview(),n.updateEnabled(),n.setStatus("No image loaded"),e.contourSpinnerEl.classList.add("is-hidden")}function l(){}function u(){}return{id:"contour",bind:i,mount:l,unmount:u}}function Vn(){return{status:"Idle",report:["Segmentation placeholder","","Planned:","- Multi-step segmentation pipeline (process1..processN)","- Per-step engine selection: native / opencv / auto","- OpenCV injection + probing is managed in Settings (demo-only)."].join(`
`)}}function Un(e){function t(){const n=e.viewSegmentation,a=n.querySelector('pre[data-bct="seg-report"]');if(a)return a;const i=document.createElement("pre");return i.className="report",i.setAttribute("data-bct","seg-report"),i.setAttribute("aria-label","Segmentation placeholder report"),i.style.marginTop="10px",n.appendChild(i),i}function o(n){const a=e.viewSegmentation.querySelector(".status");a&&(a.textContent=n.status);const i=t();i.textContent=n.report}return{set:o}}function Nn(e,t){const o=Vn(),n=Un(e);function a(){}function i(){O("[segmentation] mount (placeholder)"),o.status="Idle",n.set(o)}function l(){O("[segmentation] refresh (placeholder)"),n.set(o)}function u(){}function f(){}return{bind:a,mount:i,refresh:l,unmount:u,dispose:f}}function be(e,t,o){return Number.isFinite(e)?Math.max(t,Math.min(o,Math.trunc(e))):t}function jn(e,t,o){return Math.round(.2126*e+.7152*t+.0722*o)}function it(e){return{edgesDark:!!(e.edgesDark??!0),edgeThreshold:be(e.edgeThreshold??80,0,255),edgeDilate:be(e.edgeDilate??2,0,6),maxRegionPx:be(e.maxRegionPx??2e5,1e3,1e7)}}function Fn(e,t,o){const{data:n,width:a,height:i}=e,l=new Uint8Array(a*i);for(let u=0,f=0;u<l.length;u++,f+=4){const r=n[f+0],c=n[f+1],v=n[f+2];if(n[f+3]===0){l[u]=0;continue}const g=jn(r,c,v),s=t?g<=o:g>=255-o;l[u]=s?1:0}return l}function _n(e,t,o,n){if(n<=0)return e;let a=e;for(let i=0;i<n;i++){const l=new Uint8Array(t*o);for(let u=0;u<o;u++)for(let f=0;f<t;f++){const r=u*t+f;if(a[r]){l[r]=1;continue}let c=0;for(let v=-1;v<=1&&!c;v++){const b=u+v;if(!(b<0||b>=o))for(let g=-1;g<=1;g++){const s=f+g;if(!(s<0||s>=t)&&a[b*t+s]){c=1;break}}}l[r]=c}a=l}return a}function zn(e,t,o,n,a,i){const l=t*n+e;if(o[l])return{ok:!1,message:"Click is on an edge; pick inside a region."};const u=new Uint8Array(n*a),f=new Int32Array(n*a),r=new Int32Array(n*a);let c=0,v=0;f[v]=e,r[v]=t,v++,u[l]=1;let b=1;for(;c<v;){const g=f[c],s=r[c];c++;const d=[[g-1,s],[g+1,s],[g,s-1],[g,s+1]];for(const[p,m]of d){if(p<0||p>=n||m<0||m>=a)continue;const h=m*n+p;if(!u[h]&&!o[h]&&(u[h]=1,f[v]=p,r[v]=m,v++,b++,b>i))return{ok:!1,message:`Region too large (>${i}px). Increase Max region or fix gaps.`}}}return{ok:!0,mask:u}}function qn(e,t,o,n){const a=new Uint8Array(o*n);for(let i=1;i<n-1;i++)for(let l=1;l<o-1;l++){const u=i*o+l;if(!e[u])continue;const f=(i-1)*o+l,r=(i+1)*o+l,c=i*o+(l-1),v=i*o+(l+1);(!e[f]||!e[r]||!e[c]||!e[v]||t[f]||t[r]||t[c]||t[v])&&(a[u]=1)}return a}function Gn(e,t,o,n){const a=it(n),i=e.width,l=e.height;let u=Fn(e,a.edgesDark,a.edgeThreshold);u=_n(u,i,l,a.edgeDilate);const f=zn(t,o,u,i,l,a.maxRegionPx);if(!f.ok)return{ok:!1,message:f.message};const r=qn(f.mask,u,i,l);return{ok:!0,preview:{mask:f.mask,outline:r,w:i,h:l}}}function Qn(e,t,o){const n=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),a=o.replace("#",""),i=parseInt(a.slice(0,2),16),l=parseInt(a.slice(2,4),16),u=parseInt(a.slice(4,6),16),f=n.data;for(let r=0,c=0;r<t.mask.length;r++,c+=4)t.mask[r]&&(f[c+0]=i,f[c+1]=l,f[c+2]=u);return n}function he(e,t,o){return Number.isFinite(e)?Math.max(t,Math.min(o,Math.trunc(e))):t}function je(e){const t=(e||"").trim();if(!t)return null;const o=t.startsWith("#")?t:`#${t}`;return/^#[0-9a-fA-F]{6}$/.test(o)?o.toLowerCase():null}function Hn(e){let t="#ff3b30",o=[],n=null;function a(d){e.colorsStatusEl.textContent=d||""}function i(){const d=!!e.edgesDarkEl.checked,p=he(parseInt(e.edgeMaskThresholdEl.value,10),0,255),m=he(parseInt(e.edgeDilateEl.value,10),0,6),h=he(parseInt(e.maxRegionPxEl.value,10),1e3,1e7);return e.edgeMaskThresholdEl.value=String(p),e.edgeDilateEl.value=String(m),e.maxRegionPxEl.value=String(h),it({edgesDark:d,edgeThreshold:p,edgeDilate:m,maxRegionPx:h})}function l(d){const p=je(d);if(p){t=p;for(const m of Array.from(e.paletteEl.querySelectorAll(".paletteItem"))){const h=m.dataset.hex||"";m.classList.toggle("is-selected",h===t)}}}function u(){return t}function f(d){o=d.slice(),e.paletteEl.innerHTML="";for(const p of o){const m=je(p);if(!m)continue;const h=document.createElement("button");h.type="button",h.className="paletteItem",h.style.background=m,h.dataset.hex=m,h.setAttribute("role","listitem"),h.setAttribute("aria-label",`Select ${m}`),h.addEventListener("click",()=>{l(m)}),e.paletteEl.appendChild(h)}l(t)}function r(d){const p=e.colorsCanvasEl;p.width=d.width,p.height=d.height,p.getContext("2d").putImageData(d,0,0)}function c(d,p){r(d);const m=e.colorsCanvasEl.getContext("2d"),{outline:h,w:C,h:w}=p,D=m.getImageData(0,0,C,w),k=D.data;for(let M=0,x=0;M<h.length;M++,x+=4)h[M]&&(k[x+0]=255,k[x+1]=60,k[x+2]=60,k[x+3]=220);m.putImageData(D,0,0)}function v(d){e.btnColorsApplyEl.disabled=!d}function b(d){e.btnColorsCancelEl.disabled=!d}function g(d){n=d}function s(){a("Idle"),v(!1),b(!1),e.colorsCanvasEl.addEventListener("click",d=>{if(!n)return;const p=e.colorsCanvasEl.getBoundingClientRect(),m=Math.floor((d.clientX-p.left)/p.width*e.colorsCanvasEl.width),h=Math.floor((d.clientY-p.top)/p.height*e.colorsCanvasEl.height);n(m,h)})}return{bind:s,setStatus:a,getSettings:i,setSelectedColor:l,getSelectedColor:u,renderPalette:f,drawBase:r,drawPreview:c,setApplyEnabled:v,setCancelEnabled:b,onCanvasClick:g}}const Kn=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#a2845e","#8e8e93","#1c1c1e","#ffffff","#000000","#4cd964","#5ac8fa","#ff6b6b","#7aa2ff","#f5a623","#50e3c2"];function Wn(e,t){const o=Hn(e);let n=null,a=null;function i(v){o.setStatus(v)}function l(){const v=e.outCanvasEl.getContext("2d");if(!v)return null;const b=e.outCanvasEl.width,g=e.outCanvasEl.height;return b<=0||g<=0?null:v.getImageData(0,0,b,g)}function u(){const v=l();if(!v){n=null,a=null,o.setApplyEnabled(!1),o.setCancelEnabled(!1),i("No output available. Run Process first.");return}n=v,a=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),i("Ready. Pick a color, click inside a region.")}function f(){if(n){o.drawBase(n);return}const v=l();if(!v){i("No output available. Run Process first.");return}n=v,a=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),i("Loaded output. Pick a color, click inside a region.")}function r(){if(!n||!a)return;const v=o.getSelectedColor();n=Qn(n,a,v),a=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),i("Fill applied. Click another region.")}function c(){n&&(a=null,o.drawBase(n),o.setApplyEnabled(!1),o.setCancelEnabled(!1),i("Preview canceled."))}return{bind(){o.bind(),o.renderPalette(Kn),o.onCanvasClick((v,b)=>{if(!n){i("No output available. Run Process first.");return}const g=o.getSettings(),s=Gn(n,v,b,g);if(!s.ok){a=null,o.setApplyEnabled(!1),o.setCancelEnabled(!1),i(s.message);return}a=s.preview,o.drawPreview(n,a),o.setApplyEnabled(!0),o.setCancelEnabled(!0),i("Preview shown. Apply fill or cancel.")}),e.btnColorsApplyEl.addEventListener("click",()=>r()),e.btnColorsCancelEl.addEventListener("click",()=>c()),e.btnColorsResetEl.addEventListener("click",()=>u()),e.tabColors.addEventListener("click",()=>{queueMicrotask(()=>f())}),i("Idle"),o.setApplyEnabled(!1),o.setCancelEnabled(!1)}}}const ue="beecontour.actionLog",Yn=5e3;function Jn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function Xn(e){return Array.isArray(e)?e:[e]}function de(e,t,o){return Math.max(t,Math.min(o,Math.floor(e)))}async function ne(){const e=await W(ue),t=e==null?void 0:e[ue];return Array.isArray(t)?t:[]}async function rt(e){await Y({[ue]:e})}async function K(e,t){const o=de(Yn,100,5e4),a=Xn(e).map(f=>({...f,id:Jn(),ts:Date.now()}));if(!a.length)return{total:(await ne()).length};const l=(await ne()).concat(a),u=l.length>o?l.slice(l.length-o):l;return await rt(u),{total:u.length}}async function Zn(e){const t=de((e==null?void 0:e.limit)??200,1,5e4),o=de((e==null?void 0:e.offset)??0,0,1e6);let a=await ne();e!=null&&e.kind&&(a=a.filter(u=>u.kind===e.kind)),e!=null&&e.scope&&(a=a.filter(u=>u.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(a=a.filter(u=>u.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(a=a.filter(u=>u.ts<=e.untilTs));const i=a.length;a=a.slice().reverse();const l=a.slice(o,o+t);return{total:i,items:l}}async function eo(e){let o=await ne();if(typeof e.beforeTs=="number"&&(o=o.filter(n=>n.ts>=e.beforeTs)),typeof e.keepLast=="number"){const n=de(e.keepLast,0,5e4);n===0?o=[]:o.length>n&&(o=o.slice(o.length-n))}return await rt(o),{total:o.length}}async function to(){await Te(ue)}async function no(e){const t=await ne();return JSON.stringify(t,null,2)}const Fe="0.0.7";async function oo(e){const t=new URL(e.opencvJsRel,document.baseURI).toString(),o=new URL(e.opencvWasmRel,document.baseURI).toString(),n=globalThis;n.Module=n.Module||{},n.Module.locateFile=a=>a.endsWith(".wasm")?o:a,n.Module.print=()=>{},n.Module.printErr=()=>{},n.cv||await ao(t),await so(e.timeoutMs)}function ao(e){return new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0;const a=15e3,i=window.setTimeout(()=>{l(),o(new Error(`OpenCV script load timeout after ${a}ms: ${e}`))},a);function l(){window.clearTimeout(i),n.onload=null,n.onerror=null}n.onload=()=>{l(),t()},n.onerror=()=>{l(),o(new Error(`Failed to load OpenCV script: ${e}`))},document.head.appendChild(n)})}async function so(e){var n;const t=Date.now(),o=globalThis;for(;Date.now()-t<e;){try{if(o.cv&&typeof o.cv.Mat=="function"){const a=new o.cv.Mat;(n=a.delete)==null||n.call(a);return}}catch{}await new Promise(a=>setTimeout(a,75))}throw new Error(`OpenCV initialization timeout after ${e}ms`)}async function io(){try{await oo({opencvJsRel:"../assets/opencv/opencv.js",opencvWasmRel:"../assets/opencv/opencv.wasm",timeoutMs:2e4}),vn("opencv")}catch(e){throw mn("opencv",e!=null&&e.message?String(e.message):String(e)),e}}function T(e,t,o){const n=document.createElement(e);if(t)for(const[a,i]of Object.entries(t))n.setAttribute(a,i);return typeof o=="string"&&(n.textContent=o),n}function _e(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function ro(e){return e.fallbackReason?`${e.effectiveEngine} (fallback)`:e.effectiveEngine}function co(e){const t=[{value:"native",label:"Native"},{value:"auto",label:"Auto"},...e.canImplementOpenCv?[{value:"opencv",label:"OpenCV"}]:[]];return e.isRoot?t:[{value:"inherit",label:"Inherit"},...t]}function lo(e,t,o){var a;const n=(a=e.storedParams)==null?void 0:a[t];return typeof n<"u"&&n!==o}function uo(e){var v;const{node:t,compId:o,key:n,schema:a,value:i,handlers:l}=e,u=T("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),f=T("label",{class:"fieldInline"}),r=T("span",void 0,a.label);f.appendChild(r);let c;if(a.kind==="number"?(c=T("input"),c.type="number",typeof a.min=="number"&&(c.min=String(a.min)),typeof a.max=="number"&&(c.max=String(a.max)),typeof a.step=="number"&&(c.step=String(a.step)),c.value=String(i??a.default),c.addEventListener("change",()=>{const b=Number(c.value);l.onSetParam(o,n,Number.isFinite(b)?b:a.default)})):a.kind==="boolean"?(c=T("input"),c.type="checkbox",c.checked=!!i,c.addEventListener("change",()=>{l.onSetParam(o,n,!!c.checked)})):(c=T("input"),c.type="text",c.value=String(i??a.default),c.addEventListener("change",()=>{l.onSetParam(o,n,String(c.value??a.default))})),f.appendChild(c),u.appendChild(f),l.onResetParam&&typeof((v=t.storedParams)==null?void 0:v[n])<"u"){const b=T("button",{type:"button"},"Reset");b.addEventListener("click",g=>{var s;g.preventDefault(),(s=l.onResetParam)==null||s.call(l,o,n)}),u.appendChild(b)}return lo(t,n,i)&&u.appendChild(T("span",{class:"muted",style:"font-size:12px;"},"override")),u}function ct(e){const{node:t,depth:o,isRoot:n,handlers:a}=e,i=T("div",{style:`margin-left:${Math.min(o*14,56)}px; margin-top:10px;`}),l=T("div",{style:"border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:10px; background:rgba(0,0,0,0.12);"}),u=T("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),f=T("div");f.appendChild(T("div",{style:"font-weight:700;"},t.title)),t.description&&f.appendChild(T("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},t.description)),t.isGroup&&f.appendChild(T("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},"Group (policy affects children)")),u.appendChild(f);const r=T("div",{class:"row",style:"align-items:center; gap:10px;"});r.appendChild(T("span",{class:"qBadge"},ro(t)));const c=T("select");c.style.background="rgba(255,255,255,0.05)",c.style.border="1px solid rgba(255,255,255,0.08)",c.style.color="rgba(255,255,255,0.92)",c.style.borderRadius="10px",c.style.padding="6px 8px";const v=co({isRoot:n,canImplementOpenCv:t.canImplementOpenCv});for(const p of v){const m=T("option");m.value=p.value,m.textContent=p.label,c.appendChild(m)}const b=new Set(v.map(p=>p.value)),g=t.effectivePolicy;b.has(g)?c.value=g:c.value=n?"native":"inherit",c.addEventListener("change",()=>{a.onSetPolicy(t.id,c.value)}),r.appendChild(c);const s=typeof t.storedPolicy<"u"||t.storedParams&&Object.keys(t.storedParams).length>0;if(a.onResetNode&&s){const p=T("button",{type:"button"},"Reset node");p.addEventListener("click",m=>{var h;m.preventDefault(),(h=a.onResetNode)==null||h.call(a,t.id)}),r.appendChild(p)}u.appendChild(r),l.appendChild(u),t.fallbackReason?l.appendChild(T("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},t.fallbackReason)):t.effectivePolicy==="opencv"&&!t.runtimeOpenCvReady&&l.appendChild(T("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},"OpenCV policy selected, but OpenCV is not available at runtime. It will fall back to native."));const d=Object.keys(t.paramsSchema??{});if(d.length>0){const p=T("div",{style:"margin-top:10px;"});p.appendChild(T("div",{class:"muted",style:"font-weight:600; margin-bottom:6px;"},"Parameters"));for(const m of d){const h=t.paramsSchema[m],C=t.effectiveParams[m];p.appendChild(uo({node:t,compId:t.id,key:m,schema:h,value:C,handlers:a}))}l.appendChild(p)}if(t.children.length>0){const p=T("div",{style:"margin-top:10px;"});for(const m of t.children)p.appendChild(ct({node:m,depth:o+1,isRoot:!1,handlers:a}));l.appendChild(p)}return i.appendChild(l),i}function lt(e,t){let o=!1;function n(i){if(o)return;_e(e);const l=i.scopeId==="app",u=T("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"});u.appendChild(T("div",{style:"font-weight:700;"},"Tuning")),u.appendChild(T("div",{class:"muted",style:"font-size:12px;"},`OpenCV runtime: ${i.runtime.opencvReady?"ready":"not available"}`)),e.appendChild(u),e.appendChild(ct({node:i.root,depth:0,isRoot:l,handlers:t}))}function a(){o=!0,_e(e)}return{render:n,dispose:a}}function go(){let e=!1,t={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},o=!1,n="",a="";function i(r){e=r}function l(r){t={...t,...r}}function u(r){o=r}function f(r){typeof r.general=="string"&&(n=r.general),typeof r.dev=="string"&&(a=r.dev)}return{get showDevTools(){return e},get dev(){return t},get debugEnabled(){return o},get generalStatus(){return n},get devStatus(){return a},setShowDevTools:i,setDev:l,setDebugEnabled:u,setStatus:f}}function fo(e){function t(r){e.settingsGeneralStatusEl.textContent=r||""}function o(r){e.cfgStatusEl.textContent=r||""}function n(r){e.cfgShowDevToolsEl.checked=r}function a(r){e.tabLogs.hidden=!r,e.devConfigDetailsEl.classList.toggle("is-hidden",!r),r||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function i(r){e.cfgTraceConsoleEl.checked=!!r.traceConsole,e.cfgActionLogMaxEl.value=String(r.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(r.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(r.failureLogsPerRun??50)}function l(r){e.logsCbDebugEl.checked=r}function u(r,c){e.settingsVersionEl.textContent=r||"—",e.settingsGitHubLinkEl.href=c||"#",e.settingsGitHubLinkEl.hidden=!c}function f(r){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=r,e.cfgActionLogMaxEl.disabled=r,e.cfgDebugTraceMaxEl.disabled=r,e.cfgFailureLogsPerRunEl.disabled=r,e.btnCfgResetDefaults.disabled=r,e.logsCbDebugEl.disabled=r,e.cfgUseOpenCvEl.disabled=r}return{setGeneralStatus:t,setDevStatus:o,setShowDevToolsChecked:n,setDevToolsVisible:a,setDevConfig:i,setDebugEnabledChecked:l,setAbout:u,setBusy:f}}const ye="template.settings.showDevTools",Ee="beecontour.settings.engine.useOpenCv";function po(){var e,t;try{const o=(e=globalThis==null?void 0:globalThis.chrome)==null?void 0:e.runtime,n=(t=o==null?void 0:o.getManifest)==null?void 0:t.call(o),a=typeof(n==null?void 0:n.version)=="string"?n.version:"";if(O("Settings: getManifestVersion manifest found version is ",{v:a}),a)return a}catch{}return O("Settings: getManifestVersion fallback",{APP_VERSION:Fe}),Fe}function Ce(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??V.actionLogMax),debugTraceMax:Number(e.debugTraceMax??V.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??V.failureLogsPerRun)}}function vo(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:q(e.cfgActionLogMaxEl.value,100,5e4,V.actionLogMax),debugTraceMax:q(e.cfgDebugTraceMaxEl.value,100,5e4,V.debugTraceMax),failureLogsPerRun:q(e.cfgFailureLogsPerRunEl.value,0,5e4,V.failureLogsPerRun)}}async function ze(e){const t=et;return typeof t.setEnabled=="function"?(await t.setEnabled(e),{ok:!0}):typeof t.enable=="function"&&typeof t.disable=="function"?(await(e?t.enable():t.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function mo(e,t){const o=go(),n=fo(e),a=Me({getRuntimeAvailability:()=>({opencvReady:e.cfgUseOpenCvEl.checked&&Q()})}),i=lt(e.tuningMountEl,{onSetPolicy:async(y,E)=>{await a.setEnginePolicy(y,E),await h("policy change")},onSetParam:async(y,E,P)=>{await a.setParam(y,E,P),await h("param change")},onResetNode:async y=>{await a.resetNode(y),await h("reset node")},onResetParam:async(y,E)=>{await a.resetParam(y,E),await h("reset param")}});function l(y){e.settingsEngineBoxEl.classList.toggle("is-hidden",!1)}async function u(){const y=await W([Ee]).catch(()=>({}));return(y==null?void 0:y[Ee])===!0}async function f(y){await Y({[Ee]:!!y}).catch(()=>null)}function r(y){var E;e.cfgUseOpenCvEl.checked=y,(E=e.cfgUseOpenCvEl.closest(".switch"))==null||E.classList.toggle("is-disabled",e.cfgUseOpenCvEl.disabled)}function c(y){e.cfgOpenCvSpinner.classList.toggle("is-hidden",!y),e.cfgOpenCvSpinner.setAttribute("aria-hidden",y?"false":"true")}function v(y){e.cfgOpenCvStatus.textContent=y||""}function b(y){e.cfgOpenCvReport.textContent=y||""}async function g(){if($())return;if(!!!e.cfgUseOpenCvEl.checked){await f(!1),c(!1),v(Q()?"OpenCV loaded (native mode)":"Native mode"),b("Native mode. OpenCV is optional and demo-only."),await h("opencv mode disabled");return}c(!0),v("Loading OpenCV…"),b("Loading OpenCV…");try{if(await oe(e,async()=>{await io()}),!Q())throw new Error("OpenCV load returned but runtime is not injected.");await f(!0),v("OpenCV mode enabled"),b("OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV."),await h("opencv mode enabled")}catch(E){const P=String((E==null?void 0:E.message)??E);await f(!1),r(!1),v("OpenCV load failed"),b(`ERROR

${P}`),N("[settings] OpenCV toggle failed",{msg:P})}finally{c(!1)}}async function s(){const y=await W([ye]).catch(()=>({}));return(y==null?void 0:y[ye])===!0}async function d(y){await Y({[ye]:!!y}).catch(()=>null)}function p(y){o.setShowDevTools(y),n.setShowDevToolsChecked(y),n.setDevToolsVisible(y)}async function m(){const y=await s();p(y),O("Settings: boot applyDevToolsVisibility",{showDevTools:y})}async function h(y){try{const E=await a.loadTree("app");i.render(E),O("[settings] tuning rendered",{reason:y,opencvInjected:Q(),opencvMode:!!e.cfgUseOpenCvEl.checked})}catch(E){N("[settings] tuning render failed",{reason:y,msg:String((E==null?void 0:E.message)??E)}),e.tuningMountEl.textContent="Tuning UI failed to load (see console)."}}async function C(){var R;n.setBusy($());const y=await s();p(y),await Be().catch(()=>null);const E=re();o.setDev(Ce(E)),n.setDevConfig(o.dev);const P=et;let I=!1;try{typeof P.isEnabled=="function"?I=!!await P.isEnabled():I=!!P.enabled}catch(L){_("Settings: failed to read debug enabled state",{error:L instanceof Error?L.message:String(L)})}o.setDebugEnabled(I),n.setDebugEnabledChecked(I),n.setAbout(po()||"—",((R=e.settingsGitHubLinkEl)==null?void 0:R.href)||"#"),l();{const L=await u();r(L),c(!1);const A=Q();L?(v(A?"OpenCV mode enabled":"OpenCV mode (not loaded)"),b(A?"OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV.":"OpenCV mode is enabled, but OpenCV is not loaded yet. Toggle OFF then ON to load OpenCV.")):(v(A?"OpenCV loaded (native mode)":"Native mode"),b("Native mode. OpenCV is optional and demo-only."))}n.setGeneralStatus(""),n.setDevStatus(""),await h("loadAll"),O("Settings: loaded",{showDevTools:y,debugTraceEnabled:I,dev:o.dev,opencvInjected:Q()})}async function w(){const y=!!e.cfgShowDevToolsEl.checked;p(y),await d(y),K({kind:"run",scope:"settings",message:y?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:y}}),O("Settings: ui toggle showDevTools",{showDevTools:y}),n.setGeneralStatus(y?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>n.setGeneralStatus(""),1200)}async function D(){const y=vo(e);n.setDevStatus("Saving…");try{await Ke(y)}catch(E){N("Settings: failed to save dev config",{error:E instanceof Error?E.message:String(E),next:y}),n.setDevStatus("Save failed."),setTimeout(()=>n.setDevStatus(""),1200);return}o.setDev(Ce(y)),n.setDevConfig(o.dev),K({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:y}),O("Settings: devConfig updated",y),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}async function k(){n.setDevStatus("Resetting…");try{await Xt(),await Be().catch(()=>null);const E=re();o.setDev(Ce(E)),n.setDevConfig(o.dev)}catch(E){N("Settings: failed to reset dev config defaults",{error:E instanceof Error?E.message:String(E)}),n.setDevStatus("Reset failed."),setTimeout(()=>n.setDevStatus(""),1200);return}const y=await ze(!1);y.ok?(o.setDebugEnabled(!1),n.setDebugEnabledChecked(!1)):(_("Settings: failed to reset debug enabled state",{error:y.error||"unknown error"}),K({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:y.error||"unknown error"})),K({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...V,debugEnabled:!1}}),O("Settings: reset defaults",{...V,debugEnabled:!1}),n.setDevStatus("Reset."),setTimeout(()=>n.setDevStatus(""),1200)}async function M(){const y=!!e.logsCbDebugEl.checked;n.setDevStatus("Saving…");const E=await ze(y);if(!E.ok){e.logsCbDebugEl.checked=!y,n.setDevStatus(`Save failed: ${E.error||"unknown error"}`),N("Settings: failed to change debug enabled state",{error:E.error||"unknown error",enabled:y}),K({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:E.error||"unknown error",meta:{enabled:y}});return}o.setDebugEnabled(y),K({kind:"run",scope:"settings",message:y?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:y}}),O("Settings: debug enabled changed",{enabled:y}),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}const x=t.on(()=>{});function S(){e.cfgShowDevToolsEl.addEventListener("change",()=>{w()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{$()||D()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{$()||D()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{$()||D()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{$()||D()}),e.btnCfgResetDefaults.addEventListener("click",()=>{$()||k()}),e.logsCbDebugEl.addEventListener("change",()=>{$()||M()}),e.cfgUseOpenCvEl.addEventListener("change",()=>{g()}),m().catch(y=>{_("Settings: initDevToolsVisibility failed",{error:y instanceof Error?y.message:String(y)})})}return{id:"settings",refresh(){C().catch(y=>{N("Settings: refresh failed",{error:y instanceof Error?y.message:String(y)})})},mount(){C().catch(y=>{N("Settings: mount failed",{error:y instanceof Error?y.message:String(y)})})},unmount(){},bind:S,dispose(){x()}}}function bo(){let e=[],t=0;function o(n){e=n.items,t=n.total}return{get items(){return e},get total(){return t},set:o}}function ho(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function qe(e,t){const o=[];o.push(`Total entries: ${t.total}`),o.push("");for(const n of t.items){const a=typeof n.ok=="boolean"?n.ok?"ok":"fail":"",i=[];typeof n.status=="number"&&i.push(`status=${n.status}`),a&&i.push(a);const l=[n.scope,n.kind].filter(Boolean).join("/");o.push(`[${ho(n.ts)}] ${l}${i.length?` (${i.join(", ")})`:""}`),o.push(`  ${n.message}`),n.error&&o.push(`  error: ${n.error}`),o.push("")}e.textContent=o.join(`
`),e.scrollTop=0}function yo(e){function t(l){e.logsStatusEl.textContent=l}function o(l){e.debugStatusEl.textContent=l}function n(l){e.logsCbDebugEl.checked=l}function a(l){qe(e.logsOutEl,{total:l.total,items:l.items.map(u=>({ts:u.ts,message:u.message,scope:u.scope,kind:u.kind,ok:u.ok,status:u.status,error:u.error,meta:u.meta}))})}function i(l){qe(e.debugOutEl,{total:l.total,items:l.items.map(u=>({ts:u.ts,message:u.message,scope:u.scope,kind:u.kind,ok:u.ok,status:u.status,error:u.error,meta:u.meta}))})}return{setAuditStatus:t,setDebugStatus:o,setDebugChecked:n,renderAudit:a,renderDebug:i}}const Ge="beecontour";function Eo(e,t){const o=bo(),n=yo(e);async function a(){n.setAuditStatus("Loading…"),z(e,!0);try{const s=q(e.logsLimitEl.value,10,5e3,200),d=await Zn({limit:s,reverse:!0});o.set(d),n.renderAudit({items:o.items,total:o.total}),n.setAuditStatus(`Showing ${o.items.length} (newest first)`)}catch(s){n.setAuditStatus(`Failed: ${(s==null?void 0:s.message)||String(s)}`)}finally{z(e,!1)}}async function i(){n.setDebugStatus("Loading…"),z(e,!0);try{const s=q(e.debugLimitEl.value,10,5e3,200),d=await Xe({limit:s,reverse:!0});n.renderDebug(d),n.setDebugStatus(`Showing ${d.items.length} (newest first)`)}catch(s){n.setDebugStatus(`Failed: ${(s==null?void 0:s.message)||String(s)}`)}finally{z(e,!1)}}async function l(){const s=await Ie();n.setDebugChecked(s)}async function u(s){if(await Ye(s),n.setDebugChecked(s),!s){n.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}n.setDebugStatus("Debug ON."),await i()}async function f(){const s=q(e.logsTrimKeepEl.value,0,5e4,2e3);n.setAuditStatus("Trimming…"),z(e,!0);try{const d=await eo({keepLast:s});await a(),n.setAuditStatus(`Trimmed. Remaining: ${d.total}`)}catch(d){n.setAuditStatus(`Trim failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{z(e,!1)}}async function r(){n.setAuditStatus("Clearing…"),z(e,!0);try{await to(),await a(),n.setAuditStatus("Cleared.")}catch(s){n.setAuditStatus(`Clear failed: ${(s==null?void 0:s.message)||String(s)}`)}finally{z(e,!1)}}async function c(){n.setAuditStatus("Exporting…");try{const s=await no({pretty:!0}),d=new Blob([s],{type:"application/json"}),p=URL.createObjectURL(d),m=document.createElement("a");m.href=p,m.download=`${Ge}-audit-${Date.now()}.json`,m.click(),setTimeout(()=>URL.revokeObjectURL(p),1e3),n.setAuditStatus("Exported.")}catch(s){n.setAuditStatus(`Export failed: ${(s==null?void 0:s.message)||String(s)}`)}}async function v(){n.setDebugStatus("Clearing…"),z(e,!0);try{await Je(),await i(),n.setDebugStatus("Cleared.")}catch(s){n.setDebugStatus(`Clear failed: ${(s==null?void 0:s.message)||String(s)}`)}finally{z(e,!1)}}async function b(){n.setDebugStatus("Exporting…");try{const s=await Ze({pretty:!0}),d=new Blob([s],{type:"application/json"}),p=URL.createObjectURL(d),m=document.createElement("a");m.href=p,m.download=`${Ge}-debug-${Date.now()}.json`,m.click(),setTimeout(()=>URL.revokeObjectURL(p),1e3),n.setDebugStatus("Exported.")}catch(s){n.setDebugStatus(`Export failed: ${(s==null?void 0:s.message)||String(s)}`)}}function g(){e.btnLogsRefresh.addEventListener("click",()=>{$()||a()}),e.btnLogsTrim.addEventListener("click",()=>{$()||f()}),e.btnLogsClear.addEventListener("click",()=>{$()||r()}),e.btnLogsExport.addEventListener("click",()=>{$()||c()}),e.logsCbDebugEl.addEventListener("change",()=>{$()||u(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{$()||i()}),e.btnDebugClear.addEventListener("click",()=>{$()||v()}),e.btnDebugExport.addEventListener("click",()=>{$()||b()})}return{id:"logs",bind:g,mount(){l(),a(),i()},unmount(){},dispose(){}}}function Co(e,t){if(e.id===t)return e;const o=[...e.children??[]];for(;o.length>0;){const n=o.shift();if(n.id===t)return n;for(const a of n.children??[])o.push(a)}throw new Error(`[tuning] scopeRootId not found in VM tree: ${t}`)}function wo(e){const t=Me({getRuntimeAvailability:e.getRuntimeAvailability}),o=[];let n=!1;async function a(){return await t.loadTree("app")}async function i(){if(n)return;const s=await a();for(const d of o){if(d.scopeRootId==="app"){d.view.render(s);continue}const p=Co(s.root,d.scopeRootId);d.view.render({...s,scopeId:d.scopeRootId,root:p})}}async function l(s,d){await t.setEnginePolicy(s,d),e.actionLogAppend(`[tuning] policy ${s} = ${d}`),e.debugTraceAppend(`[tuning] setPolicy id=${s} policy=${d}`),await i()}async function u(s,d,p){await t.setParam(s,d,p),e.actionLogAppend(`[tuning] param ${s}.${d} = ${String(p)}`),e.debugTraceAppend(`[tuning] setParam id=${s} key=${d} value=${String(p)}`),await i()}async function f(s){await t.resetNode(s),e.actionLogAppend(`[tuning] reset node ${s}`),e.debugTraceAppend(`[tuning] resetNode id=${s}`),await i()}async function r(s,d){await t.resetParam(s,d),e.actionLogAppend(`[tuning] reset param ${s}.${d}`),e.debugTraceAppend(`[tuning] resetParam id=${s} key=${d}`),await i()}function c(s){if(n)return;const{mountEl:d,scopeRootId:p}=s;if(o.some(h=>h.mountEl===d))return;const m=lt(d,{onSetPolicy:l,onSetParam:u,onResetNode:f,onResetParam:r});o.push({mountEl:d,scopeRootId:p,view:m}),i()}function v(s){const d=o.findIndex(p=>p.mountEl===s);d<0||(o[d].view.dispose(),o.splice(d,1))}async function b(){await i()}function g(){n=!0;for(const s of o)s.view.dispose();o.length=0}return{mount:c,unmount:v,refresh:b,dispose:g}}(function(){const t=Qt(),o=Wt();o.start();const n=en();globalThis.__APP__={...globalThis.__APP__,cache:n};const a=wo({getRuntimeAvailability:()=>({opencvReady:!1}),debugTraceAppend:v=>Re({scope:"panel",kind:"debug",message:v}),actionLogAppend:v=>K({scope:"panel",kind:"info",message:v})});a.mount({mountEl:t.tuningMountEl,scopeRootId:"app"}),a.mount({mountEl:t.contourTuningMountEl,scopeRootId:"contour"});const i=$n(t),l=Wn(t),u=Nn(t),f=mo(t,o),r=Eo(t);i.bind(),u.bind(),l.bind(),f.bind(),r.bind();const c=Zt(t,{contour:i,segmentation:u,colors:l,settings:f,logs:r});c.bind(),c.boot()})();
