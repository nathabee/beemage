import{_ as Ln}from"./index-PzPktjDZ.js";function Rn(){function e(Et,Tn){if(!Et)throw new Error(`[dom] Missing #${Tn}`);return Et}const t=e(document.getElementById("appRoot"),"appRoot"),i=e(document.getElementById("tabImage"),"tabImage"),n=e(document.getElementById("tabColors"),"tabColors"),o=e(document.getElementById("tabSettings"),"tabSettings"),a=e(document.getElementById("tabLogs"),"tabLogs"),s=e(document.getElementById("tabPipeline"),"tabPipeline"),l=e(document.getElementById("tabBuilder"),"tabBuilder"),d=e(document.getElementById("viewImage"),"viewImage"),r=e(document.getElementById("viewColors"),"viewColors"),f=e(document.getElementById("viewSettings"),"viewSettings"),g=e(document.getElementById("viewLogs"),"viewLogs"),u=e(document.getElementById("viewPipeline"),"viewPipeline"),p=e(document.getElementById("viewBuilder"),"viewBuilder"),c=e(document.getElementById("dropZone"),"dropZone"),h=e(document.getElementById("fileInput"),"fileInput"),v=e(document.getElementById("srcCanvas"),"srcCanvas"),y=e(document.getElementById("pipelineStatus"),"pipelineStatus"),b=e(document.getElementById("pipelineTuningMount"),"pipelineTuningMount"),w=e(document.getElementById("pipelineViewMount"),"pipelineViewMount"),C=e(document.getElementById("builderImportFile"),"builderImportFile"),E=e(document.getElementById("btnBuilderExport"),"btnBuilderExport"),I=e(document.getElementById("builderStatus"),"builderStatus"),D=e(document.getElementById("colorsCanvas"),"colorsCanvas"),L=e(document.getElementById("palette"),"palette"),U=e(document.getElementById("btnColorsApply"),"btnColorsApply"),$=e(document.getElementById("btnColorsCancel"),"btnColorsCancel"),m=e(document.getElementById("btnColorsReset"),"btnColorsReset"),z=e(document.getElementById("edgesDark"),"edgesDark"),_=e(document.getElementById("edgeMaskThreshold"),"edgeMaskThreshold"),M=e(document.getElementById("edgeDilate"),"edgeDilate"),O=e(document.getElementById("maxRegionPx"),"maxRegionPx"),k=e(document.getElementById("colorsStatus"),"colorsStatus"),S=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),P=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),x=e(document.getElementById("devConfigDetails"),"devConfigDetails"),T=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),A=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),N=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),R=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),B=e(document.getElementById("logsCbDebug"),"logsCbDebug"),K=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),V=e(document.getElementById("cfgStatus"),"cfgStatus"),F=e(document.getElementById("cfgOpenCvSpinner"),"cfgOpenCvSpinner"),q=e(document.getElementById("cfgOpenCvStatus"),"cfgOpenCvStatus"),X=e(document.getElementById("cfgOpenCvReport"),"cfgOpenCvReport"),Z=e(document.getElementById("settingsEngineBox"),"settingsEngineBox"),te=e(document.getElementById("cfgUseOpenCv"),"cfgUseOpenCv"),ne=e(document.getElementById("tuningMount"),"tuningMount"),xe=e(document.getElementById("settingsVersion"),"settingsVersion"),ke=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),Ye=e(document.getElementById("logsLimit"),"logsLimit"),yn=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),bn=e(document.getElementById("logsStatus"),"logsStatus"),vn=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),wn=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),Cn=e(document.getElementById("btnLogsExport"),"btnLogsExport"),En=e(document.getElementById("btnLogsClear"),"btnLogsClear"),kn=e(document.getElementById("logsOut"),"logsOut"),In=e(document.getElementById("debugLimit"),"debugLimit"),xn=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),Sn=e(document.getElementById("btnDebugExport"),"btnDebugExport"),Pn=e(document.getElementById("btnDebugClear"),"btnDebugClear"),$n=e(document.getElementById("debugStatus"),"debugStatus"),An=e(document.getElementById("debugOut"),"debugOut");return{rootEl:t,tabImage:i,tabColors:n,tabSettings:o,tabLogs:a,tabPipeline:s,tabBuilder:l,viewImage:d,viewColors:r,viewSettings:f,viewLogs:g,viewPipeline:u,viewBuilder:p,dropZoneEl:c,fileInputEl:h,srcCanvasEl:v,pipelineStatusEl:y,pipelineTuningMountEl:b,pipelineViewMountEl:w,builderImportFileEl:C,btnBuilderExportEl:E,builderStatusEl:I,colorsCanvasEl:D,paletteEl:L,btnColorsApplyEl:U,btnColorsCancelEl:$,btnColorsResetEl:m,edgesDarkEl:z,edgeMaskThresholdEl:_,edgeDilateEl:M,maxRegionPxEl:O,colorsStatusEl:k,cfgShowDevToolsEl:S,settingsGeneralStatusEl:P,devConfigDetailsEl:x,cfgTraceConsoleEl:T,cfgActionLogMaxEl:A,cfgDebugTraceMaxEl:N,cfgFailureLogsPerRunEl:R,logsCbDebugEl:B,btnCfgResetDefaults:K,cfgStatusEl:V,settingsVersionEl:xe,settingsGitHubLinkEl:ke,cfgOpenCvSpinner:F,cfgOpenCvStatus:q,cfgOpenCvReport:X,settingsEngineBoxEl:Z,cfgUseOpenCvEl:te,tuningMountEl:ne,logsLimitEl:Ye,btnLogsRefresh:yn,logsStatusEl:bn,logsTrimKeepEl:vn,btnLogsTrim:wn,btnLogsExport:Cn,btnLogsClear:En,logsOutEl:kn,debugLimitEl:In,btnDebugRefresh:xn,btnDebugExport:Sn,btnDebugClear:Pn,debugStatusEl:$n,debugOutEl:An}}const Mn=new Set;function Dn(e){Mn.add(e)}function kt(e){return`./${String(e||"").replace(/^\/+/,"")}`}function On(){const e=new Set;function t(n){return e.add(n),()=>e.delete(n)}function i(){Dn(o=>{for(const a of e)a(o)})}return{on:t,start:i}}const Bn=new Set;function Wt(e){for(const t of Bn)t(e,"local")}function $e(e){const t=localStorage.getItem(e);if(t!==null)try{return JSON.parse(t)}catch{return t}}function Un(e,t){localStorage.setItem(e,JSON.stringify(t))}async function ge(e){if(typeof e=="string")return{[e]:$e(e)};if(Array.isArray(e)){const i={};for(const n of e)i[n]=$e(n);return i}const t={};for(const[i,n]of Object.entries(e))t[i]=localStorage.getItem(i)!==null?$e(i):n;return t}async function fe(e){const t={};for(const[i,n]of Object.entries(e)){const o=$e(i);Un(i,n),t[i]={oldValue:o,newValue:n}}Wt(t)}async function vt(e){const t=Array.isArray(e)?e:[e],i={};for(const n of t){const o=$e(n);localStorage.removeItem(n),i[n]={oldValue:o,newValue:void 0}}Wt(i)}function ue(e,t,i,n){const o=Number(String(e??"").trim());return Number.isFinite(o)?Math.max(t,Math.min(i,Math.floor(o))):n}const st="beemage.devConfig",ae={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let rt=!1,Ne={...ae};function Jt(e){const t=e||{};return{traceConsole:!!t.traceConsole,actionLogMax:ue(t.actionLogMax??ae.actionLogMax,100,5e4,ae.actionLogMax),debugTraceMax:ue(t.debugTraceMax??ae.debugTraceMax,100,5e4,ae.debugTraceMax),failureLogsPerRun:ue(t.failureLogsPerRun??ae.failureLogsPerRun,0,5e4,ae.failureLogsPerRun)}}async function lt(){if(rt)return;const e=await ge([st]).catch(()=>({}));Ne=Jt(e==null?void 0:e[st]),rt=!0}function _e(){return Ne}async function qt(e){Ne=Jt(e),rt=!0,await fe({[st]:Ne}).catch(()=>null)}async function zn(){await qt({...ae})}function Vn(e,t){const i={pipeline:e.tabPipeline,image:e.tabImage,builder:e.tabBuilder,colors:e.tabColors,settings:e.tabSettings,logs:e.tabLogs},n={pipeline:e.viewPipeline,image:e.viewImage,builder:e.viewBuilder,colors:e.viewColors,settings:e.viewSettings,logs:e.viewLogs};let o="image";const a=new Set;function s(){const p=_e();return!!(p!=null&&p.traceConsole)}function l(){const p=globalThis;p.__bctGlobalErrorHooksInstalled||(p.__bctGlobalErrorHooksInstalled=!0,window.addEventListener("error",c=>{var v;const h=c;console.error("[panel] window error",{message:h.message,filename:h.filename,lineno:h.lineno,colno:h.colno,error:h.error?String(h.error):null,stack:(v=h.error)!=null&&v.stack?String(h.error.stack):null})}),window.addEventListener("unhandledrejection",c=>{var h;console.error("[panel] unhandledrejection",{reason:c.reason?String(c.reason):null,stack:(h=c.reason)!=null&&h.stack?String(c.reason.stack):null})}))}s()&&l();function d(p){Object.keys(i).forEach(c=>{const h=c===p;i[c].classList.toggle("is-active",h),i[c].setAttribute("aria-selected",h?"true":"false"),n[c].hidden=!h,n[c].classList.toggle("is-active",h)})}function r(p){var c,h,v,y,b,w,C,E;if(p===o){(h=(c=t[p]).refresh)==null||h.call(c);return}(y=(v=t[o]).unmount)==null||y.call(v),o=p,d(o),a.has(o)?(E=(C=t[o]).refresh)==null||E.call(C):(a.add(o),(w=(b=t[o]).mount)==null||w.call(b))}function f(){i.image.addEventListener("click",p=>{var c;(c=p.preventDefault)==null||c.call(p),r("image")}),i.pipeline.addEventListener("click",p=>{var c;(c=p.preventDefault)==null||c.call(p),r("pipeline")}),i.colors.addEventListener("click",p=>{var c;(c=p.preventDefault)==null||c.call(p),r("colors")}),i.settings.addEventListener("click",p=>{var c;(c=p.preventDefault)==null||c.call(p),r("settings")}),i.logs.addEventListener("click",p=>{var c;(c=p.preventDefault)==null||c.call(p),r("logs")}),i.builder.addEventListener("click",p=>{var c;(c=p.preventDefault)==null||c.call(p),r("builder")})}function g(){var p,c,h,v;o="image",d(o),Object.keys(t).forEach(y=>{var b,w;return(w=(b=t[y]).boot)==null?void 0:w.call(b)}),a.has(o)?(v=(h=t[o]).refresh)==null||v.call(h):(a.add(o),(c=(p=t[o]).mount)==null||c.call(p))}function u(){Object.keys(t).forEach(p=>{var c,h;return(h=(c=t[p]).dispose)==null?void 0:h.call(c)})}return{bind:f,boot:g,activate:r,dispose:u}}function It(e){const t=e.items.length;return{items:e.items,counts:{items:t},meta:e.meta}}function Nn(){const e={items:[],meta:{}},t=new Set;function i(){const r=It(e);for(const f of t)try{f(r)}catch{}}function n(){return It(e)}function o(r){t.add(r);try{r(n())}catch{}return()=>t.delete(r)}function a(){e.items=[],e.meta={},i()}function s(r){e.meta.scopeUpdatedSince=r,i()}function l(){return String(e.meta.scopeUpdatedSince||"")}function d(r,f){e.items=r.slice(),e.meta.updatedTs=Date.now(),typeof(f==null?void 0:f.limit)=="number"&&(e.meta.limit=f.limit),i()}return{getSnapshot:n,subscribe:o,getScopeUpdatedSince:l,clearAll:a,setScopeUpdatedSince:s,setItems:d}}function _n(e,t){function i(l){e.dropZoneEl.classList.toggle("is-hover",l)}function n(l,d){const r=l.getContext("2d",{willReadFrequently:!0});if(!r)return;const f=Math.max(1,l.width),g=Math.max(1,l.height);r.clearRect(0,0,f,g);const u=d.naturalWidth||d.width,p=d.naturalHeight||d.height;if(!u||!p)return;const c=Math.min(f/u,g/p),h=Math.max(1,Math.round(u*c)),v=Math.max(1,Math.round(p*c)),y=Math.floor((f-h)/2),b=Math.floor((g-v)/2);r.drawImage(d,y,b,h,v)}function o(l){n(e.srcCanvasEl,l)}function a(l){t.lastError=void 0;const d=Array.isArray(l)?l.filter(Boolean):[];t.loadedImageNames=d,t.loadedCount=d.length,t.loadedImageName=d[0]??null,t.hasImage=d.length>0}function s(l){t.lastError=l,t.hasImage=!1,t.loadedImageName=null,t.loadedImageNames=[],t.loadedCount=0}return{setHover:i,drawImageToSource:o,showLoadOk:a,showLoadError:s}}function jn(){return{loadedImageName:null,loadedImageNames:[],loadedCount:0,hasImage:!1,lastError:void 0}}const je="beemage.actionLog",Fn=5e3;function Gn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function Kn(e){return Array.isArray(e)?e:[e]}function Fe(e,t,i){return Math.max(t,Math.min(i,Math.floor(e)))}async function Ae(){const e=await ge(je),t=e==null?void 0:e[je];return Array.isArray(t)?t:[]}async function Zt(e){await fe({[je]:e})}async function G(e,t){const i=Fe(Fn,100,5e4),o=Kn(e).map(d=>({...d,id:Gn(),ts:Date.now()}));if(!o.length)return{total:(await Ae()).length};const s=(await Ae()).concat(o),l=s.length>i?s.slice(s.length-i):s;return await Zt(l),{total:l.length}}async function Hn(e){const t=Fe((e==null?void 0:e.limit)??200,1,5e4),i=Fe((e==null?void 0:e.offset)??0,0,1e6);let o=await Ae();e!=null&&e.kind&&(o=o.filter(l=>l.kind===e.kind)),e!=null&&e.scope&&(o=o.filter(l=>l.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(o=o.filter(l=>l.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(o=o.filter(l=>l.ts<=e.untilTs));const a=o.length;o=o.slice().reverse();const s=o.slice(i,i+t);return{total:a,items:s}}async function Wn(e){let i=await Ae();if(typeof e.beforeTs=="number"&&(i=i.filter(n=>n.ts>=e.beforeTs)),typeof e.keepLast=="number"){const n=Fe(e.keepLast,0,5e4);n===0?i=[]:i.length>n&&(i=i.slice(i.length-n))}return await Zt(i),{total:i.length}}async function Jn(){await vt(je)}async function qn(e){const t=await Ae();return JSON.stringify(t,null,2)}const Te="beemage.debugTrace",ct="beemage.debugTrace.enabled",Zn=2e3;function Yn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function dt(e,t,i){return Math.max(t,Math.min(i,Math.floor(e)))}async function Ge(){const e=await ge(Te),t=e==null?void 0:e[Te];return Array.isArray(t)?t:[]}async function Xn(e){await fe({[Te]:e})}async function wt(){const e=await ge(ct);return!!(e!=null&&e[ct])}async function Yt(e){await fe({[ct]:!!e}),e||await vt(Te)}async function Xt(){await vt(Te)}async function ee(e,t){if(!await wt())return{total:0};const n=dt((t==null?void 0:t.max)??Zn,100,5e4),o=(Array.isArray(e)?e:[e]).map(d=>({...d,id:Yn(),ts:Date.now()}));if(!o.length)return{total:(await Ge()).length};const s=(await Ge()).concat(o),l=s.length>n?s.slice(s.length-n):s;return await Xn(l),{total:l.length}}async function Qt(e){const t=dt((e==null?void 0:e.limit)??200,1,5e4),i=dt((e==null?void 0:e.offset)??0,0,1e6),n=(e==null?void 0:e.reverse)??!0,o=await Ge(),a=o.length,l=(n?o.slice().reverse():o).slice(i,i+t);return{total:a,items:l}}async function en(e){const t=await Ge();return JSON.stringify(t,null,e!=null&&e.pretty?2:0)}const tn=Object.freeze(Object.defineProperty({__proto__:null,append:ee,clear:Xt,exportJson:en,isEnabled:wt,list:Qt,setEnabled:Yt},Symbol.toStringTag,{value:"Module"}));function Qn(e,t){const i=jn(),n=_n(e,i);async function o(u){if(!u.type.startsWith("image/"))throw new Error(`Unsupported file type: ${u.type||"unknown"}`);const p=URL.createObjectURL(u);try{const c=new Image;return c.decoding="async",c.src=p,typeof c.decode=="function"?await c.decode():await new Promise((h,v)=>{c.onload=()=>h(),c.onerror=()=>v(new Error("Image decode failed."))}),c}finally{URL.revokeObjectURL(p)}}function a(u){const p=u.naturalWidth||u.width,c=u.naturalHeight||u.height;if(!p||!c)throw new Error("Image has invalid dimensions.");const h=document.createElement("canvas");h.width=p,h.height=c;const v=h.getContext("2d",{willReadFrequently:!0});if(!v)throw new Error("2D canvas context unavailable.");return v.drawImage(u,0,0,p,c),v.getImageData(0,0,p,c)}function s(u){globalThis.app__=globalThis.app__??{},globalThis.app__.input__=u}async function l(u){const p=(u??[]).filter(v=>v&&v.type.startsWith("image/"));if(p.length===0)throw new Error("No supported images found.");const c=await Promise.all(p.map(o));n.drawImageToSource(c[0]);const h=c.map((v,y)=>{const b=p[y],w=v.naturalWidth||v.width,C=v.naturalHeight||v.height;return{name:b.name,type:b.type,size:b.size,width:w,height:C,imageData:a(v)}});n.showLoadOk(p.map(v=>v.name)),s({kind:h.length===1?"image":"imageList",images:h,createdAtMs:Date.now()}),G({scope:"panel",kind:"info",message:h.length===1?`Input loaded: ${h[0].name}`:`Inputs loaded: ${h.length} images`}),ee({scope:"panel",kind:"info",message:"Mage input loaded",meta:{count:h.length,names:h.slice(0,10).map(v=>v.name),first:h[0]?{name:h[0].name,w:h[0].width,h:h[0].height,type:h[0].type}:null}})}function d(){e.dropZoneEl.addEventListener("dragover",u=>{u.preventDefault(),n.setHover(!0)}),e.dropZoneEl.addEventListener("dragleave",()=>n.setHover(!1)),e.dropZoneEl.addEventListener("drop",u=>{var c;u.preventDefault(),n.setHover(!1);const p=Array.from(((c=u.dataTransfer)==null?void 0:c.files)??[]);p.length!==0&&l(p).catch(h=>{const v=h instanceof Error?h.message:String(h);n.showLoadError(v),G({scope:"panel",kind:"error",message:`Input load failed: ${v}`}),ee({scope:"panel",kind:"error",message:"Input load failed",meta:{error:v}})})}),e.fileInputEl.addEventListener("change",()=>{const u=Array.from(e.fileInputEl.files??[]);u.length!==0&&(l(u).catch(p=>{const c=p instanceof Error?p.message:String(p);n.showLoadError(c),G({scope:"panel",kind:"error",message:`Input load failed: ${c}`}),ee({scope:"panel",kind:"error",message:"Input load failed",meta:{error:c}})}),e.fileInputEl.value="")})}function r(){d()}function f(){}function g(){}return{id:"image",bind:r,mount:f,unmount:g}}function Xe(e,t,i){return Number.isFinite(e)?Math.max(t,Math.min(i,Math.trunc(e))):t}function ei(e,t,i){return Math.round(.2126*e+.7152*t+.0722*i)}function nn(e){return{edgesDark:!!(e.edgesDark??!0),edgeThreshold:Xe(e.edgeThreshold??80,0,255),edgeDilate:Xe(e.edgeDilate??2,0,6),maxRegionPx:Xe(e.maxRegionPx??2e5,1e3,1e7)}}function ti(e,t,i){const{data:n,width:o,height:a}=e,s=new Uint8Array(o*a);for(let l=0,d=0;l<s.length;l++,d+=4){const r=n[d+0],f=n[d+1],g=n[d+2];if(n[d+3]===0){s[l]=0;continue}const p=ei(r,f,g),c=t?p<=i:p>=255-i;s[l]=c?1:0}return s}function ni(e,t,i,n){if(n<=0)return e;let o=e;for(let a=0;a<n;a++){const s=new Uint8Array(t*i);for(let l=0;l<i;l++)for(let d=0;d<t;d++){const r=l*t+d;if(o[r]){s[r]=1;continue}let f=0;for(let g=-1;g<=1&&!f;g++){const u=l+g;if(!(u<0||u>=i))for(let p=-1;p<=1;p++){const c=d+p;if(!(c<0||c>=t)&&o[u*t+c]){f=1;break}}}s[r]=f}o=s}return o}function ii(e,t,i,n,o,a){const s=t*n+e;if(i[s])return{ok:!1,message:"Click is on an edge; pick inside a region."};const l=new Uint8Array(n*o),d=new Int32Array(n*o),r=new Int32Array(n*o);let f=0,g=0;d[g]=e,r[g]=t,g++,l[s]=1;let u=1;for(;f<g;){const p=d[f],c=r[f];f++;const h=[[p-1,c],[p+1,c],[p,c-1],[p,c+1]];for(const[v,y]of h){if(v<0||v>=n||y<0||y>=o)continue;const b=y*n+v;if(!l[b]&&!i[b]&&(l[b]=1,d[g]=v,r[g]=y,g++,u++,u>a))return{ok:!1,message:`Region too large (>${a}px). Increase Max region or fix gaps.`}}}return{ok:!0,mask:l}}function oi(e,t,i,n){const o=new Uint8Array(i*n);for(let a=1;a<n-1;a++)for(let s=1;s<i-1;s++){const l=a*i+s;if(!e[l])continue;const d=(a-1)*i+s,r=(a+1)*i+s,f=a*i+(s-1),g=a*i+(s+1);(!e[d]||!e[r]||!e[f]||!e[g]||t[d]||t[r]||t[f]||t[g])&&(o[l]=1)}return o}function ai(e,t,i,n){const o=nn(n),a=e.width,s=e.height;let l=ti(e,o.edgesDark,o.edgeThreshold);l=ni(l,a,s,o.edgeDilate);const d=ii(t,i,l,a,s,o.maxRegionPx);if(!d.ok)return{ok:!1,message:d.message};const r=oi(d.mask,l,a,s);return{ok:!0,preview:{mask:d.mask,outline:r,w:a,h:s}}}function si(e,t,i){const n=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),o=i.replace("#",""),a=parseInt(o.slice(0,2),16),s=parseInt(o.slice(2,4),16),l=parseInt(o.slice(4,6),16),d=n.data;for(let r=0,f=0;r<t.mask.length;r++,f+=4)t.mask[r]&&(d[f+0]=a,d[f+1]=s,d[f+2]=l);return n}function Qe(e,t,i){return Number.isFinite(e)?Math.max(t,Math.min(i,Math.trunc(e))):t}function xt(e){const t=(e||"").trim();if(!t)return null;const i=t.startsWith("#")?t:`#${t}`;return/^#[0-9a-fA-F]{6}$/.test(i)?i.toLowerCase():null}function ri(e){let t="#ff3b30",i=[],n=null;function o(h){e.colorsStatusEl.textContent=h||""}function a(){const h=!!e.edgesDarkEl.checked,v=Qe(parseInt(e.edgeMaskThresholdEl.value,10),0,255),y=Qe(parseInt(e.edgeDilateEl.value,10),0,6),b=Qe(parseInt(e.maxRegionPxEl.value,10),1e3,1e7);return e.edgeMaskThresholdEl.value=String(v),e.edgeDilateEl.value=String(y),e.maxRegionPxEl.value=String(b),nn({edgesDark:h,edgeThreshold:v,edgeDilate:y,maxRegionPx:b})}function s(h){const v=xt(h);if(v){t=v;for(const y of Array.from(e.paletteEl.querySelectorAll(".paletteItem"))){const b=y.dataset.hex||"";y.classList.toggle("is-selected",b===t)}}}function l(){return t}function d(h){i=h.slice(),e.paletteEl.innerHTML="";for(const v of i){const y=xt(v);if(!y)continue;const b=document.createElement("button");b.type="button",b.className="paletteItem",b.style.background=y,b.dataset.hex=y,b.setAttribute("role","listitem"),b.setAttribute("aria-label",`Select ${y}`),b.addEventListener("click",()=>{s(y)}),e.paletteEl.appendChild(b)}s(t)}function r(h){const v=e.colorsCanvasEl;v.width=h.width,v.height=h.height,v.getContext("2d").putImageData(h,0,0)}function f(h,v){r(h);const y=e.colorsCanvasEl.getContext("2d"),{outline:b,w,h:C}=v,E=y.getImageData(0,0,w,C),I=E.data;for(let D=0,L=0;D<b.length;D++,L+=4)b[D]&&(I[L+0]=255,I[L+1]=60,I[L+2]=60,I[L+3]=220);y.putImageData(E,0,0)}function g(h){e.btnColorsApplyEl.disabled=!h}function u(h){e.btnColorsCancelEl.disabled=!h}function p(h){n=h}function c(){o("Idle"),g(!1),u(!1),e.colorsCanvasEl.addEventListener("click",h=>{if(!n)return;const v=e.colorsCanvasEl.getBoundingClientRect(),y=Math.floor((h.clientX-v.left)/v.width*e.colorsCanvasEl.width),b=Math.floor((h.clientY-v.top)/v.height*e.colorsCanvasEl.height);n(y,b)})}return{bind:c,setStatus:o,getSettings:a,setSelectedColor:s,getSelectedColor:l,renderPalette:d,drawBase:r,drawPreview:f,setApplyEnabled:g,setCancelEnabled:u,onCanvasClick:p}}let on={type:"none"};function Se(e){on=e}function St(){return on}function Pe(e){var s,l,d,r,f;if(!e){Se({type:"none"});return}const t=(s=e.outputSvg)==null?void 0:s.svg;if(typeof t=="string"&&t.length>0){Se({type:"svg",svg:t});return}const i=(l=e.outputImage)==null?void 0:l.data;if(i){Se({type:"image",image:i});return}const n=(d=e.outputMask)==null?void 0:d.data,o=(r=e.outputMask)==null?void 0:r.width,a=(f=e.outputMask)==null?void 0:f.height;if(n&&typeof o=="number"&&typeof a=="number"){Se({type:"mask",mask:n,width:o,height:a});return}Se({type:"none"})}const li=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#a2845e","#8e8e93","#1c1c1e","#ffffff","#000000","#4cd964","#5ac8fa","#ff6b6b","#7aa2ff","#f5a623","#50e3c2"];function ci(e,t){const i=ri(e);let n=null,o=null;function a(p){i.setStatus(p)}function s(p,c,h){const v=new ImageData(c,h),y=v.data;for(let b=0,w=0;b<p.length;b++,w+=4){const E=(p[b]??0)>0?0:255;y[w+0]=E,y[w+1]=E,y[w+2]=E,y[w+3]=255}return v}function l(){const p=St();return p.type==="image"?p.image:p.type==="mask"?s(p.mask,p.width,p.height):null}function d(){return St().type==="svg"?"Pipeline output is SVG. Colors needs an image or mask output.":"No pipeline output available. Run the Pipeline first."}function r(){const p=l();if(!p){n=null,o=null,i.setApplyEnabled(!1),i.setCancelEnabled(!1),a(d());return}n=p,o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Ready. Pick a color, click inside a region.")}function f(){if(n){i.drawBase(n);return}const p=l();if(!p){a(d());return}n=p,o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Loaded pipeline output. Pick a color, click inside a region.")}function g(){if(!n||!o)return;const p=i.getSelectedColor();n=si(n,o,p),o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Fill applied. Click another region.")}function u(){n&&(o=null,i.drawBase(n),i.setApplyEnabled(!1),i.setCancelEnabled(!1),a("Preview canceled."))}return{bind(){i.bind(),i.renderPalette(li),i.onCanvasClick((p,c)=>{if(!n){a(d());return}const h=i.getSettings(),v=ai(n,p,c,h);if(!v.ok){o=null,i.setApplyEnabled(!1),i.setCancelEnabled(!1),a(v.message);return}o=v.preview,i.drawPreview(n,o),i.setApplyEnabled(!0),i.setCancelEnabled(!0),a("Preview shown. Apply fill or cancel.")}),e.btnColorsApplyEl.addEventListener("click",()=>g()),e.btnColorsCancelEl.addEventListener("click",()=>u()),e.btnColorsResetEl.addEventListener("click",()=>r()),e.tabColors.addEventListener("click",()=>{queueMicrotask(()=>f())}),a("Idle"),i.setApplyEnabled(!1),i.setCancelEnabled(!1)}}}const di="0.3.3";function et(e){return`[BCT][${e}]`}function pi(e){function t(...a){e.traceOn()&&console.log(et("trace"),...a)}function i(...a){console.warn(et("warn"),...a)}function n(...a){console.error(et("error"),...a)}function o(a,s){t(a,s),ee({scope:e.scope,kind:"debug",message:a,meta:s})}return{logTrace:t,logWarn:i,logError:n,traceScope:o}}const{logTrace:H,logWarn:Ve,logError:be,traceScope:an}=pi({scope:"panel",traceOn:()=>!!_e().traceConsole});let ie=0;function oe(){return ie>0}function ce(e,t){if(t){sn(e);return}ie=0,Ke(e,!1)}async function ui(e,t){const i=`${Date.now()}-${Math.random().toString(16).slice(2)}`;H("[state] withBusy: enter",{id:i,busyCount:ie}),sn(e,i);try{H("[state] withBusy: before await fn",{id:i,busyCount:ie});const n=await t();return H("[state] withBusy: after await fn (resolved)",{id:i,busyCount:ie}),n}catch(n){throw be("[state] withBusy: fn threw",{id:i,busyCount:ie,msg:String((n==null?void 0:n.message)??n),stack:String((n==null?void 0:n.stack)??"")}),n}finally{H("[state] withBusy: finally before endBusy",{id:i,busyCount:ie}),gi(e,i),H("[state] withBusy: finally after endBusy",{id:i,busyCount:ie})}}function sn(e,t){ie++,H("[state] beginBusy",{id:t,busyCount:ie}),ie===1&&Ke(e,!0)}function gi(e,t){if(ie--,H("[state] endBusy: dec",{id:t,busyCount:ie}),ie<=0){ie=0,H("[state] endBusy: applying busy=false",{id:t,busyCount:ie}),Ke(e,!1);return}ie===0&&(H("[state] endBusy: applying busy=false (redundant branch)",{id:t,busyCount:ie}),Ke(e,!1))}function Ke(e,t){e.rootEl.classList.toggle("is-busy",t),e.cfgShowDevToolsEl.disabled=!1,e.fileInputEl.disabled=t,e.cfgTraceConsoleEl.disabled=t,e.cfgActionLogMaxEl.disabled=t,e.cfgDebugTraceMaxEl.disabled=t,e.cfgFailureLogsPerRunEl.disabled=t,e.btnCfgResetDefaults.disabled=t,e.logsCbDebugEl.disabled=t,e.cfgUseOpenCvEl.disabled=t,e.logsLimitEl.disabled=t,e.btnLogsRefresh.disabled=t,e.logsTrimKeepEl.disabled=t,e.btnLogsTrim.disabled=t,e.btnLogsExport.disabled=t,e.btnLogsClear.disabled=t,e.debugLimitEl.disabled=t,e.btnDebugRefresh.disabled=t,e.btnDebugExport.disabled=t,e.btnDebugClear.disabled=t,e.btnColorsApplyEl.disabled=t,e.btnColorsCancelEl.disabled=t,e.btnColorsResetEl.disabled=t,e.edgesDarkEl.disabled=t,e.edgeMaskThresholdEl.disabled=t,e.edgeDilateEl.disabled=t,e.maxRegionPxEl.disabled=t;for(const i of Array.from(e.paletteEl.querySelectorAll("button")))i.disabled=t;e.colorsCanvasEl.style.pointerEvents=t?"none":"auto"}const Ct={native:{available:!0},opencv:{available:!1,reason:"OpenCV not loaded"}};function fi(e){Ct[e]={available:!0}}function hi(e,t){Ct[e]={available:!1,reason:t}}function ve(){return Ct.opencv.available===!0}async function mi(e){const t=new URL(e.opencvJsRel,document.baseURI).toString(),i=new URL(e.opencvWasmRel,document.baseURI).toString(),n=globalThis;n.Module=n.Module||{},n.Module.locateFile=o=>o.endsWith(".wasm")?i:o,n.Module.print=()=>{},n.Module.printErr=()=>{},n.cv||await yi(t),await bi(e.timeoutMs)}function yi(e){return new Promise((t,i)=>{const n=document.createElement("script");n.src=e,n.async=!0;const o=15e3,a=window.setTimeout(()=>{s(),i(new Error(`OpenCV script load timeout after ${o}ms: ${e}`))},o);function s(){window.clearTimeout(a),n.onload=null,n.onerror=null}n.onload=()=>{s(),t()},n.onerror=()=>{s(),i(new Error(`Failed to load OpenCV script: ${e}`))},document.head.appendChild(n)})}async function bi(e){var n;const t=Date.now(),i=globalThis;for(;Date.now()-t<e;){try{if(i.cv&&typeof i.cv.Mat=="function"){const o=new i.cv.Mat;(n=o.delete)==null||n.call(o);return}}catch{}await new Promise(o=>setTimeout(o,75))}throw new Error(`OpenCV initialization timeout after ${e}ms`)}async function vi(){try{await mi({opencvJsRel:"../assets/opencv/opencv.js",opencvWasmRel:"../assets/opencv/opencv.wasm",timeoutMs:2e4}),fi("opencv")}catch(e){throw hi("opencv",e!=null&&e.message?String(e.message):String(e)),e}}function Q(e,t,i,n,o,a,s){return{id:e,title:t,implementedEngines:i,defaultEnginePolicy:n,params:o,children:a,description:s}}function wi(e){const t=new Map,i=new Map;function n(o,a){if(t.has(o.id))throw new Error(`[tuning] Duplicate component id: ${o.id}`);t.set(o.id,o),i.set(o.id,a);for(const s of o.children??[])n(s,o.id)}return n(e,null),{root:e,byId:t,parentById:i}}function rn(){const e=Q("app","BeeMage",["native","opencv"],"native",{},[Q("edge","Edge",["native","opencv"],"auto",{},[Q("edge.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),Q("edge.threshold","Threshold",["native","opencv"],"auto",{manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128}},void 0,"Convert image into a binary mask before edge extraction."),Q("edge.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:3},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Clean the mask before extracting edges."),Q("edge.extract","Edge extract",["native","opencv"],"auto",{},void 0,"Extract a 1px outline from the cleaned mask.")],"Fixed-order edge pipeline (image -> mask -> edges). Presets configure each step."),Q("svg","SVG",["native","opencv"],"auto",{},[Q("svg.create","Create SVG",["native","opencv"],"auto",{scale:{kind:"number",label:"Scale",min:1,max:10,step:1,default:1},transparentBg:{kind:"number",label:"Transparent bg (0/1)",min:0,max:1,step:1,default:1},color:{kind:"text",label:"Color",default:"#3bca1e"}},void 0,"Convert the edge mask into an SVG.")],"SVG generation parameters."),Q("segmentation","Segmentation",["native","opencv"],"auto",{},[Q("segmentation.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),Q("segmentation.denoise","Denoise",["native","opencv"],"auto",{denoiseAlgo:{kind:"number",label:"Denoise algo",min:0,max:2,step:1,default:1},blurK:{kind:"number",label:"Blur kernel",min:1,max:21,step:2,default:3},bilateralSigma:{kind:"number",label:"Bilateral sigma",min:1,max:150,step:1,default:35}},void 0,"Reduce noise before thresholding."),Q("segmentation.color","Color / Gray",["native","opencv"],"auto",{colorMode:{kind:"number",label:"Color mode",min:0,max:3,step:1,default:1},hsvChannel:{kind:"number",label:"HSV channel",min:0,max:2,step:1,default:2}},void 0,"Select color space / channel features for thresholding."),Q("segmentation.threshold","Threshold",["native","opencv"],"auto",{thresholdAlgo:{kind:"number",label:"Threshold algo",min:0,max:3,step:1,default:1},manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128},adaptBlock:{kind:"number",label:"Adaptive block",min:3,max:101,step:2,default:31},adaptC:{kind:"number",label:"Adaptive C",min:-50,max:50,step:1,default:3}},void 0,"Convert features into a binary mask."),Q("segmentation.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:5},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Remove specks, fill holes, and stabilize regions.")],"Fixed-order segmentation pipeline. Presets configure each step."),Q("image","iMage",["native","opencv"],"auto",{},[Q("mage.process","Process",["native"],"auto",{imageScale:{kind:"number",label:"Processing scale",min:25,max:100,step:5,default:100},edgeThreshold:{kind:"number",label:"Edge threshold",min:1,max:255,step:1,default:70},invertOutput:{kind:"boolean",label:"White background",default:!0}}),Q("mage.clean","Clean & Smooth",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:500,step:1,default:12},cleanRadius:{kind:"number",label:"Repair strength",min:1,max:3,step:1,default:1},cleanBinaryThreshold:{kind:"number",label:"Binary threshold",min:1,max:254,step:1,default:128}},[Q("mage.clean.threshold","Threshold",["native"],"auto",{}),Q("mage.clean.removeSmallComponents","Remove small components",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:5e3,step:1,default:12}},void 0,"Remove connected components smaller than the minimum area."),Q("mage.clean.repair","Repair gaps",["native"],"auto",{}),Q("mage.clean.smooth","Smooth mask",["native"],"auto",{}),Q("mage.clean.quality","Quality metrics",["native"],"auto",{})]),Q("mage.vectorize","Vectorize (SVG)",["native"],"native",{pathSmoothIters:{kind:"number",label:"Path smoothing",min:0,max:4,step:1,default:2}})]),Q("colors","Colors",["native"],"auto",{},[Q("colors.fill","Region fill",["native"],"auto",{edgesDark:{kind:"boolean",label:"Edges are dark",default:!0},edgeMaskThreshold:{kind:"number",label:"Edge threshold",min:0,max:255,step:1,default:80},edgeDilate:{kind:"number",label:"Gap close (px)",min:0,max:6,step:1,default:2},maxRegionPx:{kind:"number",label:"Max region (px)",min:1e3,step:1e3,default:2e5}})]),Q("pipeline","Pipeline (UI)",["native","opencv"],"auto",{mode:{kind:"text",label:"Pipeline",default:"segmentation"},recipe:{kind:"text",label:"Recipe",default:"default"}},void 0,"UI state for the Pipeline tab (selected pipeline + recipe).")]);return wi(e)}function Ci(e){return e.default}function Ei(e,t){const i={};for(const[n,o]of Object.entries(e))i[n]=Ci(o);for(const[n,o]of Object.entries(t??{}))i[n]=o;return i}function ki(e,t,i){var o;let n=e;for(;n;){const a=t.byId.get(n);if(!a)throw new Error(`[tuning] Unknown component: ${n}`);const l=((o=i[n])==null?void 0:o.enginePolicy)??a.defaultEnginePolicy;if(l!=="inherit")return l;n=t.parentById.get(n)??null}return"native"}function Ii(e,t,i){const n=i.opencvReady&&e.includes("opencv");return e.includes("native")||e.length,t==="native"?{engine:"native"}:t==="opencv"?n?{engine:"opencv"}:{engine:"native",fallbackReason:i.opencvReady?"Policy=opencv, but component has no OpenCV implementation.":"Policy=opencv, but OpenCV is not available at runtime."}:t==="auto"?n?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}function ln(e,t,i,n){var r;const o=t.byId.get(e);if(!o)throw new Error(`[tuning] Unknown component: ${e}`);const a=ki(e,t,i),{engine:s,fallbackReason:l}=Ii(o.implementedEngines,a,n),d=Ei(o.params,(r=i[e])==null?void 0:r.params);return{id:e,policy:a,engine:s,fallbackReason:l,params:d}}const pt="beemage.tuning.components.v1";async function Le(){const e=await ge([pt]).catch(()=>({})),t=e==null?void 0:e[pt];return!t||typeof t!="object"?{}:t}async function cn(e){await fe({[pt]:e}).catch(()=>null)}async function tt(e,t){const i=await Le(),n=i[e]??{};i[e]={enginePolicy:t.enginePolicy??n.enginePolicy,params:{...n.params??{},...t.params??{}}},await cn(i)}async function Pt(e){const t=await Le();delete t[e],await cn(t)}function xi(){return{opencvReady:ve()}}function Si(e){return Array.isArray(e.children)&&e.children.length>0}function dn(e){const{id:t,registry:i,stored:n,runtime:o}=e,a=i.byId.get(t);if(!a)throw new Error(`[tuning] Unknown component: ${t}`);const s=ln(t,i,n,o),l=n[t],d=l==null?void 0:l.enginePolicy,r=l==null?void 0:l.params,f=a.implementedEngines.includes("opencv"),g=!!o.opencvReady,u=[];for(const p of a.children??[])u.push(dn({id:p.id,registry:i,stored:n,runtime:o}));return{id:a.id,title:a.title,description:a.description,isGroup:Si(a),implementedEngines:a.implementedEngines,storedPolicy:d,storedParams:r,effectivePolicy:s.policy,effectiveEngine:s.engine,fallbackReason:s.fallbackReason,paramsSchema:a.params,effectiveParams:s.params,canImplementOpenCv:f,runtimeOpenCvReady:g,children:u}}function pn(e={}){const t=e.registry??rn(),i=e.getRuntimeAvailability??xi;async function n(d="app"){const r=await Le(),f=i();if(!t.byId.get(d))throw new Error(`[tuning] Unknown scope: ${d}`);const u=dn({id:d,registry:t,stored:r,runtime:f});return{scopeId:d,runtime:f,stored:r,root:u}}async function o(d,r){await tt(d,{enginePolicy:r})}async function a(d,r,f){await tt(d,{params:{[r]:f}})}async function s(d){await Pt(d)}async function l(d,r){const g=(await Le())[d];if(!(g!=null&&g.params))return;const u={...g.params??{}};delete u[r];const p=typeof g.enginePolicy=="string",c=Object.keys(u).length>0;if(!p&&!c){await Pt(d);return}await tt(d,{enginePolicy:g.enginePolicy,params:u})}return{getRegistry:()=>t,loadTree:n,setEnginePolicy:o,setParam:a,resetNode:s,resetParam:l}}function Y(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function $t(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function Pi(e){return e.fallbackReason?`${e.effectiveEngine} (fallback)`:e.effectiveEngine}function $i(e){const t=[{value:"native",label:"Native"},{value:"auto",label:"Auto"},...e.canImplementOpenCv?[{value:"opencv",label:"OpenCV"}]:[]];return e.isRoot?t:[{value:"inherit",label:"Inherit"},...t]}function Ai(e){return!1}function Ti(e,t,i){var o;const n=(o=e.storedParams)==null?void 0:o[t];return typeof n<"u"&&n!==i}function Li(e){var g;const{node:t,compId:i,key:n,schema:o,value:a,handlers:s}=e,l=Y("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),d=Y("label",{class:"fieldInline"}),r=Y("span",void 0,o.label);d.appendChild(r);let f;if(o.kind==="number"?(f=Y("input"),f.type="number",typeof o.min=="number"&&(f.min=String(o.min)),typeof o.max=="number"&&(f.max=String(o.max)),typeof o.step=="number"&&(f.step=String(o.step)),f.value=String(a??o.default),f.addEventListener("change",()=>{const u=Number(f.value);s.onSetParam(i,n,Number.isFinite(u)?u:o.default)})):o.kind==="boolean"?(f=Y("input"),f.type="checkbox",f.checked=!!a,f.addEventListener("change",()=>{s.onSetParam(i,n,!!f.checked)})):(f=Y("input"),f.type="text",f.value=String(a??o.default),f.addEventListener("change",()=>{s.onSetParam(i,n,String(f.value??o.default))})),d.appendChild(f),l.appendChild(d),s.onResetParam&&typeof((g=t.storedParams)==null?void 0:g[n])<"u"){const u=Y("button",{type:"button"},"Reset");u.addEventListener("click",p=>{var c;p.preventDefault(),(c=s.onResetParam)==null||c.call(s,i,n)}),l.appendChild(u)}return Ti(t,n,a)&&l.appendChild(Y("span",{class:"muted",style:"font-size:12px;"},"override")),l}function un(e){const{node:t,depth:i,isRoot:n,handlers:o,treeScopeId:a}=e,s=Y("div",{style:`margin-left:${Math.min(i*14,56)}px; margin-top:10px;`}),l=Y("div",{style:"border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:10px; background:rgba(0,0,0,0.12);"}),d=Y("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),r=Y("div");r.appendChild(Y("div",{style:"font-weight:700;"},t.title)),t.description&&r.appendChild(Y("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},t.description)),t.isGroup&&r.appendChild(Y("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},"Group (policy affects children)")),d.appendChild(r);const f=Y("div",{class:"row",style:"align-items:center; gap:10px;"});f.appendChild(Y("span",{class:"qBadge"},Pi(t)));const g=Y("select");g.style.background="rgba(255,255,255,0.05)",g.style.border="1px solid rgba(255,255,255,0.08)",g.style.color="rgba(255,255,255,0.92)",g.style.borderRadius="10px",g.style.padding="6px 8px";const u=$i({isRoot:n,canImplementOpenCv:t.canImplementOpenCv});for(const w of u){const C=Y("option");C.value=w.value,C.textContent=w.label,g.appendChild(C)}const p=new Set(u.map(w=>w.value)),c=t.effectivePolicy;p.has(c)?g.value=c:g.value=n?"native":"inherit",g.addEventListener("change",()=>{o.onSetPolicy(t.id,g.value)}),f.appendChild(g);const h=typeof t.storedPolicy<"u"||t.storedParams&&Object.keys(t.storedParams).length>0;if(o.onResetNode&&h){const w=Y("button",{type:"button"},"Reset node");w.addEventListener("click",C=>{var E;C.preventDefault(),(E=o.onResetNode)==null||E.call(o,t.id)}),f.appendChild(w)}d.appendChild(f),l.appendChild(d),t.fallbackReason?l.appendChild(Y("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},t.fallbackReason)):t.effectivePolicy==="opencv"&&!t.runtimeOpenCvReady&&l.appendChild(Y("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},"OpenCV policy selected, but OpenCV is not available at runtime. It will fall back to native."));const v=Object.keys(t.paramsSchema??{}),y=v.length>0,b=t.children.length>0;if(y||b){const w=Y("details",{style:"margin-top:10px;"});w.open=Ai();const C=Y("summary",{style:"cursor:pointer; user-select:none;"},"Details");if(w.appendChild(C),y){const E=Y("div",{style:"margin-top:10px;"});E.appendChild(Y("div",{class:"muted",style:"font-weight:600; margin-bottom:6px;"},"Parameters"));for(const I of v){const D=t.paramsSchema[I],L=t.effectiveParams[I];E.appendChild(Li({node:t,compId:t.id,key:I,schema:D,value:L,handlers:o}))}w.appendChild(E)}if(b){const E=Y("div",{style:"margin-top:10px;"});for(const I of t.children)E.appendChild(un({node:I,depth:i+1,isRoot:!1,handlers:o,treeScopeId:a}));w.appendChild(E)}l.appendChild(w)}return s.appendChild(l),s}function gn(e,t){let i=!1;function n(a){if(i)return;$t(e);const s=a.scopeId==="app",l=Y("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"});l.appendChild(Y("div",{style:"font-weight:700;"},"Tuning")),l.appendChild(Y("div",{class:"muted",style:"font-size:12px;"},`OpenCV runtime: ${a.runtime.opencvReady?"ready":"not available"}`)),e.appendChild(l),e.appendChild(un({node:a.root,depth:0,isRoot:s,handlers:t,treeScopeId:a.scopeId}))}function o(){i=!0,$t(e)}return{render:n,dispose:o}}function Ri(){let e=!1,t={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},i=!1,n="",o="";function a(r){e=r}function s(r){t={...t,...r}}function l(r){i=r}function d(r){typeof r.general=="string"&&(n=r.general),typeof r.dev=="string"&&(o=r.dev)}return{get showDevTools(){return e},get dev(){return t},get debugEnabled(){return i},get generalStatus(){return n},get devStatus(){return o},setShowDevTools:a,setDev:s,setDebugEnabled:l,setStatus:d}}function Mi(e){function t(r){e.settingsGeneralStatusEl.textContent=r||""}function i(r){e.cfgStatusEl.textContent=r||""}function n(r){e.cfgShowDevToolsEl.checked=r}function o(r){e.tabLogs.hidden=!r,e.devConfigDetailsEl.classList.toggle("is-hidden",!r),r||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function a(r){e.cfgTraceConsoleEl.checked=!!r.traceConsole,e.cfgActionLogMaxEl.value=String(r.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(r.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(r.failureLogsPerRun??50)}function s(r){e.logsCbDebugEl.checked=r}function l(r,f){e.settingsVersionEl.textContent=r||"—",e.settingsGitHubLinkEl.href=f||"#",e.settingsGitHubLinkEl.hidden=!f}function d(r){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=r,e.cfgActionLogMaxEl.disabled=r,e.cfgDebugTraceMaxEl.disabled=r,e.cfgFailureLogsPerRunEl.disabled=r,e.btnCfgResetDefaults.disabled=r,e.logsCbDebugEl.disabled=r,e.cfgUseOpenCvEl.disabled=r}return{setGeneralStatus:t,setDevStatus:i,setShowDevToolsChecked:n,setDevToolsVisible:o,setDevConfig:a,setDebugEnabledChecked:s,setAbout:l,setBusy:d}}const nt="template.settings.showDevTools",it="beemage.settings.engine.useOpenCv";function Di(){return di}function ot(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??ae.actionLogMax),debugTraceMax:Number(e.debugTraceMax??ae.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??ae.failureLogsPerRun)}}function Oi(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:ue(e.cfgActionLogMaxEl.value,100,5e4,ae.actionLogMax),debugTraceMax:ue(e.cfgDebugTraceMaxEl.value,100,5e4,ae.debugTraceMax),failureLogsPerRun:ue(e.cfgFailureLogsPerRunEl.value,0,5e4,ae.failureLogsPerRun)}}async function At(e){const t=tn;return typeof t.setEnabled=="function"?(await t.setEnabled(e),{ok:!0}):typeof t.enable=="function"&&typeof t.disable=="function"?(await(e?t.enable():t.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function Bi(e,t){const i=Ri(),n=Mi(e),o=pn({getRuntimeAvailability:()=>({opencvReady:e.cfgUseOpenCvEl.checked&&ve()})}),a=gn(e.tuningMountEl,{onSetPolicy:async($,m)=>{await o.setEnginePolicy($,m),await b("policy change")},onSetParam:async($,m,z)=>{await o.setParam($,m,z),await b("param change")},onResetNode:async $=>{await o.resetNode($),await b("reset node")},onResetParam:async($,m)=>{await o.resetParam($,m),await b("reset param")}});function s($){e.settingsEngineBoxEl.classList.toggle("is-hidden",!1)}async function l(){const $=await ge([it]).catch(()=>({}));return($==null?void 0:$[it])===!0}async function d($){await fe({[it]:!!$}).catch(()=>null)}function r($){var m;e.cfgUseOpenCvEl.checked=$,(m=e.cfgUseOpenCvEl.closest(".switch"))==null||m.classList.toggle("is-disabled",e.cfgUseOpenCvEl.disabled)}function f($){e.cfgOpenCvSpinner.classList.toggle("is-hidden",!$),e.cfgOpenCvSpinner.setAttribute("aria-hidden",$?"false":"true")}function g($){e.cfgOpenCvStatus.textContent=$||""}function u($){e.cfgOpenCvReport.textContent=$||""}async function p(){if(oe())return;if(!!!e.cfgUseOpenCvEl.checked){await d(!1),f(!1),g(ve()?"OpenCV loaded (native mode)":"Native mode"),u("Native mode. OpenCV is optional and demo-only."),await b("opencv mode disabled");return}f(!0),g("Loading OpenCV…"),u("Loading OpenCV…");try{if(await ui(e,async()=>{await vi()}),!ve())throw new Error("OpenCV load returned but runtime is not injected.");await d(!0),g("OpenCV mode enabled"),u("OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV."),await b("opencv mode enabled")}catch(m){const z=String((m==null?void 0:m.message)??m);await d(!1),r(!1),g("OpenCV load failed"),u(`ERROR

${z}`),be("[settings] OpenCV toggle failed",{msg:z})}finally{f(!1)}}async function c(){const $=await ge([nt]).catch(()=>({}));return($==null?void 0:$[nt])===!0}async function h($){await fe({[nt]:!!$}).catch(()=>null)}function v($){i.setShowDevTools($),n.setShowDevToolsChecked($),n.setDevToolsVisible($)}async function y(){const $=await c();v($),H("Settings: boot applyDevToolsVisibility",{showDevTools:$})}async function b($){try{const m=await o.loadTree("app");a.render(m),H("[settings] tuning rendered",{reason:$,opencvInjected:ve(),opencvMode:!!e.cfgUseOpenCvEl.checked})}catch(m){be("[settings] tuning render failed",{reason:$,msg:String((m==null?void 0:m.message)??m)}),e.tuningMountEl.textContent="Tuning UI failed to load (see console)."}}async function w(){var M;n.setBusy(oe());const $=await c();v($),await lt().catch(()=>null);const m=_e();i.setDev(ot(m)),n.setDevConfig(i.dev);const z=tn;let _=!1;try{typeof z.isEnabled=="function"?_=!!await z.isEnabled():_=!!z.enabled}catch(O){Ve("Settings: failed to read debug enabled state",{error:O instanceof Error?O.message:String(O)})}i.setDebugEnabled(_),n.setDebugEnabledChecked(_),n.setAbout(Di(),((M=e.settingsGitHubLinkEl)==null?void 0:M.href)||"#"),s();{const O=await l();r(O),f(!1);const k=ve();O?(g(k?"OpenCV mode enabled":"OpenCV mode (not loaded)"),u(k?"OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV.":"OpenCV mode is enabled, but OpenCV is not loaded yet. Toggle OFF then ON to load OpenCV.")):(g(k?"OpenCV loaded (native mode)":"Native mode"),u("Native mode. OpenCV is optional and demo-only."))}n.setGeneralStatus(""),n.setDevStatus(""),await b("loadAll"),H("Settings: loaded",{showDevTools:$,debugTraceEnabled:_,dev:i.dev,opencvInjected:ve()})}async function C(){const $=!!e.cfgShowDevToolsEl.checked;v($),await h($),G({kind:"run",scope:"settings",message:$?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:$}}),H("Settings: ui toggle showDevTools",{showDevTools:$}),n.setGeneralStatus($?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>n.setGeneralStatus(""),1200)}async function E(){const $=Oi(e);n.setDevStatus("Saving…");try{await qt($)}catch(m){be("Settings: failed to save dev config",{error:m instanceof Error?m.message:String(m),next:$}),n.setDevStatus("Save failed."),setTimeout(()=>n.setDevStatus(""),1200);return}i.setDev(ot($)),n.setDevConfig(i.dev),G({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:$}),H("Settings: devConfig updated",$),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}async function I(){n.setDevStatus("Resetting…");try{await zn(),await lt().catch(()=>null);const m=_e();i.setDev(ot(m)),n.setDevConfig(i.dev)}catch(m){be("Settings: failed to reset dev config defaults",{error:m instanceof Error?m.message:String(m)}),n.setDevStatus("Reset failed."),setTimeout(()=>n.setDevStatus(""),1200);return}const $=await At(!1);$.ok?(i.setDebugEnabled(!1),n.setDebugEnabledChecked(!1)):(Ve("Settings: failed to reset debug enabled state",{error:$.error||"unknown error"}),G({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:$.error||"unknown error"})),G({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...ae,debugEnabled:!1}}),H("Settings: reset defaults",{...ae,debugEnabled:!1}),n.setDevStatus("Reset."),setTimeout(()=>n.setDevStatus(""),1200)}async function D(){const $=!!e.logsCbDebugEl.checked;n.setDevStatus("Saving…");const m=await At($);if(!m.ok){e.logsCbDebugEl.checked=!$,n.setDevStatus(`Save failed: ${m.error||"unknown error"}`),be("Settings: failed to change debug enabled state",{error:m.error||"unknown error",enabled:$}),G({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:m.error||"unknown error",meta:{enabled:$}});return}i.setDebugEnabled($),G({kind:"run",scope:"settings",message:$?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:$}}),H("Settings: debug enabled changed",{enabled:$}),n.setDevStatus("Saved."),setTimeout(()=>n.setDevStatus(""),1200)}const L=t.on(()=>{});function U(){e.cfgShowDevToolsEl.addEventListener("change",()=>{C()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{oe()||E()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{oe()||E()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{oe()||E()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{oe()||E()}),e.btnCfgResetDefaults.addEventListener("click",()=>{oe()||I()}),e.logsCbDebugEl.addEventListener("change",()=>{oe()||D()}),e.cfgUseOpenCvEl.addEventListener("change",()=>{p()}),y().catch($=>{Ve("Settings: initDevToolsVisibility failed",{error:$ instanceof Error?$.message:String($)})})}return{id:"settings",refresh(){w().catch($=>{be("Settings: refresh failed",{error:$ instanceof Error?$.message:String($)})})},mount(){w().catch($=>{be("Settings: mount failed",{error:$ instanceof Error?$.message:String($)})})},unmount(){},bind:U,dispose(){L()}}}function Ui(){let e=[],t=0;function i(n){e=n.items,t=n.total}return{get items(){return e},get total(){return t},set:i}}function zi(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function Tt(e,t){const i=[];i.push(`Total entries: ${t.total}`),i.push("");for(const n of t.items){const o=typeof n.ok=="boolean"?n.ok?"ok":"fail":"",a=[];typeof n.status=="number"&&a.push(`status=${n.status}`),o&&a.push(o);const s=[n.scope,n.kind].filter(Boolean).join("/");i.push(`[${zi(n.ts)}] ${s}${a.length?` (${a.join(", ")})`:""}`),i.push(`  ${n.message}`),n.error&&i.push(`  error: ${n.error}`),i.push("")}e.textContent=i.join(`
`),e.scrollTop=0}function Vi(e){function t(s){e.logsStatusEl.textContent=s}function i(s){e.debugStatusEl.textContent=s}function n(s){e.logsCbDebugEl.checked=s}function o(s){Tt(e.logsOutEl,{total:s.total,items:s.items.map(l=>({ts:l.ts,message:l.message,scope:l.scope,kind:l.kind,ok:l.ok,status:l.status,error:l.error,meta:l.meta}))})}function a(s){Tt(e.debugOutEl,{total:s.total,items:s.items.map(l=>({ts:l.ts,message:l.message,scope:l.scope,kind:l.kind,ok:l.ok,status:l.status,error:l.error,meta:l.meta}))})}return{setAuditStatus:t,setDebugStatus:i,setDebugChecked:n,renderAudit:o,renderDebug:a}}const Lt="beemage";function Ni(e,t){const i=Ui(),n=Vi(e);async function o(){n.setAuditStatus("Loading…"),ce(e,!0);try{const c=ue(e.logsLimitEl.value,10,5e3,200),h=await Hn({limit:c,reverse:!0});i.set(h),n.renderAudit({items:i.items,total:i.total}),n.setAuditStatus(`Showing ${i.items.length} (newest first)`)}catch(c){n.setAuditStatus(`Failed: ${(c==null?void 0:c.message)||String(c)}`)}finally{ce(e,!1)}}async function a(){n.setDebugStatus("Loading…"),ce(e,!0);try{const c=ue(e.debugLimitEl.value,10,5e3,200),h=await Qt({limit:c,reverse:!0});n.renderDebug(h),n.setDebugStatus(`Showing ${h.items.length} (newest first)`)}catch(c){n.setDebugStatus(`Failed: ${(c==null?void 0:c.message)||String(c)}`)}finally{ce(e,!1)}}async function s(){const c=await wt();n.setDebugChecked(c)}async function l(c){if(await Yt(c),n.setDebugChecked(c),!c){n.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}n.setDebugStatus("Debug ON."),await a()}async function d(){const c=ue(e.logsTrimKeepEl.value,0,5e4,2e3);n.setAuditStatus("Trimming…"),ce(e,!0);try{const h=await Wn({keepLast:c});await o(),n.setAuditStatus(`Trimmed. Remaining: ${h.total}`)}catch(h){n.setAuditStatus(`Trim failed: ${(h==null?void 0:h.message)||String(h)}`)}finally{ce(e,!1)}}async function r(){n.setAuditStatus("Clearing…"),ce(e,!0);try{await Jn(),await o(),n.setAuditStatus("Cleared.")}catch(c){n.setAuditStatus(`Clear failed: ${(c==null?void 0:c.message)||String(c)}`)}finally{ce(e,!1)}}async function f(){n.setAuditStatus("Exporting…");try{const c=await qn({pretty:!0}),h=new Blob([c],{type:"application/json"}),v=URL.createObjectURL(h),y=document.createElement("a");y.href=v,y.download=`${Lt}-audit-${Date.now()}.json`,y.click(),setTimeout(()=>URL.revokeObjectURL(v),1e3),n.setAuditStatus("Exported.")}catch(c){n.setAuditStatus(`Export failed: ${(c==null?void 0:c.message)||String(c)}`)}}async function g(){n.setDebugStatus("Clearing…"),ce(e,!0);try{await Xt(),await a(),n.setDebugStatus("Cleared.")}catch(c){n.setDebugStatus(`Clear failed: ${(c==null?void 0:c.message)||String(c)}`)}finally{ce(e,!1)}}async function u(){n.setDebugStatus("Exporting…");try{const c=await en({pretty:!0}),h=new Blob([c],{type:"application/json"}),v=URL.createObjectURL(h),y=document.createElement("a");y.href=v,y.download=`${Lt}-debug-${Date.now()}.json`,y.click(),setTimeout(()=>URL.revokeObjectURL(v),1e3),n.setDebugStatus("Exported.")}catch(c){n.setDebugStatus(`Export failed: ${(c==null?void 0:c.message)||String(c)}`)}}function p(){e.btnLogsRefresh.addEventListener("click",()=>{oe()||o()}),e.btnLogsTrim.addEventListener("click",()=>{oe()||d()}),e.btnLogsClear.addEventListener("click",()=>{oe()||r()}),e.btnLogsExport.addEventListener("click",()=>{oe()||f()}),e.logsCbDebugEl.addEventListener("change",()=>{oe()||l(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{oe()||a()}),e.btnDebugClear.addEventListener("click",()=>{oe()||g()}),e.btnDebugExport.addEventListener("click",()=>{oe()||u()})}return{id:"logs",bind:p,mount(){s(),o(),a()},unmount(){},dispose(){}}}function _i(e,t){if(e.id===t)return e;const i=[...e.children??[]];for(;i.length>0;){const n=i.shift();if(n.id===t)return n;for(const o of n.children??[])i.push(o)}throw new Error(`[tuning] scopeRootId not found in VM tree: ${t}`)}function ji(e,t){if(e.id===t)return e;const i=[...e.children??[]];for(;i.length>0;){const n=i.shift();if(n.id===t)return n;for(const o of n.children??[])i.push(o)}return null}function Fi(e){const t=pn({getRuntimeAvailability:e.getRuntimeAvailability}),i=[];let n=!1;async function o(){return await t.loadTree("app")}async function a(){if(n)return;const y=await o();for(const b of i){if(b.scopeRootId==="app"){b.view.render(y);continue}const w=_i(y.root,b.scopeRootId);b.view.render({...y,scopeId:b.scopeRootId,root:w})}}async function s(y,b){await t.setEnginePolicy(y,b),e.actionLogAppend(`[tuning] policy ${y} = ${b}`),e.debugTraceAppend(`[tuning] setPolicy id=${y} policy=${b}`),await a()}async function l(y,b,w){await t.setParam(y,b,w),e.actionLogAppend(`[tuning] param ${y}.${b} = ${String(w)}`),e.debugTraceAppend(`[tuning] setParam id=${y} key=${b} value=${String(w)}`),await a()}async function d(y){await t.resetNode(y),e.actionLogAppend(`[tuning] reset node ${y}`),e.debugTraceAppend(`[tuning] resetNode id=${y}`),await a()}async function r(y,b){await t.resetParam(y,b),e.actionLogAppend(`[tuning] reset param ${y}.${b}`),e.debugTraceAppend(`[tuning] resetParam id=${y} key=${b}`),await a()}async function f(y){var b,w;if(!n){if(y.policies)for(const C of y.policies)await t.setEnginePolicy(C.id,C.policy);if(y.params)for(const C of y.params)await t.setParam(C.id,C.key,C.value);e.actionLogAppend(`[tuning] preset ${y.id} (${y.title})`),e.debugTraceAppend(`[tuning] applyPreset id=${y.id} title=${y.title} policies=${((b=y.policies)==null?void 0:b.length)??0} params=${((w=y.params)==null?void 0:w.length)??0}`),await a()}}async function g(y){const b=await o(),w=ji(b.root,y);if(!w)throw new Error(`[tuning] getEffectiveParams: unknown component id ${y}`);return{...w.effectiveParams??{}}}async function u(y,b,w){await t.setParam(y,b,w),e.actionLogAppend(`[tuning] param ${y}.${b} = ${String(w)}`),e.debugTraceAppend(`[tuning] setParamValue id=${y} key=${b} value=${String(w)}`),await a()}function p(y){if(n)return;const{mountEl:b,scopeRootId:w}=y;if(i.some(E=>E.mountEl===b))return;const C=gn(b,{onSetPolicy:s,onSetParam:l,onResetNode:d,onResetParam:r});i.push({mountEl:b,scopeRootId:w,view:C}),a()}function c(y){const b=i.findIndex(w=>w.mountEl===y);b<0||(i[b].view.dispose(),i.splice(b,1))}async function h(){await a()}function v(){n=!0;for(const y of i)y.view.dispose();i.length=0}return{mount:p,unmount:c,refresh:h,applyPreset:f,getEffectiveParams:g,setParamValue:u,dispose:v}}function se(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function Gi(e){const t=[{kind:"input",type:e.io.input}],i=[{kind:"output",type:e.io.output}];return{id:e.id,title:e.title,group:e.group,inputs:t,outputs:i}}function Ki(e){const t=String(e||"").toLowerCase();return t==="image"?"opPort--image":t==="mask"?"opPort--mask":t==="svg"?"opPort--svg":"opPort--unknown"}function Hi(e){const{kind:t,type:i}=e,n="http://www.w3.org/2000/svg",o=document.createElementNS(n,"svg");o.setAttribute("viewBox","0 0 48 20"),o.setAttribute("width","48"),o.setAttribute("height","20"),o.setAttribute("aria-hidden","true"),o.classList.add("opPort__glyph");const a=String(i||"").toLowerCase(),s=t==="output",l=document.createElementNS(n,"rect");l.setAttribute("x","1"),l.setAttribute("y","3"),l.setAttribute("width","46"),l.setAttribute("height","14"),l.setAttribute("rx","7"),l.setAttribute("ry","7"),l.classList.add("opPort__glyphTrack"),o.appendChild(l);const d=document.createElementNS(n,"path");d.classList.add("opPort__glyphShape");const r=(h,v,y)=>Math.max(v,Math.min(y,h)),f=24,g=10,u=7,c=r((a==="mask"?12:a==="svg"||a==="image"?14:12)/2,4,10);if(a==="image")if(s){const h=f-c,v=f+c+u,y=g-6,b=g+6;d.setAttribute("d",`M ${h} ${y} L ${v} ${g} L ${h} ${b} Z`)}else{const h=f+c,v=f-c-u,y=g-6,b=g+6;d.setAttribute("d",`M ${h} ${y} L ${v} ${g} L ${h} ${b} Z`),d.classList.add("opPort__glyphShape--socket")}else if(a==="svg")if(s){const h=f-c,v=c*2+u;d.setAttribute("d",[`M ${h} ${g-6}`,`h ${v}`,"a 6 6 0 0 1 0 12",`h ${-v}`,"a 6 6 0 0 1 0 -12","Z"].join(" "))}else{const h=f+c,v=c*2+u;d.setAttribute("d",[`M ${h} ${g-6}`,`h ${-v}`,"a 6 6 0 0 0 0 12",`h ${v}`,"a 6 6 0 0 0 0 -12","Z"].join(" ")),d.classList.add("opPort__glyphShape--socket")}else if(s){const h=f-c,v=c*2+u;d.setAttribute("d",`M ${h} ${g-6} h ${v} v 12 h ${-v} Z`)}else{const h=f+c,v=c*2+u;d.setAttribute("d",`M ${h} ${g-6} h ${-v} v 12 h ${v} Z`),d.classList.add("opPort__glyphShape--socket")}return o.appendChild(d),o}function Wi(e){const{port:t,getPortClass:i}=e,n=`opPort ${i(t.type)}`,o=t.label?`${t.label}: ${t.type}`:String(t.type);return se("div",{class:n,"data-port-kind":t.kind,"data-port-type":String(t.type)},o)}function Ji(e){const{port:t,getPortClass:i}=e,n=`opPort opPort--puzzle ${i(t.type)}`,o=se("div",{class:n,"data-port-kind":t.kind,"data-port-type":String(t.type)}),a=t.label?t.label:String(t.type);o.appendChild(se("div",{class:"opPort__puzzleLabel"},a));const s=Hi({kind:t.kind,type:t.type});return o.appendChild(s),o}function Rt(e){const{ports:t,kind:i,portStyle:n,getPortClass:o}=e,a=se("div",{class:"opCard__portsRow"}),s=se("div",{class:"opCard__portsLabel"},i==="input"?"IN":"OUT");a.appendChild(s);const l=se("div",{class:"opCard__ports"});for(const d of t){const r=n==="puzzle"?Ji({port:d,getPortClass:o}):Wi({port:d,getPortClass:o});l.appendChild(r)}return a.appendChild(l),a}function he(e,t,i){return Math.max(t,Math.min(i,e))}function He(e){const t=String(e||"").toLowerCase();return t==="image"?"image":t==="mask"?"mask":t==="svg"?"svg":"unknown"}function We(e){return e==="image"?{w:34,d:7,shape:"circle"}:e==="svg"?{w:30,d:7,shape:"triangle"}:e==="mask"?{w:28,d:6,shape:"rect"}:{w:26,d:6,shape:"rect"}}function qi(e){return`url("data:image/svg+xml,${encodeURIComponent(e).replace(/'/g,"%27").replace(/"/g,"%22")}")`}function Zi(e){const{root:t,inType:i,outType:n}=e,o=He(i),a=He(n),s=We(o),l=We(a),d=Yi({inType:i,outType:n}),r=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 110" preserveAspectRatio="none">
    <path d="${d}" fill="white"/>
  </svg>`,f=qi(r);t.style.webkitMaskImage=f,t.style.webkitMaskRepeat="no-repeat",t.style.webkitMaskSize="100% 100%",t.style.webkitMaskPosition="center",t.style.maskImage=f,t.style.maskRepeat="no-repeat",t.style.maskSize="100% 100%",t.style.maskPosition="center",t.classList.add("opCard--puzzleFrame"),t.style.position="relative",t.style.border="none",t.style.overflow="visible",t.style.minWidth="0";let g=t.querySelector(":scope > svg.opCard__puzzleOutline");if(!g)g=document.createElementNS("http://www.w3.org/2000/svg","svg"),g.classList.add("opCard__puzzleOutline"),g.setAttribute("viewBox","0 0 100 110"),g.setAttribute("preserveAspectRatio","none"),g.innerHTML=`<path d="${d}" fill="none" stroke="rgba(255,255,255,0.18)" stroke-width="1.5"/>`,t.insertBefore(g,t.firstChild);else{const b=g.querySelector("path");b&&b.setAttribute("d",d)}const u=t.classList.contains("opCard--compact"),p=u?22:26,c=u?16:18,h=u?16:18,v=c+Math.round(s.d*.9),y=h+Math.round(l.d*.9);t.style.setProperty("--opPuzzleInsetX",`${p}px`),t.style.setProperty("--opPuzzleInsetTop",`${v}px`),t.style.setProperty("--opPuzzleInsetBottom",`${y}px`)}function Yi(e){const l=He(e.inType),d=He(e.outType),r=We(l),f=We(d),g=50,u=he(r.w,18,40),p=he(r.d,6,12),c=he(f.w,18,40),h=Math.max(6,Math.min(12,8)),v=he(f.d,6,h),y=he(g-u/2,20,80),b=he(g+u/2,20,80),w=he(g-c/2,20,80),C=he(g+c/2,20,80);function E(){if(r.shape==="triangle")return`L ${g} ${0+p} L ${b} 0`;if(r.shape==="circle"){const D=y,L=b,U=L-D,$=p,m=Math.max(6,U*.25),z=D+U/2;return[`C ${D+m} 0 ${D+m} ${0+$} ${z} ${0+$}`,`C ${L-m} ${0+$} ${L-m} 0 ${L} 0`].join(" ")}return`V ${0+p} H ${b} V 0`}function I(){if(f.shape==="triangle")return`L ${g} ${100+v} L ${w} 100`;if(f.shape==="circle"){const D=C,L=w,U=D-L,$=v,m=Math.max(6,U*.25),z=L+U/2;return[`C ${D-m} 100 ${D-m} ${100+$} ${z} ${100+$}`,`C ${L+m} ${100+$} ${L+m} 100 ${L} 100`].join(" ")}return`V ${100+v} H ${w} V 100`}return["M 16 0",`H ${y}`,E(),"H 84","A 10 10 0 0 1 94 10","V 90","A 10 10 0 0 1 84 100",`H ${C}`,I(),"H 16","A 10 10 0 0 1 6 90","V 10","A 10 10 0 0 1 16 0","Z"].join(" ")}function Ze(e,t){const i=Gi(e),n={compact:!!(t!=null&&t.compact),showId:(t==null?void 0:t.showId)??!0,showGroup:(t==null?void 0:t.showGroup)??!0,portStyle:(t==null?void 0:t.portStyle)??"chip",cardStyle:(t==null?void 0:t.cardStyle)??"plain",getPortClass:(t==null?void 0:t.getPortClass)??Ki,onClick:t==null?void 0:t.onClick},o=se("div",{class:`opCard${n.compact?" opCard--compact":""}`,"data-op-id":i.id}),a=se("div",{class:"opCard__content"}),s=se("div",{class:"opCard__head"}),l=se("div",{class:"opCard__title"},i.title);s.appendChild(l);const d=se("div",{class:"opCard__meta"});n.showGroup&&i.group&&d.appendChild(se("span",{class:"opBadge opBadge--group"},i.group)),n.showId&&d.appendChild(se("span",{class:"opBadge opBadge--id"},i.id)),s.appendChild(d),a.appendChild(s);const r=se("div",{class:"opCard__body"});return r.appendChild(Rt({ports:i.inputs,kind:"input",portStyle:n.portStyle,getPortClass:n.getPortClass})),r.appendChild(Rt({ports:i.outputs,kind:"output",portStyle:n.portStyle,getPortClass:n.getPortClass})),a.appendChild(r),o.appendChild(a),n.cardStyle==="puzzleFrame"&&Zi({root:o,inType:e.io.input,outType:e.io.output}),n.onClick&&(o.classList.add("opCard--clickable"),o.addEventListener("click",f=>{var g,u;(g=f.preventDefault)==null||g.call(f),(u=n.onClick)==null||u.call(n,i.id)})),o}function j(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function Xi(e){return e.type==="image"}function Qi(e){return e.type==="mask"}function eo(e){return e.type==="svg"}function to(e){return e.type==="imageList"}function no(e){return e.type==="pdf"}function fn(e){return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(e)}`}function Mt(e,t){var n;if(no(e)){const o=Math.max(1,Math.round((((n=e.bytes)==null?void 0:n.length)??0)/1024));return j("div",{class:"muted",style:"margin-top:8px; font-size:12px; white-space:pre-wrap;"},`PDF output (${o} KB)`)}if(to(e)){const o=j("div",{style:"margin-top:8px;"});o.appendChild(j("div",{class:"muted",style:"font-size:12px; margin-bottom:6px;"},`Image list (${e.items.length})`));const a=e.items[0];if(a){const s=j("canvas",{class:"canvas",style:`display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});pe(s,a.image),o.appendChild(s)}return o}if(Xi(e)){const o=j("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return pe(o,e.image),o}if(Qi(e)){const o=j("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return gt(o,e.mask,e.width,e.height),o}if(!eo(e))return j("div",{class:"muted",style:"margin-top:8px; font-size:12px;"},`Unsupported output: ${String(e.type)}`);const i=j("img",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`,"aria-label":"SVG preview"});return i.src=fn(e.svg),i}function ut(e,t){const i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download=e,n.rel="noopener",n.click(),setTimeout(()=>URL.revokeObjectURL(i),500)}async function at(e,t){const i=await new Promise(n=>t.toBlob(o=>n(o),"image/png"));if(!i)throw new Error("Failed to create PNG blob.");ut(e,i)}function pe(e,t){e.width=t.width,e.height=t.height;const i=e.getContext("2d",{willReadFrequently:!0});i&&i.putImageData(t,0,0)}function gt(e,t,i,n){e.width=i,e.height=n;const o=e.getContext("2d",{willReadFrequently:!0});if(!o)return;let a=0;const s=i*n;for(let f=0;f<s;f++){const g=t[f]??0;g>a&&(a=g)}const l=a<=1,d=o.createImageData(i,n),r=d.data;for(let f=0;f<s;f++){const g=t[f]??0;let u;l?u=(g>0?1:0)?0:255:u=g;const p=f*4;r[p]=u,r[p+1]=u,r[p+2]=u,r[p+3]=255}o.putImageData(d,0,0)}function io(e){const{hostEl:t,statusEl:i,handlers:n}=e;let o=!1,a=null,s=null,l=null,d=null,r=null,f=null,g=null,u=null,p=null,c=null,h=null,v=null,y=null,b=null;function w(){for(;t.firstChild;)t.removeChild(t.firstChild)}async function C(m){var N,R,B,K,V,F,q,X,Z,te;const _=(typeof(m==null?void 0:m.activePipelineId)=="string"?m.activePipelineId:"pipeline").replace(/[^a-z0-9_-]+/gi,"_").slice(0,40)||"pipeline",M=(N=m==null?void 0:m.outputPdf)==null?void 0:N.bytes;if(M&&M.byteLength>0){const ne=typeof((R=m==null?void 0:m.outputPdf)==null?void 0:R.filenameHint)=="string"?m.outputPdf.filenameHint:"",xe=ne&&ne.toLowerCase().endsWith(".pdf")?ne:`beemage-${_}.pdf`,ke=new Uint8Array(M.byteLength);ke.set(M);const Ye=new Blob([ke],{type:"application/pdf"});ut(xe,Ye);return}const O=(B=m==null?void 0:m.outputSvg)==null?void 0:B.svg;if(typeof O=="string"&&O.length>0){const ne=new Blob([O],{type:"image/svg+xml;charset=utf-8"});ut(`beemage-${_}.svg`,ne);return}const k=(K=m==null?void 0:m.outputImage)==null?void 0:K.data;if(k){const ne=document.createElement("canvas");pe(ne,k),await at(`beemage-${_}.png`,ne);return}const S=(V=m==null?void 0:m.outputMask)==null?void 0:V.data,P=(F=m==null?void 0:m.outputMask)==null?void 0:F.width,x=(q=m==null?void 0:m.outputMask)==null?void 0:q.height;if(S&&typeof P=="number"&&typeof x=="number"){const ne=document.createElement("canvas");gt(ne,S,P,x),await at(`beemage-${_}-mask.png`,ne);return}const T=(X=m==null?void 0:m.outputImageList)==null?void 0:X.count,A=(te=(Z=m==null?void 0:m.outputImageList)==null?void 0:Z.first)==null?void 0:te.data;if(typeof T=="number"&&T>0&&A){const ne=document.createElement("canvas");pe(ne,A),await at(`beemage-${_}-0.png`,ne);return}throw new Error("No output to download.")}function E(){if(o)return;o=!0,w(),a=j("div",{class:"card"}),u=j("p",{class:"muted",style:"margin-top:0;"},"Universal pipeline runner. Select a pipeline and run it.");const m=j("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),z=j("label",{class:"fieldInline"});z.appendChild(j("span",{},"Pipeline")),s=j("select"),z.appendChild(s);const _=j("label",{class:"fieldInline"});_.appendChild(j("span",{},"Recipe")),l=j("select"),_.appendChild(l),d=j("button",{type:"button"},"Run all"),r=j("button",{type:"button"},"Next step"),f=j("button",{type:"button"},"Reset"),g=j("button",{type:"button"},"Download"),m.appendChild(z),m.appendChild(_),m.appendChild(d),m.appendChild(r),m.appendChild(f),m.appendChild(g);const M=j("div",{class:"grid4",style:"margin-top:12px;"}),O=j("div",{class:"card"});O.appendChild(j("div",{class:"cardTitle"},"Input (from source)")),p=j("canvas",{class:"canvas","aria-label":"Pipeline input preview"}),O.appendChild(p);const k=j("div",{class:"card"});k.appendChild(j("div",{class:"cardTitle"},"Current output")),v=j("div",{class:"muted",style:"font-size:12px; margin-top:6px;"}),c=j("canvas",{class:"canvas","aria-label":"Pipeline current output preview"}),h=j("img",{class:"canvas","aria-label":"Pipeline SVG output preview",style:"display:none;"}),k.appendChild(v),k.appendChild(c),k.appendChild(h);const S=j("div",{class:"card",style:"grid-column:1 / -1;"});S.appendChild(j("div",{class:"cardTitle"},"Stages")),y=j("div"),S.appendChild(y),M.appendChild(O),M.appendChild(k),M.appendChild(S),a.appendChild(u),a.appendChild(m),a.appendChild(M),t.appendChild(a),s.addEventListener("change",()=>{const P=s?s.value:"segmentation";n.onSelectPipeline(P)}),l.addEventListener("change",()=>{const P=l?l.value:"default";n.onSelectRecipe(P)}),d.addEventListener("click",()=>n.onRunAll()),r.addEventListener("click",()=>n.onNext()),f.addEventListener("click",()=>n.onReset()),g.addEventListener("click",async()=>{try{await C(b)}catch(P){const x=P instanceof Error?P.message:String(P);i.textContent=`Download failed: ${x}`}})}function I(m){if(!s||!l)return;const z=Array.isArray(m==null?void 0:m.pipelines)?m.pipelines:[],_=Array.isArray(m==null?void 0:m.recipes)?m.recipes:[],M=typeof(m==null?void 0:m.activePipelineId)=="string"?m.activePipelineId:"segmentation",O=typeof(m==null?void 0:m.activeRecipeId)=="string"?m.activeRecipeId:"default";s.innerHTML="";for(const k of z){const S=j("option");S.value=k.id,S.textContent=k.title,k.id===M&&(S.selected=!0),s.appendChild(S)}l.innerHTML="";for(const k of _){const S=j("option");S.value=k.id,S.textContent=k.title,k.id===O&&(S.selected=!0),l.appendChild(S)}}function D(m){var O,k,S;if(!p)return;const z=m==null?void 0:m.inputArtifact;if(z&&z.type==="image"){pe(p,z.image);return}if(z&&z.type==="imageList"){const P=(k=(O=z.items)==null?void 0:O[0])==null?void 0:k.image;if(P){pe(p,P);return}}const _=(S=m==null?void 0:m.input)==null?void 0:S.data;if(_){pe(p,_);return}p.width=1,p.height=1;const M=p.getContext("2d");M&&M.clearRect(0,0,p.width,p.height)}function L(m){var A,N,R,B,K,V,F,q,X;if(!c||!h||!v)return;v.textContent="";const z=(A=m==null?void 0:m.outputPdf)==null?void 0:A.bytes;if(z&&z.length){c.style.display="none",h.style.display="none",h.src="";const Z=Math.max(1,Math.round(z.length/1024));v.textContent=`PDF output (${Z} KB)`;return}const _=(N=m==null?void 0:m.outputImageList)==null?void 0:N.count,M=(B=(R=m==null?void 0:m.outputImageList)==null?void 0:R.first)==null?void 0:B.data;if(typeof _=="number"&&_>0){if(v.textContent=`Image list (${_})`,M){c.style.display="block",h.style.display="none",h.src="",pe(c,M);return}c.style.display="none",h.style.display="none",h.src="";return}const O=(K=m==null?void 0:m.outputSvg)==null?void 0:K.svg;if(typeof O=="string"&&O.length>0){c.style.display="none",h.style.display="block",h.src=fn(O);return}c.style.display="block",h.style.display="none",h.src="";const k=(V=m==null?void 0:m.outputImage)==null?void 0:V.data;if(k){pe(c,k);return}const S=(F=m==null?void 0:m.outputMask)==null?void 0:F.data,P=(q=m==null?void 0:m.outputMask)==null?void 0:q.width,x=(X=m==null?void 0:m.outputMask)==null?void 0:X.height;if(S&&typeof P=="number"&&typeof x=="number"){gt(c,S,P,x);return}c.width=1,c.height=1;const T=c.getContext("2d");T&&T.clearRect(0,0,c.width,c.height)}function U(m){if(!y)return;y.innerHTML="";const z=Array.isArray(m==null?void 0:m.stages)?m.stages:[];if(!z.length){y.appendChild(j("div",{class:"muted",style:"font-size:12px;"},"No stages."));return}const _=j("div",{style:"display:flex; flex-direction:column; gap:10px;"});for(const M of z)_.appendChild($(M));y.appendChild(_)}function $(m){const z=j("div",{class:"card",style:"padding:10px;"}),_=j("div",{class:"row",style:"align-items:center; justify-content:space-between;"});_.appendChild(j("div",{style:"font-weight:bold;"},String(m.title??m.stageId))),_.appendChild(j("div",{class:"status"},String(m.state??"idle"))),z.appendChild(_),z.appendChild(j("div",{class:"muted",style:"font-size:12px;"},`${m.input} -> ${m.output}`)),typeof m.error=="string"&&m.error.length>0&&z.appendChild(j("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Stage error: ${m.error}`));const M=m.outputArtifact;M&&z.appendChild(Mt(M,260));const O=Array.isArray(m.ops)?m.ops:[];if(O.length){const k=j("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:8px;"});for(let S=0;S<O.length;S++){const P=O[S],x=S===O.length-1,T=j("div",{class:"card",style:"padding:8px;"}),A=j("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),N={id:String(P.opId??""),title:String(P.title??P.opId??"Operation"),io:{input:P.input,output:P.output},group:P.group},R=Ze(N,{compact:!0,showGroup:!0,showId:!0,portStyle:"puzzle",cardStyle:"plain"});A.appendChild(R),A.appendChild(j("div",{class:"status"},String(P.state??"idle"))),T.appendChild(A),typeof P.error=="string"&&P.error.length>0&&T.appendChild(j("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Op error: ${P.error}`));const B=M&&x?void 0:P.outputArtifact;B&&T.appendChild(Mt(B,200)),k.appendChild(T)}z.appendChild(k)}return z}return{mount(){E()},render(m){var z,_,M,O,k;if(E(),b=m,I(m),i.textContent=typeof(m==null?void 0:m.statusText)=="string"?m.statusText:"Idle",u){const S=typeof(m==null?void 0:m.description)=="string"?m.description:"Universal pipeline runner.";u.textContent=S}if(g){const S=(z=m==null?void 0:m.outputPdf)==null?void 0:z.bytes,P=((S==null?void 0:S.byteLength)??0)>0,x=typeof((_=m==null?void 0:m.outputSvg)==null?void 0:_.svg)=="string"&&m.outputSvg.svg.length>0,T=!!((M=m==null?void 0:m.outputImage)!=null&&M.data),A=!!((O=m==null?void 0:m.outputMask)!=null&&O.data),N=typeof((k=m==null?void 0:m.outputImageList)==null?void 0:k.count)=="number"&&m.outputImageList.count>0;g.disabled=!(P||x||T||A||N)}D(m),L(m),U(m)},dispose(){o=!1,a=null,s=null,l=null,d=null,r=null,f=null,g=null,u=null,p=null,c=null,h=null,v=null,y=null,b=null,w()}}}function Me(e,t){return e.find(i=>i.id===t)??null}function re(e,t){return{input:e,output:t}}function Dt(e,t){return`${e}.${t+1}`}function ft(e){const t=[{kind:"dispatch",id:"op.seg.resize",title:"Resize",io:re("image","image"),dispatchId:"segmentation.resize",tuningId:"segmentation.resize",group:"Segmentation"},{kind:"dispatch",id:"op.seg.denoise",title:"Denoise",io:re("image","image"),dispatchId:"segmentation.denoise",tuningId:"segmentation.denoise",group:"Segmentation"},{kind:"dispatch",id:"op.seg.color",title:"Color / Gray",io:re("image","image"),dispatchId:"segmentation.color",tuningId:"segmentation.color",group:"Segmentation"},{kind:"dispatch",id:"op.seg.threshold",title:"Threshold",io:re("image","mask"),dispatchId:"segmentation.threshold",tuningId:"segmentation.threshold",group:"Segmentation"},{kind:"dispatch",id:"op.seg.morphology",title:"Morphology cleanup",io:re("mask","mask"),dispatchId:"segmentation.morphology",tuningId:"segmentation.morphology",group:"Segmentation"},{kind:"dispatch",id:"op.edge.resize",title:"Resize",io:re("image","image"),dispatchId:"edge.resize",tuningId:"edge.resize",group:"Edge"},{kind:"dispatch",id:"op.edge.threshold",title:"Threshold",io:re("image","mask"),dispatchId:"edge.threshold",tuningId:"edge.threshold",group:"Edge"},{kind:"dispatch",id:"op.edge.morphology",title:"Morphology cleanup",io:re("mask","mask"),dispatchId:"edge.morphology",tuningId:"edge.morphology",group:"Edge"},{kind:"dispatch",id:"op.edge.extract",title:"Edge extract",io:re("mask","mask"),dispatchId:"edge.extract",tuningId:"edge.extract",group:"Edge"},{kind:"dispatch",id:"op.svg.create",title:"Create SVG",io:re("mask","svg"),dispatchId:"svg.create",tuningId:"svg.create",group:"SVG"},{kind:"dispatch",id:"op.mage.clean.removeSmallComponents",title:"Remove small components",io:re("mask","mask"),dispatchId:"mage.clean.removeSmallComponents",tuningId:"mage.clean.removeSmallComponents",group:"Cleanup"},{kind:"js",id:"op.util.pass.image",title:"Pass-through (image)",io:re("image","image"),group:"Utility",run:({input:r})=>r},{kind:"js",id:"op.util.pass.mask",title:"Pass-through (mask)",io:re("mask","mask"),group:"Utility",run:({input:r})=>r}];function i(r){return Me(t,r)}function n(r,f){return f.map((g,u)=>({instanceId:Dt(r,u),opId:g,enabled:!0}))}const o=[{id:"segmentation",title:"Segmentation",implemented:!0,description:"Multi-step segmentation pipeline (image -> mask).",ops:n("segmentation",["op.seg.resize","op.seg.denoise","op.seg.color","op.seg.threshold","op.seg.morphology"])},{id:"edge",title:"Edge",implemented:!0,description:"Edge extraction pipeline (image -> mask -> edges).",ops:n("edge",["op.edge.resize","op.edge.threshold","op.edge.morphology","op.edge.extract"])},{id:"svg",title:"SVG",implemented:!0,description:"Image to SVG outline.",ops:n("svg",["op.edge.resize","op.edge.threshold","op.edge.morphology","op.edge.extract","op.svg.create"])},{id:"cleanup",title:"Cleanup (min area)",implemented:!0,description:"Image -> mask -> cleanup (morphology + remove small components).",ops:n("cleanup",["op.seg.resize","op.seg.threshold","op.seg.morphology","op.mage.clean.removeSmallComponents"])},{id:"surface",title:"Surface",implemented:!1,description:"Future: region labeling + vectorize pipeline.",ops:[]}],a=(e==null?void 0:e.userPipelines)??[];function s(r){return Me(o,r)}function l(r){return Me(a,r)??Me(o,r)}function d(){const r=new Set(a.map(g=>g.id));return[...o.filter(g=>!r.has(g.id)),...a]}return{ops:t,getOp:i,builtIns:o,getBuiltIn:s,listPipelines:d,getPipeline:l,createInstanceId:Dt}}const Ot=rn();function oo(){return{opencvReady:ve()}}function ao(e){const{implemented:t,policy:i,runtimeOpenCvReady:n}=e,o=n&&t.includes("opencv");return t.includes("native")||t.length,i==="native"?{engine:"native"}:i==="opencv"?o?{engine:"opencv"}:{engine:"native",fallbackReason:n?"Override policy=opencv, but this op has no OpenCV implementation.":"Override policy=opencv, but OpenCV is not available at runtime."}:i==="auto"?o?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}async function so(e,t){const i=await Le(),n=oo(),o=ln(e,Ot,i,n),a=Ot.byId.get(e);if(!a)throw new Error(`[opsDispatch] Unknown op in registry: ${e}`);const l={...o.params,...(t==null?void 0:t.params)??{}},d=t!=null&&t.enginePolicy&&t.enginePolicy!=="inherit"?t.enginePolicy:o.policy;let r=o.engine,f=o.fallbackReason;if(t!=null&&t.enginePolicy&&t.enginePolicy!=="inherit"){const g=ao({implemented:a.implementedEngines,policy:d,runtimeOpenCvReady:!!n.opencvReady});r=g.engine,f=g.fallbackReason}return{engine:r,params:l,fallbackReason:f,opencvReady:!!n.opencvReady}}async function ro(e,t,i,n){const{engine:o,params:a,fallbackReason:s,opencvReady:l}=await so(e,n);return o==="opencv"&&!l?(Ve(`OpenCV selected for ${e} but not ready; falling back to native. ${s??""}`.trim()),await i[e].native(t,a)):await i[e][o](t,a)}function De(e,t,i,n){if(!t||!i)return e;const o=Math.floor(Number(n.morphAlgo??2)),a=co(Math.floor(Number(n.morphIters??1)),1,20),s=Math.floor(Number(n.morphK??5)),l=lo(s),d=l-1>>1;if(o<=0||l<=1)return e;let r=e,f=new Uint8Array(t*i);for(let g=0;g<a;g++){if(o===1){Ut(r,f,t,i,d);const u=r;r=f,f=u;continue}if(o===2){Bt(r,f,t,i,d);const u=r;r=f,f=u;continue}Bt(r,f,t,i,d),r===e&&g===0&&(r=new Uint8Array(e)),Ut(f,r,t,i,d)}return r}function lo(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:5}function Bt(e,t,i,n,o){t.fill(0);for(let a=0;a<n;a++){const s=Math.max(0,a-o),l=Math.min(n-1,a+o);for(let d=0;d<i;d++){const r=Math.max(0,d-o),f=Math.min(i-1,d+o);let g=0;for(let u=s;u<=l&&!g;u++){let p=u*i+r;for(let c=r;c<=f;c++,p++)if(e[p]){g=1;break}}t[a*i+d]=g}}}function Ut(e,t,i,n,o){t.fill(0);for(let a=0;a<n;a++){const s=Math.max(0,a-o),l=Math.min(n-1,a+o);for(let d=0;d<i;d++){const r=Math.max(0,d-o),f=Math.min(i-1,d+o);let g=1;for(let u=s;u<=l&&g;u++){let p=u*i+r;for(let c=r;c<=f;c++,p++)if(!e[p]){g=0;break}}t[a*i+d]=g}}}function co(e,t,i){return e<t?t:e>i?i:e}function hn(e,t,i,n){const o=Math.max(0,Math.floor(Number(n??0)));if(!t||!i||o<=1)return e;const a=new Uint8Array(e),s=new Uint8Array(e.length),l=new Int32Array(e.length),d=new Int32Array(e.length);for(let r=0;r<i;r++)for(let f=0;f<t;f++){const g=r*t+f;if(e[g]===0||s[g]===1)continue;let u=0,p=0;s[g]=1,l[p]=f,d[p]=r,p++;const c=[g];for(;u<p;){const h=l[u],v=d[u];u++;const y=h-1,b=v,w=h+1,C=v,E=h,I=v-1,D=h,L=v+1;if(y>=0){const U=b*t+y;e[U]!==0&&s[U]===0&&(s[U]=1,l[p]=y,d[p]=b,p++,c.push(U))}if(w<t){const U=C*t+w;e[U]!==0&&s[U]===0&&(s[U]=1,l[p]=w,d[p]=C,p++,c.push(U))}if(I>=0){const U=I*t+E;e[U]!==0&&s[U]===0&&(s[U]=1,l[p]=E,d[p]=I,p++,c.push(U))}if(L<i){const U=L*t+D;e[U]!==0&&s[U]===0&&(s[U]=1,l[p]=D,d[p]=L,p++,c.push(U))}}if(c.length<o)for(let h=0;h<c.length;h++)a[c[h]]=0}return a}function po(){const e=globalThis;return e!=null&&e.cv&&typeof e.cv.Mat=="function"?e.cv:null}function uo(e,t){const{width:i,height:n}=e,o=Math.max(0,Math.floor(Number(t.cleanMinArea??0)));if(an("OpenCV removeSmallComponents params",{width:i,height:n,minArea:o}),!i||!n||o<=1)return e.mask;const a=po();if(!a)return hn(e.mask,i,n,o);const s=new a.Mat(n,i,a.CV_8UC1);try{const l=s.data,d=e.mask;for(let u=0;u<d.length;u++)l[u]=d[u]?255:0;const r=new a.Mat,f=new a.Mat,g=new a.Mat;try{const u=a.connectedComponentsWithStats(s,r,f,g,8,a.CV_32S),p=a.CC_STAT_AREA??4,c=new Array(u).fill(!1);for(let y=1;y<u;y++)f.intAt(y,p)<o&&(c[y]=!0);const h=new Uint8Array(i*n),v=r.data32S;for(let y=0;y<h.length;y++){const b=v[y];h[y]=b>0&&!c[b]?1:0}return h}finally{r.delete(),f.delete(),g.delete()}}finally{s.delete()}}function Oe(e,t,i,n){const o=Math.max(0,Math.min(255,Math.floor(Number(n.manualT??128)))),a=new Uint8Array(t*i),s=e.data;for(let l=0,d=0;l<a.length;l++,d+=4){const r=s[d],f=s[d+1],g=s[d+2],u=r*77+f*150+g*29>>8;a[l]=u>=o?1:0}return a}function Be(e,t,i,n){const o=Math.max(1,Math.floor(Number(n.targetMaxW??t)));if(!t||!i||t<=o)return e;const a=o/t,s=Math.max(1,Math.floor(t*a)),l=Math.max(1,Math.floor(i*a));return Math.floor(Number(n.resizeAlgo??1))===0?go(e,t,i,s,l):fo(e,t,i,s,l)}function go(e,t,i,n,o){const a=e.data,s=new Uint8ClampedArray(n*o*4),l=t/n,d=i/o;for(let r=0;r<o;r++){const f=Math.min(i-1,Math.max(0,Math.floor((r+.5)*d-.5)));for(let g=0;g<n;g++){const u=Math.min(t-1,Math.max(0,Math.floor((g+.5)*l-.5))),p=(f*t+u)*4,c=(r*n+g)*4;s[c]=a[p],s[c+1]=a[p+1],s[c+2]=a[p+2],s[c+3]=a[p+3]}}return new ImageData(s,n,o)}function fo(e,t,i,n,o){const a=e.data,s=new Uint8ClampedArray(n*o*4),l=t/n,d=i/o;for(let r=0;r<o;r++){const f=(r+.5)*d-.5,g=Ue(Math.floor(f),0,i-1),u=Ue(g+1,0,i-1),p=f-g;for(let c=0;c<n;c++){const h=(c+.5)*l-.5,v=Ue(Math.floor(h),0,t-1),y=Ue(v+1,0,t-1),b=h-v,w=(g*t+v)*4,C=(g*t+y)*4,E=(u*t+v)*4,I=(u*t+y)*4,D=(r*n+c)*4;for(let L=0;L<4;L++){const U=a[w+L],$=a[C+L],m=a[E+L],z=a[I+L],_=U+($-U)*b,M=m+(z-m)*b,O=_+(M-_)*p;s[D+L]=ho(O)}}}return new ImageData(s,n,o)}function Ue(e,t,i){return e<t?t:e>i?i:e}function ho(e){return e<=0?0:e>=255?255:e|0}function zt(e,t,i,n){if(!t||!i)return e;const o=Math.floor(Number(n.denoiseAlgo??1));if(o<=0)return e;const a=Math.floor(Number(n.blurK??3)),s=mo(a);return o===2&&s<=3?bo(e,t,i):s<=1?e:yo(e,t,i,s)}function mo(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:3}function yo(e,t,i,n){const o=n-1>>1,a=e.data,s=new Uint8ClampedArray(t*i*4);for(let d=0;d<i;d++){let r=0,f=0,g=0,u=0;for(let p=-o;p<=o;p++){const c=we(p,0,t-1),h=(d*t+c)*4;r+=a[h],f+=a[h+1],g+=a[h+2],u+=a[h+3]}for(let p=0;p<t;p++){const c=(d*t+p)*4;s[c]=r/n|0,s[c+1]=f/n|0,s[c+2]=g/n|0,s[c+3]=u/n|0;const h=we(p-o,0,t-1),v=we(p+o+1,0,t-1),y=(d*t+h)*4,b=(d*t+v)*4;r+=a[b]-a[y],f+=a[b+1]-a[y+1],g+=a[b+2]-a[y+2],u+=a[b+3]-a[y+3]}}const l=new Uint8ClampedArray(t*i*4);for(let d=0;d<t;d++){let r=0,f=0,g=0,u=0;for(let p=-o;p<=o;p++){const h=(we(p,0,i-1)*t+d)*4;r+=s[h],f+=s[h+1],g+=s[h+2],u+=s[h+3]}for(let p=0;p<i;p++){const c=(p*t+d)*4;l[c]=r/n|0,l[c+1]=f/n|0,l[c+2]=g/n|0,l[c+3]=u/n|0;const h=we(p-o,0,i-1),v=we(p+o+1,0,i-1),y=(h*t+d)*4,b=(v*t+d)*4;r+=s[b]-s[y],f+=s[b+1]-s[y+1],g+=s[b+2]-s[y+2],u+=s[b+3]-s[y+3]}}return new ImageData(l,t,i)}function bo(e,t,i){const n=e.data,o=new Uint8ClampedArray(t*i*4),a=new Array(9),s=new Array(9),l=new Array(9),d=new Array(9);for(let r=0;r<i;r++)for(let f=0;f<t;f++){let g=0;for(let p=-1;p<=1;p++){const c=we(r+p,0,i-1);for(let h=-1;h<=1;h++){const v=we(f+h,0,t-1),y=(c*t+v)*4;a[g]=n[y],s[g]=n[y+1],l[g]=n[y+2],d[g]=n[y+3],g++}}a.sort(ze),s.sort(ze),l.sort(ze),d.sort(ze);const u=(r*t+f)*4;o[u]=a[4]|0,o[u+1]=s[4]|0,o[u+2]=l[4]|0,o[u+3]=d[4]|0}return new ImageData(o,t,i)}function ze(e,t){return e-t}function we(e,t,i){return e<t?t:e>i?i:e}function Vt(e,t,i,n){if(!t||!i)return e;const o=Math.floor(Number(n.colorMode??1));if(o===0)return e;const a=e.data,s=new Uint8ClampedArray(t*i*4),l=wo(Math.floor(Number(n.hsvChannel??2)),0,2);for(let d=0,r=0;d<t*i;d++,r+=4){const f=a[r],g=a[r+1],u=a[r+2],p=a[r+3];let c=0;if(o===1)c=f*77+g*150+u*29>>8;else if(o===2){const h=vo(f,g,u),v=l===0?h.h:l===1?h.s:h.v;c=Co(v*255)}else c=255-(f*77+g*150+u*29>>8);s[r]=c,s[r+1]=c,s[r+2]=c,s[r+3]=p}return new ImageData(s,t,i)}function vo(e,t,i){const n=e/255,o=t/255,a=i/255,s=Math.max(n,o,a),l=Math.min(n,o,a),d=s-l;let r=0;d!==0&&(s===n?r=(o-a)/d%6:s===o?r=(a-n)/d+2:r=(n-o)/d+4,r/=6,r<0&&(r+=1));const f=s===0?0:d/s;return{h:r,s:f,v:s}}function wo(e,t,i){return e<t?t:e>i?i:e}function Co(e){return e<=0?0:e>=255?255:e|0}function Nt(e,t,i){const n=new Uint8Array(e.length),o=(a,s)=>s*t+a;for(let a=0;a<i;a++)for(let s=0;s<t;s++){const l=o(s,a);if(e[l]===0)continue;if(s===0||a===0||s===t-1||a===i-1){n[l]=255;continue}const r=e[o(s-1,a)],f=e[o(s+1,a)],g=e[o(s,a-1)],u=e[o(s,a+1)];(r===0||f===0||g===0||u===0)&&(n[l]=255)}return n}function _t(e,t,i,n){const o=Math.max(1,Math.floor(n.scale||1)),a=t*o,s=i*o,l=o;let d="";for(let u=0;u<i;u++){const p=u*t;for(let c=0;c<t;c++){if(e[p+c]===0)continue;const v=c*l,y=u*l;d+=`M${v} ${y}h${l}v${l}h-${l}Z`}}const r=n.transparentBg?"":`<rect x="0" y="0" width="${a}" height="${s}" fill="white"/>`,f=n.color||"#000",g=d.length>0?`<path d="${d}" fill="${f}" stroke="none"/>`:"";return`<svg xmlns="http://www.w3.org/2000/svg" width="${a}" height="${s}" viewBox="0 0 ${a} ${s}">`+r+g+"</svg>"}const Eo="demo",ko={"mage.clean.removeSmallComponents":{native:(e,t)=>hn(e.mask,e.width,e.height,t.cleanMinArea),opencv:(e,t)=>(H("OpenCV removeSmallComponents called (demo).",{width:e.width,height:e.height,cleanMinArea:t.cleanMinArea}),uo(e,t))},"segmentation.resize":{native:(e,t)=>(H("[demo op] segmentation.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),Be(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(H("[demo op] segmentation.resize opencv",{width:e.width,height:e.height}),Be(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"segmentation.denoise":{native:(e,t)=>(H("[demo op] segmentation.denoise native",{width:e.width,height:e.height,denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}),zt(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma})),opencv:(e,t)=>(H("[demo op] segmentation.denoise opencv",{width:e.width,height:e.height}),zt(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}))},"segmentation.color":{native:(e,t)=>(H("[demo op] segmentation.color native",{width:e.width,height:e.height,colorMode:t.colorMode,hsvChannel:t.hsvChannel}),Vt(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel})),opencv:(e,t)=>(H("[demo op] segmentation.color opencv",{width:e.width,height:e.height}),Vt(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel}))},"segmentation.threshold":{native:(e,t)=>(H("[demo op] segmentation.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),Oe(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(H("[demo op] segmentation.threshold opencv",{width:e.width,height:e.height}),Oe(e.image,e.width,e.height,{manualT:t.manualT}))},"segmentation.morphology":{native:(e,t)=>(H("[demo op] segmentation.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),De(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(H("[demo op] segmentation.morphology opencv",{width:e.width,height:e.height}),De(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.resize":{native:(e,t)=>(H("[demo op] edge.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),Be(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(H("[demo op] edge.resize opencv",{width:e.width,height:e.height}),Be(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"edge.threshold":{native:(e,t)=>(H("[demo op] edge.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),Oe(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(H("[demo op] edge.threshold opencv",{width:e.width,height:e.height}),Oe(e.image,e.width,e.height,{manualT:t.manualT}))},"edge.morphology":{native:(e,t)=>(H("[demo op] edge.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),De(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(H("[demo op] edge.morphology opencv",{width:e.width,height:e.height}),De(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.extract":{native:(e,t)=>(H("[demo op] edge.extract native",{width:e.width,height:e.height}),Nt(e.mask,e.width,e.height)),opencv:(e,t)=>(H("[demo op] edge.extract opencv",{width:e.width,height:e.height}),Nt(e.mask,e.width,e.height))},"svg.create":{native:(e,t)=>(H("[demo op] svg.create native",{width:e.width,height:e.height,scale:t.scale}),_t(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color})),opencv:(e,t)=>(H("[demo op] svg.create opencv",{width:e.width,height:e.height,scale:t.scale}),_t(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color}))}};async function Ce(e,t,i){return an("[opsDispatch] runOp",{op:e,implSource:Eo,inputKeys:t&&typeof t=="object"?Object.keys(t):typeof t,override:i?{enginePolicy:i.enginePolicy,paramsKeys:Object.keys(i.params??{})}:null}),ro(e,t,ko,i)}async function Io(e,t){return Ce(e,t)}const xo=Object.freeze(Object.defineProperty({__proto__:null,runMaskOp:Io,runOp:Ce},Symbol.toStringTag,{value:"Module"}));function So(e){return e.type==="image"||e.type==="mask"||e.type==="svg"?{width:e.width,height:e.height}:null}function Po(e){const{catalogue:t,pipeline:i}=e,n=(i.ops??[]).filter(a=>a.enabled!==!1),o=[];for(const a of n){const s=t.getOp(a.opId);if(!s)return{enabledInstances:[],specs:[],error:`Unknown opId in pipeline: ${a.opId}`};o.push(s)}return{enabledInstances:n,specs:o}}function $o(e){const{specs:t,instances:i,startType:n}=e;if(t.length===0)return{ok:!0,startType:n,endType:n,steps:[]};if(i.length!==t.length)return{ok:!1,startType:n,error:`Typing internal mismatch: instances(${i.length}) != specs(${t.length})`,steps:[]};let o=n;const a=[];for(let s=0;s<t.length;s++){const l=t[s],d=i[s],r=l.io.input,f=r===o,g=f?void 0:`Chain IO mismatch at "${l.title}" (${l.id}): needs ${r} but current is ${o}`;if(a.push({index:s,instanceId:d.instanceId,opId:l.id,title:l.title,expectedInput:r,actualInput:o,output:l.io.output,ok:f,error:g}),!f)return{ok:!1,startType:n,error:g,steps:a};o=l.io.output}return{ok:!0,startType:n,endType:o,steps:a}}function jt(e){const{specs:t,startType:i,index:n}=e;if(n<=0||t.length===0)return i;let o=i;for(let a=0;a<Math.min(n,t.length);a++){const s=t[a];if(s.io.input!==o)return o;o=s.io.output}return o}function Ao(e){const{beforeType:t,afterType:i,op:n}=e;return n.io.input!==t?{ok:!1,reason:`Needs ${n.io.input} but slot provides ${t}`}:i&&n.io.output!==i?{ok:!1,reason:`Produces ${n.io.output} but next op needs ${i}`}:{ok:!0}}function To(e){return e.type==="image"}function Lo(e){return e.type==="mask"}function Ro(e){return{type:"image",width:e.width,height:e.height,image:e}}function Ft(e,t,i){return{type:"mask",width:t,height:i,mask:e}}function Gt(e,t,i){return{type:"svg",width:t,height:i,svg:e}}function Je(e,t){return`IO mismatch: expected ${e}, got ${t}`}async function Mo(e,t,i){const n=t.override;if(e.io.input!=="image"&&e.io.input!=="mask")throw new Error(`Dispatch op does not support input type: ${e.io.input}`);if(e.io.input==="image"){if(!To(i))throw new Error(Je("image",i.type));const{width:s,height:l}=i;if(e.io.output==="image"){const d=await Ce(e.dispatchId,{image:i.image,width:s,height:l},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return Ro(d)}if(e.io.output==="mask"){const d=await Ce(e.dispatchId,{image:i.image,width:s,height:l},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return Ft(d,s,l)}if(e.io.output==="svg"){const d=await Ce(e.dispatchId,{image:i.image,width:s,height:l},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return Gt(d,s,l)}throw new Error(`Unsupported dispatch output: ${e.io.output}`)}if(!Lo(i))throw new Error(Je("mask",i.type));const{width:o,height:a}=i;if(e.io.output==="mask"){const s=await Ce(e.dispatchId,{mask:i.mask,width:o,height:a},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return Ft(s,o,a)}if(e.io.output==="svg"){const s=await Ce(e.dispatchId,{mask:i.mask,width:o,height:a},n?{enginePolicy:n.enginePolicy,params:n.params}:void 0);return Gt(s,o,a)}throw new Error(`Invalid op spec: mask input cannot produce ${e.io.output} (unsupported here)`)}async function Do(e,t,i,n){var l;if(e.kind==="dispatch")return await Mo(e,t,i);const a={...e.tuningId?await n.getEffectiveParams(e.tuningId).catch(()=>({})):{},...((l=t.override)==null?void 0:l.params)??{}};return await e.run({input:i,params:a})}async function Oo(e){const{catalogue:t,pipeline:i,input:n,deps:o}=e;if(!i.implemented)return{pipelineId:i.id,title:i.title,status:"error",error:"Not implemented yet",input:n,ops:[]};const a=Po({catalogue:t,pipeline:i});if(a.error)return{pipelineId:i.id,title:i.title,status:"error",error:a.error,input:n,ops:[]};const s=a.enabledInstances,l=a.specs,d=$o({specs:l,instances:s,startType:n.type});if(!d.ok)return o.debug("pipeline validation failed (linear)",{pipelineId:i.id,error:d.error}),{pipelineId:i.id,title:i.title,status:"error",error:d.error??"Invalid pipeline typing",input:n,ops:s.map((g,u)=>{var p,c;return{instanceId:g.instanceId,opId:g.opId,title:((p=l[u])==null?void 0:p.title)??g.opId,io:((c=l[u])==null?void 0:c.io)??{input:n.type,output:n.type},status:"error",error:d.error??"Invalid pipeline typing"}})};const r=[];let f=n;for(let g=0;g<l.length;g++){const u=s[g],p=l[g];try{if(p.io.input!==f.type)throw new Error(Je(p.io.input,f.type));const c=await Do(p,u,f,o);if(c.type!==p.io.output)throw new Error(Je(p.io.output,c.type));r.push({instanceId:u.instanceId,opId:p.id,title:p.title,io:p.io,status:"ok",output:c}),f=c}catch(c){const h=c instanceof Error?c.message:String(c);r.push({instanceId:u.instanceId,opId:p.id,title:p.title,io:p.io,status:"error",error:h});const v=So(f);return o.debug("pipeline op failed (linear)",{pipelineId:i.id,opId:p.id,error:h,...v??{},currentType:f.type}),{pipelineId:i.id,title:i.title,status:"error",error:`Op "${p.title}" failed: ${h}`,input:n,ops:r}}}return{pipelineId:i.id,title:i.title,status:"ok",input:n,output:f,ops:r}}const ht="beemage.pipeline.userPipelines.v1";async function Ie(){const e=await ge([ht]).catch(()=>({})),t=e==null?void 0:e[ht];if(!Array.isArray(t))return[];const i=[];for(const n of t)!n||typeof n!="object"||typeof n.id=="string"&&Array.isArray(n.ops)&&i.push(n);return i}async function qe(e){await fe({[ht]:e}).catch(()=>null)}async function Bo(e){const t=await Ie(),i=t.findIndex(n=>n.id===e.id);if(i>=0){const n=t.slice();n[i]=e,await qe(n);return}await qe([...t,e])}async function Uo(e){const i=(await Ie()).filter(n=>n.id!==e);await qe(i)}const mt="beemage.pipeline.recipes.v1";function zo(){return Date.now()}function mn(){return{recipesById:{}}}async function Ee(){const e=await ge([mt]).catch(()=>({})),t=e==null?void 0:e[mt];return!t||typeof t!="object"?{}:t}async function Re(e){await fe({[mt]:e}).catch(()=>null)}async function Vo(e,t){const i=await Ee(),n=i[e]??mn();n.selectedRecipeId=t,i[e]=n,await Re(i)}async function No(e,t){const i=await Ee(),n=i[e]??mn();n.recipesById[t.id]={...t,updatedTs:zo()},n.selectedRecipeId||(n.selectedRecipeId=t.id),i[e]=n,await Re(i)}async function _o(e,t){const i=await Ee(),n=i[e];if(n){if(delete n.recipesById[t],n.selectedRecipeId===t){const o=Object.keys(n.recipesById);n.selectedRecipeId=o.length?o[0]:void 0}i[e]=n,await Re(i)}}function jo(e){const t=[];for(const[i,n]of Object.entries(e??{})){const o=Object.values(n.recipesById??{});t.push({pipelineId:i,selectedRecipeId:n.selectedRecipeId,recipes:o})}return t.sort((i,n)=>i.pipelineId.localeCompare(n.pipelineId)),t}function Fo(e){if(!Array.isArray(e))return{};const t={};for(const i of e){if(!i||typeof i!="object")continue;const n=i.pipelineId;if(typeof n!="string"||!n)continue;const o=i.selectedRecipeId,a=i.recipes,s={};if(Array.isArray(a))for(const l of a){if(!l||typeof l!="object")continue;const d=l.id,r=l.title,f=l.updatedTs,g=l.ops;typeof d!="string"||!d||typeof r!="string"||!r||typeof f=="number"&&Array.isArray(g)&&(s[d]=l)}t[n]={selectedRecipeId:typeof o=="string"?o:void 0,recipesById:s}}return t}function Go(e){return e.type==="image"}function Ko(e){return e.type==="mask"}function Ho(e){return e.type==="svg"}function Wo(e){return e.type==="imageList"}function Jo(e){return e.type==="pdf"}function qo(e){var z,_,M,O;let t=ft({userPipelines:[]}),i={},o=((M=(_=(z=t.listPipelines)==null?void 0:z.call(t))==null?void 0:_[0])==null?void 0:M.id)??((O=t.builtIns[0])==null?void 0:O.id)??"segmentation",a="default",s=null,l="Idle",d=null,r=[],f=0,g=null;async function u(){var R,B,K,V,F;const k=o,S=a,P=await Ie().catch(()=>[]);t=ft({userPipelines:P}),i=await Ee().catch(()=>({}));const x=((R=t.listPipelines)==null?void 0:R.call(t))??t.builtIns;x.some(q=>q.id===o)||(o=((B=x[0])==null?void 0:B.id)??"segmentation",a="default");const A=((K=t.getPipeline)==null?void 0:K.call(t,o))??((F=(V=t.listPipelines)==null?void 0:V.call(t))==null?void 0:F[0]);if(A&&c(A).some(Z=>Z.id===a)||(a="default"),k!==o||S!==a){v();return}r=[],f=0}function p(){var S,P,x;const k=((S=t.getPipeline)==null?void 0:S.call(t,o))??((x=(P=t.listPipelines)==null?void 0:P.call(t))==null?void 0:x[0]);if(!k)throw new Error("[pipeline] No pipelines available.");return k}function c(k){const S={id:"default",title:"Default",buildPipeline:A=>A},P=i==null?void 0:i[k.id],x=(P==null?void 0:P.recipesById)??{},T=[S];for(const A of Object.keys(x)){const N=x[A];!N||typeof N.id!="string"||T.push({id:String(N.id),title:typeof N.title=="string"&&N.title.trim().length?N.title:String(N.id),buildPipeline:R=>{const B=Array.isArray(N.ops)?N.ops:null;if(!B)return R;const K=B.filter(V=>V&&typeof V=="object").map(V=>({instanceId:typeof V.instanceId=="string"?V.instanceId:String(V.instanceId??""),opId:typeof V.opId=="string"?V.opId:String(V.opId??""),enabled:V.enabled===void 0?!0:!!V.enabled})).filter(V=>V.instanceId&&V.opId);return K.length?{...R,ops:K}:R}})}return T.slice(0,1).concat(T.slice(1).sort((A,N)=>String(A.title).localeCompare(String(N.title))))}function h(){const k=p(),S=c(k),P=S.find(x=>x.id===a)??S[0];return a=P.id,P.buildPipeline(k)}function v(){l=h().implemented?"Ready":"Not implemented yet",d=null,r=[],f=0,g=null}function y(){v()}function b(k){var P,x;k===o||!(((P=t.getPipeline)==null?void 0:P.call(t,k))??((x=t.getBuiltIn)==null?void 0:x.call(t,k)))||(o=k,a="default",y())}function w(k){if(k===a)return;const S=p();a=c(S).some(T=>T.id===k)?k:"default",y()}function C(k){s=k,v()}function E(k){C({type:"image",width:k.width,height:k.height,image:k})}function I(k){const S=k.ops.filter(x=>x.enabled!==!1),P=[];for(let x=0;x<S.length;x++){const T=S[x],A=t.getOp(T.opId);A&&P.push({index0:x,instanceId:T.instanceId,inst:T,opSpec:A})}return P}function D(k){var T;const S=k.ops.map(A=>({instanceId:A.instanceId,opId:A.opId,title:A.title,input:A.io.input,output:A.io.output,state:A.status==="ok"?"ok":A.status==="error"?"error":"idle",error:A.error,outputArtifact:A.output})),P=k.status==="ok"?"ok":"error",x=k.output??((T=S.slice().reverse().find(A=>A.outputArtifact))==null?void 0:T.outputArtifact);return[{stageId:"pipeline",title:"Pipeline",input:k.input.type,output:(x==null?void 0:x.type)??k.input.type,ops:S,state:P,error:k.error,outputArtifact:x}]}function L(k,S){if(k.outputImage=void 0,k.outputMask=void 0,k.outputSvg=void 0,k.outputImageList=void 0,k.outputPdf=void 0,!!S)if(Go(S))k.outputImage={width:S.width,height:S.height,data:S.image};else if(Ko(S))k.outputMask={width:S.width,height:S.height,data:S.mask};else if(Ho(S))k.outputSvg={width:S.width,height:S.height,svg:S.svg};else if(Wo(S)){const P=S.items[0];k.outputImageList={count:S.items.length,first:P?{width:P.width,height:P.height,data:P.image}:void 0}}else Jo(S)&&(k.outputPdf={bytes:S.bytes,filenameHint:S.filenameHint})}async function U(){const k=h();if(!k.implemented){l="Not implemented yet";return}if(!s){l="No input";return}l="Running all…";const S=await Oo({catalogue:t,pipeline:k,input:s,deps:e.runner});d=S,r=I(k),f=r.length,g=S.output??null,l=S.status==="ok"?"Done":S.error??"Error"}async function $(){var x;const k=h();if(!k.implemented){l="Not implemented yet";return}if(!s){l="No input";return}if(r.length===0&&(r=I(k),f=0,g=s,d={pipelineId:k.id,title:k.title,status:"ok",input:s,output:s,ops:[]}),f>=r.length){l="Done";return}const S=r[f],P=S.opSpec;g||(g=s);try{if(l=`Running: ${P.title}`,g.type!==P.io.input)throw new Error(`IO mismatch: expected ${P.io.input}, got ${g.type}`);const T=P.tuningId?await e.runner.getEffectiveParams(P.tuningId).catch(()=>({})):{};let A;if(P.kind==="dispatch"){const{runOp:B}=await Ln(async()=>{const{runOp:V}=await Promise.resolve().then(()=>xo);return{runOp:V}},void 0,import.meta.url),K=S.inst.override;if(g.type==="image"){const V=await B(P.dispatchId,{image:g.image,width:g.width,height:g.height},K?{enginePolicy:K.enginePolicy,params:{...T,...K.params??{}}}:{params:T});if(P.io.output==="image"){const F=V;A={type:"image",width:F.width,height:F.height,image:F}}else if(P.io.output==="mask")A={type:"mask",width:g.width,height:g.height,mask:V};else if(P.io.output==="svg")A={type:"svg",width:g.width,height:g.height,svg:V};else throw new Error(`Unsupported dispatch output: ${P.io.output}`)}else if(g.type==="mask"){const V=await B(P.dispatchId,{mask:g.mask,width:g.width,height:g.height},K?{enginePolicy:K.enginePolicy,params:{...T,...K.params??{}}}:{params:T});if(P.io.output==="mask")A={type:"mask",width:g.width,height:g.height,mask:V};else if(P.io.output==="svg")A={type:"svg",width:g.width,height:g.height,svg:V};else throw new Error(`Invalid dispatch output: ${P.io.output}`)}else throw new Error(`Dispatch ops cannot take ${g.type} input.`)}else{const B={...T,...((x=S.inst.override)==null?void 0:x.params)??{}};A=await P.run({input:g,params:B})}if(A.type!==P.io.output)throw new Error(`IO mismatch: expected ${P.io.output}, got ${A.type}`);const R=((d==null?void 0:d.ops)??[]).concat([{instanceId:S.instanceId,opId:P.id,title:P.title,io:P.io,status:"ok",output:A}]);d={pipelineId:k.id,title:k.title,status:"ok",input:s,output:A,ops:R},g=A,f+=1,l=f>=r.length?"Done":"Ready"}catch(T){const A=T instanceof Error?T.message:String(T);l=`Error: ${P.title} — ${A}`;const R=((d==null?void 0:d.ops)??[]).concat([{instanceId:S.instanceId,opId:P.id,title:P.title,io:P.io,status:"error",error:A}]);d={pipelineId:k.id,title:k.title,status:"error",error:A,input:s,ops:R},e.runner.debug("pipeline next-step failed",{pipelineId:k.id,recipeId:a,instanceId:S.instanceId,opId:P.id,error:A})}}function m(){var R;const k=p(),S=h(),P=c(k),A={pipelines:(((R=t.listPipelines)==null?void 0:R.call(t))??t.builtIns).map(B=>({id:B.id,title:B.title})),recipes:P.map(B=>({id:B.id,title:B.title})),activePipelineId:o,activeRecipeId:a,statusText:l,description:S.description,stages:d?D(d):[],inputArtifact:s??void 0,input:s&&s.type==="image"?{width:s.width,height:s.height,data:s.image}:void 0,nextIndex:f,totalOps:r.length||S.ops.filter(B=>B.enabled!==!1).length},N=(d==null?void 0:d.output)??g??null;return L(A,N),A}return y(),{getVm:m,setActivePipeline:b,setActiveRecipe:w,setInputImageData:E,setInputArtifact:C,runAll:U,runNext:$,reset:y,reloadCatalogue:u}}const yt=new Set;function Zo(e){return yt.add(e),()=>{yt.delete(e)}}function me(e){const t=Array.from(yt);for(const i of t)try{i(e)}catch{}}function Yo(e,t,i){const n=qo({runner:{getEffectiveParams:async x=>await i.getEffectiveParams(x).catch(()=>({})),debug:(x,T)=>ee({scope:"panel",kind:"debug",message:x,meta:T})}});let o=null,a=!1,s=null,l=null,d=null,r=!1;const f=[];function g(){d||(d=Zo(x=>{a&&(f.push(`${x.kind}:${x.reason}`),p())}))}function u(){d==null||d(),d=null}function p(){r||(r=!0,queueMicrotask(()=>{r=!1;const x=f.splice(0,f.length).join(",")||"unknown";c(x)}))}async function c(x){ee({scope:"panel",kind:"info",message:"Pipeline tab: auto reload catalogue",meta:{reason:x}});const T=n.getVm(),A=String(T.activePipelineId??""),N=String(T.activeRecipeId??"");try{await n.reloadCatalogue()}catch(V){const F=V instanceof Error?V.message:String(V);ee({scope:"panel",kind:"error",message:"Pipeline tab: auto reloadCatalogue failed",meta:{reason:x,error:F}}),G({scope:"panel",kind:"error",message:"Pipeline catalogue refresh failed (auto)."});return}const R=n.getVm(),B=String(R.activePipelineId??""),K=String(R.activeRecipeId??"");(A!==B||N!==K)&&(G({scope:"panel",kind:"info",message:`Pipeline selection updated due to storage change: ${A}/${N} → ${B}/${K}`}),i.setParamValue("pipeline","mode",B),i.setParamValue("pipeline","recipe",K)),C(),Pe(R),m()}async function h(){n.reset();const x=I();x&&n.setInputArtifact(x),Pe(n.getVm()),G({scope:"panel",kind:"info",message:"Pipeline reset (reseed from source)"});try{await n.reloadCatalogue()}catch(T){ee({scope:"panel",kind:"error",message:"Pipeline reset: reloadCatalogue() failed",meta:{error:T instanceof Error?T.message:String(T)}}),G({scope:"panel",kind:"error",message:"Pipeline reset: failed to reload pipeline catalogue from storage."})}try{await U()}catch(T){ee({scope:"panel",kind:"error",message:"Pipeline reset: syncPipelineFromTuning() failed",meta:{error:T instanceof Error?T.message:String(T)}}),C()}Pe(n.getVm()),m()}function v(){const x=n.getVm();if(!(x.stages.some(N=>N.state==="error")||String(x.statusText).toLowerCase().includes("error"))){l=null;return}const A=String(x.statusText||"Pipeline error");A!==l&&(l=A,G({scope:"panel",kind:"error",message:`Pipeline: ${A}`}))}function y(){e.pipelineTuningMountEl.innerHTML=""}function b(x){return[x,`pipeline.${x}`,"pipeline"]}function w(x){const T=b(x);if(s===T[0])return;y();let A=null,N=null;for(const R of T)try{i.mount({mountEl:e.pipelineTuningMountEl,scopeRootId:R}),A=R;break}catch(B){N=B,y()}if(!A){s=null,G({scope:"panel",kind:"info",message:`Pipeline tuning mount failed for "${x}" (no matching scope).`}),ee({scope:"panel",kind:"error",message:"Pipeline tuning mount failed (no candidate scopeRootId worked)",meta:{pipelineId:x,candidates:T,error:N instanceof Error?N.message:String(N)}});return}s=A,G({scope:"panel",kind:"info",message:`Pipeline tuning mount: pipelineId=${x}, scopeRootId=${A}`})}function C(){const x=n.getVm(),T=typeof x.activePipelineId=="string"?x.activePipelineId:"segmentation";w(T)}function E(x){return{type:"image",width:x.width,height:x.height,image:x}}function I(){const x=globalThis==null?void 0:globalThis.app__,T=x==null?void 0:x.input__;if(T&&typeof T=="object"){const V=String(T.kind??"");if(V==="image"){const F=T.image??T.data;if(F&&typeof F=="object"&&typeof F.width=="number"&&typeof F.height=="number")return E(F)}if(V==="imageList"){const F=T.images??T.items;if(Array.isArray(F)&&F.length>0){const q=F.filter(X=>X&&typeof X.width=="number"&&typeof X.height=="number").map(X=>E(X));if(q.length>0)return{type:"imageList",items:q}}}ee({scope:"panel",kind:"info",message:"Pipeline tab: app__.input__ present but unsupported/malformed; falling back to srcCanvas",meta:{kind:V}})}const A=e.srcCanvasEl,N=A.width,R=A.height;if(!N||!R)return null;const B=A.getContext("2d",{willReadFrequently:!0});if(!B)return null;const K=B.getImageData(0,0,N,R);return E(K)}function D(){if(n.getVm().input)return;const T=I();T&&n.setInputArtifact(T)}function L(){const x=I();x&&n.setInputArtifact(x)}async function U(){const x=await i.getEffectiveParams("pipeline").catch(()=>({})),T=x==null?void 0:x.mode,A=x==null?void 0:x.recipe,N=typeof T=="string"?T:"segmentation",R=typeof A=="string"?A:"default";n.setActivePipeline(N),n.setActiveRecipe(R),C()}function $(){return o||(G({scope:"panel",kind:"info",message:"Pipeline view: create + mount"}),o=io({hostEl:e.pipelineViewMountEl,statusEl:e.pipelineStatusEl,handlers:{onSelectPipeline:x=>{G({scope:"panel",kind:"info",message:`Pipeline select: ${x}`}),n.setActivePipeline(x),i.setParamValue("pipeline","mode",x),C(),m()},onSelectRecipe:x=>{G({scope:"panel",kind:"info",message:`Recipe select: ${x}`}),n.setActiveRecipe(x),i.setParamValue("pipeline","recipe",x),m()},onRunAll:()=>void z(),onNext:()=>void _(),onReset:()=>{h()}}}),o.mount(),C(),o)}function m(){$().render(n.getVm())}async function z(){G({scope:"panel",kind:"info",message:"Pipeline run: all"}),L();try{await n.runAll()}finally{Pe(n.getVm()),m(),v()}}async function _(){G({scope:"panel",kind:"info",message:"Pipeline run: next"}),D();try{await n.runNext()}finally{Pe(n.getVm()),m(),v()}}function M(){}async function O(){a=!0,G({scope:"panel",kind:"info",message:"Pipeline tab: mount()"}),L(),await n.reloadCatalogue().catch(()=>null),await U(),g(),G({scope:"panel",kind:"info",message:"Pipeline tab: render()"}),m()}async function k(){a&&(G({scope:"panel",kind:"info",message:"Pipeline tab: refresh()"}),L(),await n.reloadCatalogue().catch(()=>null),await U(),m())}function S(){a=!1,u(),G({scope:"panel",kind:"info",message:"Pipeline tab: unmount()"})}function P(){G({scope:"panel",kind:"info",message:"Pipeline tab: dispose()"}),u(),o==null||o.dispose(),o=null,s=null,y()}return{bind:M,mount:O,unmount:S,refresh:k,dispose:P}}function bt(e){return!!e&&typeof e=="object"}function Xo(e){if(!bt(e)||typeof e.id!="string"||!e.id||typeof e.title!="string"||!e.title||typeof e.implemented!="boolean"||!Array.isArray(e.ops))return!1;for(const t of e.ops)if(!bt(t)||typeof t.instanceId!="string"||!t.instanceId||typeof t.opId!="string"||!t.opId||t.enabled!==void 0&&typeof t.enabled!="boolean")return!1;return!0}function Qo(){const e=ft({userPipelines:[]});async function t(){return await Ie().catch(()=>[])}function i(){return e.ops}async function n(){return await Ee().catch(()=>({}))}async function o(u){await Uo(u).catch(()=>null),me({kind:"userPipelines",reason:"delete",pipelineId:u})}async function a(u){await Bo(u).catch(()=>null),me({kind:"userPipelines",reason:"upsert",pipelineId:u.id})}async function s(u){const p=await Ee().catch(()=>({}));!p||typeof p!="object"||(delete p[u],await Re(p).catch(()=>null),me({kind:"recipes",reason:"deleteAllForPipeline",pipelineId:u}))}async function l(u,p){await Vo(u,p).catch(()=>null),me({kind:"recipes",reason:"select",pipelineId:u,recipeId:p})}async function d(u,p){await No(u,p).catch(()=>null),me({kind:"recipes",reason:"upsert",pipelineId:u,recipeId:p.id})}async function r(u,p){await _o(u,p).catch(()=>null),me({kind:"recipes",reason:"delete",pipelineId:u,recipeId:p})}async function f(u){let p;try{p=JSON.parse(u)}catch{throw new Error("Invalid JSON (parse failed).")}let c,h;if(Array.isArray(p))c=p;else if(bt(p)&&Array.isArray(p.pipelines))c=p.pipelines,h=p.recipes;else throw new Error('Invalid file shape. Expected {"pipelines":[...]} or an array of pipelines.');const v=c,y=v.length,b=[];let w=0;for(const I of v){if(!Xo(I)){w++;continue}b.push(I)}if(b.length===0)throw new Error("No valid pipelines found in the imported file.");const C=await Ie().catch(()=>[]),E=new Map;for(const I of C)E.set(I.id,I);for(const I of b)E.set(I.id,I);if(await qe(Array.from(E.values())),me({kind:"userPipelines",reason:"import"}),h!==void 0){if(!Array.isArray(h))throw new Error('Invalid "recipes" shape. Expected an array (or omit the field).');const I=Fo(h);await Re(I).catch(()=>null),me({kind:"recipes",reason:"import"})}return{imported:b.length,skipped:w,totalInFile:y}}async function g(){const u=await Ie().catch(()=>[]),p=await Ee().catch(()=>({})),c={format:"beemage.pipeline.userPipelines.v2",exportedAt:new Date().toISOString(),pipelines:u,recipes:jo(p)};return JSON.stringify(c,null,2)}return{listUserPipelines:t,listOperations:i,importFromJsonText:f,exportToJsonText:g,listAllRecipes:n,deleteUserPipelineById:o,upsertUserPipeline:a,setSelectedRecipe:l,upsertRecipe:d,deleteRecipe:r,deleteAllRecipesForPipeline:s}}function de(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function ea(e){return e.enabled!==!1}function ta(e){const t=new Map;for(const i of e)t.set(i.id,i);return t}function na(e,t,i){const n={compactOps:i==null?void 0:i.compactOps},o=ta(t),a=de("div",{class:"pipelineCard"}),s=de("div",{class:"pipelineCardHead"}),l=de("div",{style:"display:flex; flex-direction:column; gap:2px;"});l.appendChild(de("div",{class:"pipelineCardTitle"},e.title||e.id)),s.appendChild(l);{const g=e.implemented?"implemented":"not implemented";s.appendChild(de("div",{class:"status"},g))}a.appendChild(s);const d=de("div",{class:"pipelineOps",style:"margin-top:10px;"}),f=Array.isArray(e.ops)?e.ops:[];if(!f.length)return d.appendChild(de("div",{class:"muted",style:"font-size:12px;"},"No operations in this pipeline.")),a.appendChild(d),a;for(let g=0;g<f.length;g++){const u=f[g],p=o.get(u.opId),c=!ea(u),h=p?Ze(p,{compact:n.compactOps,showGroup:!0,showId:!0}):de("div",{class:"opCard opCard--unknown",style:"padding:10px;"},`Unknown operation: ${u.opId}`);c&&h.classList.add("is-disabled"),d.appendChild(h),g<f.length-1&&d.appendChild(de("div",{class:"pipelineConnector","aria-hidden":"true"}))}return a.appendChild(d),a}function le(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function ia(e){return JSON.parse(e)}function oa(e){const{pipelineId:t,instanceIds:i,selectedRecipeId:n,recipes:o,handlers:a}=e,s=le("div",{class:"card",style:"padding:10px; margin-top:8px;"});s.appendChild(le("div",{class:"cardTitle"},"Recipes"));const l=le("div",{class:"row",style:"gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px;"});s.appendChild(l);const d=le("label",{class:"fieldInline"});d.appendChild(le("span",{},"Selected"));const r=le("select"),f=le("option");f.value="",f.textContent="None",r.appendChild(f);for(const b of o){const w=le("option");w.value=b.id,w.textContent=`${b.title} (${b.id})`,r.appendChild(w)}r.value=n??"",r.addEventListener("change",()=>{const b=r.value;b&&a.onSelectRecipe(t,b)}),d.appendChild(r),l.appendChild(d);const g=le("button",{class:"btn",type:"button"},"New recipe"),u=le("button",{class:"btn",type:"button"},"Edit recipe"),p=le("button",{class:"btn",type:"button"},"Delete recipe");l.appendChild(g),l.appendChild(u),l.appendChild(p);const c=le("div",{class:"muted",style:"font-size:12px; margin-top:8px;"},`Recipes store only deltas per instanceId. Valid instanceIds: ${i.join(", ")||"(none)"}`);s.appendChild(c);function h(){const b=window.prompt("New recipe id (unique within this pipeline):","new");if(!b)return;const w=window.prompt("Recipe title:",b);w&&a.onUpsertRecipe(t,{id:b,title:w,ops:[]})}function v(){const b=(n??r.value)||"";if(!b){window.alert("Select a recipe first.");return}const w=o.find(I=>I.id===b);if(!w){window.alert("Recipe not found.");return}const C={id:w.id,title:w.title,ops:w.ops},E=window.prompt(`Edit recipe JSON (pipeline=${t}).

Structure: { id, title, ops: [{ instanceId, enabled?, override?: { enginePolicy?, params? } }] }

`,JSON.stringify(C,null,2));if(E)try{const I=ia(E);if(typeof I.id!="string"||!I.id)throw new Error("Missing recipe.id");if(typeof I.title!="string"||!I.title)throw new Error("Missing recipe.title");if(!Array.isArray(I.ops))throw new Error("Missing recipe.ops array");for(const D of I.ops){if(!D||typeof D!="object")throw new Error("Invalid patch object in ops");if(typeof D.instanceId!="string"||!D.instanceId)throw new Error("Patch missing instanceId");i.length&&!i.includes(D.instanceId)&&console.warn("Recipe patch references unknown instanceId",t,D.instanceId)}a.onUpsertRecipe(t,{id:I.id,title:I.title,ops:I.ops})}catch(I){const D=I instanceof Error?I.message:String(I);window.alert(`Invalid recipe JSON: ${D}`)}}function y(){const b=(n??r.value)||"";if(!b){window.alert("Select a recipe first.");return}window.confirm(`Delete recipe "${b}" from pipeline "${t}"?`)&&a.onDeleteRecipe(t,b)}return g.addEventListener("click",h),u.addEventListener("click",v),p.addEventListener("click",y),o.length||(u.disabled=!0,p.disabled=!0),s}function ye(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function aa(e){return JSON.parse(e)}function sa(e){const{pipeline:t,opsLibrary:i,selectedRecipeId:n,recipes:o,handlers:a}=e,s=ye("div",{class:"card",style:"padding:10px; margin-top:10px;"}),l=ye("div",{class:"row",style:"justify-content:space-between; align-items:center; gap:10px;"}),d=ye("div",{class:"cardTitle"},`${t.title} (${t.id})`);l.appendChild(d);const r=ye("div",{class:"row",style:"gap:8px; align-items:center;"}),f=ye("button",{class:"btn",type:"button"},"Edit"),g=ye("button",{class:"btn",type:"button"},"Delete");r.appendChild(f),r.appendChild(g),l.appendChild(r),s.appendChild(l),t.description&&s.appendChild(ye("div",{class:"muted",style:"font-size:12px; margin-top:6px;"},t.description));const u=ye("div",{style:"margin-top:10px;"});u.appendChild(na(t,i,{compactOps:!0})),s.appendChild(u);const p=t.ops.map(v=>v.instanceId);s.appendChild(oa({pipelineId:t.id,instanceIds:p,selectedRecipeId:n,recipes:o,handlers:a}));function c(){const v={id:t.id,title:t.title,description:t.description??"",implemented:t.implemented,ops:t.ops},y=window.prompt(`Edit pipeline JSON.

Structure: { id, title, description?, implemented, ops: [{ instanceId, opId, enabled?, override? }] }

`,JSON.stringify(v,null,2));if(y)try{const b=aa(y);if(!b||typeof b!="object")throw new Error("Invalid JSON object");if(typeof b.id!="string"||!b.id)throw new Error("Missing pipeline.id");if(typeof b.title!="string"||!b.title)throw new Error("Missing pipeline.title");if(typeof b.implemented!="boolean")throw new Error("Missing pipeline.implemented boolean");if(!Array.isArray(b.ops))throw new Error("Missing pipeline.ops array");for(const w of b.ops){if(!w||typeof w!="object")throw new Error("Invalid op entry");if(typeof w.instanceId!="string"||!w.instanceId)throw new Error("Op missing instanceId");if(typeof w.opId!="string"||!w.opId)throw new Error("Op missing opId");if(w.enabled!==void 0&&typeof w.enabled!="boolean")throw new Error("Op.enabled must be boolean")}a.onUpsertPipeline(b)}catch(b){const w=b instanceof Error?b.message:String(b);window.alert(`Invalid pipeline JSON: ${w}`)}}function h(){window.confirm(`Delete pipeline "${t.id}"? This also deletes its recipes.`)&&a.onDeletePipeline(t.id)}return f.addEventListener("click",c),g.addEventListener("click",h),s}function W(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function Kt(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function ra(e,t){return`${e}.${t+1}`}function la(e){const t=new Map;for(const i of e)t.set(i.id,i);return t}function Ht(e,t){const i=[];for(const n of e.opIds){const o=t.get(n);o&&i.push(o)}return i}function ca(e,t){let i=t;for(const n of e){if(n.io.input!==i)return i;i=n.io.output}return i}function da(e){const{mountEl:t,onSavePipeline:i}=e;let n=!1,o=[],a=new Map,s="info",l="Drag an operation from the left and drop it into a slot.",d=null;function r(w){const C="margin-top:10px; padding:8px 10px; border-radius:10px; font-size:12px; border:1px solid rgba(255,255,255,0.12);";return w==="error"?C+" background: rgba(255, 80, 80, 0.10);":w==="info"?C+" background: rgba(255, 200, 80, 0.10);":C+" background: rgba(80, 160, 255, 0.08);"}function f(w,C){s=w,l=C,d&&(d.setAttribute("style",r(w)),d.textContent=C)}function g(w){return w&&(w.getData("application/x-beemage-opid")||w.getData("text/plain"))||""}const u={id:"myPipeline",title:"My pipeline",description:"",implemented:!0,opIds:[],startType:"image"};function p(w,C){u.opIds.splice(w,0,C)}function c(w){u.opIds.splice(w,1)}function h(w,C){const E=w+C;if(E<0||E>=u.opIds.length)return;const I=u.opIds[w];u.opIds[w]=u.opIds[E],u.opIds[E]=I}function v(w,C){const E=a.get(C);if(!E)return{ok:!1,reason:"Unknown op"};const I=Ht(u,a),D=jt({specs:I,startType:u.startType,index:w}),L=w<I.length?I[w].io.input:void 0;return Ao({beforeType:D,afterType:L,op:E})}function y(){const w=u.id.trim(),C=u.title.trim();if(!w){window.alert("Pipeline id is required.");return}if(!C){window.alert("Pipeline title is required.");return}const E=[];for(const L of u.opIds){const U=a.get(L);if(!U){window.alert(`Unknown operation in draft: ${L}`);return}E.push(U)}const I={id:w,title:C,description:u.description||void 0,implemented:!!u.implemented,ops:u.opIds.map((L,U)=>({instanceId:ra(w,U),opId:L,enabled:!0}))};let D=u.startType;for(let L=0;L<E.length;L++){const U=E[L];if(U.io.input!==D){window.alert(`Invalid typing at step ${L+1}: "${U.title}" needs ${U.io.input} but current is ${D}`);return}D=U.io.output}i(I)}function b(){if(n)return;Kt(t);const w=W("div",{class:"card",style:"padding:10px;"});w.appendChild(W("div",{class:"cardTitle"},"Pipeline playground"));const C=W("div",{class:"row",style:"gap:10px; flex-wrap:wrap; align-items:flex-end; margin-top:10px;"}),E=W("label",{class:"fieldInline"});E.appendChild(W("span",{},"Id"));const I=W("input",{type:"text",value:u.id,style:"min-width:200px;"});I.addEventListener("input",()=>{u.id=I.value}),E.appendChild(I);const D=W("label",{class:"fieldInline"});D.appendChild(W("span",{},"Title"));const L=W("input",{type:"text",value:u.title,style:"min-width:240px;"});L.addEventListener("input",()=>{u.title=L.value}),D.appendChild(L);const U=W("label",{class:"fieldInline"});U.appendChild(W("span",{},"Start type"));const $=W("select"),m=["image","imageList","mask","svg","pdf"];for(const R of m){const B=W("option");B.value=R,B.textContent=R,R===u.startType&&(B.selected=!0),$.appendChild(B)}$.addEventListener("change",()=>{const R=String($.value);u.startType=R,f("info",`Start type set to "${R}".`),b()}),U.appendChild($);const z=W("label",{class:"fieldInline"});z.appendChild(W("span",{},"Implemented"));const _=W("input",{type:"checkbox"});_.checked=!!u.implemented,_.addEventListener("change",()=>{u.implemented=!!_.checked}),z.appendChild(_);const M=W("button",{type:"button",class:"btn"},"Clear");M.addEventListener("click",()=>{u.opIds=[],b()});const O=W("button",{type:"button",class:"btn"},"Save pipeline");O.addEventListener("click",y),C.appendChild(E),C.appendChild(D),C.appendChild(U),C.appendChild(z),C.appendChild(M),C.appendChild(O),w.appendChild(C);const k=W("label",{style:"display:block; margin-top:10px;"});k.appendChild(W("div",{class:"muted",style:"font-size:12px; margin-bottom:4px;"},"Description"));const S=W("textarea",{style:"width:100%; min-height:54px;"});S.value=u.description,S.addEventListener("input",()=>{u.description=S.value}),k.appendChild(S),w.appendChild(k);const P=Ht(u,a),x=ca(P,u.startType),T=W("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},`Start: ${u.startType}  →  Current output: ${x}`);w.appendChild(T),d=W("div",{style:r(s)},l),w.appendChild(d);const A=W("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:8px;"});A.appendChild(W("div",{style:"border:1px dashed rgba(255,255,255,0.18); border-radius:10px; padding:8px; background:rgba(0,0,0,0.08);"},`Input (${u.startType})`));function N(R){const B=W("div",{"data-slot-index":String(R),style:"min-height:46px; display:flex; align-items:center; justify-content:center; border:1px dashed rgba(255,255,255,0.14); border-radius:10px; padding:8px; background:rgba(0,0,0,0.05); text-align:center; font-size:12px; cursor:copy;"}),K=jt({specs:P,startType:u.startType,index:R}),V=R<P.length?P[R].io.input:void 0;return B.textContent=V?`Drop here (slot type: ${K} → next needs: ${V})`:`Drop here (slot type: ${K})`,B.addEventListener("dragenter",F=>{F.preventDefault(),B.style.background="rgba(80, 160, 255, 0.08)"}),B.addEventListener("dragover",F=>{F.preventDefault(),F.dataTransfer&&(F.dataTransfer.dropEffect="copy");const q=g(F.dataTransfer);if(!q)return;const X=v(R,q);B.style.background=X.ok?"rgba(80, 255, 140, 0.08)":"rgba(255, 80, 80, 0.06)"}),B.addEventListener("dragleave",()=>{B.style.background="rgba(0,0,0,0.05)"}),B.addEventListener("drop",F=>{F.preventDefault(),B.style.background="rgba(0,0,0,0.05)";const q=g(F.dataTransfer);if(!q){f("error","Drop refused: could not read operation id from the drag payload."),ee({scope:"panel",kind:"error",message:"Builder playground drop refused (missing opId)",meta:{index:R}});return}const X=v(R,q);if(!X.ok){f("info",`Drop refused: ${X.reason??"operation cannot be inserted here."}`),ee({scope:"panel",kind:"info",message:"Builder playground drop refused (typing mismatch)",meta:{index:R,opId:q,reason:X.reason??""}});return}p(R,q),f("info",`Inserted "${q}" at position ${R+1}.`),ee({scope:"panel",kind:"info",message:"Builder playground op inserted",meta:{index:R,opId:q}}),b()}),B}for(let R=0;R<=u.opIds.length;R++)if(A.appendChild(N(R)),R<u.opIds.length){const B=u.opIds[R],K=a.get(B),V=W("div",{class:"row",style:"gap:8px; align-items:flex-start;"}),F=W("div",{style:"flex:1;"});K?F.appendChild(Ze(K,{compact:!0,showGroup:!0,showId:!0,portStyle:"puzzle",cardStyle:"puzzleFrame"})):F.appendChild(W("div",{class:"muted"},`Unknown op: ${B}`));const q=W("div",{style:"display:flex; flex-direction:column; gap:6px;"}),X=W("button",{type:"button",class:"btn"},"Up");X.disabled=R===0,X.addEventListener("click",()=>{h(R,-1),b()});const Z=W("button",{type:"button",class:"btn"},"Down");Z.disabled=R===u.opIds.length-1,Z.addEventListener("click",()=>{h(R,1),b()});const te=W("button",{type:"button",class:"btn"},"Remove");te.addEventListener("click",()=>{c(R),b()}),q.appendChild(X),q.appendChild(Z),q.appendChild(te),V.appendChild(F),V.appendChild(q),A.appendChild(V)}w.appendChild(A),t.appendChild(w)}return{render(w){o=w.opsLibrary??[],a=la(o),b()},dispose(){n=!0,Kt(t)}}}function J(e,t,i){const n=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))n.setAttribute(o,a);return typeof i=="string"&&(n.textContent=i),n}function pa(e){const{dom:t,handlers:i}=e;let n=!1,o=!1,a="all",s="all",l=null,d=null,r="",f=null,g=null,u=null,p=null,c=null,h=null,v=null,y=null;function b(){if(g)return g;const M=J("div",{"data-role":"builderListMount",style:"margin-top:12px;"});return t.viewBuilder.appendChild(M),g=M,M}function w(){if(C(),u)return u;const M=J("div",{"data-role":"builderOpsMount"});return(c??t.viewBuilder).appendChild(M),u=M,M}function C(){p||(p=J("div",{"data-role":"builderLayout",style:"display:flex; gap:12px; align-items:flex-start; margin-top:12px;"}),c=J("div",{"data-role":"builderLeftCol",style:"flex:1; min-width:320px;"}),h=J("div",{"data-role":"builderRightCol",style:"flex:1; min-width:320px;"}),p.appendChild(c),p.appendChild(h),t.viewBuilder.appendChild(p))}function E(M,O){const k=J("select"),S=[{value:"all",label:"All"},{value:"image",label:"image"},{value:"mask",label:"mask"},{value:"svg",label:"svg"}];for(const P of S){const x=J("option");x.value=P.value,x.textContent=P.label,P.value===M&&(x.selected=!0),k.appendChild(x)}return k.addEventListener("change",()=>O(k.value)),k}function I(){if(C(),v)return v;const M=J("div",{"data-role":"builderPlaygroundMount"});return(h??t.viewBuilder).appendChild(M),v=M,y=da({mountEl:v,onSavePipeline:async O=>{await i.onUpsertPipeline(O)}}),M}function D(M){const O=a==="all"?!0:M.io.input===a,k=s==="all"?!0:M.io.output===s;return O&&k}function L(M,O){const k=w();k.innerHTML="";const S=J("div",{class:"card",style:"padding:10px;"});S.appendChild(J("div",{class:"cardTitle"},"All operations"));const P=J("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px;"}),x=J("label",{class:"fieldInline"});x.appendChild(J("span",{},"Filter input")),l=E(String(a),R=>{a=R==="all"?"all":R,L(M)}),x.appendChild(l);const T=J("label",{class:"fieldInline"});T.appendChild(J("span",{},"Filter output")),d=E(String(s),R=>{s=R==="all"?"all":R,L(M)}),T.appendChild(d),P.appendChild(x),P.appendChild(T),S.appendChild(P);const A=M.filter(D);if(!A.length){S.appendChild(J("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No operations match the filter.")),k.appendChild(S);return}const N=J("div",{class:"opsGrid",style:"margin-top:10px;"});for(const R of A){const B=Ze(R,{compact:!0,showGroup:!0,showId:!0,portStyle:"puzzle",cardStyle:"plain"});B.setAttribute("draggable","true"),B.addEventListener("dragstart",K=>{var V,F;(V=K.dataTransfer)==null||V.setData("application/x-beemage-opid",R.id),(F=K.dataTransfer)==null||F.setData("text/plain",R.id),K.dataTransfer&&(K.dataTransfer.effectAllowed="copy")}),N.appendChild(B)}S.appendChild(N),k.appendChild(S)}function U(M,O){const k=b();k.innerHTML="";const S=J("div",{class:"card",style:"padding:10px;"});S.appendChild(J("div",{class:"cardTitle"},"Stored user pipelines"));const P=J("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px;"}),x=Array.isArray(O.examples)?O.examples:[],T=J("label",{class:"fieldInline"});T.appendChild(J("span",{},"Load example"));const A=J("select",{style:"min-width:260px;"});{const Z=J("option");Z.value="",Z.textContent=x.length?"Select an example…":"No examples available",Z.selected=!0,A.appendChild(Z)}for(const Z of x){const te=J("option");te.value=String(Z.path??""),te.textContent=String(Z.title??Z.id??Z.path??"Example"),A.appendChild(te)}T.appendChild(A);const N=J("button",{type:"button",class:"btn",style:"padding:4px 10px; font-size:12px;"},"Load");N.disabled=!0,A.addEventListener("change",()=>{N.disabled=!A.value}),N.addEventListener("click",()=>{const Z=A.value;Z&&(i.onLoadExample(Z),A.value="",N.disabled=!0)});const R=J("label",{class:"fieldInline"});R.appendChild(J("span",{},"Filter pipelines")),f=J("input",{type:"text",value:r,placeholder:"Search by id or title…",style:"min-width:260px;"}),f.addEventListener("input",()=>{r=f?f.value:"",U(O.pipelines,O)}),R.appendChild(f);const B=J("button",{type:"button",class:"btn",style:"padding:4px 10px; font-size:12px;"},"Clear");B.addEventListener("click",()=>{r="",f&&(f.value=""),U(O.pipelines,O)}),P.appendChild(T),P.appendChild(N),P.appendChild(R),P.appendChild(B),S.appendChild(P);const K=Array.isArray(O.userPipelinesRaw)?O.userPipelinesRaw:[];if(!K.length){S.appendChild(J("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No user pipelines stored.")),k.appendChild(S);return}const V=r.trim().toLowerCase(),F=V.length===0?K:K.filter(Z=>{const te=String(Z.id??"").toLowerCase(),ne=String(Z.title??"").toLowerCase();return te.includes(V)||ne.includes(V)});if(!F.length){S.appendChild(J("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No pipelines match the search.")),k.appendChild(S);return}const q=J("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:10px;"}),X=O.recipesAll??{};for(const Z of F){const te=(X==null?void 0:X[Z.id])??{recipesById:{},selectedRecipeId:void 0},ne=(te==null?void 0:te.recipesById)??{},xe=Object.values(ne),ke=te==null?void 0:te.selectedRecipeId;q.appendChild(sa({pipeline:Z,opsLibrary:O.ops??[],selectedRecipeId:ke,recipes:xe,handlers:{onDeletePipeline:i.onDeletePipeline,onUpsertPipeline:i.onUpsertPipeline,onSelectRecipe:i.onSelectRecipe,onUpsertRecipe:i.onUpsertRecipe,onDeleteRecipe:i.onDeleteRecipe}}))}S.appendChild(q),k.appendChild(S)}function $(){o||(o=!0,t.builderImportFileEl.addEventListener("change",()=>{var M;(M=t.builderImportFileEl.files)==null||M[0]}),t.btnBuilderExportEl.addEventListener("click",()=>{i.onExport()}),t.builderImportFileEl.addEventListener("change",()=>{var O;const M=((O=t.builderImportFileEl.files)==null?void 0:O[0])??null;M&&(i.onImportFile(M),t.builderImportFileEl.value="")}))}function m(){n||(n=!0,C(),w(),I(),b())}function z(M){t.builderStatusEl.textContent=M.statusText||"Idle",C(),w(),I(),b(),y==null||y.render({opsLibrary:M.ops??[]}),L(M.ops??[]),U(M.pipelines,M)}function _(){n=!1,o=!1,a="all",s="all",r="",f=null,l=null,d=null,g&&(g.innerHTML="",g.remove(),g=null),u&&(u.innerHTML="",u.remove(),u=null),y==null||y.dispose(),y=null,v&&(v.innerHTML="",v.remove(),v=null),p&&(p.innerHTML="",p.remove(),p=null,c=null,h=null)}return{bind:$,mount:m,render:z,dispose:_}}function ua(e,t){const i=new Blob([t],{type:"application/json;charset=utf-8"}),n=URL.createObjectURL(i),o=document.createElement("a");o.href=n,o.download=e,o.rel="noopener",o.click(),setTimeout(()=>URL.revokeObjectURL(n),500)}function ga(e,t){const i=Qo();let n=!1,o={},a=[],s="Idle",l=[],d=i.listOperations();async function r(){const C=kt("assets/pipelines/index.json"),E=await fetch(C,{cache:"no-store"});if(!E.ok)throw new Error(`Examples index not found: ${E.status}`);const I=await E.json().catch(()=>null),D=I==null?void 0:I.examples;return Array.isArray(D)?D.map(L=>({id:String((L==null?void 0:L.id)??""),title:String((L==null?void 0:L.title)??(L==null?void 0:L.id)??(L==null?void 0:L.path)??"Example"),path:String((L==null?void 0:L.path)??"")})).filter(L=>L.id&&L.path):[]}async function f(C){const E=kt(C),I=await fetch(E,{cache:"no-store"});if(!I.ok)throw new Error(`Example fetch failed (${I.status}): ${C}`);const D=await I.text();await i.importFromJsonText(D)}const g=pa({dom:e,handlers:{onImportFile:async C=>{try{s=`Importing: ${C.name}`,c();const E=await C.text(),I=await i.importFromJsonText(E);G({scope:"panel",kind:"info",message:`Builder import: imported=${I.imported}, skipped=${I.skipped}, total=${I.totalInFile}`}),s=`Imported ${I.imported} pipeline(s) (skipped ${I.skipped}).`,await u()}catch(E){const I=E instanceof Error?E.message:String(E);G({scope:"panel",kind:"error",message:`Builder import failed: ${I}`}),ee({scope:"panel",kind:"error",message:"Builder import failed",meta:{error:I}}),s=`Import failed: ${I}`,c()}},onExport:async()=>{try{s="Exporting…",c();const C=await i.exportToJsonText();ua("beemage-user-pipelines.json",C),G({scope:"panel",kind:"info",message:"Builder export: downloaded beemage-user-pipelines.json"}),s="Exported.",c()}catch(C){const E=C instanceof Error?C.message:String(C);G({scope:"panel",kind:"error",message:`Builder export failed: ${E}`}),ee({scope:"panel",kind:"error",message:"Builder export failed",meta:{error:E}}),s=`Export failed: ${E}`,c()}},onDeletePipeline:async C=>{try{await i.deleteUserPipelineById(C),await i.deleteAllRecipesForPipeline(C),G({scope:"panel",kind:"info",message:`Builder: deleted user pipeline "${C}" (and its recipes)`}),s=`Deleted pipeline ${C}.`,await u()}catch(E){const I=E instanceof Error?E.message:String(E);G({scope:"panel",kind:"error",message:`Delete pipeline failed: ${I}`}),ee({scope:"panel",kind:"error",message:"Delete pipeline failed",meta:{pipelineId:C,error:I}}),s=`Delete failed: ${I}`,c()}},onUpsertPipeline:async C=>{try{await i.upsertUserPipeline(C),G({scope:"panel",kind:"info",message:`Builder: saved user pipeline "${String((C==null?void 0:C.id)??"")}"`}),s=`Saved pipeline ${String((C==null?void 0:C.id)??"")}.`,await u()}catch(E){const I=E instanceof Error?E.message:String(E);G({scope:"panel",kind:"error",message:`Save pipeline failed: ${I}`}),ee({scope:"panel",kind:"error",message:"Save pipeline failed",meta:{error:I}}),s=`Save failed: ${I}`,c()}},onSelectRecipe:async(C,E)=>{try{await i.setSelectedRecipe(C,E),G({scope:"panel",kind:"info",message:`Builder: selected recipe "${E}" for pipeline "${C}"`}),s=`Selected recipe ${E} for ${C}.`,await u()}catch(I){const D=I instanceof Error?I.message:String(I);G({scope:"panel",kind:"error",message:`Select recipe failed: ${D}`}),ee({scope:"panel",kind:"error",message:"Select recipe failed",meta:{pipelineId:C,recipeId:E,error:D}}),s=`Select recipe failed: ${D}`,c()}},onUpsertRecipe:async(C,E)=>{try{await i.upsertRecipe(C,E),G({scope:"panel",kind:"info",message:`Builder: saved recipe "${String((E==null?void 0:E.id)??"")}" for pipeline "${C}"`}),s=`Saved recipe ${String((E==null?void 0:E.id)??"")} for ${C}.`,await u()}catch(I){const D=I instanceof Error?I.message:String(I);G({scope:"panel",kind:"error",message:`Save recipe failed: ${D}`}),ee({scope:"panel",kind:"error",message:"Save recipe failed",meta:{pipelineId:C,error:D}}),s=`Save recipe failed: ${D}`,c()}},onDeleteRecipe:async(C,E)=>{try{await i.deleteRecipe(C,E),G({scope:"panel",kind:"info",message:`Builder: deleted recipe "${E}" from pipeline "${C}"`}),s=`Deleted recipe ${E} from ${C}.`,await u()}catch(I){const D=I instanceof Error?I.message:String(I);G({scope:"panel",kind:"error",message:`Delete recipe failed: ${D}`}),ee({scope:"panel",kind:"error",message:"Delete recipe failed",meta:{pipelineId:C,recipeId:E,error:D}}),s=`Delete recipe failed: ${D}`,c()}},onLoadExample:async C=>{try{s=`Loading example: ${C}`,c(),await f(C),G({scope:"panel",kind:"info",message:`Builder example loaded: ${C}`}),s=`Loaded example: ${C}`,await u()}catch(E){const I=E instanceof Error?E.message:String(E);G({scope:"panel",kind:"error",message:`Load example failed: ${I}`}),ee({scope:"panel",kind:"error",message:"Load example failed",meta:{error:I,examplePath:C}}),s=`Load example failed: ${I}`,c()}}}});async function u(){const C=await i.listUserPipelines().catch(()=>[]);l=C,d=i.listOperations(),o=await i.listAllRecipes().catch(()=>({})),a=await r().catch(()=>[]),s=`Ready. User pipelines: ${C.length} · Operations: ${d.length} · Examples: ${a.length}`,c()}function p(){const C=l??[];return{statusText:s,pipelines:C.map(E=>({id:String(E.id),title:String(E.title),implemented:!!E.implemented,opCount:Array.isArray(E.ops)?E.ops.length:0})),userPipelinesRaw:C,ops:d,recipesAll:o??{},examples:a??[]}}function c(){g.mount(),g.render(p())}function h(){g.bind(),e.builderStatusEl.textContent="Idle"}async function v(){n=!0,s="Loading…",c(),await u()}async function y(){n&&(s="Refreshing…",c(),await u())}function b(){n=!1}function w(){g.dispose()}return{bind:h,mount:v,refresh:y,unmount:b,dispose:w}}async function fa(){const e=Rn();await lt().catch(()=>null);const t=On();t.start();const i=Nn();globalThis.app__={...globalThis.app__,cache:i};const n=Fi({getRuntimeAvailability:()=>({opencvReady:!1}),debugTraceAppend:g=>ee({scope:"panel",kind:"debug",message:g}),actionLogAppend:g=>G({scope:"panel",kind:"info",message:g})});n.mount({mountEl:e.tuningMountEl,scopeRootId:"app"});const o=Qn(e),a=ci(e),s=Yo(e,t,n),l=Bi(e,t),d=Ni(e),r=ga(e);o.bind(),s.bind(),a.bind(),l.bind(),d.bind(),r.bind();const f=Vn(e,{image:o,pipeline:s,builder:r,colors:a,settings:l,logs:d});f.bind(),f.boot()}fa();
