import{_ as Rn}from"./index-BxvdQbmG.js";function Ln(){function e(yt,Tn){if(!yt)throw new Error(`[dom] Missing #${Tn}`);return yt}const t=e(document.getElementById("appRoot"),"appRoot"),n=e(document.getElementById("tabImage"),"tabImage"),i=e(document.getElementById("tabColors"),"tabColors"),o=e(document.getElementById("tabSettings"),"tabSettings"),a=e(document.getElementById("tabLogs"),"tabLogs"),s=e(document.getElementById("tabPipeline"),"tabPipeline"),l=e(document.getElementById("tabBuilder"),"tabBuilder"),u=e(document.getElementById("viewImage"),"viewImage"),r=e(document.getElementById("viewColors"),"viewColors"),f=e(document.getElementById("viewSettings"),"viewSettings"),g=e(document.getElementById("viewLogs"),"viewLogs"),h=e(document.getElementById("viewPipeline"),"viewPipeline"),c=e(document.getElementById("viewBuilder"),"viewBuilder"),d=e(document.getElementById("dropZone"),"dropZone"),m=e(document.getElementById("fileInput"),"fileInput"),v=e(document.getElementById("srcCanvas"),"srcCanvas"),b=e(document.getElementById("pipelineStatus"),"pipelineStatus"),y=e(document.getElementById("pipelineTuningMount"),"pipelineTuningMount"),x=e(document.getElementById("pipelineViewMount"),"pipelineViewMount"),w=e(document.getElementById("builderImportFile"),"builderImportFile"),C=e(document.getElementById("btnBuilderExport"),"btnBuilderExport"),E=e(document.getElementById("builderStatus"),"builderStatus"),T=e(document.getElementById("colorsCanvas"),"colorsCanvas"),$=e(document.getElementById("palette"),"palette"),O=e(document.getElementById("btnColorsApply"),"btnColorsApply"),p=e(document.getElementById("btnColorsCancel"),"btnColorsCancel"),I=e(document.getElementById("btnColorsReset"),"btnColorsReset"),R=e(document.getElementById("edgesDark"),"edgesDark"),B=e(document.getElementById("edgeMaskThreshold"),"edgeMaskThreshold"),A=e(document.getElementById("edgeDilate"),"edgeDilate"),k=e(document.getElementById("maxRegionPx"),"maxRegionPx"),S=e(document.getElementById("colorsStatus"),"colorsStatus"),P=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),D=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),M=e(document.getElementById("devConfigDetails"),"devConfigDetails"),z=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),L=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),N=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),U=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),J=e(document.getElementById("logsCbDebug"),"logsCbDebug"),_=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),q=e(document.getElementById("cfgStatus"),"cfgStatus"),Q=e(document.getElementById("cfgOpenCvSpinner"),"cfgOpenCvSpinner"),ue=e(document.getElementById("cfgOpenCvStatus"),"cfgOpenCvStatus"),pe=e(document.getElementById("cfgOpenCvReport"),"cfgOpenCvReport"),Z=e(document.getElementById("settingsEngineBox"),"settingsEngineBox"),ne=e(document.getElementById("cfgUseOpenCv"),"cfgUseOpenCv"),Ce=e(document.getElementById("tuningMount"),"tuningMount"),We=e(document.getElementById("settingsVersion"),"settingsVersion"),Je=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),mn=e(document.getElementById("logsLimit"),"logsLimit"),yn=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),bn=e(document.getElementById("logsStatus"),"logsStatus"),vn=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),wn=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),Cn=e(document.getElementById("btnLogsExport"),"btnLogsExport"),En=e(document.getElementById("btnLogsClear"),"btnLogsClear"),kn=e(document.getElementById("logsOut"),"logsOut"),In=e(document.getElementById("debugLimit"),"debugLimit"),xn=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),Sn=e(document.getElementById("btnDebugExport"),"btnDebugExport"),Pn=e(document.getElementById("btnDebugClear"),"btnDebugClear"),$n=e(document.getElementById("debugStatus"),"debugStatus"),An=e(document.getElementById("debugOut"),"debugOut");return{rootEl:t,tabImage:n,tabColors:i,tabSettings:o,tabLogs:a,tabPipeline:s,tabBuilder:l,viewImage:u,viewColors:r,viewSettings:f,viewLogs:g,viewPipeline:h,viewBuilder:c,dropZoneEl:d,fileInputEl:m,srcCanvasEl:v,pipelineStatusEl:b,pipelineTuningMountEl:y,pipelineViewMountEl:x,builderImportFileEl:w,btnBuilderExportEl:C,builderStatusEl:E,colorsCanvasEl:T,paletteEl:$,btnColorsApplyEl:O,btnColorsCancelEl:p,btnColorsResetEl:I,edgesDarkEl:R,edgeMaskThresholdEl:B,edgeDilateEl:A,maxRegionPxEl:k,colorsStatusEl:S,cfgShowDevToolsEl:P,settingsGeneralStatusEl:D,devConfigDetailsEl:M,cfgTraceConsoleEl:z,cfgActionLogMaxEl:L,cfgDebugTraceMaxEl:N,cfgFailureLogsPerRunEl:U,logsCbDebugEl:J,btnCfgResetDefaults:_,cfgStatusEl:q,settingsVersionEl:We,settingsGitHubLinkEl:Je,cfgOpenCvSpinner:Q,cfgOpenCvStatus:ue,cfgOpenCvReport:pe,settingsEngineBoxEl:Z,cfgUseOpenCvEl:ne,tuningMountEl:Ce,logsLimitEl:mn,btnLogsRefresh:yn,logsStatusEl:bn,logsTrimKeepEl:vn,btnLogsTrim:wn,btnLogsExport:Cn,btnLogsClear:En,logsOutEl:kn,debugLimitEl:In,btnDebugRefresh:xn,btnDebugExport:Sn,btnDebugClear:Pn,debugStatusEl:$n,debugOutEl:An}}const Dn=new Set;function Mn(e){Dn.add(e)}function bt(e){return`./${String(e||"").replace(/^\/+/,"")}`}function On(){const e=new Set;function t(i){return e.add(i),()=>e.delete(i)}function n(){Mn(o=>{for(const a of e)a(o)})}return{on:t,start:n}}const Bn=new Set;function Gt(e){for(const t of Bn)t(e,"local")}function ke(e){const t=localStorage.getItem(e);if(t!==null)try{return JSON.parse(t)}catch{return t}}function Un(e,t){localStorage.setItem(e,JSON.stringify(t))}async function ce(e){if(typeof e=="string")return{[e]:ke(e)};if(Array.isArray(e)){const n={};for(const i of e)n[i]=ke(i);return n}const t={};for(const[n,i]of Object.entries(e))t[n]=localStorage.getItem(n)!==null?ke(n):i;return t}async function de(e){const t={};for(const[n,i]of Object.entries(e)){const o=ke(n);Un(n,i),t[n]={oldValue:o,newValue:i}}Gt(t)}async function ft(e){const t=Array.isArray(e)?e:[e],n={};for(const i of t){const o=ke(i);localStorage.removeItem(i),n[i]={oldValue:o,newValue:void 0}}Gt(n)}function le(e,t,n,i){const o=Number(String(e??"").trim());return Number.isFinite(o)?Math.max(t,Math.min(n,Math.floor(o))):i}const it="beemage.devConfig",te={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let ot=!1,Be={...te};function Kt(e){const t=e||{};return{traceConsole:!!t.traceConsole,actionLogMax:le(t.actionLogMax??te.actionLogMax,100,5e4,te.actionLogMax),debugTraceMax:le(t.debugTraceMax??te.debugTraceMax,100,5e4,te.debugTraceMax),failureLogsPerRun:le(t.failureLogsPerRun??te.failureLogsPerRun,0,5e4,te.failureLogsPerRun)}}async function at(){if(ot)return;const e=await ce([it]).catch(()=>({}));Be=Kt(e==null?void 0:e[it]),ot=!0}function Ue(){return Be}async function Ht(e){Be=Kt(e),ot=!0,await de({[it]:Be}).catch(()=>null)}async function zn(){await Ht({...te})}function Vn(e,t){const n={pipeline:e.tabPipeline,image:e.tabImage,builder:e.tabBuilder,colors:e.tabColors,settings:e.tabSettings,logs:e.tabLogs},i={pipeline:e.viewPipeline,image:e.viewImage,builder:e.viewBuilder,colors:e.viewColors,settings:e.viewSettings,logs:e.viewLogs};let o="image";const a=new Set;function s(){const c=Ue();return!!(c!=null&&c.traceConsole)}function l(){const c=globalThis;c.__bctGlobalErrorHooksInstalled||(c.__bctGlobalErrorHooksInstalled=!0,window.addEventListener("error",d=>{var v;const m=d;console.error("[panel] window error",{message:m.message,filename:m.filename,lineno:m.lineno,colno:m.colno,error:m.error?String(m.error):null,stack:(v=m.error)!=null&&v.stack?String(m.error.stack):null})}),window.addEventListener("unhandledrejection",d=>{var m;console.error("[panel] unhandledrejection",{reason:d.reason?String(d.reason):null,stack:(m=d.reason)!=null&&m.stack?String(d.reason.stack):null})}))}s()&&l();function u(c){Object.keys(n).forEach(d=>{const m=d===c;n[d].classList.toggle("is-active",m),n[d].setAttribute("aria-selected",m?"true":"false"),i[d].hidden=!m,i[d].classList.toggle("is-active",m)})}function r(c){var d,m,v,b,y,x,w,C;if(c===o){(m=(d=t[c]).refresh)==null||m.call(d);return}(b=(v=t[o]).unmount)==null||b.call(v),o=c,u(o),a.has(o)?(C=(w=t[o]).refresh)==null||C.call(w):(a.add(o),(x=(y=t[o]).mount)==null||x.call(y))}function f(){n.image.addEventListener("click",c=>{var d;(d=c.preventDefault)==null||d.call(c),r("image")}),n.pipeline.addEventListener("click",c=>{var d;(d=c.preventDefault)==null||d.call(c),r("pipeline")}),n.colors.addEventListener("click",c=>{var d;(d=c.preventDefault)==null||d.call(c),r("colors")}),n.settings.addEventListener("click",c=>{var d;(d=c.preventDefault)==null||d.call(c),r("settings")}),n.logs.addEventListener("click",c=>{var d;(d=c.preventDefault)==null||d.call(c),r("logs")}),n.builder.addEventListener("click",c=>{var d;(d=c.preventDefault)==null||d.call(c),r("builder")})}function g(){var c,d,m,v;o="image",u(o),Object.keys(t).forEach(b=>{var y,x;return(x=(y=t[b]).boot)==null?void 0:x.call(y)}),a.has(o)?(v=(m=t[o]).refresh)==null||v.call(m):(a.add(o),(d=(c=t[o]).mount)==null||d.call(c))}function h(){Object.keys(t).forEach(c=>{var d,m;return(m=(d=t[c]).dispose)==null?void 0:m.call(d)})}return{bind:f,boot:g,activate:r,dispose:h}}function vt(e){const t=e.items.length;return{items:e.items,counts:{items:t},meta:e.meta}}function Nn(){const e={items:[],meta:{}},t=new Set;function n(){const r=vt(e);for(const f of t)try{f(r)}catch{}}function i(){return vt(e)}function o(r){t.add(r);try{r(i())}catch{}return()=>t.delete(r)}function a(){e.items=[],e.meta={},n()}function s(r){e.meta.scopeUpdatedSince=r,n()}function l(){return String(e.meta.scopeUpdatedSince||"")}function u(r,f){e.items=r.slice(),e.meta.updatedTs=Date.now(),typeof(f==null?void 0:f.limit)=="number"&&(e.meta.limit=f.limit),n()}return{getSnapshot:i,subscribe:o,getScopeUpdatedSince:l,clearAll:a,setScopeUpdatedSince:s,setItems:u}}function _n(e,t){function n(l){e.dropZoneEl.classList.toggle("is-hover",l)}function i(l,u){const r=l.getContext("2d",{willReadFrequently:!0});if(!r)return;const f=Math.max(1,l.width),g=Math.max(1,l.height);r.clearRect(0,0,f,g);const h=u.naturalWidth||u.width,c=u.naturalHeight||u.height;if(!h||!c)return;const d=Math.min(f/h,g/c),m=Math.max(1,Math.round(h*d)),v=Math.max(1,Math.round(c*d)),b=Math.floor((f-m)/2),y=Math.floor((g-v)/2);r.drawImage(u,b,y,m,v)}function o(l){i(e.srcCanvasEl,l)}function a(l){t.lastError=void 0,t.loadedImageName=l,t.hasImage=!0}function s(l){t.lastError=l,t.hasImage=!1}return{setHover:n,drawImageToSource:o,showLoadOk:a,showLoadError:s}}function jn(){return{loadedImageName:null,hasImage:!1,lastError:void 0}}const ze="beemage.actionLog",Fn=5e3;function Gn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function Kn(e){return Array.isArray(e)?e:[e]}function Ve(e,t,n){return Math.max(t,Math.min(n,Math.floor(e)))}async function Ie(){const e=await ce(ze),t=e==null?void 0:e[ze];return Array.isArray(t)?t:[]}async function Wt(e){await de({[ze]:e})}async function j(e,t){const n=Ve(Fn,100,5e4),o=Kn(e).map(u=>({...u,id:Gn(),ts:Date.now()}));if(!o.length)return{total:(await Ie()).length};const s=(await Ie()).concat(o),l=s.length>n?s.slice(s.length-n):s;return await Wt(l),{total:l.length}}async function Hn(e){const t=Ve((e==null?void 0:e.limit)??200,1,5e4),n=Ve((e==null?void 0:e.offset)??0,0,1e6);let o=await Ie();e!=null&&e.kind&&(o=o.filter(l=>l.kind===e.kind)),e!=null&&e.scope&&(o=o.filter(l=>l.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(o=o.filter(l=>l.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(o=o.filter(l=>l.ts<=e.untilTs));const a=o.length;o=o.slice().reverse();const s=o.slice(n,n+t);return{total:a,items:s}}async function Wn(e){let n=await Ie();if(typeof e.beforeTs=="number"&&(n=n.filter(i=>i.ts>=e.beforeTs)),typeof e.keepLast=="number"){const i=Ve(e.keepLast,0,5e4);i===0?n=[]:n.length>i&&(n=n.slice(n.length-i))}return await Wt(n),{total:n.length}}async function Jn(){await ft(ze)}async function qn(e){const t=await Ie();return JSON.stringify(t,null,2)}const xe="beemage.debugTrace",st="beemage.debugTrace.enabled",Zn=2e3;function Yn(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function rt(e,t,n){return Math.max(t,Math.min(n,Math.floor(e)))}async function Ne(){const e=await ce(xe),t=e==null?void 0:e[xe];return Array.isArray(t)?t:[]}async function Xn(e){await de({[xe]:e})}async function ht(){const e=await ce(st);return!!(e!=null&&e[st])}async function Jt(e){await de({[st]:!!e}),e||await ft(xe)}async function qt(){await ft(xe)}async function Y(e,t){if(!await ht())return{total:0};const i=rt((t==null?void 0:t.max)??Zn,100,5e4),o=(Array.isArray(e)?e:[e]).map(u=>({...u,id:Yn(),ts:Date.now()}));if(!o.length)return{total:(await Ne()).length};const s=(await Ne()).concat(o),l=s.length>i?s.slice(s.length-i):s;return await Xn(l),{total:l.length}}async function Zt(e){const t=rt((e==null?void 0:e.limit)??200,1,5e4),n=rt((e==null?void 0:e.offset)??0,0,1e6),i=(e==null?void 0:e.reverse)??!0,o=await Ne(),a=o.length,l=(i?o.slice().reverse():o).slice(n,n+t);return{total:a,items:l}}async function Yt(e){const t=await Ne();return JSON.stringify(t,null,e!=null&&e.pretty?2:0)}const Xt=Object.freeze(Object.defineProperty({__proto__:null,append:Y,clear:qt,exportJson:Yt,isEnabled:ht,list:Zt,setEnabled:Jt},Symbol.toStringTag,{value:"Module"}));function Qn(e,t){const n=jn(),i=_n(e,n);async function o(f){if(!f.type.startsWith("image/"))throw new Error(`Unsupported file type: ${f.type||"unknown"}`);const g=URL.createObjectURL(f);try{const h=new Image;return h.decoding="async",h.src=g,typeof h.decode=="function"?await h.decode():await new Promise((c,d)=>{h.onload=()=>c(),h.onerror=()=>d(new Error("Image decode failed."))}),h}finally{URL.revokeObjectURL(g)}}async function a(f){const g=await o(f);i.drawImageToSource(g),i.showLoadOk(f.name),j({scope:"panel",kind:"info",message:`Input loaded: ${f.name}`}),Y({scope:"panel",kind:"info",message:"Mage input loaded into srcCanvas",meta:{name:f.name,type:f.type,size:f.size,canvasW:e.srcCanvasEl.width,canvasH:e.srcCanvasEl.height,naturalW:g.naturalWidth||g.width,naturalH:g.naturalHeight||g.height}})}function s(){e.dropZoneEl.addEventListener("dragover",f=>{f.preventDefault(),i.setHover(!0)}),e.dropZoneEl.addEventListener("dragleave",()=>i.setHover(!1)),e.dropZoneEl.addEventListener("drop",f=>{var h,c;f.preventDefault(),i.setHover(!1);const g=(c=(h=f.dataTransfer)==null?void 0:h.files)==null?void 0:c[0];g&&a(g).catch(d=>{const m=d instanceof Error?d.message:String(d);i.showLoadError(m),j({scope:"panel",kind:"error",message:`Input load failed: ${m}`}),Y({scope:"panel",kind:"error",message:"Input load failed",meta:{error:m}})})}),e.fileInputEl.addEventListener("change",()=>{var g;const f=(g=e.fileInputEl.files)==null?void 0:g[0];f&&(a(f).catch(h=>{const c=h instanceof Error?h.message:String(h);i.showLoadError(c),j({scope:"panel",kind:"error",message:`Input load failed: ${c}`}),Y({scope:"panel",kind:"error",message:"Input load failed",meta:{error:c}})}),e.fileInputEl.value="")})}function l(){s()}function u(){}function r(){}return{id:"image",bind:l,mount:u,unmount:r}}function qe(e,t,n){return Number.isFinite(e)?Math.max(t,Math.min(n,Math.trunc(e))):t}function ei(e,t,n){return Math.round(.2126*e+.7152*t+.0722*n)}function Qt(e){return{edgesDark:!!(e.edgesDark??!0),edgeThreshold:qe(e.edgeThreshold??80,0,255),edgeDilate:qe(e.edgeDilate??2,0,6),maxRegionPx:qe(e.maxRegionPx??2e5,1e3,1e7)}}function ti(e,t,n){const{data:i,width:o,height:a}=e,s=new Uint8Array(o*a);for(let l=0,u=0;l<s.length;l++,u+=4){const r=i[u+0],f=i[u+1],g=i[u+2];if(i[u+3]===0){s[l]=0;continue}const c=ei(r,f,g),d=t?c<=n:c>=255-n;s[l]=d?1:0}return s}function ni(e,t,n,i){if(i<=0)return e;let o=e;for(let a=0;a<i;a++){const s=new Uint8Array(t*n);for(let l=0;l<n;l++)for(let u=0;u<t;u++){const r=l*t+u;if(o[r]){s[r]=1;continue}let f=0;for(let g=-1;g<=1&&!f;g++){const h=l+g;if(!(h<0||h>=n))for(let c=-1;c<=1;c++){const d=u+c;if(!(d<0||d>=t)&&o[h*t+d]){f=1;break}}}s[r]=f}o=s}return o}function ii(e,t,n,i,o,a){const s=t*i+e;if(n[s])return{ok:!1,message:"Click is on an edge; pick inside a region."};const l=new Uint8Array(i*o),u=new Int32Array(i*o),r=new Int32Array(i*o);let f=0,g=0;u[g]=e,r[g]=t,g++,l[s]=1;let h=1;for(;f<g;){const c=u[f],d=r[f];f++;const m=[[c-1,d],[c+1,d],[c,d-1],[c,d+1]];for(const[v,b]of m){if(v<0||v>=i||b<0||b>=o)continue;const y=b*i+v;if(!l[y]&&!n[y]&&(l[y]=1,u[g]=v,r[g]=b,g++,h++,h>a))return{ok:!1,message:`Region too large (>${a}px). Increase Max region or fix gaps.`}}}return{ok:!0,mask:l}}function oi(e,t,n,i){const o=new Uint8Array(n*i);for(let a=1;a<i-1;a++)for(let s=1;s<n-1;s++){const l=a*n+s;if(!e[l])continue;const u=(a-1)*n+s,r=(a+1)*n+s,f=a*n+(s-1),g=a*n+(s+1);(!e[u]||!e[r]||!e[f]||!e[g]||t[u]||t[r]||t[f]||t[g])&&(o[l]=1)}return o}function ai(e,t,n,i){const o=Qt(i),a=e.width,s=e.height;let l=ti(e,o.edgesDark,o.edgeThreshold);l=ni(l,a,s,o.edgeDilate);const u=ii(t,n,l,a,s,o.maxRegionPx);if(!u.ok)return{ok:!1,message:u.message};const r=oi(u.mask,l,a,s);return{ok:!0,preview:{mask:u.mask,outline:r,w:a,h:s}}}function si(e,t,n){const i=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),o=n.replace("#",""),a=parseInt(o.slice(0,2),16),s=parseInt(o.slice(2,4),16),l=parseInt(o.slice(4,6),16),u=i.data;for(let r=0,f=0;r<t.mask.length;r++,f+=4)t.mask[r]&&(u[f+0]=a,u[f+1]=s,u[f+2]=l);return i}function Ze(e,t,n){return Number.isFinite(e)?Math.max(t,Math.min(n,Math.trunc(e))):t}function wt(e){const t=(e||"").trim();if(!t)return null;const n=t.startsWith("#")?t:`#${t}`;return/^#[0-9a-fA-F]{6}$/.test(n)?n.toLowerCase():null}function ri(e){let t="#ff3b30",n=[],i=null;function o(m){e.colorsStatusEl.textContent=m||""}function a(){const m=!!e.edgesDarkEl.checked,v=Ze(parseInt(e.edgeMaskThresholdEl.value,10),0,255),b=Ze(parseInt(e.edgeDilateEl.value,10),0,6),y=Ze(parseInt(e.maxRegionPxEl.value,10),1e3,1e7);return e.edgeMaskThresholdEl.value=String(v),e.edgeDilateEl.value=String(b),e.maxRegionPxEl.value=String(y),Qt({edgesDark:m,edgeThreshold:v,edgeDilate:b,maxRegionPx:y})}function s(m){const v=wt(m);if(v){t=v;for(const b of Array.from(e.paletteEl.querySelectorAll(".paletteItem"))){const y=b.dataset.hex||"";b.classList.toggle("is-selected",y===t)}}}function l(){return t}function u(m){n=m.slice(),e.paletteEl.innerHTML="";for(const v of n){const b=wt(v);if(!b)continue;const y=document.createElement("button");y.type="button",y.className="paletteItem",y.style.background=b,y.dataset.hex=b,y.setAttribute("role","listitem"),y.setAttribute("aria-label",`Select ${b}`),y.addEventListener("click",()=>{s(b)}),e.paletteEl.appendChild(y)}s(t)}function r(m){const v=e.colorsCanvasEl;v.width=m.width,v.height=m.height,v.getContext("2d").putImageData(m,0,0)}function f(m,v){r(m);const b=e.colorsCanvasEl.getContext("2d"),{outline:y,w:x,h:w}=v,C=b.getImageData(0,0,x,w),E=C.data;for(let T=0,$=0;T<y.length;T++,$+=4)y[T]&&(E[$+0]=255,E[$+1]=60,E[$+2]=60,E[$+3]=220);b.putImageData(C,0,0)}function g(m){e.btnColorsApplyEl.disabled=!m}function h(m){e.btnColorsCancelEl.disabled=!m}function c(m){i=m}function d(){o("Idle"),g(!1),h(!1),e.colorsCanvasEl.addEventListener("click",m=>{if(!i)return;const v=e.colorsCanvasEl.getBoundingClientRect(),b=Math.floor((m.clientX-v.left)/v.width*e.colorsCanvasEl.width),y=Math.floor((m.clientY-v.top)/v.height*e.colorsCanvasEl.height);i(b,y)})}return{bind:d,setStatus:o,getSettings:a,setSelectedColor:s,getSelectedColor:l,renderPalette:u,drawBase:r,drawPreview:f,setApplyEnabled:g,setCancelEnabled:h,onCanvasClick:c}}let en={type:"none"};function Ee(e){en=e}function Ct(){return en}function Ye(e){var s,l,u,r,f;if(!e){Ee({type:"none"});return}const t=(s=e.outputSvg)==null?void 0:s.svg;if(typeof t=="string"&&t.length>0){Ee({type:"svg",svg:t});return}const n=(l=e.outputImage)==null?void 0:l.data;if(n){Ee({type:"image",image:n});return}const i=(u=e.outputMask)==null?void 0:u.data,o=(r=e.outputMask)==null?void 0:r.width,a=(f=e.outputMask)==null?void 0:f.height;if(i&&typeof o=="number"&&typeof a=="number"){Ee({type:"mask",mask:i,width:o,height:a});return}Ee({type:"none"})}const li=["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de","#ff2d55","#a2845e","#8e8e93","#1c1c1e","#ffffff","#000000","#4cd964","#5ac8fa","#ff6b6b","#7aa2ff","#f5a623","#50e3c2"];function ci(e,t){const n=ri(e);let i=null,o=null;function a(c){n.setStatus(c)}function s(c,d,m){const v=new ImageData(d,m),b=v.data;for(let y=0,x=0;y<c.length;y++,x+=4){const C=(c[y]??0)>0?0:255;b[x+0]=C,b[x+1]=C,b[x+2]=C,b[x+3]=255}return v}function l(){const c=Ct();return c.type==="image"?c.image:c.type==="mask"?s(c.mask,c.width,c.height):null}function u(){return Ct().type==="svg"?"Pipeline output is SVG. Colors needs an image or mask output.":"No pipeline output available. Run the Pipeline first."}function r(){const c=l();if(!c){i=null,o=null,n.setApplyEnabled(!1),n.setCancelEnabled(!1),a(u());return}i=c,o=null,n.drawBase(i),n.setApplyEnabled(!1),n.setCancelEnabled(!1),a("Ready. Pick a color, click inside a region.")}function f(){if(i){n.drawBase(i);return}const c=l();if(!c){a(u());return}i=c,o=null,n.drawBase(i),n.setApplyEnabled(!1),n.setCancelEnabled(!1),a("Loaded pipeline output. Pick a color, click inside a region.")}function g(){if(!i||!o)return;const c=n.getSelectedColor();i=si(i,o,c),o=null,n.drawBase(i),n.setApplyEnabled(!1),n.setCancelEnabled(!1),a("Fill applied. Click another region.")}function h(){i&&(o=null,n.drawBase(i),n.setApplyEnabled(!1),n.setCancelEnabled(!1),a("Preview canceled."))}return{bind(){n.bind(),n.renderPalette(li),n.onCanvasClick((c,d)=>{if(!i){a(u());return}const m=n.getSettings(),v=ai(i,c,d,m);if(!v.ok){o=null,n.setApplyEnabled(!1),n.setCancelEnabled(!1),a(v.message);return}o=v.preview,n.drawPreview(i,o),n.setApplyEnabled(!0),n.setCancelEnabled(!0),a("Preview shown. Apply fill or cancel.")}),e.btnColorsApplyEl.addEventListener("click",()=>g()),e.btnColorsCancelEl.addEventListener("click",()=>h()),e.btnColorsResetEl.addEventListener("click",()=>r()),e.tabColors.addEventListener("click",()=>{queueMicrotask(()=>f())}),a("Idle"),n.setApplyEnabled(!1),n.setCancelEnabled(!1)}}}const Et="0.1.8";function Xe(e){return`[BCT][${e}]`}function di(e){function t(...a){e.traceOn()&&console.log(Xe("trace"),...a)}function n(...a){console.warn(Xe("warn"),...a)}function i(...a){console.error(Xe("error"),...a)}function o(a,s){t(a,s),Y({scope:e.scope,kind:"debug",message:a,meta:s})}return{logTrace:t,logWarn:n,logError:i,traceScope:o}}const{logTrace:F,logWarn:Me,logError:he,traceScope:tn}=di({scope:"panel",traceOn:()=>!!Ue().traceConsole});let X=0;function ee(){return X>0}function se(e,t){if(t){nn(e);return}X=0,_e(e,!1)}async function ui(e,t){const n=`${Date.now()}-${Math.random().toString(16).slice(2)}`;F("[state] withBusy: enter",{id:n,busyCount:X}),nn(e,n);try{F("[state] withBusy: before await fn",{id:n,busyCount:X});const i=await t();return F("[state] withBusy: after await fn (resolved)",{id:n,busyCount:X}),i}catch(i){throw he("[state] withBusy: fn threw",{id:n,busyCount:X,msg:String((i==null?void 0:i.message)??i),stack:String((i==null?void 0:i.stack)??"")}),i}finally{F("[state] withBusy: finally before endBusy",{id:n,busyCount:X}),pi(e,n),F("[state] withBusy: finally after endBusy",{id:n,busyCount:X})}}function nn(e,t){X++,F("[state] beginBusy",{id:t,busyCount:X}),X===1&&_e(e,!0)}function pi(e,t){if(X--,F("[state] endBusy: dec",{id:t,busyCount:X}),X<=0){X=0,F("[state] endBusy: applying busy=false",{id:t,busyCount:X}),_e(e,!1);return}X===0&&(F("[state] endBusy: applying busy=false (redundant branch)",{id:t,busyCount:X}),_e(e,!1))}function _e(e,t){e.rootEl.classList.toggle("is-busy",t),e.cfgShowDevToolsEl.disabled=!1,e.fileInputEl.disabled=t,e.cfgTraceConsoleEl.disabled=t,e.cfgActionLogMaxEl.disabled=t,e.cfgDebugTraceMaxEl.disabled=t,e.cfgFailureLogsPerRunEl.disabled=t,e.btnCfgResetDefaults.disabled=t,e.logsCbDebugEl.disabled=t,e.cfgUseOpenCvEl.disabled=t,e.logsLimitEl.disabled=t,e.btnLogsRefresh.disabled=t,e.logsTrimKeepEl.disabled=t,e.btnLogsTrim.disabled=t,e.btnLogsExport.disabled=t,e.btnLogsClear.disabled=t,e.debugLimitEl.disabled=t,e.btnDebugRefresh.disabled=t,e.btnDebugExport.disabled=t,e.btnDebugClear.disabled=t,e.btnColorsApplyEl.disabled=t,e.btnColorsCancelEl.disabled=t,e.btnColorsResetEl.disabled=t,e.edgesDarkEl.disabled=t,e.edgeMaskThresholdEl.disabled=t,e.edgeDilateEl.disabled=t,e.maxRegionPxEl.disabled=t;for(const n of Array.from(e.paletteEl.querySelectorAll("button")))n.disabled=t;e.colorsCanvasEl.style.pointerEvents=t?"none":"auto"}const mt={native:{available:!0},opencv:{available:!1,reason:"OpenCV not loaded"}};function gi(e){mt[e]={available:!0}}function fi(e,t){mt[e]={available:!1,reason:t}}function me(){return mt.opencv.available===!0}async function hi(e){const t=new URL(e.opencvJsRel,document.baseURI).toString(),n=new URL(e.opencvWasmRel,document.baseURI).toString(),i=globalThis;i.Module=i.Module||{},i.Module.locateFile=o=>o.endsWith(".wasm")?n:o,i.Module.print=()=>{},i.Module.printErr=()=>{},i.cv||await mi(t),await yi(e.timeoutMs)}function mi(e){return new Promise((t,n)=>{const i=document.createElement("script");i.src=e,i.async=!0;const o=15e3,a=window.setTimeout(()=>{s(),n(new Error(`OpenCV script load timeout after ${o}ms: ${e}`))},o);function s(){window.clearTimeout(a),i.onload=null,i.onerror=null}i.onload=()=>{s(),t()},i.onerror=()=>{s(),n(new Error(`Failed to load OpenCV script: ${e}`))},document.head.appendChild(i)})}async function yi(e){var i;const t=Date.now(),n=globalThis;for(;Date.now()-t<e;){try{if(n.cv&&typeof n.cv.Mat=="function"){const o=new n.cv.Mat;(i=o.delete)==null||i.call(o);return}}catch{}await new Promise(o=>setTimeout(o,75))}throw new Error(`OpenCV initialization timeout after ${e}ms`)}async function bi(){try{await hi({opencvJsRel:"../assets/opencv/opencv.js",opencvWasmRel:"../assets/opencv/opencv.wasm",timeoutMs:2e4}),gi("opencv")}catch(e){throw fi("opencv",e!=null&&e.message?String(e.message):String(e)),e}}function W(e,t,n,i,o,a,s){return{id:e,title:t,implementedEngines:n,defaultEnginePolicy:i,params:o,children:a,description:s}}function vi(e){const t=new Map,n=new Map;function i(o,a){if(t.has(o.id))throw new Error(`[tuning] Duplicate component id: ${o.id}`);t.set(o.id,o),n.set(o.id,a);for(const s of o.children??[])i(s,o.id)}return i(e,null),{root:e,byId:t,parentById:n}}function on(){const e=W("app","BeeMage",["native","opencv"],"native",{},[W("edge","Edge",["native","opencv"],"auto",{},[W("edge.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),W("edge.threshold","Threshold",["native","opencv"],"auto",{manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128}},void 0,"Convert image into a binary mask before edge extraction."),W("edge.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:3},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Clean the mask before extracting edges."),W("edge.extract","Edge extract",["native","opencv"],"auto",{},void 0,"Extract a 1px outline from the cleaned mask.")],"Fixed-order edge pipeline (image -> mask -> edges). Presets configure each step."),W("svg","SVG",["native","opencv"],"auto",{},[W("svg.create","Create SVG",["native","opencv"],"auto",{scale:{kind:"number",label:"Scale",min:1,max:10,step:1,default:1},transparentBg:{kind:"number",label:"Transparent bg (0/1)",min:0,max:1,step:1,default:1},color:{kind:"text",label:"Color",default:"#3bca1e"}},void 0,"Convert the edge mask into an SVG.")],"SVG generation parameters."),W("segmentation","Segmentation",["native","opencv"],"auto",{},[W("segmentation.resize","Resize",["native","opencv"],"auto",{resizeAlgo:{kind:"number",label:"Resize algo",min:0,max:3,step:1,default:1},targetMaxW:{kind:"number",label:"Target max width",min:100,max:4e3,step:50,default:1200}},void 0,"Prepare image for stable downstream processing."),W("segmentation.denoise","Denoise",["native","opencv"],"auto",{denoiseAlgo:{kind:"number",label:"Denoise algo",min:0,max:2,step:1,default:1},blurK:{kind:"number",label:"Blur kernel",min:1,max:21,step:2,default:3},bilateralSigma:{kind:"number",label:"Bilateral sigma",min:1,max:150,step:1,default:35}},void 0,"Reduce noise before thresholding."),W("segmentation.color","Color / Gray",["native","opencv"],"auto",{colorMode:{kind:"number",label:"Color mode",min:0,max:3,step:1,default:1},hsvChannel:{kind:"number",label:"HSV channel",min:0,max:2,step:1,default:2}},void 0,"Select color space / channel features for thresholding."),W("segmentation.threshold","Threshold",["native","opencv"],"auto",{thresholdAlgo:{kind:"number",label:"Threshold algo",min:0,max:3,step:1,default:1},manualT:{kind:"number",label:"Manual threshold",min:0,max:255,step:1,default:128},adaptBlock:{kind:"number",label:"Adaptive block",min:3,max:101,step:2,default:31},adaptC:{kind:"number",label:"Adaptive C",min:-50,max:50,step:1,default:3}},void 0,"Convert features into a binary mask."),W("segmentation.morphology","Morphology cleanup",["native","opencv"],"auto",{morphAlgo:{kind:"number",label:"Morph algo",min:0,max:3,step:1,default:2},morphK:{kind:"number",label:"Kernel size",min:1,max:31,step:2,default:5},morphIters:{kind:"number",label:"Iterations",min:1,max:5,step:1,default:1}},void 0,"Remove specks, fill holes, and stabilize regions.")],"Fixed-order segmentation pipeline. Presets configure each step."),W("image","iMage",["native","opencv"],"auto",{},[W("mage.process","Process",["native"],"auto",{imageScale:{kind:"number",label:"Processing scale",min:25,max:100,step:5,default:100},edgeThreshold:{kind:"number",label:"Edge threshold",min:1,max:255,step:1,default:70},invertOutput:{kind:"boolean",label:"White background",default:!0}}),W("mage.clean","Clean & Smooth",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:500,step:1,default:12},cleanRadius:{kind:"number",label:"Repair strength",min:1,max:3,step:1,default:1},cleanBinaryThreshold:{kind:"number",label:"Binary threshold",min:1,max:254,step:1,default:128}},[W("mage.clean.threshold","Threshold",["native"],"auto",{}),W("mage.clean.removeSmallComponents","Remove small components",["native","opencv"],"auto",{cleanMinArea:{kind:"number",label:"Min fragment size",min:0,max:5e3,step:1,default:12}},void 0,"Remove connected components smaller than the minimum area."),W("mage.clean.repair","Repair gaps",["native"],"auto",{}),W("mage.clean.smooth","Smooth mask",["native"],"auto",{}),W("mage.clean.quality","Quality metrics",["native"],"auto",{})]),W("mage.vectorize","Vectorize (SVG)",["native"],"native",{pathSmoothIters:{kind:"number",label:"Path smoothing",min:0,max:4,step:1,default:2}})]),W("colors","Colors",["native"],"auto",{},[W("colors.fill","Region fill",["native"],"auto",{edgesDark:{kind:"boolean",label:"Edges are dark",default:!0},edgeMaskThreshold:{kind:"number",label:"Edge threshold",min:0,max:255,step:1,default:80},edgeDilate:{kind:"number",label:"Gap close (px)",min:0,max:6,step:1,default:2},maxRegionPx:{kind:"number",label:"Max region (px)",min:1e3,step:1e3,default:2e5}})]),W("pipeline","Pipeline (UI)",["native","opencv"],"auto",{mode:{kind:"text",label:"Pipeline",default:"segmentation"},recipe:{kind:"text",label:"Recipe",default:"default"}},void 0,"UI state for the Pipeline tab (selected pipeline + recipe).")]);return vi(e)}function wi(e){return e.default}function Ci(e,t){const n={};for(const[i,o]of Object.entries(e))n[i]=wi(o);for(const[i,o]of Object.entries(t??{}))n[i]=o;return n}function Ei(e,t,n){var o;let i=e;for(;i;){const a=t.byId.get(i);if(!a)throw new Error(`[tuning] Unknown component: ${i}`);const l=((o=n[i])==null?void 0:o.enginePolicy)??a.defaultEnginePolicy;if(l!=="inherit")return l;i=t.parentById.get(i)??null}return"native"}function ki(e,t,n){const i=n.opencvReady&&e.includes("opencv");return e.includes("native")||e.length,t==="native"?{engine:"native"}:t==="opencv"?i?{engine:"opencv"}:{engine:"native",fallbackReason:n.opencvReady?"Policy=opencv, but component has no OpenCV implementation.":"Policy=opencv, but OpenCV is not available at runtime."}:t==="auto"?i?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}function an(e,t,n,i){var r;const o=t.byId.get(e);if(!o)throw new Error(`[tuning] Unknown component: ${e}`);const a=Ei(e,t,n),{engine:s,fallbackReason:l}=ki(o.implementedEngines,a,i),u=Ci(o.params,(r=n[e])==null?void 0:r.params);return{id:e,policy:a,engine:s,fallbackReason:l,params:u}}const lt="beemage.tuning.components.v1";async function Se(){const e=await ce([lt]).catch(()=>({})),t=e==null?void 0:e[lt];return!t||typeof t!="object"?{}:t}async function sn(e){await de({[lt]:e}).catch(()=>null)}async function Qe(e,t){const n=await Se(),i=n[e]??{};n[e]={enginePolicy:t.enginePolicy??i.enginePolicy,params:{...i.params??{},...t.params??{}}},await sn(n)}async function kt(e){const t=await Se();delete t[e],await sn(t)}function Ii(){return{opencvReady:me()}}function xi(e){return Array.isArray(e.children)&&e.children.length>0}function rn(e){const{id:t,registry:n,stored:i,runtime:o}=e,a=n.byId.get(t);if(!a)throw new Error(`[tuning] Unknown component: ${t}`);const s=an(t,n,i,o),l=i[t],u=l==null?void 0:l.enginePolicy,r=l==null?void 0:l.params,f=a.implementedEngines.includes("opencv"),g=!!o.opencvReady,h=[];for(const c of a.children??[])h.push(rn({id:c.id,registry:n,stored:i,runtime:o}));return{id:a.id,title:a.title,description:a.description,isGroup:xi(a),implementedEngines:a.implementedEngines,storedPolicy:u,storedParams:r,effectivePolicy:s.policy,effectiveEngine:s.engine,fallbackReason:s.fallbackReason,paramsSchema:a.params,effectiveParams:s.params,canImplementOpenCv:f,runtimeOpenCvReady:g,children:h}}function ln(e={}){const t=e.registry??on(),n=e.getRuntimeAvailability??Ii;async function i(u="app"){const r=await Se(),f=n();if(!t.byId.get(u))throw new Error(`[tuning] Unknown scope: ${u}`);const h=rn({id:u,registry:t,stored:r,runtime:f});return{scopeId:u,runtime:f,stored:r,root:h}}async function o(u,r){await Qe(u,{enginePolicy:r})}async function a(u,r,f){await Qe(u,{params:{[r]:f}})}async function s(u){await kt(u)}async function l(u,r){const g=(await Se())[u];if(!(g!=null&&g.params))return;const h={...g.params??{}};delete h[r];const c=typeof g.enginePolicy=="string",d=Object.keys(h).length>0;if(!c&&!d){await kt(u);return}await Qe(u,{enginePolicy:g.enginePolicy,params:h})}return{getRegistry:()=>t,loadTree:i,setEnginePolicy:o,setParam:a,resetNode:s,resetParam:l}}function K(e,t,n){const i=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))i.setAttribute(o,a);return typeof n=="string"&&(i.textContent=n),i}function It(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function Si(e){return e.fallbackReason?`${e.effectiveEngine} (fallback)`:e.effectiveEngine}function Pi(e){const t=[{value:"native",label:"Native"},{value:"auto",label:"Auto"},...e.canImplementOpenCv?[{value:"opencv",label:"OpenCV"}]:[]];return e.isRoot?t:[{value:"inherit",label:"Inherit"},...t]}function $i(e){return!1}function Ai(e,t,n){var o;const i=(o=e.storedParams)==null?void 0:o[t];return typeof i<"u"&&i!==n}function Ti(e){var g;const{node:t,compId:n,key:i,schema:o,value:a,handlers:s}=e,l=K("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),u=K("label",{class:"fieldInline"}),r=K("span",void 0,o.label);u.appendChild(r);let f;if(o.kind==="number"?(f=K("input"),f.type="number",typeof o.min=="number"&&(f.min=String(o.min)),typeof o.max=="number"&&(f.max=String(o.max)),typeof o.step=="number"&&(f.step=String(o.step)),f.value=String(a??o.default),f.addEventListener("change",()=>{const h=Number(f.value);s.onSetParam(n,i,Number.isFinite(h)?h:o.default)})):o.kind==="boolean"?(f=K("input"),f.type="checkbox",f.checked=!!a,f.addEventListener("change",()=>{s.onSetParam(n,i,!!f.checked)})):(f=K("input"),f.type="text",f.value=String(a??o.default),f.addEventListener("change",()=>{s.onSetParam(n,i,String(f.value??o.default))})),u.appendChild(f),l.appendChild(u),s.onResetParam&&typeof((g=t.storedParams)==null?void 0:g[i])<"u"){const h=K("button",{type:"button"},"Reset");h.addEventListener("click",c=>{var d;c.preventDefault(),(d=s.onResetParam)==null||d.call(s,n,i)}),l.appendChild(h)}return Ai(t,i,a)&&l.appendChild(K("span",{class:"muted",style:"font-size:12px;"},"override")),l}function cn(e){const{node:t,depth:n,isRoot:i,handlers:o,treeScopeId:a}=e,s=K("div",{style:`margin-left:${Math.min(n*14,56)}px; margin-top:10px;`}),l=K("div",{style:"border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:10px; background:rgba(0,0,0,0.12);"}),u=K("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),r=K("div");r.appendChild(K("div",{style:"font-weight:700;"},t.title)),t.description&&r.appendChild(K("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},t.description)),t.isGroup&&r.appendChild(K("div",{class:"muted",style:"font-size:12px; margin-top:2px;"},"Group (policy affects children)")),u.appendChild(r);const f=K("div",{class:"row",style:"align-items:center; gap:10px;"});f.appendChild(K("span",{class:"qBadge"},Si(t)));const g=K("select");g.style.background="rgba(255,255,255,0.05)",g.style.border="1px solid rgba(255,255,255,0.08)",g.style.color="rgba(255,255,255,0.92)",g.style.borderRadius="10px",g.style.padding="6px 8px";const h=Pi({isRoot:i,canImplementOpenCv:t.canImplementOpenCv});for(const x of h){const w=K("option");w.value=x.value,w.textContent=x.label,g.appendChild(w)}const c=new Set(h.map(x=>x.value)),d=t.effectivePolicy;c.has(d)?g.value=d:g.value=i?"native":"inherit",g.addEventListener("change",()=>{o.onSetPolicy(t.id,g.value)}),f.appendChild(g);const m=typeof t.storedPolicy<"u"||t.storedParams&&Object.keys(t.storedParams).length>0;if(o.onResetNode&&m){const x=K("button",{type:"button"},"Reset node");x.addEventListener("click",w=>{var C;w.preventDefault(),(C=o.onResetNode)==null||C.call(o,t.id)}),f.appendChild(x)}u.appendChild(f),l.appendChild(u),t.fallbackReason?l.appendChild(K("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},t.fallbackReason)):t.effectivePolicy==="opencv"&&!t.runtimeOpenCvReady&&l.appendChild(K("div",{class:"muted",style:"margin-top:8px; font-size:12px; line-height:1.4;"},"OpenCV policy selected, but OpenCV is not available at runtime. It will fall back to native."));const v=Object.keys(t.paramsSchema??{}),b=v.length>0,y=t.children.length>0;if(b||y){const x=K("details",{style:"margin-top:10px;"});x.open=$i();const w=K("summary",{style:"cursor:pointer; user-select:none;"},"Details");if(x.appendChild(w),b){const C=K("div",{style:"margin-top:10px;"});C.appendChild(K("div",{class:"muted",style:"font-weight:600; margin-bottom:6px;"},"Parameters"));for(const E of v){const T=t.paramsSchema[E],$=t.effectiveParams[E];C.appendChild(Ti({node:t,compId:t.id,key:E,schema:T,value:$,handlers:o}))}x.appendChild(C)}if(y){const C=K("div",{style:"margin-top:10px;"});for(const E of t.children)C.appendChild(cn({node:E,depth:n+1,isRoot:!1,handlers:o,treeScopeId:a}));x.appendChild(C)}l.appendChild(x)}return s.appendChild(l),s}function dn(e,t){let n=!1;function i(a){if(n)return;It(e);const s=a.scopeId==="app",l=K("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"});l.appendChild(K("div",{style:"font-weight:700;"},"Tuning")),l.appendChild(K("div",{class:"muted",style:"font-size:12px;"},`OpenCV runtime: ${a.runtime.opencvReady?"ready":"not available"}`)),e.appendChild(l),e.appendChild(cn({node:a.root,depth:0,isRoot:s,handlers:t,treeScopeId:a.scopeId}))}function o(){n=!0,It(e)}return{render:i,dispose:o}}function Ri(){let e=!1,t={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},n=!1,i="",o="";function a(r){e=r}function s(r){t={...t,...r}}function l(r){n=r}function u(r){typeof r.general=="string"&&(i=r.general),typeof r.dev=="string"&&(o=r.dev)}return{get showDevTools(){return e},get dev(){return t},get debugEnabled(){return n},get generalStatus(){return i},get devStatus(){return o},setShowDevTools:a,setDev:s,setDebugEnabled:l,setStatus:u}}function Li(e){function t(r){e.settingsGeneralStatusEl.textContent=r||""}function n(r){e.cfgStatusEl.textContent=r||""}function i(r){e.cfgShowDevToolsEl.checked=r}function o(r){e.tabLogs.hidden=!r,e.devConfigDetailsEl.classList.toggle("is-hidden",!r),r||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function a(r){e.cfgTraceConsoleEl.checked=!!r.traceConsole,e.cfgActionLogMaxEl.value=String(r.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(r.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(r.failureLogsPerRun??50)}function s(r){e.logsCbDebugEl.checked=r}function l(r,f){e.settingsVersionEl.textContent=r||"—",e.settingsGitHubLinkEl.href=f||"#",e.settingsGitHubLinkEl.hidden=!f}function u(r){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=r,e.cfgActionLogMaxEl.disabled=r,e.cfgDebugTraceMaxEl.disabled=r,e.cfgFailureLogsPerRunEl.disabled=r,e.btnCfgResetDefaults.disabled=r,e.logsCbDebugEl.disabled=r,e.cfgUseOpenCvEl.disabled=r}return{setGeneralStatus:t,setDevStatus:n,setShowDevToolsChecked:i,setDevToolsVisible:o,setDevConfig:a,setDebugEnabledChecked:s,setAbout:l,setBusy:u}}const et="template.settings.showDevTools",tt="beemage.settings.engine.useOpenCv";function Di(){var e,t;try{const n=(e=globalThis==null?void 0:globalThis.chrome)==null?void 0:e.runtime,i=(t=n==null?void 0:n.getManifest)==null?void 0:t.call(n),o=typeof(i==null?void 0:i.version)=="string"?i.version:"";if(F("Settings: getManifestVersion manifest found version is ",{v:o}),o)return o}catch{}return F("Settings: getManifestVersion fallback",{APP_VERSION:Et}),Et}function nt(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??te.actionLogMax),debugTraceMax:Number(e.debugTraceMax??te.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??te.failureLogsPerRun)}}function Mi(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:le(e.cfgActionLogMaxEl.value,100,5e4,te.actionLogMax),debugTraceMax:le(e.cfgDebugTraceMaxEl.value,100,5e4,te.debugTraceMax),failureLogsPerRun:le(e.cfgFailureLogsPerRunEl.value,0,5e4,te.failureLogsPerRun)}}async function xt(e){const t=Xt;return typeof t.setEnabled=="function"?(await t.setEnabled(e),{ok:!0}):typeof t.enable=="function"&&typeof t.disable=="function"?(await(e?t.enable():t.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function Oi(e,t){const n=Ri(),i=Li(e),o=ln({getRuntimeAvailability:()=>({opencvReady:e.cfgUseOpenCvEl.checked&&me()})}),a=dn(e.tuningMountEl,{onSetPolicy:async(p,I)=>{await o.setEnginePolicy(p,I),await y("policy change")},onSetParam:async(p,I,R)=>{await o.setParam(p,I,R),await y("param change")},onResetNode:async p=>{await o.resetNode(p),await y("reset node")},onResetParam:async(p,I)=>{await o.resetParam(p,I),await y("reset param")}});function s(p){e.settingsEngineBoxEl.classList.toggle("is-hidden",!1)}async function l(){const p=await ce([tt]).catch(()=>({}));return(p==null?void 0:p[tt])===!0}async function u(p){await de({[tt]:!!p}).catch(()=>null)}function r(p){var I;e.cfgUseOpenCvEl.checked=p,(I=e.cfgUseOpenCvEl.closest(".switch"))==null||I.classList.toggle("is-disabled",e.cfgUseOpenCvEl.disabled)}function f(p){e.cfgOpenCvSpinner.classList.toggle("is-hidden",!p),e.cfgOpenCvSpinner.setAttribute("aria-hidden",p?"false":"true")}function g(p){e.cfgOpenCvStatus.textContent=p||""}function h(p){e.cfgOpenCvReport.textContent=p||""}async function c(){if(ee())return;if(!!!e.cfgUseOpenCvEl.checked){await u(!1),f(!1),g(me()?"OpenCV loaded (native mode)":"Native mode"),h("Native mode. OpenCV is optional and demo-only."),await y("opencv mode disabled");return}f(!0),g("Loading OpenCV…"),h("Loading OpenCV…");try{if(await ui(e,async()=>{await bi()}),!me())throw new Error("OpenCV load returned but runtime is not injected.");await u(!0),g("OpenCV mode enabled"),h("OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV."),await y("opencv mode enabled")}catch(I){const R=String((I==null?void 0:I.message)??I);await u(!1),r(!1),g("OpenCV load failed"),h(`ERROR

${R}`),he("[settings] OpenCV toggle failed",{msg:R})}finally{f(!1)}}async function d(){const p=await ce([et]).catch(()=>({}));return(p==null?void 0:p[et])===!0}async function m(p){await de({[et]:!!p}).catch(()=>null)}function v(p){n.setShowDevTools(p),i.setShowDevToolsChecked(p),i.setDevToolsVisible(p)}async function b(){const p=await d();v(p),F("Settings: boot applyDevToolsVisibility",{showDevTools:p})}async function y(p){try{const I=await o.loadTree("app");a.render(I),F("[settings] tuning rendered",{reason:p,opencvInjected:me(),opencvMode:!!e.cfgUseOpenCvEl.checked})}catch(I){he("[settings] tuning render failed",{reason:p,msg:String((I==null?void 0:I.message)??I)}),e.tuningMountEl.textContent="Tuning UI failed to load (see console)."}}async function x(){var A;i.setBusy(ee());const p=await d();v(p),await at().catch(()=>null);const I=Ue();n.setDev(nt(I)),i.setDevConfig(n.dev);const R=Xt;let B=!1;try{typeof R.isEnabled=="function"?B=!!await R.isEnabled():B=!!R.enabled}catch(k){Me("Settings: failed to read debug enabled state",{error:k instanceof Error?k.message:String(k)})}n.setDebugEnabled(B),i.setDebugEnabledChecked(B),i.setAbout(Di()||"—",((A=e.settingsGitHubLinkEl)==null?void 0:A.href)||"#"),s();{const k=await l();r(k),f(!1);const S=me();k?(g(S?"OpenCV mode enabled":"OpenCV mode (not loaded)"),h(S?"OpenCV injected and mode enabled. Pipeline steps may opt into OpenCV.":"OpenCV mode is enabled, but OpenCV is not loaded yet. Toggle OFF then ON to load OpenCV.")):(g(S?"OpenCV loaded (native mode)":"Native mode"),h("Native mode. OpenCV is optional and demo-only."))}i.setGeneralStatus(""),i.setDevStatus(""),await y("loadAll"),F("Settings: loaded",{showDevTools:p,debugTraceEnabled:B,dev:n.dev,opencvInjected:me()})}async function w(){const p=!!e.cfgShowDevToolsEl.checked;v(p),await m(p),j({kind:"run",scope:"settings",message:p?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:p}}),F("Settings: ui toggle showDevTools",{showDevTools:p}),i.setGeneralStatus(p?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>i.setGeneralStatus(""),1200)}async function C(){const p=Mi(e);i.setDevStatus("Saving…");try{await Ht(p)}catch(I){he("Settings: failed to save dev config",{error:I instanceof Error?I.message:String(I),next:p}),i.setDevStatus("Save failed."),setTimeout(()=>i.setDevStatus(""),1200);return}n.setDev(nt(p)),i.setDevConfig(n.dev),j({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:p}),F("Settings: devConfig updated",p),i.setDevStatus("Saved."),setTimeout(()=>i.setDevStatus(""),1200)}async function E(){i.setDevStatus("Resetting…");try{await zn(),await at().catch(()=>null);const I=Ue();n.setDev(nt(I)),i.setDevConfig(n.dev)}catch(I){he("Settings: failed to reset dev config defaults",{error:I instanceof Error?I.message:String(I)}),i.setDevStatus("Reset failed."),setTimeout(()=>i.setDevStatus(""),1200);return}const p=await xt(!1);p.ok?(n.setDebugEnabled(!1),i.setDebugEnabledChecked(!1)):(Me("Settings: failed to reset debug enabled state",{error:p.error||"unknown error"}),j({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:p.error||"unknown error"})),j({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...te,debugEnabled:!1}}),F("Settings: reset defaults",{...te,debugEnabled:!1}),i.setDevStatus("Reset."),setTimeout(()=>i.setDevStatus(""),1200)}async function T(){const p=!!e.logsCbDebugEl.checked;i.setDevStatus("Saving…");const I=await xt(p);if(!I.ok){e.logsCbDebugEl.checked=!p,i.setDevStatus(`Save failed: ${I.error||"unknown error"}`),he("Settings: failed to change debug enabled state",{error:I.error||"unknown error",enabled:p}),j({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:I.error||"unknown error",meta:{enabled:p}});return}n.setDebugEnabled(p),j({kind:"run",scope:"settings",message:p?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:p}}),F("Settings: debug enabled changed",{enabled:p}),i.setDevStatus("Saved."),setTimeout(()=>i.setDevStatus(""),1200)}const $=t.on(()=>{});function O(){e.cfgShowDevToolsEl.addEventListener("change",()=>{w()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{ee()||C()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{ee()||C()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{ee()||C()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{ee()||C()}),e.btnCfgResetDefaults.addEventListener("click",()=>{ee()||E()}),e.logsCbDebugEl.addEventListener("change",()=>{ee()||T()}),e.cfgUseOpenCvEl.addEventListener("change",()=>{c()}),b().catch(p=>{Me("Settings: initDevToolsVisibility failed",{error:p instanceof Error?p.message:String(p)})})}return{id:"settings",refresh(){x().catch(p=>{he("Settings: refresh failed",{error:p instanceof Error?p.message:String(p)})})},mount(){x().catch(p=>{he("Settings: mount failed",{error:p instanceof Error?p.message:String(p)})})},unmount(){},bind:O,dispose(){$()}}}function Bi(){let e=[],t=0;function n(i){e=i.items,t=i.total}return{get items(){return e},get total(){return t},set:n}}function Ui(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function St(e,t){const n=[];n.push(`Total entries: ${t.total}`),n.push("");for(const i of t.items){const o=typeof i.ok=="boolean"?i.ok?"ok":"fail":"",a=[];typeof i.status=="number"&&a.push(`status=${i.status}`),o&&a.push(o);const s=[i.scope,i.kind].filter(Boolean).join("/");n.push(`[${Ui(i.ts)}] ${s}${a.length?` (${a.join(", ")})`:""}`),n.push(`  ${i.message}`),i.error&&n.push(`  error: ${i.error}`),n.push("")}e.textContent=n.join(`
`),e.scrollTop=0}function zi(e){function t(s){e.logsStatusEl.textContent=s}function n(s){e.debugStatusEl.textContent=s}function i(s){e.logsCbDebugEl.checked=s}function o(s){St(e.logsOutEl,{total:s.total,items:s.items.map(l=>({ts:l.ts,message:l.message,scope:l.scope,kind:l.kind,ok:l.ok,status:l.status,error:l.error,meta:l.meta}))})}function a(s){St(e.debugOutEl,{total:s.total,items:s.items.map(l=>({ts:l.ts,message:l.message,scope:l.scope,kind:l.kind,ok:l.ok,status:l.status,error:l.error,meta:l.meta}))})}return{setAuditStatus:t,setDebugStatus:n,setDebugChecked:i,renderAudit:o,renderDebug:a}}const Pt="beemage";function Vi(e,t){const n=Bi(),i=zi(e);async function o(){i.setAuditStatus("Loading…"),se(e,!0);try{const d=le(e.logsLimitEl.value,10,5e3,200),m=await Hn({limit:d,reverse:!0});n.set(m),i.renderAudit({items:n.items,total:n.total}),i.setAuditStatus(`Showing ${n.items.length} (newest first)`)}catch(d){i.setAuditStatus(`Failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{se(e,!1)}}async function a(){i.setDebugStatus("Loading…"),se(e,!0);try{const d=le(e.debugLimitEl.value,10,5e3,200),m=await Zt({limit:d,reverse:!0});i.renderDebug(m),i.setDebugStatus(`Showing ${m.items.length} (newest first)`)}catch(d){i.setDebugStatus(`Failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{se(e,!1)}}async function s(){const d=await ht();i.setDebugChecked(d)}async function l(d){if(await Jt(d),i.setDebugChecked(d),!d){i.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}i.setDebugStatus("Debug ON."),await a()}async function u(){const d=le(e.logsTrimKeepEl.value,0,5e4,2e3);i.setAuditStatus("Trimming…"),se(e,!0);try{const m=await Wn({keepLast:d});await o(),i.setAuditStatus(`Trimmed. Remaining: ${m.total}`)}catch(m){i.setAuditStatus(`Trim failed: ${(m==null?void 0:m.message)||String(m)}`)}finally{se(e,!1)}}async function r(){i.setAuditStatus("Clearing…"),se(e,!0);try{await Jn(),await o(),i.setAuditStatus("Cleared.")}catch(d){i.setAuditStatus(`Clear failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{se(e,!1)}}async function f(){i.setAuditStatus("Exporting…");try{const d=await qn({pretty:!0}),m=new Blob([d],{type:"application/json"}),v=URL.createObjectURL(m),b=document.createElement("a");b.href=v,b.download=`${Pt}-audit-${Date.now()}.json`,b.click(),setTimeout(()=>URL.revokeObjectURL(v),1e3),i.setAuditStatus("Exported.")}catch(d){i.setAuditStatus(`Export failed: ${(d==null?void 0:d.message)||String(d)}`)}}async function g(){i.setDebugStatus("Clearing…"),se(e,!0);try{await qt(),await a(),i.setDebugStatus("Cleared.")}catch(d){i.setDebugStatus(`Clear failed: ${(d==null?void 0:d.message)||String(d)}`)}finally{se(e,!1)}}async function h(){i.setDebugStatus("Exporting…");try{const d=await Yt({pretty:!0}),m=new Blob([d],{type:"application/json"}),v=URL.createObjectURL(m),b=document.createElement("a");b.href=v,b.download=`${Pt}-debug-${Date.now()}.json`,b.click(),setTimeout(()=>URL.revokeObjectURL(v),1e3),i.setDebugStatus("Exported.")}catch(d){i.setDebugStatus(`Export failed: ${(d==null?void 0:d.message)||String(d)}`)}}function c(){e.btnLogsRefresh.addEventListener("click",()=>{ee()||o()}),e.btnLogsTrim.addEventListener("click",()=>{ee()||u()}),e.btnLogsClear.addEventListener("click",()=>{ee()||r()}),e.btnLogsExport.addEventListener("click",()=>{ee()||f()}),e.logsCbDebugEl.addEventListener("change",()=>{ee()||l(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{ee()||a()}),e.btnDebugClear.addEventListener("click",()=>{ee()||g()}),e.btnDebugExport.addEventListener("click",()=>{ee()||h()})}return{id:"logs",bind:c,mount(){s(),o(),a()},unmount(){},dispose(){}}}function Ni(e,t){if(e.id===t)return e;const n=[...e.children??[]];for(;n.length>0;){const i=n.shift();if(i.id===t)return i;for(const o of i.children??[])n.push(o)}throw new Error(`[tuning] scopeRootId not found in VM tree: ${t}`)}function _i(e,t){if(e.id===t)return e;const n=[...e.children??[]];for(;n.length>0;){const i=n.shift();if(i.id===t)return i;for(const o of i.children??[])n.push(o)}return null}function ji(e){const t=ln({getRuntimeAvailability:e.getRuntimeAvailability}),n=[];let i=!1;async function o(){return await t.loadTree("app")}async function a(){if(i)return;const b=await o();for(const y of n){if(y.scopeRootId==="app"){y.view.render(b);continue}const x=Ni(b.root,y.scopeRootId);y.view.render({...b,scopeId:y.scopeRootId,root:x})}}async function s(b,y){await t.setEnginePolicy(b,y),e.actionLogAppend(`[tuning] policy ${b} = ${y}`),e.debugTraceAppend(`[tuning] setPolicy id=${b} policy=${y}`),await a()}async function l(b,y,x){await t.setParam(b,y,x),e.actionLogAppend(`[tuning] param ${b}.${y} = ${String(x)}`),e.debugTraceAppend(`[tuning] setParam id=${b} key=${y} value=${String(x)}`),await a()}async function u(b){await t.resetNode(b),e.actionLogAppend(`[tuning] reset node ${b}`),e.debugTraceAppend(`[tuning] resetNode id=${b}`),await a()}async function r(b,y){await t.resetParam(b,y),e.actionLogAppend(`[tuning] reset param ${b}.${y}`),e.debugTraceAppend(`[tuning] resetParam id=${b} key=${y}`),await a()}async function f(b){var y,x;if(!i){if(b.policies)for(const w of b.policies)await t.setEnginePolicy(w.id,w.policy);if(b.params)for(const w of b.params)await t.setParam(w.id,w.key,w.value);e.actionLogAppend(`[tuning] preset ${b.id} (${b.title})`),e.debugTraceAppend(`[tuning] applyPreset id=${b.id} title=${b.title} policies=${((y=b.policies)==null?void 0:y.length)??0} params=${((x=b.params)==null?void 0:x.length)??0}`),await a()}}async function g(b){const y=await o(),x=_i(y.root,b);if(!x)throw new Error(`[tuning] getEffectiveParams: unknown component id ${b}`);return{...x.effectiveParams??{}}}async function h(b,y,x){await t.setParam(b,y,x),e.actionLogAppend(`[tuning] param ${b}.${y} = ${String(x)}`),e.debugTraceAppend(`[tuning] setParamValue id=${b} key=${y} value=${String(x)}`),await a()}function c(b){if(i)return;const{mountEl:y,scopeRootId:x}=b;if(n.some(C=>C.mountEl===y))return;const w=dn(y,{onSetPolicy:s,onSetParam:l,onResetNode:u,onResetParam:r});n.push({mountEl:y,scopeRootId:x,view:w}),a()}function d(b){const y=n.findIndex(x=>x.mountEl===b);y<0||(n[y].view.dispose(),n.splice(y,1))}async function m(){await a()}function v(){i=!0;for(const b of n)b.view.dispose();n.length=0}return{mount:c,unmount:d,refresh:m,applyPreset:f,getEffectiveParams:g,setParamValue:h,dispose:v}}function ie(e,t,n){const i=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))i.setAttribute(o,a);return typeof n=="string"&&(i.textContent=n),i}function Fi(e){const t=[{kind:"input",type:e.io.input}],n=[{kind:"output",type:e.io.output}];return{id:e.id,title:e.title,group:e.group,inputs:t,outputs:n}}function Gi(e){const t=String(e||"").toLowerCase();return t==="image"?"opPort--image":t==="mask"?"opPort--mask":t==="svg"?"opPort--svg":"opPort--unknown"}function Ki(e){const{kind:t,type:n}=e,i="http://www.w3.org/2000/svg",o=document.createElementNS(i,"svg");o.setAttribute("viewBox","0 0 48 20"),o.setAttribute("width","48"),o.setAttribute("height","20"),o.setAttribute("aria-hidden","true"),o.classList.add("opPort__glyph");const a=String(n||"").toLowerCase(),s=t==="output",l=document.createElementNS(i,"rect");l.setAttribute("x","1"),l.setAttribute("y","3"),l.setAttribute("width","46"),l.setAttribute("height","14"),l.setAttribute("rx","7"),l.setAttribute("ry","7"),l.classList.add("opPort__glyphTrack"),o.appendChild(l);const u=document.createElementNS(i,"path");u.classList.add("opPort__glyphShape");const r=(m,v,b)=>Math.max(v,Math.min(b,m)),f=24,g=10,h=7,d=r((a==="mask"?12:a==="svg"||a==="image"?14:12)/2,4,10);if(a==="image")if(s){const m=f-d,v=f+d+h,b=g-6,y=g+6;u.setAttribute("d",`M ${m} ${b} L ${v} ${g} L ${m} ${y} Z`)}else{const m=f+d,v=f-d-h,b=g-6,y=g+6;u.setAttribute("d",`M ${m} ${b} L ${v} ${g} L ${m} ${y} Z`),u.classList.add("opPort__glyphShape--socket")}else if(a==="svg")if(s){const m=f-d,v=d*2+h;u.setAttribute("d",[`M ${m} ${g-6}`,`h ${v}`,"a 6 6 0 0 1 0 12",`h ${-v}`,"a 6 6 0 0 1 0 -12","Z"].join(" "))}else{const m=f+d,v=d*2+h;u.setAttribute("d",[`M ${m} ${g-6}`,`h ${-v}`,"a 6 6 0 0 0 0 12",`h ${v}`,"a 6 6 0 0 0 0 -12","Z"].join(" ")),u.classList.add("opPort__glyphShape--socket")}else if(s){const m=f-d,v=d*2+h;u.setAttribute("d",`M ${m} ${g-6} h ${v} v 12 h ${-v} Z`)}else{const m=f+d,v=d*2+h;u.setAttribute("d",`M ${m} ${g-6} h ${-v} v 12 h ${v} Z`),u.classList.add("opPort__glyphShape--socket")}return o.appendChild(u),o}function Hi(e){const{port:t,getPortClass:n}=e,i=`opPort ${n(t.type)}`,o=t.label?`${t.label}: ${t.type}`:String(t.type);return ie("div",{class:i,"data-port-kind":t.kind,"data-port-type":String(t.type)},o)}function Wi(e){const{port:t,getPortClass:n}=e,i=`opPort opPort--puzzle ${n(t.type)}`,o=ie("div",{class:i,"data-port-kind":t.kind,"data-port-type":String(t.type)}),a=t.label?t.label:String(t.type);o.appendChild(ie("div",{class:"opPort__puzzleLabel"},a));const s=Ki({kind:t.kind,type:t.type});return o.appendChild(s),o}function $t(e){const{ports:t,kind:n,portStyle:i,getPortClass:o}=e,a=ie("div",{class:"opCard__portsRow"}),s=ie("div",{class:"opCard__portsLabel"},n==="input"?"IN":"OUT");a.appendChild(s);const l=ie("div",{class:"opCard__ports"});for(const u of t){const r=i==="puzzle"?Wi({port:u,getPortClass:o}):Hi({port:u,getPortClass:o});l.appendChild(r)}return a.appendChild(l),a}function ge(e,t,n){return Math.max(t,Math.min(n,e))}function je(e){const t=String(e||"").toLowerCase();return t==="image"?"image":t==="mask"?"mask":t==="svg"?"svg":"unknown"}function Fe(e){return e==="image"?{w:34,d:7,shape:"circle"}:e==="svg"?{w:30,d:7,shape:"triangle"}:e==="mask"?{w:28,d:6,shape:"rect"}:{w:26,d:6,shape:"rect"}}function Ji(e){return`url("data:image/svg+xml,${encodeURIComponent(e).replace(/'/g,"%27").replace(/"/g,"%22")}")`}function qi(e){const{root:t,inType:n,outType:i}=e,o=je(n),a=je(i),s=Fe(o),l=Fe(a),u=Zi({inType:n,outType:i}),r=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 110" preserveAspectRatio="none">
    <path d="${u}" fill="white"/>
  </svg>`,f=Ji(r);t.style.webkitMaskImage=f,t.style.webkitMaskRepeat="no-repeat",t.style.webkitMaskSize="100% 100%",t.style.webkitMaskPosition="center",t.style.maskImage=f,t.style.maskRepeat="no-repeat",t.style.maskSize="100% 100%",t.style.maskPosition="center",t.classList.add("opCard--puzzleFrame"),t.style.position="relative",t.style.border="none",t.style.overflow="visible",t.style.minWidth="0";let g=t.querySelector(":scope > svg.opCard__puzzleOutline");if(!g)g=document.createElementNS("http://www.w3.org/2000/svg","svg"),g.classList.add("opCard__puzzleOutline"),g.setAttribute("viewBox","0 0 100 110"),g.setAttribute("preserveAspectRatio","none"),g.innerHTML=`<path d="${u}" fill="none" stroke="rgba(255,255,255,0.18)" stroke-width="1.5"/>`,t.insertBefore(g,t.firstChild);else{const y=g.querySelector("path");y&&y.setAttribute("d",u)}const h=t.classList.contains("opCard--compact"),c=h?22:26,d=h?16:18,m=h?16:18,v=d+Math.round(s.d*.9),b=m+Math.round(l.d*.9);t.style.setProperty("--opPuzzleInsetX",`${c}px`),t.style.setProperty("--opPuzzleInsetTop",`${v}px`),t.style.setProperty("--opPuzzleInsetBottom",`${b}px`)}function Zi(e){const l=je(e.inType),u=je(e.outType),r=Fe(l),f=Fe(u),g=50,h=ge(r.w,18,40),c=ge(r.d,6,12),d=ge(f.w,18,40),m=Math.max(6,Math.min(12,8)),v=ge(f.d,6,m),b=ge(g-h/2,20,80),y=ge(g+h/2,20,80),x=ge(g-d/2,20,80),w=ge(g+d/2,20,80);function C(){if(r.shape==="triangle")return`L ${g} ${0+c} L ${y} 0`;if(r.shape==="circle"){const T=b,$=y,O=$-T,p=c,I=Math.max(6,O*.25),R=T+O/2;return[`C ${T+I} 0 ${T+I} ${0+p} ${R} ${0+p}`,`C ${$-I} ${0+p} ${$-I} 0 ${$} 0`].join(" ")}return`V ${0+c} H ${y} V 0`}function E(){if(f.shape==="triangle")return`L ${g} ${100+v} L ${x} 100`;if(f.shape==="circle"){const T=w,$=x,O=T-$,p=v,I=Math.max(6,O*.25),R=$+O/2;return[`C ${T-I} 100 ${T-I} ${100+p} ${R} ${100+p}`,`C ${$+I} ${100+p} ${$+I} 100 ${$} 100`].join(" ")}return`V ${100+v} H ${x} V 100`}return["M 16 0",`H ${b}`,C(),"H 84","A 10 10 0 0 1 94 10","V 90","A 10 10 0 0 1 84 100",`H ${w}`,E(),"H 16","A 10 10 0 0 1 6 90","V 10","A 10 10 0 0 1 16 0","Z"].join(" ")}function He(e,t){const n=Fi(e),i={compact:!!(t!=null&&t.compact),showId:(t==null?void 0:t.showId)??!0,showGroup:(t==null?void 0:t.showGroup)??!0,portStyle:(t==null?void 0:t.portStyle)??"chip",cardStyle:(t==null?void 0:t.cardStyle)??"plain",getPortClass:(t==null?void 0:t.getPortClass)??Gi,onClick:t==null?void 0:t.onClick},o=ie("div",{class:`opCard${i.compact?" opCard--compact":""}`,"data-op-id":n.id}),a=ie("div",{class:"opCard__content"}),s=ie("div",{class:"opCard__head"}),l=ie("div",{class:"opCard__title"},n.title);s.appendChild(l);const u=ie("div",{class:"opCard__meta"});i.showGroup&&n.group&&u.appendChild(ie("span",{class:"opBadge opBadge--group"},n.group)),i.showId&&u.appendChild(ie("span",{class:"opBadge opBadge--id"},n.id)),s.appendChild(u),a.appendChild(s);const r=ie("div",{class:"opCard__body"});return r.appendChild($t({ports:n.inputs,kind:"input",portStyle:i.portStyle,getPortClass:i.getPortClass})),r.appendChild($t({ports:n.outputs,kind:"output",portStyle:i.portStyle,getPortClass:i.getPortClass})),a.appendChild(r),o.appendChild(a),i.cardStyle==="puzzleFrame"&&qi({root:o,inType:e.io.input,outType:e.io.output}),i.onClick&&(o.classList.add("opCard--clickable"),o.addEventListener("click",f=>{var g,h;(g=f.preventDefault)==null||g.call(f),(h=i.onClick)==null||h.call(i,n.id)})),o}function V(e,t,n){const i=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))i.setAttribute(o,a);return typeof n=="string"&&(i.textContent=n),i}function Yi(e){return e.type==="image"}function Xi(e){return e.type==="mask"}function Qi(e){return e.type==="svg"}function un(e){return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(e)}`}function At(e,t){if(Yi(e)){const i=V("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return Oe(i,e.image),i}if(Xi(e)){const i=V("canvas",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`});return ct(i,e.mask,e.width,e.height),i}if(!Qi(e))return V("div",{class:"muted",style:"margin-top:8px; font-size:12px;"},`Unsupported output: ${String(e.type)}`);const n=V("img",{class:"canvas",style:`margin-top:8px; display:block; margin-left:auto; margin-right:auto; max-width:100%; max-height:${t}px; width:auto; height:auto;`,"aria-label":"SVG preview"});return n.src=un(e.svg),n}function pn(e,t){const n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download=e,i.rel="noopener",i.click(),setTimeout(()=>URL.revokeObjectURL(n),500)}async function Tt(e,t){const n=await new Promise(i=>t.toBlob(o=>i(o),"image/png"));if(!n)throw new Error("Failed to create PNG blob.");pn(e,n)}function Oe(e,t){e.width=t.width,e.height=t.height;const n=e.getContext("2d",{willReadFrequently:!0});n&&n.putImageData(t,0,0)}function ct(e,t,n,i){e.width=n,e.height=i;const o=e.getContext("2d",{willReadFrequently:!0});if(!o)return;let a=0;const s=n*i;for(let f=0;f<s;f++){const g=t[f]??0;g>a&&(a=g)}const l=a<=1,u=o.createImageData(n,i),r=u.data;for(let f=0;f<s;f++){const g=t[f]??0;let h;l?h=(g>0?1:0)?0:255:h=g;const c=f*4;r[c]=h,r[c+1]=h,r[c+2]=h,r[c+3]=255}o.putImageData(u,0,0)}function eo(e){const{hostEl:t,statusEl:n,handlers:i}=e;let o=!1,a=null,s=null,l=null,u=null,r=null,f=null,g=null,h=null,c=null,d=null,m=null,v=null,b=null;function y(){for(;t.firstChild;)t.removeChild(t.firstChild)}async function x(p){var D,M,z,L,N;const R=(typeof(p==null?void 0:p.activePipelineId)=="string"?p.activePipelineId:"pipeline").replace(/[^a-z0-9_-]+/gi,"_").slice(0,40)||"pipeline",B=(D=p==null?void 0:p.outputSvg)==null?void 0:D.svg;if(typeof B=="string"&&B.length>0){const U=new Blob([B],{type:"image/svg+xml;charset=utf-8"});pn(`beemage-${R}.svg`,U);return}const A=(M=p==null?void 0:p.outputImage)==null?void 0:M.data;if(A){const U=document.createElement("canvas");Oe(U,A),await Tt(`beemage-${R}.png`,U);return}const k=(z=p==null?void 0:p.outputMask)==null?void 0:z.data,S=(L=p==null?void 0:p.outputMask)==null?void 0:L.width,P=(N=p==null?void 0:p.outputMask)==null?void 0:N.height;if(k&&typeof S=="number"&&typeof P=="number"){const U=document.createElement("canvas");ct(U,k,S,P),await Tt(`beemage-${R}-mask.png`,U);return}throw new Error("No output to download.")}function w(){if(o)return;o=!0,y(),a=V("div",{class:"card"}),h=V("p",{class:"muted",style:"margin-top:0;"},"Universal pipeline runner. Select a pipeline and run it.");const p=V("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap;"}),I=V("label",{class:"fieldInline"});I.appendChild(V("span",{},"Pipeline")),s=V("select"),I.appendChild(s);const R=V("label",{class:"fieldInline"});R.appendChild(V("span",{},"Recipe")),l=V("select"),R.appendChild(l),u=V("button",{type:"button"},"Run all"),r=V("button",{type:"button"},"Next step"),f=V("button",{type:"button"},"Reset"),g=V("button",{type:"button"},"Download"),p.appendChild(I),p.appendChild(R),p.appendChild(u),p.appendChild(r),p.appendChild(f),p.appendChild(g);const B=V("div",{class:"grid4",style:"margin-top:12px;"}),A=V("div",{class:"card"});A.appendChild(V("div",{class:"cardTitle"},"Input (from source)")),c=V("canvas",{class:"canvas","aria-label":"Pipeline input preview"}),A.appendChild(c);const k=V("div",{class:"card"});k.appendChild(V("div",{class:"cardTitle"},"Current output")),d=V("canvas",{class:"canvas","aria-label":"Pipeline current output preview"}),m=V("img",{class:"canvas","aria-label":"Pipeline SVG output preview",style:"display:none;"}),k.appendChild(d),k.appendChild(m);const S=V("div",{class:"card",style:"grid-column:1 / -1;"});S.appendChild(V("div",{class:"cardTitle"},"Stages")),v=V("div"),S.appendChild(v),B.appendChild(A),B.appendChild(k),B.appendChild(S),a.appendChild(h),a.appendChild(p),a.appendChild(B),t.appendChild(a),s.addEventListener("change",()=>{const P=s?s.value:"segmentation";i.onSelectPipeline(P)}),l.addEventListener("change",()=>{const P=l?l.value:"default";i.onSelectRecipe(P)}),u.addEventListener("click",()=>i.onRunAll()),r.addEventListener("click",()=>i.onNext()),f.addEventListener("click",()=>i.onReset()),g.addEventListener("click",async()=>{try{await x(b)}catch(P){const D=P instanceof Error?P.message:String(P);n.textContent=`Download failed: ${D}`}})}function C(p){if(!s||!l)return;const I=Array.isArray(p==null?void 0:p.pipelines)?p.pipelines:[],R=Array.isArray(p==null?void 0:p.recipes)?p.recipes:[],B=typeof(p==null?void 0:p.activePipelineId)=="string"?p.activePipelineId:"segmentation",A=typeof(p==null?void 0:p.activeRecipeId)=="string"?p.activeRecipeId:"default";s.innerHTML="";for(const k of I){const S=V("option");S.value=k.id,S.textContent=k.title,k.id===B&&(S.selected=!0),s.appendChild(S)}l.innerHTML="";for(const k of R){const S=V("option");S.value=k.id,S.textContent=k.title,k.id===A&&(S.selected=!0),l.appendChild(S)}}function E(p){var R;if(!c)return;const I=(R=p==null?void 0:p.input)==null?void 0:R.data;if(!I){c.width=1,c.height=1;const B=c.getContext("2d");B&&B.clearRect(0,0,c.width,c.height);return}Oe(c,I)}function T(p){var P,D,M,z,L;if(!d||!m)return;const I=(P=p==null?void 0:p.outputSvg)==null?void 0:P.svg;if(typeof I=="string"&&I.length>0){d.style.display="none",m.style.display="block",m.src=un(I);return}d.style.display="block",m.style.display="none",m.src="";const R=(D=p==null?void 0:p.outputImage)==null?void 0:D.data;if(R){Oe(d,R);return}const B=(M=p==null?void 0:p.outputMask)==null?void 0:M.data,A=(z=p==null?void 0:p.outputMask)==null?void 0:z.width,k=(L=p==null?void 0:p.outputMask)==null?void 0:L.height;if(B&&typeof A=="number"&&typeof k=="number"){ct(d,B,A,k);return}d.width=1,d.height=1;const S=d.getContext("2d");S&&S.clearRect(0,0,d.width,d.height)}function $(p){if(!v)return;v.innerHTML="";const I=Array.isArray(p==null?void 0:p.stages)?p.stages:[];if(!I.length){v.appendChild(V("div",{class:"muted",style:"font-size:12px;"},"No stages."));return}const R=V("div",{style:"display:flex; flex-direction:column; gap:10px;"});for(const B of I)R.appendChild(O(B));v.appendChild(R)}function O(p){const I=V("div",{class:"card",style:"padding:10px;"}),R=V("div",{class:"row",style:"align-items:center; justify-content:space-between;"});R.appendChild(V("div",{style:"font-weight:bold;"},String(p.title??p.stageId))),R.appendChild(V("div",{class:"status"},String(p.state??"idle"))),I.appendChild(R),I.appendChild(V("div",{class:"muted",style:"font-size:12px;"},`${p.input} -> ${p.output}`)),typeof p.error=="string"&&p.error.length>0&&I.appendChild(V("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Stage error: ${p.error}`));const B=p.outputArtifact;B&&I.appendChild(At(B,260));const A=Array.isArray(p.ops)?p.ops:[];if(A.length){const k=V("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:8px;"});for(let S=0;S<A.length;S++){const P=A[S],D=S===A.length-1,M=V("div",{class:"card",style:"padding:8px;"}),z=V("div",{class:"row",style:"align-items:center; justify-content:space-between; gap:10px;"}),L={id:String(P.opId??""),title:String(P.title??P.opId??"Operation"),io:{input:P.input,output:P.output},group:P.group},N=He(L,{compact:!0,showGroup:!0,showId:!0,portStyle:"puzzle",cardStyle:"plain"});z.appendChild(N),z.appendChild(V("div",{class:"status"},String(P.state??"idle"))),M.appendChild(z),typeof P.error=="string"&&P.error.length>0&&M.appendChild(V("div",{style:"margin-top:6px; font-size:12px; white-space:pre-wrap;"},`Op error: ${P.error}`));const U=B&&D?void 0:P.outputArtifact;U&&M.appendChild(At(U,200)),k.appendChild(M)}I.appendChild(k)}return I}return{mount(){w()},render(p){var I,R,B;if(w(),b=p,C(p),n.textContent=typeof(p==null?void 0:p.statusText)=="string"?p.statusText:"Idle",h){const A=typeof(p==null?void 0:p.description)=="string"?p.description:"Universal pipeline runner.";h.textContent=A}if(g){const A=typeof((I=p==null?void 0:p.outputSvg)==null?void 0:I.svg)=="string"&&p.outputSvg.svg.length>0,k=!!((R=p==null?void 0:p.outputImage)!=null&&R.data),S=!!((B=p==null?void 0:p.outputMask)!=null&&B.data);g.disabled=!(A||k||S)}E(p),T(p),$(p)},dispose(){o=!1,a=null,s=null,l=null,u=null,r=null,f=null,g=null,h=null,c=null,d=null,m=null,v=null,b=null,y()}}}function $e(e,t){return e.find(n=>n.id===t)??null}function oe(e,t){return{input:e,output:t}}function Rt(e,t){return`${e}.${t+1}`}function dt(e){const t=[{kind:"dispatch",id:"op.seg.resize",title:"Resize",io:oe("image","image"),dispatchId:"segmentation.resize",tuningId:"segmentation.resize",group:"Segmentation"},{kind:"dispatch",id:"op.seg.denoise",title:"Denoise",io:oe("image","image"),dispatchId:"segmentation.denoise",tuningId:"segmentation.denoise",group:"Segmentation"},{kind:"dispatch",id:"op.seg.color",title:"Color / Gray",io:oe("image","image"),dispatchId:"segmentation.color",tuningId:"segmentation.color",group:"Segmentation"},{kind:"dispatch",id:"op.seg.threshold",title:"Threshold",io:oe("image","mask"),dispatchId:"segmentation.threshold",tuningId:"segmentation.threshold",group:"Segmentation"},{kind:"dispatch",id:"op.seg.morphology",title:"Morphology cleanup",io:oe("mask","mask"),dispatchId:"segmentation.morphology",tuningId:"segmentation.morphology",group:"Segmentation"},{kind:"dispatch",id:"op.edge.resize",title:"Resize",io:oe("image","image"),dispatchId:"edge.resize",tuningId:"edge.resize",group:"Edge"},{kind:"dispatch",id:"op.edge.threshold",title:"Threshold",io:oe("image","mask"),dispatchId:"edge.threshold",tuningId:"edge.threshold",group:"Edge"},{kind:"dispatch",id:"op.edge.morphology",title:"Morphology cleanup",io:oe("mask","mask"),dispatchId:"edge.morphology",tuningId:"edge.morphology",group:"Edge"},{kind:"dispatch",id:"op.edge.extract",title:"Edge extract",io:oe("mask","mask"),dispatchId:"edge.extract",tuningId:"edge.extract",group:"Edge"},{kind:"dispatch",id:"op.svg.create",title:"Create SVG",io:oe("mask","svg"),dispatchId:"svg.create",tuningId:"svg.create",group:"SVG"},{kind:"dispatch",id:"op.mage.clean.removeSmallComponents",title:"Remove small components",io:oe("mask","mask"),dispatchId:"mage.clean.removeSmallComponents",tuningId:"mage.clean.removeSmallComponents",group:"Cleanup"},{kind:"js",id:"op.util.pass.image",title:"Pass-through (image)",io:oe("image","image"),group:"Utility",run:({input:r})=>r},{kind:"js",id:"op.util.pass.mask",title:"Pass-through (mask)",io:oe("mask","mask"),group:"Utility",run:({input:r})=>r}];function n(r){return $e(t,r)}function i(r,f){return f.map((g,h)=>({instanceId:Rt(r,h),opId:g,enabled:!0}))}const o=[{id:"segmentation",title:"Segmentation",implemented:!0,description:"Multi-step segmentation pipeline (image -> mask).",ops:i("segmentation",["op.seg.resize","op.seg.denoise","op.seg.color","op.seg.threshold","op.seg.morphology"])},{id:"edge",title:"Edge",implemented:!0,description:"Edge extraction pipeline (image -> mask -> edges).",ops:i("edge",["op.edge.resize","op.edge.threshold","op.edge.morphology","op.edge.extract"])},{id:"svg",title:"SVG",implemented:!0,description:"Image to SVG outline.",ops:i("svg",["op.edge.resize","op.edge.threshold","op.edge.morphology","op.edge.extract","op.svg.create"])},{id:"cleanup",title:"Cleanup (min area)",implemented:!0,description:"Image -> mask -> cleanup (morphology + remove small components).",ops:i("cleanup",["op.seg.resize","op.seg.threshold","op.seg.morphology","op.mage.clean.removeSmallComponents"])},{id:"surface",title:"Surface",implemented:!1,description:"Future: region labeling + vectorize pipeline.",ops:[]}],a=(e==null?void 0:e.userPipelines)??[];function s(r){return $e(o,r)}function l(r){return $e(a,r)??$e(o,r)}function u(){const r=new Set(a.map(g=>g.id));return[...o.filter(g=>!r.has(g.id)),...a]}return{ops:t,getOp:n,builtIns:o,getBuiltIn:s,listPipelines:u,getPipeline:l,createInstanceId:Rt}}const Lt=on();function to(){return{opencvReady:me()}}function no(e){const{implemented:t,policy:n,runtimeOpenCvReady:i}=e,o=i&&t.includes("opencv");return t.includes("native")||t.length,n==="native"?{engine:"native"}:n==="opencv"?o?{engine:"opencv"}:{engine:"native",fallbackReason:i?"Override policy=opencv, but this op has no OpenCV implementation.":"Override policy=opencv, but OpenCV is not available at runtime."}:n==="auto"?o?{engine:"opencv"}:{engine:"native"}:{engine:"native"}}async function io(e,t){const n=await Se(),i=to(),o=an(e,Lt,n,i),a=Lt.byId.get(e);if(!a)throw new Error(`[opsDispatch] Unknown op in registry: ${e}`);const l={...o.params,...(t==null?void 0:t.params)??{}},u=t!=null&&t.enginePolicy&&t.enginePolicy!=="inherit"?t.enginePolicy:o.policy;let r=o.engine,f=o.fallbackReason;if(t!=null&&t.enginePolicy&&t.enginePolicy!=="inherit"){const g=no({implemented:a.implementedEngines,policy:u,runtimeOpenCvReady:!!i.opencvReady});r=g.engine,f=g.fallbackReason}return{engine:r,params:l,fallbackReason:f,opencvReady:!!i.opencvReady}}async function oo(e,t,n,i){const{engine:o,params:a,fallbackReason:s,opencvReady:l}=await io(e,i);return o==="opencv"&&!l?(Me(`OpenCV selected for ${e} but not ready; falling back to native. ${s??""}`.trim()),await n[e].native(t,a)):await n[e][o](t,a)}function Ae(e,t,n,i){if(!t||!n)return e;const o=Math.floor(Number(i.morphAlgo??2)),a=so(Math.floor(Number(i.morphIters??1)),1,20),s=Math.floor(Number(i.morphK??5)),l=ao(s),u=l-1>>1;if(o<=0||l<=1)return e;let r=e,f=new Uint8Array(t*n);for(let g=0;g<a;g++){if(o===1){Mt(r,f,t,n,u);const h=r;r=f,f=h;continue}if(o===2){Dt(r,f,t,n,u);const h=r;r=f,f=h;continue}Dt(r,f,t,n,u),r===e&&g===0&&(r=new Uint8Array(e)),Mt(f,r,t,n,u)}return r}function ao(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:5}function Dt(e,t,n,i,o){t.fill(0);for(let a=0;a<i;a++){const s=Math.max(0,a-o),l=Math.min(i-1,a+o);for(let u=0;u<n;u++){const r=Math.max(0,u-o),f=Math.min(n-1,u+o);let g=0;for(let h=s;h<=l&&!g;h++){let c=h*n+r;for(let d=r;d<=f;d++,c++)if(e[c]){g=1;break}}t[a*n+u]=g}}}function Mt(e,t,n,i,o){t.fill(0);for(let a=0;a<i;a++){const s=Math.max(0,a-o),l=Math.min(i-1,a+o);for(let u=0;u<n;u++){const r=Math.max(0,u-o),f=Math.min(n-1,u+o);let g=1;for(let h=s;h<=l&&g;h++){let c=h*n+r;for(let d=r;d<=f;d++,c++)if(!e[c]){g=0;break}}t[a*n+u]=g}}}function so(e,t,n){return e<t?t:e>n?n:e}function gn(e,t,n,i){const o=Math.max(0,Math.floor(Number(i??0)));if(!t||!n||o<=1)return e;const a=new Uint8Array(e),s=new Uint8Array(e.length),l=new Int32Array(e.length),u=new Int32Array(e.length);for(let r=0;r<n;r++)for(let f=0;f<t;f++){const g=r*t+f;if(e[g]===0||s[g]===1)continue;let h=0,c=0;s[g]=1,l[c]=f,u[c]=r,c++;const d=[g];for(;h<c;){const m=l[h],v=u[h];h++;const b=m-1,y=v,x=m+1,w=v,C=m,E=v-1,T=m,$=v+1;if(b>=0){const O=y*t+b;e[O]!==0&&s[O]===0&&(s[O]=1,l[c]=b,u[c]=y,c++,d.push(O))}if(x<t){const O=w*t+x;e[O]!==0&&s[O]===0&&(s[O]=1,l[c]=x,u[c]=w,c++,d.push(O))}if(E>=0){const O=E*t+C;e[O]!==0&&s[O]===0&&(s[O]=1,l[c]=C,u[c]=E,c++,d.push(O))}if($<n){const O=$*t+T;e[O]!==0&&s[O]===0&&(s[O]=1,l[c]=T,u[c]=$,c++,d.push(O))}}if(d.length<o)for(let m=0;m<d.length;m++)a[d[m]]=0}return a}function ro(){const e=globalThis;return e!=null&&e.cv&&typeof e.cv.Mat=="function"?e.cv:null}function lo(e,t){const{width:n,height:i}=e,o=Math.max(0,Math.floor(Number(t.cleanMinArea??0)));if(tn("OpenCV removeSmallComponents params",{width:n,height:i,minArea:o}),!n||!i||o<=1)return e.mask;const a=ro();if(!a)return gn(e.mask,n,i,o);const s=new a.Mat(i,n,a.CV_8UC1);try{const l=s.data,u=e.mask;for(let h=0;h<u.length;h++)l[h]=u[h]?255:0;const r=new a.Mat,f=new a.Mat,g=new a.Mat;try{const h=a.connectedComponentsWithStats(s,r,f,g,8,a.CV_32S),c=a.CC_STAT_AREA??4,d=new Array(h).fill(!1);for(let b=1;b<h;b++)f.intAt(b,c)<o&&(d[b]=!0);const m=new Uint8Array(n*i),v=r.data32S;for(let b=0;b<m.length;b++){const y=v[b];m[b]=y>0&&!d[y]?1:0}return m}finally{r.delete(),f.delete(),g.delete()}}finally{s.delete()}}function Te(e,t,n,i){const o=Math.max(0,Math.min(255,Math.floor(Number(i.manualT??128)))),a=new Uint8Array(t*n),s=e.data;for(let l=0,u=0;l<a.length;l++,u+=4){const r=s[u],f=s[u+1],g=s[u+2],h=r*77+f*150+g*29>>8;a[l]=h>=o?1:0}return a}function Re(e,t,n,i){const o=Math.max(1,Math.floor(Number(i.targetMaxW??t)));if(!t||!n||t<=o)return e;const a=o/t,s=Math.max(1,Math.floor(t*a)),l=Math.max(1,Math.floor(n*a));return Math.floor(Number(i.resizeAlgo??1))===0?co(e,t,n,s,l):uo(e,t,n,s,l)}function co(e,t,n,i,o){const a=e.data,s=new Uint8ClampedArray(i*o*4),l=t/i,u=n/o;for(let r=0;r<o;r++){const f=Math.min(n-1,Math.max(0,Math.floor((r+.5)*u-.5)));for(let g=0;g<i;g++){const h=Math.min(t-1,Math.max(0,Math.floor((g+.5)*l-.5))),c=(f*t+h)*4,d=(r*i+g)*4;s[d]=a[c],s[d+1]=a[c+1],s[d+2]=a[c+2],s[d+3]=a[c+3]}}return new ImageData(s,i,o)}function uo(e,t,n,i,o){const a=e.data,s=new Uint8ClampedArray(i*o*4),l=t/i,u=n/o;for(let r=0;r<o;r++){const f=(r+.5)*u-.5,g=Le(Math.floor(f),0,n-1),h=Le(g+1,0,n-1),c=f-g;for(let d=0;d<i;d++){const m=(d+.5)*l-.5,v=Le(Math.floor(m),0,t-1),b=Le(v+1,0,t-1),y=m-v,x=(g*t+v)*4,w=(g*t+b)*4,C=(h*t+v)*4,E=(h*t+b)*4,T=(r*i+d)*4;for(let $=0;$<4;$++){const O=a[x+$],p=a[w+$],I=a[C+$],R=a[E+$],B=O+(p-O)*y,A=I+(R-I)*y,k=B+(A-B)*c;s[T+$]=po(k)}}}return new ImageData(s,i,o)}function Le(e,t,n){return e<t?t:e>n?n:e}function po(e){return e<=0?0:e>=255?255:e|0}function Ot(e,t,n,i){if(!t||!n)return e;const o=Math.floor(Number(i.denoiseAlgo??1));if(o<=0)return e;const a=Math.floor(Number(i.blurK??3)),s=go(a);return o===2&&s<=3?ho(e,t,n):s<=1?e:fo(e,t,n,s)}function go(e){return Number.isFinite(e)?e<1?1:e%2===0?e+1:e:3}function fo(e,t,n,i){const o=i-1>>1,a=e.data,s=new Uint8ClampedArray(t*n*4);for(let u=0;u<n;u++){let r=0,f=0,g=0,h=0;for(let c=-o;c<=o;c++){const d=ye(c,0,t-1),m=(u*t+d)*4;r+=a[m],f+=a[m+1],g+=a[m+2],h+=a[m+3]}for(let c=0;c<t;c++){const d=(u*t+c)*4;s[d]=r/i|0,s[d+1]=f/i|0,s[d+2]=g/i|0,s[d+3]=h/i|0;const m=ye(c-o,0,t-1),v=ye(c+o+1,0,t-1),b=(u*t+m)*4,y=(u*t+v)*4;r+=a[y]-a[b],f+=a[y+1]-a[b+1],g+=a[y+2]-a[b+2],h+=a[y+3]-a[b+3]}}const l=new Uint8ClampedArray(t*n*4);for(let u=0;u<t;u++){let r=0,f=0,g=0,h=0;for(let c=-o;c<=o;c++){const m=(ye(c,0,n-1)*t+u)*4;r+=s[m],f+=s[m+1],g+=s[m+2],h+=s[m+3]}for(let c=0;c<n;c++){const d=(c*t+u)*4;l[d]=r/i|0,l[d+1]=f/i|0,l[d+2]=g/i|0,l[d+3]=h/i|0;const m=ye(c-o,0,n-1),v=ye(c+o+1,0,n-1),b=(m*t+u)*4,y=(v*t+u)*4;r+=s[y]-s[b],f+=s[y+1]-s[b+1],g+=s[y+2]-s[b+2],h+=s[y+3]-s[b+3]}}return new ImageData(l,t,n)}function ho(e,t,n){const i=e.data,o=new Uint8ClampedArray(t*n*4),a=new Array(9),s=new Array(9),l=new Array(9),u=new Array(9);for(let r=0;r<n;r++)for(let f=0;f<t;f++){let g=0;for(let c=-1;c<=1;c++){const d=ye(r+c,0,n-1);for(let m=-1;m<=1;m++){const v=ye(f+m,0,t-1),b=(d*t+v)*4;a[g]=i[b],s[g]=i[b+1],l[g]=i[b+2],u[g]=i[b+3],g++}}a.sort(De),s.sort(De),l.sort(De),u.sort(De);const h=(r*t+f)*4;o[h]=a[4]|0,o[h+1]=s[4]|0,o[h+2]=l[4]|0,o[h+3]=u[4]|0}return new ImageData(o,t,n)}function De(e,t){return e-t}function ye(e,t,n){return e<t?t:e>n?n:e}function Bt(e,t,n,i){if(!t||!n)return e;const o=Math.floor(Number(i.colorMode??1));if(o===0)return e;const a=e.data,s=new Uint8ClampedArray(t*n*4),l=yo(Math.floor(Number(i.hsvChannel??2)),0,2);for(let u=0,r=0;u<t*n;u++,r+=4){const f=a[r],g=a[r+1],h=a[r+2],c=a[r+3];let d=0;if(o===1)d=f*77+g*150+h*29>>8;else if(o===2){const m=mo(f,g,h),v=l===0?m.h:l===1?m.s:m.v;d=bo(v*255)}else d=255-(f*77+g*150+h*29>>8);s[r]=d,s[r+1]=d,s[r+2]=d,s[r+3]=c}return new ImageData(s,t,n)}function mo(e,t,n){const i=e/255,o=t/255,a=n/255,s=Math.max(i,o,a),l=Math.min(i,o,a),u=s-l;let r=0;u!==0&&(s===i?r=(o-a)/u%6:s===o?r=(a-i)/u+2:r=(i-o)/u+4,r/=6,r<0&&(r+=1));const f=s===0?0:u/s;return{h:r,s:f,v:s}}function yo(e,t,n){return e<t?t:e>n?n:e}function bo(e){return e<=0?0:e>=255?255:e|0}function Ut(e,t,n){const i=new Uint8Array(e.length),o=(a,s)=>s*t+a;for(let a=0;a<n;a++)for(let s=0;s<t;s++){const l=o(s,a);if(e[l]===0)continue;if(s===0||a===0||s===t-1||a===n-1){i[l]=255;continue}const r=e[o(s-1,a)],f=e[o(s+1,a)],g=e[o(s,a-1)],h=e[o(s,a+1)];(r===0||f===0||g===0||h===0)&&(i[l]=255)}return i}function zt(e,t,n,i){const o=Math.max(1,Math.floor(i.scale||1)),a=t*o,s=n*o,l=o;let u="";for(let h=0;h<n;h++){const c=h*t;for(let d=0;d<t;d++){if(e[c+d]===0)continue;const v=d*l,b=h*l;u+=`M${v} ${b}h${l}v${l}h-${l}Z`}}const r=i.transparentBg?"":`<rect x="0" y="0" width="${a}" height="${s}" fill="white"/>`,f=i.color||"#000",g=u.length>0?`<path d="${u}" fill="${f}" stroke="none"/>`:"";return`<svg xmlns="http://www.w3.org/2000/svg" width="${a}" height="${s}" viewBox="0 0 ${a} ${s}">`+r+g+"</svg>"}const vo="demo",wo={"mage.clean.removeSmallComponents":{native:(e,t)=>gn(e.mask,e.width,e.height,t.cleanMinArea),opencv:(e,t)=>(F("OpenCV removeSmallComponents called (demo).",{width:e.width,height:e.height,cleanMinArea:t.cleanMinArea}),lo(e,t))},"segmentation.resize":{native:(e,t)=>(F("[demo op] segmentation.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),Re(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(F("[demo op] segmentation.resize opencv",{width:e.width,height:e.height}),Re(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"segmentation.denoise":{native:(e,t)=>(F("[demo op] segmentation.denoise native",{width:e.width,height:e.height,denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}),Ot(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma})),opencv:(e,t)=>(F("[demo op] segmentation.denoise opencv",{width:e.width,height:e.height}),Ot(e.image,e.width,e.height,{denoiseAlgo:t.denoiseAlgo,blurK:t.blurK,bilateralSigma:t.bilateralSigma}))},"segmentation.color":{native:(e,t)=>(F("[demo op] segmentation.color native",{width:e.width,height:e.height,colorMode:t.colorMode,hsvChannel:t.hsvChannel}),Bt(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel})),opencv:(e,t)=>(F("[demo op] segmentation.color opencv",{width:e.width,height:e.height}),Bt(e.image,e.width,e.height,{colorMode:t.colorMode,hsvChannel:t.hsvChannel}))},"segmentation.threshold":{native:(e,t)=>(F("[demo op] segmentation.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),Te(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(F("[demo op] segmentation.threshold opencv",{width:e.width,height:e.height}),Te(e.image,e.width,e.height,{manualT:t.manualT}))},"segmentation.morphology":{native:(e,t)=>(F("[demo op] segmentation.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),Ae(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(F("[demo op] segmentation.morphology opencv",{width:e.width,height:e.height}),Ae(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.resize":{native:(e,t)=>(F("[demo op] edge.resize native",{width:e.width,height:e.height,resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}),Re(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW})),opencv:(e,t)=>(F("[demo op] edge.resize opencv",{width:e.width,height:e.height}),Re(e.image,e.width,e.height,{resizeAlgo:t.resizeAlgo,targetMaxW:t.targetMaxW}))},"edge.threshold":{native:(e,t)=>(F("[demo op] edge.threshold native",{width:e.width,height:e.height,manualT:t.manualT}),Te(e.image,e.width,e.height,{manualT:t.manualT})),opencv:(e,t)=>(F("[demo op] edge.threshold opencv",{width:e.width,height:e.height}),Te(e.image,e.width,e.height,{manualT:t.manualT}))},"edge.morphology":{native:(e,t)=>(F("[demo op] edge.morphology native",{width:e.width,height:e.height,morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}),Ae(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters})),opencv:(e,t)=>(F("[demo op] edge.morphology opencv",{width:e.width,height:e.height}),Ae(e.mask,e.width,e.height,{morphAlgo:t.morphAlgo,morphK:t.morphK,morphIters:t.morphIters}))},"edge.extract":{native:(e,t)=>(F("[demo op] edge.extract native",{width:e.width,height:e.height}),Ut(e.mask,e.width,e.height)),opencv:(e,t)=>(F("[demo op] edge.extract opencv",{width:e.width,height:e.height}),Ut(e.mask,e.width,e.height))},"svg.create":{native:(e,t)=>(F("[demo op] svg.create native",{width:e.width,height:e.height,scale:t.scale}),zt(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color})),opencv:(e,t)=>(F("[demo op] svg.create opencv",{width:e.width,height:e.height,scale:t.scale}),zt(e.mask,e.width,e.height,{scale:t.scale,transparentBg:!!t.transparentBg,color:t.color}))}};async function ve(e,t,n){return tn("[opsDispatch] runOp",{op:e,implSource:vo,inputKeys:t&&typeof t=="object"?Object.keys(t):typeof t,override:n?{enginePolicy:n.enginePolicy,paramsKeys:Object.keys(n.params??{})}:null}),oo(e,t,wo,n)}const Co=Object.freeze(Object.defineProperty({__proto__:null,runOp:ve},Symbol.toStringTag,{value:"Module"}));function Eo(e){return{width:e.width,height:e.height}}function ko(e){const{catalogue:t,pipeline:n}=e,i=(n.ops??[]).filter(a=>a.enabled!==!1),o=[];for(const a of i){const s=t.getOp(a.opId);if(!s)return{enabledInstances:[],specs:[],error:`Unknown opId in pipeline: ${a.opId}`};o.push(s)}return{enabledInstances:i,specs:o}}function Io(e){const{specs:t,instances:n,startType:i}=e;if(t.length===0)return{ok:!1,startType:i,error:"Pipeline has no ops",steps:[]};let o=i;const a=[];for(let s=0;s<t.length;s++){const l=t[s],u=n[s],r=l.io.input,f=r===o;if(a.push({index:s,instanceId:u.instanceId,opId:l.id,title:l.title,expectedInput:r,actualInput:o,output:l.io.output,ok:f,error:f?void 0:`Chain IO mismatch at "${l.title}": needs ${r} but current is ${o}`}),!f)return{ok:!1,startType:i,error:a[a.length-1].error,steps:a};o=l.io.output}return{ok:!0,startType:i,endType:o,steps:a}}function Vt(e){const{specs:t,startType:n,index:i}=e;if(i<=0)return n;let o=n;for(let a=0;a<Math.min(i,t.length);a++){const s=t[a];if(s.io.input!==o)return o;o=s.io.output}return o}function xo(e){const{beforeType:t,afterType:n,op:i}=e;return i.io.input!==t?{ok:!1,reason:`Needs ${i.io.input} but slot provides ${t}`}:n&&i.io.output!==n?{ok:!1,reason:`Produces ${i.io.output} but next op needs ${n}`}:{ok:!0}}function So(e){return e.type==="image"}function Po(e){return e.type==="mask"}function fn(e){return{type:"image",width:e.width,height:e.height,image:e}}function Nt(e,t,n){return{type:"mask",width:t,height:n,mask:e}}function _t(e,t,n){return{type:"svg",width:t,height:n,svg:e}}function Ge(e,t){return`IO mismatch: expected ${e}, got ${t}`}async function $o(e,t,n){const i=t.override;if(e.io.input==="image"){if(!So(n))throw new Error(Ge("image",n.type));const{width:s,height:l}=n;if(e.io.output==="image"){const u=await ve(e.dispatchId,{image:n.image,width:s,height:l},i?{enginePolicy:i.enginePolicy,params:i.params}:void 0);return fn(u)}if(e.io.output==="mask"){const u=await ve(e.dispatchId,{image:n.image,width:s,height:l},i?{enginePolicy:i.enginePolicy,params:i.params}:void 0);return Nt(u,s,l)}if(e.io.output==="svg"){const u=await ve(e.dispatchId,{image:n.image,width:s,height:l},i?{enginePolicy:i.enginePolicy,params:i.params}:void 0);return _t(u,s,l)}throw new Error(`Unsupported dispatch output: ${e.io.output}`)}if(!Po(n))throw new Error(Ge("mask",n.type));const{width:o,height:a}=n;if(e.io.output==="mask"){const s=await ve(e.dispatchId,{mask:n.mask,width:o,height:a},i?{enginePolicy:i.enginePolicy,params:i.params}:void 0);return Nt(s,o,a)}if(e.io.output==="svg"){const s=await ve(e.dispatchId,{mask:n.mask,width:o,height:a},i?{enginePolicy:i.enginePolicy,params:i.params}:void 0);return _t(s,o,a)}throw new Error(`Invalid op spec: mask input cannot produce ${e.io.output} (unsupported here)`)}async function Ao(e,t,n,i){var l;if(e.kind==="dispatch")return await $o(e,t,n);const a={...e.tuningId?await i.getEffectiveParams(e.tuningId).catch(()=>({})):{},...((l=t.override)==null?void 0:l.params)??{}};return await e.run({input:n,params:a})}async function To(e){const{catalogue:t,pipeline:n,inputImage:i,deps:o}=e,a=fn(i);if(!n.implemented)return{pipelineId:n.id,title:n.title,status:"error",error:"Not implemented yet",input:a,ops:[]};const s=ko({catalogue:t,pipeline:n});if(s.error)return{pipelineId:n.id,title:n.title,status:"error",error:s.error,input:a,ops:[]};const l=s.enabledInstances,u=s.specs,r=Io({specs:u,instances:l,startType:"image"});if(!r.ok)return o.debug("pipeline validation failed (linear)",{pipelineId:n.id,error:r.error}),{pipelineId:n.id,title:n.title,status:"error",error:r.error??"Invalid pipeline typing",input:a,ops:l.map((h,c)=>{var d,m;return{instanceId:h.instanceId,opId:h.opId,title:((d=u[c])==null?void 0:d.title)??h.opId,io:((m=u[c])==null?void 0:m.io)??{input:"image",output:"image"},status:"error",error:r.error??"Invalid pipeline typing"}})};const f=[];let g=a;for(let h=0;h<u.length;h++){const c=l[h],d=u[h];try{if(d.io.input!==g.type)throw new Error(Ge(d.io.input,g.type));const m=await Ao(d,c,g,o);if(m.type!==d.io.output)throw new Error(Ge(d.io.output,m.type));f.push({instanceId:c.instanceId,opId:d.id,title:d.title,io:d.io,status:"ok",output:m}),g=m}catch(m){const v=m instanceof Error?m.message:String(m);return f.push({instanceId:c.instanceId,opId:d.id,title:d.title,io:d.io,status:"error",error:v}),o.debug("pipeline op failed (linear)",{pipelineId:n.id,opId:d.id,error:v,...Eo(g)}),{pipelineId:n.id,title:n.title,status:"error",error:`Op "${d.title}" failed: ${v}`,input:a,ops:f}}}return{pipelineId:n.id,title:n.title,status:"ok",input:a,output:g,ops:f}}const ut="beemage.pipeline.userPipelines.v1";async function we(){const e=await ce([ut]).catch(()=>({})),t=e==null?void 0:e[ut];if(!Array.isArray(t))return[];const n=[];for(const i of t)!i||typeof i!="object"||typeof i.id=="string"&&Array.isArray(i.ops)&&n.push(i);return n}async function Ke(e){await de({[ut]:e}).catch(()=>null)}async function Ro(e){const t=await we(),n=t.findIndex(i=>i.id===e.id);if(n>=0){const i=t.slice();i[n]=e,await Ke(i);return}await Ke([...t,e])}async function Lo(e){const n=(await we()).filter(i=>i.id!==e);await Ke(n)}const pt="beemage.pipeline.recipes.v1";function Do(){return Date.now()}function hn(){return{recipesById:{}}}async function be(){const e=await ce([pt]).catch(()=>({})),t=e==null?void 0:e[pt];return!t||typeof t!="object"?{}:t}async function Pe(e){await de({[pt]:e}).catch(()=>null)}async function Mo(e,t){const n=await be(),i=n[e]??hn();i.selectedRecipeId=t,n[e]=i,await Pe(n)}async function Oo(e,t){const n=await be(),i=n[e]??hn();i.recipesById[t.id]={...t,updatedTs:Do()},i.selectedRecipeId||(i.selectedRecipeId=t.id),n[e]=i,await Pe(n)}async function Bo(e,t){const n=await be(),i=n[e];if(i){if(delete i.recipesById[t],i.selectedRecipeId===t){const o=Object.keys(i.recipesById);i.selectedRecipeId=o.length?o[0]:void 0}n[e]=i,await Pe(n)}}function Uo(e){const t=[];for(const[n,i]of Object.entries(e??{})){const o=Object.values(i.recipesById??{});t.push({pipelineId:n,selectedRecipeId:i.selectedRecipeId,recipes:o})}return t.sort((n,i)=>n.pipelineId.localeCompare(i.pipelineId)),t}function zo(e){if(!Array.isArray(e))return{};const t={};for(const n of e){if(!n||typeof n!="object")continue;const i=n.pipelineId;if(typeof i!="string"||!i)continue;const o=n.selectedRecipeId,a=n.recipes,s={};if(Array.isArray(a))for(const l of a){if(!l||typeof l!="object")continue;const u=l.id,r=l.title,f=l.updatedTs,g=l.ops;typeof u!="string"||!u||typeof r!="string"||!r||typeof f=="number"&&Array.isArray(g)&&(s[u]=l)}t[i]={selectedRecipeId:typeof o=="string"?o:void 0,recipesById:s}}return t}function Vo(e){return e.type==="image"}function No(e){return e.type==="mask"}function _o(e){return e.type==="svg"}function jo(e){var I,R,B,A;let t=dt({userPipelines:[]}),n={},o=((B=(R=(I=t.listPipelines)==null?void 0:I.call(t))==null?void 0:R[0])==null?void 0:B.id)??((A=t.builtIns[0])==null?void 0:A.id)??"segmentation",a="default",s=null,l="Idle",u=null,r=[],f=0,g=null;async function h(){var M,z,L,N,U;const k=await we().catch(()=>[]);t=dt({userPipelines:k}),n=await be().catch(()=>({}));const S=((M=t.listPipelines)==null?void 0:M.call(t))??t.builtIns;S.some(J=>J.id===o)||(o=((z=S[0])==null?void 0:z.id)??"segmentation",a="default");const D=((L=t.getPipeline)==null?void 0:L.call(t,o))??((U=(N=t.listPipelines)==null?void 0:N.call(t))==null?void 0:U[0]);D&&d(D).some(q=>q.id===a)||(a="default"),v()}function c(){var S,P,D;const k=((S=t.getPipeline)==null?void 0:S.call(t,o))??((D=(P=t.listPipelines)==null?void 0:P.call(t))==null?void 0:D[0]);if(!k)throw new Error("[pipeline] No pipelines available.");return k}function d(k){const S={id:"default",title:"Default",buildPipeline:z=>z},P=n==null?void 0:n[k.id],D=(P==null?void 0:P.recipesById)??{},M=[S];for(const z of Object.keys(D)){const L=D[z];!L||typeof L.id!="string"||M.push({id:String(L.id),title:typeof L.title=="string"&&L.title.trim().length?L.title:String(L.id),buildPipeline:N=>{const U=Array.isArray(L.ops)?L.ops:null;if(!U)return N;const J=U.filter(_=>_&&typeof _=="object").map(_=>({instanceId:typeof _.instanceId=="string"?_.instanceId:String(_.instanceId??""),opId:typeof _.opId=="string"?_.opId:String(_.opId??""),enabled:_.enabled===void 0?!0:!!_.enabled})).filter(_=>_.instanceId&&_.opId);return J.length?{...N,ops:J}:N}})}return M.slice(0,1).concat(M.slice(1).sort((z,L)=>String(z.title).localeCompare(String(L.title))))}function m(){const k=c(),S=d(k),P=S.find(D=>D.id===a)??S[0];return a=P.id,P.buildPipeline(k)}function v(){l=m().implemented?"Ready":"Not implemented yet",u=null,r=[],f=0,g=null}function b(){v()}function y(k){var P,D;k===o||!(((P=t.getPipeline)==null?void 0:P.call(t,k))??((D=t.getBuiltIn)==null?void 0:D.call(t,k)))||(o=k,a="default",b())}function x(k){if(k===a)return;const S=c();a=d(S).some(M=>M.id===k)?k:"default",b()}function w(k){s=k,v()}function C(k){const S=k.ops.filter(D=>D.enabled!==!1),P=[];for(let D=0;D<S.length;D++){const M=S[D],z=t.getOp(M.opId);z&&P.push({index0:D,instanceId:M.instanceId,opSpec:z})}return P}function E(k){var M;const S=k.ops.map(z=>({instanceId:z.instanceId,opId:z.opId,title:z.title,input:z.io.input,output:z.io.output,state:z.status==="ok"?"ok":z.status==="error"?"error":"idle",error:z.error,outputArtifact:z.output})),P=k.status==="ok"?"ok":"error",D=k.output??((M=S.slice().reverse().find(z=>z.outputArtifact))==null?void 0:M.outputArtifact);return[{stageId:"pipeline",title:"Pipeline",input:"image",output:(D==null?void 0:D.type)??"image",ops:S,state:P,error:k.error,outputArtifact:D}]}function T(k,S){S&&(Vo(S)?k.outputImage={width:S.width,height:S.height,data:S.image}:No(S)?k.outputMask={width:S.width,height:S.height,data:S.mask}:_o(S)&&(k.outputSvg={width:S.width,height:S.height,svg:S.svg}))}async function $(){const k=m();if(!k.implemented){l="Not implemented yet";return}if(!s){l="No input image";return}l="Running all…";const S=await To({catalogue:t,pipeline:k,inputImage:s,deps:e.runner});u=S,r=C(k),f=r.length,g=S.output??null,l=S.status==="ok"?"Done":S.error??"Error"}async function O(){const k=m();if(!k.implemented){l="Not implemented yet";return}if(!s){l="No input image";return}if(r.length===0&&(r=C(k),f=0,g={type:"image",width:s.width,height:s.height,image:s},u={pipelineId:k.id,title:k.title,status:"ok",input:{type:"image",width:s.width,height:s.height,image:s},output:{type:"image",width:s.width,height:s.height,image:s},ops:[]}),f>=r.length){l="Done";return}const S=r[f],P=S.opSpec;g||(g={type:"image",width:s.width,height:s.height,image:s});try{if(l=`Running: ${P.title}`,g.type!==P.io.input)throw new Error(`IO mismatch: expected ${P.io.input}, got ${g.type}`);const D=P.tuningId?await e.runner.getEffectiveParams(P.tuningId).catch(()=>({})):{};let M;if(P.kind==="dispatch"){const{runOp:N}=await Rn(async()=>{const{runOp:U}=await Promise.resolve().then(()=>Co);return{runOp:U}},void 0,import.meta.url);if(g.type==="image"){const U=await N(P.dispatchId,{image:g.image,width:g.width,height:g.height});if(P.io.output==="image"){const J=U;M={type:"image",width:J.width,height:J.height,image:J}}else if(P.io.output==="mask")M={type:"mask",width:g.width,height:g.height,mask:U};else throw new Error(`Unsupported dispatch output: ${P.io.output}`)}else if(g.type==="mask"){const U=await N(P.dispatchId,{mask:g.mask,width:g.width,height:g.height});if(P.io.output==="mask")M={type:"mask",width:g.width,height:g.height,mask:U};else if(P.io.output==="svg")M={type:"svg",width:g.width,height:g.height,svg:U};else throw new Error(`Invalid dispatch output: ${P.io.output}`)}else throw new Error("Dispatch ops cannot take svg input.")}else M=await P.run({input:g,params:D});if(M.type!==P.io.output)throw new Error(`IO mismatch: expected ${P.io.output}, got ${M.type}`);const L=((u==null?void 0:u.ops)??[]).concat([{instanceId:S.instanceId,opId:P.id,title:P.title,io:P.io,status:"ok",output:M}]);u={pipelineId:k.id,title:k.title,status:"ok",input:{type:"image",width:s.width,height:s.height,image:s},output:M,ops:L},g=M,f+=1,l=f>=r.length?"Done":"Ready"}catch(D){const M=D instanceof Error?D.message:String(D);l=`Error: ${P.title} — ${M}`;const L=((u==null?void 0:u.ops)??[]).concat([{instanceId:S.instanceId,opId:P.id,title:P.title,io:P.io,status:"error",error:M}]);u={pipelineId:k.id,title:k.title,status:"error",error:M,input:{type:"image",width:s.width,height:s.height,image:s},ops:L},e.runner.debug("pipeline next-step failed",{pipelineId:k.id,recipeId:a,instanceId:S.instanceId,opId:P.id,error:M})}}function p(){var N;const k=c(),S=m(),P=d(k),z={pipelines:(((N=t.listPipelines)==null?void 0:N.call(t))??t.builtIns).map(U=>({id:U.id,title:U.title})),recipes:P.map(U=>({id:U.id,title:U.title})),activePipelineId:o,activeRecipeId:a,statusText:l,description:S.description,stages:u?E(u):[],input:s?{width:s.width,height:s.height,data:s}:void 0,nextIndex:f,totalOps:r.length||S.ops.filter(U=>U.enabled!==!1).length},L=(u==null?void 0:u.output)??g??null;return T(z,L),z}return b(),{getVm:p,setActivePipeline:y,setActiveRecipe:x,setInputImageData:w,runAll:$,runNext:O,reset:b,reloadCatalogue:h}}function Fo(e,t,n){const i=jo({runner:{getEffectiveParams:async p=>await n.getEffectiveParams(p).catch(()=>({})),debug:(p,I)=>Y({scope:"panel",kind:"debug",message:p,meta:I})}});let o=null,a=!1,s=null,l=null;function u(){const p=i.getVm();if(!(p.stages.some(B=>B.state==="error")||String(p.statusText).toLowerCase().includes("error"))){l=null;return}const R=String(p.statusText||"Pipeline error");R!==l&&(l=R,j({scope:"panel",kind:"error",message:`Pipeline: ${R}`}))}function r(){e.pipelineTuningMountEl.innerHTML=""}function f(p){return[p,`pipeline.${p}`,"pipeline"]}function g(p){const I=f(p);if(s===I[0])return;r();let R=null,B=null;for(const A of I)try{n.mount({mountEl:e.pipelineTuningMountEl,scopeRootId:A}),R=A;break}catch(k){B=k,r()}if(!R){s=null,j({scope:"panel",kind:"info",message:`Pipeline tuning mount failed for "${p}" (no matching scope).`}),Y({scope:"panel",kind:"error",message:"Pipeline tuning mount failed (no candidate scopeRootId worked)",meta:{pipelineId:p,candidates:I,error:B instanceof Error?B.message:String(B)}});return}s=R,j({scope:"panel",kind:"info",message:`Pipeline tuning mount: pipelineId=${p}, scopeRootId=${R}`})}function h(){const p=i.getVm(),I=typeof p.activePipelineId=="string"?p.activePipelineId:"segmentation";g(I)}function c(){const p=e.srcCanvasEl,I=p.width,R=p.height;if(!I||!R)return null;const B=p.getContext("2d",{willReadFrequently:!0});return B?B.getImageData(0,0,I,R):null}function d(){if(i.getVm().input)return;const I=c();I&&i.setInputImageData(I)}function m(){const p=c();p&&i.setInputImageData(p)}async function v(){const p=await n.getEffectiveParams("pipeline").catch(()=>({})),I=p==null?void 0:p.mode,R=p==null?void 0:p.recipe,B=typeof I=="string"?I:"segmentation",A=typeof R=="string"?R:"default";i.setActivePipeline(B),i.setActiveRecipe(A),h()}function b(){return o||(j({scope:"panel",kind:"info",message:"Pipeline view: create + mount"}),o=eo({hostEl:e.pipelineViewMountEl,statusEl:e.pipelineStatusEl,handlers:{onSelectPipeline:p=>{j({scope:"panel",kind:"info",message:`Pipeline select: ${p}`}),i.setActivePipeline(p),n.setParamValue("pipeline","mode",p),h(),y()},onSelectRecipe:p=>{j({scope:"panel",kind:"info",message:`Recipe select: ${p}`}),i.setActiveRecipe(p),n.setParamValue("pipeline","recipe",p),y()},onRunAll:()=>void x(),onNext:()=>void w(),onReset:()=>{i.reset();const p=c();p&&i.setInputImageData(p),Ye(i.getVm()),j({scope:"panel",kind:"info",message:"Pipeline reset (reseed from source)"}),h(),y()}}}),o.mount(),h(),o)}function y(){b().render(i.getVm())}async function x(){j({scope:"panel",kind:"info",message:"Pipeline run: all"}),m();try{await i.runAll()}finally{Ye(i.getVm()),y(),u()}}async function w(){j({scope:"panel",kind:"info",message:"Pipeline run: next"}),d();try{await i.runNext()}finally{Ye(i.getVm()),y(),u()}}function C(){}async function E(){a=!0,j({scope:"panel",kind:"info",message:"Pipeline tab: mount()"}),m(),await i.reloadCatalogue().catch(()=>null),await v(),j({scope:"panel",kind:"info",message:"Pipeline tab: render()"}),y()}async function T(){a&&(j({scope:"panel",kind:"info",message:"Pipeline tab: refresh()"}),m(),await i.reloadCatalogue().catch(()=>null),await v(),y())}function $(){a=!1,j({scope:"panel",kind:"info",message:"Pipeline tab: unmount()"})}function O(){j({scope:"panel",kind:"info",message:"Pipeline tab: dispose()"}),o==null||o.dispose(),o=null,s=null,r()}return{bind:C,mount:E,unmount:$,refresh:T,dispose:O}}function gt(e){return!!e&&typeof e=="object"}function Go(e){if(!gt(e)||typeof e.id!="string"||!e.id||typeof e.title!="string"||!e.title||typeof e.implemented!="boolean"||!Array.isArray(e.ops))return!1;for(const t of e.ops)if(!gt(t)||typeof t.instanceId!="string"||!t.instanceId||typeof t.opId!="string"||!t.opId||t.enabled!==void 0&&typeof t.enabled!="boolean")return!1;return!0}function Ko(){const e=dt({userPipelines:[]});async function t(){return await we().catch(()=>[])}function n(){return e.ops}async function i(){return await be().catch(()=>({}))}async function o(h){await Lo(h).catch(()=>null)}async function a(h){await Ro(h).catch(()=>null)}async function s(h){const c=await be().catch(()=>({}));!c||typeof c!="object"||(delete c[h],await Pe(c).catch(()=>null))}async function l(h,c){await Mo(h,c).catch(()=>null)}async function u(h,c){await Oo(h,c).catch(()=>null)}async function r(h,c){await Bo(h,c).catch(()=>null)}async function f(h){let c;try{c=JSON.parse(h)}catch{throw new Error("Invalid JSON (parse failed).")}let d,m;if(Array.isArray(c))d=c;else if(gt(c)&&Array.isArray(c.pipelines))d=c.pipelines,m=c.recipes;else throw new Error('Invalid file shape. Expected {"pipelines":[...]} or an array of pipelines.');const v=d,b=v.length,y=[];let x=0;for(const E of v){if(!Go(E)){x++;continue}y.push(E)}if(y.length===0)throw new Error("No valid pipelines found in the imported file.");const w=await we().catch(()=>[]),C=new Map;for(const E of w)C.set(E.id,E);for(const E of y)C.set(E.id,E);if(await Ke(Array.from(C.values())),m!==void 0){if(!Array.isArray(m))throw new Error('Invalid "recipes" shape. Expected an array (or omit the field).');const E=zo(m);await Pe(E).catch(()=>null)}return{imported:y.length,skipped:x,totalInFile:b}}async function g(){const h=await we().catch(()=>[]),c=await be().catch(()=>({})),d={format:"beemage.pipeline.userPipelines.v2",exportedAt:new Date().toISOString(),pipelines:h,recipes:Uo(c)};return JSON.stringify(d,null,2)}return{listUserPipelines:t,listOperations:n,importFromJsonText:f,exportToJsonText:g,listAllRecipes:i,deleteUserPipelineById:o,upsertUserPipeline:a,setSelectedRecipe:l,upsertRecipe:u,deleteRecipe:r,deleteAllRecipesForPipeline:s}}function re(e,t,n){const i=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))i.setAttribute(o,a);return typeof n=="string"&&(i.textContent=n),i}function Ho(e){return e.enabled!==!1}function Wo(e){const t=new Map;for(const n of e)t.set(n.id,n);return t}function Jo(e,t,n){const i={compactOps:n==null?void 0:n.compactOps},o=Wo(t),a=re("div",{class:"pipelineCard"}),s=re("div",{class:"pipelineCardHead"}),l=re("div",{style:"display:flex; flex-direction:column; gap:2px;"});l.appendChild(re("div",{class:"pipelineCardTitle"},e.title||e.id)),s.appendChild(l);{const g=e.implemented?"implemented":"not implemented";s.appendChild(re("div",{class:"status"},g))}a.appendChild(s);const u=re("div",{class:"pipelineOps",style:"margin-top:10px;"}),f=Array.isArray(e.ops)?e.ops:[];if(!f.length)return u.appendChild(re("div",{class:"muted",style:"font-size:12px;"},"No operations in this pipeline.")),a.appendChild(u),a;for(let g=0;g<f.length;g++){const h=f[g],c=o.get(h.opId),d=!Ho(h),m=c?He(c,{compact:i.compactOps,showGroup:!0,showId:!0}):re("div",{class:"opCard opCard--unknown",style:"padding:10px;"},`Unknown operation: ${h.opId}`);d&&m.classList.add("is-disabled"),u.appendChild(m),g<f.length-1&&u.appendChild(re("div",{class:"pipelineConnector","aria-hidden":"true"}))}return a.appendChild(u),a}function ae(e,t,n){const i=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))i.setAttribute(o,a);return typeof n=="string"&&(i.textContent=n),i}function qo(e){return JSON.parse(e)}function Zo(e){const{pipelineId:t,instanceIds:n,selectedRecipeId:i,recipes:o,handlers:a}=e,s=ae("div",{class:"card",style:"padding:10px; margin-top:8px;"});s.appendChild(ae("div",{class:"cardTitle"},"Recipes"));const l=ae("div",{class:"row",style:"gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px;"});s.appendChild(l);const u=ae("label",{class:"fieldInline"});u.appendChild(ae("span",{},"Selected"));const r=ae("select"),f=ae("option");f.value="",f.textContent="None",r.appendChild(f);for(const y of o){const x=ae("option");x.value=y.id,x.textContent=`${y.title} (${y.id})`,r.appendChild(x)}r.value=i??"",r.addEventListener("change",()=>{const y=r.value;y&&a.onSelectRecipe(t,y)}),u.appendChild(r),l.appendChild(u);const g=ae("button",{class:"btn",type:"button"},"New recipe"),h=ae("button",{class:"btn",type:"button"},"Edit recipe"),c=ae("button",{class:"btn",type:"button"},"Delete recipe");l.appendChild(g),l.appendChild(h),l.appendChild(c);const d=ae("div",{class:"muted",style:"font-size:12px; margin-top:8px;"},`Recipes store only deltas per instanceId. Valid instanceIds: ${n.join(", ")||"(none)"}`);s.appendChild(d);function m(){const y=window.prompt("New recipe id (unique within this pipeline):","new");if(!y)return;const x=window.prompt("Recipe title:",y);x&&a.onUpsertRecipe(t,{id:y,title:x,ops:[]})}function v(){const y=(i??r.value)||"";if(!y){window.alert("Select a recipe first.");return}const x=o.find(E=>E.id===y);if(!x){window.alert("Recipe not found.");return}const w={id:x.id,title:x.title,ops:x.ops},C=window.prompt(`Edit recipe JSON (pipeline=${t}).

Structure: { id, title, ops: [{ instanceId, enabled?, override?: { enginePolicy?, params? } }] }

`,JSON.stringify(w,null,2));if(C)try{const E=qo(C);if(typeof E.id!="string"||!E.id)throw new Error("Missing recipe.id");if(typeof E.title!="string"||!E.title)throw new Error("Missing recipe.title");if(!Array.isArray(E.ops))throw new Error("Missing recipe.ops array");for(const T of E.ops){if(!T||typeof T!="object")throw new Error("Invalid patch object in ops");if(typeof T.instanceId!="string"||!T.instanceId)throw new Error("Patch missing instanceId");n.length&&!n.includes(T.instanceId)&&console.warn("Recipe patch references unknown instanceId",t,T.instanceId)}a.onUpsertRecipe(t,{id:E.id,title:E.title,ops:E.ops})}catch(E){const T=E instanceof Error?E.message:String(E);window.alert(`Invalid recipe JSON: ${T}`)}}function b(){const y=(i??r.value)||"";if(!y){window.alert("Select a recipe first.");return}window.confirm(`Delete recipe "${y}" from pipeline "${t}"?`)&&a.onDeleteRecipe(t,y)}return g.addEventListener("click",m),h.addEventListener("click",v),c.addEventListener("click",b),o.length||(h.disabled=!0,c.disabled=!0),s}function fe(e,t,n){const i=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))i.setAttribute(o,a);return typeof n=="string"&&(i.textContent=n),i}function Yo(e){return JSON.parse(e)}function Xo(e){const{pipeline:t,opsLibrary:n,selectedRecipeId:i,recipes:o,handlers:a}=e,s=fe("div",{class:"card",style:"padding:10px; margin-top:10px;"}),l=fe("div",{class:"row",style:"justify-content:space-between; align-items:center; gap:10px;"}),u=fe("div",{class:"cardTitle"},`${t.title} (${t.id})`);l.appendChild(u);const r=fe("div",{class:"row",style:"gap:8px; align-items:center;"}),f=fe("button",{class:"btn",type:"button"},"Edit"),g=fe("button",{class:"btn",type:"button"},"Delete");r.appendChild(f),r.appendChild(g),l.appendChild(r),s.appendChild(l),t.description&&s.appendChild(fe("div",{class:"muted",style:"font-size:12px; margin-top:6px;"},t.description));const h=fe("div",{style:"margin-top:10px;"});h.appendChild(Jo(t,n,{compactOps:!0})),s.appendChild(h);const c=t.ops.map(v=>v.instanceId);s.appendChild(Zo({pipelineId:t.id,instanceIds:c,selectedRecipeId:i,recipes:o,handlers:a}));function d(){const v={id:t.id,title:t.title,description:t.description??"",implemented:t.implemented,ops:t.ops},b=window.prompt(`Edit pipeline JSON.

Structure: { id, title, description?, implemented, ops: [{ instanceId, opId, enabled?, override? }] }

`,JSON.stringify(v,null,2));if(b)try{const y=Yo(b);if(!y||typeof y!="object")throw new Error("Invalid JSON object");if(typeof y.id!="string"||!y.id)throw new Error("Missing pipeline.id");if(typeof y.title!="string"||!y.title)throw new Error("Missing pipeline.title");if(typeof y.implemented!="boolean")throw new Error("Missing pipeline.implemented boolean");if(!Array.isArray(y.ops))throw new Error("Missing pipeline.ops array");for(const x of y.ops){if(!x||typeof x!="object")throw new Error("Invalid op entry");if(typeof x.instanceId!="string"||!x.instanceId)throw new Error("Op missing instanceId");if(typeof x.opId!="string"||!x.opId)throw new Error("Op missing opId");if(x.enabled!==void 0&&typeof x.enabled!="boolean")throw new Error("Op.enabled must be boolean")}a.onUpsertPipeline(y)}catch(y){const x=y instanceof Error?y.message:String(y);window.alert(`Invalid pipeline JSON: ${x}`)}}function m(){window.confirm(`Delete pipeline "${t.id}"? This also deletes its recipes.`)&&a.onDeletePipeline(t.id)}return f.addEventListener("click",d),g.addEventListener("click",m),s}function H(e,t,n){const i=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))i.setAttribute(o,a);return typeof n=="string"&&(i.textContent=n),i}function jt(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function Qo(e,t){return`${e}.${t+1}`}function ea(e){const t=new Map;for(const n of e)t.set(n.id,n);return t}function Ft(e,t){const n=[];for(const i of e.opIds){const o=t.get(i);o&&n.push(o)}return n}function ta(e,t){let n=t;for(const i of e){if(i.io.input!==n)return n;n=i.io.output}return n}function na(e){const{mountEl:t,onSavePipeline:n}=e;let i=!1,o=[],a=new Map;const s="image";let l,u="Drag an operation from the left and drop it into a slot.",r=null;function f(w){const C="margin-top:10px; padding:8px 10px; border-radius:10px; font-size:12px; border:1px solid rgba(255,255,255,0.12);";return w==="error"?C+" background: rgba(255, 80, 80, 0.10);":w==="info"?C+" background: rgba(255, 200, 80, 0.10);":C+" background: rgba(80, 160, 255, 0.08);"}function g(w,C){l=w,u=C,r&&(r.setAttribute("style",f(w)),r.textContent=C)}function h(w){return w&&(w.getData("application/x-beemage-opid")||w.getData("text/plain"))||""}const c={id:"myPipeline",title:"My pipeline",description:"",implemented:!0,opIds:[]};function d(w,C){c.opIds.splice(w,0,C)}function m(w){c.opIds.splice(w,1)}function v(w,C){const E=w+C;if(E<0||E>=c.opIds.length)return;const T=c.opIds[w];c.opIds[w]=c.opIds[E],c.opIds[E]=T}function b(w,C){const E=a.get(C);if(!E)return{ok:!1,reason:"Unknown op"};const T=Ft(c,a),$=Vt({specs:T,startType:s,index:w}),O=w<T.length?T[w].io.input:void 0;return xo({beforeType:$,afterType:O,op:E})}function y(){const w=c.id.trim(),C=c.title.trim();if(!w){window.alert("Pipeline id is required.");return}if(!C){window.alert("Pipeline title is required.");return}const E=[];for(const O of c.opIds){const p=a.get(O);if(!p){window.alert(`Unknown operation in draft: ${O}`);return}E.push(p)}const T={id:w,title:C,description:c.description||void 0,implemented:!!c.implemented,ops:c.opIds.map((O,p)=>({instanceId:Qo(w,p),opId:O,enabled:!0}))};let $=s;for(let O=0;O<E.length;O++){const p=E[O];if(p.io.input!==$){window.alert(`Invalid typing at step ${O+1}: "${p.title}" needs ${p.io.input} but current is ${$}`);return}$=p.io.output}n(T)}function x(){if(i)return;jt(t);const w=H("div",{class:"card",style:"padding:10px;"});w.appendChild(H("div",{class:"cardTitle"},"Pipeline playground"));const C=H("div",{class:"row",style:"gap:10px; flex-wrap:wrap; align-items:flex-end; margin-top:10px;"}),E=H("label",{class:"fieldInline"});E.appendChild(H("span",{},"Id"));const T=H("input",{type:"text",value:c.id,style:"min-width:200px;"});T.addEventListener("input",()=>{c.id=T.value}),E.appendChild(T);const $=H("label",{class:"fieldInline"});$.appendChild(H("span",{},"Title"));const O=H("input",{type:"text",value:c.title,style:"min-width:240px;"});O.addEventListener("input",()=>{c.title=O.value}),$.appendChild(O);const p=H("label",{class:"fieldInline"});p.appendChild(H("span",{},"Implemented"));const I=H("input",{type:"checkbox"});I.checked=!!c.implemented,I.addEventListener("change",()=>{c.implemented=!!I.checked}),p.appendChild(I);const R=H("button",{type:"button",class:"btn"},"Clear");R.addEventListener("click",()=>{c.opIds=[],x()});const B=H("button",{type:"button",class:"btn"},"Save pipeline");B.addEventListener("click",y),C.appendChild(E),C.appendChild($),C.appendChild(p),C.appendChild(R),C.appendChild(B),w.appendChild(C);const A=H("label",{style:"display:block; margin-top:10px;"});A.appendChild(H("div",{class:"muted",style:"font-size:12px; margin-bottom:4px;"},"Description"));const k=H("textarea",{style:"width:100%; min-height:54px;"});k.value=c.description,k.addEventListener("input",()=>{c.description=k.value}),A.appendChild(k),w.appendChild(A);const S=Ft(c,a),P=ta(S,s),D=H("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},`Start: ${s}  →  Current output: ${P}`);w.appendChild(D),r=H("div",{style:f(l)},u),w.appendChild(r);const M=H("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:8px;"});M.appendChild(H("div",{style:"border:1px dashed rgba(255,255,255,0.18); border-radius:10px; padding:8px; background:rgba(0,0,0,0.08);"},`Input (${s})`));function z(L){const N=H("div",{"data-slot-index":String(L),style:"min-height:46px; display:flex; align-items:center; justify-content:center; border:1px dashed rgba(255,255,255,0.14); border-radius:10px; padding:8px; background:rgba(0,0,0,0.05); text-align:center; font-size:12px; cursor:copy;"}),U=Vt({specs:S,startType:s,index:L}),J=L<S.length?S[L].io.input:void 0;return N.textContent=J?`Drop here (slot type: ${U} → next needs: ${J})`:`Drop here (slot type: ${U})`,N.addEventListener("dragenter",_=>{_.preventDefault(),N.style.background="rgba(80, 160, 255, 0.08)"}),N.addEventListener("dragover",_=>{_.preventDefault(),_.dataTransfer&&(_.dataTransfer.dropEffect="copy");const q=h(_.dataTransfer);if(!q)return;const Q=b(L,q);N.style.background=Q.ok?"rgba(80, 255, 140, 0.08)":"rgba(255, 80, 80, 0.06)"}),N.addEventListener("dragleave",()=>{N.style.background="rgba(0,0,0,0.05)"}),N.addEventListener("drop",_=>{_.preventDefault(),N.style.background="rgba(0,0,0,0.05)";const q=h(_.dataTransfer);if(!q){g("error","Drop refused: could not read operation id from the drag payload."),Y({scope:"panel",kind:"error",message:"Builder playground drop refused (missing opId)",meta:{index:L}});return}const Q=b(L,q);if(!Q.ok){g("info",`Drop refused: ${Q.reason??"operation cannot be inserted here."}`),Y({scope:"panel",kind:"info",message:"Builder playground drop refused (typing mismatch)",meta:{index:L,opId:q,reason:Q.reason??""}});return}d(L,q),g("info",`Inserted "${q}" at position ${L+1}.`),Y({scope:"panel",kind:"info",message:"Builder playground op inserted",meta:{index:L,opId:q}}),x()}),N}for(let L=0;L<=c.opIds.length;L++)if(M.appendChild(z(L)),L<c.opIds.length){const N=c.opIds[L],U=a.get(N),J=H("div",{class:"row",style:"gap:8px; align-items:flex-start;"}),_=H("div",{style:"flex:1;"});U?_.appendChild(He(U,{compact:!0,showGroup:!0,showId:!0,portStyle:"puzzle",cardStyle:"puzzleFrame"})):_.appendChild(H("div",{class:"muted"},`Unknown op: ${N}`));const q=H("div",{style:"display:flex; flex-direction:column; gap:6px;"}),Q=H("button",{type:"button",class:"btn"},"Up");Q.disabled=L===0,Q.addEventListener("click",()=>{v(L,-1),x()});const ue=H("button",{type:"button",class:"btn"},"Down");ue.disabled=L===c.opIds.length-1,ue.addEventListener("click",()=>{v(L,1),x()});const pe=H("button",{type:"button",class:"btn"},"Remove");pe.addEventListener("click",()=>{m(L),x()}),q.appendChild(Q),q.appendChild(ue),q.appendChild(pe),J.appendChild(_),J.appendChild(q),M.appendChild(J)}w.appendChild(M),t.appendChild(w)}return{render(w){o=w.opsLibrary??[],a=ea(o),x()},dispose(){i=!0,jt(t)}}}function G(e,t,n){const i=document.createElement(e);if(t)for(const[o,a]of Object.entries(t))i.setAttribute(o,a);return typeof n=="string"&&(i.textContent=n),i}function ia(e){const{dom:t,handlers:n}=e;let i=!1,o=!1,a="all",s="all",l=null,u=null,r="",f=null,g=null,h=null,c=null,d=null,m=null,v=null,b=null;function y(){if(g)return g;const A=G("div",{"data-role":"builderListMount",style:"margin-top:12px;"});return t.viewBuilder.appendChild(A),g=A,A}function x(){if(w(),h)return h;const A=G("div",{"data-role":"builderOpsMount"});return(d??t.viewBuilder).appendChild(A),h=A,A}function w(){c||(c=G("div",{"data-role":"builderLayout",style:"display:flex; gap:12px; align-items:flex-start; margin-top:12px;"}),d=G("div",{"data-role":"builderLeftCol",style:"flex:1; min-width:320px;"}),m=G("div",{"data-role":"builderRightCol",style:"flex:1; min-width:320px;"}),c.appendChild(d),c.appendChild(m),t.viewBuilder.appendChild(c))}function C(A,k){const S=G("select"),P=[{value:"all",label:"All"},{value:"image",label:"image"},{value:"mask",label:"mask"},{value:"svg",label:"svg"}];for(const D of P){const M=G("option");M.value=D.value,M.textContent=D.label,D.value===A&&(M.selected=!0),S.appendChild(M)}return S.addEventListener("change",()=>k(S.value)),S}function E(){if(w(),v)return v;const A=G("div",{"data-role":"builderPlaygroundMount"});return(m??t.viewBuilder).appendChild(A),v=A,b=na({mountEl:v,onSavePipeline:async k=>{await n.onUpsertPipeline(k)}}),A}function T(A){const k=a==="all"?!0:A.io.input===a,S=s==="all"?!0:A.io.output===s;return k&&S}function $(A,k){const S=x();S.innerHTML="";const P=G("div",{class:"card",style:"padding:10px;"});P.appendChild(G("div",{class:"cardTitle"},"All operations"));const D=G("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px;"}),M=G("label",{class:"fieldInline"});M.appendChild(G("span",{},"Filter input")),l=C(String(a),U=>{a=U==="all"?"all":U,$(A)}),M.appendChild(l);const z=G("label",{class:"fieldInline"});z.appendChild(G("span",{},"Filter output")),u=C(String(s),U=>{s=U==="all"?"all":U,$(A)}),z.appendChild(u),D.appendChild(M),D.appendChild(z),P.appendChild(D);const L=A.filter(T);if(!L.length){P.appendChild(G("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No operations match the filter.")),S.appendChild(P);return}const N=G("div",{class:"opsGrid",style:"margin-top:10px;"});for(const U of L){const J=He(U,{compact:!0,showGroup:!0,showId:!0,portStyle:"puzzle",cardStyle:"plain"});J.setAttribute("draggable","true"),J.addEventListener("dragstart",_=>{var q,Q;(q=_.dataTransfer)==null||q.setData("application/x-beemage-opid",U.id),(Q=_.dataTransfer)==null||Q.setData("text/plain",U.id),_.dataTransfer&&(_.dataTransfer.effectAllowed="copy")}),N.appendChild(J)}P.appendChild(N),S.appendChild(P)}function O(A,k){const S=y();S.innerHTML="";const P=G("div",{class:"card",style:"padding:10px;"});P.appendChild(G("div",{class:"cardTitle"},"Stored user pipelines"));const D=G("div",{class:"row",style:"align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px;"}),M=Array.isArray(k.examples)?k.examples:[],z=G("label",{class:"fieldInline"});z.appendChild(G("span",{},"Load example"));const L=G("select",{style:"min-width:260px;"});{const Z=G("option");Z.value="",Z.textContent=M.length?"Select an example…":"No examples available",Z.selected=!0,L.appendChild(Z)}for(const Z of M){const ne=G("option");ne.value=String(Z.path??""),ne.textContent=String(Z.title??Z.id??Z.path??"Example"),L.appendChild(ne)}z.appendChild(L);const N=G("button",{type:"button",class:"btn",style:"padding:4px 10px; font-size:12px;"},"Load");N.disabled=!0,L.addEventListener("change",()=>{N.disabled=!L.value}),N.addEventListener("click",()=>{const Z=L.value;Z&&(n.onLoadExample(Z),L.value="",N.disabled=!0)});const U=G("label",{class:"fieldInline"});U.appendChild(G("span",{},"Filter pipelines")),f=G("input",{type:"text",value:r,placeholder:"Search by id or title…",style:"min-width:260px;"}),f.addEventListener("input",()=>{r=f?f.value:"",O(k.pipelines,k)}),U.appendChild(f);const J=G("button",{type:"button",class:"btn",style:"padding:4px 10px; font-size:12px;"},"Clear");J.addEventListener("click",()=>{r="",f&&(f.value=""),O(k.pipelines,k)}),D.appendChild(z),D.appendChild(N),D.appendChild(U),D.appendChild(J),P.appendChild(D);const _=Array.isArray(k.userPipelinesRaw)?k.userPipelinesRaw:[];if(!_.length){P.appendChild(G("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No user pipelines stored.")),S.appendChild(P);return}const q=r.trim().toLowerCase(),Q=q.length===0?_:_.filter(Z=>{const ne=String(Z.id??"").toLowerCase(),Ce=String(Z.title??"").toLowerCase();return ne.includes(q)||Ce.includes(q)});if(!Q.length){P.appendChild(G("div",{class:"muted",style:"font-size:12px; margin-top:10px;"},"No pipelines match the search.")),S.appendChild(P);return}const ue=G("div",{style:"margin-top:10px; display:flex; flex-direction:column; gap:10px;"}),pe=k.recipesAll??{};for(const Z of Q){const ne=(pe==null?void 0:pe[Z.id])??{recipesById:{},selectedRecipeId:void 0},Ce=(ne==null?void 0:ne.recipesById)??{},We=Object.values(Ce),Je=ne==null?void 0:ne.selectedRecipeId;ue.appendChild(Xo({pipeline:Z,opsLibrary:k.ops??[],selectedRecipeId:Je,recipes:We,handlers:{onDeletePipeline:n.onDeletePipeline,onUpsertPipeline:n.onUpsertPipeline,onSelectRecipe:n.onSelectRecipe,onUpsertRecipe:n.onUpsertRecipe,onDeleteRecipe:n.onDeleteRecipe}}))}P.appendChild(ue),S.appendChild(P)}function p(){o||(o=!0,t.builderImportFileEl.addEventListener("change",()=>{var A;(A=t.builderImportFileEl.files)==null||A[0]}),t.btnBuilderExportEl.addEventListener("click",()=>{n.onExport()}),t.builderImportFileEl.addEventListener("change",()=>{var k;const A=((k=t.builderImportFileEl.files)==null?void 0:k[0])??null;A&&(n.onImportFile(A),t.builderImportFileEl.value="")}))}function I(){i||(i=!0,w(),x(),E(),y())}function R(A){t.builderStatusEl.textContent=A.statusText||"Idle",w(),x(),E(),y(),b==null||b.render({opsLibrary:A.ops??[]}),$(A.ops??[]),O(A.pipelines,A)}function B(){i=!1,o=!1,a="all",s="all",r="",f=null,l=null,u=null,g&&(g.innerHTML="",g.remove(),g=null),h&&(h.innerHTML="",h.remove(),h=null),b==null||b.dispose(),b=null,v&&(v.innerHTML="",v.remove(),v=null),c&&(c.innerHTML="",c.remove(),c=null,d=null,m=null)}return{bind:p,mount:I,render:R,dispose:B}}function oa(e,t){const n=new Blob([t],{type:"application/json;charset=utf-8"}),i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download=e,o.rel="noopener",o.click(),setTimeout(()=>URL.revokeObjectURL(i),500)}function aa(e,t){const n=Ko();let i=!1,o={},a=[],s="Idle",l=[],u=n.listOperations();async function r(){const w=bt("assets/pipelines/index.json"),C=await fetch(w,{cache:"no-store"});if(!C.ok)throw new Error(`Examples index not found: ${C.status}`);const E=await C.json().catch(()=>null),T=E==null?void 0:E.examples;return Array.isArray(T)?T.map($=>({id:String(($==null?void 0:$.id)??""),title:String(($==null?void 0:$.title)??($==null?void 0:$.id)??($==null?void 0:$.path)??"Example"),path:String(($==null?void 0:$.path)??"")})).filter($=>$.id&&$.path):[]}async function f(w){const C=bt(w),E=await fetch(C,{cache:"no-store"});if(!E.ok)throw new Error(`Example fetch failed (${E.status}): ${w}`);const T=await E.text();await n.importFromJsonText(T)}const g=ia({dom:e,handlers:{onImportFile:async w=>{try{s=`Importing: ${w.name}`,d();const C=await w.text(),E=await n.importFromJsonText(C);j({scope:"panel",kind:"info",message:`Builder import: imported=${E.imported}, skipped=${E.skipped}, total=${E.totalInFile}`}),s=`Imported ${E.imported} pipeline(s) (skipped ${E.skipped}).`,await h()}catch(C){const E=C instanceof Error?C.message:String(C);j({scope:"panel",kind:"error",message:`Builder import failed: ${E}`}),Y({scope:"panel",kind:"error",message:"Builder import failed",meta:{error:E}}),s=`Import failed: ${E}`,d()}},onExport:async()=>{try{s="Exporting…",d();const w=await n.exportToJsonText();oa("beemage-user-pipelines.json",w),j({scope:"panel",kind:"info",message:"Builder export: downloaded beemage-user-pipelines.json"}),s="Exported.",d()}catch(w){const C=w instanceof Error?w.message:String(w);j({scope:"panel",kind:"error",message:`Builder export failed: ${C}`}),Y({scope:"panel",kind:"error",message:"Builder export failed",meta:{error:C}}),s=`Export failed: ${C}`,d()}},onDeletePipeline:async w=>{try{await n.deleteUserPipelineById(w),await n.deleteAllRecipesForPipeline(w),j({scope:"panel",kind:"info",message:`Builder: deleted user pipeline "${w}" (and its recipes)`}),s=`Deleted pipeline ${w}.`,await h()}catch(C){const E=C instanceof Error?C.message:String(C);j({scope:"panel",kind:"error",message:`Delete pipeline failed: ${E}`}),Y({scope:"panel",kind:"error",message:"Delete pipeline failed",meta:{pipelineId:w,error:E}}),s=`Delete failed: ${E}`,d()}},onUpsertPipeline:async w=>{try{await n.upsertUserPipeline(w),j({scope:"panel",kind:"info",message:`Builder: saved user pipeline "${String((w==null?void 0:w.id)??"")}"`}),s=`Saved pipeline ${String((w==null?void 0:w.id)??"")}.`,await h()}catch(C){const E=C instanceof Error?C.message:String(C);j({scope:"panel",kind:"error",message:`Save pipeline failed: ${E}`}),Y({scope:"panel",kind:"error",message:"Save pipeline failed",meta:{error:E}}),s=`Save failed: ${E}`,d()}},onSelectRecipe:async(w,C)=>{try{await n.setSelectedRecipe(w,C),j({scope:"panel",kind:"info",message:`Builder: selected recipe "${C}" for pipeline "${w}"`}),s=`Selected recipe ${C} for ${w}.`,await h()}catch(E){const T=E instanceof Error?E.message:String(E);j({scope:"panel",kind:"error",message:`Select recipe failed: ${T}`}),Y({scope:"panel",kind:"error",message:"Select recipe failed",meta:{pipelineId:w,recipeId:C,error:T}}),s=`Select recipe failed: ${T}`,d()}},onUpsertRecipe:async(w,C)=>{try{await n.upsertRecipe(w,C),j({scope:"panel",kind:"info",message:`Builder: saved recipe "${String((C==null?void 0:C.id)??"")}" for pipeline "${w}"`}),s=`Saved recipe ${String((C==null?void 0:C.id)??"")} for ${w}.`,await h()}catch(E){const T=E instanceof Error?E.message:String(E);j({scope:"panel",kind:"error",message:`Save recipe failed: ${T}`}),Y({scope:"panel",kind:"error",message:"Save recipe failed",meta:{pipelineId:w,error:T}}),s=`Save recipe failed: ${T}`,d()}},onDeleteRecipe:async(w,C)=>{try{await n.deleteRecipe(w,C),j({scope:"panel",kind:"info",message:`Builder: deleted recipe "${C}" from pipeline "${w}"`}),s=`Deleted recipe ${C} from ${w}.`,await h()}catch(E){const T=E instanceof Error?E.message:String(E);j({scope:"panel",kind:"error",message:`Delete recipe failed: ${T}`}),Y({scope:"panel",kind:"error",message:"Delete recipe failed",meta:{pipelineId:w,recipeId:C,error:T}}),s=`Delete recipe failed: ${T}`,d()}},onLoadExample:async w=>{try{s=`Loading example: ${w}`,d(),await f(w),j({scope:"panel",kind:"info",message:`Builder example loaded: ${w}`}),s=`Loaded example: ${w}`,await h()}catch(C){const E=C instanceof Error?C.message:String(C);j({scope:"panel",kind:"error",message:`Load example failed: ${E}`}),Y({scope:"panel",kind:"error",message:"Load example failed",meta:{error:E,examplePath:w}}),s=`Load example failed: ${E}`,d()}}}});async function h(){const w=await n.listUserPipelines().catch(()=>[]);l=w,u=n.listOperations(),o=await n.listAllRecipes().catch(()=>({})),a=await r().catch(()=>[]),s=`Ready. User pipelines: ${w.length} · Operations: ${u.length} · Examples: ${a.length}`,d()}function c(){const w=l??[];return{statusText:s,pipelines:w.map(C=>({id:String(C.id),title:String(C.title),implemented:!!C.implemented,opCount:Array.isArray(C.ops)?C.ops.length:0})),userPipelinesRaw:w,ops:u,recipesAll:o??{},examples:a??[]}}function d(){g.mount(),g.render(c())}function m(){g.bind(),e.builderStatusEl.textContent="Idle"}async function v(){i=!0,s="Loading…",d(),await h()}async function b(){i&&(s="Refreshing…",d(),await h())}function y(){i=!1}function x(){g.dispose()}return{bind:m,mount:v,refresh:b,unmount:y,dispose:x}}async function sa(){const e=Ln();await at().catch(()=>null);const t=On();t.start();const n=Nn();globalThis.__APP__={...globalThis.__APP__,cache:n};const i=ji({getRuntimeAvailability:()=>({opencvReady:!1}),debugTraceAppend:g=>Y({scope:"panel",kind:"debug",message:g}),actionLogAppend:g=>j({scope:"panel",kind:"info",message:g})});i.mount({mountEl:e.tuningMountEl,scopeRootId:"app"});const o=Qn(e),a=ci(e),s=Fo(e,t,i),l=Oi(e,t),u=Vi(e),r=aa(e);o.bind(),s.bind(),a.bind(),l.bind(),u.bind(),r.bind();const f=Vn(e,{image:o,pipeline:s,builder:r,colors:a,settings:l,logs:u});f.bind(),f.boot()}sa();
